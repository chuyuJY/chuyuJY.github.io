[{"categories":["é¢è¯•","é¡¹ç›®"],"content":"[toc] ","date":"2023-08-01","objectID":"/trlab/:0:0","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"ä¸€ã€æ™ºèƒ½é—®ç­”ç³»ç»Ÿ èƒŒæ™¯ï¼šä¼ ç»Ÿç«™å†…æœç´¢ç³»ç»ŸåŸºäºå…³é”®å­—åŒ¹é…ï¼Œåœ¨é¢å‘ï¼šç‰¹å®šé¢†åŸŸçŸ¥è¯†åº“ã€æŠ€æœ¯å›¾è°±ã€äº§å“è¯´æ˜ã€ä¼ä¸š/å­¦æ ¡ç”Ÿæ´»æŒ‡å—ç­‰ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œç¼ºå°‘å¯¹ç”¨æˆ·é—®é¢˜ç†è§£å’Œç­”æ¡ˆäºŒæ¬¡å¤„ç†èƒ½åŠ›ã€‚ å¤§è¯­è¨€æ¨¡å‹ï¼ˆLarge Language Model, LLMï¼‰é€šè¿‡å…¶å¯¹è‡ªç„¶è¯­è¨€ç†è§£å’Œç”Ÿæˆçš„èƒ½åŠ›ï¼Œå¯ä»¥çŒœæµ‹ç”¨æˆ·æ„å›¾ï¼Œå¹¶å¯¹åŸå§‹çŸ¥è¯†ç‚¹è¿›è¡Œæç‚¼ã€æ±‡æ€»ã€æ•´åˆï¼Œè¿›è€Œç”Ÿæˆæ›´è´´åˆ‡çš„ç­”æ¡ˆã€‚ ç°æœ‰çš„å¤§è¯­è¨€æ¨¡å‹å¦‚ ChatGPTï¼Œ çŸ¥è¯†åº“ä»…è¦†ç›–è‡³ 2021 å¹´ 9 æœˆå‰çš„ä¿¡æ¯ï¼Œæ— æ³•å‚è€ƒè®­ç»ƒæ•°æ®é›†æœªåŒ…å«çš„ä¿¡æ¯åŠä¹‹åå‡ºç°çš„æ–°ä¿¡æ¯ã€‚ æœ¬æ–‡æ¢ç´¢é€šè¿‡ LLMï¼Œæ‰“é€  ç‰¹å®šé¢†åŸŸçŸ¥è¯†ï¼ˆDomain-specific Knowledgeï¼‰é—®ç­”ç³»ç»ŸğŸ¤–ã€‚ ","date":"2023-08-01","objectID":"/trlab/:1:0","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.1 éœ€æ±‚åˆ†æ åœ¨ Web ç«¯ï¼Œå®ç°ä¸€ä¸ªå¯ä»¥åœ¨ç‰¹å®šé¢†åŸŸä¸ç”¨æˆ·å¯¹è¯çš„æ™ºèƒ½é—®ç­”ç³»ç»ŸğŸ¤–ã€‚å…·ä½“éœ€æ±‚åˆ†æå¦‚ä¸‹ï¼š graph ss(æ™ºèƒ½é—®ç­”ç³»ç»Ÿ) --\u003e ä¸­è‹±æ–‡é—®ç­” ss --\u003e ç‰¹å®šé¢†åŸŸ ss --\u003e æ”¯æŒä¸Šä¸‹æ–‡ ss --\u003e é¿å…ç¼–é€ ç­”æ¡ˆ é€šè¿‡é—®ç­”çš„å½¢å¼ï¼Œå’Œç”¨æˆ·äº¤äº’ï¼ŒåŒæ—¶æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ï¼› é—®é¢˜çš„å›ç­”éœ€è¦å‚è€ƒç«™å†…æä¾›çš„ç‰¹å®šé¢†åŸŸçš„åŸå§‹ä¿¡æ¯ï¼› æ”¯æŒä¸Šä¸‹æ–‡ã€‚ç”¨æˆ·çš„é—®é¢˜å¯èƒ½ä¸å†å²ä¼šè¯ç›¸å…³ï¼Œéœ€è¦ä»å†å²å›ç­”æå–ä¸Šä¸‹æ–‡ï¼› å›ç­”å‡†ç¡®ã€‚ChatGPT å¾ˆæ“…é•¿åœ¨ä¸æ“…é•¿çš„é¢†åŸŸâ€œè¡¨ç°â€çš„å¾ˆæ“…é•¿ï¼Œè¦å°½é‡é¿å…è¿™ç§æƒ…å†µï¼ ç”±äº LLM æ— æ³•å‚è€ƒé¢„è®­ç»ƒæ•°æ®é›†ä¹‹å¤–çš„æ•°æ®ï¼Œå› æ­¤å®ç°ä¸Šè¿°éœ€æ±‚çš„å…³é”®å°±åœ¨äºï¼šå¦‚ä½•å‘ LLM åé¦ˆç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†åº“ã€‚ ","date":"2023-08-01","objectID":"/trlab/:1:1","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.2 æ–¹æ¡ˆåˆ†æ é€šè¿‡è°ƒç ”ï¼Œä¸šç•Œä¸»æµçš„æ–¹æ¡ˆæœ‰ä¸¤ç§ã€‚ Fine-TunningğŸ’°ğŸ‘ Fine-Tunningï¼šå¯¹å¼€æºçš„ LLM è¿›è¡Œå…¨é¢æˆ–éƒ¨åˆ†çš„å¾®è°ƒï¼Œé‡‡ç”¨ fine-tune æˆ–è€… LoRA æŠ€æœ¯ã€‚ä¸šç•Œå·²ç»ä¸å°‘ chatgpt çš„å¹³æ›¿æ–¹æ¡ˆéƒ½æ”¯æŒå¾®è°ƒï¼Œæ¯”å¦‚ï¼š æ¸…åå¤§å­¦äº 2023.03 æå‡ºçš„ ChatGLM æ”¯æŒä¸­è‹±åŒè¯­ï¼Œå…·æœ‰ 62 äº¿å‚æ•°ï¼Œå¯ä»¥åœ¨æ¶ˆè´¹çº§æ˜¾å¡ä¸Šéƒ¨ç½²ï¼ŒINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€è¦ 6GB æ˜¾å­˜ã€‚ Alpaca æ˜¯åœ¨ Meta æå‡ºçš„ LLaMA 7B æ¨¡å‹åŸºç¡€ä¸Šå¾®è°ƒçš„ç»“æœã€‚åŸç”Ÿçš„ Alpaca å¯¹ä¸­æ–‡çš„æ”¯æŒå¹¶ä¸å¥½ï¼Œä¸è¿‡å·²ç»ä¸šç•Œä¹Ÿåšäº†äº›æ‰©å……ä¸­æ–‡è¯è¡¨çš„å¼€æºæ–¹æ¡ˆã€‚ ä¼˜ç‚¹ï¼š èƒ½ä½¿ LLM â€œå½»åº•è®°ä½â€ç‰¹å®šçš„é¢†åŸŸçŸ¥è¯†ï¼Œä»è€Œåœ¨æ‹¥æœ‰ç‰¹å®šçŸ¥è¯†èƒŒæ™¯çš„æ¡ä»¶ä¸‹è¿›äº¤æµï¼› é‡‡ç”¨ç§æœ‰éƒ¨ç½²ï¼Œé€‚åˆç”¨äºä¸€äº›å°šæœªå…¬å¼€çš„å…¬å¸å†…éƒ¨çŸ¥è¯†ï¼Œä¸ä¼šé€ æˆä¿¡æ¯æ³„éœ²ã€‚ ç¼ºç‚¹ï¼š èµ„æºæ¶ˆè€—éå¸¸å¤§ã€‚æ¶ˆè€—çš„èµ„æºé‡è™½ç„¶ç›¸å¯¹å¤§æ¨¡å‹é¢„è®­ç»ƒå‡å°‘ï¼Œä½†è¿˜æ˜¯ä¸å®¹å°è§‘çš„ã€‚æ¯”å¦‚ Alpaca çš„å¾®è°ƒï¼Œæ®ä½œè€…ä»‹ç»ä»–ä»¬ä½¿ç”¨ 8 ä¸ª æ˜¾å­˜ 80GB A100 ï¼ŒèŠ±è´¹äº† 3 ä¸ªå°æ—¶ã€‚å¦‚æœé¢†åŸŸæ”¯æŒé¢‘ç¹æ›´æ–°ï¼Œä¸”éœ€è¦éœ€è¦è¾ƒé«˜çš„å®æ—¶æ€§ï¼Œæ˜¾ç„¶æ˜¯æ— æ³•æ»¡è¶³è¦æ±‚çš„ã€‚ éœ€è¦æ„å»ºç‰¹å®šé¢„è®­ç»ƒè¯­æ–™åº“ã€‚é«˜è´¨é‡è®­ç»ƒæ•°æ®é›†çš„æ„å»ºéœ€è¦ç²¾å¿ƒè®¾è®¡ï¼Œå¼€é”€ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚ å¾®è°ƒçš„ç»“æœä¸ä¸€å®šç¬¦åˆé¢„æœŸã€‚ Embeddingâ­ Embeddingï¼šé€šè¿‡åµŒå…¥æ¨¡å‹ï¼Œå°†ç‰¹å®šçŸ¥è¯†è½¬åŒ–ä¸ºå‘é‡ Embeddingï¼Œç„¶åå°†è¿™äº›å‘é‡å­˜å…¥ç›¸åº”çš„å‘é‡æ•°æ®åº“ä¸­ã€‚åœ¨æŸ¥è¯¢é˜¶æ®µï¼Œé€šè¿‡ç›¸ä¼¼åº¦æŸ¥è¯¢ï¼ŒåŒ¹é…å‡ºå…³è”çš„ topK ç»“æœï¼Œç„¶åå°†è¿™äº›ç»“æœæä¾›ç»™ LLMï¼Œç”Ÿæˆç›¸åº”çš„ç­”æ¡ˆã€‚ ä¼˜ç‚¹ï¼š æˆæœ¬ä½ï¼› ä¼˜ç§€çš„æ­£ç¡®åº¦å’Œç²¾ç¡®åº¦ï¼› ç¼ºç‚¹ï¼š å¯èƒ½å­˜åœ¨æ•°æ®æ³„éœ²çš„é£é™©ï¼› å¯åµŒå…¥çš„æ–‡æœ¬æœ‰é•¿åº¦é™åˆ¶ï¼Œå¯èƒ½ä¼šæœ‰ä¸¢å¤±éƒ¨åˆ†ä¸Šä¸‹æ–‡çš„é£é™©ã€‚ Model Maximum text length gpt-3.5-turbo 4,096(~5 pages) gpt-4 8,192(~10 pages) gpt-4-32k 32,768(~40 pages) å‚è€ƒé“¾æ¥ï¼š Question answering using embeddings-based search ","date":"2023-08-01","objectID":"/trlab/:1:2","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.3 æ•´ä½“æµç¨‹ å‡†å¤‡é¢†åŸŸçŸ¥è¯†åº“ï¼ˆæ¯ä¸ªæ–‡æ¡£éœ€è¦ä¸€æ¬¡ï¼‰ æ”¶é›†æ–‡æœ¬ä¿¡æ¯ï¼šé€šè¿‡æŒ‡å®šæ•°æ®æºè·å–åŸå§‹æ–‡æœ¬ä¿¡æ¯ï¼› åˆ†å—ï¼ˆChunkï¼‰ï¼šæ ¹æ® Token é™åˆ¶ï¼Œå°†é•¿æ–‡æœ¬æ‹†åˆ†æˆçŸ­æ–‡æœ¬ï¼› åµŒå…¥ï¼ˆEmbeddingï¼‰ï¼šé€šè¿‡ OpenAI API è·å–æ¯å—æ–‡æœ¬çš„åµŒå…¥ä¿¡æ¯ Embeddingï¼› å­˜å‚¨ï¼šå°† Embedding ä¿å­˜åœ¨å‘é‡æ•°æ®åº“ï¼Œæ¨èä½¿ç”¨Milvusã€‚ æœç´¢ï¼ˆæ¯æ¬¡æŸ¥è¯¢éœ€è¦ä¸€æ¬¡ï¼‰ ç»™å®šä¸€ä¸ªç”¨æˆ·æŸ¥è¯¢è¯·æ±‚ï¼Œé€šè¿‡ OpenAI API ç”Ÿæˆè¯¥é—®é¢˜å¯¹åº”çš„ Embeddingï¼› ä»å‘é‡æ•°æ®åº“ä¸­æŸ¥è¯¢ä¸è¯¥é—®é¢˜å¯¹åº” Embedding æœ€ç›¸ä¼¼çš„ TopN ä¸ªæ–‡æœ¬ï¼Œå¹¶æŒ‰ç…§ç›¸ä¼¼åº¦æ’åºï¼› è¯¢é—®ï¼ˆæ¯æ¬¡æŸ¥è¯¢éœ€è¦ä¸€æ¬¡ï¼‰ å°†å‰ç½®èƒŒæ™¯ä¿¡æ¯ã€å†å²é—®ç­”ã€æŸ¥è¯¢é—®é¢˜ã€ç›¸ä¼¼æ–‡æœ¬æ’å…¥åˆ°ä¸€ä¸ª Complection å‘é€ç»™ ChatGPTï¼› è¿”å› ChatGPT çš„å›ç­”å¹¶è¿›è¡Œå¤„ç†ã€‚ ","date":"2023-08-01","objectID":"/trlab/:1:3","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.4 å…³é”®å®ç° ä»¥ä¸‹åŠŸèƒ½å‡é€šè¿‡ Go å®ç°ã€‚ ","date":"2023-08-01","objectID":"/trlab/:1:4","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"å‡†å¤‡çŸ¥è¯†åº“ è·å–åŸå§‹ä¿¡æ¯ è¿™é‡Œçš„æ–‡æœ¬æ¥æºä¸»è¦æ˜¯ï¼šhttps://trlab.com/ å¯ä»¥é€šè¿‡ Go çš„çˆ¬è™«æ¡†æ¶ Colly å†™ä¸€ä¸ªç®€æ˜“çš„è„šæœ¬ï¼Œçˆ¬å–æ–‡ç« å’Œ FAQSã€‚æ­¤å¤„ç›´æ¥ä»æ¥å£è·å–ï¼š func CrawArticles(url string, object any) { c := colly.NewCollector() c.OnRequest(func(r *colly.Request) { fmt.Println(\"Visiting\", r.URL) }) c.OnResponse(func(response *colly.Response) { if err := json.Unmarshal(response.Body, object); err != nil { logger.ZapLogger.Error(err.Error()) return } }) c.Visit(url) } CrawArticles() å‚æ•°ä¸ºä¸€ä¸ªæ¥å£åœ°å€ url å’Œæ¥æ”¶å¯¹è±¡ objectï¼Œä¼šå°†è·å–çš„ä¿¡æ¯æŒ‰ç…§ object æ ¼å¼è¿›è¡Œè§£æã€‚ Tokenizer Tokenï¼šLLM ç†è§£è¯­è¨€çš„åŸºæœ¬å•å…ƒï¼Œé€šè¿‡å°†æ–‡æœ¬åˆ†è§£ä¸º Token æ¥ç†è§£å’Œå¤„ç†æ–‡æœ¬ã€‚å•è¯å’Œ Token ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯”å¦‚ goodness å°±ç”±goodã€ness ä¸¤ä¸ª Token ç»„æˆã€‚ä¸­æ–‡é€šå¸¸å…ˆè½¬æ¢ä¸º Unicode æˆ– UTF-8 ç¼–ç ï¼Œå†è½¬æ¢æˆ Tokenã€‚ Tokenizerï¼šåˆ†è¯å™¨ï¼Œå°†æ–‡æœ¬åˆ†æˆä¸€ä¸ªä¸ªè¯å…ƒï¼Œä¿è¯å„ä¸ªè¯å…ƒæ‹¥æœ‰ç›¸å¯¹å®Œæ•´å’Œç‹¬ç«‹çš„è¯­ä¹‰ï¼Œä»¥ä¾›åç»­ä»»åŠ¡æ¯”å¦‚ Embedding ä½¿ç”¨ã€‚æ­¤å¤„é€‰ç”¨Tiktokenï¼Œæœ‰å¤šç§ç¼–ç æ–¹æ³•å¯é€‰ï¼Œå¦‚ï¼šr50k_baseï¼Œp50k_baseï¼Œcl100k_base ç­‰ã€‚é¢å‘ OpenAI çš„ gpt-4ï¼Œgpt-3.5-turbo å’Œ text-embedding-ada-002 æ¨¡å‹é€šå¸¸ä½¿ç”¨ cl100k_base ç¼–ç æ–¹æ³•ã€‚ äº†è§£æ–‡æœ¬ä¸­çš„ Token æ•°é‡ï¼Œæ—¢å¯ä»¥å‘Šè¯‰ä½ å­—ç¬¦ä¸²æ˜¯å¦å¤ªé•¿è€Œè¶…å‡ºäº†æ¨¡å‹å¤„ç†èƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹ OpenAI çš„ API è´¹ç”¨ï¼ˆæŒ‰ç…§tokenè®¡è´¹ï¼‰ã€‚ OpenAI å®˜æ–¹æä¾›äº†ä¸€ä¸ªåœ¨çº¿åˆ†è¯å·¥å…·ï¼Œæ ¹æ®å·¥å…·æä¾›çš„åˆ†è¯ç»“æœçœ‹ï¼Œ1 ä¸ªä¸­æ–‡è¯è¯­ä¼šåˆ†è§£ä¸º 2/3 ä¸ª Tokenã€‚ OpenAI æŒ‰ç…§ token æ•°ç›®æ”¶è´¹ï¼Œå¹¶ä¸”æ¯ä¸ª embedding-model å’Œ gpt-model å¯¹ token æ•°ç›®éƒ½æœ‰é™åˆ¶ï¼Œè¶…å‡ºéƒ¨åˆ†ä¼šè¢«æˆªæ–­ã€‚æ³¨æ„ï¼šé•¿åº¦æ˜¯æŒ‡é€šè¿‡ Tokenizer è®¡ç®—å‡ºçš„ tokené•¿åº¦ï¼Œè€Œéæ–‡æœ¬å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚ æ¯”å¦‚ text-embedding-ada-002 é‡‡ç”¨çš„ cl100k_base çš„ max token ä¸º 8191ï¼Œè€Œ gpt-3.5-turbo å•æ¬¡è¯¢é—®çš„ max token ä¸º 4096ã€‚ EMBEDDING MODEL TOKENIZER MAX INPUT TOKENS OUTPUT DIMENSIONS text-embedding-ada-002 cl100k_base 8191 1536 GPT MODEL MAX TOKENS gpt-3.5-turbo 4,096 tokens (~5 pages) gpt-3.5-turbo-16k 16,384 tokensï¼ˆ~20 pagesï¼‰ gpt-4 8,192 tokens (~10 pages) gpt-4-32k 32,768 tokens (~40 pages) å®˜æ–¹æ–‡æ¡£æä¾›äº† Python è®¡ç®— Token çš„æ–¹æ³•ï¼Œæ­¤å¤„æä¾› Go çš„ç‰ˆæœ¬ï¼š // CountMessagesTokens based on \"How_to_count_tokens_with_tiktoken.ipynb\" func CountMessagesTokens(model string, messages ...openai.ChatCompletionMessage) (numTokens int) { tkm, err := tiktoken.EncodingForModel(model) if err != nil { err = fmt.Errorf(\"encoding for model: %v\", err) log.Println(err) return } var tokensPerMessage, tokensPerName int switch model { case \"gpt-3.5-turbo-0613\", \"gpt-3.5-turbo-16k-0613\", \"gpt-4-0314\", \"gpt-4-32k-0314\", \"gpt-4-0613\", \"gpt-4-32k-0613\": tokensPerMessage = 3 tokensPerName = 1 case \"gpt-3.5-turbo-0301\": tokensPerMessage = 4 // every message follows \u003c|start|\u003e{role/name}\\n{content}\u003c|end|\u003e\\n tokensPerName = -1 // if there's a name, the role is omitted default: if strings.Contains(model, \"gpt-3.5-turbo\") { //logger.ZapLogger.Warn(\"warning: gpt-3.5-turbo may update over time. Returning num tokens assuming gpt-3.5-turbo-0613.\") return CountMessagesTokens(\"gpt-3.5-turbo-0613\", messages...) } else if strings.Contains(model, \"gpt-4\") { //logger.ZapLogger.Warn(\"warning: gpt-4 may update over time. Returning num tokens assuming gpt-4-0613.\") return CountMessagesTokens(\"gpt-4-0613\", messages...) } else { err = fmt.Errorf(\"num_tokens_from_messages() is not implemented for model %s. See https://github.com/openai/openai-python/blob/main/chatml.md for information on how messages are converted to tokens.\", model) logger.ZapLogger.Error(err.Error()) return } } for _, message := range messages { numTokens += tokensPerMessage numTokens += len(tkm.Encode(message.Content, nil, nil)) numTokens += len(tkm.Encode(message.Role, nil, nil)) numTokens += len(tkm.Encode(message.Name, nil, nil)) if message.Name != \"\" { numTokens += tokensPerName } } numTokens += 3 // every reply is primed with \u003c|start|\u003eassistant\u003c|message|\u003e return numTokens } å®‰å…¨åˆ†ç‰‡ å®‰å…¨åˆ†ç‰‡ï¼šå°†åŸå§‹çŸ¥è¯†åº“æ‹†åˆ†ä¸ºè‹¥å¹²ä¸ªç‹¬ç«‹ã€è¾ƒçŸ­çš„çŸ¥è¯†ç‚¹â­æ¯ä¸ªçŸ¥è¯†ç‚¹ä¼šä½œä¸ºé—®ç­”çš„æœ€å°è®°å½•ï¼Œä¸é—®é¢˜è¿›è¡ŒåŒ¹é…ã€‚ åˆ†ç‰‡æ—¶æœ‰å¦‚ä¸‹å¯å‚è€ƒçš„åŸåˆ™ï¼š åŸå§‹å†…å®¹åœ¨ç¼–å†™ã€ç»„ç»‡æ—¶æœ€å¥½åŸå­åŒ–ã€æ­£äº¤åŒ–ã€‚å¯¹äºæ ‘çŠ¶ç»“æ„çš„çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥æŒ‰å±‚çº§å…³ç³»è¡¨ç¤ºï¼Œæœ€å¥½ä¸è¦æ··ä¸ºä¸€è°ˆã€‚æ¯”å¦‚å€šå¤©å‰‘å¯èƒ½åŸºç¡€å±æ€§ï¼Œä¹Ÿæœ‰é€‚åˆçš„æ‰“æ³•ï¼Œåå‘çš„è‹±é›„å¤©èµ‹ï¼Œé‚£ä¹ˆä¸‰è€…åº”è¯¥ç‹¬ç«‹æè¿°ï¼Œè€Œä¸è¦æ··æ‚åœ¨ä¸€èµ·ï¼› å¯ä»¥åœ¨åŸå§‹è¯­æ–™ä¸­è®¾è®¡æ˜ç¡®çš„åˆ†ç‰‡æ ‡è®°ï¼Œç®€åŒ–å¤„ç†è¿‡ç¨‹ï¼› åŸºæœ¬çš„åˆ†ç‰‡æ–¹å¼ï¼Œç²’åº¦ä»ç»†åˆ°ç²—å¯ä»¥ä½¿ç”¨ï¼šæ ‡ç‚¹ç¬¦å·ã€æ®µè½ã€ç« èŠ‚ç­‰ã€‚åˆ†ç‰‡ç²’åº¦è¿‡ç»†ï¼ŒçŸ¥è¯†ç‚¹ä¼šæ¯”è¾ƒé›¶ç¢å½±å“äº†ç›¸äº’é—´çš„å…³ç³»ï¼›åˆ†ç‰‡ç²’åº¦è¿‡ç²—ï¼Œåœ¨åŒ¹é…æ—¶å¯èƒ½ä¼šæºå¸¦å†—ä½™ä¿¡æ¯ï¼Œå¦å¤–å¯¹ Embeddingã€å¤„ç†ã€ç´¢å¼•çš„æ•ˆç‡ä¹Ÿæœ‰å½±å“ã€‚ åˆ†ç‰‡è¦ä½¿ç”¨ Tokenizerï¼ŒåŸå§‹æ–‡æœ¬ç»è¿‡åˆ†è¯ç„¶åå†è¿›è¡Œ Embeddingï¼Œåˆ†ç‰‡å¤§å°éœ€è¦è€ƒè™‘åˆ†è¯ä¹‹åç”Ÿæˆçš„ Token æ•°é‡ã€‚åŸºæœ¬ç›®æ ‡æ˜¯ï¼šåˆ†ç‰‡ä¸èƒ½ç ´åçŸ¥è¯†ç‚¹çš„å®Œæ•´æ€§ï¼Œç”Ÿæˆçš„åˆ†ç‰‡å¯¹åº”çš„ Token æ•°é‡åº”è¯¥åœ¨é¢„è®¾èŒƒå›´å†…ï¼Œä¸è¦è¿‡å°æˆ–è¿‡å¤§ã€‚ æ­¤å¤„æŒ‰ç…§é™åˆ¶çš„ Token æœ€å¤§é•¿åº¦ï¼Œåˆ‡å‰² string ç±»å‹çš„æ–‡æœ¬ä¿¡æ¯ï¼š // ChunkedTokens encodes a string into tokens and then breaks it up into chunks func ChunkedTokens(text string, model string, chunkLength int) [][]int { if chunkLength \u003c 1 { logger.ZapLogger.Error(\"chunkLength must be at least one\") return nil } return Batched(","date":"2023-08-01","objectID":"/trlab/:1:5","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.5 åº”ç”¨æ•ˆæœ å‰ç½®æ–‡æœ¬ Question Who is the President of the United States? Compare the GC of Java and Go. When will Apple release new products? çŸ¥è¯†åº“ Question What is a secondary market? What is NFT? What is rhizome? What are the steps to purchase an NFT artwork? ä¸­è‹±æ–‡ Question What are the steps to purchase an NFT artwork? è´­ä¹°ä¸€ä¸ª NFT è‰ºæœ¯å“æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ å›ç­”æ ¼å¼ TRLab is a platform for discovering and collecting NFT (Non-Fungible Token) art from the worldâ€™s leading artists. They aim to elevate the NFT landscape by showcasing NFT art from renowned artists and exclusive collaborations. TRLab has a strong curatorial mission and leverages its connections with the art world to provide a platform for artists, collectors, and art lovers to engage with NFT art.\\n\\nThe team at TRLab believes in the long-lasting potential of NFTs to fundamentally change art ownership, collecting, royalties, and provenance. They offer a robust transaction platform, a production studio to assist artists in creating digital and NFT works of art, a concierge team to assist collectors, and a social community to engage art enthusiasts [1].\\n\\nThe name \"TRLab\" comes from \"Tabula Rasa,\" a Latin expression meaning \"blank slate.\" It signifies that everyone is born as a blank slate, free of judgment. TRLab sees NFTs as a blank slate where the value is given by the creator, and they aim to be at the forefront of the evolution of the creative industries in the information age [1].\\n\\nThe founding members of TRLab include Dragonfly Capital, Xin Li-Cohen (Non-executive Deputy Chairman of Christieâ€™s), and the founders of Rockbund Art Museum, Artsy, and ART021 [1].\\n\\nTRLab has also collaborated with artists and authors to create unique NFT projects, such as the collaboration with authors Stanley Qiufan Chen and Kai-Fu Lee for the release of their book \"AI 2041: Ten Visions For Our Future\" [3] and the collaboration with David Ariew and Tatler China for the release of the magazine cover featuring an NFT artwork [4].\\n\\nOverall, TRLab aims to redefine the NFT art space and provide a platform for artists and collectors to engage with and explore the potential of NFTs in the art world. ","date":"2023-08-01","objectID":"/trlab/:1:6","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"1.6 æ”¹è¿›æ–¹å‘ å¯¹äºæ–‡æœ¬åˆ†ç‰‡ï¼Œæœ‰å¯èƒ½å‡ºç°è¯­ä¹‰ä¸¢å¤±ç°è±¡ï¼Œæ¯”å¦‚ï¼š å°æ˜çš„çˆ±å¥½æœ‰å¾ˆå¤šï¼Œ\u003cfont color = â€œblue\"\u003eæ¯”å¦‚ï¼šä¹’ä¹“çƒï¼Œç¾½æ¯›çƒï¼Œè·‘æ­¥ã€‚ å¦‚æœé—®é¢˜æ˜¯â€œå°æ˜çš„çˆ±å¥½ï¼Ÿâ€ï¼Œé‚£ä¹ˆå°±æ— æ³•åŒ¹é…åˆ°ã€‚ éœ€è¦è°ƒç ”ä¸ LLM å¯¹åº”çš„è¯­ä¹‰åˆ†ç‰‡å·¥å…·ï¼Œåœ¨å°½å¯èƒ½ä¿è¯å¥å­è¯­ä¹‰å®Œæ•´çš„å‰æä¸‹æ ¹æ® ChunkSize è¿›è¡Œåˆ†ç‰‡ï¼Œæ¯”å¦‚æŒ‰ç…§å®Œæ•´è¯­ä¹‰è¿›è¡Œå›æº¯ã€‚ å¯¹ä¸åŒè¯­ç§çš„æ”¯æŒï¼Œç”±äºææ–™æ˜¯è‹±æ–‡ï¼Œæ— æ³•é€šè¿‡å·²æœ‰æ¥å£è¿›è¡Œä¸åŒè¯­ç§é—´çš„ç›¸ä¼¼åº¦åŒ¹é…ã€‚ ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸‹æ–‡çš„æ–‡æœ¬åŒ¹é…ä¸ä¼šæºå¸¦ä¸Šæ–‡ï¼ŒEmbedding æ–¹å¼çš„ç¼ºé™·ï¼Œæ¯”å¦‚ï¼š Question What is rhizome? When was it created? å‚è€ƒæ–‡ç« ï¼š openai-cookbook https://hackernoon.com/how-to-customize-an-openai-chatbot-with-embedding https://mp.weixin.qq.com/s/MpF9xBHYjgnCHNkFn1AsOA https://mp.weixin.qq.com/s/movaNCWjJGBaes6KxhpYpg ","date":"2023-08-01","objectID":"/trlab/:1:7","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"äºŒã€æ‹¼å­—æ¸¸æˆ ","date":"2023-08-01","objectID":"/trlab/:2:0","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"2.1 éœ€æ±‚åˆ†æ ç±»ä¼¼äºhttps://sculpture.co/gameï¼Œå®ç°æ‹¼å­—æ¸¸æˆã€‚å…·ä½“éœ€æ±‚åˆ†æå¦‚ä¸‹ï¼š graph id1(æ‹¼å­—æ¸¸æˆ) id1 --\u003e ç›¸é‚»å­—ç¬¦ä¸²å¯æ‹¼æ¥ id1 --\u003e å¯åŒ…å«ç©ºæ ¼ id1 --\u003e ä¸åŒºåˆ†å­—ç¬¦ä½ç½® id1 --\u003e ç¡®ä¿å¯æ‹¼æ¥æˆåŸå­—ç¬¦ä¸² ","date":"2023-08-01","objectID":"/trlab/:2:1","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"2.2 æ•´ä½“æµç¨‹ å°†åŸå§‹å­—ç¬¦ä¸² word è¿›è¡Œæ‹†åˆ† ä¸¤ç§æƒ…å†µï¼š ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸ä¸º çš„å­—ç¬¦ï¼Œå•ç‹¬åˆ’åˆ†ï¼› ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º çš„å­—ç¬¦ï¼Œåˆå¹¶ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚ type WordGame struct { Word string WordParts []string } func NewWordGame(word string) *WordGame { wg := \u0026WordGame{Word: word} for i := 0; i \u003c len(wg.Word); i++ { if i \u003c len(wg.Word)-1 \u0026\u0026 wg.Word[i+1] == ' ' { wg.WordParts = append(wg.WordParts, wg.Word[i:i+2]) i++ // è·³è¿‡ ' ' } else { wg.WordParts = append(wg.WordParts, string(wg.Word[i])) } } return wg } æ‹¼æ¥å­—ç¬¦ä¸² è¯¥å‡½æ•°çš„å‚æ•°ä¸ºï¼šcurrentIndexï¼ŒcurrentPosï¼ŒtouchedIndexï¼ŒtouchedPosï¼Œåˆ†åˆ«ä»£è¡¨é€‰ä¸­å­—ç¬¦ä¸²çš„ä¸‹æ ‡ï¼Œé€‰ä¸­å­—ç¬¦ä¸²çš„æ‘†æ”¾ä½ç½®ï¼Œé è¿‘å­—ç¬¦ä¸²çš„ä¸‹æ ‡ï¼Œé è¿‘å­—ç¬¦ä¸²çš„æ‘†æ”¾ä½ç½®ã€‚ åˆ¤æ–­æ‰€é€‰çš„ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦èƒ½æ‹¼æ¥ï¼Œä¸»è¦å°±æ˜¯çœ‹ï¼š åŸå­—ç¬¦ä¸²æ˜¯å¦åŒ…å«äº†æ‹¼æ¥åçš„å­ä¸²ï¼› æ‹¼æ¥å®Œæˆåçš„ wordParts æ˜¯å¦è¿˜èƒ½æ‹¼æ¥å›åŸå­—ç¬¦ä¸²ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…ç›¸åŒå­—ç¬¦ä¸²çš„å½±å“ã€‚ ç¬¬ä¸€æ­¥ç›¸å½“äºå‰ªæï¼Œå› ä¸ºç¬¬äºŒæ­¥é€šè¿‡å›æº¯ï¼Œæ—¶é—´å¤æ‚åº¦è¾ƒé«˜ã€‚ func (wg *WordGame) TryConnect(currentIndex, currentPos, touchedIndex, touchedPos int) { // åˆ¤æ–­è¾“å…¥æ˜¯å¦åˆæ³• if currentIndex == touchedIndex || currentIndex \u003c 0 || touchedIndex \u003c 0 || currentIndex \u003e= len(wg.WordParts) || touchedIndex \u003e= len(wg.WordParts) || currentPos^touchedPos \u003e= 0 { fmt.Println(\"invalid input\") return } // è®¾ç½®æ‹¼æ¥å­—ç¬¦ä¸²çš„ä½ç½® var leftPart, rightPart string if currentPos \u003e 0 { leftPart, rightPart = wg.WordParts[currentIndex], wg.WordParts[touchedIndex] } else { leftPart, rightPart = wg.WordParts[touchedIndex], wg.WordParts[currentIndex] } // åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‹¼æ¥ temp := wg.WordParts[currentIndex] wg.WordParts[currentIndex] = leftPart + rightPart // æ­¤å¤„äº¤æ¢æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜å’Œæ—¶é—´ï¼Œå¦åˆ™éœ€è¦é‡æ–°å¼€è¾Ÿ Slice å¹¶æ‹·è´åŸæ•°æ® wg.WordParts[touchedIndex], wg.WordParts[len(wg.WordParts)-1] = wg.WordParts[len(wg.WordParts)-1], wg.WordParts[touchedIndex] // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å«æœ‰æ‹¼æ¥æˆçš„å­—ç¬¦ä¸²(å‰ªæ)ï¼Œç„¶ååˆ¤æ–­æ‹¼æ¥ä¹‹åçš„ wordParts æ˜¯å¦è¿˜å¯ä»¥ç»„æˆ word ok := strings.Contains(wg.Word, wg.WordParts[currentIndex]) \u0026\u0026 isValid(wg.Word, wg.WordParts[:len(wg.WordParts)-1]) wg.WordParts[touchedIndex], wg.WordParts[len(wg.WordParts)-1] = wg.WordParts[len(wg.WordParts)-1], wg.WordParts[touchedIndex] if ok { // è‹¥å¯ä»¥æ‹¼æ¥ï¼Œåˆ™åˆ é™¤åŸæ¥çš„ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œæ·»åŠ æ–°çš„å­—ç¬¦ä¸² wg.WordParts = append(wg.WordParts[:touchedIndex], wg.WordParts[touchedIndex+1:]...) fmt.Println(\"combine success\") } else { // è‹¥ä¸å¯ä»¥æ‹¼æ¥ï¼Œåˆ™æ¢å¤åŸæ¥çš„å­—ç¬¦ä¸² wg.WordParts[currentIndex] = temp fmt.Println(\"combine failed\") } // æ‰“å°å½“å‰çš„ wordParts wg.printWordParts() } åˆ¤æ–­æ‹¼æ¥åçš„ wordParts æ˜¯å¦èƒ½æ‹¼æ¥æˆåŸå­—ç¬¦ä¸²ï¼š // åˆ¤æ–­ wordParts æ˜¯å¦å¯ä»¥ç»„æˆ word func isValid(s string, wordParts []string) bool { var backTrack func(s string, start int) bool backTrack = func(s string, start int) bool { // åŒ¹é…å®Œæ¯• if s == \"\" { return true } flag := false for i := start; i \u003c len(wordParts); i++ { // å›æº¯ if strings.HasPrefix(s, wordParts[i]) { // å½“å‰å­ä¸²æ˜¯ s çš„å‰ç¼€ // æ­¤å¤„äº¤æ¢æ˜¯ä¸ºäº†é€’å½’æ—¶é‡å¤ä½¿ç”¨å­ä¸² wordParts[i], wordParts[start] = wordParts[start], wordParts[i] flag = backTrack(s[len(wordParts[start]):], start+1) wordParts[i], wordParts[start] = wordParts[start], wordParts[i] } // è‹¥æˆç«‹ï¼Œåˆ™ç›´æ¥è¿”å› if flag { break } } return flag } return backTrack(s, 0) } æµ‹è¯• å•å…ƒæµ‹è¯•ï¼š æµ‹è¯•ç”¨ä¾‹æ»¡è¶³éœ€æ±‚åˆ†æä¸­çš„è¦æ±‚ã€‚éšæœºç”Ÿæˆè¦æ“ä½œçš„ä¸‹æ ‡ï¼Œæ£€æµ‹æ˜¯å¦å¯ä»¥æ‹¼æ¥å›åŸå­—ç¬¦ä¸²ã€‚ func TestWordGame_TryConnect(t *testing.T) { tests := []struct { name string word string }{ {\"friendship\", \"friendship\"}, {\"ababab\", \"ababab\"}, {\"testwordgame\", \"testwordgame\"}, {\"test blank word\", \"test blank word\"}, {\"pairs and nicole\", \"pairs and nicole\"}, {\"hello world\", \"hello world\"}, {\"ababa abb aab\", \"ababa abb aab\"}, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { wg := NewWordGame(tt.word) cnt := 0 for len(wg.WordParts) \u003e 1 \u0026\u0026 cnt \u003c= 1000 { cnt++ currentIndex, touchedIndex := rand.Intn(len(wg.WordParts)), rand.Intn(len(wg.WordParts)) fmt.Println(\"currentIndex:\", currentIndex, \"touchedIndex:\", touchedIndex) wg.TryConnect(currentIndex, 1, touchedIndex, -1) // é»˜è®¤ä½ç½® } require.Equal(t, wg.Word, wg.WordParts[0]) }) } } æ€§èƒ½æµ‹è¯•ï¼š éšæœºç”Ÿæˆé•¿åº¦ä¸º n çš„å­—ç¬¦ä¸²ï¼Œæ¯ 5 ä¸ªå­—ç¬¦æ’å…¥ä¸€ä¸ª ï¼Œè§‚å¯Ÿéšå­—ç¬¦ä¸²é•¿åº¦ä¸Šå‡ï¼Œå¯¹æ€§èƒ½çš„å½±å“ã€‚ æ³¨æ„ï¼šæµ‹è¯•æ—¶ï¼Œé¿å…æ‰“å°æ—¥å¿—ï¼Œå¦åˆ™é¢‘ç¹åœ° IO ä¼šä¸¥é‡é™ä½æ•ˆç‡ã€‚ func BenchmarkWordGame_TryConnect(b *testing.B) { for i := 0; i \u003c b.N; i++ { wg := NewWordGame(randomString(30)) cnt := 0 for len(wg.WordParts) \u003e 1 \u0026\u0026 cnt \u003c= 1000 { cnt++ currentIndex, touchedIndex := rand.Intn(len(wg.WordParts)), rand.Intn(len(wg.WordParts)) wg.TryConnect(currentIndex, 1, touchedIndex, -1) } } } const letterBytes = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\" func randomString(n int) string { b := make([]byte, n) for","date":"2023-08-01","objectID":"/trlab/:2:2","tags":["å®ä¹ ","é¡¹ç›®","ChatGPT"],"title":"å®ä¹ -Trlab","uri":"/trlab/"},{"categories":["å…³äº"],"content":" Name Chuyu Education Southeast University Research Direction Blockchain \u0026 Golang QQ 1205667742 Mail jyzhangis12@gmail.com Phone +86 15237174980 ","date":"2023-07-27","objectID":"/about/about/:0:0","tags":["å…³äº"],"title":"About Me","uri":"/about/about/"},{"categories":["é€šç”¨"],"content":"[toc] ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:0:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"ä¸€ã€åŸºæœ¬æµç¨‹ æ‹‰å–æœ€æ–°ä»£ç â€”â€”åˆ›å»ºåˆ†æ”¯â€”â€”æäº¤åˆ†æ”¯è‡³äº‘ç«¯â€”â€”åˆ†æ”¯ä»£ç å®ŒæˆåæŸ¥çœ‹çŠ¶æ€â€”â€”å°†ä»£ç æ·»åŠ è‡³æš‚å­˜åŒºâ€”â€”æœ¬åœ°æäº¤ä»£ç â€”â€”æ¨é€è‡³äº‘ç«¯â€”â€”åˆ‡æ¢ä¸ºä¸»åˆ†æ”¯â€”â€”åˆå¹¶å­åˆ†æ”¯ä»£ç â€”â€”æ¨é€è‡³äº‘ç«¯â€”â€”åˆ é™¤åˆ†æ”¯ ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:1:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"äºŒã€æ‰§è¡Œå‘½ä»¤ åœ¨ä¸»åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull åŸºäºä¸»åˆ†æ”¯åˆ›å»ºå¹¶ä¸”åˆ‡æ¢åˆ°æ–°çš„å­åˆ†æ”¯ï¼ˆæ²¡æœ‰è¿™ä¸ªåˆ†æ”¯å°±ä¼šæ–°å»ºï¼‰ï¼šgit checkout -b åˆ†æ”¯å å…ˆæŠŠæ–°çš„å­åˆ†æ”¯æ¨é€åˆ°äº‘ç«¯ä»“åº“ï¼Œå› ä¸ºæ­¤æ—¶äº‘ç«¯æ²¡æœ‰è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æœæœ‰åˆ™å¿½ç•¥æ­¤æ­¥éª¤ï¼šgit push -u origin åˆ†æ”¯å ç„¶ååˆ›å»ºå¯¹åº”æ–‡ä»¶ï¼Œå¼€å§‹å†™ä»£ç  å°†ä¿®æ”¹è¿‡çš„æ–‡ä»¶å…¨éƒ¨æ·»åŠ åˆ°æš‚å­˜åŒºï¼šgit add . å°†ä»£ç ä¿å­˜åˆ°æœ¬åœ°ä»“åº“ï¼šgit commit -m \"å®Œæˆäº†åˆ†ç±»åŠŸèƒ½å¼€å‘\" å°†æœ¬åœ°ä»£ç æ¨é€åˆ°äº‘ç«¯ï¼šgit push åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯ï¼šgit checkout master æ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull å¦‚æœä¸Šä¸€æ­¥éª¤å­˜åœ¨æ›´æ–°ï¼Œåˆ™è¿›è¡Œå˜åŸºæ“ä½œå³å¤„ç†å†²çªï¼ˆç¬¬å››æ­¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ­¥ åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯ï¼Œåˆå¹¶ä»£ç ï¼šgit merge åˆ†æ”¯å æŠŠä¸»åˆ†æ”¯æ¨é€åˆ°äº‘ç«¯: git push åˆ é™¤æœ¬åœ°çš„åˆ†æ”¯ï¼šgit branch -d åˆ†æ”¯å åˆ é™¤äº‘ç«¯çš„åˆ†æ”¯ï¼šgit push origin --delete åˆ†æ”¯å ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:2:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"ä¸‰ã€å¸¸ç”¨ git å‘½ä»¤ åˆå§‹åŒ–ä¸€ä¸ª git ä»“åº“ï¼šgit init æŸ¥çœ‹çŠ¶æ€ï¼šgit status æ·»åŠ æ‰€æœ‰ä¿®æ”¹ï¼šgit add -A æäº¤ä¿®æ”¹ï¼šgit commit -m \"æäº¤è¯´æ˜\" æŸ¥çœ‹æäº¤å†å²ï¼ŒæŒ‰å­—æ¯ q(uit) é€€å‡ºï¼šgit log æŸ¥çœ‹æ²¡ add çš„ä¸åŒï¼šgit diff(erence) æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯ï¼šgit branch æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯ï¼šgit branch -a åˆ é™¤æœªåˆå¹¶ä»£ç åˆ†æ”¯ï¼šgit branch -D åˆ†æ”¯å æ‹‰å–æœ¬åœ°ä¸å­˜åœ¨çš„è¿œç¨‹åˆ†æ”¯ï¼šgit checkout -b æœ¬åœ°åˆ†æ”¯å origin/è¿œç¨‹åˆ†æ”¯å ä¸è¿œç¨‹ä»“åº“å…³è”ï¼šgit remote add origin åœ°å€ ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:3:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"å››ã€è§£å†³å†²çª pre-1: åœ¨åŸºå‡†åˆ†æ”¯ï¼ˆä¸»åˆ†æ”¯ï¼‰ä¸Šæ¥å–æœ€æ–°çš„ä»£ç  git pull pre-2: åˆ‡æ¢åˆ°è‡ªå·±çš„åˆ†æ”¯ä¸Š git checkout åˆ†æ”¯å git rebase dev è§£å†³å†²çªï¼ˆéœ€è¦å’Œå›¢é˜Ÿä¹‹é—´å•†é‡ï¼‰ git add -A git rebase --continue é‡å¤ 2ï¼Œ3ï¼Œ4 ç›´åˆ° reabase å®Œæˆ,ä¼šå‡ºç° applying å­—æ · æœ‰å¯èƒ½æœ¬åœ°è‡ªå·±çš„åˆ†æ”¯å’Œè¿œç¨‹åˆ†æ”¯è¿˜æœ‰å†²çªï¼Œè¿™æ—¶å€™éœ€è¦ git pull origin qh/home ä¹‹åï¼Œè§£å†³å†²çªå† push å³å¯ ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:4:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"äº”ã€git çš„è¯­ä¹‰åŒ– commit choreï¼šadd Oyster build scriptï¼ˆå…¶ä»–ä¿®æ”¹, æ¯”å¦‚æ„å»ºæµç¨‹, ä¾èµ–ç®¡ç†ï¼‰ docsï¼šexplain hat wobbleï¼ˆæ›´æ”¹æ–‡æ¡£ï¼‰ featï¼šadd beta sequenceï¼ˆæ–°å¢äº†ä¸€ä¸ªåŠŸèƒ½ï¼‰ fixï¼šremove broken confirmation messageï¼ˆä¿®å¤äº†ä¸€ä¸ª bugï¼‰ refactorï¼šshare logic between 4d3d3d3 and flarhgunnstowï¼ˆä»£ç é‡æ„ï¼Œæ—¢ä¸ä¿®å¤é”™è¯¯ä¹Ÿä¸æ·»åŠ åŠŸèƒ½ï¼‰ styleï¼šconvert tabs to spacesï¼ˆä¸å½±å“ä»£ç å«ä¹‰çš„å˜åŒ–ï¼ˆç©ºç™½ã€æ ¼å¼åŒ–ã€ç¼ºå°‘åˆ†å·ç­‰ï¼Œæ³¨æ„ä¸æ˜¯ css ä¿®æ”¹ï¼‰ï¼‰ testï¼šensure Tayne retains clothingï¼ˆæµ‹è¯•ç”¨ä¾‹ä¿®æ”¹ï¼‰ ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:5:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"å…­ã€git merge å’Œ git rebase çš„åŒºåˆ« ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:6:0","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"merge merge ç‰¹ç‚¹ï¼šâ¾ƒåŠ¨åˆ›å»ºâ¼€ä¸ªæ–°çš„ commit å¦‚æœåˆå¹¶çš„æ—¶å€™é‡åˆ°å†²çªï¼Œä»…éœ€è¦ä¿®æ”¹åé‡æ–° commit ä¼˜ç‚¹ï¼šè®°å½•äº†çœŸå®çš„ commit æƒ…å†µï¼ŒåŒ…æ‹¬æ¯ä¸ªåˆ†â½€çš„è¯¦æƒ… ç¼ºç‚¹ï¼šå› ä¸ºæ¯æ¬¡ merge ä¼šâ¾ƒåŠ¨äº§â½£â¼€ä¸ª merge commitï¼Œæ‰€ä»¥åœ¨ä½¿â½¤â¼€äº› git çš„ GUI toolsï¼Œç‰¹åˆ«æ˜¯ commit â½è¾ƒé¢‘ç¹æ—¶ï¼Œçœ‹åˆ°åˆ†æ”¯å¾ˆæ‚ä¹±ã€‚ ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:6:1","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"rebase rebase ç‰¹ç‚¹ï¼šä¼šåˆå¹¶ä¹‹å‰çš„ commit å†å² ä¼˜ç‚¹ï¼šå¾—åˆ°æ›´ç®€æ´çš„é¡¹ç›®å†å²ï¼Œå»æ‰äº† merge commit ç¼ºç‚¹ï¼šå¦‚æœåˆå¹¶å‡ºç°ä»£ç é—®é¢˜ä¸å®¹æ˜“å®šä½ï¼Œå› ä¸º re-write äº† history æ€»ç»“ï¼šå› æ­¤ï¼Œå½“éœ€è¦ä¿ç•™è¯¦ç»†çš„åˆå¹¶ä¿¡æ¯çš„æ—¶å€™å»ºè®®ä½¿â½¤ git mergeï¼Œç‰¹åˆ«æ˜¯éœ€è¦å°†åˆ†æ”¯åˆå¹¶è¿›å…¥ master åˆ†æ”¯æ—¶ï¼›å½“å‘ç°è‡ªå·±ä¿®æ”¹æŸä¸ªåŠŸèƒ½æ—¶ï¼Œé¢‘ç¹è¿›â¾äº† git commit æäº¤æ—¶ï¼Œå‘ç°å…¶å®è¿‡å¤šçš„æäº¤ä¿¡æ¯æ²¡æœ‰å¿…è¦æ—¶ï¼Œå¯ä»¥å°è¯• git rebase. ","date":"2023-07-23","objectID":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/:6:2","tags":["Git","è®¡ç®—æœºåŸºç¡€"],"title":"Git-ä»£ç å†²çª","uri":"/20-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81/"},{"categories":["é€šç”¨"],"content":"ä¸€ã€å¾®æœåŠ¡ ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:1:0","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":"1.1 å¾®æœåŠ¡æŠ€æœ¯æ ˆ å…ˆç»™å‡ºå¾®æœåŠ¡çš„æ¶æ„ï¼š åˆ†ç±»ï¼š ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:1:1","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":"1.2 è®¤è¯†å¾®æœåŠ¡ å•ä½“æ¶æ„ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“åŒ…æˆä¸€ä¸ªéƒ¨ç½²ã€‚ ä¼˜ç‚¹ï¼šæ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½ï¼› ç¼ºç‚¹ï¼šè€¦åˆåº¦å¤ªé«˜ï¼Œä¸é€‚åˆå¤§å‹é¡¹ç›®ã€‚ å¾®æœåŠ¡æ¶æ„çš„ç‰¹å¾ï¼š å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†çš„ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£ï¼Œé¿å…é‡å¤ä¸šåŠ¡å¼€å‘ï¼› é¢å‘æœåŠ¡ï¼šå¾®æœåŠ¡å¯¹å¤–æš´éœ²ä¸šåŠ¡æ¥å£ï¼Œå…è®¸è¿œç¨‹è°ƒç”¨ï¼› éš”ç¦»æ€§å¼ºï¼šå„æœåŠ¡åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ç­‰ï¼Œé¿å…æœåŠ¡æŒ‚äº†å¯¹å…¶ä»–æœåŠ¡äº§ç”Ÿå½±å“ã€‚ ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:1:2","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":"äºŒã€gRPC ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:2:0","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":"æ¦‚è¿° gRPC æ˜¯è°·æ­Œæ¨å‡ºçš„ä¸€ä¸ªå¼€æºã€é«˜æ€§èƒ½çš„ RPC æ¡†æ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ protoBuf è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¹¶åŸºäº HTTP/2 ä¼ è¾“æŠ¥æ–‡ï¼Œå¸¦æ¥è¯¸å¦‚å¤šè¯·æ±‚å¤ç”¨ä¸€ä¸ª TCP è¿æ¥(æ‰€è°“çš„å¤šè·¯å¤ç”¨)ã€åŒå‘æµã€æµæ§ã€å¤´éƒ¨å‹ç¼©ç­‰ç‰¹æ€§ã€‚ åœ¨ gRPC ä¸­ï¼Œå¼€å‘è€…å¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œé€šè¿‡ gRPC çš„å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœºå™¨ä¸Š gRPC æœåŠ¡çš„æ–¹æ³•ã€‚gRPC å®¢æˆ·ç«¯å°è£…äº† HTTP/2 åè®®æ•°æ®å¸§çš„æ‰“åŒ…ã€ä»¥åŠç½‘ç»œå±‚çš„é€šä¿¡ç»†èŠ‚ï¼ŒæŠŠå¤æ‚ç•™ç»™æ¡†æ¶è‡ªå·±ï¼ŒæŠŠä¾¿æ·æä¾›ç»™ç”¨æˆ·ã€‚ gRPC åŸºäºè¿™æ ·çš„ä¸€ä¸ªè®¾è®¡ç†å¿µï¼š å®šä¹‰ä¸€ä¸ªæœåŠ¡ï¼ŒåŠå…¶è¢«è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•(æ–¹æ³•åç§°ã€å…¥å‚ã€å‡ºå‚)ï¼Œåœ¨ gRPC æœåŠ¡ç«¯å®ç°è¿™ä¸ªæ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶åœ¨ gRPC æœåŠ¡ç«¯å¤„ç†æ¥è‡ªè¿œç¨‹å®¢æˆ·ç«¯å¯¹è¿™ä¸ª RPC æ–¹æ³•çš„è°ƒç”¨ï¼› åœ¨ gRPC å®¢æˆ·ç«¯ä¹Ÿæ‹¥æœ‰è¿™ä¸ª RPC æ–¹æ³•çš„å­˜æ ¹(stub)ã€‚gRPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¯ä»¥ç”¨ä»»ä½•æ”¯æŒ gRPC çš„è¯­è¨€æ¥å®ç°ï¼Œä¾‹å¦‚ä¸€ä¸ª gRPC æœåŠ¡ç«¯å¯ä»¥æ˜¯ C++ è¯­è¨€ç¼–å†™çš„ï¼Œä»¥ä¾› Ruby è¯­è¨€çš„ gRPC å®¢æˆ·ç«¯å’Œ JAVA è¯­è¨€çš„ gRPC å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š gRPC é»˜è®¤ä½¿ç”¨ ProtoBuf å¯¹è¯·æ±‚/å“åº”è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¿™ä½¿å¾—ä¼ è¾“çš„è¯·æ±‚ä½“å’Œå“åº”ä½“æ¯” JSON ç­‰åºåˆ—åŒ–æ–¹å¼åŒ…ä½“æ›´å°ã€æ›´è½»é‡ã€‚ gRPC åŸºäº HTTP/2 åè®®ä¼ è¾“æŠ¥æ–‡ï¼ŒHTTP/2 å…·æœ‰å¤šè·¯å¤ç”¨ã€å¤´éƒ¨å‹ç¼©ç­‰ç‰¹æ€§ï¼ŒåŸºäº HTTP/2 çš„å¸§è®¾è®¡ï¼Œå®ç°äº†å¤šä¸ªè¯·æ±‚å¤ç”¨ä¸€ä¸ª TCP è¿æ¥ï¼ŒåŸºæœ¬è§£å†³äº† HTTP/1.1 çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œç›¸å¯¹ HTTP/1.1 å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ã€‚ ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:2:1","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":"åè®®æ ¼å¼ gRPC åŸºäº HTTP/2/åè®®è¿›è¡Œé€šä¿¡ï¼Œä½¿ç”¨ ProtoBuf åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼ŒgRPC çš„åè®®æ ¼å¼å¦‚ä¸‹å›¾ï¼š gRPC åè®®åœ¨ HTTP åè®®çš„åŸºç¡€ä¸Šï¼Œå¯¹ HTTP/2 çš„å¸§çš„**æœ‰æ•ˆåŒ…ä½“(Frame Payload)**åšäº†è¿›ä¸€æ­¥ç¼–ç ï¼šgRPC åŒ…å¤´(5 å­—èŠ‚)+gRPC å˜é•¿åŒ…å¤´ï¼Œå…¶ä¸­ï¼š 5 å­—èŠ‚çš„ gRPC åŒ…å¤´ï¼š1 å­—èŠ‚çš„å‹ç¼©æ ‡å¿—(compress flag) å’Œ 4 å­—èŠ‚çš„ gRPC åŒ…å¤´é•¿åº¦ï¼› gRPC åŒ…ä½“é•¿åº¦æ˜¯å˜é•¿çš„ï¼Œæ˜¯ä¸€ä¸²äºŒè¿›åˆ¶æµï¼šä½¿ç”¨æŒ‡å®šåºåˆ—åŒ–æ–¹å¼(é€šå¸¸æ˜¯ ProtoBuf)åºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œå†ä½¿ç”¨æŒ‡å®šçš„å‹ç¼©ç®—æ³•å¯¹åºåˆ—åŒ–çš„å­—èŠ‚æµå‹ç¼©è€Œæˆçš„ã€‚å¦‚æœå¯¹åºåˆ—åŒ–å­—èŠ‚æµè¿›è¡Œäº†å‹ç¼©ï¼ŒgRPC åŒ…å¤´çš„å‹ç¼©æ ‡å¿—ä¸º 1ã€‚ ","date":"2023-07-03","objectID":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/:2:2","tags":["å¾®æœåŠ¡"],"title":"å¾®æœåŠ¡åŸºç¡€çŸ¥è¯† ","uri":"/14-%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"categories":["é€šç”¨"],"content":" å‰è¨€ï¼šProtobuf çš„ç¼–ç æ˜¯åŸºäºå˜ç§çš„ Base 128ã€‚å› æ­¤ï¼ŒæŒ‰ç…§ Base 64 --\u003e Base 128 --\u003e Protobuf çš„é¡ºåºæ¥å­¦ä¹ æ¯”è¾ƒå¥½~ åŸæ–‡é“¾æ¥ ","date":"2023-06-21","objectID":"/13-protobuf/:0:0","tags":["åºåˆ—åŒ–"],"title":"Protobufæµ…æ","uri":"/13-protobuf/"},{"categories":["é€šç”¨"],"content":"ä¸€ã€Base 64 è®¡ç®—æœºä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œæ•°æ®æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸²å­—èŠ‚æµã€‚ç”±äºä¸åŒæœºå™¨é‡‡ç”¨çš„å­—ç¬¦é›†ä¸åŒç­‰åŸå› ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ç›®æ ‡æœºå™¨èƒ½å¤Ÿæ­£ç¡®åœ°â€œç†è§£â€å­—èŠ‚æµã€‚ å…ˆçœ‹çœ‹ Base 64 å¦‚ä½•å·¥ä½œï¼Œå‡è®¾è¿™é‡Œæœ‰ 4 ä¸ªå­—èŠ‚ï¼Œä»£è¡¨è¦ä¼ è¾“çš„äºŒè¿›åˆ¶æ•°æ®ï¼š é¦–å…ˆå°†è¿™ä¸ªå­—èŠ‚æµæŒ‰æ¯ 6 ä¸ª bit ä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„ï¼Œå‰©ä¸‹å°‘äº 6 bits çš„ä½ä½è¡¥ 0ï¼› ç„¶ååœ¨æ¯ä¸€ç»„ 6 bits çš„é«˜ä½è¡¥ä¸¤ä¸ª 0ï¼› å¯¹ç…§ Base 64 tableï¼Œå­—èŠ‚æµå¯ä»¥ç”¨ ognC0w æ¥è¡¨ç¤ºã€‚å¦å¤–ï¼ŒBase 64 ç¼–ç æ˜¯æŒ‰ç…§ 6 bits ä¸ºä¸€ç»„è¿›è¡Œç¼–ç ï¼Œæ¯ 3 ä¸ªå­—èŠ‚çš„åŸå§‹æ•°æ®è¦ç”¨ 4 ä¸ªå­—èŠ‚æ¥å‚¨å­˜ï¼Œç¼–ç åçš„é•¿åº¦è¦ä¸º 4 çš„æ•´æ•°å€ï¼Œä¸è¶³ 4 å­—èŠ‚çš„éƒ¨åˆ†è¦ä½¿ç”¨ pad è¡¥é½ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ç¼–ç ç»“æœä¸ºognC0w==ã€‚ Base 64 ç¼–ç ä¹‹åæ‰€æœ‰å­—èŠ‚å‡å¯ä»¥ç”¨æ•°å­—ã€å­—æ¯ã€+ã€/ã€= è¿›è¡Œè¡¨ç¤ºï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥è¢«æ­£å¸¸æ˜¾ç¤ºçš„ ascii å­—ç¬¦ï¼Œå³**â€œå®‰å…¨â€çš„å­—èŠ‚**ã€‚ç»å¤§éƒ¨åˆ†çš„è®¡ç®—æœºå’Œæ“ä½œç³»ç»Ÿéƒ½å¯¹ ascii æœ‰ç€è‰¯å¥½çš„æ”¯æŒï¼Œä¿è¯äº†ç¼–ç ä¹‹åçš„å­—èŠ‚æµèƒ½è¢«æ­£ç¡®åœ°å¤åˆ¶ã€ä¼ æ’­ã€è§£æã€‚ Base 64 å­˜åœ¨çš„é—®é¢˜å°±æ˜¯ï¼šç¼–ç åçš„æ¯ä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä¸¤ä½æ€»æ˜¯ 0ï¼Œåœ¨ä¸è€ƒè™‘ pad çš„æƒ…å†µä¸‹ï¼Œæœ‰æ•ˆ bit åªå  bit æ€»æ•°çš„ 75%ï¼Œé€ æˆå¤§é‡çš„ç©ºé—´æµªè´¹ã€‚ ","date":"2023-06-21","objectID":"/13-protobuf/:1:0","tags":["åºåˆ—åŒ–"],"title":"Protobufæµ…æ","uri":"/13-protobuf/"},{"categories":["é€šç”¨"],"content":"äºŒã€Base 128 å› æ­¤ï¼ŒBase 128 çš„å¤§è‡´å®ç°æ€è·¯æ˜¯ï¼šå°†å­—èŠ‚æµæŒ‰ 7 bits è¿›è¡Œåˆ†ç»„ï¼Œç„¶åä½ä½è¡¥ 0ã€‚ ä½†é—®é¢˜æ¥äº†ï¼ŒBase 64 å®é™…ä¸Šç”¨äº† 2^6^+1 ä¸ª ascii å­—ç¬¦ï¼ŒæŒ‰ç…§è¿™ä¸ªæ€è·¯ Base 128 éœ€è¦ä½¿ç”¨ 2^7^+1 ä¸ª ascii ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯ ascii å­—ç¬¦ä¸€å…±åªæœ‰ 128 ä¸ªã€‚å¦å¤–ï¼Œå³ä½¿ä¸è€ƒè™‘ padï¼Œascii ä¸­åŒ…å«äº†ä¸€äº›ä¸å¯ä»¥æ­£å¸¸æ‰“å°çš„æ§åˆ¶å­—ç¬¦ï¼Œç¼–ç ä¹‹åçš„å­—ç¬¦è¿˜å¯èƒ½åŒ…å«ä¼šè¢«ä¸åŒæ“ä½œç³»ç»Ÿè½¬æ¢çš„æ¢è¡Œç¬¦å·(10 å’Œ 13)ã€‚å› æ­¤ï¼ŒBase 64 è‡³ä»Šä¾ç„¶æ²¡æœ‰è¢« Base 128 æ›¿ä»£ã€‚ ","date":"2023-06-21","objectID":"/13-protobuf/:2:0","tags":["åºåˆ—åŒ–"],"title":"Protobufæµ…æ","uri":"/13-protobuf/"},{"categories":["é€šç”¨"],"content":"ä¸‰ã€Base 128 Varints Protocol Buffers æ‰€ç”¨çš„ç¼–ç æ–¹å¼å°±æ˜¯ Base 128 Varintsã€‚(æŒ‰ç…§å°ç«¯æ¨¡å¼è®¨è®º) ç¼–ç /è§£ç  å¯¹äºç¼–ç åçš„æ¯ä¸ªå­—èŠ‚ï¼Œä½ 7 ä½ç”¨äºå‚¨å­˜æ•°æ®ï¼Œæœ€é«˜ä½ç”¨æ¥æ ‡è¯†å½“å‰å­—èŠ‚æ˜¯å¦æ˜¯å½“å‰æ•´æ•°çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºæœ€é«˜æœ‰æ•ˆä½ï¼ˆmost significant bit, msbï¼‰ã€‚msb ä¸º 1 æ—¶ï¼Œä»£è¡¨ç€åé¢è¿˜æœ‰æ•°æ®ï¼›msb ä¸º 0 æ—¶ä»£è¡¨ç€å½“å‰å­—èŠ‚æ˜¯å½“å‰æ•´æ•°çš„æœ€åä¸€ä¸ªå­—èŠ‚ã€‚ å¦‚ä½•å°†ä½¿ç”¨ Base 128 Varints å¯¹æ•´æ•°è¿›è¡Œç¼–ç ï¼š å°†æ•°æ®æŒ‰æ¯ 7 bits ä¸€ç»„æ‹†åˆ† é€†åºæ¯ä¸€ä¸ªç»„(å› ä¸ºå°ç«¯) æ·»åŠ  msb å¦‚ä½•å°†ä½¿ç”¨ Base 128 Varints å¯¹æ•´æ•°è¿›è¡Œè§£ç ï¼š å»é™¤ msb å°†å­—èŠ‚æµé€†åº(msb ä¸º 0 çš„å­—èŠ‚å‚¨å­˜åŸå§‹æ•°æ®çš„é«˜ä½éƒ¨åˆ†ï¼Œå°ç«¯æ¨¡å¼) æœ€åæ‹¼æ¥æ‰€æœ‰çš„ bitsã€‚ 300 (0b 10 0101100)ç¼–ç ï¼š è§£ç ï¼š protobuf çš„ varints æœ€å¤šå¯ä»¥ç¼–ç  8 å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºç»å¤§éƒ¨åˆ†çš„ç°ä»£è®¡ç®—æœºæœ€é«˜æ”¯æŒå¤„ç† 64 ä½çš„æ•´å‹ã€‚ ","date":"2023-06-21","objectID":"/13-protobuf/:3:0","tags":["åºåˆ—åŒ–"],"title":"Protobufæµ…æ","uri":"/13-protobuf/"},{"categories":["é€šç”¨"],"content":"å››ã€Protobuf Protocol Buffers æ‰€ç”¨çš„ç¼–ç æ–¹å¼å°±æ˜¯ Base 128 Varintsã€‚(æŒ‰ç…§å°ç«¯æ¨¡å¼è®¨è®º) æ•°æ®ç±»å‹ protobuf æ”¯æŒçš„æ•°æ®ç±»å‹(wire type)ï¼š å½“å®é™…ä½¿ç”¨ protobuf è¿›è¡Œç¼–ç æ—¶ï¼Œç»è¿‡äº†ä¸¤æ­¥å¤„ç†ï¼š å°† ç¼–ç¨‹è¯­è¨€çš„æ•°æ®ç»“æ„ è½¬åŒ–ä¸º wire typeã€‚ æ ¹æ®ä¸åŒçš„ wire type ä½¿ç”¨å¯¹åº”çš„æ–¹æ³•ç¼–ç ã€‚å‰æ–‡æ‰€æåˆ°çš„ Base 128 Varints ç”¨æ¥ç¼–ç  varint ç±»å‹çš„æ•°æ®ï¼Œå…¶ä»– wire type åˆ™ä½¿ç”¨å…¶ä»–ç¼–ç æ–¹å¼ã€‚ éƒ¨åˆ†æ•°æ®ç±»å‹åˆ° wire type çš„è½¬æ¢è§„åˆ™ï¼š æœ‰ç¬¦å·æ•´å‹ é‡‡ç”¨ ZigZag ç¼–ç æ¥å°† sint32 å’Œ sint64 è½¬æ¢ä¸º wire type 0ã€‚ä¸‹é¢æ˜¯ ZigZag ç¼–ç çš„è§„åˆ™ï¼ˆæ³¨æ„æ˜¯ç®—æœ¯ä½ç§»ï¼‰ï¼š n * 2 // when n \u003e= 0 -n * 2 - 1 // when n \u003c 0 ä¸€äº›ä¾‹å­ï¼š å®šé•¿æ•°æ®(64-bit) ç›´æ¥é‡‡ç”¨å°ç«¯æ¨¡å¼å‚¨å­˜ï¼Œä¸ä½œè½¬æ¢ã€‚ å­—ç¬¦ä¸² ä»¥å­—ç¬¦ä¸²\"testing\"ä¸ºä¾‹ï¼š ç¼–ç åçš„ value åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š è“è‰²ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²é‡‡ç”¨ UTF-8 ç¼–ç åå­—èŠ‚æµçš„é•¿åº¦(bytes)ï¼Œé‡‡ç”¨ Base 128 Varints è¿›è¡Œç¼–ç ã€‚ ç™½è‰²ï¼Œå­—ç¬¦ä¸²ç”¨ UTF-8 ç¼–ç åçš„å­—èŠ‚æµã€‚ æ¶ˆæ¯ç»“æ„ Protobuf é‡‡ç”¨ proto3 ä½œä¸º DSL æ¥æè¿°å…¶æ”¯æŒçš„æ¶ˆæ¯ç»“æ„ã€‚ syntax = \"proto3\"; message SearchRequest { string query = 1; int32 page_number = 2; int32 result_per_page = 3; } è®¾æƒ³ä¸€ä¸‹è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæ•°æ®çš„å‘é€æ–¹åœ¨ä¸šåŠ¡è¿­ä»£ä¹‹åéœ€è¦åœ¨æ¶ˆæ¯å†…æºå¸¦æ›´å¤šçš„å­—æ®µï¼Œè€Œæœ‰çš„æ¥æ”¶æ–¹å¹¶æ²¡æœ‰æ›´æ–°è‡ªå·±çš„ proto æ–‡ä»¶ã€‚è¦ä¿æŒè¾ƒå¥½çš„å…¼å®¹æ€§ï¼Œæ¥æ”¶æ–¹éœ€è¦åˆ†è¾¨å‡ºå“ªäº›å­—æ®µæ˜¯è‡ªå·±å¯ä»¥è¯†åˆ«çš„ï¼Œå“ªäº›æ˜¯ä¸èƒ½è¯†åˆ«çš„æ–°å¢å­—æ®µã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå‘é€æ–¹åœ¨ç¼–ç æ¶ˆæ¯æ—¶è¿˜å¿…é¡»é™„å¸¦æ¯ä¸ªå­—æ®µçš„ keyï¼Œå®¢æˆ·ç«¯è¯»å–åˆ°æœªçŸ¥çš„ key æ—¶ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡å¯¹åº”çš„ valueã€‚ proto3 ä¸­æ¯ä¸€ä¸ªå­—æ®µåé¢éƒ½æœ‰ä¸€ä¸ª = xï¼Œæ¯”å¦‚ï¼š string query = 1; è¿™é‡Œçš„ç­‰å·å¹¶ä¸æ˜¯ç”¨äºèµ‹å€¼ï¼Œè€Œæ˜¯ç»™æ¯ä¸€ä¸ªå­—æ®µæŒ‡å®šä¸€ä¸ª IDï¼Œç§°ä¸º field numberã€‚æ¶ˆæ¯å†…åŒä¸€å±‚æ¬¡å­—æ®µçš„ field number å¿…é¡»å„ä¸ç›¸åŒã€‚ ä¸Šé¢æ‰€è¯´çš„ keyï¼Œåœ¨ protobuf æºç ä¸­è¢«ç§°ä¸º tagã€‚tag ç”± field number å’Œ type ä¸¤éƒ¨åˆ†ç»„æˆï¼š field number å·¦ç§» 3 bits åœ¨æœ€ä½ 3 bits å†™å…¥ wire type ä¸€ä¸ªç”Ÿæˆ tag çš„ä¾‹å­ï¼š Go ç‰ˆæœ¬ Protobuf ä¸­ç”Ÿæˆ tag çš„æºç ï¼š func EncodeTag(num Number, typ Type) uint64 { return uint64(num)\u003c\u003c3 | uint64(typ\u00267) } æºç ä¸­ç”Ÿæˆçš„ tag æ˜¯ uint64ï¼Œä»£è¡¨ç€ field number å¯ä»¥ä½¿ç”¨ 61 ä¸ª bit å—ï¼Ÿå¹¶éå¦‚æ­¤ã€‚äº‹å®ä¸Šï¼Œ==tag çš„é•¿åº¦ä¸èƒ½è¶…è¿‡ 32 bits==ï¼Œæ„å‘³ç€ field number çš„æœ€å¤§å–å€¼ä¸º 2^29^-1 (536870911)ã€‚è€Œä¸”åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œæœ‰ä¸€äº›æ•°æ˜¯ä¸èƒ½è¢«ä½¿ç”¨çš„ï¼š 0ï¼šprotobuf è§„å®š field number å¿…é¡»ä¸ºæ­£æ•´æ•°ã€‚ 19000 åˆ° 19999ï¼š protobuf ä»…ä¾›å†…éƒ¨ä½¿ç”¨çš„ä¿ç•™ä½ã€‚ ç†è§£äº†ç”Ÿæˆ tag çš„è§„åˆ™ä¹‹åï¼Œä¸éš¾å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š field number ä¸å¿…ä» 1 å¼€å§‹ï¼Œå¯ä»¥ä»åˆæ³•èŒƒå›´å†…çš„ä»»æ„æ•°å­—å¼€å§‹ã€‚ ä¸åŒå­—æ®µé—´çš„ field number ä¸å¿…è¿ç»­ï¼Œåªè¦åˆæ³•ä¸”ä¸åŒå³å¯ã€‚ å½“ä¿®æ”¹ proto æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ³¨æ„â­ï¼š field number ä¸€æ—¦è¢«åˆ†é…äº†å°±ä¸åº”è¯¥è¢«æ›´æ”¹ï¼Œé™¤éä½ èƒ½ä¿è¯æ‰€æœ‰çš„æ¥æ”¶æ–¹éƒ½èƒ½æ›´æ–°åˆ°æœ€æ–°çš„ proto æ–‡ä»¶ï¼› ç”±äº tag ä¸­ä¸æºå¸¦ field name ä¿¡æ¯ï¼Œæ›´æ”¹ field name å¹¶ä¸ä¼šæ”¹å˜æ¶ˆæ¯çš„ç»“æ„ã€‚å‘é€æ–¹è®¤ä¸ºçš„ apple åˆ°æ¥å—æ–¹å¯èƒ½ä¼šè¢«è¯†åˆ«æˆ pearã€‚åŒæ–¹æŠŠå­—æ®µè¯»å–æˆå“ªä¸ªåå­—å®Œå…¨ç”±åŒæ–¹è‡ªå·±çš„ proto æ–‡ä»¶å†³å®šï¼Œåªè¦å­—æ®µçš„ wire type å’Œ field number ç›¸åŒå³å¯ã€‚ æœ€åå†æ¥ä¸ªå¤æ‚ä¾‹å­(èƒ½çœ‹æ˜ç™½å°±ç®—ä¼šäº†~)ï¼š åµŒå¥—æ¶ˆæ¯ wire type 2ä¸ä»…æ”¯æŒ stringï¼Œä¹Ÿæ”¯æŒ embedded messagesã€‚ å¯¹äºåµŒå¥—æ¶ˆæ¯ï¼š é¦–å…ˆè¦å°†è¢«åµŒå¥—çš„æ¶ˆæ¯è¿›è¡Œç¼–ç æˆå­—èŠ‚æµï¼› ç„¶åå°±å¯ä»¥åƒå¤„ç† UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ä¸€æ ·å¤„ç†è¿™äº›å­—èŠ‚æµï¼šåœ¨å­—èŠ‚æµå‰é¢åŠ å…¥ä½¿ç”¨ Base 128 Varints ç¼–ç çš„é•¿åº¦å³å¯ã€‚ èƒ½çœ‹æ˜ç™½å°±æ˜¯èƒœåˆ©ï¼ğŸ˜‰ å­—æ®µé¡ºåº Proto æ–‡ä»¶ä¸­å®šä¹‰å­—æ®µçš„é¡ºåºä¸æœ€ç»ˆç¼–ç ç»“æœçš„å­—æ®µé¡ºåºæ— å…³ï¼Œä¸¤è€…æœ‰å¯èƒ½ç›¸åŒä¹Ÿå¯èƒ½ä¸åŒã€‚ ä»»ä½• Protobuf çš„å®ç°éƒ½åº”è¯¥ä¿è¯å­—æ®µä»¥ä»»æ„é¡ºåºç¼–ç çš„ç»“æœéƒ½èƒ½è¢«è§£ç ã€‚ å®‰å…¨æ€§ ç”±äº Protobuf åºåˆ—åŒ–åå°±æ˜¯ä¸€å †å­—èŠ‚æµï¼Œéœ€è¦æœ‰åŸ Proto å£°æ˜æ–‡ä»¶æ‰èƒ½ååºåˆ—åŒ–ï¼Œå› æ­¤ä¹Ÿå…·å¤‡ä¸€å®šçš„ä¿å¯†æ€§ã€‚ å¯¹æ¯”JSONã€XML XMLã€JSON æ›´æ³¨é‡æ•°æ®ç»“æ„åŒ–ï¼Œå…³æ³¨äººç±»å¯è¯»æ€§å’Œè¯­ä¹‰è¡¨è¾¾èƒ½åŠ›ï¼› ProtoBuf æ›´æ³¨é‡æ•°æ®åºåˆ—åŒ–ï¼Œå…³æ³¨æ•ˆç‡ã€ç©ºé—´ã€é€Ÿåº¦ï¼Œäººç±»å¯è¯»æ€§å·®ï¼Œè¯­ä¹‰è¡¨è¾¾èƒ½åŠ›ä¸è¶³ï¼ˆä¸ºä¿è¯æè‡´çš„æ•ˆç‡ï¼Œä¼šèˆå¼ƒä¸€éƒ¨åˆ†å…ƒä¿¡æ¯ï¼‰ ProtoBuf çš„åº”ç”¨åœºæ™¯æ›´ä¸ºæ˜ç¡®ï¼ŒXMLã€JSON çš„åº”ç”¨åœºæ™¯æ›´ä¸ºä¸°å¯Œã€‚ ","date":"2023-06-21","objectID":"/13-protobuf/:4:0","tags":["åºåˆ—åŒ–"],"title":"Protobufæµ…æ","uri":"/13-protobuf/"},{"categories":["é€šç”¨"],"content":" é—®ï¼šä»€ä¹ˆæ˜¯ JWT ï¼Ÿ JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ä¸€ç§åŸºäº Token çš„è®¤è¯æˆæƒæœºåˆ¶ã€‚ä» JWT çš„å…¨ç§°å¯ä»¥çœ‹å‡ºï¼ŒJWT æœ¬èº«ä¹Ÿæ˜¯ Tokenï¼Œä¸€ç§è§„èŒƒåŒ–ä¹‹åçš„ JSON ç»“æ„çš„ Tokenã€‚ JWT è‡ªèº«åŒ…å«äº†èº«ä»½éªŒè¯æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Session ä¿¡æ¯ã€‚è¿™æ˜¾ç„¶å¢åŠ äº†ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œä¼¸ç¼©æ€§ï¼Œå¤§å¤§å‡è½»äº†æœåŠ¡ç«¯çš„å‹åŠ›ã€‚ JWT æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç»„å­—ç¬¦ä¸²ï¼Œé€šè¿‡ï¼ˆ.ï¼‰åˆ‡åˆ†æˆä¸‰ä¸ªä¸º Base64 ç¼–ç çš„éƒ¨åˆ†ï¼š Headerï¼šæè¿° JWT çš„å…ƒæ•°æ®ï¼Œå®šä¹‰äº†ç”Ÿæˆç­¾åçš„ç®—æ³•ä»¥åŠ Token çš„ç±»å‹ï¼› Payloadï¼šç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ï¼› Signatureï¼ˆç­¾åï¼‰ï¼šæœåŠ¡å™¨é€šè¿‡ Payloadã€Header å’Œç§é’¥ï¼ˆSecretï¼‰ä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ç”Ÿæˆã€‚ JWT é€šå¸¸æ˜¯è¿™æ ·çš„ï¼šxxxxx.yyyyy.zzzzzã€‚ ç¤ºä¾‹ï¼š eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9. eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ. SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c ä½ å¯ä»¥åœ¨ jwt.ioopen in new window è¿™ä¸ªç½‘ç«™ä¸Šå¯¹å…¶ JWT è¿›è¡Œè§£ç ï¼Œè§£ç ä¹‹åå¾—åˆ°çš„å°±æ˜¯ Headerã€Payloadã€Signature è¿™ä¸‰éƒ¨åˆ†ã€‚ é—®ï¼šå¦‚ä½•åŸºäº JWT è¿›è¡Œèº«ä»½éªŒè¯ï¼Ÿ åœ¨åŸºäº JWT è¿›è¡Œèº«ä»½éªŒè¯çš„çš„åº”ç”¨ç¨‹åºä¸­ï¼ŒæœåŠ¡å™¨é€šè¿‡ Payloadã€Header å’Œ Secretï¼ˆå¯†é’¥ï¼‰ åˆ›å»º JWT å¹¶å°† JWT å‘é€ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ¥æ”¶åˆ° JWT ä¹‹åï¼Œä¼šå°†å…¶ä¿å­˜åœ¨ Cookie æˆ–è€… localStorage é‡Œé¢ï¼Œä»¥åå®¢æˆ·ç«¯å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šæºå¸¦è¿™ä¸ªä»¤ç‰Œã€‚ ä¸¤ç‚¹å»ºè®®ï¼š å»ºè®®å°† JWT å­˜æ”¾åœ¨ localStorage ä¸­ï¼Œæ”¾åœ¨ Cookie ä¸­ä¼šæœ‰ CSRF é£é™©ã€‚ è¯·æ±‚æœåŠ¡ç«¯å¹¶æºå¸¦ JWT çš„å¸¸è§åšæ³•æ˜¯å°†å…¶æ”¾åœ¨ HTTP Header çš„ Authorization å­—æ®µä¸­ï¼ˆAuthorization: Bearer Tokenï¼‰ã€‚ é—®ï¼šå¦‚ä½•æé«˜ JWT çš„å®‰å…¨æ€§ï¼Ÿ JWT å­˜æ”¾åœ¨ localStorage ä¸­è€Œä¸æ˜¯ Cookie ä¸­ï¼Œé¿å… CSRF é£é™©ï¼› ä¸€å®šä¸è¦å°†éšç§ä¿¡æ¯å­˜æ”¾åœ¨ Payload å½“ä¸­ï¼Œå› ä¸ºå®ƒä¸åŠ å¯†ï¼› JWT çš„è¿‡æœŸæ—¶é—´ä¸æ˜“è¿‡é•¿ã€‚ é—®ï¼šJWT ä¸ºå•¥ä¸ä¼šæœ‰ CSRF æ”»å‡»æ¼æ´ï¼Ÿ ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨ JWT çš„è¯ï¼Œåœ¨æˆ‘ä»¬ç™»å½•æˆåŠŸè·å¾— JWT ä¹‹åï¼Œä¸€èˆ¬ä¼šé€‰æ‹©å­˜æ”¾åœ¨ localStorage ä¸­ã€‚å‰ç«¯çš„æ¯ä¸€ä¸ªè¯·æ±‚åç»­éƒ½ä¼šé™„å¸¦ä¸Šè¿™ä¸ª JWTï¼Œæ•´ä¸ªè¿‡ç¨‹å‹æ ¹ä¸ä¼šæ¶‰åŠåˆ° Cookieã€‚å› æ­¤ï¼Œå³ä½¿ä½ ç‚¹å‡»äº†éæ³•é“¾æ¥å‘é€äº†è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼Œè¿™ä¸ªéæ³•è¯·æ±‚ä¹Ÿæ˜¯ä¸ä¼šæºå¸¦ JWT çš„ï¼Œæ‰€ä»¥è¿™ä¸ªè¯·æ±‚å°†æ˜¯éæ³•çš„ã€‚ æ€»ç»“æ¥è¯´å°±ä¸€å¥è¯ï¼šä½¿ç”¨ JWT è¿›è¡Œèº«ä»½éªŒè¯ä¸éœ€è¦ä¾èµ– Cookie ï¼Œå› æ­¤å¯ä»¥é¿å… CSRF æ”»å‡»ã€‚ ä½†æ˜¯ XSS ä¾ç„¶ä¼šæœ‰ã€‚ é—®ï¼šJWT é‡æ”¾æ”»å‡»æ€ä¹ˆé˜²å¾¡ï¼Ÿ JWT è¿‡æœŸæ—¶é—´è®¾ç½®çš„çŸ­ç‚¹ï¼› å¢åŠ æ—¶é—´æˆ³æœºåˆ¶ï¼Œä½†æ—¶é—´åŒæ­¥æ˜¯ä¸ªé—®é¢˜ï¼› å®¢æˆ·ç«¯æ¯æ¬¡éœ€è¦æºå¸¦æœåŠ¡ç«¯åˆ†å‘çš„éšæœºæ•°ï¼Œéšæœºæ•°çš„ç»´æŠ¤æ˜¯ä¸ªé—®é¢˜ï¼› å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å•†é‡æµæ°´å·ï¼Œè½åçš„åºå·å°†è¢«è®¤å®šä¸ºé‡æ”¾æ”»å‡»ï¼Œåˆ†å¸ƒå¼åœºæ™¯ä¸‹åºå·åŒæ­¥æ˜¯ä¸ªé—®é¢˜ã€‚ ","date":"2023-06-19","objectID":"/12-jwt%E8%AE%A4%E8%AF%81/:0:0","tags":["èº«ä»½è®¤è¯"],"title":"JWTè®¤è¯","uri":"/12-jwt%E8%AE%A4%E8%AF%81/"},{"categories":["é¢è¯•"],"content":"[toc] ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:0:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€æ¦‚è¿° é—®ï¼šå¦‚ä½•ç†è§£é«˜å¹¶å‘ç³»ç»Ÿï¼Ÿ æ‰€è°“è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿï¼Œå°±æ˜¯è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œä¿è¯å®ƒæ•´ä½“å¯ç”¨çš„åŒæ—¶ï¼Œèƒ½å¤Ÿå¤„ç†å¾ˆé«˜çš„å¹¶å‘ç”¨æˆ·è¯·æ±‚ï¼Œèƒ½å¤Ÿæ‰¿å—å¾ˆå¤§çš„æµé‡å†²å‡»ã€‚ æˆ‘ä»¬è¦è®¾è®¡é«˜å¹¶å‘çš„ç³»ç»Ÿï¼Œé‚£å°±éœ€è¦å¤„ç†å¥½ä¸€äº›å¸¸è§çš„ç³»ç»Ÿç“¶é¢ˆé—®é¢˜ï¼Œå¦‚å†…å­˜ä¸è¶³ã€ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè¿æ¥æ•°ä¸å¤Ÿï¼Œç½‘ç»œå®½å¸¦ä¸å¤Ÿç­‰ç­‰ï¼Œä»¥åº”å¯¹çªå‘çš„æµé‡æ´ªå³°ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"åˆ†è€Œæ²»ä¹‹ï¼Œæ¨ªå‘æ‰©å±• å•ä¸ªæœåŠ¡å™¨çš„ç¼ºç‚¹ï¼š æŠ—ä½çš„æµé‡è¯·æ±‚æ˜¯éå¸¸æœ‰é™ï¼› æœ‰å•ç‚¹çš„é£é™©ï¼ŒæŒ‚äº†å°±å¯„äº†ã€‚ å› æ­¤ï¼Œå¯ä»¥åˆ†è€Œæ²»ä¹‹ï¼Œæ¨ªå‘æ‰©å±•ã€‚å³ï¼Œé‡‡ç”¨åˆ†å¸ƒå¼éƒ¨ç½²çš„æ–¹å¼ï¼Œéƒ¨ç½²å¤šå°æœåŠ¡å™¨ï¼ŒæŠŠæµé‡åˆ†æµå¼€ï¼Œè®©æ¯ä¸ªæœåŠ¡å™¨éƒ½æ‰¿æ‹…ä¸€éƒ¨åˆ†çš„å¹¶å‘å’Œæµé‡ï¼Œæå‡æ•´ä½“ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"å¾®æœåŠ¡æ‹†åˆ†ï¼ˆç³»ç»Ÿæ‹†åˆ†ï¼‰ æ‰€è°“çš„å¾®æœåŠ¡æ‹†åˆ†ï¼Œå…¶å®å°±æ˜¯æŠŠä¸€ä¸ªå•ä½“çš„åº”ç”¨ï¼ŒæŒ‰åŠŸèƒ½å•ä¸€æ€§ï¼Œæ‹†åˆ†ä¸ºå¤šä¸ªæœåŠ¡æ¨¡å—ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°åˆ†æ‘Šè¯·æ±‚æµé‡çš„ç›®çš„ï¼Œæé«˜äº†å¹¶å‘èƒ½åŠ›ã€‚æ¯”å¦‚ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œæ‹†åˆ†ä¸ºç”¨æˆ·ç³»ç»Ÿã€è®¢å•ç³»ç»Ÿã€å•†å“ç³»ç»Ÿç­‰ç­‰ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"åˆ†åº“åˆ†è¡¨ è€ƒè™‘å°†å•æœºæ•°æ®åº“ï¼Œæ‹†åˆ†ä¸ºå¤šä¸ªæ•°æ®åº“æˆ–è¡¨ã€‚ è¯¦æƒ…å‚è€ƒï¼š åˆ†åº“åˆ†è¡¨ç»å…¸15è¿é—® ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:3","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ± åŒ–æŠ€æœ¯ è¯·æ±‚è°ƒç”¨æ•°æ®åº“æ—¶ï¼Œéƒ½ä¼šå…ˆè·å–æ•°æ®åº“çš„è¿æ¥ï¼Œç„¶åä¾é è¿™ä¸ªè¿æ¥æ¥æŸ¥è¯¢æ•°æ®ï¼Œæå®Œæ”¶å·¥ï¼Œæœ€åå…³é—­è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚å¦‚æœæˆ‘ä»¬ä¸ç”¨æ•°æ®åº“è¿æ¥æ± çš„è¯ï¼Œæ¯æ¬¡æ‰§è¡ŒSQLï¼Œéƒ½è¦åˆ›å»ºè¿æ¥å’Œé”€æ¯è¿æ¥ï¼Œè¿™å°±ä¼šå¯¼è‡´æ¯ä¸ªæŸ¥è¯¢è¯·æ±‚éƒ½å˜å¾—æ›´æ…¢äº†ï¼Œç›¸åº”çš„ï¼Œç³»ç»Ÿå¤„ç†ç”¨æˆ·è¯·æ±‚çš„èƒ½åŠ›å°±é™ä½äº†ã€‚ å› æ­¤ï¼Œéœ€è¦ä½¿ç”¨æ± åŒ–æŠ€æœ¯ï¼Œå³æ•°æ®åº“è¿æ¥æ± ã€HTTP è¿æ¥æ± ã€Redis è¿æ¥æ± ç­‰ç­‰ã€‚ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œå¯ä»¥é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½æ–°å»ºè¿æ¥ï¼Œå‡å°‘ä¸å¿…è¦çš„èµ„æºå¼€é”€ï¼Œé€šè¿‡å¤ç”¨è¿æ¥æ± ï¼Œæé«˜ç³»ç»Ÿå¤„ç†é«˜å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ã€‚ åŒç†ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹æ± ï¼Œä¹Ÿèƒ½è®©ä»»åŠ¡å¹¶è¡Œå¤„ç†ï¼Œæ›´é«˜æ•ˆåœ°å®Œæˆä»»åŠ¡ã€‚ é¢è¯•å¿…å¤‡ï¼šJavaçº¿ç¨‹æ± è§£æ ç»†æ•°çº¿ç¨‹æ± çš„10ä¸ªå‘ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:4","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"è¯»å†™åˆ†ç¦» é€šå¸¸æ¥è¯´ï¼Œä¸€å°å•æœºçš„MySQLæœåŠ¡å™¨ï¼Œå¯ä»¥æ”¯æŒ500å·¦å³çš„TPSå’Œ10000å·¦å³çš„QPSï¼Œå³å•æœºæ”¯æ’‘çš„è¯·æ±‚è®¿é—®æ˜¯æœ‰é™çš„ã€‚ å½“è¯·æ±‚é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œå¯¹äºå®æ—¶æ€§è¦æ±‚ä¸é«˜çš„è¯»è¯·æ±‚ï¼Œéƒ½å»è¯»ä»åº“ï¼Œå†™çš„è¯·æ±‚æˆ–è€…å®æ—¶æ€§è¦æ±‚é«˜çš„è¯·æ±‚ï¼Œæ‰èµ°ä¸»åº“ã€‚ é¢è¯•å¿…å¤‡ï¼šèŠèŠMySQLçš„ä¸»ä» ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:5","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ä½¿ç”¨ç¼“å­˜ å†…å­˜æ“ä½œï¼Œæ˜¾ç„¶æ›´å¿«ï¼Œèƒ½æ”¯æ’‘æ›´é«˜çš„å¹¶å‘é‡ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:6","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"CDN ä»€ä¹ˆæ˜¯CDNï¼Ÿ Content Delivery Network/Content Distribution Networkï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å†…å®¹åˆ†å‘ç½‘ç»œï¼Œå®ƒè¡¨ç¤ºå°†é™æ€èµ„æºåˆ†å‘åˆ°ä½äºå¤šä¸ªåœ°ç†ä½ç½®æœºæˆ¿çš„æœåŠ¡å™¨ï¼Œå¯ä»¥åšåˆ°æ•°æ®å°±è¿‘è®¿é—®ï¼ŒåŠ é€Ÿäº†é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦ï¼Œå› æ­¤è®©ç³»ç»Ÿæ›´å¥½å¤„ç†æ­£å¸¸åˆ«çš„åŠ¨æ€è¯·æ±‚ã€‚ å•†å“å›¾ç‰‡ï¼Œiconç­‰ç­‰é™æ€èµ„æºï¼Œå¯ä»¥å¯¹é¡µé¢åšé™æ€åŒ–å¤„ç†ï¼Œå‡å°‘è®¿é—®æœåŠ¡ç«¯çš„è¯·æ±‚ã€‚å¦‚æœç”¨æˆ·åˆ†å¸ƒåœ¨å…¨å›½å„åœ°ï¼Œæœ‰çš„åœ¨ä¸Šæµ·ï¼Œæœ‰çš„åœ¨æ·±åœ³ï¼Œåœ°åŸŸç›¸å·®å¾ˆè¿œï¼Œç½‘é€Ÿä¹Ÿå„ä¸ç›¸åŒã€‚ä¸ºäº†è®©ç”¨æˆ·æœ€å¿«è®¿é—®åˆ°é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨CDNã€‚CDNå¯ä»¥è®©ç”¨æˆ·å°±è¿‘è·å–æ‰€éœ€å†…å®¹ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:7","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ¶ˆæ¯é˜Ÿåˆ— å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦ æä¸€äº›åŒåä¸€ã€åŒåäºŒç­‰è¿è¥æ´»åŠ¨æ—¶ï¼Œéœ€è¦é¿å…æµé‡æš´æ¶¨ï¼Œæ‰“å®åº”ç”¨ç³»ç»Ÿçš„é£é™©ã€‚å› æ­¤ä¸€èˆ¬ä¼šå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥åº”å¯¹é«˜å¹¶å‘çš„åœºæ™¯ã€‚ å‡è®¾ä½ çš„åº”ç”¨ç³»ç»Ÿæ¯ç§’æœ€å¤šå¯ä»¥å¤„ç†2kä¸ªè¯·æ±‚ï¼Œæ¯ç§’å´æœ‰5kçš„è¯·æ±‚è¿‡æ¥ï¼Œå¯ä»¥å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåº”ç”¨ç³»ç»Ÿæ¯ç§’ä»æ¶ˆæ¯é˜Ÿåˆ—æ‹‰2kè¯·æ±‚å¤„ç†å¾—äº†ã€‚ æœ‰äº›ä¼™ä¼´æ‹…å¿ƒè¿™æ ·å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ç§¯å‹çš„é—®é¢˜ï¼š é¦–å…ˆï¼Œæä¸€äº›è¿è¥æ´»åŠ¨ï¼Œä¸ä¼šæ¯æ—¶æ¯åˆ»éƒ½é‚£ä¹ˆå¤šè¯·æ±‚è¿‡æ¥ä½ çš„ç³»ç»Ÿï¼ˆé™¤éæœ‰äººæ¶æ„æ”»å‡»ï¼‰ï¼Œé«˜å³°æœŸè¿‡å»åï¼Œç§¯å‹çš„è¯·æ±‚å¯ä»¥æ…¢æ…¢å¤„ç†ï¼› å…¶æ¬¡ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§æ•°é‡ï¼Œå¯ä»¥ç›´æ¥æŠ›å¼ƒç”¨æˆ·è¯·æ±‚æˆ–è·³è½¬åˆ°é”™è¯¯é¡µé¢ï¼› ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:8","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ElasticSearch ä¸€èˆ¬æœç´¢åŠŸèƒ½éƒ½ä¼šç”¨åˆ°å®ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€é«˜æ‰©å±•ã€é«˜å®æ—¶çš„æœç´¢ä¸æ•°æ®åˆ†æå¼•æ“ï¼Œç®€ç§°ä¸ºESã€‚ESå¯ä»¥æ‰©å®¹æ–¹ä¾¿ï¼Œå¤©ç„¶æ”¯æ’‘é«˜å¹¶å‘ã€‚å½“æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œä¸ç”¨åŠ¨ä¸åŠ¨å°±åŠ æœºå™¨æ‰©å®¹ï¼Œåˆ†åº“ç­‰ç­‰ï¼Œå¯ä»¥è€ƒè™‘ç”¨ESæ¥æ”¯æŒç®€å•çš„æŸ¥è¯¢æœç´¢ã€ç»Ÿè®¡ç±»çš„æ“ä½œã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:9","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é™çº§ç†”æ–­ ç†”æ–­é™çº§æ˜¯ä¿æŠ¤ç³»ç»Ÿçš„ä¸€ç§æ‰‹æ®µã€‚å½“å‰äº’è”ç½‘ç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²çš„ï¼Œè€Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¶å°”ä¼šå‡ºç°æŸä¸ªåŸºç¡€æœåŠ¡ä¸å¯ç”¨ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µ, è¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”ã€‚ æ¯”å¦‚åˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯A-\u003eB-\u003eC....ï¼Œä¸‹å›¾æ‰€ç¤ºï¼š å¦‚æœæœåŠ¡Cå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚æ˜¯å› ä¸ºæ…¢SQLå¯¼è‡´è°ƒç”¨ç¼“æ…¢ï¼Œé‚£å°†å¯¼è‡´Bä¹Ÿä¼šå»¶è¿Ÿï¼Œä»è€ŒAä¹Ÿä¼šå»¶è¿Ÿã€‚å µä½çš„Aè¯·æ±‚ä¼šæ¶ˆè€—å ç”¨ç³»ç»Ÿçš„çº¿ç¨‹ã€IOã€CPUç­‰èµ„æºã€‚å½“è¯·æ±‚Açš„æœåŠ¡è¶Šæ¥è¶Šå¤šï¼Œå ç”¨è®¡ç®—æœºçš„èµ„æºä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œæœ€ç»ˆä¼šå¯¼è‡´ç³»ç»Ÿç“¶é¢ˆå‡ºç°ï¼Œé€ æˆå…¶ä»–çš„è¯·æ±‚åŒæ ·ä¸å¯ç”¨ï¼Œæœ€åå¯¼è‡´ä¸šåŠ¡ç³»ç»Ÿå´©æºƒã€‚ ä¸ºäº†åº”å¯¹æœåŠ¡é›ªå´©, å¸¸è§çš„åšæ³•æ˜¯ç†”æ–­å’Œé™çº§ã€‚æœ€ç®€å•æ˜¯åŠ å¼€å…³æ§åˆ¶ï¼Œå½“ä¸‹æ¸¸ç³»ç»Ÿå‡ºé—®é¢˜æ—¶ï¼Œå¼€å…³æ‰“å¼€é™çº§ï¼Œä¸å†è°ƒç”¨ä¸‹æ¸¸ç³»ç»Ÿã€‚è¿˜å¯ä»¥é€‰ç”¨å¼€æºç»„ä»¶Hystrixæ¥æ”¯æŒã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:10","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é™æµ å¦‚æœä½ çš„ç³»ç»Ÿæ¯ç§’æ‰›ä½çš„è¯·æ±‚æ˜¯ä¸€åƒï¼Œå¦‚æœä¸€ç§’é’Ÿæ¥äº†åä¸‡è¯·æ±‚å‘¢ï¼Ÿæ¢ä¸ªè§’åº¦å°±æ˜¯è¯´ï¼Œé«˜å¹¶å‘çš„æ—¶å€™ï¼Œæµé‡æ´ªå³°æ¥äº†ï¼Œè¶…è¿‡ç³»ç»Ÿçš„æ‰¿è½½èƒ½åŠ›ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–é™æµæ–¹æ¡ˆã€‚å°±æ˜¯ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿï¼Œå¤šä½™çš„è¯·æ±‚ï¼Œç›´æ¥ä¸¢å¼ƒã€‚ ä»€ä¹ˆæ˜¯é™æµï¼šåœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œé™æµå°±æ˜¯æ§åˆ¶ç½‘ç»œæ¥å£å‘é€æˆ–æ¥æ”¶è¯·æ±‚çš„é€Ÿç‡ï¼Œå®ƒå¯é˜²æ­¢DoSæ”»å‡»å’Œé™åˆ¶Webçˆ¬è™«ã€‚é™æµï¼Œä¹Ÿç§°æµé‡æ§åˆ¶ã€‚æ˜¯æŒ‡ç³»ç»Ÿåœ¨é¢ä¸´é«˜å¹¶å‘ï¼Œæˆ–è€…å¤§æµé‡è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œé™åˆ¶æ–°çš„è¯·æ±‚å¯¹ç³»ç»Ÿçš„è®¿é—®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ å¯ä»¥ä½¿ç”¨Guavaçš„RateLimiterå•æœºç‰ˆé™æµï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Redisåˆ†å¸ƒå¼é™æµï¼Œè¿˜å¯ä»¥ä½¿ç”¨é˜¿é‡Œå¼€æºç»„ä»¶sentinelé™æµã€‚ é¢è¯•çš„æ—¶å€™ï¼Œä½ è¯´åˆ°é™æµè¿™å—çš„è¯ï¼Ÿé¢è¯•å®˜å¾ˆå¤§æ¦‚ç‡ä¼šé—®ä½ é™æµçš„ç®—æ³•ï¼šé¢è¯•å¿…å¤‡ï¼š4ç§ç»å…¸é™æµç®—æ³•è®²è§£ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:1:11","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"äºŒã€æ•°æ®åº“ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:2:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ± åŒ– åŸå› ï¼šæ•°æ®åº“çš„è°ƒç”¨æ–¹å¼æ˜¯å…ˆè·å–æ•°æ®åº“çš„è¿æ¥ï¼Œç„¶åä¾é è¿™æ¡è¿æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæœ€åå…³é—­è¿æ¥é‡Šæ”¾æ•°æ®åº“èµ„æºã€‚è¿™ç§è°ƒç”¨æ–¹å¼ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œ SQL éƒ½éœ€è¦é‡æ–°å»ºç«‹è¿æ¥ï¼Œè€Œå»ºç«‹è¿æ¥çš„è€—æ—¶å¯èƒ½è¦æ¯”æ‰§è¡Œsqlçš„è€—æ—¶è¿˜è¦é«˜ï¼Œå› æ­¤é‡‡ç”¨æ± åŒ–æŠ€æœ¯ã€‚ åšæ³•ï¼šæ•°æ®åº“è¿æ¥æ± æœ‰ä¸¤ä¸ªæœ€é‡è¦çš„é…ç½®ï¼šæœ€å°è¿æ¥æ•°å’Œæœ€å¤§è¿æ¥æ•°ï¼Œå®ƒä»¬æ§åˆ¶ç€ä»è¿æ¥æ± ä¸­è·å–è¿æ¥çš„æµç¨‹ï¼š å¦‚æœå½“å‰è¿æ¥æ± ä¸­çš„è¿æ¥æ•°å°äºæœ€å°è¿æ¥æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„è¿æ¥ï¼› å¦‚æœè¿æ¥æ± ä¸­æœ‰ç©ºé—²è¿æ¥åˆ™å¤ç”¨ç©ºé—²è¿æ¥ï¼› å¦‚æœç©ºé—²æ± ä¸­æ²¡æœ‰ç©ºé—²è¿æ¥å¹¶ä¸”å½“å‰è¿æ¥æ•°å°äºæœ€å¤§è¿æ¥æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„è¿æ¥å¤„ç†è¯·æ±‚ï¼› å¦‚æœå½“å‰è¿æ¥æ•°å·²ç»å¤§äºç­‰äºæœ€å¤§è¿æ¥æ•°ï¼Œåˆ™æŒ‰ç…§é…ç½®ä¸­è®¾å®šçš„æ—¶é—´ç­‰å¾…æ—§çš„è¿æ¥å¯ç”¨ï¼› å¦‚æœç­‰å¾…è¶…è¿‡äº†è¿™ä¸ªè®¾å®šæ—¶é—´åˆ™å‘ç”¨æˆ·æŠ›å‡ºé”™è¯¯ã€‚ æ€»ç»“ï¼š æ± å­çš„æœ€å¤§å€¼å’Œæœ€å°å€¼çš„è®¾ç½®å¾ˆé‡è¦ï¼ŒåˆæœŸå¯ä»¥ä¾æ®ç»éªŒæ¥è®¾ç½®ï¼Œåé¢è¿˜æ˜¯éœ€è¦æ ¹æ®å®é™…è¿è¡Œæƒ…å†µåšè°ƒæ•´ã€‚ æ± å­ä¸­çš„å¯¹è±¡éœ€è¦åœ¨ä½¿ç”¨ä¹‹å‰é¢„å…ˆåˆå§‹åŒ–å®Œæˆï¼Œå«åšè¿æ¥æ± é¢„çƒ­ï¼Œæ¯”æ–¹è¯´ä½¿ç”¨çº¿ç¨‹æ± æ—¶å°±éœ€è¦é¢„å…ˆåˆå§‹åŒ–æ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹ã€‚å¦‚æœæ± å­æœªç»è¿‡é¢„çƒ­å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿé‡å¯åäº§ç”Ÿæ¯”è¾ƒå¤šçš„æ…¢è¯·æ±‚ã€‚ æ± åŒ–æŠ€æœ¯æ ¸å¿ƒæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´ä¼˜åŒ–æ–¹æ³•çš„å®è·µï¼Œæ‰€ä»¥è¦å…³æ³¨ç©ºé—´å ç”¨æƒ…å†µï¼Œé¿å…å‡ºç°ç©ºé—´è¿‡åº¦ä½¿ç”¨å‡ºç°å†…å­˜æ³„éœ²æˆ–è€…é¢‘ç¹åƒåœ¾å›æ”¶ç­‰é—®é¢˜ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:2:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ä¸»ä»è¯»å†™åˆ†ç¦» åŸå› ï¼šå…¶å®ï¼Œå¤§éƒ¨åˆ†ç³»ç»Ÿçš„è®¿é—®æ¨¡å‹æ˜¯è¯»å¤šå†™å°‘ï¼Œè¯»å†™è¯·æ±‚é‡çš„å·®è·å¯èƒ½è¾¾åˆ°å‡ ä¸ªæ•°é‡çº§ã€‚è¯»å†™åˆ†ç¦»ä¸»è¦ç”¨æ¥è§£å†³æŸ¥è¯¢è¯·æ±‚å¢å¤šçš„é—®é¢˜ã€‚ å…³é”®æŠ€æœ¯ï¼š ä¸»ä»å¤åˆ¶ï¼› è®¿é—®å“ªä¸ªæ•°æ®åº“ã€‚å¯åŸºäºä»£ç†é€‰æ‹©ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:2:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"åˆ†åº“åˆ†è¡¨ åŸå› ï¼šè¯»å†™åˆ†ç¦»ä¸»è¦è§£å†³è¯»è¯·æ±‚å¢å¤šçš„é—®é¢˜ï¼Œè€Œåˆ†åº“åˆ†è¡¨è§£å†³å†™è¯·æ±‚å¢å¤šã€å­˜å‚¨å˜å¤šçš„é—®é¢˜ã€‚ å…³é”®æŠ€æœ¯ï¼š å‚ç›´åˆ†ç‰‡ï¼šå¯ä»¥è§£å†³å•åº“æ•°æ®å­˜å‚¨é—®é¢˜ï¼ŒåŒæ—¶ï¼Œå•åº“çš„æ•°æ®é‡é™ä½ï¼Œä¹Ÿèƒ½æé«˜æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½ã€‚ æ°´å¹³åˆ†ç‰‡ï¼šè§£å†³å•åº“æˆ–å•è¡¨æ•°æ®å­˜å‚¨é—®é¢˜ï¼ŒåŒæ—¶ï¼Œå•åº“æˆ–å•è¡¨çš„æ•°æ®é‡é™ä½ï¼Œä¹Ÿèƒ½æé«˜æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½ã€‚ å½“åˆ†åº“åˆ†è¡¨ä¹‹åï¼ŒåŒä¸€ä¸ªé€»è¾‘è¡¨çš„æ•°æ®è¢«åˆ†å¸ƒåˆ°å¤šä¸ªåº“ä¸­ï¼Œè¿™æ—¶å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢å­—æ®µä½œä¸ºä¸»é”®ï¼Œé‚£ä¹ˆåªèƒ½ä¿è¯åœ¨è¿™ä¸ªåº“ä¸­æ˜¯å”¯ä¸€çš„ï¼Œæ— æ³•ä¿è¯å…¨å±€çš„å”¯ä¸€æ€§ã€‚é‚£ä¹ˆå‡å¦‚è®¾è®¡ç”¨æˆ·ç³»ç»Ÿçš„æ—¶å€™ï¼Œä½¿ç”¨è‡ªå¢ ID ä½œä¸ºç”¨æˆ· IDï¼Œå°±å¯èƒ½å‡ºç°ä¸¤ä¸ªç”¨æˆ·æœ‰ä¸¤ä¸ªç›¸åŒçš„ IDï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ IDã€‚ UUID ä¸å»ºè®®ä½¿ç”¨ UUID ä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œå› ä¸ºï¼š ID æœ‰åºæ›´åˆ©äºç´¢å¼•æ•°æ®çš„æ’å…¥ï¼Œè€Œ UUID æ˜¯æ— åºçš„ï¼Œé€ æˆäº†å¤šä½™çš„æ•°æ®ç§»åŠ¨çš„å¼€é”€ï¼› UUID ä¸å…·å¤‡ä¸šåŠ¡å«ä¹‰ï¼› UUID æ˜¯ç”± 32 ä¸ª 16 è¿›åˆ¶æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²(128ä½)ï¼Œå¦‚æœä½œä¸ºæ•°æ®åº“ä¸»é”®ä½¿ç”¨æ¯”è¾ƒè€—è´¹ç©ºé—´ã€‚ ==é›ªèŠ±ç®—æ³•(Snowflake)== Snowflake çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°† 64 ä½çš„äºŒè¿›åˆ¶æ•°å­—åˆ†æˆè‹¥å¹²éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†éƒ½å­˜å‚¨æœ‰ç‰¹å®šå«ä¹‰çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´æ—¶é—´æˆ³ã€æœºå™¨ IDã€åºåˆ—å·ç­‰ç­‰ï¼Œæœ€ç»ˆç”Ÿæˆå…¨å±€å”¯ä¸€çš„æœ‰åº IDã€‚å¯ä»¥è‡ªå®šä¹‰å„å­—æ®µä»£è¡¨çš„å«ä¹‰å’Œä½æ•°ã€‚ åŸç†çŸ¥é“äº†ï¼Œé‚£å·¥ç¨‹ä¸Šæ˜¯æ€ä¹ˆå®ç°å‘¢ï¼Ÿ ä¸€ç§æ˜¯åµŒå…¥åˆ°ä¸šåŠ¡ä»£ç é‡Œï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒåœ¨ä¸šåŠ¡æœåŠ¡å™¨ä¸­ã€‚ ä¸€ç§æ˜¯ä½œä¸ºç‹¬ç«‹çš„æœåŠ¡éƒ¨ç½²ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å‘å·å™¨æœåŠ¡ã€‚ Snowflake ç®—æ³•è®¾è®¡çš„éå¸¸ç®€å•ä¸”å·§å¦™ï¼Œæ€§èƒ½ä¸Šä¹Ÿè¶³å¤Ÿé«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿç”Ÿæˆå…·æœ‰å…¨å±€å”¯ä¸€æ€§ã€å•è°ƒé€’å¢æ€§å’Œæœ‰ä¸šåŠ¡å«ä¹‰çš„ IDï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š å…¶ä¸­æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯å®ƒä¾èµ–äºç³»ç»Ÿçš„æ—¶é—´æˆ³ï¼Œä¸€æ—¦ç³»ç»Ÿæ—¶é—´ä¸å‡†ï¼Œå°±æœ‰å¯èƒ½ç”Ÿæˆé‡å¤çš„ IDã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å‘ç°ç³»ç»Ÿæ—¶é’Ÿä¸å‡†ï¼Œå°±å¯ä»¥è®©å‘å·å™¨æš‚æ—¶æ‹’ç»å‘å·ï¼Œç›´åˆ°æ—¶é’Ÿå‡†ç¡®ä¸ºæ­¢ï¼› å¦å¤–ï¼Œå¦‚æœè¯·æ±‚å‘å·å™¨çš„ QPS ä¸é«˜ï¼Œæ¯”å¦‚è¯´å‘å·å™¨æ¯æ¯«ç§’åªå‘ä¸€ä¸ª IDï¼Œå°±ä¼šé€ æˆç”Ÿæˆ ID çš„æœ«ä½æ°¸è¿œæ˜¯ 1ï¼Œé‚£ä¹ˆåœ¨åˆ†åº“åˆ†è¡¨æ—¶å¦‚æœä½¿ç”¨ ID ä½œä¸ºåˆ†åŒºé”®å°±ä¼šé€ æˆåº“è¡¨åˆ†é…çš„ä¸å‡åŒ€ã€‚ è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è¸©è¿‡çš„å‘ï¼Œè€Œè§£å†³åŠæ³•ä¸»è¦æœ‰ä¸¤ä¸ªï¼š æ—¶é—´æˆ³ä¸è®°å½•æ¯«ç§’è€Œæ˜¯è®°å½•ç§’ï¼Œè¿™æ ·åœ¨ä¸€ä¸ªæ—¶é—´åŒºé—´é‡Œå¯ä»¥å¤šå‘å‡ºå‡ ä¸ªå·ï¼Œé¿å…å‡ºç°åˆ†åº“åˆ†è¡¨æ—¶æ•°æ®åˆ†é…ä¸å‡ï¼› ç”Ÿæˆçš„åºåˆ—å·çš„èµ·å§‹å·å¯ä»¥åšä¸€ä¸‹éšæœºï¼Œè¿™ä¸€ç§’æ˜¯ 21ï¼Œä¸‹ä¸€ç§’æ˜¯ 30ï¼Œè¿™æ ·å°±ä¼šå°½é‡çš„å‡è¡¡äº†ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:2:3","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"NoSQL // TODO ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:2:4","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€ç¼“å­˜ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:3:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ¦‚è¿° ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ å‡¡æ˜¯ä½äºé€Ÿåº¦ç›¸å·®è¾ƒå¤§çš„ä¸¤ç§ç¡¬ä»¶ä¹‹é—´ï¼Œç”¨äºåè°ƒä¸¤è€…æ•°æ®ä¼ è¾“é€Ÿåº¦å·®å¼‚çš„ç»“æ„ï¼Œå‡å¯ç§°ä¹‹ä¸ºç¼“å­˜ã€‚å†…å­˜å’Œç¼“å­˜ä¹‹é—´ä¸èƒ½åˆ’ç­‰å·ã€‚ å¸¸è§ç¡¬ä»¶ç»„ä»¶çš„å»¶æ—¶æƒ…å†µï¼š å¯ä»¥çœ‹åˆ°ï¼Œåšä¸€æ¬¡å†…å­˜å¯»å€å¤§æ¦‚éœ€è¦ 100nsï¼Œè€Œåšä¸€æ¬¡ç£ç›˜çš„æŸ¥æ‰¾åˆ™éœ€è¦ 10msï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨å†…å­˜ä½œä¸ºç¼“å­˜çš„å­˜å‚¨ä»‹è´¨ç›¸æ¯”äºä»¥ç£ç›˜ä½œä¸ºä¸»è¦å­˜å‚¨ä»‹è´¨çš„æ•°æ®åº“æ¥è¯´ï¼Œæ€§èƒ½ä¸Šä¼šæé«˜å¤šä¸ªæ•°é‡çº§ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæ”¯æ’‘æ›´é«˜çš„å¹¶å‘é‡ã€‚ ç¼“å­˜åˆ†ç±» æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¸¸è§çš„ç¼“å­˜ä¸»è¦å°±æ˜¯é™æ€ç¼“å­˜ã€åˆ†å¸ƒå¼ç¼“å­˜ã€çƒ­ç‚¹æœ¬åœ°ç¼“å­˜è¿™ä¸‰ç§ã€‚ é™æ€ç¼“å­˜åœ¨ Web 1.0 æ—¶æœŸæ˜¯éå¸¸è‘—åçš„ï¼Œå®ƒä¸€èˆ¬é€šè¿‡ç”Ÿæˆ Velocity æ¨¡æ¿æˆ–è€…é™æ€ HTML æ–‡ä»¶æ¥å®ç°é™æ€ç¼“å­˜ï¼Œåœ¨ Nginx ä¸Šéƒ¨ç½²é™æ€ç¼“å­˜å¯ä»¥å‡å°‘å¯¹äºåå°åº”ç”¨æœåŠ¡å™¨çš„å‹åŠ›ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨åšä¸€äº›å†…å®¹ç®¡ç†ç³»ç»Ÿçš„æ—¶å€™ï¼Œåå°ä¼šå½•å…¥å¾ˆå¤šçš„æ–‡ç« ï¼Œå‰å°åœ¨ç½‘ç«™ä¸Šå±•ç¤ºæ–‡ç« å†…å®¹ï¼Œå°±åƒæ–°æµªï¼Œç½‘æ˜“è¿™ç§é—¨æˆ·ç½‘ç«™ä¸€æ ·ã€‚è§£å†³æ€è·¯æ˜¯ï¼šæ¯ç¯‡æ–‡ç« åœ¨å½•å…¥çš„æ—¶å€™æ¸²æŸ“æˆé™æ€é¡µé¢ï¼Œæ”¾ç½®åœ¨æ‰€æœ‰çš„å‰ç«¯ Nginx æˆ–è€… Squid ç­‰ Web æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ç”¨æˆ·åœ¨è®¿é—®çš„æ—¶å€™ä¼šä¼˜å…ˆè®¿é—® Web æœåŠ¡å™¨ä¸Šçš„é™æ€é¡µé¢ï¼Œåœ¨å¯¹æ—§çš„æ–‡ç« æ‰§è¡Œä¸€å®šçš„æ¸…ç†ç­–ç•¥åï¼Œä¾ç„¶å¯ä»¥ä¿è¯ 99% ä»¥ä¸Šçš„ç¼“å­˜å‘½ä¸­ç‡ã€‚ é™æ€ç¼“å­˜åªèƒ½é’ˆå¯¹é™æ€æ•°æ®æ¥ç¼“å­˜ï¼Œå¯¹äºåŠ¨æ€è¯·æ±‚å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œé’ˆå¯¹åŠ¨æ€è¯·æ±‚åšç¼“å­˜å°±éœ€è¦åˆ†å¸ƒå¼ç¼“å­˜äº†ã€‚ åˆ†å¸ƒå¼ç¼“å­˜æœ€å…¸å‹çš„å°±æ˜¯ Redis äº†ã€‚ å½“é‡åˆ°æç«¯çš„çƒ­ç‚¹æ•°æ®æŸ¥è¯¢æ—¶ï¼Œåˆ†å¸ƒå¼ç¼“å­˜ä¹Ÿæ‰›ä¸ä½äº†ï¼Œå°±è¦è€ƒè™‘çƒ­ç‚¹æœ¬åœ°ç¼“å­˜äº†ã€‚ çƒ­ç‚¹æœ¬åœ°ç¼“å­˜ä¸»è¦éƒ¨ç½²åœ¨åº”ç”¨æœåŠ¡å™¨çš„ä»£ç ä¸­ï¼Œç”¨äºé˜»æŒ¡çƒ­ç‚¹æŸ¥è¯¢å¯¹äºåˆ†å¸ƒå¼ç¼“å­˜èŠ‚ç‚¹æˆ–è€…æ•°æ®åº“çš„å‹åŠ›ã€‚ æœ¬åœ°ç¼“å­˜æ–¹æ¡ˆï¼Œå¦‚ HashMapï¼ŒGuava Cache æˆ–è€…æ˜¯ Ehcache ç­‰ï¼Œå®ƒä»¬å’Œåº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä¼˜åŠ¿æ˜¯ä¸éœ€è¦è·¨ç½‘ç»œè°ƒåº¦ï¼Œé€Ÿåº¦æå¿«ï¼Œæ‰€ä»¥å¯ä»¥æ¥é˜»æŒ¡çŸ­æ—¶é—´å†…çš„çƒ­ç‚¹æŸ¥è¯¢ã€‚ æ¯”å¦‚ï¼Œç”µå•†ç³»ç»Ÿçš„é¦–é¡µæœ‰ä¸€äº›æ¨èçš„å•†å“ï¼Œè¯·æ±‚é‡å¾ˆå¤§ï¼Œå¯ä»¥ä½¿ç”¨ Guava Cache æ¥å°†æ‰€æœ‰çš„æ¨èå•†å“çš„ä¿¡æ¯ç¼“å­˜èµ·æ¥ï¼Œå¹¶ä¸”è®¾ç½®æ¯éš” 30 ç§’é‡æ–°ä»æ•°æ®åº“ä¸­åŠ è½½æœ€æ–°çš„æ‰€æœ‰å•†å“ã€‚è¿™æ ·ï¼Œåœ¨è·å–æ‰€æœ‰å•†å“ä¿¡æ¯çš„æ—¶å€™å¯ä»¥è°ƒç”¨ Loading Cache çš„ get æ–¹æ³•ï¼Œå°±å¯ä»¥ä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜ä¸­è·å–å•†å“ä¿¡æ¯ï¼Œå¦‚æœæœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨ï¼Œä¼šä½¿ç”¨ CacheLoader ä¸­çš„é€»è¾‘ä»æ•°æ®åº“ä¸­åŠ è½½æ‰€æœ‰çš„å•†å“ã€‚ ç¼ºç‚¹å°±æ˜¯æœ‰æ—¶æ•ˆæ€§ï¼Œä¸èƒ½å®æ—¶è¯»åˆ°æœ€æ–°çš„æ•°æ®ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:3:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"ç¼“å­˜ä¸€è‡´æ€§ æ—è·¯ç¼“å­˜ç­–ç•¥ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:3:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é«˜å¯ç”¨ ä¸»è¦é€‰æ‹©çš„æ–¹æ¡ˆæœ‰å®¢æˆ·ç«¯æ–¹æ¡ˆã€ä¸­é—´ä»£ç†å±‚æ–¹æ¡ˆå’ŒæœåŠ¡ç«¯æ–¹æ¡ˆä¸‰å¤§ç±»ï¼š å®¢æˆ·ç«¯æ–¹æ¡ˆï¼šåœ¨å®¢æˆ·ç«¯é…ç½®å¤šä¸ªç¼“å­˜çš„èŠ‚ç‚¹ï¼Œé€šè¿‡ç¼“å­˜å†™å…¥å’Œè¯»å–ç®—æ³•ç­–ç•¥æ¥å®ç°åˆ†å¸ƒå¼ï¼Œä»è€Œæé«˜ç¼“å­˜çš„å¯ç”¨æ€§ã€‚ ä¸­é—´ä»£ç†å±‚æ–¹æ¡ˆï¼šåœ¨åº”ç”¨ä»£ç å’Œç¼“å­˜èŠ‚ç‚¹ä¹‹é—´å¢åŠ ä»£ç†å±‚ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰çš„å†™å…¥å’Œè¯»å–çš„è¯·æ±‚éƒ½é€šè¿‡ä»£ç†å±‚ï¼Œè€Œä»£ç†å±‚ä¸­ä¼šå†…ç½®é«˜å¯ç”¨ç­–ç•¥ï¼Œå¸®åŠ©æå‡ç¼“å­˜ç³»ç»Ÿçš„é«˜å¯ç”¨ã€‚ æœåŠ¡ç«¯æ–¹æ¡ˆï¼šRedis 2.4 ç‰ˆæœ¬åæå‡ºçš„ Redis Sentinel æ–¹æ¡ˆã€‚ å®¢æˆ·ç«¯æ–¹æ¡ˆâ­ åœ¨å®¢æˆ·ç«¯æ–¹æ¡ˆä¸­ï¼Œéœ€è¦å…³æ³¨ç¼“å­˜çš„å†™å’Œè¯»ä¸¤ä¸ªæ–¹é¢ï¼š å†™æ•°æ®æ—¶ï¼Œéœ€è¦æŠŠè¢«å†™å…¥ç¼“å­˜çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸­ï¼Œå³è¿›è¡Œæ•°æ®åˆ†ç‰‡ï¼Œé€šå¸¸é‡‡ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼› è¯»æ•°æ®æ—¶ï¼Œå¯ä»¥åˆ©ç”¨å¤šç»„çš„ç¼“å­˜æ¥åšå®¹é”™ï¼Œæå‡ç¼“å­˜ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚å…³äºè¯»æ•°æ®ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸»ä»å’Œå¤šå‰¯æœ¬ä¸¤ç§ç­–ç•¥ï¼Œä¸¤ç§ç­–ç•¥æ˜¯ä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜è€Œæå‡ºçš„ã€‚ ä¸­é—´ä»£ç†å±‚æ–¹æ¡ˆ è™½ç„¶å®¢æˆ·ç«¯æ–¹æ¡ˆå·²ç»èƒ½è§£å†³å¤§éƒ¨åˆ†çš„é—®é¢˜ï¼Œä½†æ˜¯åªèƒ½åœ¨å•ä¸€è¯­è¨€ç³»ç»Ÿä¹‹é—´å¤ç”¨ã€‚ä¾‹å¦‚å¾®åšä½¿ç”¨ Java è¯­è¨€å®ç°äº†è¿™ä¹ˆä¸€å¥—é€»è¾‘ï¼Œå†ä½¿ç”¨ PHP å°±éš¾ä»¥å¤ç”¨ï¼Œéœ€è¦é‡æ–°å†™ä¸€å¥—ï¼Œå¾ˆéº»çƒ¦ã€‚è€Œä¸­é—´ä»£ç†å±‚çš„æ–¹æ¡ˆå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ‰€æœ‰ç¼“å­˜çš„è¯»å†™è¯·æ±‚éƒ½æ˜¯ç»è¿‡ä»£ç†å±‚å®Œæˆçš„ã€‚ä»£ç†å±‚æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸»è¦è´Ÿè´£è¯»å†™è¯·æ±‚çš„è·¯ç”±åŠŸèƒ½ã€‚ æœåŠ¡ç«¯æ–¹æ¡ˆâ­ Redis åœ¨ 2.4 ç‰ˆæœ¬ä¸­æå‡ºäº† Redis Sentinel æ¨¡å¼æ¥è§£å†³ä¸»ä» Redis éƒ¨ç½²æ—¶çš„é«˜å¯ç”¨é—®é¢˜ï¼Œå®ƒå¯ä»¥åœ¨ä¸»èŠ‚ç‚¹æŒ‚äº†ä»¥åè‡ªåŠ¨å°†ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œä¿è¯æ•´ä½“é›†ç¾¤çš„å¯ç”¨æ€§ï¼Œæ•´ä½“çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¼“å­˜ç©¿é€åŠè§£å†³ å›ç§ç©ºå€¼ï¼› å¸ƒéš†è¿‡æ»¤å™¨ï¼› åˆ†å¸ƒå¼é”ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:3:3","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"CDN åˆ†å¸ƒå¼ç¼“å­˜ä¸»è¦å¯¹åŠ¨æ€è¯·æ±‚æ•°æ®åšäº†åŠ é€Ÿï¼Œä½†æ˜¯ç³»ç»Ÿä¸­è¿˜å­˜åœ¨ç€å¤§é‡çš„é™æ€èµ„æºè¯·æ±‚ï¼š å¯¹äºç§»åŠ¨ APP æ¥è¯´ï¼Œé™æ€èµ„æºä¸»è¦æ˜¯å›¾ç‰‡ã€è§†é¢‘å’Œæµåª’ä½“ä¿¡æ¯ã€‚ å¯¹äº Web ç½‘ç«™æ¥è¯´ï¼Œåˆ™åŒ…æ‹¬äº† JavaScript æ–‡ä»¶ï¼ŒCSS æ–‡ä»¶ï¼Œé™æ€ HTML æ–‡ä»¶ç­‰ç­‰ã€‚ é—®ï¼šæ˜¯å¦ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ä¸èƒ½ï¼ ä¸€èˆ¬æ¥è¯´ï¼Œå›¾ç‰‡å’Œè§†é¢‘çš„å¤§å°ä¼šåœ¨å‡ å…†åˆ°å‡ ç™¾å…†ä¹‹é—´ï¼Œå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æœåŠ¡å™¨å’Œåˆ†å¸ƒå¼ç¼“å­˜éƒ½éƒ¨ç½²åœ¨åŒ—äº¬çš„æœºæˆ¿é‡Œï¼Œè¿™æ—¶ä¸€ä¸ªæ­å·çš„ç”¨æˆ·è¦è®¿é—®ç¼“å­˜ä¸­çš„ä¸€ä¸ªè§†é¢‘ï¼Œé‚£è¿™ä¸ªè§†é¢‘æ–‡ä»¶å°±éœ€è¦ä»åŒ—äº¬ä¼ è¾“åˆ°æ­å·ï¼ŒæœŸé—´ä¼šç»è¿‡å¤šä¸ªå…¬ç½‘éª¨å¹²ç½‘ç»œï¼Œå»¶è¿Ÿå¾ˆé«˜ï¼Œä¼šè®©ç”¨æˆ·æ„Ÿè§‰è§†é¢‘æ‰“å¼€å¾ˆæ…¢ï¼Œä¸¥é‡å½±å“åˆ°ç”¨æˆ·çš„ä½¿ç”¨ä½“éªŒã€‚ æ‰€ä»¥ï¼Œé™æ€èµ„æºè®¿é—®çš„å…³é”®ç‚¹æ˜¯å°±è¿‘è®¿é—®ï¼Œå³åŒ—äº¬ç”¨æˆ·è®¿é—®åŒ—äº¬çš„æ•°æ®ï¼Œæ­å·ç”¨æˆ·è®¿é—®æ­å·çš„æ•°æ®ï¼Œè¿™æ ·æ‰å¯ä»¥è¾¾åˆ°æ€§èƒ½çš„æœ€ä¼˜ã€‚ ä½ å¯èƒ½ä¼šè¯´ï¼šã€Œé‚£æˆ‘ä»¬åœ¨æ­å·ä¹Ÿè‡ªå»ºä¸€ä¸ªæœºæˆ¿ï¼Œè®©ç”¨æˆ·è®¿é—®æ­å·æœºæˆ¿çš„æ•°æ®å°±å¥½äº†å‘€ã€‚ã€å¯ç”¨æˆ·éå¸ƒåœ¨å…¨å›½å„åœ°ï¼Œæœ‰äº›åº”ç”¨å¯èƒ½è¿˜æœ‰å›½å¤–çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬ä¸å¯èƒ½åœ¨æ¯ä¸ªåœ°åŸŸéƒ½è‡ªå»ºæœºæˆ¿ï¼Œè¿™æ ·æˆæœ¬å¤ªé«˜äº†ã€‚ å¦å¤–ï¼Œå•ä¸ªè§†é¢‘å’Œå›¾ç‰‡ç­‰é™æ€èµ„æºå¾ˆå¤§ï¼Œå¹¶ä¸”è®¿é—®é‡åˆæé«˜ï¼Œå¦‚æœä½¿ç”¨ä¸šåŠ¡æœåŠ¡å™¨å’Œåˆ†å¸ƒå¼ç¼“å­˜æ¥æ‰¿æ‹…è¿™äº›æµé‡ï¼Œæ— è®ºæ˜¯å¯¹äºå†…ç½‘è¿˜æ˜¯å¤–ç½‘çš„å¸¦å®½éƒ½ä¼šæ˜¯å¾ˆå¤§çš„è€ƒéªŒã€‚ æ‰€ä»¥è€ƒè™‘åœ¨ä¸šåŠ¡æœåŠ¡å™¨çš„ä¸Šå±‚ï¼Œå¢åŠ ä¸€å±‚ç‰¹æ®Šçš„ç¼“å­˜ï¼Œç”¨æ¥æ‰¿æ‹…ç»å¤§éƒ¨åˆ†å¯¹äºé™æ€èµ„æºçš„è®¿é—®ï¼Œè¿™ä¸€å±‚ç‰¹æ®Šç¼“å­˜çš„èŠ‚ç‚¹éœ€è¦éå¸ƒåœ¨å…¨å›½å„åœ°ï¼Œè¿™æ ·å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©æœ€è¿‘çš„èŠ‚ç‚¹è®¿é—®ã€‚ç¼“å­˜çš„å‘½ä¸­ç‡ä¹Ÿéœ€è¦ä¸€å®šçš„ä¿è¯ï¼Œå°½é‡å‡å°‘è®¿é—®èµ„æºå­˜å‚¨æºç«™çš„è¯·æ±‚æ•°é‡ï¼ˆå›æºè¯·æ±‚ï¼‰ï¼Œä¹Ÿå°±æ˜¯ç”¨ CDNã€‚ å…³é”®æŠ€æœ¯ å†…å®¹åˆ†å‘ç½‘ç»œ(CDNï¼ŒContent Delivery Network/Content Distribution Network)ï¼šç®€å•æ¥è¯´ï¼ŒCDN å°±æ˜¯å°†é™æ€çš„èµ„æºåˆ†å‘åˆ°ä½äºå¤šä¸ªåœ°ç†ä½ç½®æœºæˆ¿ä¸­çš„æœåŠ¡å™¨ä¸Šï¼Œå› æ­¤å®ƒèƒ½å¾ˆå¥½åœ°è§£å†³æ•°æ®å°±è¿‘è®¿é—®çš„é—®é¢˜ï¼Œä¹Ÿå°±åŠ å¿«äº†é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦ã€‚ è¦æ­å»ºä¸€ä¸ª CDN ç³»ç»Ÿéœ€è¦è€ƒè™‘å“ªä¸¤ç‚¹ï¼š å¦‚ä½•å°†ç”¨æˆ·çš„è¯·æ±‚æ˜ å°„åˆ° CDN èŠ‚ç‚¹ä¸Šï¼› å¦‚ä½•æ ¹æ®ç”¨æˆ·çš„åœ°ç†ä½ç½®ä¿¡æ¯é€‰æ‹©åˆ°æ¯”è¾ƒè¿‘çš„èŠ‚ç‚¹ã€‚ CNAME é¦–å…ˆï¼Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚ä½•è®©ç”¨æˆ·çš„è¯·æ±‚åˆ°è¾¾ CDN èŠ‚ç‚¹ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™å¾ˆç®€å•å•Šï¼Œåªéœ€è¦å‘Šè¯‰ç”¨æˆ· CDN èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œç„¶åè¯·æ±‚è¿™ä¸ª IP åœ°å€ä¸Šé¢éƒ¨ç½²çš„ CDN æœåŠ¡å°±å¯ä»¥äº†å•Šã€‚ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹å‚å•†çš„ CDN æœåŠ¡ï¼ŒCDN å‚å•†ä¼šç»™æˆ‘ä»¬ä¸€ä¸ª CDN çš„èŠ‚ç‚¹ IPï¼Œæ¯”å¦‚è¯´è¿™ä¸ª IP åœ°å€æ˜¯ã€Œ111.202.34.130ã€ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç”µå•†ç³»ç»Ÿä¸­çš„å›¾ç‰‡çš„åœ°å€å¾ˆå¯èƒ½æ˜¯è¿™æ ·çš„ï¼šã€Œhttp://111.202.34.130/1.jpgã€ï¼Œè¿™ä¸ªåœ°å€æ˜¯è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ã€‚ é‚£ä¹ˆå¦‚æœè¿™ä¸ªèŠ‚ç‚¹ IP å‘ç”Ÿäº†å˜æ›´æ€ä¹ˆåŠï¼Ÿæˆ–è€…æˆ‘ä»¬å¦‚æœæ›´æ”¹äº† CDN å‚å•†æ€ä¹ˆåŠï¼Ÿæ˜¯ä¸æ˜¯è¦ä¿®æ”¹æ‰€æœ‰çš„å•†å“çš„ url åŸŸåå‘¢ï¼Ÿè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å·¥ä½œé‡äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ å°†ç¬¬ä¸‰æ–¹å‚å•†æä¾›çš„ IP éšè—èµ·æ¥ï¼Œç»™åˆ°ç”¨æˆ·çš„æœ€å¥½æ˜¯ä¸€ä¸ªæœ¬å…¬å¸åŸŸåçš„å­åŸŸåã€‚ é—®ï¼šé‚£ä¹ˆå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿè¿™å°±éœ€è¦ä¾é  DNS æ¥å¸®æˆ‘ä»¬è§£å†³åŸŸåæ˜ å°„çš„é—®é¢˜äº†ã€‚ åŸŸåç³»ç»Ÿ(DNSï¼ŒDomain Name System)ï¼šå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­˜å‚¨åŸŸåå’Œ IP åœ°å€å¯¹åº”å…³ç³»çš„åˆ†å¸ƒå¼æ•°æ®åº“ã€‚è€ŒåŸŸåè§£æçš„ç»“æœä¸€èˆ¬æœ‰ä¸¤ç§ï¼š ä¸€ç§å«åš A è®°å½•ï¼Œè¿”å›çš„æ˜¯åŸŸåå¯¹åº”çš„ IP åœ°å€ï¼› å¦ä¸€ç§æ˜¯ CNAME è®°å½•ï¼Œè¿”å›çš„æ˜¯å¦ä¸€ä¸ªåŸŸåã€‚ ä¹Ÿå°±æ˜¯è¯´å½“å‰åŸŸåçš„è§£æè¦è·³è½¬åˆ°å¦ä¸€ä¸ªåŸŸåçš„è§£æä¸Šï¼Œå®é™…ä¸Š www.baidu.com åŸŸåçš„è§£æç»“æœå°±æ˜¯ä¸€ä¸ª CNAME è®°å½•ï¼ŒåŸŸåçš„è§£æè¢«è·³è½¬åˆ° www.a.shifen.com ä¸Šäº†ï¼Œæ­£æ˜¯åˆ©ç”¨ CNAME è®°å½•æ¥è§£å†³åŸŸåæ˜ å°„é—®é¢˜çš„ã€‚ é—®ï¼šå…·ä½“æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ã€‚ æ¯”å¦‚ä½ çš„å…¬å¸çš„ä¸€çº§åŸŸåå«åš example.comï¼Œé‚£ä¹ˆä½ å¯ä»¥ç»™ä½ çš„å›¾ç‰‡æœåŠ¡çš„åŸŸåå®šä¹‰ä¸º img.example.comï¼Œç„¶åå°†è¿™ä¸ªåŸŸåçš„è§£æç»“æœçš„ CNAME é…ç½®åˆ° CDN æä¾›çš„åŸŸåä¸Šã€‚ æ¯”å¦‚ ucloud å¯èƒ½ä¼šæä¾›ä¸€ä¸ªåŸŸåæ˜¯ 80f21f91.cdn.ucloud.com.cn è¿™ä¸ªåŸŸåã€‚è¿™æ ·ä½ çš„ç”µå•†ç³»ç»Ÿä½¿ç”¨çš„å›¾ç‰‡åœ°å€å¯ä»¥æ˜¯ http://img.example.com/1.jpgã€‚ ç”¨æˆ·åœ¨è¯·æ±‚è¿™ä¸ªåœ°å€æ—¶ï¼ŒDNS æœåŠ¡å™¨ä¼šå°†åŸŸåè§£æåˆ° 80f21f91.cdn.ucloud.com.cn åŸŸåä¸Šï¼Œç„¶åå†å°†è¿™ä¸ªåŸŸåè§£æä¸º CDN çš„èŠ‚ç‚¹ IPï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ° CDN ä¸Šé¢çš„èµ„æºæ•°æ®äº†ã€‚ é—®ï¼šDNS åŸŸåè§£æçš„æ—¶é—´å¯èƒ½ä¼šæœ‰ç‚¹ä¹…ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ ä¸€ä¸ªè§£å†³çš„æ€è·¯æ˜¯ï¼šåœ¨ APP å¯åŠ¨æ—¶ï¼Œå¯¹éœ€è¦è§£æçš„åŸŸååšé¢„å…ˆè§£æï¼Œç„¶åæŠŠè§£æçš„ç»“æœç¼“å­˜åˆ°æœ¬åœ°çš„ä¸€ä¸ª LRU ç¼“å­˜é‡Œé¢ã€‚è¿™æ ·å½“æˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªåŸŸåçš„æ—¶å€™ï¼Œåªéœ€è¦ä»ç¼“å­˜ä¸­ç›´æ¥æ‹¿åˆ°æ‰€éœ€è¦çš„ IP åœ°å€å°±å¥½äº†ï¼Œå¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨æ‰ä¼šèµ°æ•´ä¸ª DNS æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚åŒæ—¶ï¼Œä¸ºäº†é¿å… DNS è§£æç»“æœçš„å˜æ›´é€ æˆç¼“å­˜å†…æ•°æ®å¤±æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæœŸåœ°æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ GSLB å…¨å±€è´Ÿè½½å‡è¡¡(GSLBï¼ŒGlobal Server Load Balance)ï¼šä¸»è¦æ˜¯å¯¹äºéƒ¨ç½²åœ¨ä¸åŒåœ°åŸŸçš„æœåŠ¡å™¨ä¹‹é—´åšè´Ÿè½½å‡è¡¡ï¼Œåº•å±‚å¯èƒ½ç®¡ç†äº†å¾ˆå¤šçš„æœ¬åœ°è´Ÿè½½å‡è¡¡ç»„ä»¶ã€‚å®ƒæœ‰ä¸¤æ–¹é¢çš„ä½œç”¨ï¼š ä¸€æ–¹é¢ï¼Œå®ƒæ˜¯ä¸€ç§è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ã€‚è´Ÿè½½å‡è¡¡ï¼Œé¡¾åæ€ä¹‰å˜›ï¼ŒæŒ‡çš„æ˜¯è®©æµé‡å¹³å‡åˆ†é…ä½¿å¾—ä¸‹é¢ç®¡ç†çš„æœåŠ¡å™¨çš„è´Ÿè½½æ›´å¹³å‡ï¼› å¦ä¸€æ–¹é¢ï¼Œå®ƒè¿˜éœ€è¦ä¿è¯æµé‡æµç»çš„æœåŠ¡å™¨ä¸æµé‡æºå¤´åœ¨åœ°ç¼˜ä¸Šæ˜¯æ¯”è¾ƒæ¥è¿‘çš„ã€‚ GSLB å¯ä»¥é€šè¿‡å¤šç§ç­–ç•¥ï¼Œæ¥ä¿è¯è¿”å›çš„ CDN èŠ‚ç‚¹å’Œç”¨æˆ·å°½é‡ä¿è¯åœ¨åŒä¸€åœ°ç¼˜åŒºåŸŸï¼š æ¯”å¦‚è¯´å¯ä»¥å°†ç”¨æˆ·çš„ IP åœ°å€æŒ‰ç…§åœ°ç†ä½ç½®åˆ’åˆ†ä¸ºè‹¥å¹²çš„åŒºåŸŸï¼Œç„¶åå°† CDN èŠ‚ç‚¹å¯¹åº”åˆ°ä¸€ä¸ªåŒºåŸŸä¸Šï¼Œç„¶åæ ¹æ®ç”¨æˆ·æ‰€åœ¨åŒºåŸŸæ¥è¿”å›åˆé€‚çš„èŠ‚ç‚¹ï¼› ä¹Ÿå¯ä»¥é€šè¿‡å‘é€æ•°æ®åŒ…æµ‹é‡ RTT çš„æ–¹å¼æ¥å†³å®šè¿”å›å“ªä¸€ä¸ªèŠ‚ç‚¹ã€‚ æœ‰äº† GSLB ä¹‹åï¼ŒèŠ‚ç‚¹çš„è§£æè¿‡ç¨‹å˜æˆäº†ä¸‹å›¾ä¸­çš„æ ·å­ï¼š å½“ç„¶ï¼Œæ˜¯å¦èƒ½å¤Ÿä» CDN èŠ‚ç‚¹ä¸Šè·å–åˆ°èµ„æºè¿˜å–å†³äº CDN çš„åŒæ­¥å»¶æ—¶ã€‚ ä¸€èˆ¬ï¼Œä¼šé€šè¿‡ CDN å‚å•†çš„æ¥å£å°†é™æ€çš„èµ„æºå†™å…¥åˆ°æŸä¸€ä¸ª CDN èŠ‚ç‚¹ä¸Š ï¼Œå†ç”± CDN å†…éƒ¨çš„åŒæ­¥æœºåˆ¶å°†èµ„æºåˆ†æ•£åŒæ­¥åˆ°æ¯ä¸ª CDN èŠ‚ç‚¹ï¼Œå³ä½¿ CDN å†…éƒ¨ç½‘ç»œç»è¿‡äº†ä¼˜åŒ–ï¼Œè¿™ä¸ªåŒæ­¥çš„è¿‡ç¨‹æ˜¯æœ‰å»¶æ—¶çš„ï¼Œä¸€æ—¦æˆ‘ä»¬æ— æ³•ä»é€‰å®šçš„ CDN èŠ‚ç‚¹ä¸Šè·å–åˆ°æ•°æ®ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸ä»æºç«™è·å–æ•°æ®ï¼Œè€Œç”¨æˆ·ç½‘ç»œåˆ°æºç«™çš„ç½‘ç»œå¯èƒ½ä¼šè·¨è¶Šå¤šä¸ªä¸»å¹²ç½‘ï¼Œè¿™æ ·ä¸ä»…æ€§èƒ½ä¸Šæœ‰æŸè€—ï¼Œä¹Ÿä¼šæ¶ˆè€—æºç«™çš„å¸¦å®½ï¼Œå¸¦æ¥æ›´é«˜çš„ç ”å‘æˆæœ¬ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ CDN çš„æ—¶å€™éœ€è¦å…³æ³¨ CDN çš„å‘½ä¸­ç‡å’Œæºç«™çš„å¸¦å®½æƒ…å†µã€‚ å°ç»“ DNS æŠ€æœ¯æ˜¯ CDN å®ç°ä¸­ä½¿ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„è¯·æ±‚æ˜ å°„åˆ° CDN èŠ‚ç‚¹ä¸Šï¼› DNS è§£æç»“æœéœ€è¦åšæœ¬åœ°ç¼“å­˜ï¼Œé™ä½ DNS è§£æè¿‡ç¨‹çš„å“åº”æ—¶é—´ï¼› GSLB å¯ä»¥ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªç¦»ç€ä»–æ›´è¿‘çš„èŠ‚ç‚¹ï¼ŒåŠ å¿«é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:3:4","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"å››ã€æ¶ˆæ¯é˜Ÿåˆ— ä¸Šé¢ä¸€ç›´å…³æ³¨çš„æ˜¯å¦‚ä½•æå‡è¯»è¯·æ±‚çš„æ€§èƒ½ï¼Œä½†éšç€ä¸šåŠ¡å‘å±•ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›å­˜åœ¨é«˜å¹¶å‘å†™è¯·æ±‚çš„åœºæ™¯ï¼Œå…¶ä¸­ç§’æ€æŠ¢è´­å°±æ˜¯æœ€å…¸å‹çš„åœºæ™¯ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:4:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"åº”ç”¨åœºæ™¯ é«˜å¹¶å‘å†™è¯·æ±‚-å‰Šå³° ç§’æ€åœºæ™¯ï¼š ç§’æ€å¼€å§‹å‰ï¼Œç”¨æˆ·æŸ¥è¯¢çš„æ˜¯å°‘é‡çš„å•†å“æ•°æ®ï¼Œå±äºæŸ¥è¯¢çš„çƒ­ç‚¹æ•°æ®ï¼Œå¯ä»¥é‡‡ç”¨ç¼“å­˜ç­–ç•¥ï¼Œå°†è¯·æ±‚å°½é‡æŒ¡åœ¨ä¸Šå±‚çš„ç¼“å­˜ä¸­ï¼Œèƒ½è¢«é™æ€åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´å•†åŸé‡Œçš„å›¾ç‰‡å’Œè§†é¢‘æ•°æ®ï¼Œå°½é‡åšåˆ°é™æ€åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥å‘½ä¸­ CDN èŠ‚ç‚¹ç¼“å­˜ï¼Œå‡å°‘ Web æœåŠ¡å™¨çš„æŸ¥è¯¢é‡å’Œå¸¦å®½è´Ÿæ‹…ã€‚Web æœåŠ¡å™¨æ¯”å¦‚ Nginx å¯ä»¥ç›´æ¥è®¿é—®åˆ†å¸ƒå¼ç¼“å­˜èŠ‚ç‚¹ï¼Œè¿™æ ·å¯ä»¥é¿å…è¯·æ±‚åˆ°è¾¾ Tomcat ç­‰ä¸šåŠ¡æœåŠ¡å™¨ã€‚ ç§’æ€å¼€å§‹åï¼Œç”¨æˆ·ç¬é—´å‘ç”µå•†ç³»ç»Ÿè¯·æ±‚ç”Ÿæˆè®¢å•ï¼Œæ‰£å‡åº“å­˜ï¼Œç”¨æˆ·çš„è¿™äº›å†™æ“ä½œéƒ½æ˜¯ä¸ç»è¿‡ç¼“å­˜ç›´è¾¾æ•°æ®åº“çš„ã€‚1 ç§’é’Ÿä¹‹å†…ï¼Œæœ‰ 1 ä¸‡ä¸ªæ•°æ®åº“è¿æ¥åŒæ—¶è¾¾åˆ°ï¼Œç³»ç»Ÿçš„æ•°æ®åº“æ¿’ä¸´å´©æºƒï¼Œå¯»æ‰¾èƒ½å¤Ÿåº”å¯¹å¦‚æ­¤é«˜å¹¶å‘çš„å†™è¯·æ±‚æ–¹æ¡ˆè¿«åœ¨çœ‰ç«ã€‚ åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼ŒçŸ­æ—¶é—´ä¹‹å†…æ•°æ®åº“çš„å†™æµé‡ä¼šå¾ˆé«˜ï¼Œé‚£ä¹ˆä¾ç…§æˆ‘ä»¬ä»¥å‰çš„æ€è·¯åº”è¯¥å¯¹æ•°æ®åšåˆ†åº“åˆ†è¡¨ã€‚å¦‚æœå·²ç»åšäº†åˆ†åº“åˆ†è¡¨ï¼Œé‚£ä¹ˆå°±éœ€è¦æ‰©å±•æ›´å¤šçš„æ•°æ®åº“æ¥åº”å¯¹æ›´é«˜çš„å†™æµé‡ã€‚ä½†æ˜¯æ— è®ºæ˜¯åˆ†åº“åˆ†è¡¨ï¼Œè¿˜æ˜¯æ‰©å……æ›´å¤šçš„æ•°æ®åº“ï¼Œéƒ½ä¼šæ¯”è¾ƒå¤æ‚ï¼ŒåŸå› æ˜¯ä½ éœ€è¦å°†æ•°æ®åº“ä¸­çš„æ•°æ®åšè¿ç§»ï¼Œè¿™ä¸ªæ—¶é—´å°±è¦æŒ‰å¤©ç”šè‡³æŒ‰å‘¨æ¥è®¡ç®—äº†ã€‚ è€Œåœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œé«˜å¹¶å‘çš„å†™è¯·æ±‚å¹¶ä¸æ˜¯æŒç»­çš„ï¼Œä¹Ÿä¸æ˜¯ç»å¸¸å‘ç”Ÿçš„ï¼Œè€Œåªæœ‰åœ¨ç§’æ€æ´»åŠ¨å¼€å§‹åçš„å‡ ç§’æˆ–è€…åå‡ ç§’æ—¶é—´å†…æ‰ä¼šå­˜åœ¨ã€‚ä¸ºäº†åº”å¯¹è¿™åå‡ ç§’çš„ç¬é—´å†™é«˜å³°ï¼Œå°±è¦èŠ±è´¹å‡ å¤©ç”šè‡³å‡ å‘¨çš„æ—¶é—´æ¥æ‰©å®¹æ•°æ®åº“ï¼Œå†åœ¨ç§’æ€ä¹‹åèŠ±è´¹å‡ å¤©çš„æ—¶é—´æ¥åšç¼©å®¹ï¼Œè¿™æ— ç–‘æ˜¯å¾—ä¸å¿å¤±çš„ã€‚ æ‰€ä»¥ï¼Œè§£å†³æ€è·¯æ˜¯ï¼šå°†ç§’æ€è¯·æ±‚æš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åä¸šåŠ¡æœåŠ¡å™¨ä¼šå“åº”ç”¨æˆ·ã€Œç§’æ€ç»“æœæ­£åœ¨è®¡ç®—ä¸­ã€ï¼Œé‡Šæ”¾äº†ç³»ç»Ÿèµ„æºä¹‹åå†å¤„ç†å…¶å®ƒç”¨æˆ·çš„è¯·æ±‚ã€‚ æˆ‘ä»¬ä¼šåœ¨åå°å¯åŠ¨è‹¥å¹²ä¸ªé˜Ÿåˆ—å¤„ç†ç¨‹åºï¼Œæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå†æ‰§è¡Œæ ¡éªŒåº“å­˜ã€ä¸‹å•ç­‰é€»è¾‘ã€‚å› ä¸ºåªæœ‰æœ‰é™ä¸ªé˜Ÿåˆ—å¤„ç†çº¿ç¨‹åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥è½å…¥åç«¯æ•°æ®åº“ä¸Šçš„å¹¶å‘è¯·æ±‚æ˜¯æœ‰é™çš„ã€‚è€Œè¯·æ±‚æ˜¯å¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¢«çŸ­æš‚åœ°å †ç§¯ï¼Œå½“åº“å­˜è¢«æ¶ˆè€—å®Œä¹‹åï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å †ç§¯çš„è¯·æ±‚å°±å¯ä»¥è¢«ä¸¢å¼ƒäº†ã€‚ è¿™å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—åœ¨ç§’æ€ç³»ç»Ÿä¸­æœ€ä¸»è¦çš„ä½œç”¨ï¼šå‰Šå³°å¡«è°·ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒå¯ä»¥å‰Šå¹³çŸ­æš‚çš„æµé‡é«˜å³°ï¼Œè™½è¯´å †ç§¯ä¼šé€ æˆè¯·æ±‚è¢«çŸ­æš‚å»¶è¿Ÿå¤„ç†ï¼Œä½†æ˜¯åªè¦æˆ‘ä»¬æ—¶åˆ»ç›‘æ§æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å †ç§¯é•¿åº¦ï¼Œåœ¨å †ç§¯é‡è¶…è¿‡ä¸€å®šé‡æ—¶ï¼Œå¢åŠ é˜Ÿåˆ—å¤„ç†æœºæ•°é‡ï¼Œæ¥æå‡æ¶ˆæ¯çš„å¤„ç†èƒ½åŠ›å°±å¥½äº†ï¼Œè€Œä¸”ç§’æ€çš„ç”¨æˆ·å¯¹äºçŸ­æš‚å»¶è¿ŸçŸ¥æ™“ç§’æ€çš„ç»“æœï¼Œä¹Ÿæ˜¯æœ‰ä¸€å®šå®¹å¿åº¦çš„ã€‚ æ¯”å¦‚ç§’æ€å•†å“æœ‰ 1000 ä»¶ï¼Œå¤„ç†ä¸€æ¬¡è´­ä¹°è¯·æ±‚çš„æ—¶é—´æ˜¯ 500msï¼Œé‚£ä¹ˆæ€»å…±å°±éœ€è¦ 500s çš„æ—¶é—´ã€‚è¿™æ—¶ï¼Œä½ éƒ¨ç½² 10 ä¸ªé˜Ÿåˆ—å¤„ç†ç¨‹åºï¼Œé‚£ä¹ˆç§’æ€è¯·æ±‚çš„å¤„ç†æ—¶é—´å°±æ˜¯ 50sï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·éœ€è¦ç­‰å¾… 50s æ‰å¯ä»¥çœ‹åˆ°ç§’æ€çš„ç»“æœï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚è¿™æ—¶ä¼šå¹¶å‘ 10 ä¸ªè¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¹¶ä¸ä¼šå¯¹æ•°æ®åº“é€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚ ä¸šåŠ¡æµç¨‹-å¼‚æ­¥ åœ¨åˆšæ‰æåˆ°çš„ç§’æ€åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åœ¨å¤„ç†è´­ä¹°è¯·æ±‚æ—¶ï¼Œéœ€è¦ 500msã€‚è¿™æ—¶ï¼Œä½ åˆ†æäº†ä¸€ä¸‹æ•´ä¸ªçš„è´­ä¹°æµç¨‹ï¼Œå‘ç°è¿™é‡Œé¢ä¼šæœ‰ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿä¼šæœ‰æ¬¡è¦çš„ä¸šåŠ¡é€»è¾‘ï¼šæ¯”å¦‚è¯´ï¼Œä¸»è¦çš„æµç¨‹æ˜¯ç”Ÿæˆè®¢å•ã€æ‰£å‡åº“å­˜ï¼›æ¬¡è¦çš„æµç¨‹å¯èƒ½æ˜¯æˆ‘ä»¬åœ¨ä¸‹å•è´­ä¹°æˆåŠŸä¹‹åä¼šç»™ç”¨æˆ·å‘æ”¾ä¼˜æƒ åˆ¸ï¼Œä¼šå¢åŠ ç”¨æˆ·çš„ç§¯åˆ†ã€‚å‡å¦‚å‘æ”¾ä¼˜æƒ åˆ¸çš„è€—æ—¶æ˜¯ 50msï¼Œå¢åŠ ç”¨æˆ·ç§¯åˆ†çš„è€—æ—¶ä¹Ÿæ˜¯ 50msï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å°†å‘æ”¾ä¼˜æƒ åˆ¸ã€å¢åŠ ç§¯åˆ†çš„æ“ä½œæ”¾åœ¨å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—å¤„ç†æœºä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆæ•´ä¸ªæµç¨‹å°±ç¼©çŸ­åˆ°äº† 400msï¼Œæ€§èƒ½æå‡äº† 20%ï¼Œå¤„ç†è¿™ 1000 ä»¶å•†å“çš„æ—¶é—´å°±å˜æˆäº† 400sã€‚å¦‚æœæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›èƒ½åœ¨ 50s ä¹‹å†…çœ‹åˆ°ç§’æ€ç»“æœçš„è¯ï¼Œåªéœ€è¦éƒ¨ç½² 8 ä¸ªé˜Ÿåˆ—ç¨‹åºå°±å¥½äº†ã€‚ ç»è¿‡å°†ä¸€äº›ä¸šåŠ¡æµç¨‹å¼‚æ­¥å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬çš„ç§’æ€ç³»ç»Ÿéƒ¨ç½²ç»“æ„ä¹Ÿä¼šæœ‰æ‰€æ”¹å˜ï¼š ç³»ç»Ÿæ¨¡å—-è§£è€¦ æ¯”å¦‚æ•°æ®å›¢é˜Ÿå¯¹ä½ è¯´ï¼Œåœ¨ç§’æ€æ´»åŠ¨ä¹‹åæƒ³è¦ç»Ÿè®¡æ´»åŠ¨çš„æ•°æ®ï¼Œå€Ÿæ­¤æ¥åˆ†ææ´»åŠ¨å•†å“çš„å—æ¬¢è¿ç¨‹åº¦ã€è´­ä¹°è€…äººç¾¤çš„ç‰¹ç‚¹ä»¥åŠç”¨æˆ·å¯¹äºç§’æ€äº’åŠ¨çš„æ»¡æ„ç¨‹åº¦ç­‰ç­‰æŒ‡æ ‡ã€‚è€Œæˆ‘ä»¬éœ€è¦å°†å¤§é‡çš„æ•°æ®å‘é€ç»™æ•°æ®å›¢é˜Ÿï¼Œé‚£ä¹ˆè¦æ€ä¹ˆåšå‘¢ï¼Ÿ ä¸€ä¸ªæ€è·¯æ˜¯ï¼šå¯ä»¥ä½¿ç”¨ HTTP æˆ–è€… RPC çš„æ–¹å¼æ¥åŒæ­¥åœ°è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å›¢é˜Ÿè¿™è¾¹æä¾›ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å®æ—¶å°†ç§’æ€çš„æ•°æ®æ¨é€ç»™å®ƒï¼Œä½†æ˜¯è¿™æ ·è°ƒç”¨ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š æ•´ä½“ç³»ç»Ÿçš„è€¦åˆæ€§æ¯”è¾ƒå¼ºï¼Œå½“æ•°æ®å›¢é˜Ÿçš„æ¥å£å‘ç”Ÿæ•…éšœæ—¶ï¼Œä¼šå½±å“åˆ°ç§’æ€ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ å½“æ•°æ®ç³»ç»Ÿéœ€è¦æ–°çš„å­—æ®µï¼Œå°±è¦å˜æ›´æ¥å£çš„å‚æ•°ï¼Œé‚£ä¹ˆç§’æ€ç³»ç»Ÿä¹Ÿè¦éšç€ä¸€èµ·å˜æ›´ã€‚ è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—é™ä½ä¸šåŠ¡ç³»ç»Ÿå’Œæ•°æ®ç³»ç»Ÿçš„ç›´æ¥è€¦åˆåº¦ã€‚ ç§’æ€ç³»ç»Ÿäº§ç”Ÿä¸€æ¡è´­ä¹°æ•°æ®åï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠå…¨éƒ¨æ•°æ®å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åæ•°æ®å›¢é˜Ÿå†è®¢é˜…è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„è¯é¢˜ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥æ¥æ”¶åˆ°æ•°æ®ï¼Œç„¶åå†åšè¿‡æ»¤å’Œå¤„ç†äº†ã€‚ç§’æ€ç³»ç»Ÿåœ¨è¿™æ ·è§£è€¦åˆä¹‹åï¼Œæ•°æ®ç³»ç»Ÿçš„æ•…éšœå°±ä¸ä¼šå½±å“åˆ°ç§’æ€ç³»ç»Ÿäº†ï¼ŒåŒæ—¶ï¼Œå½“æ•°æ®ç³»ç»Ÿéœ€è¦æ–°çš„å­—æ®µæ—¶ï¼Œåªéœ€è¦è§£ææ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæ‹¿åˆ°éœ€è¦çš„æ•°æ®å°±å¥½äº†ã€‚ å¼‚æ­¥å¤„ç†ã€è§£è€¦åˆå’Œå‰Šå³°å¡«è°· æ˜¯æ¶ˆæ¯é˜Ÿåˆ—åœ¨ç§’æ€ç³»ç»Ÿè®¾è®¡ä¸­èµ·åˆ°çš„ä¸»è¦ä½œç”¨ï¼Œå…¶ä¸­ï¼Œ å‰Šå³°å¡«è°·å¯ä»¥å‰Šå»åˆ°è¾¾ç§’æ€ç³»ç»Ÿçš„å³°å€¼æµé‡ï¼Œè®©ä¸šåŠ¡é€»è¾‘çš„å¤„ç†æ›´åŠ ç¼“å’Œï¼Œä½†ä¼šé€ æˆè¯·æ±‚å¤„ç†çš„å»¶è¿Ÿï¼› å¼‚æ­¥å¤„ç†å¯ä»¥ç®€åŒ–ä¸šåŠ¡æµç¨‹ä¸­çš„æ­¥éª¤ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ï¼› è§£è€¦åˆå¯ä»¥å°†ç§’æ€ç³»ç»Ÿå’Œæ•°æ®ç³»ç»Ÿè§£è€¦å¼€ï¼Œè¿™æ ·ä¸¤ä¸ªç³»ç»Ÿçš„ä»»ä½•å˜æ›´éƒ½ä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå¯ä»¥æå‡ç³»ç»Ÿçš„é²æ£’æ€§ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:4:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é¿å…é‡å¤æ¶ˆè´¹ é¿å…æ¶ˆæ¯ä¸¢å¤± å¦‚æœè¦ä¿è¯æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œé¦–å…ˆå°±è¦ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚ æ¶ˆæ¯ä¸¢å¤±ä¸»è¦å­˜åœ¨ä¸‰ä¸ªåœºæ™¯ï¼š æ¶ˆæ¯ä»ç”Ÿäº§è€…å†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„è¿‡ç¨‹ã€‚ æ¶ˆæ¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å­˜å‚¨åœºæ™¯ã€‚ æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„è¿‡ç¨‹ã€‚ æ¶ˆæ¯ç”Ÿäº§çš„è¿‡ç¨‹ä¸­ä¸¢å¤± ä¸»è¦åŸå› ï¼šç½‘ç»œæŠ–åŠ¨ï¼Œæ¶ˆæ¯æœ‰å¯èƒ½å› ä¸ºç½‘ç»œçš„é”™è¯¯è€Œä¸¢å¤±ã€‚ è§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯é‡ä¼ ã€‚å½“ä½ å‘ç°å‘é€è¶…æ—¶åä½ å°±å°†æ¶ˆæ¯é‡æ–°å‘ä¸€æ¬¡ï¼Œä½†æ˜¯ä½ ä¹Ÿä¸èƒ½æ— é™åˆ¶åœ°é‡ä¼ æ¶ˆæ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—å‘ç”Ÿæ•…éšœï¼Œæˆ–è€…æ˜¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç½‘ç»œæ–­å¼€äº†ï¼Œé‡è¯• 2ï½3 æ¬¡å°±å¯ä»¥äº†ã€‚ æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸¢å¤± ä¸»è¦åŸå› ï¼šä¸ºäº†å‡å°‘æ¶ˆæ¯å­˜å‚¨æ—¶å¯¹ç£ç›˜çš„éšæœº I/Oï¼ŒKafka å¯ä»¥é…ç½®å½“è¾¾åˆ°æŸä¸€æ—¶é—´é—´éš”ï¼Œæˆ–è€…ç´¯ç§¯ä¸€å®šçš„æ¶ˆæ¯æ•°é‡çš„æ—¶å€™å†åˆ·ç›˜ï¼Œä¹Ÿå°±æ˜¯æ‰€è¯´çš„å¼‚æ­¥åˆ·ç›˜ã€‚ è§£å†³æ–¹æ¡ˆï¼šè€ƒè™‘ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½² Kafka æœåŠ¡ï¼Œé€šè¿‡éƒ¨ç½²å¤šä¸ªå‰¯æœ¬å¤‡ä»½æ•°æ®ï¼Œä¿è¯æ¶ˆæ¯å°½é‡ä¸ä¸¢å¤±ã€‚ å…·ä½“å®ç°ï¼šKafka é›†ç¾¤ä¸­æœ‰ä¸€ä¸ª Leader è´Ÿè´£æ¶ˆæ¯çš„å†™å…¥å’Œæ¶ˆè´¹ï¼Œå¯ä»¥æœ‰å¤šä¸ª Follower è´Ÿè´£æ•°æ®çš„å¤‡ä»½ã€‚Follower ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„é›†åˆå«åš ISRï¼Œå½“ Leader æ•…éšœæ—¶ï¼Œä¼šä» ISR ä¸­æ–°é€‰ä¸¾å‡ºæ¥ Leaderã€‚Leader çš„æ•°æ®ä¼šå¼‚æ­¥åœ°å¤åˆ¶ç»™ Followerï¼Œè¿™æ ·åœ¨ Leader å‘ç”Ÿæ‰ç”µæˆ–è€…å®•æœºæ—¶ï¼ŒKafka ä¼šä» Follower ä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼Œå‡å°‘æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½ã€‚ ç”±äºæ¶ˆæ¯æ˜¯å¼‚æ­¥åœ°ä» Leader å¤åˆ¶åˆ° Follower çš„ï¼Œæ‰€ä»¥ä¸€æ—¦ Leader å®•æœºï¼Œé‚£äº›è¿˜æ²¡æœ‰æ¥å¾—åŠå¤åˆ¶åˆ° Follower çš„æ¶ˆæ¯è¿˜æ˜¯ä¼šä¸¢å¤±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKafka ä¸ºç”Ÿäº§è€…æä¾›ä¸€ä¸ªé€‰é¡¹å«åš acksï¼Œå½“è¿™ä¸ªé€‰é¡¹è¢«è®¾ç½®ä¸º all æ—¶ï¼Œç”Ÿäº§è€…å‘é€çš„æ¯ä¸€æ¡æ¶ˆæ¯é™¤äº†å‘ç»™ Leader å¤–è¿˜ä¼šå‘ç»™æ‰€æœ‰çš„ ISRï¼Œå¹¶ä¸”å¿…é¡»å¾—åˆ° Leader å’Œæ‰€æœ‰ ISR çš„ç¡®è®¤åæ‰è¢«è®¤ä¸ºå‘é€æˆåŠŸã€‚è¿™æ ·ï¼Œåªæœ‰ Leader å’Œæ‰€æœ‰çš„ ISR éƒ½æŒ‚äº†ï¼Œæ¶ˆæ¯æ‰ä¼šä¸¢å¤±ã€‚ å»ºè®®æ˜¯ï¼š å¦‚æœä½ éœ€è¦ç¡®ä¿æ¶ˆæ¯ä¸€æ¡éƒ½ä¸èƒ½ä¸¢å¤±ï¼Œé‚£ä¹ˆå»ºè®®ä¸è¦å¼€å¯æ¶ˆæ¯é˜Ÿåˆ—çš„åŒæ­¥åˆ·ç›˜ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨é›†ç¾¤çš„æ–¹å¼æ¥è§£å†³ï¼Œå¯ä»¥é…ç½®å½“æ‰€æœ‰ ISR Follower éƒ½æ¥æ”¶åˆ°æ¶ˆæ¯æ‰è¿”å›æˆåŠŸã€‚ å¦‚æœå¯¹æ¶ˆæ¯çš„ä¸¢å¤±æœ‰ä¸€å®šçš„å®¹å¿åº¦ï¼Œé‚£ä¹ˆå»ºè®®ä¸éƒ¨ç½²é›†ç¾¤ï¼Œå³ä½¿ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œä¹Ÿå»ºè®®é…ç½®åªå‘é€ç»™ä¸€ä¸ª Follower å°±å¯ä»¥è¿”å›æˆåŠŸäº†ã€‚ æ¶ˆè´¹è¿‡ç¨‹ä¸­æ¶ˆæ¯ä¸¢å¤± ä¸»è¦åŸå› ï¼šä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„è¿›åº¦æ˜¯è®°å½•åœ¨æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤ä¸­çš„ï¼Œè€Œæ¶ˆè´¹çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼šæ¥æ”¶æ¶ˆæ¯ã€å¤„ç†æ¶ˆæ¯ã€æ›´æ–°æ¶ˆè´¹è¿›åº¦ã€‚æ¥æ”¶æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹éƒ½å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸æˆ–è€…å¤±è´¥ï¼Œæ¯”å¦‚è¯´ï¼Œæ¶ˆæ¯æ¥æ”¶æ—¶ç½‘ç»œå‘ç”ŸæŠ–åŠ¨ï¼Œå¯¼è‡´æ¶ˆæ¯å¹¶æ²¡æœ‰è¢«æ­£ç¡®çš„æ¥æ”¶åˆ°ï¼›å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½å‘ç”Ÿä¸€äº›ä¸šåŠ¡çš„å¼‚å¸¸å¯¼è‡´å¤„ç†æµç¨‹æœªæ‰§è¡Œå®Œæˆï¼Œè¿™æ—¶å¦‚æœæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼Œé‚£ä¹ˆè¿™æ¡å¤±è´¥çš„æ¶ˆæ¯å°±æ°¸è¿œä¸ä¼šè¢«å¤„ç†äº†ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸¢å¤±äº†ã€‚ è§£å†³æ–¹æ¡ˆï¼šä¸€å®šè¦ç­‰åˆ°æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†å®Œæˆåæ‰èƒ½æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼Œä½†æ˜¯è¿™ä¹Ÿä¼šé€ æˆæ¶ˆæ¯é‡å¤çš„é—®é¢˜ï¼Œæ¯”æ–¹è¯´æŸä¸€æ¡æ¶ˆæ¯åœ¨å¤„ç†ä¹‹åï¼Œæ¶ˆè´¹è€…æ°å¥½å®•æœºäº†ï¼Œé‚£ä¹ˆå› ä¸ºæ²¡æœ‰æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼Œæ‰€ä»¥å½“è¿™ä¸ªæ¶ˆè´¹è€…é‡å¯ä¹‹åï¼Œè¿˜ä¼šé‡å¤åœ°æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ã€‚ é¿å…é‡å¤æ¶ˆè´¹ ä¸ºäº†é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼Œéœ€è¦ä»˜å‡ºä¸¤æ–¹é¢çš„ä»£ä»·ï¼šä¸€æ–¹é¢æ˜¯æ€§èƒ½çš„æŸè€—ï¼›ä¸€æ–¹é¢å¯èƒ½é€ æˆæ¶ˆæ¯é‡å¤æ¶ˆè´¹ã€‚æ€§èƒ½æŸè€—è¿˜èƒ½æ¥å—ï¼Œä½†æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¯èƒ½å°±ä¼šé€ æˆä¸¥é‡é”™è¯¯ï¼Œé‚£ä¹ˆå¦‚ä½•é¿å…å‘¢ï¼Ÿ Kafka å‡ºç°æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„åŸå› ï¼š æ ¹æœ¬åŸå› ï¼šå·²ç»æ¶ˆè´¹çš„æ•°æ®æ²¡æœ‰æˆåŠŸæäº¤ offsetã€‚ Kafka ä¾§ç”±äºæœåŠ¡ç«¯å¤„ç†ä¸šåŠ¡æ—¶é—´é•¿æˆ–è€…ç½‘ç»œé“¾æ¥ç­‰ç­‰åŸå› è®© Kafka è®¤ä¸ºæœåŠ¡å‡æ­»ï¼Œè§¦å‘äº†åˆ†åŒº rebalanceã€‚ æƒ³è¦å®Œå…¨çš„é¿å…æ¶ˆæ¯é‡å¤çš„å‘ç”Ÿæ˜¯å¾ˆéš¾åšåˆ°çš„ï¼Œå› ä¸ºç½‘ç»œçš„æŠ–åŠ¨ã€æœºå™¨çš„å®•æœºå’Œå¤„ç†çš„å¼‚å¸¸éƒ½æ˜¯æ¯”è¾ƒéš¾ä»¥é¿å…çš„ï¼Œåœ¨å·¥ä¸šä¸Šå¹¶æ²¡æœ‰æˆç†Ÿçš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬ä¼šæŠŠè¦æ±‚æ”¾å®½ï¼Œåªè¦ä¿è¯å³ä½¿æ¶ˆè´¹åˆ°äº†é‡å¤çš„æ¶ˆæ¯ï¼Œä»æ¶ˆè´¹çš„æœ€ç»ˆç»“æœæ¥çœ‹å’Œåªæ¶ˆè´¹ä¸€æ¬¡æ˜¯ç­‰åŒçš„å°±å¥½äº†ï¼Œä¹Ÿå°±æ˜¯ä¿è¯åœ¨æ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹çš„è¿‡ç¨‹æ˜¯å¹‚ç­‰çš„ã€‚ æ³¨ï¼š**å¹‚ç­‰**æŒ‡åªæ‰§è¡Œä¸€æ¬¡æ“ä½œå’Œå¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªæ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ é—®ï¼šKafka å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ/å¦‚ä½•å®ç°å¹‚ç­‰æ€§ï¼Œè®¾è®¡å»é‡æœºåˆ¶ï¼Ÿ ç”Ÿäº§ç«¯ï¼š æ€è·¯ï¼šKafka æ”¯æŒå°† Producer å‡çº§ä¸ºå¹‚ç­‰æ€§ Producerï¼Œä¿è¯æ¶ˆæ¯è™½ç„¶å¯èƒ½åœ¨ç”Ÿäº§ç«¯é‡å¤ç”Ÿäº§ï¼Œä½†æ˜¯æœ€ç»ˆåœ¨æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨æ—¶åªä¼šå­˜å‚¨ä¸€ä»½ã€‚ å…·ä½“åšæ³•ï¼šç»™æ¯ä¸€ä¸ªç”Ÿäº§è€…ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œå¹¶ä¸”ä¸ºç”Ÿäº§çš„æ¯ä¸€æ¡æ¶ˆæ¯èµ‹äºˆä¸€ä¸ªå”¯ä¸€ IDï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„æœåŠ¡ç«¯ä¼šå­˜å‚¨ \u003c ç”Ÿäº§è€… IDï¼Œæœ€åä¸€æ¡æ¶ˆæ¯ ID\u003e çš„æ˜ å°„ã€‚å½“æŸä¸€ä¸ªç”Ÿäº§è€…äº§ç”Ÿæ–°çš„æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç«¯ä¼šæ¯”å¯¹æ¶ˆæ¯ ID æ˜¯å¦ä¸å­˜å‚¨çš„æœ€åä¸€æ¡ ID ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œå°±è®¤ä¸ºæ˜¯é‡å¤çš„æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯ä¼šè‡ªåŠ¨ä¸¢å¼ƒã€‚ æ¶ˆè´¹ç«¯ï¼š æ€è·¯ï¼šå¯åˆ†ä¸ºé€šç”¨å±‚å’Œä¸šåŠ¡å±‚ã€‚ å…·ä½“åšæ³•ï¼š é€šç”¨å±‚ï¼šå¯ä»¥åœ¨æ¶ˆæ¯è¢«ç”Ÿäº§çš„æ—¶å€™ï¼Œä½¿ç”¨å‘å·å™¨ç»™å®ƒç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ¶ˆæ¯ IDï¼Œæ¶ˆæ¯è¢«å¤„ç†ä¹‹åï¼ŒæŠŠè¿™ä¸ª ID å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œåœ¨å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ä¹‹å‰ï¼Œå…ˆä»æ•°æ®åº“é‡Œé¢æŸ¥è¯¢è¿™ä¸ªå…¨å±€ ID æ˜¯å¦è¢«æ¶ˆè´¹è¿‡ï¼Œå¦‚æœè¢«æ¶ˆè´¹è¿‡å°±æ”¾å¼ƒæ¶ˆè´¹ï¼› ä¸šåŠ¡å±‚ï¼šåˆ©ç”¨ä¹è§‚é”çš„æ–¹å¼æ¥å®ç°ã€‚è¿™ä¸ªæœºåˆ¶æ˜¯åœ¨æ¶ˆæ¯ä¸­æ·»åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œåœ¨ç”Ÿäº§æ¶ˆæ¯æ—¶å…ˆæŸ¥è¯¢æ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸”å°†ç‰ˆæœ¬å·è¿åŒæ¶ˆæ¯ä¸€èµ·å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¶ˆè´¹ç«¯åœ¨æ‹¿åˆ°æ¶ˆæ¯å’Œç‰ˆæœ¬å·åï¼Œæ‰§è¡Œæ—¶ä¹Ÿå¸¦ä¸Šç‰ˆæœ¬å·ã€‚æ¯”å¦‚åœ¨æ¶ˆè´¹ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œversion å€¼ä¸º 1ï¼ŒSQL å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”åŒæ—¶æŠŠ version å€¼æ”¹ä¸ºäº† 2ï¼›åœ¨æ‰§è¡Œç¬¬äºŒæ¡ç›¸åŒçš„æ¶ˆæ¯æ—¶ï¼Œç”±äº version å€¼ä¸å†æ˜¯ 1ï¼Œæ‰€ä»¥è¿™æ¡ SQL ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Œä¹Ÿå°±ä¿è¯äº†æ¶ˆæ¯çš„å¹‚ç­‰æ€§ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:4:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ¶ˆæ¯å»¶è¿Ÿ/å †ç§¯ å¦‚ä½•ç›‘æ§æ¶ˆæ¯å»¶è¿Ÿ ç›‘æ§æ¶ˆæ¯çš„å»¶è¿Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æä¾›çš„å·¥å…·ï¼Œé€šè¿‡ç›‘æ§æ¶ˆæ¯çš„å †ç§¯æ¥å®Œæˆï¼› é€šè¿‡ç”Ÿæˆç›‘æ§æ¶ˆæ¯çš„æ–¹å¼æ¥ç›‘æ§æ¶ˆæ¯çš„å»¶è¿Ÿæƒ…å†µã€‚ ç›‘æ§æ¶ˆæ¯çš„å †ç§¯ é¦–å…ˆéœ€è¦ä»åŸç†ä¸Šäº†è§£ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¿›åº¦æ˜¯å¤šå°‘ï¼Œå› ä¸ºè¿™æ ·æ‰æ–¹ä¾¿è®¡ç®—å½“å‰çš„æ¶ˆè´¹å»¶è¿Ÿæ˜¯å¤šå°‘ã€‚æ¯”æ–¹è¯´ï¼Œç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­ä¸€å…±ç”Ÿäº§äº† 1000 æ¡æ¶ˆæ¯ï¼ŒæŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹è¿›åº¦æ˜¯ 900 æ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹å»¶è¿Ÿå°±æ˜¯ 100 æ¡æ¶ˆæ¯ã€‚ åœ¨ Kafka ä¸­ï¼Œæ¶ˆè´¹è€…çš„æ¶ˆè´¹è¿›åº¦åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸Šæ˜¯ä¸åŒçš„ã€‚ åœ¨ Kafka0.9 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ¶ˆè´¹è¿›åº¦æ˜¯å­˜å‚¨åœ¨ ZooKeeper ä¸­çš„ï¼Œæ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™ï¼Œå…ˆè¦ä» ZooKeeper ä¸­è·å–æœ€æ–°çš„æ¶ˆè´¹è¿›åº¦ï¼Œå†ä»è¿™ä¸ªè¿›åº¦çš„åŸºç¡€ä¸Šæ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚ åœ¨ Kafka0.9 ç‰ˆæœ¬ä¹‹åï¼Œæ¶ˆè´¹è¿›åº¦è¢«è¿å…¥åˆ° Kakfa çš„ä¸€ä¸ªä¸“é—¨çš„ topic å« __consumer_offsets é‡Œé¢ã€‚ Kafka ä¹Ÿæä¾›äº†ä¸€äº›å·¥å…·æ¥è·å–è¿™ä¸ªæ¶ˆè´¹è¿›åº¦çš„ä¿¡æ¯ï¼Œå¸®åŠ©å®ç°è‡ªå·±çš„ç›‘æ§ï¼Œæ¯”è¾ƒæ¨è JMXã€‚Kafka é€šè¿‡ JMX æš´éœ²äº†æ¶ˆæ¯å †ç§¯çš„æ•°æ®ï¼Œæˆ‘åœ¨æœ¬åœ°å¯åŠ¨äº†ä¸€ä¸ª console consumerï¼Œç„¶åä½¿ç”¨ jconsole è¿æ¥è¿™ä¸ª consumerï¼Œä½ å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ª consumer çš„å †ç§¯æ•°æ®äº†ã€‚ ç”Ÿæˆç›‘æ§æ¶ˆæ¯ å…·ä½“åšæ³•ï¼š å…ˆå®šä¹‰ä¸€ç§ç‰¹æ®Šçš„æ¶ˆæ¯ï¼› ç„¶åå¯åŠ¨ä¸€ä¸ªç›‘æ§ç¨‹åºï¼Œå°†è¿™ä¸ªæ¶ˆæ¯å®šæ—¶åœ°å¾ªç¯å†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚æ¶ˆæ¯çš„å†…å®¹å¯ä»¥æ˜¯ç”Ÿæˆæ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œå¹¶ä¸”ä¹Ÿä¼šä½œä¸ºé˜Ÿåˆ—çš„æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼› ä¸šåŠ¡å¤„ç†ç¨‹åºæ¶ˆè´¹åˆ°è¿™ä¸ªæ¶ˆæ¯æ—¶ç›´æ¥ä¸¢å¼ƒæ‰ï¼Œè€Œç›‘æ§ç¨‹åºåœ¨æ¶ˆè´¹åˆ°è¿™ä¸ªæ¶ˆæ¯æ—¶ï¼Œå°±å¯ä»¥å’Œè¿™ä¸ªæ¶ˆæ¯çš„ç”Ÿæˆæ—¶é—´åšæ¯”è¾ƒï¼Œå¦‚æœæ—¶é—´å·®è¾¾åˆ°æŸä¸€ä¸ªé˜ˆå€¼å°±å¯ä»¥å‘æˆ‘ä»¬æŠ¥è­¦ã€‚ å‡å°‘æ¶ˆæ¯å»¶è¿Ÿ å‡å°‘æ¶ˆæ¯çš„å¤„ç†å»¶è¿Ÿï¼Œéœ€è¦åœ¨æ¶ˆè´¹ç«¯å’Œæ¶ˆæ¯é˜Ÿåˆ—ä¸¤ä¸ªå±‚é¢æ¥å®Œæˆã€‚ æ¶ˆè´¹ç«¯ï¼š å¢åŠ æ¶ˆè´¹è€…çš„æ•°é‡ åœ¨ Kafka ä¸­ï¼ŒTopic çš„ Partition æ•°é‡å†³å®šäº†æ¶ˆè´¹çš„å¹¶è¡Œåº¦ï¼Œå¢åŠ å¤šä½™çš„æ¶ˆè´¹è€…ä¹Ÿæ˜¯æ²¡ç”¨çš„ã€‚è¿™æ˜¯å› ä¸º Kafka çº¦å®šä¸€ä¸ª Partition åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ ä¼˜åŒ–æ¶ˆè´¹ä»£ç  å¯ä»¥åœ¨ consumer ä¸­æå‡å¤„ç†æ¶ˆæ¯çš„å¹¶è¡Œåº¦ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘ä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ¥å¢åŠ å¤„ç†èƒ½åŠ›ï¼šä½ å¯ä»¥é¢„å…ˆåˆ›å»ºä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹æ± ï¼Œåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼ŒæŠŠæ¶ˆæ¯ä¸¢åˆ°çº¿ç¨‹æ± ä¸­æ¥å¼‚æ­¥åœ°å¤„ç†ï¼Œè¿™æ ·ï¼ŒåŸæœ¬ä¸²è¡Œçš„æ¶ˆè´¹æ¶ˆæ¯çš„æµç¨‹å°±å˜æˆäº†å¹¶è¡Œçš„æ¶ˆè´¹ï¼Œå¯ä»¥æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„ååé‡ï¼Œåœ¨å¹¶è¡Œå¤„ç†çš„å‰æä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€æ¬¡å’Œæ¶ˆæ¯é˜Ÿåˆ—çš„äº¤äº’ä¸­å¤šæ‹‰å–å‡ æ¡æ•°æ®ï¼Œç„¶ååˆ†é…ç»™å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ æ¶ˆæ¯é˜Ÿåˆ—ï¼š é›¶æ‹·è´ ä¼ ç»Ÿæ•°æ®æ–‡ä»¶æ‹·è´ æ“ä½œç³»ç»Ÿå°†æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼› åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨å°†å†…æ ¸ç¼“å­˜åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼› åº”ç”¨ç¨‹åºå°†ç”¨æˆ·ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ Socket ç¼“å†²åŒºä¸­ï¼› æ“ä½œç³»ç»Ÿå°† Socket ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç½‘å¡ç¼“å†²åŒºä¸­ï¼Œé€šè¿‡ç½‘å¡å‘é€ç»™æ•°æ®æ¥æ”¶æ–¹ã€‚ æ€»ç»“ï¼šæ¶‰åŠ 1 æ¬¡å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„æ•°æ®æ‹·è´å’Œ 1 æ¬¡ ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ•°æ®æ‹·è´ã€‚ é›¶æ‹·è´ æ“ä½œç³»ç»Ÿæä¾›äº† Sendfile å‡½æ•°ï¼Œå¯ä»¥å‡å°‘æ•°æ®è¢«æ‹·è´çš„æ¬¡æ•°ã€‚ä½¿ç”¨äº† Sendfile ä¹‹åï¼Œåœ¨å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®ä¸ä¼šè¢«æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œè€Œæ˜¯ç›´æ¥è¢«æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼ŒèŠ‚çœäº†ä¸€æ¬¡æ‹·è´çš„è¿‡ç¨‹ï¼Œæå‡äº†æ¶ˆæ¯å‘é€çš„æ€§èƒ½ã€‚ æ“ä½œç³»ç»Ÿå°†æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼› ç³»ç»Ÿè°ƒç”¨ Sendfile å°†æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦ç›´æ¥è¢«æ‹·è´åˆ° Socket ç¼“å†²åŒº(ä»…ä»…ä¼šæ‹·è´ä¸€ä¸ªæè¿°ç¬¦è¿‡å»ï¼Œä¸ä¼šæ‹·è´æ•°æ®åˆ° Socket ç¼“å­˜)ï¼› æ“ä½œç³»ç»Ÿå°† Socket ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç½‘å¡ç¼“å†²åŒºä¸­ï¼Œé€šè¿‡ç½‘å¡å‘é€ç»™æ•°æ®æ¥æ”¶æ–¹ã€‚ æ€»ç»“ï¼šçœç•¥äº†ä¸¤æ¬¡ä¸å¿…è¦çš„æ•°æ®æ‹·è´ï¼š ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼› ä»ç”¨æˆ·ç©ºé—´å†æ¬¡æ‹·è´åˆ°å†…æ ¸ç©ºé—´ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:4:3","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"äº”ã€å¾®æœåŠ¡ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æ¦‚è¿° ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¾®æœåŠ¡æ¶æ„ï¼Ÿ ä¸€ä½“åŒ–æ¶æ„å¢åŠ äº†ç ”å‘çš„æˆæœ¬ï¼ŒæŠ‘åˆ¶äº†ç ”å‘æ•ˆç‡çš„æå‡ã€‚ ã€Šäººæœˆç¥è¯ã€‹ä¸­æ›¾ç»æåˆ°ï¼šä¸€ä¸ªå›¢é˜Ÿå†…éƒ¨æ²Ÿé€šæˆæœ¬ï¼Œå’Œäººå‘˜æ•°é‡ n æœ‰å…³ï¼Œçº¦ç­‰äº n(n-1)/2ï¼Œä¹Ÿå°±æ˜¯è¯´éšç€å›¢é˜Ÿäººå‘˜çš„å¢åŠ ï¼Œæ²Ÿé€šçš„æˆæœ¬å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œä¸€ä¸ª 100 äººçš„å›¢é˜Ÿï¼Œéœ€è¦æ²Ÿé€šçš„æ¸ é“å¤§æ¦‚æ˜¯ 100ï¼ˆ100-1ï¼‰/2 = 4950ã€‚é‚£ä¹ˆä¸ºäº†å‡å°‘æ²Ÿé€šæˆæœ¬ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠå›¢é˜Ÿæ‹†åˆ†æˆè‹¥å¹²ä¸ªå°å›¢é˜Ÿï¼Œæ¯ä¸ªå°å›¢é˜Ÿ 5ï½7 äººï¼Œè´Ÿè´£ä¸€éƒ¨åˆ†åŠŸèƒ½æ¨¡å—çš„å¼€å‘å’Œç»´æŠ¤ã€‚ æŒ‰ç…§äºšé©¬é€Š CEOï¼Œè´ä½æ–¯çš„ã€Œä¸¤ä¸ªæŠ«è¨ã€çš„ç†è®ºï¼Œå¦‚æœä¸¤ä¸ªæŠ«è¨ä¸å¤Ÿä½ çš„å›¢é˜Ÿåƒï¼Œé‚£ä¹ˆä½ çš„å›¢é˜Ÿå°±å¤ªå¤§äº†ï¼Œéœ€è¦æ‹†åˆ†ï¼Œæ‰€ä»¥ä¸€ä¸ªå°å›¢é˜ŸåŒ…æ‹¬å¼€å‘ã€è¿ç»´ã€æµ‹è¯•ä»¥ 6ï½8 ä¸ªäººä¸ºæœ€ä½³ï¼› æœ‰çš„ç ”å‘åŒå­¦ä¼šè®¤ä¸ºæœ€å¿«çš„æ–¹å¼ï¼Œä¸æ˜¯è¯¢é—®å…¶ä»–å›¢é˜Ÿæ˜¯å¦æœ‰ç°æˆçš„ï¼Œè€Œæ˜¯è‡ªå·±å†™ä¸€å¥—ï¼Œä½†æ˜¯è¿™ç§æƒ³æ³•æ˜¯ä¸åˆé€‚çš„ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šé€ æˆåŠŸèƒ½æœåŠ¡çš„é‡å¤å¼€å‘ã€‚ ç”±äºä»£ç éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œæ¯ä¸ªäººéƒ½å‘åŒä¸€ä¸ªä»£ç åº“æäº¤ä»£ç ï¼Œä»£ç å†²çªæ— æ³•é¿å…ï¼›åŒæ—¶ï¼ŒåŠŸèƒ½ä¹‹é—´è€¦åˆä¸¥é‡ï¼Œå¯èƒ½ä½ åªæ˜¯æ›´æ”¹äº†å¾ˆå°çš„é€»è¾‘ï¼Œå´å¯¼è‡´å…¶å®ƒåŠŸèƒ½ä¸å¯ç”¨ï¼Œä»è€Œåœ¨æµ‹è¯•æ—¶éœ€è¦å¯¹æ•´ä½“åŠŸèƒ½å›å½’ï¼Œå»¶é•¿äº†äº¤ä»˜æ—¶é—´ã€‚ æ¨¡å—ä¹‹é—´äº’ç›¸ä¾èµ–ï¼Œä¸€ä¸ªå°å›¢é˜Ÿä¸­çš„æˆå‘˜çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œå°±å¯èƒ½ä¼šå½±å“åˆ°ï¼Œå…¶å®ƒå›¢é˜Ÿç»´æŠ¤çš„æœåŠ¡ï¼Œå¯¹äºæ•´ä½“ç³»ç»Ÿç¨³å®šæ€§å½±å“å¾ˆå¤§ã€‚ ä¸€ä½“åŒ–æ¶æ„å¯¹äºç³»ç»Ÿçš„è¿ç»´ä¹Ÿä¼šæœ‰å¾ˆå¤§çš„å½±å“ã€‚ åœ¨é¡¹ç›®åˆæœŸï¼Œä½ çš„ä»£ç å¯èƒ½åªæœ‰å‡ åƒè¡Œï¼Œæ„å»ºä¸€æ¬¡åªéœ€è¦ä¸€åˆ†é’Ÿï¼Œé‚£ä¹ˆä½ å¯ä»¥å¾ˆæ•æ·çµæ´»åœ°é¢‘ç¹ä¸Šçº¿å˜æ›´ä¿®å¤é—®é¢˜ã€‚ä½†æ˜¯å½“ä½ çš„ç³»ç»Ÿæ‰©å……åˆ°å‡ åä¸‡è¡Œï¼Œç”šè‡³ä¸Šç™¾ä¸‡è¡Œä»£ç çš„æ—¶å€™ï¼Œä¸€æ¬¡æ„å»ºçš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç¼–è¯‘ã€å•å…ƒæµ‹è¯•ã€æ‰“åŒ…å’Œä¸Šä¼ åˆ°æ­£å¼ç¯å¢ƒï¼ŒèŠ±è´¹çš„æ—¶é—´å¯èƒ½è¾¾åˆ°åå‡ åˆ†é’Ÿï¼Œå¹¶ä¸”ï¼Œä»»ä½•å°çš„ä¿®æ”¹ï¼Œéƒ½éœ€è¦æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼Œä¸Šçº¿å˜æ›´çš„è¿‡ç¨‹éå¸¸ä¸çµæ´»ã€‚ è¿™äº›é—®é¢˜ï¼Œéƒ½å¯ä»¥ç”¨å¾®æœåŠ¡æ¥è§£å†³ã€‚ å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™ å•ä¸€æœåŠ¡å†…éƒ¨åŠŸèƒ½çš„é«˜å†…èšã€ä½è€¦åˆã€‚å³ï¼Œæ¯ä¸ªæœåŠ¡åªå®Œæˆè‡ªå·±èŒè´£ä¹‹å†…çš„ä»»åŠ¡ï¼Œå¯¹äºä¸æ˜¯è‡ªå·±èŒè´£çš„åŠŸèƒ½ï¼Œäº¤ç»™å…¶å®ƒæœåŠ¡æ¥å®Œæˆã€‚ å…³æ³¨æœåŠ¡æ‹†åˆ†çš„ç²’åº¦ï¼Œå…ˆç²—ç•¥æ‹†åˆ†ï¼Œå†é€æ¸ç»†åŒ–ã€‚å› ä¸ºæœåŠ¡å¤šäº†ä¹Ÿä¼šå¸¦æ¥é—®é¢˜ï¼Œåƒæ˜¯æœåŠ¡ä¸ªæ•°çš„å¢åŠ ä¼šå¢åŠ è¿ç»´çš„æˆæœ¬ã€‚å†æ¯”å¦‚ï¼ŒåŸæœ¬ä¸€æ¬¡è¯·æ±‚åªéœ€è¦è°ƒç”¨è¿›ç¨‹å†…çš„å¤šä¸ªæ–¹æ³•ï¼Œç°åœ¨åˆ™éœ€è¦è·¨ç½‘ç»œè°ƒç”¨å¤šä¸ª RPC æœåŠ¡ï¼Œåœ¨æ€§èƒ½ä¸Šè‚¯å®šä¼šæœ‰æ‰€ä¸‹é™ã€‚æ¨èçš„åšæ³•æ˜¯ï¼šæ‹†åˆ†åˆæœŸå¯ä»¥æŠŠæœåŠ¡ç²’åº¦æ‹†çš„ç²—ä¸€äº›ï¼Œåé¢éšç€å›¢é˜Ÿå¯¹äºä¸šåŠ¡å’Œå¾®æœåŠ¡ç†è§£çš„åŠ æ·±ï¼Œå†è€ƒè™‘æŠŠæœåŠ¡ç²’åº¦ç»†åŒ–ã€‚æ¯”å¦‚è¯´ï¼Œå¯¹äºä¸€ä¸ªç¤¾åŒºç³»ç»Ÿæ¥è¯´ï¼Œä½ å¯ä»¥å…ˆæŠŠå’Œç”¨æˆ·å…³ç³»ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œéƒ½æ‹†åˆ†åˆ°ç”¨æˆ·å…³ç³»æœåŠ¡ä¸­ï¼Œä¹‹åï¼Œå†æŠŠå…¶ä¸­æ¯”å¦‚é»‘åå•çš„é€»è¾‘ç‹¬ç«‹æˆé»‘åå•æœåŠ¡ã€‚ æ‹†åˆ†çš„è¿‡ç¨‹ï¼Œè¦å°½é‡é¿å…å½±å“äº§å“çš„æ—¥å¸¸åŠŸèƒ½è¿­ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¸€è¾¹åšäº§å“åŠŸèƒ½è¿­ä»£ï¼Œä¸€è¾¹å®ŒæˆæœåŠ¡åŒ–æ‹†åˆ†ã€‚æ€»ä¸èƒ½åœæ‰æ‰€æœ‰ä¸šåŠ¡å¼€å‘ï¼Œå…¨ç›˜æ¨ç¿»é‡æ„å®Œå†ä¸Šçº¿å§ï¼Ÿå‚è€ƒå¦‚ä¸‹å‰¥ç¦»é¡ºåºï¼š ä¼˜å…ˆå‰¥ç¦»æ¯”è¾ƒç‹¬ç«‹çš„è¾¹ç•ŒæœåŠ¡ã€‚ä»éæ ¸å¿ƒçš„æœåŠ¡å‡ºå‘ï¼Œå‡å°‘æ‹†åˆ†å¯¹ç°æœ‰ä¸šåŠ¡çš„å½±å“ï¼Œä¹Ÿç»™å›¢é˜Ÿä¸€ä¸ªç»ƒä¹ ã€è¯•é”™çš„æœºä¼šï¼› è¦ç†æ¸…æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œå½“ä¸¤ä¸ªæœåŠ¡å­˜åœ¨ä¾èµ–å…³ç³»æ—¶ï¼Œä¼˜å…ˆæ‹†åˆ†è¢«ä¾èµ–çš„æœåŠ¡ã€‚æ¯”å¦‚ï¼Œå†…å®¹æœåŠ¡ä¼šä¾èµ–ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œäº’åŠ¨æœåŠ¡ä¼šä¾èµ–å†…å®¹æœåŠ¡ï¼Œæ‰€ä»¥è¦æŒ‰ç…§å…ˆç”¨æˆ·æœåŠ¡ï¼Œå†å†…å®¹æœåŠ¡ï¼Œæœ€åäº’åŠ¨æœåŠ¡çš„é¡ºåºæ¥è¿›è¡Œæ‹†åˆ†ã€‚ æœåŠ¡æ¥å£çš„å®šä¹‰è¦å…·å¤‡å¯æ‰©å±•æ€§ã€‚æœåŠ¡æ‹†åˆ†ä¹‹åï¼Œç”±äºæœåŠ¡æ˜¯ä»¥ç‹¬ç«‹è¿›ç¨‹çš„æ–¹å¼éƒ¨ç½²ï¼Œæ‰€ä»¥æœåŠ¡ä¹‹é—´é€šä¿¡ï¼Œå°±ä¸å†æ˜¯è¿›ç¨‹å†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ï¼Œè€Œæ˜¯è·¨è¿›ç¨‹çš„ç½‘ç»œé€šä¿¡äº†ã€‚åœ¨è¿™ç§é€šä¿¡æ¨¡å‹ä¸‹éœ€è¦æ³¨æ„ï¼ŒæœåŠ¡æ¥å£çš„å®šä¹‰è¦å…·å¤‡å¯æ‰©å±•æ€§ï¼Œå¦åˆ™åœ¨æœåŠ¡å˜æ›´æ—¶ï¼Œä¼šé€ æˆæ„æƒ³ä¸åˆ°çš„é”™è¯¯ã€‚æ¯”å¦‚ï¼ŒæŸä¸€ä¸ªå¾®æœåŠ¡çš„æ¥å£æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåœ¨ä¸€æ¬¡ä¸šåŠ¡éœ€æ±‚å¼€å‘ä¸­ï¼Œç»„å†…çš„ä¸€ä¸ªåŒå­¦å°†è¿™ä¸ªæ¥å£çš„å‚æ•°è°ƒæ•´ä¸ºäº†å››ä¸ªï¼Œæ¥å£è¢«è°ƒç”¨çš„åœ°æ–¹ä¹Ÿåšäº†ä¿®æ”¹ï¼Œç»“æœä¸Šçº¿è¿™ä¸ªæœåŠ¡åï¼Œå´ä¸æ–­æŠ¥é”™ï¼Œæ— å¥ˆåªèƒ½å›æ»šã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"è¿œç¨‹è°ƒç”¨ å½“é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ä¹‹åï¼ŒåŸæœ¬çš„ 1 æ¬¡è¯·æ±‚ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨ 4ã€5 æ¬¡æœåŠ¡ï¼Œå¦‚å›¾ã€‚ é‚£å¦‚ä½•é¿å…å…¶å¸¦æ¥çš„æ€§èƒ½æŸè€—å‘¢ï¼Ÿ é€‰æ‹©åˆé€‚çš„ç½‘ç»œæ¨¡å‹ï¼Œæœ‰é’ˆå¯¹æ€§åœ°è°ƒæ•´ç½‘ç»œå‚æ•°ï¼Œä»¥ä¼˜åŒ–ç½‘ç»œä¼ è¾“æ€§èƒ½ï¼› é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼ï¼Œä»¥æå‡å°åŒ…ã€è§£åŒ…çš„æ€§èƒ½ã€‚ å¦‚ä½•æå‡ç½‘ç»œä¼ è¾“æ€§èƒ½ï¼Ÿ æœ‰å¾ˆå¤šæ–¹é¢ï¼š I/O å¤šè·¯å¤ç”¨ï¼› ç¦ç”¨ Nagle ç®—æ³•ã€‚ è¦è®²è®² Nagle ç®—æ³•ï¼š tcp åè®®çš„åŒ…å¤´æœ‰ 20 å­—èŠ‚ï¼Œip åè®®çš„åŒ…å¤´ä¹Ÿæœ‰ 20 å­—èŠ‚ï¼Œå¦‚æœä»…ä»…ä¼ è¾“ 1 å­—èŠ‚çš„æ•°æ®ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å°±æœ‰ 20 + 20 + 1 = 41 å­—èŠ‚ï¼Œå…¶ä¸­çœŸæ­£æœ‰ç”¨çš„æ•°æ®åªæœ‰ 1 ä¸ªå­—èŠ‚ï¼Œè¿™å¯¹æ•ˆç‡å’Œå¸¦å®½æ˜¯æå¤§çš„æµªè´¹ã€‚æ‰€ä»¥åœ¨ 1984 å¹´çš„æ—¶å€™ï¼ŒJohn Nagle æå‡ºäº†ä»¥ä»–çš„åå­—å‘½åçš„ Nagle ç®—æ³•ï¼š å¦‚æœæ˜¯è¿ç»­çš„å°æ•°æ®åŒ…ï¼Œå¤§å°æ²¡æœ‰ä¸€ä¸ª MSSï¼ˆMaximum Segment Sizeï¼Œæœ€å¤§åˆ†æ®µå¤§å°ï¼‰ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æ”¶åˆ°ä¹‹å‰å‘é€çš„æ•°æ®åŒ…çš„ Ack ä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™äº›å°æ•°æ®åŒ…å°±ä¼šåœ¨å‘é€ç«¯æš‚å­˜èµ·æ¥ï¼Œç›´åˆ°å°æ•°æ®åŒ…ç´¯ç§¯åˆ°ä¸€ä¸ª MSSï¼Œæˆ–è€…æ”¶åˆ°ä¸€ä¸ª Ack ä¸ºæ­¢ã€‚ åŸæœ¬æ˜¯ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œä¼ è¾“ï¼Œä½†æ˜¯å¦‚æœæ¥æ”¶ç«¯å¼€å¯äº† DelayedACKï¼ˆå»¶è¿Ÿ ACK çš„å‘é€ï¼Œè¿™æ ·å¯ä»¥åˆå¹¶å¤šä¸ª ACKï¼Œæå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼‰ï¼Œé‚£å°±ä¼šå‘ç”Ÿï¼Œå‘é€ç«¯å‘é€ç¬¬ä¸€ä¸ªæ•°æ®åŒ…åï¼Œæ¥æ”¶ç«¯æ²¡æœ‰è¿”å› ACKï¼Œè¿™æ—¶å‘é€ç«¯å‘é€äº†ç¬¬äºŒä¸ªæ•°æ®åŒ…ï¼Œå› ä¸º Nagle ç®—æ³•çš„å­˜åœ¨ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªå‘é€åŒ…çš„ ACK è¿˜æ²¡æœ‰è¿”å›ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªåŒ…ä¼šæš‚å­˜èµ·æ¥ã€‚è€Œ DelayedACK çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯ 40msï¼Œæ‰€ä»¥ä¸€æ—¦åˆ°äº† 40msï¼Œæ¥æ”¶ç«¯å›ç»™å‘é€ç«¯ ACKï¼Œé‚£ä¹ˆå‘é€ç«¯æ‰ä¼šå‘é€ç¬¬äºŒä¸ªåŒ…ï¼Œè¿™æ ·å°±å¢åŠ äº†å»¶è¿Ÿã€‚ è§£å†³çš„æ–¹å¼éå¸¸ç®€å•ï¼šåªè¦åœ¨ socket ä¸Šå¼€å¯ tcp_nodelay å°±å¥½äº†ï¼Œè¿™ä¸ªå‚æ•°å…³é—­äº† Nagle ç®—æ³•ï¼Œè¿™æ ·å‘é€ç«¯å°±ä¸éœ€è¦ç­‰åˆ°ä¸Šä¸€ä¸ªå‘é€åŒ…çš„ ACK è¿”å›ï¼Œç›´æ¥å‘é€æ–°çš„æ•°æ®åŒ…å°±å¥½äº†ã€‚è¿™å¯¹äºå¼ºç½‘ç»œäº¤äº’çš„åœºæ™¯æ¥è¯´éå¸¸çš„é€‚ç”¨ï¼ŒåŸºæœ¬ä¸Šï¼Œå¦‚æœä½ è¦è‡ªå·±å®ç°ä¸€å¥—ç½‘ç»œæ¡†æ¶ï¼Œtcp_nodelay è¿™ä¸ªå‚æ•°æœ€å¥½æ˜¯è¦å¼€å¯çš„ã€‚ é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹æ³• ä¸€æ¬¡ RPC è°ƒç”¨éœ€è¦ç»å†ä¸¤æ¬¡åºåˆ—åŒ–ã€ä¸¤æ¬¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå› æ­¤éœ€è¦é€‰æ‹©é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹æ³•ã€‚ æ²¡å•¥è¦æ±‚çš„å¯ä»¥ç”¨ JSONï¼Œä¸ç„¶è¿˜å¾—æ˜¯ Protobufã€‚(åŸå› è¯¦è§ Protobuf çš„ md) ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"æœåŠ¡æ³¨å†Œä¸å‘ç° æ³¨å†Œä¸­å¿ƒ æ³¨å†Œä¸­å¿ƒæä¾›çš„åŠŸèƒ½ï¼š å…¶ä¸€æ˜¯æä¾›äº†æœåŠ¡åœ°å€çš„å­˜å‚¨ï¼› å…¶äºŒæ˜¯å½“å­˜å‚¨å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥å°†å˜æ›´çš„å†…å®¹æ¨é€ç»™å®¢æˆ·ç«¯ã€‚ æœ‰äº†æ³¨å†Œä¸­å¿ƒä¹‹åï¼ŒæœåŠ¡èŠ‚ç‚¹çš„å¢åŠ å’Œå‡å°‘å¯¹äºå®¢æˆ·ç«¯å°±æ˜¯é€æ˜çš„ã€‚è¿™æ ·ï¼Œé™¤äº†å¯ä»¥å®ç°ä¸é‡å¯å®¢æˆ·ç«¯ï¼Œå°±èƒ½åŠ¨æ€åœ°å˜æ›´æœåŠ¡èŠ‚ç‚¹ä»¥å¤–ï¼Œè¿˜å¯ä»¥å®ç°ä¼˜é›…å…³é—­çš„åŠŸèƒ½ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯ä¼˜é›…çš„å…³é—­ï¼Ÿæ³¨å†Œä¸­å¿ƒæ€ä¹ˆåšåˆ°ï¼Ÿ ä¼˜é›…å…³é—­æ˜¯å¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ã€‚å› ä¸ºå¦‚æœç›´æ¥æš´åŠ›åœ°åœæ­¢æœåŠ¡ï¼Œé‚£ä¹ˆå·²ç»å‘é€ç»™æœåŠ¡ç«¯çš„è¯·æ±‚ï¼Œæ¥ä¸åŠè¢«å¤„ç†å°±ä¼šè¢«ä¸¢å¼ƒäº†ï¼Œå°±ä¼šé€ æˆè¿™éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼ŒæœåŠ¡å°±ä¼šæœ‰æ³¢åŠ¨ã€‚ æ‰€ä»¥ï¼ŒæœåŠ¡åœ¨é€€å‡ºçš„æ—¶å€™ï¼Œéƒ½éœ€è¦å…ˆåœæ‰æµé‡ï¼Œå†åœæ­¢æœåŠ¡ï¼Œè¿™æ ·æœåŠ¡çš„å…³é—­æ‰ä¼šæ›´å¹³æ»‘ã€‚ å¯¹äº RPC æœåŠ¡æ¥è¯´ï¼Œå¯ä»¥å…ˆå°† RPC æœåŠ¡ä»æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åˆ—è¡¨ä¸­åˆ é™¤æ‰ï¼Œç„¶åè§‚å¯Ÿ RPC æœåŠ¡ç«¯æ²¡æœ‰æœªå¤„ç†çš„è¯·æ±‚ä¹‹åï¼Œå†å°†æœåŠ¡ç«¯åœæ‰ã€‚æœ‰äº†ä¼˜é›…å…³é—­ä¹‹åï¼ŒRPC æœåŠ¡ç«¯å†é‡å¯çš„æ—¶å€™ï¼Œå°±ä¼šå‡å°‘å¯¹å®¢æˆ·ç«¯çš„å½±å“ã€‚ æœåŠ¡çŠ¶æ€ç®¡ç† ä¸€èˆ¬æœ‰ä¸¤ç§è§£å†³æ€è·¯ï¼š ä¸»åŠ¨æ¢æµ‹ï¼› å¿ƒè·³æ¨¡å¼ï¼› ä¸»åŠ¨æ¢æµ‹ æ€è·¯ï¼šRPC æœåŠ¡æ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œç”±æ³¨å†Œä¸­å¿ƒæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚ 30 ç§’ï¼‰æ¢æµ‹è¿™äº›ç«¯å£æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœå¯ç”¨å°±è®¤ä¸ºæœåŠ¡ä»ç„¶æ˜¯æ­£å¸¸çš„ï¼Œå¦åˆ™å°±å¯ä»¥è®¤ä¸ºæœåŠ¡ä¸å¯ç”¨ï¼Œé‚£ä¹ˆæ³¨å†Œä¸­å¿ƒå°±å¯ä»¥æŠŠæœåŠ¡ä»åˆ—è¡¨é‡Œé¢åˆ é™¤äº†ã€‚ ç¼ºé™·ï¼š æ‰€æœ‰çš„ RPC æœåŠ¡ç«¯éƒ½éœ€è¦å¼€æ”¾ä¸€ä¸ªç»Ÿä¸€çš„ç«¯å£ç»™æ³¨å†Œä¸­å¿ƒæ¢æµ‹ï¼Œä½†éœ€è¦å¼€æ”¾çš„ç«¯å£å¾ˆå¯èƒ½å·²ç»è¢«å ç”¨ï¼Œè¿™æ ·ä¼šé€ æˆ RPC æœåŠ¡å¯åŠ¨å¤±è´¥ï¼› å¦‚æœ RPC æœåŠ¡å®ä¾‹æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆæ¯æ¬¡æ¢æµ‹çš„æˆæœ¬ä¹Ÿä¼šæ¯”è¾ƒé«˜ï¼Œæ¢æµ‹çš„æ—¶é—´ä¹Ÿæ¯”è¾ƒé•¿ï¼Œè¿™æ ·å½“ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œå¯èƒ½ä¼šæœ‰ä¸€æ®µæ—¶é—´çš„å»¶è¿Ÿï¼Œæ‰ä¼šè¢«æ³¨å†Œä¸­å¿ƒæ¢æµ‹åˆ°ã€‚ å› æ­¤ï¼Œæ”¹è¿›æˆäº†å¿ƒè·³æ¨¡å¼ã€‚ å¿ƒè·³æ¨¡å¼ å¤§éƒ¨åˆ†æ³¨å†Œä¸­å¿ƒéƒ½é‡‡ç”¨å¿ƒè·³æ¨¡å¼æ£€æµ‹ RPC æœåŠ¡æ˜¯å¦å­˜æ´»ã€‚ æ€è·¯ï¼š é¦–å…ˆï¼Œæ³¨å†Œä¸­å¿ƒä¸ºæ¯ä¸€ä¸ªè¿æ¥ä¸Šæ¥çš„ RPC æœåŠ¡èŠ‚ç‚¹ï¼Œè®°å½•æœ€è¿‘ç»­çº¦çš„æ—¶é—´ï¼› åŒæ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ£€æµ‹ RPC æœåŠ¡èŠ‚ç‚¹çš„ç§Ÿçº¦æ˜¯å¦åˆ°æœŸï¼Œç§Ÿçº¦åˆ°æœŸå°±è®¤ä¸ºè¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸å¯ç”¨ RPC æœåŠ¡èŠ‚ç‚¹å¯ä»¥æŒ‰ç…§ä¸€å®šçš„æ—¶é—´é—´éš”(æ¯”å¦‚ 30 ç§’)ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘é€å¿ƒè·³åŒ…ç»­çº¦ï¼› æ³¨å†Œä¸­å¿ƒæ”¶åˆ°å¿ƒè·³åŒ…ä¹‹åï¼Œä¼šæ›´æ–°è¿™ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘ç»­çº¦æ—¶é—´ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:3","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"åˆ†å¸ƒå¼ Trace æ…¢è¯·æ±‚é—®é¢˜å¦‚ä½•æ’æŸ¥ï¼Ÿ å•ä½“æ¶æ„ä¸­çš„æ…¢è¯·æ±‚æ’æŸ¥ ä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹åŒæ—¶è¯·æ±‚é€ æˆçš„æ—¥å¿—æ··ä¹±ï¼Œå¯ä»¥åœ¨è®°å½•æ‰“ç‚¹æ—¥å¿—æ—¶ï¼Œä½¿ç”¨ requestId å°†æ—¥å¿—ä¸²èµ·æ¥ï¼Œè¿™æ ·æ–¹ä¾¿æ¯”è¾ƒä¸€æ¬¡è¯·æ±‚ä¸­çš„å¤šä¸ªæ­¥éª¤çš„è€—æ—¶æƒ…å†µï¼› ä½¿ç”¨é™æ€ä»£ç†çš„æ–¹å¼åšåˆ‡é¢ç¼–ç¨‹ï¼Œé¿å…åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼ŒåŠ å…¥å¤§é‡æ‰“å°è€—æ—¶çš„æ—¥å¿—çš„ä»£ç ï¼Œå‡å°‘äº†å¯¹äºä»£ç çš„ä¾µå…¥æ€§ï¼ŒåŒæ—¶ç¼–è¯‘æœŸçš„ä»£ç æ³¨å…¥å¯ä»¥å‡å°‘ï¼› å¢åŠ æ—¥å¿—é‡‡æ ·ç‡ï¼Œé¿å…å…¨é‡æ—¥å¿—çš„æ‰“å°ï¼› ä¸ºäº†é¿å…åœ¨æ’æŸ¥é—®é¢˜æ—¶ï¼Œéœ€è¦åˆ°å¤šå°æœåŠ¡å™¨ä¸Šæœç´¢æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†æ—¥å¿—é›†ä¸­èµ·æ¥æ”¾åœ¨äº† Elasticsearch ä¸­ã€‚ åˆ†å¸ƒå¼ Trace åœ¨å•ä½“æ¶æ„ä¸­ï¼Œå•æ¬¡è¯·æ±‚çš„æ‰€æœ‰çš„è€—æ—¶æ—¥å¿—ï¼Œéƒ½è¢«è®°å½•åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼›è€Œåœ¨å¾®æœåŠ¡çš„åœºæ™¯ä¸‹ï¼Œå•æ¬¡è¯·æ±‚å¯èƒ½è·¨è¶Šå¤šä¸ª RPC æœåŠ¡ï¼Œè¿™å°±é€ æˆäº†ï¼Œå•æ¬¡çš„è¯·æ±‚çš„æ—¥å¿—ä¼šåˆ†å¸ƒåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šã€‚ å¯ä»¥é‡‡ç”¨ traceId + spanId è¿™ä¸¤ä¸ªæ•°æ®ç»´åº¦æ¥è®°å½•æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼ˆè¿™é‡Œ traceId å°±æ˜¯ requestIdï¼‰ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ traceId ä¸²èµ·å•æ¬¡è¯·æ±‚ï¼Œç”¨ spanId è®°å½•æ¯ä¸€æ¬¡ RPC è°ƒç”¨ã€‚ æ¯”å¦‚ï¼Œè¯·æ±‚ä»ç”¨æˆ·ç«¯è¿‡æ¥ï¼Œå…ˆåˆ°è¾¾ A æœåŠ¡ï¼ŒA æœåŠ¡ä¼šåˆ†åˆ«è°ƒç”¨ B å’Œ C æœåŠ¡ï¼ŒB æœåŠ¡åˆä¼šè°ƒç”¨ D å’Œ E æœåŠ¡ã€‚ é‚£ä¹ˆ spanId æ˜¯ä½•æ—¶ç”Ÿæˆçš„ï¼Œåˆæ˜¯å¦‚ä½•ä¼ é€’çš„å‘¢ï¼Ÿ é¦–å…ˆï¼ŒA æœåŠ¡åœ¨å‘èµ· RPC è¯·æ±‚æœåŠ¡ B å‰ï¼Œå…ˆä»çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è·å–å½“å‰çš„ traceId å’Œ spanIdï¼Œç„¶åï¼Œä¾æ®ä¸Šé¢çš„é€»è¾‘ç”Ÿæˆæœ¬æ¬¡ RPC è°ƒç”¨çš„ spanIdï¼Œå†å°† spanId å’Œ traceId åºåˆ—åŒ–åï¼Œè£…é…åˆ°è¯·æ±‚ä½“ä¸­ï¼Œå‘é€ç»™æœåŠ¡æ–¹ Bã€‚ æœåŠ¡æ–¹ B è·å–è¯·æ±‚åï¼Œä»è¯·æ±‚ä½“ä¸­ååºåˆ—åŒ–å‡º spanId å’Œ traceIdï¼ŒåŒæ—¶è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œä»¥ä¾¿ç»™ä¸‹æ¬¡ RPC è°ƒç”¨ä½¿ç”¨ã€‚åœ¨æœåŠ¡ B è°ƒç”¨å®Œæˆè¿”å›å“åº”å‰ï¼Œè®¡ç®—å‡ºæœåŠ¡ B çš„æ‰§è¡Œæ—¶é—´å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—ã€‚ å½“ç„¶ï¼Œåœ¨æœåŠ¡ B ä¸­ï¼Œä½ ä¾ç„¶å¯ä»¥ä½¿ç”¨åˆ‡é¢ç¼–ç¨‹çš„æ–¹å¼ï¼Œå¾—åˆ°æ‰€æœ‰è°ƒç”¨çš„æ•°æ®åº“ã€ç¼“å­˜ã€HTTP æœåŠ¡çš„å“åº”æ—¶é—´ï¼Œåªæ˜¯åœ¨å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—çš„æ—¶å€™ï¼Œè¦åŠ ä¸Šå½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ spanId å’Œ traceIdã€‚ è¿™æ ·ï¼Œæ— è®ºæ˜¯æ•°æ®åº“ç­‰èµ„æºçš„å“åº”æ—¶é—´ï¼Œè¿˜æ˜¯ RPC æœåŠ¡çš„å“åº”æ—¶é—´å°±éƒ½æ±‡æ€»åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œåœ¨ç»è¿‡ä¸€äº›å¤„ç†ä¹‹åï¼Œæœ€ç»ˆè¢«å†™å…¥åˆ° Elasticsearch ä¸­ä»¥ä¾¿ç»™å¼€å‘å’Œè¿ç»´åŒå­¦æŸ¥è¯¢ä½¿ç”¨ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:4","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"è´Ÿè½½å‡è¡¡ è´Ÿè½½å‡è¡¡æœåŠ¡å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šä¸€ç±»æ˜¯ä»£ç†ç±»çš„è´Ÿè½½å‡è¡¡æœåŠ¡ï¼›å¦ä¸€ç±»æ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æœåŠ¡ã€‚ ä»£ç†ç±»è´Ÿè½½å‡è¡¡æœåŠ¡å…¸å‹çš„å°±æ˜¯ NGINX å’Œ LVSï¼Œé€‚ç”¨äºæ™®é€šçš„ Web æœåŠ¡ã€‚ä½†å¯¹äºå¾®æœåŠ¡æ¶æ„æ¥è¯´ï¼Œæ˜¯ä¸åˆé€‚çš„ã€‚å› ä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡èŠ‚ç‚¹å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒé‡Œï¼Œä½¿ç”¨ LVS å°±å¾ˆéš¾å’Œæ³¨å†Œä¸­å¿ƒäº¤äº’ï¼Œè·å–å…¨é‡çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ã€‚å¦å¤–ï¼Œä¸€èˆ¬å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ RPC åè®®è€Œä¸æ˜¯ HTTP åè®®ï¼Œæ‰€ä»¥ Nginx ä¹Ÿä¸èƒ½æ»¡è¶³è¦æ±‚ã€‚ åœ¨ RPC ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨å¦ä¸€ç±»çš„è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æŠŠè´Ÿè½½å‡è¡¡çš„æœåŠ¡å†…åµŒåœ¨ RPC å®¢æˆ·ç«¯ä¸­ã€‚ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œä¸€èˆ¬å’Œå®¢æˆ·ç«¯åº”ç”¨éƒ¨ç½²åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæä¾›å¤šç§é€‰æ‹©èŠ‚ç‚¹çš„ç­–ç•¥ï¼Œæœ€ç»ˆä¸ºå®¢æˆ·ç«¯åº”ç”¨æä¾›ä¸€ä¸ªæœ€ä½³çš„ï¼Œå¯ç”¨çš„æœåŠ¡ç«¯èŠ‚ç‚¹ã€‚æ€æƒ³ï¼šè¿™ç±»æœåŠ¡ä¸€èˆ¬ä¼šç»“åˆæ³¨å†Œä¸­å¿ƒæ¥ä½¿ç”¨ï¼Œæ³¨å†Œä¸­å¿ƒæä¾›æœåŠ¡èŠ‚ç‚¹çš„å®Œæ•´åˆ—è¡¨ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°åˆ—è¡¨ä¹‹åä½¿ç”¨è´Ÿè½½å‡è¡¡æœåŠ¡çš„ç­–ç•¥é€‰å–ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œç„¶åå°†è¯·æ±‚å‘åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚ è´Ÿè½½å‡è¡¡ç­–ç•¥ è´Ÿè½½å‡è¡¡ç­–ç•¥ä»å¤§ä½“ä¸Šæ¥çœ‹å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š ä¸€ç±»æ˜¯é™æ€ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åœ¨é€‰æ‹©æœåŠ¡èŠ‚ç‚¹æ—¶ï¼Œä¸ä¼šå‚è€ƒåç«¯æœåŠ¡çš„å®é™…è¿è¡Œçš„çŠ¶æ€ã€‚ ä¸€ç±»æ˜¯åŠ¨æ€ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ä¼šä¾æ®åç«¯æœåŠ¡çš„ä¸€äº›è´Ÿè½½ç‰¹æ€§ï¼Œæ¥å†³å®šè¦é€‰æ‹©å“ªä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ã€‚ é™æ€ç­–ç•¥ è½®è¯¢(RoundRobinï¼ŒRR)ï¼šæŒ‰ç…§æœåŠ¡åˆ—è¡¨çš„é¡ºåºï¼Œé€ä¸ªè¯·æ±‚åç«¯æœåŠ¡èŠ‚ç‚¹ï¼› å¸¦æƒè½®è¯¢ï¼šç»™èŠ‚ç‚¹åŠ ä¸Šæƒé‡å€¼ï¼Œæ¯”å¦‚ç»™ 8 æ ¸ 8G çš„æœºå™¨é…ç½®æƒé‡ä¸º 2ï¼Œé‚£ä¹ˆå°±ä¼šç»™å®ƒåˆ†é…åŒå€çš„æµé‡ï¼› ä¸€è‡´æ€§ Hashã€‚ è½®è¯¢å’Œå¸¦æœ‰æƒé‡çš„è½®è¯¢ç­–ç•¥ï¼Œèƒ½å¤Ÿå°†è¯·æ±‚å°½é‡å¹³å‡åœ°åˆ†é…åˆ°åç«¯æœåŠ¡èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå°±èƒ½å¤Ÿåšåˆ°å¯¹äºè´Ÿè½½çš„å‡è¡¡åˆ†é…ï¼Œåœ¨æ²¡æœ‰æ›´å¥½çš„åŠ¨æ€ç­–ç•¥ä¹‹å‰ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨è¿™ä¸¤ç§ç­–ç•¥ï¼Œæ¯”å¦‚ Nginx å°±ä¼šä¼˜å…ˆä½¿ç”¨è½®è¯¢çš„ç­–ç•¥ã€‚ åŠ¨æ€ç­–ç•¥ åŸç†ï¼šè´Ÿè½½å‡è¡¡æœåŠ¡å™¨ä¼šæ”¶é›†å¯¹åç«¯æœåŠ¡èŠ‚ç‚¹çš„è°ƒç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚ä»è´Ÿè½½å‡è¡¡å™¨åˆ°æœåŠ¡èŠ‚ç‚¹çš„æ´»è·ƒè¿æ¥æ•°ï¼Œæˆ–è€…æ˜¯è¯·æ±‚è°ƒç”¨çš„å“åº”æ—¶é—´ï¼Œç„¶åä»ä¸­é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡èŠ‚ç‚¹ï¼Œæˆ–è€…å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡èŠ‚ç‚¹ã€‚ åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨åŠ¨æ€çš„ç­–ç•¥ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:5","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"API ç½‘å…³ API ç½‘å…³æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå®ƒæ˜¯å°†ä¸€äº›æœåŠ¡å…±æœ‰çš„åŠŸèƒ½æ•´åˆåœ¨ä¸€èµ·ï¼Œç‹¬ç«‹éƒ¨ç½²ä¸ºå•ç‹¬çš„ä¸€å±‚ï¼Œç”¨æ¥è§£å†³ä¸€äº›æœåŠ¡æ²»ç†çš„é—®é¢˜ã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œç³»ç»Ÿçš„è¾¹ç•Œï¼Œå®ƒå¯ä»¥å¯¹å‡ºå…¥ç³»ç»Ÿçš„æµé‡åšç»Ÿä¸€çš„ç®¡æ§ã€‚ ç½‘å…³åˆ†ç±» API ç½‘å…³å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»å«åšå…¥å£ç½‘å…³ï¼Œä¸€ç±»å«åšå‡ºå£ç½‘å…³ã€‚ å…¥å£ç½‘å…³â­ å…¥å£ç½‘å…³éƒ¨ç½²åœ¨è´Ÿè½½å‡è¡¡æœåŠ¡å™¨å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä½œç”¨ï¼š æä¾›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªç»Ÿä¸€çš„è¯·æ±‚æ¥å…¥åœ°å€ï¼ŒAPI ç½‘å…³å¯ä»¥å°†ç”¨æˆ·çš„è¯·æ±‚åŠ¨æ€è·¯ç”±åˆ°ä¸åŒçš„ä¸šåŠ¡æœåŠ¡ä¸Šï¼Œå¹¶ä¸”åšä¸€äº›å¿…è¦çš„åè®®è½¬æ¢å·¥ä½œã€‚æ¯”å¦‚ï¼Œéƒ¨ç½²çš„å¾®æœåŠ¡å¯¹å¤–æš´éœ²çš„åè®®å¯èƒ½ä¸åŒï¼Œæœ‰äº›è¿˜æä¾›çš„æ˜¯ HTTP æœåŠ¡ï¼›æœ‰äº›å·²ç»å®Œæˆ RPC æ”¹é€ ï¼Œå¯¹å¤–æš´éœ² RPC æœåŠ¡ã€‚API ç½‘å…³å¯ä»¥å¯¹å®¢æˆ·ç«¯å±è”½è¿™äº›æœåŠ¡çš„éƒ¨ç½²åœ°å€ï¼Œä»¥åŠåè®®çš„ç»†èŠ‚ï¼Œç»™å®¢æˆ·ç«¯çš„è°ƒç”¨å¸¦æ¥å¾ˆå¤§çš„ä¾¿æ·ã€‚ æ¤å…¥ä¸€äº›æœåŠ¡æ²»ç†çš„ç­–ç•¥ï¼Œæ¯”å¦‚æœåŠ¡çš„ç†”æ–­ã€é™çº§ï¼Œæµé‡æ§åˆ¶å’Œåˆ†æµç­‰ï¼› API ç½‘å…³å¯ä»¥åµŒå…¥ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ç”¨æˆ·è®¤è¯å’Œæˆæƒçš„å®ç°ç­‰ï¼› API ç½‘å…³å¯ä»¥ç»™è¯·æ±‚åˆ†é… Request IDï¼Œè¾…åŠ©è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œç”¨äºä¹‹å‰è®²çš„åˆ†å¸ƒå¼ Traceã€‚ å‡ºå£ç½‘å…³ ä¸æ˜¯é‡ç‚¹ã€‚ åœ¨ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¼šä¾èµ–å¾ˆå¤šå¤–éƒ¨çš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œå‡ºå£ç½‘å…³å°±æ˜¯è´Ÿè´£è°ƒç”¨è¿™äº›å¤–éƒ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„ã€‚æ¯”å¦‚å…¸å‹çš„ä¾‹å­ï¼šç¬¬ä¸‰æ–¹è´¦æˆ·ç™»å½•ã€ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ”¯ä»˜ç­‰ç­‰ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨æœåŠ¡å™¨å’Œç¬¬ä¸‰æ–¹ç³»ç»Ÿä¹‹é—´ï¼Œéƒ¨ç½²å‡ºå£ç½‘å…³ï¼Œåœ¨å‡ºå£ç½‘å…³ä¸­ï¼Œå¯¹è°ƒç”¨å¤–éƒ¨çš„ API åšç»Ÿä¸€çš„è®¤è¯ã€æˆæƒï¼Œå®¡è®¡ä»¥åŠè®¿é—®æ§åˆ¶ã€‚ å¦‚ä½•å®ç° // TODOï¼šçº¿ç¨‹æ±  å¯ä»¥é’ˆå¯¹ä¸åŒçš„æœåŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œåœ¨çº¿ç¨‹æ± å†…éƒ¨é’ˆå¯¹ä¸åŒçš„æ¥å£è®¾ç½®é…é¢ Tyk æ˜¯ä¸€ç§ Go è¯­è¨€å®ç°çš„è½»é‡çº§ API ç½‘å…³ï¼Œæœ‰ç€ä¸°å¯Œçš„æ’ä»¶èµ„æºï¼Œå¯¹äº Go è¯­è¨€æ ˆçš„å›¢é˜Ÿæ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚ å¼•å…¥ç½‘å…³ åœ¨æœåŠ¡å±‚å’Œå®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹ä¸€å±‚è–„è–„çš„ Web å±‚ï¼Œä¸»è¦åšä¸¤ä»¶äº‹ï¼š èšåˆæœåŠ¡å±‚æ¥å£æ•°æ®ã€‚æ¯”å¦‚ï¼Œå•†å“è¯¦æƒ…é¡µçš„æ¥å£ï¼Œå¯èƒ½ä¼šèšåˆæœåŠ¡å±‚ä¸­ï¼Œè·å–å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ã€åº—é“ºä¿¡æ¯ä»¥åŠç”¨æˆ·è¯„è®ºç­‰å¤šä¸ªæœåŠ¡æ¥å£çš„æ•°æ®ï¼› è´Ÿè´£åè®®è½¬æ¢ã€é™æµã€é»‘ç™½åå•ç­‰ã€‚æ¯”å¦‚å°† HTTP è¯·æ±‚è½¬æ¢ä¸º RPC è¯·æ±‚ï¼Œå¹¶ä¸”å¯¹å‰ç«¯çš„æµé‡åšä¸€äº›é™åˆ¶ï¼Œå¯¹äºæŸäº›è¯·æ±‚æ·»åŠ è®¾å¤‡ ID çš„é»‘åå•ç­‰ç­‰ã€‚ èšåˆæœåŠ¡æ¥å£æ•°æ®ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§è§£å†³æ€è·¯ï¼š ç‹¬ç«‹å‡ºä¸€ç»„ç½‘å…³ä¸“é—¨åšæœåŠ¡èšåˆã€è¶…æ—¶æ§åˆ¶æ–¹é¢çš„äº‹æƒ…ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠå‰ä¸€ç§ç½‘å…³å«åšæµé‡ç½‘å…³ï¼Œåä¸€ç§å¯ä»¥å«åšä¸šåŠ¡ç½‘å…³ï¼› æŠ½å–ç‹¬ç«‹çš„æœåŠ¡å±‚ï¼Œä¸“é—¨åšæ¥å£èšåˆçš„æ“ä½œã€‚è¿™æ ·æœåŠ¡å±‚å°±å¤§æ¦‚åˆ†ä¸ºåŸå­æœåŠ¡å±‚å’ŒèšåˆæœåŠ¡å±‚ã€‚ æ¥å£æ•°æ®èšåˆæ˜¯ä¸šåŠ¡æ“ä½œï¼Œä¸å…¶æ”¾åœ¨é€šç”¨çš„ç½‘å…³å±‚æ¥å®ç°ï¼Œä¸å¦‚æ”¾åœ¨æ›´è´´è¿‘ä¸šåŠ¡çš„æœåŠ¡å±‚æ¥å®ç°ï¼Œæ‰€ä»¥ï¼Œæˆ‘æ›´å€¾å‘äºç¬¬äºŒç§æ–¹æ¡ˆã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:6","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"è·¨åœ°åŸŸåˆ†å¸ƒå¼ç³»ç»Ÿ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:5:7","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"å…­ã€ç»´æŠ¤ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:6:0","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é™çº§ç†”æ–­ é›ªå´©æ˜¯å¦‚ä½•å‘ç”Ÿçš„ é›ªå´©ï¼šå±€éƒ¨æ•…éšœæœ€ç»ˆå¯¼è‡´å…¨å±€æ•…éšœã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šå‘ç”Ÿé›ªå´©å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œç³»ç»Ÿåœ¨è¿è¡Œçš„æ—¶å€™æ˜¯éœ€è¦æ¶ˆè€—ä¸€äº›èµ„æºçš„ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ç­‰ç³»ç»Ÿèµ„æºï¼Œä¹ŸåŒ…æ‹¬æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„æ—¶å€™ï¼Œéœ€è¦çš„çº¿ç¨‹èµ„æºã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œä¸€èˆ¬åœ¨ä¸šåŠ¡æ‰§è¡Œçš„å®¹å™¨å†…ï¼Œéƒ½ä¼šå®šä¹‰ä¸€äº›çº¿ç¨‹æ± æ¥åˆ†é…æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨ Tomcat è¿™ç§ Web å®¹å™¨çš„å†…éƒ¨ï¼Œå®šä¹‰äº†çº¿ç¨‹æ± æ¥å¤„ç† HTTP è¯·æ±‚ï¼›RPC æ¡†æ¶ä¹Ÿç»™ RPC æœåŠ¡ç«¯åˆå§‹åŒ–äº†çº¿ç¨‹æ± æ¥å¤„ç† RPC è¯·æ±‚ã€‚ è¿™äº›çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹èµ„æºæ˜¯æœ‰é™çš„ï¼Œå¦‚æœè¿™äº›çº¿ç¨‹èµ„æºè¢«è€—å°½ï¼Œé‚£ä¹ˆæœåŠ¡è‡ªç„¶ä¹Ÿå°±æ— æ³•å¤„ç†æ–°çš„è¯·æ±‚ï¼ŒæœåŠ¡æä¾›æ–¹ä¹Ÿå°±å®•æœºäº†ã€‚æ¯”å¦‚ï¼Œä½ çš„å‚ç›´ç”µå•†ç³»ç»Ÿæœ‰å››ä¸ªæœåŠ¡ Aã€Bã€Cã€Dï¼ŒA è°ƒç”¨ Bï¼ŒB è°ƒç”¨ C å’Œ Dã€‚å…¶ä¸­ï¼ŒAã€Bã€D æœåŠ¡æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼ˆåƒæ˜¯ç”µå•†ç³»ç»Ÿä¸­çš„è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ç­‰ç­‰ï¼‰ï¼ŒC æ˜¯éæ ¸å¿ƒæœåŠ¡ï¼ˆåƒååƒåœ¾æœåŠ¡ã€å®¡æ ¸æœåŠ¡ï¼‰ã€‚ æ‰€ä»¥ï¼Œä¸€æ—¦ä½œä¸ºå…¥å£çš„ A æµé‡å¢åŠ ï¼Œä½ å¯èƒ½ä¼šè€ƒè™‘æŠŠ Aã€B å’Œ D æœåŠ¡æ‰©å®¹ï¼Œå¿½ç•¥ Cã€‚é‚£ä¹ˆ C å°±æœ‰å¯èƒ½å› ä¸ºæ— æ³•æ‰¿æ‹…è¿™ä¹ˆå¤§çš„æµé‡ï¼Œå¯¼è‡´è¯·æ±‚å¤„ç†ç¼“æ…¢ï¼Œè¿›ä¸€æ­¥ä¼šè®© B åœ¨è°ƒç”¨ C çš„æ—¶å€™ï¼ŒB ä¸­çš„è¯·æ±‚è¢«é˜»å¡ï¼Œç­‰å¾… C è¿”å›å“åº”ç»“æœã€‚è¿™æ ·ä¸€æ¥ï¼ŒB æœåŠ¡ä¸­è¢«å ç”¨çš„çº¿ç¨‹èµ„æºå°±ä¸èƒ½é‡Šæ”¾ã€‚ ä¹…è€Œä¹…ä¹‹ï¼ŒB å°±ä¼šå› ä¸ºçº¿ç¨‹èµ„æºè¢«å æ»¡ï¼Œæ— æ³•å¤„ç†åç»­çš„è¯·æ±‚ã€‚é‚£ä¹ˆä» A å‘å¾€ B çš„è¯·æ±‚ï¼Œå°±ä¼šè¢«æ”¾å…¥ B æœåŠ¡çº¿ç¨‹æ± çš„é˜Ÿåˆ—ä¸­ï¼Œç„¶å A è°ƒç”¨ B å“åº”æ—¶é—´å˜é•¿ï¼Œè¿›è€Œæ‹–å® A æœåŠ¡ã€‚ä½ çœ‹ï¼Œä»…ä»…å› ä¸ºéæ ¸å¿ƒæœåŠ¡ C çš„å“åº”æ—¶é—´å˜é•¿ï¼Œå°±å¯ä»¥å¯¼è‡´æ•´ä½“æœåŠ¡å®•æœºï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸é‡åˆ°çš„ä¸€ç§æœåŠ¡é›ªå´©æƒ…å†µã€‚ é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•é¿å…å‡ºç°ä¸Šé¢è¿™ç§æƒ…å†µå‘¢ï¼Ÿä»åˆšåˆšçš„ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºæœåŠ¡è°ƒç”¨æ–¹ç­‰å¾…æœåŠ¡æä¾›æ–¹çš„å“åº”æ—¶é—´è¿‡é•¿ï¼Œå®ƒçš„èµ„æºè¢«è€—å°½ï¼Œæ‰å¼•å‘äº†çº§è”ååº”ï¼Œå‘ç”Ÿé›ªå´©ã€‚ æ‰€ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç³»ç»Ÿæœ€æ€•çš„åè€Œä¸æ˜¯æŸä¸€ä¸ªæœåŠ¡æˆ–è€…ç»„ä»¶å®•æœºï¼Œè€Œæ˜¯æœ€æ€•å®ƒå“åº”ç¼“æ…¢ï¼Œå› ä¸ºï¼ŒæŸä¸€ä¸ªæœåŠ¡æˆ–è€…ç»„ä»¶å®•æœºä¹Ÿè®¸åªä¼šå½±å“ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†å®ƒå“åº”ä¸€æ…¢ï¼Œå°±ä¼šå‡ºç°é›ªå´©æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚ è§£å†³çš„æ€è·¯å°±æ˜¯åœ¨æ£€æµ‹åˆ°æŸä¸€ä¸ªæœåŠ¡çš„å“åº”æ—¶é—´å‡ºç°å¼‚å¸¸æ—¶ï¼Œåˆ‡æ–­è°ƒç”¨å®ƒçš„æœåŠ¡ä¸å®ƒä¹‹é—´çš„è”ç³»ï¼Œè®©æœåŠ¡çš„è°ƒç”¨å¿«é€Ÿè¿”å›å¤±è´¥ï¼Œä»è€Œé‡Šæ”¾è¿™æ¬¡è¯·æ±‚æŒæœ‰çš„èµ„æºã€‚è¿™ä¸ªæ€è·¯ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„é™çº§å’Œç†”æ–­æœºåˆ¶ã€‚ ç†”æ–­æœºåˆ¶ æœåŠ¡æ²»ç†ä¸­çš„ç†”æ–­æœºåˆ¶æŒ‡çš„æ˜¯åœ¨å‘èµ·æœåŠ¡è°ƒç”¨æ—¶ï¼Œå¦‚æœè¿”å›é”™è¯¯æˆ–è€…è¶…æ—¶çš„æ¬¡æ•°è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œåˆ™åç»­çš„è¯·æ±‚ä¸å†å‘å‘è¿œç¨‹æœåŠ¡è€Œæ˜¯æš‚æ—¶è¿”å›é”™è¯¯ã€‚ æœåŠ¡è°ƒç”¨æ–¹ä¸ºæ¯ä¸€ä¸ªè°ƒç”¨çš„æœåŠ¡ç»´æŠ¤ä¸€ä¸ªæœ‰é™çŠ¶æ€æœºï¼Œåœ¨è¿™ä¸ªçŠ¶æ€æœºä¸­ä¼šæœ‰ä¸‰ç§çŠ¶æ€ï¼šå…³é—­ï¼ˆè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼‰ã€åŠæ‰“å¼€ï¼ˆå°è¯•è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼‰å’Œæ‰“å¼€ï¼ˆç›´æ¥è¿”å›é”™è¯¯ï¼‰ï¼š å½“è°ƒç”¨å¤±è´¥çš„æ¬¡æ•°ç´¯ç§¯åˆ°ä¸€å®šçš„é˜ˆå€¼æ—¶ï¼Œç†”æ–­çŠ¶æ€ä»å…³é—­æ€åˆ‡æ¢åˆ°æ‰“å¼€æ€ã€‚ä¸€èˆ¬åœ¨å®ç°æ—¶ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸä¸€æ¬¡ï¼Œå°±ä¼šé‡ç½®è°ƒç”¨å¤±è´¥æ¬¡æ•°ã€‚ å½“ç†”æ–­å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬ä¼šå¯åŠ¨ä¸€ä¸ªè¶…æ—¶è®¡æ—¶å™¨ï¼Œå½“è®¡æ—¶å™¨è¶…æ—¶åï¼ŒçŠ¶æ€åˆ‡æ¢åˆ°åŠæ‰“å¼€æ€ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæœŸåœ°æ¢æµ‹æœåŠ¡æ˜¯å¦æ¢å¤ã€‚ åœ¨ç†”æ–­å¤„äºåŠæ‰“å¼€çŠ¶æ€æ—¶ï¼Œè¯·æ±‚å¯ä»¥è¾¾åˆ°åç«¯æœåŠ¡ï¼Œå¦‚æœç´¯è®¡ä¸€å®šçš„æˆåŠŸæ¬¡æ•°åï¼ŒçŠ¶æ€åˆ‡æ¢åˆ°å…³é—­æ€ï¼›å¦‚æœå‡ºç°è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼Œåˆ™åˆ‡æ¢åˆ°æ‰“å¼€æ€ã€‚ é™çº§æœºåˆ¶ ç›¸æ¯”ç†”æ–­æ¥è¯´ï¼Œé™çº§æ˜¯ä¸€ä¸ªæ›´å¤§çš„æ¦‚å¿µã€‚å› ä¸ºå®ƒæ˜¯ç«™åœ¨æ•´ä½“ç³»ç»Ÿè´Ÿè½½çš„è§’åº¦ä¸Šï¼Œæ”¾å¼ƒéƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æˆ–è€…æœåŠ¡ï¼Œä¿è¯æ•´ä½“çš„å¯ç”¨æ€§çš„æ–¹æ³•ï¼Œæ˜¯ä¸€ç§æœ‰æŸçš„ç³»ç»Ÿå®¹é”™æ–¹å¼ã€‚è¿™æ ·çœ‹æ¥ï¼Œç†”æ–­ä¹Ÿæ˜¯é™çº§çš„ä¸€ç§ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰é™æµé™çº§ã€å¼€å…³é™çº§ç­‰ã€‚ æ­¤å¤„å…ˆä»‹ç»å¼€å…³é™çº§ï¼Œé™æµé™çº§å•ç‹¬è®²ã€‚ å¼€å…³é™çº§æŒ‡çš„æ˜¯åœ¨ä»£ç ä¸­é¢„å…ˆåŸ‹è®¾ä¸€äº›å¼€å…³ï¼Œç”¨æ¥æ§åˆ¶æœåŠ¡è°ƒç”¨çš„è¿”å›å€¼ã€‚æ¯”æ–¹è¯´ï¼Œå¼€å…³å…³é—­çš„æ—¶å€™æ­£å¸¸è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œå¼€å…³æ‰“å¼€æ—¶åˆ™æ‰§è¡Œé™çº§çš„ç­–ç•¥ã€‚è¿™äº›å¼€å…³çš„å€¼å¯ä»¥å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒä¸­ï¼Œå½“ç³»ç»Ÿå‡ºç°é—®é¢˜éœ€è¦é™çº§æ—¶ï¼Œåªéœ€è¦é€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€æ›´æ”¹å¼€å…³çš„å€¼ï¼Œå°±å¯ä»¥å®ç°ä¸é‡å¯æœåŠ¡å¿«é€Ÿåœ°é™çº§è¿œç¨‹æœåŠ¡äº†ã€‚ åœ¨è®¾è®¡å¼€å…³é™çº§é¢„æ¡ˆçš„æ—¶å€™ï¼Œé¦–å…ˆè¦åŒºåˆ†å“ªäº›æ˜¯æ ¸å¿ƒæœåŠ¡ï¼Œå“ªäº›æ˜¯éæ ¸å¿ƒæœåŠ¡ã€‚å› ä¸ºæˆ‘ä»¬åªèƒ½é’ˆå¯¹éæ ¸å¿ƒæœåŠ¡æ¥åšé™çº§å¤„ç†ï¼Œç„¶åå°±å¯ä»¥é’ˆå¯¹å…·ä½“çš„ä¸šåŠ¡ï¼Œåˆ¶å®šä¸åŒçš„é™çº§ç­–ç•¥äº†ã€‚åˆ—ä¸¾ä¸€äº›å¸¸è§åœºæ™¯ä¸‹çš„é™çº§ç­–ç•¥ï¼š é’ˆå¯¹è¯»å–æ•°æ®çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨çš„ç­–ç•¥æ˜¯ç›´æ¥è¿”å›é™çº§æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœæ•°æ®åº“çš„å‹åŠ›æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬åœ¨é™çº§çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘åªè¯»å–ç¼“å­˜çš„æ•°æ®ï¼Œè€Œä¸å†è¯»å–æ•°æ®åº“ä¸­çš„æ•°æ®ï¼›å¦‚æœéæ ¸å¿ƒæ¥å£å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥è¿”å›æœåŠ¡ç¹å¿™æˆ–è€…è¿”å›å›ºå®šçš„é™çº§æ•°æ®ã€‚ å¯¹äºä¸€äº›è½®è¯¢æŸ¥è¯¢æ•°æ®çš„åœºæ™¯ï¼Œæ¯”å¦‚æ¯éš” 30 ç§’è½®è¯¢è·å–æœªè¯»æ•°ï¼Œå¯ä»¥é™ä½è·å–æ•°æ®çš„é¢‘ç‡ï¼ˆå°†è·å–é¢‘ç‡ä¸‹é™åˆ° 10 åˆ†é’Ÿä¸€æ¬¡ï¼‰ã€‚ è€Œå¯¹äºå†™æ•°æ®çš„åœºæ™¯ï¼Œä¸€èˆ¬ä¼šè€ƒè™‘æŠŠåŒæ­¥å†™è½¬æ¢æˆå¼‚æ­¥å†™ï¼Œè¿™æ ·å¯ä»¥ç‰ºç‰²ä¸€äº›æ•°æ®ä¸€è‡´æ€§å’Œå®æ•ˆæ€§æ¥ä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:6:1","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•"],"content":"é™æµ ä»€ä¹ˆæ˜¯é™æµï¼Ÿ é™æµï¼Œä¹Ÿç§°æµé‡æ§åˆ¶ã€‚æ˜¯æŒ‡ç³»ç»Ÿåœ¨é¢ä¸´é«˜å¹¶å‘ï¼Œæˆ–è€…å¤§æµé‡è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œé™åˆ¶æ–°çš„è¯·æ±‚å¯¹ç³»ç»Ÿçš„è®¿é—®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚é™æµä¼šå¯¼è‡´éƒ¨åˆ†ç”¨æˆ·è¯·æ±‚å¤„ç†ä¸åŠæ—¶æˆ–è€…è¢«æ‹’ï¼Œè¿™å°±å½±å“äº†ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥ä¸€èˆ¬éœ€è¦åœ¨ç³»ç»Ÿç¨³å®šå’Œç”¨æˆ·ä½“éªŒä¹‹é—´å¹³è¡¡ä¸€ä¸‹ã€‚ é™æµç®—æ³• å›ºå®šçª—å£ç®—æ³• é¦–å…ˆç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå°†å•ä½æ—¶é—´æ®µå½“åšä¸€ä¸ªçª—å£ï¼Œè®¡æ•°å™¨è®°å½•è¿™ä¸ªçª—å£æ¥æ”¶è¯·æ±‚çš„æ¬¡æ•°ã€‚ å½“æ¬¡æ•°å°‘äºé™æµé˜€å€¼ï¼Œå°±å…è®¸è®¿é—®ï¼Œå¹¶ä¸”è®¡æ•°å™¨+1 å½“æ¬¡æ•°å¤§äºé™æµé˜€å€¼ï¼Œå°±æ‹’ç»è®¿é—®ã€‚ å½“å‰çš„æ—¶é—´çª—å£è¿‡å»ä¹‹åï¼Œè®¡æ•°å™¨æ¸…é›¶ã€‚ å‡è®¾å•ä½æ—¶é—´æ˜¯1ç§’ï¼Œé™æµé˜€å€¼ä¸º3ã€‚åœ¨å•ä½æ—¶é—´1ç§’å†…ï¼Œæ¯æ¥ä¸€ä¸ªè¯·æ±‚,è®¡æ•°å™¨å°±åŠ 1ï¼Œå¦‚æœè®¡æ•°å™¨ç´¯åŠ çš„æ¬¡æ•°è¶…è¿‡é™æµé˜€å€¼3ï¼Œåç»­çš„è¯·æ±‚å…¨éƒ¨æ‹’ç»ã€‚ç­‰åˆ°1sç»“æŸåï¼Œè®¡æ•°å™¨æ¸…0ï¼Œé‡æ–°å¼€å§‹è®¡æ•°ã€‚å¦‚ä¸‹å›¾ï¼š ç¼ºé™·ï¼šå‡è®¾é™æµé˜€å€¼ä¸º5ä¸ªè¯·æ±‚ï¼Œå•ä½æ—¶é—´çª—å£æ˜¯1sï¼Œå¦‚æœæˆ‘ä»¬åœ¨å•ä½æ—¶é—´å†…çš„å‰0.8-1så’Œ1-1.2sï¼Œåˆ†åˆ«å¹¶å‘5ä¸ªè¯·æ±‚ã€‚è™½ç„¶éƒ½æ²¡æœ‰è¶…è¿‡é˜€å€¼ï¼Œä½†æ˜¯å¦‚æœç®—0.8-1.2sï¼Œåˆ™å¹¶å‘æ•°é«˜è¾¾10ï¼Œå·²ç»è¶…è¿‡å•ä½æ—¶é—´1sä¸è¶…è¿‡5é˜€å€¼çš„å®šä¹‰å•¦ã€‚ æ»‘åŠ¨çª—å£ç®—æ³• æ»‘åŠ¨çª—å£ç®—æ³•è§£å†³å›ºå®šçª—å£ä¸´ç•Œå€¼çš„é—®é¢˜ã€‚å®ƒå°†å•ä½æ—¶é—´å‘¨æœŸåˆ†ä¸ºnä¸ªå°å‘¨æœŸï¼Œåˆ†åˆ«è®°å½•æ¯ä¸ªå°å‘¨æœŸå†…æ¥å£çš„è®¿é—®æ¬¡æ•°ï¼Œå¹¶ä¸”æ ¹æ®æ—¶é—´æ»‘åŠ¨åˆ é™¤è¿‡æœŸçš„å°å‘¨æœŸã€‚ å‡è®¾å•ä½æ—¶é—´è¿˜æ˜¯1sï¼Œæ»‘åŠ¨çª—å£ç®—æ³•æŠŠå®ƒåˆ’åˆ†ä¸º5ä¸ªå°å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯æ»‘åŠ¨çª—å£ï¼ˆå•ä½æ—¶é—´ï¼‰è¢«åˆ’åˆ†ä¸º5ä¸ªå°æ ¼å­ã€‚æ¯æ ¼è¡¨ç¤º0.2sã€‚æ¯è¿‡0.2sï¼Œæ—¶é—´çª—å£å°±ä¼šå¾€å³æ»‘åŠ¨ä¸€æ ¼ã€‚ç„¶åå‘¢ï¼Œæ¯ä¸ªå°å‘¨æœŸï¼Œéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è®¡æ•°å™¨ï¼Œå¦‚æœè¯·æ±‚æ˜¯0.83såˆ°è¾¾çš„ï¼Œ0.8~1.0så¯¹åº”çš„è®¡æ•°å™¨å°±ä¼šåŠ 1ã€‚ é‚£æ»‘åŠ¨çª—å£æ˜¯å¦‚ä½•è§£å†³ä¸´ç•Œé—®é¢˜çš„ï¼Ÿ å‡è®¾æˆ‘ä»¬1så†…çš„é™æµé˜€å€¼è¿˜æ˜¯5ä¸ªè¯·æ±‚ï¼Œ0.8~1.0så†…ï¼ˆæ¯”å¦‚0.9sçš„æ—¶å€™ï¼‰æ¥äº†5ä¸ªè¯·æ±‚ï¼Œè½åœ¨é»„è‰²æ ¼å­é‡Œã€‚æ—¶é—´è¿‡äº†1.0sè¿™ä¸ªç‚¹ä¹‹åï¼Œåˆæ¥5ä¸ªè¯·æ±‚ï¼Œè½åœ¨ç´«è‰²æ ¼å­é‡Œã€‚å¦‚æœæ˜¯å›ºå®šçª—å£ç®—æ³•ï¼Œæ˜¯ä¸ä¼šè¢«é™æµçš„ï¼›ä½†æ˜¯æ»‘åŠ¨çª—å£çš„è¯ï¼Œæ¯è¿‡ä¸€ä¸ªå°å‘¨æœŸï¼Œå®ƒä¼šå³ç§»ä¸€ä¸ªå°æ ¼ã€‚è¿‡äº†1.0sè¿™ä¸ªç‚¹åï¼Œä¼šå³ç§»ä¸€å°æ ¼ï¼Œå½“å‰çš„å•ä½æ—¶é—´æ®µæ˜¯0.2~1.2sï¼Œè¿™ä¸ªåŒºåŸŸçš„è¯·æ±‚å·²ç»è¶…è¿‡é™å®šçš„5äº†ï¼Œå·²è§¦å‘é™æµå•¦ï¼Œå®é™…ä¸Šï¼Œç´«è‰²æ ¼å­çš„è¯·æ±‚éƒ½è¢«æ‹’ç»å•¦ã€‚ TIPS: å½“æ»‘åŠ¨çª—å£çš„æ ¼å­å‘¨æœŸåˆ’åˆ†çš„è¶Šå¤šï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚ ç¼ºé™·ï¼šæ»‘åŠ¨çª—å£ç®—æ³•è™½ç„¶è§£å†³äº†å›ºå®šçª—å£çš„ä¸´ç•Œé—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦åˆ°è¾¾é™æµåï¼Œè¯·æ±‚éƒ½ä¼šç›´æ¥æš´åŠ›è¢«æ‹’ç»ã€‚é…±ç´«æˆ‘ä»¬ä¼šæŸå¤±ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œè¿™å…¶å®å¯¹äºäº§å“æ¥è¯´ï¼Œå¹¶ä¸å¤ªå‹å¥½ã€‚ æ¼æ¡¶ç®—æ³• æ¼æ¡¶ç®—æ³•é¢å¯¹é™æµï¼Œå°±æ›´åŠ çš„æŸ”æ€§ï¼Œä¸å­˜åœ¨ç›´æ¥çš„ç²—æš´æ‹’ç»ã€‚ å®ƒçš„åŸç†å¾ˆç®€å•ï¼Œå¯ä»¥è®¤ä¸ºå°±æ˜¯æ³¨æ°´æ¼æ°´çš„è¿‡ç¨‹ï¼šå¾€æ¼æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥æ°´ï¼Œä»¥å›ºå®šçš„é€Ÿç‡æµå‡ºæ°´ã€‚å½“æ°´è¶…è¿‡æ¡¶çš„å®¹é‡æ—¶ï¼Œä¼šè¢«æº¢å‡ºï¼Œä¹Ÿå°±æ˜¯è¢«ä¸¢å¼ƒã€‚å› ä¸ºæ¡¶å®¹é‡æ˜¯ä¸å˜çš„ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚ æµå…¥çš„æ°´æ»´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯è®¿é—®ç³»ç»Ÿçš„è¯·æ±‚ï¼Œè¿™ä¸ªæµå…¥é€Ÿç‡æ˜¯ä¸ç¡®å®šçš„ã€‚ æ¡¶çš„å®¹é‡ä¸€èˆ¬è¡¨ç¤ºç³»ç»Ÿæ‰€èƒ½å¤„ç†çš„è¯·æ±‚æ•°ã€‚ å¦‚æœæ¡¶çš„å®¹é‡æ»¡äº†ï¼Œå°±è¾¾åˆ°é™æµçš„é˜€å€¼ï¼Œå°±ä¼šä¸¢å¼ƒæ°´æ»´ï¼ˆæ‹’ç»è¯·æ±‚ï¼‰ æµå‡ºçš„æ°´æ»´ï¼Œæ˜¯æ’å®šè¿‡æ»¤çš„ï¼Œå¯¹åº”æœåŠ¡æŒ‰ç…§å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ã€‚ åœ¨æ­£å¸¸æµé‡çš„æ—¶å€™ï¼Œç³»ç»ŸæŒ‰ç…§å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œæ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä½†æ˜¯é¢å¯¹çªå‘æµé‡çš„æ—¶å€™ï¼Œæ¼æ¡¶ç®—æ³•è¿˜æ˜¯å¾ªè§„è¹ˆçŸ©åœ°å¤„ç†è¯·æ±‚ï¼Œè¿™å°±ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„å•¦ã€‚æµé‡å˜çªå‘æ—¶ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›ç³»ç»Ÿå°½é‡å¿«ç‚¹å¤„ç†è¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒå˜›ã€‚ ä»¤ç‰Œæ¡¶ç®—æ³• é¢å¯¹çªå‘æµé‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•é™æµã€‚ç›¸æ¯”æ¼æ¡¶ç®—æ³•ï¼Œå¯ä»¥è°ƒèŠ‚é€Ÿç‡ã€‚ ä»¤ç‰Œæ¡¶ç®—æ³•åŸç†ï¼š æœ‰ä¸€ä¸ªä»¤ç‰Œç®¡ç†å‘˜ï¼Œæ ¹æ®é™æµå¤§å°ï¼Œå®šé€Ÿå¾€ä»¤ç‰Œæ¡¶é‡Œæ”¾ä»¤ç‰Œã€‚ å¦‚æœä»¤ç‰Œæ•°é‡æ»¡äº†ï¼Œè¶…è¿‡ä»¤ç‰Œæ¡¶å®¹é‡çš„é™åˆ¶ï¼Œé‚£å°±ä¸¢å¼ƒã€‚ ç³»ç»Ÿåœ¨æ¥å—åˆ°ä¸€ä¸ªç”¨æˆ·è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå…ˆå»ä»¤ç‰Œæ¡¶è¦ä¸€ä¸ªä»¤ç‰Œã€‚å¦‚æœæ‹¿åˆ°ä»¤ç‰Œï¼Œé‚£ä¹ˆå°±å¤„ç†è¿™ä¸ªè¯·æ±‚çš„ä¸šåŠ¡é€»è¾‘ï¼› å¦‚æœæ‹¿ä¸åˆ°ä»¤ç‰Œï¼Œå°±ç›´æ¥æ‹’ç»è¿™ä¸ªè¯·æ±‚ã€‚ å¦‚æœä»¤ç‰Œå‘æ”¾çš„ç­–ç•¥æ­£ç¡®ï¼Œè¿™ä¸ªç³»ç»Ÿå³ä¸ä¼šè¢«æ‹–å®ï¼Œä¹Ÿèƒ½æé«˜æœºå™¨çš„åˆ©ç”¨ç‡ã€‚ å‚è€ƒæ–‡ç« ï¼š é¢è¯•å¿…å¤‡ï¼š4ç§ç»å…¸é™æµç®—æ³•è®²è§£ å‚è€ƒæ–‡ç« ï¼š é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡ 40 é—® å­—èŠ‚ä¸‰é¢ï¼šå¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¹¶å‘ç³»ç»Ÿ ","date":"2023-05-25","objectID":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/:6:2","tags":["é«˜å¹¶å‘ç³»ç»Ÿ"],"title":"é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡","uri":"/17-%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"[toc] ","date":"2023-05-01","objectID":"/11-%E9%A1%B9%E7%9B%AE/:0:0","tags":["é¡¹ç›®"],"title":"ä¸ªäººé¡¹ç›®","uri":"/11-%E9%A1%B9%E7%9B%AE/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"ä¸€ã€Gin æ¡†æ¶ é—®ï¼šä¸ºä»€ä¹ˆéœ€è¦ Webæ¡†æ¶ï¼Ÿ net/httpæä¾›äº†åŸºç¡€çš„WebåŠŸèƒ½ï¼Œå³ç›‘å¬ç«¯å£ï¼Œæ˜ å°„é™æ€è·¯ç”±ï¼Œè§£æHTTPæŠ¥æ–‡ã€‚ä¸€ä¸ªå®ä¾‹ï¼š func main() { http.HandleFunc(\"/\", handler) http.HandleFunc(\"/count\", counter) log.Fatal(http.ListenAndServe(\"localhost:8000\", nil)) } func handler(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \"URL.Path = %q\\n\", r.URL.Path) } ä½†ä¸€äº›Webå¼€å‘ä¸­ç®€å•çš„éœ€æ±‚å¹¶ä¸æ”¯æŒï¼Œéœ€è¦æ‰‹å·¥å®ç°ï¼š åŠ¨æ€è·¯ç”±ï¼šä¾‹å¦‚hello/:nameï¼Œhello/*è¿™ç±»çš„è§„åˆ™ã€‚ é‰´æƒï¼šæ²¡æœ‰åˆ†ç»„/ç»Ÿä¸€é‰´æƒçš„èƒ½åŠ›ï¼Œéœ€è¦åœ¨æ¯ä¸ªè·¯ç”±æ˜ å°„çš„handlerä¸­å®ç°ã€‚ æ¨¡æ¿ï¼šæ²¡æœ‰ç»Ÿä¸€ç®€åŒ–çš„HTMLæœºåˆ¶ã€‚ ç»Ÿä¸€å…¥å£ package http type Handler interface { ServeHTTP(w ResponseWriter, r *Request) } func ListenAndServe(address string, h Handler) error å…¶å®å°±æ˜¯ï¼Œå®ç°Handleræ¥å£ï¼Œæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚åˆ°å’±ä»¬è‡ªå·±çš„å¤„ç†é€»è¾‘ã€‚ è§£é‡Šä¸€ä¸‹ï¼šä½ å¯ä»¥çœ‹è¿™ç‚¹ä»£ç ï¼šhttp.ListenAndServe(\"localhost:8000\", nil)ï¼Œåé¢æ˜¯nilï¼Œå…¶å®httpåº“ä¼šè‡ªåŠ¨ç»™ä¸ªé»˜è®¤çš„DefaultServeMuxï¼Œä¹Ÿå°±æŠŠæ‰€æœ‰çš„è¯·æ±‚ç”¨è¿™ä¸ªå¤„ç†äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æ‹¦æˆªæ‰æ‰€æœ‰çš„è¯·æ±‚ï¼ ==è·¯ç”±æ˜ å°„==ï¼ˆåŠ¨æ€è·¯ç”±æœ‰ç‚¹é—®é¢˜å§ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼‰ func main() { r := gee.New() r.GET(\"/\", func(w http.ResponseWriter, req *http.Request) { fmt.Fprintf(w, \"URL.Path = %q\\n\", req.URL.Path) }) r.GET(\"/hello\", func(w http.ResponseWriter, req *http.Request) { for k, v := range req.Header { fmt.Fprintf(w, \"Header[%q] = %q\\n\", k, v) } }) r.Run(\":9999\") } å…¶å®å°±æ˜¯ï¼ŒæŠŠè·¯ç”±åœ°å€å’Œå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå­˜èµ·æ¥ã€‚ è§£é‡Šä¸€ä¸‹ï¼šè¿™é‡Œæœ€ç®€å•çš„åŠæ³•æ˜¯å•¥ï¼Ÿä¸å°±æ˜¯åœ¨ré‡Œè¾¹æ•´ä¸ªå“ˆå¸Œè¡¨ï¼ŒæŠŠè·¯ç”±å’Œå¤„ç†å‡½æ•°åˆ†åˆ«å½“æˆkeyå’Œvalå˜›ï¼Ÿä½†æ˜¯å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªå¼Šç«¯ï¼šåªèƒ½æ”¯æŒé™æ€è·¯ç”±ã€‚ æ”¯æŒåŠ¨æ€è·¯ç”±ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•ï¼š æ­£åˆ™è¡¨è¾¾å¼ å‰ç¼€æ ‘ã€å‹ç¼©å‰ç¼€æ ‘(æ­¤å¤„ä½¿ç”¨) è¿™é‡Œå®ç°åŠ¨æ€è·¯ç”±å…·å¤‡ä¸¤ä¸ªåŠŸèƒ½ï¼š å‚æ•°åŒ¹é…:ã€‚ä¾‹å¦‚ /p/:lang/docï¼Œå¯ä»¥åŒ¹é… /p/c/doc å’Œ /p/go/docï¼› é€šé…*ã€‚ä¾‹å¦‚ /static/*filepathï¼Œå¯ä»¥åŒ¹é…/static/fav.icoï¼Œä¹Ÿå¯ä»¥åŒ¹é…/static/js/jQuery.jsï¼Œè¿™ç§æ¨¡å¼å¸¸ç”¨äºé™æ€æœåŠ¡å™¨ï¼Œèƒ½å¤Ÿé€’å½’åœ°åŒ¹é…å­è·¯å¾„ã€‚ å®ç°å‰ç¼€æ ‘åï¼Œå¯ä»¥åœ¨routerä¸­å¯¹æ¯ä¸€ç§ç±»å‹çš„æ–¹æ³•éƒ½ç»´æŠ¤ä¸€é¢—Trieã€‚ å¯¹äºåŠ¨æ€è·¯ç”±ä¼ é€’çš„å‚æ•°ï¼Œå¯ä»¥æ”¾åœ¨Contextä¸­çš„Paramé‡Œã€‚ è®¾è®¡Context è®¾è®¡ä¸Šä¸‹æ–‡(Context)ï¼Œå°è£… Request å’Œ Responseï¼Œæä¾›å¯¹ JSONã€HTML ç­‰è¿”å›ç±»å‹çš„æ”¯æŒã€‚ å¿…è¦æ€§ï¼š å¯¹WebæœåŠ¡æ¥è¯´ï¼Œæ— éæ˜¯æ ¹æ®è¯·æ±‚*http.Requestï¼Œæ„é€ å“åº”http.ResponseWriterã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªå¯¹è±¡æä¾›çš„æ¥å£ç²’åº¦å¤ªç»†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦æ„é€ ä¸€ä¸ªå®Œæ•´çš„å“åº”ï¼Œéœ€è¦è€ƒè™‘æ¶ˆæ¯å¤´(Header)å’Œæ¶ˆæ¯ä½“(Body)ï¼Œè€Œ Header åŒ…å«äº†çŠ¶æ€ç (StatusCode)ï¼Œæ¶ˆæ¯ç±»å‹(ContentType)ç­‰å‡ ä¹æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦è®¾ç½®çš„ä¿¡æ¯ã€‚å› æ­¤ï¼Œå¦‚æœä¸è¿›è¡Œæœ‰æ•ˆçš„å°è£…ï¼Œé‚£ä¹ˆæ¡†æ¶çš„ç”¨æˆ·å°†éœ€è¦å†™å¤§é‡é‡å¤ï¼Œç¹æ‚çš„ä»£ç ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚é’ˆå¯¹å¸¸ç”¨åœºæ™¯ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°æ„é€ å‡º HTTP å“åº”æ˜¯ä¸€ä¸ªå¥½çš„æ¡†æ¶å¿…é¡»è€ƒè™‘çš„ç‚¹ã€‚ ç¤ºä¾‹ï¼š å°è£…å‰ obj = map[string]interface{}{ \"name\": \"geektutu\", \"password\": \"1234\", } w.Header().Set(\"Content-Type\", \"application/json\") w.WriteHeader(http.StatusOK) encoder := json.NewEncoder(w) if err := encoder.Encode(obj); err != nil { http.Error(w, err.Error(), 500) } VS å°è£…åï¼š c.JSON(http.StatusOK, gee.H{ \"username\": c.PostForm(\"username\"), \"password\": c.PostForm(\"password\"), }) Context è¿˜å¯ä»¥æ”¯æ’‘å…¶ä»–åŠŸèƒ½ã€‚æ¯”å¦‚ï¼š **åŠ¨æ€è·¯ç”±çš„å‚æ•°ï¼š**å°†æ¥è§£æåŠ¨æ€è·¯ç”±/hello/:nameï¼Œå‚æ•°:nameçš„å€¼æ”¾åœ¨å“ªå‘¢ï¼Ÿ **ä¸­é—´ä»¶çš„å‚æ•°ä¸ç»“æœï¼š**æ¡†æ¶éœ€è¦æ”¯æŒä¸­é—´ä»¶ï¼Œé‚£ä¸­é—´ä»¶äº§ç”Ÿçš„ä¿¡æ¯æ”¾åœ¨å“ªå‘¢ï¼Ÿ Context éšç€æ¯ä¸€ä¸ªè¯·æ±‚çš„å‡ºç°è€Œäº§ç”Ÿï¼Œè¯·æ±‚çš„ç»“æŸè€Œé”€æ¯ï¼Œå’Œå½“å‰è¯·æ±‚å¼ºç›¸å…³çš„ä¿¡æ¯éƒ½åº”ç”± Context æ‰¿è½½ã€‚ Context å°±åƒä¸€æ¬¡ä¼šè¯çš„ç™¾å®ç®±ï¼Œå¯ä»¥æ‰¾åˆ°ä»»ä½•ä¸œè¥¿ã€‚ æä¾›äº†è®¿é—®Queryå’ŒPostFormå‚æ•°çš„æ–¹æ³•ï¼› æä¾›äº†å¿«é€Ÿæ„é€ String/Data/JSON/HTMLå“åº”çš„æ–¹æ³•ã€‚ package gee import ( \"encoding/json\" \"fmt\" \"net/http\" ) type H map[string]interface{} type Context struct { // origin objects W http.ResponseWriter Req *http.Request // req info Path string // å…¶å®å°±æ˜¯ pattern Method string // è¯·æ±‚æ–¹æ³• Params map[string]string // å­˜å‚¨Pathä¼ é€’çš„å‚æ•° // resp info StatusCode int // å“åº”ç  // middleware handlers []HandlerFunc // å­˜å‚¨ä¸­é—´ä»¶ index int // è®°å½•å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ ä¸ªä¸­é—´ä»¶ // engine pointer engine *Engine } func NewContext(w http.ResponseWriter, req *http.Request) *Context { return \u0026Context{ W: w, Req: req, Path: req.URL.Path, Method: req.Method, index: -1, } } // è·å–ä¼ é€’çš„å‚æ•° func (c *Context) Param(key string) string { return c.Params[key] } // è·å–Formçš„æ•°æ® func (c *Context) PostForm(key string) string { return c.Req.FormValue(key) } // è·å–Queryçš„æ•°æ® func (c *Context) Query(key string) string { return c.Req.URL.Query().Get(key) } func (c *Context) Status(code int) { c.StatusCode = code c.W.WriteHeader(code) } func (c *Context) SetHeader(key string, value string) { c.W.Header().Set(key, value) } func (c *Context) String(code int, format string, values ...interface{}) { c.SetHeader(\"Content-Type\", \"text/plain\") c.Status(code) c.W.Write([]byte(fmt.Sprintf(format, values...))) } func (c *Context) Data(code int, data []byte) { c.Status(code) c.W.Write(data) } func (c *Context) JSON(code int, obj interface{}) { c.SetHeader(\"Content-Type\", \"application/json\") c.Status(code) encoder := json.NewEncoder(c.W) if err := encoder.Encode(obj); err != nil { http.Error(c.W, err.Error(), 500) } } func (c *Context) HTML(code int, name string, data interface{}) { c.SetHeader(\"Content-Type\", \"text/html\") c.Status(code) i","date":"2023-05-01","objectID":"/11-%E9%A1%B9%E7%9B%AE/:1:0","tags":["é¡¹ç›®"],"title":"ä¸ªäººé¡¹ç›®","uri":"/11-%E9%A1%B9%E7%9B%AE/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"äºŒã€åˆ†å¸ƒå¼ç¼“å­˜æ¡†æ¶ ä»¿ç…§ groupCache å®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ²¡æœ‰åˆ é™¤ã€æ›´æ–°æ¥å£ï¼Œåªæœ‰Getæ¥å£ã€‚ é—®ï¼šä¸ºä»€ä¹ˆè¦è®¾è®¡åˆ†å¸ƒå¼ç¼“å­˜æœºåˆ¶ï¼Ÿ æœ€ç®€å•çš„ç¼“å­˜å°±æ˜¯ç”¨å“ˆå¸Œè¡¨ã€‚ä½†æ˜¯ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š å†…å­˜ä¸å¤Ÿäº†å’‹åŠï¼Œéœ€è¦å®ç°ä¸€ä¸ªåˆç†çš„ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼› å…¨å±€å“ˆå¸Œè¡¨å­˜åœ¨è®¿é—®å†²çªï¼Œéœ€è¦åŠ é”ï¼Œé™ä½æ•ˆç‡ï¼› å•æœºæ€§èƒ½å¯èƒ½ä¸å¤Ÿï¼Œå•ç‚¹æ•…éšœçš„æˆæœ¬å¤ªé«˜ï¼Œåˆ†å¸ƒå¼ç¼“å­˜å¯ä»¥å¢å¼ºç³»ç»Ÿé²æ£’æ€§ã€‚ â€¦ é—®ï¼šæ”¯æŒé‚£äº›ç‰¹æ€§ï¼Ÿ å•æœºç¼“å­˜å’ŒåŸºäº HTTP çš„åˆ†å¸ƒå¼ç¼“å­˜ï¼› æœ€è¿‘æœ€å°‘è®¿é—®(Least Recently Used, LRU) ç¼“å­˜ç­–ç•¥ï¼› ä½¿ç”¨ Go é”æœºåˆ¶é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼› ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©èŠ‚ç‚¹ï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼› ä½¿ç”¨ protobuf ä¼˜åŒ–èŠ‚ç‚¹é—´äºŒè¿›åˆ¶é€šä¿¡ï¼› ã€‚ã€‚ã€‚ ç¼“å­˜ç­–ç•¥ ç¼“å­˜è‚¯å®šä¸èƒ½æ— é™å¤§ï¼Œè¶…è¿‡è®¾ç½®å®¹é‡æ—¶éœ€è¦æœ‰åˆç†çš„æ·˜æ±°ç­–ç•¥ã€‚ å¸¸è§çš„ç¼“å­˜ç­–ç•¥ï¼š FIFOï¼šé˜Ÿåˆ—å˜›ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œæ˜¾ç„¶å¾ˆä¸åˆç†ï¼› LFUï¼šæŒ‰ç…§ä½¿ç”¨æ¬¡æ•°æ’åºï¼Œæ·˜æ±°æœ€å°‘ä½¿ç”¨çš„ï¼› LRUï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼› é—®ï¼šç¼“å­˜å¤§å°æ˜¯å¦‚ä½•è¡¨ç¤ºçš„ï¼Ÿ ä½¿ç”¨[]byteå­˜å‚¨æ•°æ®ï¼Œå…¶é•¿åº¦len()å°±æ˜¯å ç”¨å¤šå°‘Byteã€‚ é—®ï¼šæ•°æ®å­˜æ”¾æ ¼å¼ï¼Ÿâ­ ç¼“å­˜Cacheç”±ä»¥ä¸‹å­—æ®µç»„æˆï¼š type Cache struct { MaxEntries int OnEvicted func(key Key, value interface{}) ll *list.List // çœŸæ­£å­˜å‚¨ entry æŒ‡é’ˆçš„åœ°æ–¹ cache map[interface{}]*list.Element // å­˜å‚¨ key - entryï¼Œç”¨äºå¿«é€Ÿæ‰¾åˆ° entry } type Key interface{} type entry struct { key Key value interface{} } å½“è¦å­˜å‚¨ä¸€å¯¹ key-valueæ—¶ï¼Œé¦–å…ˆè½¬æ¢æˆ entry å¯¹è±¡ï¼Œç†è®ºä¸Š key å’Œ value éƒ½æ˜¯ interface{}ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒæ‰€æœ‰ç±»å‹ã€‚ æ’å…¥æ—¶ï¼Œè‹¥keyä¹‹å‰ä¸å­˜åœ¨ï¼Œå°±æ˜¯æ’å…¥ï¼›è‹¥å·²å­˜åœ¨ï¼Œå°±æ˜¯æ›´æ–°ï¼š // Add adds a value to the cache. func (c *Cache) Add(key Key, value interface{}) { if c.cache == nil { c.cache = make(map[interface{}]*list.Element) c.ll = list.New() } if ee, ok := c.cache[key]; ok { c.ll.MoveToFront(ee) ee.Value.(*entry).value = value return } ele := c.ll.PushFront(\u0026entry{key, value}) // ll ä¸­å­˜å‚¨çš„å…¶å®æ˜¯ entry å¯¹è±¡çš„æŒ‡é’ˆ c.cache[key] = ele if c.MaxEntries != 0 \u0026\u0026 c.ll.Len() \u003e c.MaxEntries { c.RemoveOldest() } } é—®ï¼šæ•°æ®æ”¯æŒå“ªäº›æ“ä½œï¼Ÿ åªæ”¯æŒ Getã€‚ ç”¨æˆ·ä½¿ç”¨æ—¶ï¼Œéœ€è¦å®ç°ä»¥ä¸‹ï¼š åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±éœ€è¦æ˜ç¡®å½“ key miss çš„æ—¶å€™ï¼Œæ€ä¹ˆè·å–åˆ°å†…å®¹çš„æ‰‹æ®µï¼ŒæŠŠè¿™ä¸ªæ‰‹æ®µé…ç½®å¥½æ˜¯å‰æï¼› get è°ƒç”¨çš„æ—¶å€™ï¼Œå½“ key miss çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨åˆå§‹åŒ–çš„è·å–æ‰‹æ®µæ¥è·å–æ•°æ®ï¼Œå¦‚æœ hit çš„è¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›äº†ã€‚ é—®ï¼šè¿™ç§åªèƒ½ get ï¼Œä¸èƒ½æ›´æ–° key çš„ç¼“å­˜æœ‰å•¥ç”¨ï¼Ÿæœ‰ä»€ä¹ˆé€‚ç”¨åœºæ™¯ï¼Ÿ æ¯”å¦‚ä½ ç¼“å­˜ä¸€äº›é™æ€æ–‡ä»¶ï¼Œç”¨æ–‡ä»¶ md5 ä½œä¸º keyï¼Œvalue å°±æ˜¯æ–‡ä»¶ã€‚è¿™ç§åœºæ™¯å°±å¾ˆé€‚åˆç”¨ groupcache è¿™ç§ç¼“å­˜ï¼Œå› ä¸º key å¯¹åº”çš„ value ä¸éœ€è¦å˜ã€‚ å‚è€ƒæ–‡ç« ï¼š https://liqingqiya.github.io/groupcache/golang/%E7%BC%93%E5%AD%98/2020/05/10/groupcache.html å•æœºå¹¶å‘ç¼“å­˜ å¹¶å‘è®¾è®¡å¤šåç¨‹ï¼Œæ‰€ä»¥è‚¯å®šéœ€è¦ä¸€æŠŠäº’æ–¥é”ã€‚ é—®ï¼šå•æœºå¹¶å‘ç¼“å­˜æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ åœ¨lruå¤–å†å°è£…ä¸€å±‚ï¼Œä¸»è¦æ•°æ®ç»“æ„ï¼š type cache struct { mu sync.Mutex // æ”¯æŒå¹¶å‘, å¿…é¡»æœ‰é” lru *lru.Cache cacheBytes int64 // ç¼“å­˜å®¹é‡ Byte } ä¸ºäº†åŒºåˆ†ä¸åŒç±»å‹çš„ç¼“å­˜ï¼Œè®¾ç½®Groupï¼Œè´Ÿè´£ä¸ç”¨æˆ·äº¤äº’ï¼Œæ§åˆ¶ç¼“å­˜å€¼å­˜å‚¨å’Œè·å–çš„æµç¨‹ï¼š /* æ˜¯ æ¥æ”¶ key --\u003e æ£€æŸ¥æ˜¯å¦è¢«ç¼“å­˜ -----\u003e è¿”å›ç¼“å­˜å€¼ â‘´ | å¦ æ˜¯ |-----\u003e æ˜¯å¦åº”å½“ä»è¿œç¨‹èŠ‚ç‚¹è·å– -----\u003e ä¸è¿œç¨‹èŠ‚ç‚¹äº¤äº’ --\u003e è¿”å›ç¼“å­˜å€¼ â‘µ | å¦ |-----\u003e è°ƒç”¨`å›è°ƒå‡½æ•°`ï¼Œè·å–å€¼å¹¶æ·»åŠ åˆ°ç¼“å­˜ --\u003e è¿”å›ç¼“å­˜å€¼ â‘¶ */ é—®ï¼šè‹¥ç¼“å­˜ä¸å­˜åœ¨ï¼Œæ€ä¹ˆè·å–å‘¢ï¼Ÿ åˆ†ä¸ºä»è¿œç¨‹èŠ‚ç‚¹è·å–å’Œ**è°ƒç”¨ç”¨æˆ·é€»è¾‘(å›è°ƒå‡½æ•°)**è·å–ã€‚ è¿™éƒ¨åˆ†æ˜¯å›è°ƒå‡½æ•°çš„å®ç°é€»è¾‘ï¼š å› ä¸ºæ•°æ®æ€ä¹ˆè·å¾—ã€è·å¾—çš„æ¥æºæ˜¯å“ªï¼Œåº”è¯¥æ˜¯æ¡†æ¶çš„ç”¨æˆ·éœ€è¦è€ƒè™‘çš„ï¼Œæ‰€ä»¥åªéœ€è¦å¼€æ”¾ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥å£å³å¯ã€‚ **ç”¨æˆ·éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªGetterFuncç±»å‹çš„å‡½æ•°ã€‚**å½“ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œå°±ä¼šè°ƒç”¨æ­¤å‡½æ•°è·å–æ•°æ®ï¼Œè·å–ä¹‹åä¼šè°ƒç”¨cache.put()æ›´æ–°ç¼“å­˜ã€‚ // Getter æœªå‘½ä¸­æ—¶ä»æ•°æ®æºè·å–æ•°æ® type Getter interface { Get(key string) ([]byte, error) // å›è°ƒå‡½æ•° } // å‡½æ•°ç±»å‹å®ç°æŸä¸€ä¸ªæ¥å£ï¼Œç§°ä¹‹ä¸ºæ¥å£å‹å‡½æ•°ã€‚ // æ–¹ä¾¿ä½¿ç”¨è€…åœ¨è°ƒç”¨æ—¶æ—¢èƒ½å¤Ÿä¼ å…¥å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä¹Ÿèƒ½å¤Ÿä¼ å…¥å®ç°äº†è¯¥æ¥å£çš„ç»“æ„ä½“ä½œä¸ºå‚æ•°ã€‚ // æ˜¯ä¸€ä¸ªå°†å‡½æ•°è½¬æ¢ä¸ºæ¥å£çš„æŠ€å·§ type GetterFunc func(key string) ([]byte, error) // Get å®ç°Getteræ¥å£ func (f GetterFunc) Get(key string) ([]byte, error) { return f(key) } è¿™éƒ¨åˆ†æ˜¯ä»è¿œç¨‹èŠ‚ç‚¹è·å–çš„å®ç°é€»è¾‘ï¼š ä¸€è‡´æ€§å“ˆå¸Œ é—®ï¼šä¸€è‡´æ€§å“ˆå¸ŒåŸç†ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°† key æ˜ å°„åˆ° 2^32^ çš„ç©ºé—´ä¸­ï¼Œå°†è¿™ä¸ªæ•°å­—é¦–å°¾ç›¸è¿ï¼Œå½¢æˆä¸€ä¸ªç¯ã€‚ è®¡ç®—èŠ‚ç‚¹/æœºå™¨(é€šå¸¸ä½¿ç”¨èŠ‚ç‚¹çš„åç§°ã€ç¼–å·å’Œ IP åœ°å€)çš„å“ˆå¸Œå€¼ï¼Œæ”¾ç½®åœ¨ç¯ä¸Šã€‚ è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œæ”¾ç½®åœ¨ç¯ä¸Šï¼Œé¡ºæ—¶é’ˆå¯»æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯åº”é€‰å–çš„èŠ‚ç‚¹/æœºå™¨ã€‚ ç¯ä¸Šæœ‰ peer2ï¼Œpeer4ï¼Œpeer6 ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œkey11ï¼Œkey2ï¼Œkey27 å‡æ˜ å°„åˆ° peer2ï¼Œkey23 æ˜ å°„åˆ° peer4ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ–°å¢èŠ‚ç‚¹/æœºå™¨ peer8ï¼Œå‡è®¾å®ƒæ–°å¢ä½ç½®å¦‚å›¾æ‰€ç¤ºï¼Œé‚£ä¹ˆåªæœ‰ key27 ä» peer2 è°ƒæ•´åˆ° peer8ï¼Œå…¶ä½™çš„æ˜ å°„å‡æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œåœ¨æ–°å¢/åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦é‡æ–°å®šä½è¯¥èŠ‚ç‚¹é™„è¿‘çš„ä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œè€Œä¸éœ€è¦é‡æ–°å®šä½æ‰€æœ‰çš„èŠ‚ç‚¹ã€‚ é—®ï¼šæ€ä¹ˆè§£å†³æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ ==æ•°æ®å€¾æ–œæ˜¯ä»€ä¹ˆï¼Ÿ== **å¦‚æœæœåŠ¡å™¨çš„èŠ‚ç‚¹è¿‡å°‘ï¼Œå®¹æ˜“å¼•èµ· key çš„å€¾æ–œã€‚**ä¾‹å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ peer2ï¼Œpeer4ï¼Œpeer6 åˆ†å¸ƒåœ¨ç¯çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯ç©ºçš„ã€‚é‚£ä¹ˆæ˜ å°„åˆ°ç¯ä¸‹åŠéƒ¨åˆ†çš„ key éƒ½ä¼šè¢«åˆ†é…ç»™ peer2ï¼Œkey è¿‡åº¦å‘ peer2 å€¾æ–œï¼Œç¼“å­˜èŠ‚ç‚¹é—´è´Ÿè½½ä¸å‡ã€‚ ==æ€ä¹ˆè§£å†³ï¼Ÿ== **å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ï¼š**ä¸€ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº”å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚ å‡è®¾ 1 ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº” 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œé‚£ä¹ˆ peer1 å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹æ˜¯ peer1-1ã€ peer1-2ã€ peer1-3ï¼ˆé€šå¸¸ä»¥æ·»åŠ ç¼–å·çš„æ–¹å¼å®ç°ï¼‰ï¼Œå…¶ä½™èŠ‚ç‚¹ä¹Ÿä»¥ç›¸åŒçš„æ–¹å¼æ“ä½œã€‚ ç¬¬ä¸€æ­¥ï¼Œè®¡ç®—è™šæ‹ŸèŠ‚ç‚¹çš„ Hash å€¼ï¼Œæ”¾ç½®åœ¨ç¯ä¸Šã€‚ ç¬¬äºŒæ­¥ï¼Œè®¡ç®— key çš„ Hash å€¼ï¼Œåœ¨ç¯ä¸Šé¡ºæ—¶é’ˆå¯»æ‰¾åˆ°åº”é€‰å–çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ˜¯ peer2-1ï¼Œé‚£ä¹ˆå°±å¯¹åº”çœŸå®èŠ‚ç‚¹ peer2ã€‚ **è™šæ‹ŸèŠ‚ç‚¹æ‰©å……äº†èŠ‚ç‚¹çš„æ•°é‡ï¼Œè§£å†³äº†èŠ‚ç‚¹è¾ƒå°‘çš„æƒ…å†µä¸‹æ•°æ®å®¹æ˜“å€¾æ–œçš„é—®é¢˜ã€‚**è€Œä¸”ä»£ä»·éå¸¸å°ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªå­—å…¸(map)ç»´æŠ¤çœŸå®èŠ‚ç‚¹ä¸è™šæ‹ŸèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»å³å¯ã€‚ é—®ï¼šå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ Goå®ç°éƒ¨åˆ†ï¼šhttps://geektutu.com/post/geecache-day4.html å°±æ˜¯ï¼š å®šä¹‰ä¸€è‡´æ€§å“ˆå¸Œçš„æ•°æ®ç»“æ„ï¼š type Hash func(data []byte) uint32 type Map struct { hash Hash // å¯æ›´æ¢ç”¨æˆ·è‡ªå®šä¹‰çš„å“ˆå¸Œå‡½æ•°ï¼Œé»˜è®¤ä¸ºcrc32.ChecksumIEE() replicas int // è™šæ‹ŸèŠ‚ç‚¹å€æ•°ï¼Œå³ä¸€ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº”replicasä¸ªè™šæ‹ŸèŠ‚ç‚¹ keys []int // å“ˆå¸Œç¯ï¼Œå­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„hashå€¼ hashMap map[int]string // èŠ‚ç‚¹å“ˆå¸Œå€¼ - çœŸå®èŠ‚ç‚¹åç§° } å¦‚ä½•æ·»åŠ çœŸå®/è™šæ‹ŸèŠ‚ç‚¹ï¼š func (m *Map) Add(keys ...string) { // keysæ˜¯èŠ‚ç‚¹åç§° for _, key := range keys { for i := 0; i \u003c m.replicas; i++ { // æ¯ä¸ªçœŸå®èŠ‚ç‚¹éƒ½åˆ›å»ºreplicasä¸ªè™šæ‹ŸèŠ‚ç‚¹ hash := int(m.hash([]byte(strconv.Itoa(i) + key))) // æ±‚ è™šæ‹ŸèŠ‚ç‚¹(\"i+key\") çš„å“ˆå¸Œå€¼ m.keys = append(m.keys, hash) // åŠ å…¥å“ˆå¸Œç¯ m.hashMap[hash] = key // è™šæ‹ŸèŠ‚ç‚¹ - çœŸå®èŠ‚ç‚¹ } } sort.Ints(m.keys) // æ’åº } å¦‚ä½•é€‰æ‹©èŠ‚ç‚¹ï¼š func (m *Map) Get(key string) string { // keyæ˜¯æŸ¥æ‰¾é”®å€¼","date":"2023-05-01","objectID":"/11-%E9%A1%B9%E7%9B%AE/:2:0","tags":["é¡¹ç›®"],"title":"ä¸ªäººé¡¹ç›®","uri":"/11-%E9%A1%B9%E7%9B%AE/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"ä¸‰ã€Orm æ¡†æ¶ é—®ï¼šORM æ¡†æ¶æœ‰ä»€ä¹ˆç”¨ï¼Ÿ ORM æ¡†æ¶ç›¸å½“äºå¯¹è±¡å’Œæ•°æ®åº“ä¸­é—´çš„ä¸€ä¸ªæ¡¥æ¢ï¼Œå€ŸåŠ© ORM å¯ä»¥é¿å…å†™ç¹ççš„ SQL è¯­è¨€ï¼Œä»…ä»…é€šè¿‡æ“ä½œå…·ä½“çš„å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿå®Œæˆå¯¹å…³ç³»å‹æ•°æ®åº“çš„æ“ä½œã€‚ é—®ï¼šè®¾è®¡ ORM æ¡†æ¶ï¼Œéœ€è¦å…³æ³¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ å¦‚ä½•å±è”½ä¸åŒæ•°æ®åº“ä¹‹é—´çš„å·®å¼‚ï¼Ÿ å¦‚ä½•ä»å¯¹è±¡æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„è¡¨ç»“æ„/è®°å½•ï¼Ÿ MySQLï¼ŒPostgreSQLï¼ŒSQLite ç­‰æ•°æ®åº“çš„ SQL è¯­å¥æ˜¯æœ‰åŒºåˆ«çš„ï¼ŒORM æ¡†æ¶å¦‚ä½•åœ¨å¼€å‘è€…ä¸æ„ŸçŸ¥çš„æƒ…å†µä¸‹é€‚é…å¤šç§æ•°æ®åº“ï¼Ÿ å¦‚ä½•å®ç°ï¼šå¯¹è±¡çš„å­—æ®µå‘ç”Ÿæ”¹å˜ï¼Œæ•°æ®åº“è¡¨ç»“æ„èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°ï¼Œå³æ”¯æŒæ•°æ®åº“è‡ªåŠ¨è¿ç§»(migrate)ï¼Ÿ æ•°æ®åº“æ”¯æŒçš„å…¶ä»–åŠŸèƒ½ï¼Œå¦‚äº‹åŠ¡ç­‰ï¼ŒORM æ¡†æ¶èƒ½å®ç°å“ªäº›ï¼Ÿ ç®€å•çš„å¢åˆ æŸ¥æ”¹ä½¿ç”¨ ORM æ›¿ä»£ SQL è¯­å¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤šç‰¹æ€§éš¾ä»¥ç”¨ ORM æ›¿ä»£ï¼Œæ¯”å¦‚å¤æ‚çš„å¤šè¡¨å…³è”æŸ¥è¯¢ï¼ŒORM ä¹Ÿå¯èƒ½æ”¯æŒï¼Œä½†æ˜¯åŸºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œå¼€å‘è€…è‡ªå·±å†™ SQL è¯­å¥å¾ˆå¯èƒ½æ›´é«˜æ•ˆã€‚ é—®ï¼šä½ çš„ ORM æ¡†æ¶éƒ½å®ç°äº†ç‚¹å•¥ï¼Ÿ ç›®å‰æ”¯æŒçš„ç‰¹æ€§æœ‰ï¼š è¡¨çš„åˆ›å»ºã€åˆ é™¤ã€è¿ç§»ã€‚ è®°å½•çš„å¢åˆ æŸ¥æ”¹ï¼ŒæŸ¥è¯¢æ¡ä»¶çš„é“¾å¼æ“ä½œã€‚ å•ä¸€ä¸»é”®çš„è®¾ç½®(primary key)ã€‚ é’©å­(åœ¨åˆ›å»º/æ›´æ–°/åˆ é™¤/æŸ¥æ‰¾ä¹‹å‰æˆ–ä¹‹å)ã€‚ äº‹åŠ¡(transaction)ã€‚ æ•°æ®åº“è¿ç§»ã€‚ ä¸ºäº†è½»é‡åŒ–ï¼Œç›®å‰åªæ”¯æŒè½»é‡çº§æ•°æ®åº“ SQLiteã€‚ é—®ï¼šé¡¹ç›®ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿå„éƒ¨åˆ†éƒ½å®ç°äº†å•¥ï¼Ÿ . |-- clause // 5. ç”Ÿæˆsqlè¯­å¥ | |-- clause.go // ç»„åˆsqlå­å¥ä¸ºå®Œæ•´å¥å­ | `-- generator.go // ç”Ÿæˆæ‹¼åˆç”¨åˆ°çš„sqlå­å¥ |-- cmd | |-- gee.db | `-- main.go |-- dialect // 3. æŠ½è±¡å‡ºå„ä¸ªæ•°æ®åº“å·®å¼‚çš„éƒ¨åˆ† | |-- dialect.go // Goçš„æ•°æ®ç±»å‹ è½¬æ¢æˆ æ•°æ®åº“çš„æ•°æ®ç±»å‹ | `-- sqlite3.go // è¿™æ˜¯ä¸ªç¤ºä¾‹ï¼šsqlite3çš„æ•°æ®ç±»å‹è½¬æ¢ã€‚è¦æ”¯æŒå…¶ä»–æ•°æ®åº“ï¼Œè¿˜éœ€è¦æ·»åŠ å¯¹åº”æ•°æ®åº“çš„ |-- geeorm.go // 2. ä¸ç”¨æˆ·äº¤äº’çš„å…¥å£ï¼šäº¤äº’å‰çš„å‡†å¤‡å·¥ä½œï¼ˆæ¯”å¦‚è¿æ¥/æµ‹è¯•ï¼‰ï¼Œäº¤äº’åçš„æ”¶å°¾å·¥ä½œï¼ˆå…³é—­è¿æ¥ï¼‰ |-- schema // 4. è´Ÿè´£ å¯¹è±¡ --\u003e è¡¨ çš„è½¬æ¢ | `-- schema.go // schemaå°±æ˜¯å­˜æ”¾ è¦è½¬æ¢æˆçš„è¡¨ çš„ä¿¡æ¯ `-- session // 1. ç”¨æ¥å’Œæ•°æ®åº“äº¤äº’ |-- hooks.go // é’©å­ |-- raw.go // ç›´æ¥è°ƒç”¨ SQL è¯­å¥è¿›è¡ŒåŸç”Ÿäº¤äº’çš„éƒ¨åˆ† |-- record.go // ç”¨æˆ·ç›´æ¥è°ƒç”¨çš„å¢åˆ æŸ¥æ”¹æ¥å£ |-- record_test.go |-- table.go // \"è¡¨\"çš„å¢åˆ æŸ¥ `-- transaction.go // äº‹åŠ¡ è¡¨ç»“æ„æ˜ å°„ é—®ï¼šæ€ä¹ˆå®ç°çš„ä»ç»“æ„ä½“å¯¹è±¡åˆ°è¡¨çš„æ˜ å°„ï¼Ÿ åœ¨schema.goä¸­ã€‚ åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€å¼ è¡¨éœ€è¦å“ªäº›è¦ç´ å‘¢ï¼Ÿ è¡¨å(table name) â€”â€” ç»“æ„ä½“å(struct name) å­—æ®µåå’Œå­—æ®µç±»å‹ â€”â€” æˆå‘˜å˜é‡å’Œç±»å‹ã€‚ é¢å¤–çš„çº¦æŸæ¡ä»¶(ä¾‹å¦‚éç©ºã€ä¸»é”®ç­‰) â€”â€” æˆå‘˜å˜é‡çš„Tagï¼ˆGo è¯­è¨€é€šè¿‡ Tag å®ç°ï¼ŒJavaã€Python ç­‰è¯­è¨€é€šè¿‡æ³¨è§£å®ç°ï¼‰ ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š type User struct { Name string `geeorm:\"PRIMARY KEY\"` Age int } æœŸæœ›å¯¹åº”çš„ schema è¯­å¥ï¼š CREATE TABLE `User` (`Name` text PRIMARY KEY, `Age` integer); ä¸»è¦é—®é¢˜æ˜¯ï¼šå¦‚ä½•é€šè¿‡ä»»æ„ç±»å‹çš„æŒ‡é’ˆï¼Œå¾—åˆ°å…¶å¯¹åº”çš„ç»“æ„ä½“çš„ä¿¡æ¯ã€‚ æ‰€ä»¥ ORM æ¡†æ¶çš„å®ç°éœ€è¦ä¾èµ–å¤§é‡çš„ Reflect æ“ä½œï¼š reflect.ValueOf() è·å–æ¥å£å¯¹åº”çš„åå°„å€¼ã€‚ reflect.Indirect() è·å–æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„åå°„å€¼ã€‚ (reflect.Type).Name() è¿”å›ç±»å(å­—ç¬¦ä¸²)ã€‚ (reflect.Type).Field(i) è·å–ç¬¬ i ä¸ªæˆå‘˜å˜é‡ã€‚ ä»¥ä¸Šæ˜¯ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚ä¸‹é¢æ˜¯æ˜ å°„æµç¨‹ï¼š // 1. è¦è½¬æ¢æˆçš„ // Schema ä»£è¡¨ä¸€å¼ è¡¨ type Schema struct { Model interface{} // è¢«æ˜ å°„çš„å¯¹è±¡ Name string // è¡¨å Fields []*Field // æ‰€æœ‰çš„å­—æ®µä¿¡æ¯ FieldNames []string // æ‰€æœ‰çš„å­—æ®µå fieldMap map[string]*Field // æ˜ å°„ [å­—æ®µå: *Field] } // Field å­—æ®µçš„ä¿¡æ¯ type Field struct { Name string // å­—æ®µå Type string // ç±»å‹ Tag string // çº¦æŸæ¡ä»¶ } // 2. è½¬æ¢å¯¹è±¡ï¼Œç¤ºä¾‹ type User struct { name string `geeorm:\"primary\"` age int `geeorm:\"age\"` } ç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼Œå°†Userè½¬æ¢æˆæ•°æ®åº“å¯¹è±¡Schemaï¼š // 1. å¾—åˆ°è¯¥ç»“æ„ä½“çš„ç±»å‹å…ƒæ•°æ® modelType := reflect.Indirect(reflect.ValueOf(dest)).Type() // 2. å»ºç«‹Schemaå®ä¾‹ï¼Œä¹Ÿå³æ˜ å°„åˆ°çš„è¡¨ç»“æ„ schema := \u0026Schema{ Model: dest, Name: modelType.Name(), // ç»“æ„ä½“çš„åç§°ä½œä¸ºè¡¨å fieldMap: make(map[string]*Field), } // 3. å¾—åˆ°è¯¥ç»“æ„ä½“æ‰€æœ‰çš„å­—æ®µ for i := 0; i \u003c modelType.NumField(); i++ { p := modelType.Field(i) field := \u0026Field{ Name: p.Name, Type: d.DataTypeOf(reflect.Indirect(reflect.New(p.Type))), // ä¼šé€šè¿‡reflect.Kindè½¬æ¢ç±»å‹ } } // 4. åœ¨tagä¸­å¯»æ‰¾çº¦æŸæ¡ä»¶ï¼Œæ¯”å¦‚ä¸»é”®ä¹‹ç±»çš„ if v, ok := p.Tag.Lookup(\"geeorm\"); ok { field.Tag = v } // 5. å¾€Schemaä¸­æ·»åŠ ç»“æ„ä½“çš„å­—æ®µ schema.Fields = append(schema.Fields, field) schema.FieldNames = append(schema.FieldNames, p.Name) schema.fieldMap[p.Name] = field ç„¶åå°±å¯ä»¥ç”¨ schema ä¸­çš„ä¿¡æ¯ï¼Œåœ¨æ•°æ®åº“ä¸­å»ºè¡¨ï¼š // CreateTable åˆ›å»ºè¡¨ func (s *Session) CreateTable() error { table := s.RefTable() // tableå°±æ˜¯schemaï¼Œä¹Ÿå°±æ˜¯è¡¨çš„ä¿¡æ¯ var columns []string for _, field := range table.Fields { columns = append(columns, fmt.Sprintf(\"%s %s %s\", field.Name, field.Type, field.Tag)) } desc := strings.Join(columns, \",\") _, err := s.Raw(fmt.Sprintf(\"CREATE TABLE %s (%s);\", table.Name, desc)).Exec() return err } æ’å…¥ã€æŸ¥è¯¢ é—®ï¼šå¦‚ä½•å®ç°å¸¦æœ‰æ¡ä»¶çš„æŒ‡ä»¤ï¼Ÿ é€šå¸¸selectå’Œinsertç­‰æŒ‡ä»¤éƒ½ä¼šå¸¦æœ‰æ¡ä»¶ï¼Œä»¥è¿™ä¿©ä¸ºä¾‹ã€‚ å¸¦æœ‰æ¡ä»¶çš„è¯­å¥ï¼Œ**éœ€è¦å¤šä¸ªå­å¥è¿›è¡Œæ‹¼åˆï¼**æ¯•ç«Ÿä½ ä¸èƒ½æ„é€ å‡ºæ‰€æœ‰ç»„åˆå‡ºæ¥çš„è¯­å¥ã€‚ ç”¨æˆ·ä¸»è¦é€šè¿‡clause.goï¼Œæ„é€ æœ€ç»ˆçš„sqlè¯­å¥ï¼š // Type SQL è¯­å¥ç§ç±» type Type int const ( INSERT Type = iota VALUES SELECT LIMIT WHERE ORDERBY UPDATE DELETE COUNT ) // Clause ç»„åˆ SQL ç‹¬ç«‹è¯­å¥ä¸ºå®Œæ•´å¥å­ type Clause struct { sql map[Type]string // SQL è¯­å¥ sqlVars map[Type][]interface{} // å‚æ•° } // Set æŒ‰ç…§SQLè¯­å¥çš„Nameå’Œå‚æ•°, å¾—åˆ°å­å¥ func (c *Clause) Set(name Type, vars ...interface{}) { if c.sql == nil { c.sql = make(map[Type]string) c.sqlVars = make(map[Type][]interface{}) } sql, vars := generators[name](vars...) c.sql[name] = sql c.sqlVars[name] = vars } // Build æŒ‰ç…§ä¼ å…¥å­å¥ç±»å‹çš„é¡ºåºï¼Œæ„é€ æœ€ç»ˆçš„SQLè¯­å¥ func (c *Clause) Build(orders ...Type) (string, []interface{}) { var sqls []string var vars []interface{} for _, order := range orders { if sql, ok := c.sql[order]; ok {","date":"2023-05-01","objectID":"/11-%E9%A1%B9%E7%9B%AE/:3:0","tags":["é¡¹ç›®"],"title":"ä¸ªäººé¡¹ç›®","uri":"/11-%E9%A1%B9%E7%9B%AE/"},{"categories":["é¢è¯•","é¡¹ç›®"],"content":"å››ã€è´Ÿè½½å‡è¡¡å™¨ ","date":"2023-05-01","objectID":"/11-%E9%A1%B9%E7%9B%AE/:4:0","tags":["é¡¹ç›®"],"title":"ä¸ªäººé¡¹ç›®","uri":"/11-%E9%A1%B9%E7%9B%AE/"},{"categories":["é€šç”¨"],"content":" å‰è¨€ï¼šæœ¬æ–‡è®°å½•å¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚ ","date":"2023-04-27","objectID":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/:0:0","tags":["è´Ÿè½½å‡è¡¡","è®¡ç®—æœºåŸºç¡€"],"title":"è´Ÿè½½å‡è¡¡ç®—æ³•","uri":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/"},{"categories":["é€šç”¨"],"content":"1. Power of 2 random choice P2Cç®—æ³•æ˜¯ä¸€ç§å·¥ä¸šä¸­è¿ç”¨è¾ƒå¤šçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå®ƒçš„åŸç†å¾ˆç®€å•ï¼Œå®ƒæœ‰ä¸¤æ¡åŸºæœ¬å®šå¾‹ï¼š è‹¥è¯·æ±‚IPä¸ºç©ºï¼ŒP2Cå‡è¡¡å™¨å°†éšæœºé€‰æ‹©ä¸¤ä¸ªä»£ç†ä¸»æœºèŠ‚ç‚¹ï¼Œæœ€åé€‰æ‹©å…¶ä¸­è´Ÿè½½é‡è¾ƒå°çš„èŠ‚ç‚¹ï¼› è‹¥è¯·æ±‚IPä¸ä¸ºç©ºï¼ŒP2Cå‡è¡¡å™¨é€šè¿‡å¯¹IPåœ°å€ä»¥åŠå¯¹IPåœ°å€åŠ ç›è¿›è¡ŒCRC32å“ˆå¸Œè®¡ç®—ï¼Œåˆ™ä¼šå¾—åˆ°ä¸¤ä¸ª32bitçš„å€¼ï¼Œå°†å…¶å¯¹ä¸»æœºæ•°é‡è¿›è¡Œå–æ¨¡ï¼Œå³CRC32(IP) % len(hosts) ã€CRC32(IP + salt) % len(hosts)ï¼Œ æœ€åé€‰æ‹©å…¶ä¸­è´Ÿè½½é‡è¾ƒå°çš„èŠ‚ç‚¹ï¼› ","date":"2023-04-27","objectID":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/:0:1","tags":["è´Ÿè½½å‡è¡¡","è®¡ç®—æœºåŸºç¡€"],"title":"è´Ÿè½½å‡è¡¡ç®—æ³•","uri":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/"},{"categories":["é€šç”¨"],"content":"2. Least Load Least Loadä¹Ÿå°±æ˜¯æœ€å°è´Ÿè½½ç®—æ³•ï¼Œä¹Ÿæ˜¯éå¸¸ç»å…¸çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œåœ¨æœ€å°è´Ÿè½½ç®—æ³•ä¸­ï¼Œè´Ÿè½½å‡è¡¡å™¨å°†è¯·æ±‚å®šå‘åˆ°è´Ÿè½½æœ€å°çš„ç›®æ ‡ä¸»æœºä¸­ï¼› å¯¹äºæœ€å°è´Ÿè½½ç®—æ³•è€Œè¨€ï¼Œå¦‚æœæŠŠæ‰€æœ‰ä¸»æœºçš„è´Ÿè½½å€¼åŠ¨æ€å­˜å…¥åŠ¨æ€æ•°ç»„ä¸­ï¼Œå¯»æ‰¾è´Ÿè½½æœ€å°èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œå¦‚æœæŠŠä¸»æœºçš„è´Ÿè½½å€¼ç»´æŠ¤æˆä¸€ä¸ªçº¢é»‘æ ‘ï¼Œé‚£ä¹ˆå¯»æ‰¾è´Ÿè½½æœ€å°èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ©ç”¨çš„æ•°æ®ç»“æ„å«åš æ–æ³¢é‚£å¥‘å † ï¼Œå¯»æ‰¾è´Ÿè½½æœ€å°èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹æ–æ³¢é‚£å¥‘å †çš„åŸç†ï¼ ","date":"2023-04-27","objectID":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/:0:2","tags":["è´Ÿè½½å‡è¡¡","è®¡ç®—æœºåŸºç¡€"],"title":"è´Ÿè½½å‡è¡¡ç®—æ³•","uri":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/"},{"categories":["é€šç”¨"],"content":"3. ä¼ ç»Ÿä¸€è‡´æ€§å“ˆå¸Œ ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•ï¼Œå½“å“ˆå¸Œè¡¨æ”¹å˜å¤§å°æ—¶ï¼Œå¹³å‡åªéœ€è¦é‡æ–°æ˜ å°„n/mä¸ªé”®å€¼ï¼Œå…¶ä¸­nä¸ºå“ˆå¸Œè¡¨é”®å€¼çš„æ•°é‡ï¼Œmä¸ºå“ˆå¸Œè¡¨æ§½çš„æ•°é‡ã€‚ åœ¨ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡å™¨ä¸­ï¼Œä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ªä»£ç†èŠ‚ç‚¹æ‰€ç»„æˆï¼Œé€šè¿‡CRC32æ•£åˆ—ç®—æ³•å¯¹ä»£ç†ä¸»æœºèŠ‚ç‚¹çš„UUIDæˆ–èŠ‚ç‚¹çš„IPåœ°å€è¿›è¡Œè®¡ç®—ï¼Œå³**CRC32(IP)æˆ–CRC32(UUID)ï¼Œ**åˆ™ä¼šå¾—åˆ°ä¸€ç»„æ•£åˆ—å€¼ï¼Œè€Œè¿™ç»„æ•£åˆ—å€¼è¿æˆçš„ç¯ï¼Œç§°ä¸ºå“ˆå¸Œç¯ã€‚ å½“æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œè´Ÿè½½å‡è¡¡å™¨å°†è¯·æ±‚çš„IPè¿›è¡ŒCRC32å“ˆå¸Œè®¡ç®—è¿›è€Œå¾—åˆ°ä¸€ä¸ªæ•£åˆ—å€¼ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå°†ä»£ç†ä¸»æœºèŠ‚ç‚¹å’Œè¯·æ±‚IPçš„å“ˆå¸Œå€¼æ˜ å°„åˆ°å“ˆå¸Œç¯åï¼Œæ²¿ç€å“ˆå¸Œç¯é¡ºæ—¶é’ˆæ–¹å‘æŸ¥æ‰¾ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³è¯·æ±‚æ‰€è¢«è°ƒåº¦çš„ä»£ç†èŠ‚ç‚¹ã€‚ é€šè¿‡å¯¹ä»£ç†èŠ‚ç‚¹çš„å“ˆå¸Œå€¼æŒ‰å‡åºå»ºç«‹åŠ¨æ€æ•°ç»„ï¼Œå³å¯åœ¨O(logN)æ—¶é—´å¤æ‚åº¦çš„æƒ…å†µä¸‹é€šè¿‡äºŒåˆ†æœç´¢å¯ä»¥æ‰¾åˆ°è¢«è°ƒåº¦çš„ä»£ç†èŠ‚ç‚¹ã€‚ å½“ä»£ç†èŠ‚ç‚¹æ•°é‡è¶Šå°‘æ—¶ï¼Œè¶Šå®¹æ˜“å‡ºç°èŠ‚ç‚¹çš„å“ˆå¸Œå€¼åœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µã€‚è€Œé€šè¿‡å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼å¯ä»¥è§£å†³ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è´Ÿè½½ä¸å¹³è¡¡çš„é—®é¢˜ ã€‚é€šè¿‡å¯¹ä»£ç†ä¸»æœºçš„IPå¤–åŠ è™šæ‹Ÿåºå·çš„å½¢å¼ä½œå“ˆå¸Œè®¡ç®—ã€‚ å¦‚192.168.1.1çš„è™šæ‹ŸèŠ‚ç‚¹å¯èƒ½æ˜¯192.168.1.1#1ã€192.168.1.1#2ã€192.168.1.1#3ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè™šæ‹ŸèŠ‚ç‚¹è®¡ç®—å¾—åˆ°çš„CRC32å€¼ä¹Ÿæ˜ å°„åˆ°å“ˆå¸Œç¯ä¸­ã€‚ ä¸‹å›¾çš„ä¸‰ä¸ªèŠ‚ç‚¹H1ã€H2ã€H3å‡åŒ€ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼š ","date":"2023-04-27","objectID":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/:0:3","tags":["è´Ÿè½½å‡è¡¡","è®¡ç®—æœºåŸºç¡€"],"title":"è´Ÿè½½å‡è¡¡ç®—æ³•","uri":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/"},{"categories":["é€šç”¨"],"content":"4. æœ‰ç•Œè´Ÿè½½ä¸€è‡´æ€§å“ˆå¸Œ Googleæå‡ºçš„æœ‰ç•Œè´Ÿè½½ä¸€è‡´æ€§å“ˆå¸Œé€šè¿‡é™åˆ¶èŠ‚ç‚¹è´Ÿè½½ä¸Šé™çš„æ–¹å¼è§£å†³äº†å·¥ä½œèŠ‚ç‚¹è´Ÿè½½è¿‡é«˜çš„é—®é¢˜ã€‚å½“èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜æ—¶ï¼Œæœ‰ç•Œè´Ÿè½½ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•é€šè¿‡è½¬ç§»çƒ­ç‚¹çš„æ–¹å¼æ¥æå‡é›†ç¾¤æ•´ä½“çš„è´Ÿè½½å¹³è¡¡æ€§ã€‚ åœ¨æœ‰ç•Œè´Ÿè½½ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­R è¡¨ç¤ºä»£ç†ä¸»æœºèŠ‚ç‚¹çš„æ€»è´Ÿè½½é‡ï¼ŒTw è¡¨ç¤ºä»£ç†ä¸»æœºèŠ‚ç‚¹çš„æ•°é‡ï¼ŒL è¡¨ç¤ºå½“å‰æ‰€æœ‰ä»£ç†ä¸»æœºçš„å¹³å‡è´Ÿè½½é‡ï¼Œå³ï¼š Î± è¡¨ç¤ºä»£ç†ä¸»æœºæ‰€èƒ½æ‰§è¡Œçš„é¢å¤–ä¸Šé™ç³»æ•°ï¼ŒM åˆ™è¡¨ç¤ºæ¯ä¸ªä»£ç†ä¸»æœºæ‰€èƒ½æ‰¿å—çš„æœ€å¤§è´Ÿè½½é‡ï¼Œå³ï¼š å½“Î±è¶‹äº0æ—¶ï¼Œæœ‰ç•Œè´Ÿè½½ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°†ä¼šé€€åŒ–æˆæœ€å°è´Ÿè½½ç®—æ³• å½“Î±è¶‹äºæ­£æ— ç©·æ—¶ï¼Œç®—æ³•ä¼šé€€åŒ–æˆæ™®é€šæ€§è´¨çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚ å½“è¯·æ±‚IPçš„å“ˆå¸Œå€¼æ‰€è°ƒåº¦çš„ä»£ç†ä¸»æœºèŠ‚ç‚¹è¶…è¿‡æ‰€èƒ½æ‰¿å—çš„æœ€å¤§è´Ÿè½½é‡M æ—¶ï¼Œè´Ÿè½½å‡è¡¡å™¨åˆ™ä¼šæŒ‰é¡ºæ—¶é’ˆé€‰æ‹©ç¬¬ä¸€ä¸ªè´Ÿè½½é‡å°äºM å€¼çš„ä»£ç†ä¸»æœºèŠ‚ç‚¹ï¼š ","date":"2023-04-27","objectID":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/:0:4","tags":["è´Ÿè½½å‡è¡¡","è®¡ç®—æœºåŸºç¡€"],"title":"è´Ÿè½½å‡è¡¡ç®—æ³•","uri":"/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/"},{"categories":["Go","é¢è¯•"],"content":" å‰è¨€ï¼šç”¨æ¥è®°å½•Goçš„è¯­è¨€ç‰¹æ€§ï¼Œä¸»è¦å‚è€ƒä¸ºBç«™ã€Šå¹¼éºŸå®éªŒå®¤ã€‹åŠã€Šæ·±åº¦æ¢ç´¢Goè¯­è¨€ã€‹ã€‚ ä¸€ã€åŸºç¡€çŸ¥è¯† ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:0:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1 æ•°æ®ç»“æ„ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1.1 String ç¼–ç ï¼šå®šé•¿ç¼–ç éå¸¸æµªè´¹å†…å­˜ï¼Œæ‰€ä»¥é‡‡ç”¨å˜é•¿ç¼–ç ã€‚**é‚£ä¹ˆæ€ä¹ˆåˆ’åˆ†è¾¹ç•Œå‘¢ï¼Ÿ**æœ€é«˜å‡ ä½ç©ºå‡ºæ¥ä½œä¸ºæ ‡è¯†ä½ï¼Œæ ‡è®°è¯¥å­—ç¬¦å ç”¨å‡ ä¸ªå­—èŠ‚ã€‚ è¿™æ˜¯ Go é»˜è®¤çš„ç¼–ç æ–¹å¼ï¼šUTF-8 ç¼–ç ï¼š ==stringçš„ç»“æ„ï¼š== ä¸€ä¸ªèµ·å§‹åœ°å€ï¼šç”¨æ¥æ ‡è®°å­—ç¬¦ä¸²èµ·å§‹ä½ç½®ï¼›ä½†æ˜¯æ€ä¹ˆæ‰¾åˆ°ç»“å°¾å‘¢ï¼ŸC æ˜¯åœ¨å­—ç¬¦ä¸²ç»“å°¾å¤„æ”¾ä¸ª\\0ï¼Œä½†è¿™é™åˆ¶äº†å†…å®¹ä¸èƒ½å‡ºç°è¿™ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ Go å¹¶ä¸è¿™æ ·åšï¼› ä¸€ä¸ªå­—ç¬¦ä¸²é•¿åº¦ï¼šç”¨æ¥æ ‡è®°è¯¥å­—ç¬¦æœ‰å¤šé•¿(å­—èŠ‚ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸ªæ•°ï¼)ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæ‰¾åˆ°å­—ç¬¦ä¸²åœ¨å“ªç»“æŸäº†ã€‚ Go çš„å­—ç¬¦ä¸²å†…å®¹ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥ Go çš„ç¼–è¯‘å™¨ä¼šæŠŠå®šä¹‰å¥½çš„å­—ç¬¦ä¸²å†…å®¹åˆ†é…åˆ°åªè¯»å†…å­˜æ®µã€‚å¯ä»¥é€šè¿‡[]byte()å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚sliceï¼Œè¿™æ ·ä¼šä¸ºsliceå˜é‡é‡æ–°åˆ†é…ä¸€æ®µå†…å­˜ï¼Œå¹¶æ‹·è´ä¹‹å‰å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œå¯è„±ç¦»åªè¯»å†…å­˜çš„é™åˆ¶ã€‚ é—®ï¼šrune å’Œ byte çš„åŒºåˆ«ï¼Ÿ æœ¬è´¨åŒºåˆ«å°±æ˜¯ï¼š type byte = uint8 type rune = int32 rune ç­‰åŒäº int32ï¼Œå³4ä¸ªå­—èŠ‚é•¿åº¦ï¼Œå¸¸ç”¨æ¥å¤„ç† unicode æˆ– utf-8 å­—ç¬¦ã€‚æ¯”å¦‚ç”¨æ¥å¤„ç†ä¸­æ–‡å­—ç¬¦ã€‚ byte ç­‰åŒäº uint8ï¼Œå³ä¸€ä¸ªå­—èŠ‚é•¿åº¦ï¼Œå¸¸ç”¨æ¥å¤„ç† ascii å­—ç¬¦(å…±128ä¸ª)ã€‚ åœ¨goä¸­ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œéœ€è¦å…ˆå°†å­—ç¬¦ä¸²è½¬åŒ–æˆæ•°ç»„ï¼Œ[]byte æˆ– []runeï¼Œç„¶åå†è½¬æ¢æˆ string å‹ã€‚ str := \"ä½ å¥½ world\" // str[i] å…¶å®æ˜¯ byte for i := 0; i \u003c len(str); i++ { fmt.Printf(\"%c\", str[i]) // Ã¤Â½\u0026nbsp;Ã¥Â¥Â½ world } // ä½¿ç”¨rangeï¼Œå…¶å®æ˜¯ä½¿ç”¨runeç±»å‹æ¥ç¼–ç çš„ï¼Œruneç±»å‹ç”¨æ¥è¡¨ç¤ºutf8å­—ç¬¦ï¼Œä¸€ä¸ªruneå­—ç¬¦ç”±ä¸€ä¸ªæˆ–å¤šä¸ªbyteç»„æˆã€‚ for _, value := range str { fmt.Printf(\"%c\", value) // ä½ å¥½ world } ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:1","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1.2 Slice 1.1.2.1 æ•°æ®ç»“æ„ Slice æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼š å…ƒç´ å­˜å“ªé‡Œ(data) å­˜äº†å¤šå°‘ä¸ªå…ƒç´ (len) å¯ä»¥å­˜å¤šå°‘ä¸ªå…ƒç´ (cap) ä¾‹å¦‚ï¼š è‹¥é€šè¿‡var ints []intæˆ–newåˆ›å»ºæ•°ç»„ï¼Œdataæ˜¯è¯¥æ•°ç»„çš„èµ·å§‹åœ°å€ï¼Œä½†åˆå§‹åŒ–ä¸ºnilï¼Œlen=0ï¼Œcap=0ï¼Œå› ä¸ºä¸ä¼šå¼€è¾Ÿåº•å±‚å†…å­˜ç»™å®ƒï¼› è‹¥é€šè¿‡make([]int, 2, 5)åˆ›å»ºæ•°ç»„ï¼Œä¸ä»…ä¼šåˆ†é…ä¸Šè¿°ä¸‰éƒ¨åˆ†ï¼Œè¿˜ä¼šå¼€è¾Ÿä¸€æ®µå†…å­˜ä½œä¸ºå®ƒçš„åº•å±‚æ•°ç»„ï¼› 1.1.2.2 append appendå¯ä»¥ä¸ºæ²¡æœ‰åº•å±‚å†…å­˜ç©ºé—´çš„Sliceå¼€è¾Ÿä¸€æ®µå†…å­˜ï¼Œå¹¶èµ‹å€¼ã€‚ å¯ä»¥æŠŠä¸åŒçš„Sliceå…³è”åˆ°åŒä¸€ä¸ªæ•°ç»„ï¼Œå®ƒä»¬ä¼šå…±ç”¨åº•å±‚æ•°ç»„ï¼Œä¾‹å¦‚ï¼š è¿™ä¸‰ä¸ªSliceè®¿é—®å’Œä¿®æ”¹çš„éƒ½æ˜¯åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œs1å’Œs2è‹¥è®¿é—®è¶…è¿‡å…¶lençš„å…ƒç´ ï¼Œä¼šäº§ç”Ÿè®¿é—®è¶Šç•Œã€‚ ä¸Šå›¾ä¸­ï¼Œè‹¥å†ç»™s2æ·»åŠ å…ƒç´ ä¼šæ€æ ·ï¼Ÿè¿™ä¸ªåº•å±‚æ•°ç»„æ˜¯ä¸èƒ½ç”¨äº†ï¼Œå¾—å¼€è¾Ÿæ–°æ•°ç»„ï¼ŒåŸæ¥çš„å…ƒç´ è¦æ‹·è´è¿‡å»ï¼Œè¿˜è¦æ·»åŠ æ–°å…ƒç´ ï¼Œæ­¤æ—¶s2å°±ä¸æŒ‡å‘åŸåº•å±‚æ•°ç»„äº†ï¼š 1.1.2.3 ==æ‰©å®¹è§„åˆ™== å½“ä½¿ç”¨appendæ·»åŠ å…ƒç´ ï¼Œå®¹é‡ä¸å¤Ÿæ—¶ï¼Œè¯¥æ€ä¹ˆé‡æ–°åˆ†é…å®¹é‡å‘¢ï¼Ÿ é¢„ä¼°æ‰©å®¹åçš„å®¹é‡ï¼š é¢„ä¼°è§„åˆ™ï¼š oldLen*2 \u003c capï¼šæ—§å®¹é‡*2 è¿˜æ˜¯å°äºæœ€å°‘è¦åˆ†é…çš„å®¹é‡ï¼Œé‚£ä¹ˆå°±åˆ†é…æœ€å°‘è¦åˆ†é…çš„å®¹é‡ï¼Œæ­¤å¤„ä¸º5ï¼› å¦åˆ™ï¼šoldLen \u003c 1024æ—¶ï¼Œç›´æ¥ *2ï¼ŒoldLen \u003e= 1024æ—¶ï¼Œå°±å…ˆæ‰© 1/4ã€‚ **é¢„ä¼°å…ƒç´ éœ€è¦å ç”¨å¤šå¤§å†…å­˜ï¼š**ç›´æ¥åˆ†é… é¢„ä¼°å®¹é‡ * å…ƒç´ ç±»å‹å¤§å° å†…å­˜å¯ä»¥å˜›ï¼Ÿä¸å¯ä»¥çš„ï¼å› ä¸ºä¸ä¸€å®šæœ‰åˆšå¥½ä¸€æ ·å¤§çš„é¢„ç½®è§„æ ¼çš„å†…å­˜å—ã€‚è¿™å°±æ˜¯ç¬¬ä¸‰æ­¥è¦åšçš„äº‹ã€‚ åŒ¹é…åˆ°åˆé€‚çš„å†…å­˜è§„æ ¼ï¼šä¹‹å‰ä¾‹å­ä¸­ï¼Œé¢„ä¼°å®¹é‡ä¸º 5ï¼Œ64ä½ä¸‹å°±éœ€è¦ç”³è¯· 40 å­—èŠ‚å†…å­˜ï¼Œè€Œæœ€æ¥è¿‘çš„å†…å­˜è§„æ ¼ä¸º 48 å­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯èƒ½è£… 6 ä¸ªè¯¥å…ƒç´ ï¼Œæ‰€ä»¥ æ‰©å®¹åå®¹é‡ä¸º 6ã€‚ åˆ†é…å®Œæ–°çš„åº•å±‚ Array ç©ºé—´åï¼Œå°±æŠŠåŸ Array ä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°çš„ä¸Šé¢ã€‚ é—®ï¼šSlice å’Œ Array æœ‰å•¥åŒºåˆ«ï¼Ÿ arr := [2]int{1, 2} // å£°æ˜äº†ä¸€ä¸ªæ•°ç»„ sli := []int{1, 2} // å£°æ˜äº†ä¸€ä¸ªSlice Array é•¿åº¦æ˜¯å›ºå®šçš„ï¼›Slice æ˜¯åŠ¨æ€æ•°ç»„ï¼Œé•¿åº¦å¯å˜ï¼› Slice æ˜¯åœ¨ Array åŸºç¡€ä¸Šå®ç°çš„ï¼ŒSliceæœ‰ä»¨å­—æ®µï¼Œé¦–ä¸ªå°±æ˜¯å¯¹åº•å±‚ Array çš„å¼•ç”¨ï¼Œæ‰€ä»¥ Slice æ˜¯å¼•ç”¨å‹ã€‚ åœ¨ C è¯­è¨€ä¸­ï¼Œæ•°ç»„å˜é‡æ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œä½†æ˜¯ Go è¯­è¨€ä¸­å¹¶ä¸æ˜¯ã€‚ ç”±äºå€¼ä¼ é€’ï¼Œæ•°ç»„è¿›è¡Œèµ‹å€¼ã€ä¼ é€’æ—¶ï¼Œå®é™…ä¸Šä¼šå¤åˆ¶æ•´ä¸ªæ•°ç»„ï¼š a := [...]int{1, 2, 3} // ... ä¼šè‡ªåŠ¨è®¡ç®—æ•°ç»„é•¿åº¦ b := a // å€¼æ‹·è´ï¼Œå¤åˆ¶æ•´ä¸ªæ•°ç»„ a[0] = 100 fmt.Println(a, b) // [100 2 3] [1 2 3] // ä¸ºäº†é¿å…å¤åˆ¶æ•°ç»„ï¼Œä¸€èˆ¬ä¼šä¼ é€’æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€‚ a := [...]int{1, 2, 3} b := \u0026a (*b)[0] = 100 fmt.Println(a, *b) // [100 2 3] [100 2 3] é—®ï¼šSlice çš„æ€§èƒ½é™·é˜±ï¼Ÿ å¤§é‡å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ åœ¨å·²æœ‰åˆ‡ç‰‡çš„åŸºç¡€ä¸Šè¿›è¡Œåˆ‡ç‰‡ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ã€‚å› ä¸ºåŸæ¥çš„åº•å±‚æ•°ç»„æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå†…å­˜ä¼šä¸€ç›´å ç”¨ï¼Œç›´åˆ°æ²¡æœ‰å˜é‡å¼•ç”¨è¯¥æ•°ç»„ã€‚å› æ­¤å¾ˆå¯èƒ½å‡ºç°è¿™ä¹ˆä¸€ç§æƒ…å†µï¼ŒåŸåˆ‡ç‰‡ç”±å¤§é‡çš„å…ƒç´ æ„æˆï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨åŸåˆ‡ç‰‡çš„åŸºç¡€ä¸Šåˆ‡ç‰‡ï¼Œè™½ç„¶åªä½¿ç”¨äº†å¾ˆå°ä¸€æ®µï¼Œä½†åº•å±‚æ•°ç»„åœ¨å†…å­˜ä¸­ä»ç„¶å æ®äº†å¤§é‡ç©ºé—´ï¼Œå¾—ä¸åˆ°é‡Šæ”¾ã€‚æ¯”è¾ƒæ¨èçš„åšæ³•ï¼Œä½¿ç”¨ copy æ›¿ä»£ re-sliceã€‚ // 1. æ— æ³•é‡Šæ”¾ originï¼Œé€ æˆå†…å­˜æµªè´¹ func lastNumsBySlice(origin []int) []int { return origin[len(origin)-2:] } // 2. è‡ªåŠ¨å›æ”¶ originï¼ŒèŠ‚çœå†…å­˜ func lastNumsByCopy(origin []int) []int { result := make([]int, 2) copy(result, origin[len(origin)-2:]) return result } ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:2","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1.3 ç»“æ„ä½“ä¸å†…å­˜å¯¹é½ å¤ªå¼ºäº†ï¼Œçœ‹è§†é¢‘å§å»ã€‚æ‹¨äº‘è§æ—¥ï¼ŒèŒ…å¡é¡¿å¼€ï¼ 1.1.3.1 è®¿é—®å†…å­˜ CPUæ˜¯å°†å†…å­˜åœ°å€é€šè¿‡åœ°å€æ€»çº¿ä¼ è¾“ç»™å†…å­˜ï¼Œå†…å­˜å‡†å¤‡å¥½æ•°æ®åé€šè¿‡æ•°æ®æ€»çº¿ä¼ ç»™CPUï¼š è‹¥æƒ³ä¸€æ¬¡è¯»å– 8å­—èŠ‚ çš„æ•°æ®ï¼Œå°±éœ€è¦64ä½æ•°æ®æ€»çº¿ï¼Œè¿™é‡Œçš„æ•°æ®æ€»çº¿ä½æ•°å°±æ˜¯æœºå™¨å­—é•¿ã€‚å¦‚ä½•èƒ½åªä¼ è¾“ä¸€ä¸ªåœ°å€ï¼Œè¯»å– 8å­—èŠ‚ æ•°æ®å‘¢ï¼Ÿ ä¸ºäº†æ›´é«˜çš„è®¿é—®æ•ˆç‡ï¼Œå†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼šå°±æ˜¯8ä¸ªchipæ’åˆ—åœ¨ä¸€èµ·(æ¯ä¸ªchipç”±8ä¸ªbankç»„æˆï¼Œå³ 1å­—èŠ‚ å†…å­˜)ï¼Œå…±ç”¨åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå„è‡ªå¯»æ‰¾ 1å­—èŠ‚ï¼Œç„¶åç»„åˆèµ·æ¥æˆä¸º 8å­—èŠ‚ï¼š æ‰€ä»¥æ¯æ¬¡è®¿é—®å†…å­˜éƒ½åªèƒ½ä»èµ·å§‹åœ°å€%8==0å¤„å¼€å§‹è®¿é—®ã€‚ 1.1.3.2 å†…å­˜å¯¹é½ ä¸ºäº†æé«˜è®¿é—®æ•ˆç‡(ä¿è¯ä¸€æ¬¡è¯»å–)ï¼Œç¼–è¯‘å™¨ä¼šæŠŠå„ç§ç±»å‹çš„æ•°æ®å®‰æ’åˆ°åˆé€‚çš„åœ°å€ï¼Œå¹¶å ç”¨åˆé€‚çš„é•¿åº¦ã€‚ å†…å­˜å¯¹é½è¦æ±‚æ•°æ®å­˜å‚¨èµ·å§‹åœ°å€ï¼ŒåŠå ç”¨çš„å­—èŠ‚æ•°éƒ½è¦æ˜¯å®ƒå¯¹é½è¾¹ç•Œçš„å€æ•°ï¼š 1.1.3.3 ç»“æ„ä½“å¯¹é½ å…±ä¸¤ä¸ªæ¡ä»¶ï¼š å„æˆå‘˜è¦å¯¹é½è¾¹ç•Œï¼› ç»“æ„ä½“æ€»å†…å­˜å¤§å° % å¯¹é½è¾¹ç•Œ == 0ã€‚ å¯ä»¥çœ‹å‡ºï¼Œç»“æ„ä½“å„å­—æ®µçš„é¡ºåºä¼šå½±å“ç»“æ„ä½“å ç”¨å†…å­˜çš„å¤§å°ã€‚ ==ä¸ºä»€ä¹ˆè¦æœ‰ç»“æ„ä½“æ€»å†…å­˜å¤§å° % å¯¹é½è¾¹ç•Œ == 0ï¼Ÿ== å¦‚ä¸‹æƒ…å†µï¼Œè‹¥ä¸æ˜¯æ•´æ•°å€çš„è¯ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªTçš„å†…å­˜æ˜¯å¯¹é½çš„ï¼Œç¬¬2ä¸ªTå°±æ²¡æœ‰å¯¹é½ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ ç­”ï¼šä¸ºäº†æé«˜è®¿é—®æ•ˆç‡ï¼Œç¼–è¯‘å™¨ä¼šæŠŠå„ç§ç±»å‹çš„æ•°æ®å®‰æ’åˆ°åˆé€‚çš„åœ°å€ï¼Œå¹¶å ç”¨åˆé€‚çš„é•¿åº¦ã€‚å†…å­˜å¯¹é½è¦æ±‚æ•°æ®å­˜å‚¨èµ·å§‹åœ°å€ï¼ŒåŠå ç”¨çš„å­—èŠ‚æ•°éƒ½è¦æ˜¯å®ƒ**==å¯¹å…¶è¾¹ç•Œ==çš„å€æ•°**ã€‚ é—®ï¼šå¦‚ä½•ç¡®å®šæ•°æ®ç±»å‹çš„å¯¹é½è¾¹ç•Œï¼Ÿ æœºå™¨å­—é•¿æ˜¯æœ€å¤§å¯¹é½è¾¹ç•Œï¼Œè€Œæ•°æ®ç±»å‹çš„å¯¹é½è¾¹ç•Œæ˜¯ï¼šmin(ç±»å‹å¤§å°, æœ€å¤§å¯¹é½è¾¹ç•Œ)ã€‚ ==ä¸ºä»€ä¹ˆä¸ç»Ÿä¸€æŒ‰ç…§æœ€å¤§å¯¹é½è¾¹ç•Œæˆ–ç±»å‹å¤§å°åˆ†é…å‘¢ï¼Ÿ== ä¸ºäº†å‡å°‘æµªè´¹ï¼Œæé«˜æ€§èƒ½ã€‚ å¦‚æœæ˜¯int8ç±»å‹ï¼Œåªå  1å­—èŠ‚ï¼Œè‹¥å¯¹é½åˆ°æœ€å¤§è¾¹ç•Œï¼Œå°±ä¼šæµªè´¹ 7å­—èŠ‚ï¼Œæ‰€ä»¥å¯¹é½åˆ° 1å­—èŠ‚ æœ€åˆé€‚ï¼› å¦‚æœæ˜¯int64ç±»å‹ï¼Œå ç”¨ 8å­—èŠ‚ï¼Œè‹¥å¯¹é½åˆ° 8å­—èŠ‚ï¼Œå¦‚ä¸‹æƒ…å†µä¸­å°±ä¼šæµªè´¹å‰é¢çš„ 6å­—èŠ‚ï¼Œæ‰€ä»¥å¯¹é½åˆ°æœ€å¤§å¯¹é½è¾¹ç•Œæœ€åˆé€‚ã€‚ å¦‚æœæ˜¯ç»“æ„ä½“ç±»å‹ï¼Œå¯¹é½è¾¹ç•Œå°±æ˜¯åŒ…å«ç±»å‹ä¸­æœ€å¤§çš„å¯¹é½è¾¹ç•Œã€‚ é—®ï¼šä¸ºä»€ä¹ˆè¦å†…å­˜å¯¹é½ï¼Ÿ æœ‰äº›CPUèƒ½è®¿é—®ä»»æ„åœ°å€ï¼Œæ˜¯å› ä¸ºåšäº†å¤„ç†ï¼šæ¯”å¦‚è¯»1-8çš„å†…å­˜ï¼šä¼šå…ˆè¯»0-7ï¼Œåªå–1-7ï¼Œå†è¯»8-15ï¼Œåªå–8ï¼Œç»„åˆèµ·æ¥å°±æ˜¯1-8ï¼Œä½†æ˜¯è¿™æ ·ä¼šé™ä½è®¿é—®æ•ˆç‡ã€‚ä¸ºäº†é¿å…è¿™æ ·è¯»å–ï¼Œå› æ­¤è¦å†…å­˜å¯¹é½ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:3","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1.4 Map 1.1.4.1 æ¦‚è¿° Mapä¸»è¦ç”±å“ˆå¸Œå‡½æ•°å’Œæ¡¶ç»„æˆã€‚ å“ˆå¸Œå‡½æ•°ç”¨æ¥å®ç°key-valueçš„æ˜ å°„ï¼Œæ˜¯å†³å®šå“ˆå¸Œè¡¨çš„è¯»å†™æ€§èƒ½çš„å…³é”®ï¼Œå“ˆå¸Œå‡½æ•°æ˜ å°„çš„ç»“æœä¸€å®šè¦å°½å¯èƒ½å‡åŒ€ã€‚å¦‚æœä½¿ç”¨ç»“æœåˆ†å¸ƒè¾ƒä¸ºå‡åŒ€çš„å“ˆå¸Œå‡½æ•°ï¼Œé‚£ä¹ˆå“ˆå¸Œçš„å¢åˆ æ”¹æŸ¥çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›ä½†æ˜¯å¦‚æœå“ˆå¸Œå‡½æ•°çš„ç»“æœåˆ†å¸ƒä¸å‡åŒ€ï¼Œé‚£ä¹ˆæ‰€æœ‰æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å¯èƒ½ä¼šè¾¾åˆ° O(n)ã€‚ æ¡¶ç”¨æ¥è§£å†³å“ˆå¸Œæ˜ å°„çš„å†²çªé—®é¢˜ï¼Œå¸¸è§æ–¹æ³•æœ‰ï¼šå¼€æ”¾å¯»å€æ³•å’Œæ‹‰é“¾æ³•ã€‚ ==Point 1ï¼š== å› ä¸ºå“ˆå¸Œä¹‹åçš„åœ°å€ç©ºé—´é€šå¸¸è¿œå¤§äºå®é™…åœ°å€ç©ºé—´ï¼Œå› æ­¤éœ€è¦å¯¹å“ˆå¸Œå€¼è¿›è¡Œå¤„ç†ï¼Œå¸¸ç”¨æœ‰ä¸¤ç§æ–¹æ³•ï¼š å–æ¨¡æ³•ï¼šhash % mï¼› ä¸è¿ç®—(Goé‡‡ç”¨)ï¼šhash \u0026 (m-1)ã€‚è¿™é‡Œmå¿…é¡»æ˜¯2çš„æ•´æ•°æ¬¡å¹‚ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ä¸ä¼šå‡ºç°ç©ºæ¡¶ã€‚ ==Point 2ï¼š== ä¸Šè¿°å¯¹å“ˆå¸Œå€¼çš„æ“ä½œä¼šé€ æˆå“ˆå¸Œå†²çªï¼Œå› æ­¤éœ€è¦å¯¹å“ˆå¸Œå†²çªè¿›è¡Œå¤„ç†ï¼Œå¸¸ç”¨æœ‰ä¸¤ç§æ–¹æ³•ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š å¼€æ”¾å¯»å€æ³•ï¼š å†™å…¥ï¼šå¯¹å½“å‰å…ƒç´ è¿›è¡Œå“ˆå¸Œæ˜ å°„å¾—åˆ°åœ°å€ï¼Œè‹¥è¯¥åœ°å€ç©ºé—²ï¼Œå¯ä»¥ç›´æ¥å¡«å…¥ï¼›è‹¥å·²è¢«å ç”¨ï¼Œåˆ™éœ€è¦å°†å½“å‰å…ƒç´ åˆ†é…åœ¨è¯¥åœ°å€åçš„ç©ºé—²åœ°å€ï¼› **è¯»å–ï¼š**è‹¥æ˜ å°„åœ°å€ä¸­å­˜å‚¨å…ƒç´ çš„Keyä¸å½“å‰å…ƒç´ çš„Keyä¸åŒï¼Œåˆ™éœ€è¦éå†è¯¥åœ°å€ä¹‹åçš„åœ°å€ç©ºé—´ï¼Œç›´åˆ°åœ°å€ä¸ºç©ºæˆ–æ‰¾åˆ°ç›®æ ‡Keyã€‚ æ‹‰é“¾æ³•ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š å†™å…¥ï¼šå¯¹å½“å‰å…ƒç´ è¿›è¡Œå“ˆå¸Œæ˜ å°„å¾—åˆ°åœ°å€ï¼Œè‹¥è¯¥åœ°å€ç©ºé—²ï¼Œå¯ä»¥ç›´æ¥å¡«å…¥ï¼›è‹¥å·²è¢«å ç”¨ï¼Œåˆ™éœ€è¦åœ¨é“¾è¡¨çš„æœ«å°¾è¿½åŠ æ–°çš„é”®å€¼å¯¹ï¼› **è¯»å–ï¼š**éå†æ˜ å°„åœ°å€çš„é”®å€¼å¯¹é“¾è¡¨ï¼Œç›´åˆ°æœç´¢åˆ°ç›¸åŒçš„Key(å­˜åœ¨)æˆ–é“¾è¡¨æœ«å°¾(ä¸å­˜åœ¨)ã€‚ 1.1.4.2 æ•°æ®ç»“æ„ runtime.hmap æ˜¯æœ€æ ¸å¿ƒçš„ç»“æ„ä½“ï¼š type hmap struct { count int // è®°å½• å·²å­˜å‚¨é”®å€¼å¯¹çš„æ•°ç›® flags uint8 B uint8 // è®°å½• æ¡¶(buckets)çš„æ•°ç›®æ˜¯2çš„å¤šå°‘æ¬¡å¹‚ noverflow uint16 // è®°å½• ä½¿ç”¨çš„æº¢å‡ºæ¡¶çš„æ•°ç›® hash0 uint32 // å“ˆå¸Œçš„ç§å­ï¼Œä¸ºå“ˆå¸Œå‡½æ•°çš„ç»“æœå¼•å…¥éšæœºæ€§ buckets unsafe.Pointer // è®°å½• æ¡¶çš„ä½ç½® oldbuckets unsafe.Pointer // è®°å½• æ‰©å®¹é˜¶æ®µæ—§æ¡¶çš„ä½ç½®ï¼Œå¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠ nevacuate uintptr // è®°å½• æ‰©å®¹é˜¶æ®µæ—§æ¡¶è¿ç§»è¿›åº¦ï¼šä¸‹ä¸€ä¸ªè¦è¿›è¡Œè¿ç§»çš„æ—§æ¡¶ç¼–å· extra *mapextra // è®°å½• æº¢å‡ºæ¡¶ç›¸å…³ä¿¡æ¯ } // è®°å½•æº¢å‡ºæ¡¶ç›¸å…³ä¿¡æ¯ type mapextra struct { overflow *[]*bmap // è®°å½• ç›®å‰å·²è¢«ä½¿ç”¨çš„æº¢å‡ºæ¡¶çš„åœ°å€ oldoverflow *[]*bmap // è®°å½• æ‰©å®¹é˜¶æ®µæ—§æ¡¶ä½¿ç”¨åˆ°çš„æº¢å‡ºæ¡¶çš„åœ°å€ nextOverflow *bmap // ä¸‹ä¸€ä¸ªç©ºé—²æº¢å‡ºæ¡¶ } type bmap struct { topbits [8]uint8 // æ¯ä¸ªtopbitéƒ½æ˜¯å¯¹åº”hashå€¼çš„é«˜8ä½ï¼Œç´¢å¼• keys [8]keytype values [8]valuetype pad uintptr overflow uintptr // æº¢å‡ºæ¡¶ï¼Œå¸ƒå±€ä¸å¸¸è§„bmapç›¸åŒï¼Œæ˜¯ä¸ºäº†å‡å°‘æ‰©å®¹æ¬¡æ•° } Goè¯­è¨€ä¸­ï¼ŒMapç±»å‹çš„å˜é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘hmapç»“æ„ä½“çš„æŒ‡é’ˆã€‚ ä½¿ç”¨çš„æ¡¶çš„æ•°æ®ç»“æ„ä¸ºbmapç»“æ„ï¼Œæ¯ä¸€ä¸ªbmapéƒ½èƒ½å­˜å‚¨8ä¸ªé”®å€¼å¯¹ï¼Œå½“å“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„æ•°æ®è¿‡å¤šï¼Œå•ä¸ªæ¡¶å·²ç»è£…æ»¡æ—¶å°±ä¼šä½¿ç”¨ extra.nextOverflow ä¸­çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ã€‚éšç€å“ˆå¸Œè¡¨å­˜å‚¨çš„æ•°æ®é€æ¸å¢å¤šï¼Œæˆ‘ä»¬ä¼šæ‰©å®¹å“ˆå¸Œè¡¨æˆ–è€…ä½¿ç”¨æ›´å¤šæº¢å‡ºæ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ã€‚ 1.1.4.3 åˆå§‹åŒ– ==å­—é¢é‡ï¼š== Goè¯­è¨€ä¸­é€šè¿‡key: valueçš„æ–¹æ³•è¡¨ç¤ºé”®å€¼å¯¹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆå§‹åŒ–ï¼š hash := map[string]int{ \"1\": 2, \"3\": 4, \"5\": 6, } å½“**å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡ \u003c= 25 **æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“è½¬æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼Œå°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼š hash := make(map[string]int, 3) hash[\"1\"] = 2 hash[\"3\"] = 4 hash[\"5\"] = 6 å½“**å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡ \u003e 25 **æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“è½¬æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼Œå°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼š hash := make(map[string]int, 26) vstatk := []string{\"1\", \"2\", \"3\", ... ï¼Œ \"26\"} vstatv := []int{1, 2, 3, ... , 26} for i := 0; i \u003c len(vstak); i++ { hash[vstatk[i]] = vstatv[i] } ==è¿è¡Œæ—¶ï¼š== æ ¹æ®ä¼ å…¥çš„Bæ¥ç¡®å®šéœ€è¦åˆ›å»ºçš„æ¡¶çš„æ•°é‡ï¼š è‹¥æ¡¶çš„æ•°é‡ \u003c 2^4ï¼Œæ­¤æ—¶è®¤ä¸ºæ•°æ®é‡è¾ƒå°ï¼Œä½¿ç”¨æº¢å‡ºæ¡¶çš„æ¦‚ç‡è¾ƒä½ï¼Œå› æ­¤ä¸åˆ›å»ºæº¢å‡ºæ¡¶ï¼› è‹¥æ¡¶çš„æ•°é‡ \u003e 2^4ï¼Œä¼šé¢å¤–åˆ›å»º2^(B-4)ä¸ªæº¢å‡ºæ¡¶ã€‚ **æ³¨æ„ï¼š**æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ç©ºé—´æ˜¯è¿ç»­çš„ã€‚ 1.1.4.4 è¯»å†™æ“ä½œ ==è®¿é—®ï¼š== å…±æœ‰ä¸¤ç§è®¿é—®æ–¹å¼ï¼š v := hash[key] // =\u003e v := *mapaccess1(maptype, hash, \u0026key) v, ok := hash[key] // =\u003e v, ok := mapaccess2(maptype, hash, \u0026key) èµ‹å€¼è¯­å¥å·¦ä¾§æ¥å—å‚æ•°çš„ä¸ªæ•°ä¼šå†³å®šä½¿ç”¨çš„è¿è¡Œæ—¶æ–¹æ³•ï¼š å½“æ¥å—ä¸€ä¸ªå‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨ runtime.mapaccess1ï¼Œè¯¥å‡½æ•°ä»…ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ç›®æ ‡å€¼çš„æŒ‡é’ˆï¼ˆæ„Ÿè§‰è¿™é‡Œçš„æŒ‡é’ˆå¹¶ä¸æ˜¯ä¸€ä¸ªåœ°å€ï¼Œæ„Ÿè§‰è¿˜æ˜¯ç›®æ ‡å€¼ï¼‰ï¼› å½“æ¥å—ä¸¤ä¸ªå‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨ runtime.mapaccess2ï¼Œé™¤äº†è¿”å›ç›®æ ‡å€¼ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šè¿”å›ä¸€ä¸ªç”¨äºè¡¨ç¤ºå½“å‰é”®å¯¹åº”çš„å€¼æ˜¯å¦å­˜åœ¨çš„ bool å€¼ã€‚ æŸ¥æ‰¾è¿‡ç¨‹â­ï¼šå“ˆå¸Œä¼šä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­çš„æ•°æ®ï¼Œå®ƒä¼šå…ˆæ¯”è¾ƒå“ˆå¸Œçš„é«˜ 8 ä½å’Œæ¡¶ä¸­å­˜å‚¨çš„ tophash(==å‡å°‘keyçš„å¯¹æ¯”æ¬¡æ•°ï¼Œç¼©å°æŸ¥æ‰¾æˆæœ¬==)ï¼Œåæ¯”è¾ƒä¼ å…¥çš„å’Œæ¡¶ä¸­çš„key(==å› æ­¤keyéœ€è¦æ˜¯å¯æ¯”è¾ƒç±»å‹==)ä»¥åŠ é€Ÿæ•°æ®çš„è¯»å†™ã€‚ æ¯ä¸€ä¸ªæ¡¶éƒ½æ˜¯ä¸€æ•´ç‰‡çš„å†…å­˜ç©ºé—´ï¼Œå½“å‘ç°æ¡¶ä¸­çš„ tophash ä¸ä¼ å…¥é”®çš„ tophash åŒ¹é…ä¹‹åï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æŒ‡é’ˆå’Œåç§»é‡è·å–å“ˆå¸Œä¸­å­˜å‚¨çš„é”® keys[x] å¹¶ä¸ key æ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ç›¸åŒå°±ä¼šè·å–ç›®æ ‡å€¼çš„æŒ‡é’ˆ values[x] å¹¶è¿”å›ã€‚ ==å†™å…¥ï¼š== é¦–å…ˆä¼šæ ¹æ®ä¼ å…¥çš„keyæ‹¿åˆ°å¯¹åº”çš„å“ˆå¸Œå’Œæ¡¶ï¼Œç„¶åé€šè¿‡éå†æ¯”è¾ƒæ¡¶ä¸­å­˜å‚¨çš„ tophash å’Œkeyçš„å“ˆå¸Œï¼Œ å¦‚æœå½“å‰é”®å€¼å¯¹åœ¨å“ˆå¸Œä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›ç›®æ ‡åŒºåŸŸçš„å†…å­˜åœ°å€ï¼› å¦‚æœå½“å‰é”®å€¼å¯¹åœ¨å“ˆå¸Œä¸­ä¸å­˜åœ¨ï¼Œå“ˆå¸Œä¼šä¸ºæ–°é”®å€¼å¯¹è§„åˆ’å­˜å‚¨çš„å†…å­˜åœ°å€å¹¶å­˜å…¥ã€‚ 1.1.4.5 â­æ‰©å®¹ é™¤äº†ç”¨æ•£åˆ—å‡åŒ€çš„å“ˆå¸Œå‡½æ•°æ¥æé«˜è¯»å†™æ€§èƒ½ï¼Œè¿˜å¯ä»¥é€šè¿‡å¯¹åœ°å€ç©ºé—´é€‚æ—¶æ‰©å®¹å‡å°‘å“ˆå¸Œå†²çªä»¥æé«˜æ€§èƒ½ã€‚ è´Ÿè½½å› å­ï¼šcount/(2^B)ï¼Œå³å­˜å‚¨é”®å€¼å¯¹çš„æ•°ç›®/æ¡¶çš„æ•°ç›®ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚ä¸éš¾ç†è§£ï¼Œè£…è½½å› å­è¶Šå¤§ï¼Œå“ˆå¸Œçš„è¯»å†™æ€§èƒ½å°±è¶Šå·®ã€‚ æ‰©å®¹è§„åˆ™ï¼š count/(2^B) \u003e 6.5 â€“\u003e ç¿»å€æ‰©å®¹(hamp.B++)ï¼› ä½¿ç”¨äº†\"è¿‡å¤š\"çš„æº¢å‡ºæ¡¶ -\u003e ç­‰é‡æ‰©å®¹ã€‚ æ³¨ï¼šâ€œè¿‡å¤šâ€ æŒ‡ï¼š 1. `B \u003c= 15`æ—¶ï¼Œ`noverflow \u003e= 2^B`ï¼› 1. `B \u003e 15`æ—¶ï¼Œ`noverflow \u003e= 2^15`ã€‚ **ç¿»å€æ‰©å®¹ï¼š**ä¼šåˆ›å»ºæ—§æ¡¶æ•°ç›®2å€çš„æ–°æ¡¶ï¼Œç„¶åå°†æ—§æ¡¶ä¸­çš„é”®å€¼å¯¹åˆ†æµåˆ°å¯¹åº”çš„ä¸¤ä¸ªæ–°æ¡¶ä¸­ï¼Œb = hash(key) \u0026 (2^B-1)ï¼Œ(è¿™ä¸ªåœ°æ–¹å¾ˆæœ‰æ„æ€)ã€‚ ç­‰é‡æ‰©å®¹ï¼šæ‰€è°“ç­‰é‡æ‰©å®¹å°±æ˜¯åˆ›å»ºå’Œæ—§æ¡¶æ•°ç›®ä¸€æ ·å¤šçš„æ–°æ¡¶ï¼Œç„¶åæŠŠåŸæ¥çš„é”®å€¼å¯¹è¿ç§»åˆ°æ–°æ¡¶ä¸­ã€‚**è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š**æ—¢ç„¶æ˜¯ç­‰é‡çš„ï¼Œé‚£ä½•å¿…æ‰©å®¹å‘¢ï¼Ÿ **ç­”ï¼š**å½“å‘ç”Ÿå¤§è§„æ¨¡åˆ é™¤æ“ä½œæ—¶ï¼Œæ—§æ¡¶ä¸­å­˜æ”¾çš„é”®å€¼å¯¹å¯èƒ½éå¸¸ç¨€ç–ï¼Œå› æ­¤ä¸ºäº†ç´§å‡‘å†…å­˜ï¼Œéœ€è¦å°†è¿™äº›é”®å€¼å¯¹é‡æ–°æ’åˆ—åˆ°æ–°æ¡¶ä¸­ã€‚ ==Point 3== æ‰©å®¹æ—¶ï¼Œéœ€è¦æŠŠæ—§æ¡¶ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°æ¡¶ï¼Œä½†å¹¶ä¸éœ€è¦ä¸€æ¬¡æ€§è¿ç§»å®Œã€‚ æ¸è¿›å¼æ‰©å®¹ï¼šæŠŠé”®å€¼å¯¹è¿ç§»çš„æ—¶é—´åˆ†æ‘Šåˆ°å¤šæ¬¡å“ˆå¸Œè¡¨æ“ä½œä¸­ï¼Œå¯ä»¥é¿å…ç¬æ—¶çš„æ€§èƒ½æŠ–åŠ¨ã€‚åœ¨å“ˆå¸Œè¡¨æ¯æ¬¡è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°å½“å‰å¤„äºæ‰©å®¹é˜¶æ®µï¼Œå°±å®Œæˆä¸€éƒ¨åˆ†é”®å€¼å¯¹è¿ç§»ä»»åŠ¡ï¼Œç›´åˆ°æ‰€æœ‰çš„æ—§æ¡¶è¿ç§»å®Œæ¯•ã€‚ **å…·ä½“è¿‡ç¨‹ï¼š**æ‰©å®¹æ—¶ï¼Œå­—æ®µoldbucketsæŒ‡å‘æ—§æ¡¶ï¼Œnevacuateè®°å½•ä¸‹ä¸€ä¸ªå¾…è¿ç§»çš„æ—§æ¡¶ã€‚ ä¸ªäººè§‰å¾—ï¼ŒGoæœ¬è´¨ä¸Šè¿˜æ˜¯æ‹‰é“¾æ³•ï¼Œä½†æ˜¯å®ƒåšäº†ä¸€äº›å†…å­˜ä¸Šçš„ä¼˜åŒ–ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œç»™æ¯ä¸ªæ¡¶é¢„å…ˆåˆ†é…å¯ä»¥æ”¾8ä¸ªæ•°æ®çš„ç©ºé—´ï¼Œå’Œä¼ ç»Ÿçš„æ‹‰é“¾æ³•ç›¸æ¯”ï¼Œå¥½å¤„å°±æ˜¯ä¸éœ€è¦é¢‘ç¹çš„åˆ†é…å†…å­˜ï¼ŒåŒæ—¶åœ¨æŸäº›æé™æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥èŠ‚çœä¸€äº›ç©ºé—´ï¼Œä¼ ç»Ÿçš„æ‹‰é“¾æ³•è¿˜éœ€è¦å­˜æ”¾å‰åæ•°æ®çš„æŒ‡é’ˆï¼Œåœ¨64ä½æœºå™¨ä¸Šåˆæ˜¯16ä¸ªå­—èŠ‚çš„å¼€é”€ï¼Œä½†æ˜¯ç”¨æ•°ç»„çš„æ–¹å¼ç»„ç»‡çš„è¯ï¼Œå°±ä¸éœ€è¦å­˜å‚¨å‰åçš„æŒ‡é’ˆã€‚å¦‚æœä¸€ä¸ªæ¡¶é‡Œé¢å­˜æ”¾äº†è¶…è¿‡8ä¸ªæ•°æ®ï¼Œè¿˜æ˜¯éœ€è¦å¦ä¸€ä¸ªbmapæ¥æ”¾å¤šä½™çš„æ•°ï¼Œç„¶åæŠŠä¸¤ä¸ªbmapè¿æ¥èµ·æ¥ã€‚æˆ‘è§‰å¾—å¯¹æ¯”ä¸€ä¸‹ï¼Œä¼ ç»Ÿçš„æ‹‰é“¾æ³•å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æ”¾ä¸€ä¸ªæ•°æ®ï¼Œè€Œgoæ˜¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ”¾8ä¸ªæ•°æ®ï¼Œè¿™8ä¸ªæ•°æ®æ˜¯æŒ‰ç…§æ•°ç»„æ¥ç»„ç»‡çš„ã€‚ 1.1.4.5 å°ç»“ Go è¯­è¨€ä½¿ç”¨æ‹‰é“¾æ³•æ¥è§£å†³å“ˆå¸Œç¢°æ’çš„é—®é¢˜å®ç°äº†å“ˆå¸Œè¡¨ï¼Œå®ƒçš„è®¿é—®ã€å†™å…¥å’Œåˆ é™¤ç­‰æ“ä½œéƒ½åœ¨ç¼–è¯‘æœŸé—´è½¬æ¢æˆäº†è¿è¡Œæ—¶çš„å‡½æ•°æˆ–è€…æ–¹æ³•ã€‚å“ˆå¸Œåœ¨æ¯ä¸€ä¸ªæ¡¶ä¸­å­˜å‚¨é”®å¯¹åº”å“ˆå¸Œçš„å‰ 8 ä½ï¼Œå½“å¯¹å“ˆå¸Œè¿›è¡Œæ“ä½œæ—¶ï¼Œè¿™äº› tophash å°±æˆä¸ºå¯ä»¥å¸®åŠ©å“ˆå¸Œå¿«é€Ÿéå†æ¡¶ä¸­å…ƒç´ çš„ç¼“å­˜ã€‚ å“ˆå¸Œè¡¨çš„æ¯ä¸ªæ¡¶éƒ½åªèƒ½å­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹ï¼Œä¸€æ—¦å½“å‰å“ˆå¸Œçš„æŸä¸ªæ¡¶è¶…å‡º 8 ä¸ªï¼Œæ–°çš„é”®å€¼å¯¹å°±ä¼šå­˜å‚¨åˆ°å“ˆå¸Œçš„æº¢å‡ºæ¡¶ä¸­ã€‚éšç€é”®å€¼å¯¹æ•°é‡çš„å¢åŠ ï¼Œæº¢å‡ºæ¡¶çš„æ•°é‡å’Œå“ˆå¸Œçš„è£…è½½å› å­ä¹Ÿä¼šé€æ¸å‡é«˜ï¼Œè¶…è¿‡ä¸€å®šèŒƒå›´å°±ä¼šè§¦å‘æ‰©å®¹ï¼Œæ‰©å®¹ä¼šå°†æ¡¶çš„æ•°é‡ç¿»å€ï¼Œå…ƒç´ å†åˆ†é…çš„è¿‡ç¨‹","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:4","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.1.5 sync.map é—®ï¼šsync.map å’Œ mutex+map æœ‰å•¥åŒºåˆ«ï¼Ÿsync.map ä¸ºå•¥è¦æœ‰ä¿© map(read+dirty)ï¼Ÿä¸€ä¸ªä¸è¡Œå—ï¼Ÿ ä¸€ä¸ªæ˜¯ä¸è¡Œçš„ï¼Œä½ æ€»ä¸èƒ½è¯»ä¸åŠ é”ï¼Œå†™åŠ é”å§ï¼Ÿè¿™æ ·ç…§æ ·ä¼šæœ‰å¹¶å‘è®¿é—®çš„é—®é¢˜(æ˜¯ä¼šæŠ¥é”™çš„)ã€‚ä½†æ˜¯å¦‚æœæ˜¯ read+dirtyï¼Œå°±å¯ä»¥å¯¹ read çš„æ‰€æœ‰æ“ä½œéƒ½ä¸åŠ é”ï¼Œå¯¹ dirty çš„æ‰€æœ‰æ“ä½œéƒ½è¦åŠ é”ï¼Œå°±å¯ä»¥é¿å…å¹¶å‘é—®é¢˜ã€‚æˆ‘è§‰å¾—æœ€å…³é”®çš„å·®åˆ«å°±æ˜¯è¿™ä¸ªåœ°æ–¹ï¼ä¹Ÿæ˜¯å¾ˆç²¾å¦™çš„åœ°æ–¹ï¼ å‚è€ƒæ–‡ç« ï¼š https://eddycjy.com/posts/go/sync-map/ https://mp.weixin.qq.com/s/vtvlye801ePWRY7RvtkDmA â­ å…ˆæ¥çœ‹çœ‹ sync.map çš„åº•å±‚æ•°æ®ç»“æ„ï¼š type Map struct { mu Mutex // ä¿æŠ¤ dirty å’Œ read read atomic.Value // readOnlyï¼Œåªè¯»ç±»å‹ï¼Œæ‰€ä»¥æ˜¯å¹¶å‘å®‰å…¨çš„ dirty map[interface{}]*entry // ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„åŸå§‹ map misses int // è®¡æ•°ä½œç”¨ã€‚å½“è¯»æ•°æ®æ—¶ï¼Œè¯¥å­—æ®µä¸åœ¨ read ä¸­ï¼Œå°è¯•ä» dirty ä¸­è¯»å–ï¼Œä¸ç®¡æ˜¯å¦åœ¨ dirty ä¸­è¯»å–åˆ°æ•°æ®ï¼Œmisses+1ã€‚å½“ misses ç´¯è®¡åˆ° len(dirty) æ—¶ï¼Œä¼šå°† dirty æ‹·è´åˆ° read ä¸­ï¼Œå¹¶å°† dirty æ¸…ç©ºï¼Œä»¥æ­¤æå‡è¯»æ€§èƒ½ã€‚ } // read çš„ç±»å‹ä¸º atomic.Valueï¼Œå®ƒä¼šé€šè¿‡ atomic.Value çš„ Load æ–¹æ³•å°†å…¶æ–­è¨€ä¸º readOnly å¯¹è±¡ read, _ := m.read.Load().(readOnly) // m ä¸º sync.Map // read çš„çœŸå®ç±»å‹å³æ˜¯ readOnly type readOnly struct { m map[interface{}]*entry // read ä¸­çš„ go å†…ç½® map ç±»å‹ï¼Œä½†æ˜¯å®ƒä¸éœ€è¦é”ã€‚ amended bool // å½“ sync.Map.diry ä¸­çš„åŒ…å«äº†æŸäº›ä¸åœ¨ m ä¸­çš„ key æ—¶ï¼Œamended çš„å€¼ä¸º true. } // map å­˜å‚¨çš„å€¼ç±»å‹æ˜¯ *entryï¼Œå®ƒåŒ…å«ä¸€ä¸ªæŒ‡é’ˆ pï¼ŒæŒ‡å‘ç”¨æˆ·å­˜å‚¨çš„ value å€¼ã€‚ type entry struct { p unsafe.Pointer // *interface{} } muï¼šä¿æŠ¤ dirtyï¼› readï¼šå­˜åªè¯»æ•°æ®ã€‚è¯»æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä½†å¦‚æœè¦æ›´æ–° readï¼Œåˆ™éœ€è¦åŠ é”ä¿æŠ¤ï¼› dirtyï¼šåŒ…å«æœ€æ–°å†™å…¥çš„æ•°æ®ã€‚å½“ misses è®¡æ•°è¾¾åˆ°ä¸€å®šå€¼ï¼Œå°†å…¶èµ‹å€¼ç»™ readï¼› missesï¼šè®¡æ•°ä½œç”¨ã€‚å½“è¯»æ•°æ®æ—¶ï¼Œè¯¥å­—æ®µä¸åœ¨ read ä¸­ï¼Œå°è¯•ä» dirty ä¸­è¯»å–ï¼Œä¸ç®¡æ˜¯å¦åœ¨ dirty ä¸­è¯»å–åˆ°æ•°æ®ï¼Œmisses+1ã€‚å½“ misses ç´¯è®¡åˆ° len(dirty) æ—¶ï¼Œä¼šå°† dirty æ‹·è´åˆ° read ä¸­ï¼Œå¹¶å°† dirty æ¸…ç©ºï¼Œä»¥æ­¤æå‡è¯»æ€§èƒ½ã€‚ 1.1.5.1 æŸ¥è¯¢æ•°æ® Load(): é¦–å…ˆï¼Œä»åªè¯»æ•°æ®readä¸­è¯»å–(å› ä¸ºä¸ç”¨åŠ é”)ï¼Œè‹¥æœ‰å°±ç›´æ¥è¿”å›ï¼Œè‹¥æ— å†ç»§ç»­å¾€ä¸‹ï¼› è‹¥readæ²¡æœ‰ï¼Œä¸”dirtyä¸­æœ‰æ–°æ•°æ®ï¼Œå°±ä¼šå»dirtyæŸ¥æ‰¾ï¼› å…ˆåŠ é”ï¼Œç„¶åå†æ¬¡æ£€æŸ¥readï¼Œè‹¥è¿˜æ²¡æœ‰ï¼Œæ‰çœŸæ­£å»dirtyæŸ¥æ‰¾ï¼Œå¹¶ä¸”å¯¹missè®¡æ•°å™¨+1(æ— è®ºæ˜¯å¦æ‰¾åˆ°)ï¼› è‹¥missçš„å€¼ \u003e= dirtyä¸­çš„å…ƒç´ æ•°é‡ï¼Œå°±æŠŠdirtyèµ‹ç»™readï¼Œå› ä¸ºç©¿é€æ¬¡æ•°å¤ªå¤šäº†ï¼Œç„¶åå°±å¯ä»¥æŠŠdirtyç½®ä¸ºç©ºäº†ã€‚ func (m *Map) Load(key interface{}) (value interface{}, ok bool) { // é¦–å…ˆä» m.read ä¸­é€šè¿‡ Load æ–¹æ³•å¾—åˆ° readOnly read, _ := m.read.Load().(readOnly) // ä» read ä¸­çš„ map ä¸­æŸ¥æ‰¾ key e, ok := read.m[key] // å¦‚æœ read æ²¡æœ‰ï¼Œå¹¶ä¸” dirty æœ‰æ–°æ•°æ®ï¼Œé‚£ä¹ˆå» dirty ä¸­æŸ¥æ‰¾ if !ok \u0026\u0026 read.amended { m.mu.Lock() // åŒé‡æ£€æŸ¥ï¼šé¿å…åœ¨æœ¬æ¬¡åŠ é”çš„æ—¶å€™ï¼Œæœ‰å…¶ä»– goroutine æ­£å¥½å°† Map ä¸­çš„ dirty æ•°æ®å¤åˆ¶åˆ°äº† read ä¸­ã€‚ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] // å¦‚æœ read ä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸” dirty ä¸­æœ‰æ–°æ•°æ® if !ok \u0026\u0026 read.amended { e, ok = m.dirty[key] // m è®¡æ•° +1 m.missLocked() } m.mu.Unlock() } if !ok { return nil, false } return e.load() // è¿”å›æŒ‡é’ˆæŒ‡å‘çš„å€¼ } func (m *Map) missLocked() { m.misses++ if m.misses \u003c len(m.dirty) { return } // å°†dirtyç½®ç»™readï¼Œå› ä¸ºç©¿é€æ¦‚ç‡å¤ªå¤§äº†(åŸå­æ“ä½œï¼Œè€—æ—¶å¾ˆå°) m.read.Store(readOnly{m: m.dirty}) m.dirty = nil // æ¸…ç©º dirty m.misses = 0 // é‡ç½® misses } 1.1.5.2 åˆ é™¤æ•°æ® Delete()ï¼š é¦–å…ˆï¼Œä»åªè¯»æ•°æ®readä¸­è¯»å–ï¼Œè‹¥æœ‰çš„è¯ï¼Œå°±ç›´æ¥ä»readä¸­\"åˆ é™¤\"(å¹¶éçœŸçš„åˆ é™¤ï¼Œåªæ˜¯æ ‡è®°ä¸€ä¸‹)ï¼› è‹¥readä¸­æ²¡æœ‰ï¼Œå°±è·å¾—é”ï¼Œç„¶åå†æ£€æŸ¥ä¸€éreadï¼Œç„¶åå°±ä»dirtyä¸­åˆ é™¤ï¼› func (m *Map) Delete(key interface{}) { // è¯»å‡º readï¼Œæ–­è¨€ä¸ºreadOnly ç±»å‹ read, _ := m.read.Load().(readOnly) e, ok := read.m[key] // å¦‚æœ read ä¸­æ²¡æœ‰ï¼Œå¹¶ä¸” dirty ä¸­æœ‰æ–°å…ƒç´ ï¼Œé‚£ä¹ˆå°±å» dirty ä¸­å»æ‰¾ã€‚è¿™é‡Œç”¨åˆ°äº† amendedï¼Œå½“ read ä¸ dirty ä¸åŒæ—¶ä¸º trueï¼Œè¯´æ˜ dirty ä¸­æœ‰ read æ²¡æœ‰çš„æ•°æ®ã€‚ if !ok \u0026\u0026 read.amended { m.mu.Lock() // å†æ£€æŸ¥ä¸€æ¬¡ï¼Œå› ä¸ºå‰æ–‡çš„åˆ¤æ–­å’Œé”ä¸æ˜¯åŸå­æ“ä½œï¼Œé˜²æ­¢æœŸé—´å‘ç”Ÿäº†å˜åŒ–ã€‚ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026\u0026 read.amended { // ç›´æ¥åˆ é™¤ delete(m.dirty, key) } m.mu.Unlock() } if ok { // å¦‚æœ read ä¸­å­˜åœ¨è¯¥ keyï¼Œåˆ™å°†è¯¥ value èµ‹å€¼ nil(é‡‡ç”¨æ ‡è®°çš„æ–¹å¼åˆ é™¤ï¼) e.delete() } } // å¦‚æœ read ä¸­æœ‰è¯¥é”®ï¼Œåˆ™ä» read ä¸­åˆ é™¤ï¼Œå…¶åˆ é™¤æ–¹å¼æ˜¯é€šè¿‡åŸå­æ“ä½œ func (e *entry) delete() (hadValue bool) { for { p := atomic.LoadPointer(\u0026e.p) // å¦‚æœ p æŒ‡é’ˆä¸ºç©ºï¼Œæˆ–è€…è¢«æ ‡è®°æ¸…é™¤ if p == nil || p == expunged { return false } // é€šè¿‡åŸå­æ“ä½œï¼Œå°† e.p æ ‡è®°ä¸º nil if atomic.CompareAndSwapPointer(\u0026e.p, p, nil) { return true } } } 1.1.5.3 å¢æ”¹æ•°æ® Store()ï¼š é¦–å…ˆï¼Œä»åªè¯»æ•°æ®readä¸­è·å–è¯¥keyï¼Œè‹¥å­˜åœ¨ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼Œå°±å°è¯•æ›´æ–°ï¼› å¦‚æœåœ¨readä¸­ä¸å­˜åœ¨æˆ–å·²è¢«æ ‡è®°åˆ é™¤ï¼Œå°±åœ¨dirtyä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å·²å­˜åœ¨ï¼Œå°±å°è¯•æ›´æ–°ï¼› è‹¥åœ¨dirtyä¸­ä¸å­˜åœ¨ï¼Œå°±åŠ å…¥dirtyï¼› func (m *Map) Store(key, value interface{}) { // å¦‚æœ m.read ä¸­å­˜åœ¨è¯¥é”®ï¼Œä¸”è¯¥é”®æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤(expunged) // åˆ™å°è¯•ç›´æ¥å­˜å‚¨(è§ entry çš„ tryStore æ–¹æ³•) // æ³¨æ„ï¼šå¦‚æœ m.dirty ä¸­ä¹Ÿæœ‰è¯¥é”®(key å¯¹åº”çš„ entry)ï¼Œç”±äºéƒ½æ˜¯é€šè¿‡æŒ‡é’ˆæŒ‡å‘ï¼Œæ‰€æœ‰ m.dirty ä¸­ä¹Ÿä¼šä¿æŒæœ€æ–° entry å€¼ã€‚ read, _ := m.read.Load().(readOnly) if e, ok := read.m[key]; ok \u0026\u0026 e.tryStore(\u0026value) { return } // å¦‚æœä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œå³ read ä¸å­˜åœ¨æˆ–è€…å·²ç»è¢«æ ‡è®°åˆ é™¤ m.mu.Lock() read, _ = m.read.Load().(readOnly) if e, ok := read.m[key]; ok { // read å­˜åœ¨è¯¥ key // å¦‚æœ entry è¢«æ ‡è®° expungeï¼Œåˆ™è¡¨æ˜ dirty æ²¡æœ‰ keyï¼Œå¯æ·»åŠ å…¥ dirtyï¼Œå¹¶æ›´æ–° entryã€‚ if e.unexpungeLocked() { // åŠ å…¥ dirty ä¸­ï¼Œè¿™å„¿æ˜¯æŒ‡é’ˆ m.dirty[key] = e } // æ›´æ–° entry æŒ‡å‘æ–°çš„ value åœ°å€ e.storeLocked(\u0026value) } else if e, ok := m.dirty[key]; ok { // read ä¸å­˜åœ¨è¯¥ keyï¼Œä½† dirty å­˜åœ¨è¯¥ keyï¼Œæ›´æ–° e.storeLocked(\u0026value) } else { // read å’Œ dirty éƒ½æ²¡æœ‰ // å¦‚æœ re","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:1:5","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2 è¯­è¨€åŸºç¡€ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.1 å‡½æ•°è°ƒç”¨ 1.2.1.1 æ ˆå¸§å¸ƒå±€ æŒ‰ç…§ç¼–ç¨‹è¯­è¨€å®šä¹‰çš„å‡½æ•°ï¼Œä¼šè¢«ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºä¸€å †æœºå™¨æŒ‡ä»¤ï¼Œå†™å…¥å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨è¿è¡Œæ—¶è¢«åŠ è½½åˆ°å†…å­˜ï¼Œä½äºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä»£ç æ®µã€‚ å½“å‡ºç°å‡½æ•°è°ƒç”¨æ—¶ï¼Œç¼–è¯‘å™¨å°±ä¼šå¯¹åº”ç”Ÿæˆä¸€æ¡callæŒ‡ä»¤ï¼Œç¨‹åºæ‰§è¡Œåˆ°è¿™æ¡æŒ‡ä»¤æ—¶ï¼Œå°±ä¼šè·³è½¬åˆ°å¯¹åº”å‡½æ•°å…¥å£å¤„æ‰§è¡Œï¼Œè€Œæ¯ä¸ªå‡½æ•°æœ€åéƒ½æœ‰ä¸€ä¸ªretæŒ‡ä»¤ï¼Œè´Ÿè´£åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåï¼Œè·³è½¬å›è°ƒç”¨å¤„ç»§ç»­æ‰§è¡Œã€‚ å‡½æ•°æ‰§è¡Œæ—¶éœ€è¦è¶³å¤Ÿçš„å†…å­˜ç©ºé—´æ¥å­˜æ”¾å±€éƒ¨å˜é‡ã€å‚æ•°ã€è¿”å›å€¼ç­‰æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯¹åº”åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ ˆã€‚ æ ˆçš„æ‰§è¡Œé¡ºåºæ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼Œæ‰€æœ‰å‡½æ•°çš„æ ˆå¸§æ ¼å¼éƒ½æ˜¯ç»Ÿä¸€çš„ã€‚æ‰§è¡Œåˆ°callæŒ‡ä»¤ä¼šåšä¸¤ä»¶äº‹æƒ…ï¼š é¦–å…ˆæ˜¯å°†ä¸‹ä¸€æ¡æŒ‡ä»¤å…¥æ ˆï¼Œä¹Ÿå³è¿”å›åœ°å€ï¼Œå½“æ‰§è¡Œå®Œè°ƒç”¨å‡½æ•°å°±ä¼šè·³è½¬å›è¿™é‡Œï¼› ç„¶åä¼šè·³è½¬åˆ°è¢«è°ƒç”¨å‡½æ•°å…¥å£å¤„å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡åç§»é‡+æ ˆæŒ‡é’ˆspå®Œæˆçš„ã€‚ æŒ‡ä»¤è¿è¡Œæ—¶ï¼ŒCPUç”¨ç‰¹å®šå¯„å­˜å™¨æ¥å­˜å‚¨è¿è¡Œæ—¶çš„æ ˆåŸºå’Œæ ˆæŒ‡é’ˆï¼ŒåŒæ—¶ä¹Ÿæœ‰æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ç”¨æ¥å­˜æ”¾ä¸‹ä¸€æ¡è¦è¿è¡Œçš„æŒ‡ä»¤ã€‚ Goè¯­è¨€ä¸­ä¸æ˜¯é€æ­¥æ‰©å¼ æ ˆå¸§çš„ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§åˆ†é…ã€‚ç„¶åé€šè¿‡æ ˆæŒ‡é’ˆ+åç§»å€¼ä½¿ç”¨æ ˆå¸§ã€‚ ==Pointï¼š== ä¸€æ¬¡æ€§åˆ†é…æ ˆå¸§ä¸»è¦æ˜¯ä¸ºäº†é¿å…æ ˆè®¿é—®è¶Šç•Œã€‚ è€ŒGoè¯­è¨€ç¼–è¯‘å™¨ä¼šåœ¨å‡½æ•°å¤´éƒ¨æ’å…¥æ£€æµ‹ä»£ç ï¼Œå½“å‘ç°éœ€è¦è¿›è¡Œ**â€œæ ˆå¢é•¿â€**ï¼Œå°±ä¼šå¦å¤–åˆ†é…ä¸€æ®µè¶³å¤Ÿå¤§çš„æ ˆç©ºé—´ï¼Œå¹¶æŠŠåŸæ¥æ ˆä¸Šçš„æ•°æ®æ‹·è´è¿‡æ¥ï¼ŒåŒæ—¶é‡Šæ”¾åŸæ¥é‚£æ®µæ ˆç©ºé—´ã€‚ **==callå’ŒretæŒ‡ä»¤==ï¼š**æ­¤å¤„æœ€å¥½æ˜¯çœ‹è§†é¢‘ç†è§£ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å­˜æ”¾åœ¨ä»£ç æ®µï¼Œæ‰€ç”¨çš„å‚æ•°ã€å˜é‡ç­‰å­˜æ”¾åœ¨æ ˆç©ºé—´ï¼Œå¯„å­˜å™¨æ˜¯æŒ‡å‘æ ˆç©ºé—´çš„ï¼ 1.2.1.2 ä¼ å‚ä¸è¿”å›å€¼ ==ä¼ å€¼ä¸ä¼ å¼•ç”¨ï¼š== **ä¼ å€¼ï¼š**å‡½æ•°è°ƒç”¨æ—¶ä¼šå¯¹å‚æ•°è¿›è¡Œæ‹·è´ï¼Œè¢«è°ƒç”¨æ–¹å’Œè°ƒç”¨æ–¹ä¸¤è€…æŒæœ‰ä¸ç›¸å…³çš„ä¸¤ä»½æ•°æ®ï¼› **ä¼ å¼•ç”¨ï¼š**å‡½æ•°è°ƒç”¨æ—¶ä¼šä¼ é€’å‚æ•°çš„æŒ‡é’ˆï¼Œè¢«è°ƒç”¨æ–¹å’Œè°ƒç”¨æ–¹ä¸¤è€…æŒæœ‰ç›¸åŒçš„æ•°æ®ï¼Œä»»æ„ä¸€æ–¹åšå‡ºçš„ä¿®æ”¹éƒ½ä¼šå½±å“å¦ä¸€æ–¹ã€‚ ä¸åŒè¯­è¨€ä¼šé€‰æ‹©ä¸åŒçš„æ–¹å¼ä¼ é€’å‚æ•°ï¼ŒGo è¯­è¨€é€‰æ‹©äº†ä¼ å€¼çš„æ–¹å¼ï¼Œæ— è®ºæ˜¯ä¼ é€’åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“è¿˜æ˜¯æŒ‡é’ˆï¼Œéƒ½ä¼šå¯¹ä¼ é€’çš„å‚æ•°è¿›è¡Œæ‹·è´ã€‚ ==ä¼ å‚ï¼š== **è¿‡ç¨‹ï¼š**ä¸‹å›¾swapå‡½æ•°å¹¶ä¸èƒ½å®ç°äº¤æ¢a, bçš„ä½œç”¨ã€‚ é¦–å…ˆéœ€è¦åˆ†é…mainçš„æ ˆå¸§ç©ºé—´ï¼Œå³BP of main å’Œ SP of mainä¸­é—´çš„ç©ºé—´ï¼› å°†mainä¸­çš„å±€éƒ¨å˜é‡å…¥æ ˆï¼› ä»å³è‡³å·¦ä¾æ¬¡å°†å‚æ•°å…¥æ ˆ(å€¼æ‹·è´)ï¼› callä¼šå°†è¿”å›åœ°å€å…¥æ ˆï¼Œå³return addrï¼› ç„¶åå°±æ˜¯swapçš„æ ˆå¸§äº†ï¼› å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œäº¤æ¢æ“ä½œåªæ˜¯å¯¹å‚æ•°(åŒæ—¶ä¹Ÿæ˜¯swapçš„å†…éƒ¨å˜é‡)è¿›è¡Œæ“ä½œï¼Œå¯¹mainä¸­åŸæœ¬çš„æ•°æ®å¹¶ä¸èƒ½é€ æˆå½±å“ï¼Œå› æ­¤äº¤æ¢å¤±è´¥ã€‚ ä¸‹å›¾swapå‡½æ•°èƒ½å®ç°äº¤æ¢a, bçš„ä½œç”¨ã€‚ å‰ä¸¤æ­¥åŒä¸Šï¼› ä»å³è‡³å·¦ä¾æ¬¡å°†å‚æ•°å…¥æ ˆï¼Œè¿™é‡ŒåŒæ ·æ˜¯å€¼æ‹·è´ï¼Œåªä¸è¿‡å€¼ä¸ºaã€bçš„åœ°å€ï¼› äº¤æ¢æ—¶ï¼Œæ˜¯ç›´æ¥å°†addrAå’ŒaddrBæŒ‡å‘çš„æ•°æ®è¿›è¡Œäº¤æ¢ï¼Œå› æ­¤å¯ä»¥äº¤æ¢æˆåŠŸã€‚ ==Pointï¼š== Go è¯­è¨€ä¸­ä¼ æŒ‡é’ˆä¹Ÿæ˜¯ä¼ å€¼ã€‚å°†æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ å…¥æŸä¸ªå‡½æ•°æ—¶ï¼Œå‡½æ•°å†…éƒ¨ä¼šå¤åˆ¶æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ä¼šåŒæ—¶å‡ºç°ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŸæœ‰çš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œåœ¨ä¼ é€’æ•°ç»„æˆ–è€…å†…å­˜å ç”¨éå¸¸å¤§çš„ç»“æ„ä½“æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æŒ‡é’ˆä½œä¸ºå‚æ•°ç±»å‹æ¥é¿å…å‘ç”Ÿæ•°æ®æ‹·è´è¿›è€Œå½±å“æ€§èƒ½ã€‚ ==è¿”å›å€¼ï¼š== é€šå¸¸è¿”å›å€¼æ˜¯é€šè¿‡å¯„å­˜å™¨è¿”å›ï¼Œä½†æ˜¯Goæ”¯æŒè¿”å›å¤šä¸ªè¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯æœ‰å¯èƒ½è¿”å›å€¼çš„æ•°ç›®å¤§äºå¯„å­˜å™¨ä¸ªæ•°ï¼Œå› æ­¤Goé€‰æ‹©åœ¨æ ˆä¸Šå­˜å‚¨è¿”å›å€¼ã€‚ **åŒ¿åè¿”å›å€¼ï¼š**ä¸‹å›¾è¿”å›ç»“æœä¸º1ã€‚ è¢«è°ƒç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œretä¼šç»™è¿”å›å€¼èµ‹å€¼ï¼Œå¹¶æ‰§è¡Œdeferå‡½æ•°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ˜¯å…ˆç»™è¿”å›å€¼èµ‹å€¼è¿˜æ˜¯å…ˆæ‰§è¡Œdeferå‡½æ•°å‘¢ï¼Ÿ **ç­”ï¼š**å…ˆç»™è¿”å›å€¼èµ‹å€¼ï¼Œå†æ‰§è¡Œdeferå‡½æ•°ã€‚ å‘½åè¿”å›å€¼ï¼š å’Œä¸Šè¾¹é‚£ä¸ªå®Œå…¨ç›¸åŒï¼Œåªæ”¹åŠ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè¿”å›ç»“æœä¸º2ã€‚==è¿™æ˜¯å› ä¸ºè¢«è°ƒç”¨å‡½æ•°çš„è¿”å›å€¼bä¸€ç›´åœ¨è°ƒç”¨è€…æ ˆå¸§ä¸­ã€‚== å‚æ•°ç©ºé—´åˆ†é…ï¼š è‹¥è°ƒç”¨å¤šä¸ªå‡½æ•°ï¼Œå°†ä»¥æœ€å¤§çš„å‚æ•°+è¿”å›å€¼ç©ºé—´ä¸ºæ ‡å‡†æ¥åˆ†é…ã€‚å¦‚ä¸‹å›¾ï¼Œå°†ä¼šæŒ‰ç…§Bçš„å‚æ•°+è¿”å›å€¼ç©ºé—´è¿›è¡Œåˆ†é…ï¼ŒBæ‰§è¡Œå®Œåï¼ŒCçš„å‚æ•°+è¿”å›å€¼ä¼šä»ä½åœ°å€åˆ°é«˜åœ°å€è¿›è¡Œåˆ†é…ï¼Œä¸æ»¡çš„ç©ºé—´å°±ç©ºç€ã€‚ 1.2.1.3 å°ç»“ Go é€šè¿‡æ ˆä¼ é€’å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œ==å‚æ•°å’Œè¿”å›å€¼å±…ç„¶æ˜¯åœ¨è°ƒç”¨è€…çš„æ ˆå¸§ä¸­ï¼ï¼ï¼==åœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰ä¼šåœ¨æ ˆä¸Šä¸ºè¿”å›å€¼åˆ†é…åˆé€‚çš„å†…å­˜ç©ºé—´ï¼Œéšåå°†å…¥å‚ä»å³åˆ°å·¦æŒ‰é¡ºåºå‹æ ˆå¹¶æ‹·è´å‚æ•°ï¼Œè¿”å›å€¼ä¼šè¢«å­˜å‚¨åˆ°è°ƒç”¨æ–¹é¢„ç•™å¥½çš„æ ˆç©ºé—´ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æ€»ç»“å‡ºä»¥ä¸‹å‡ æ¡è§„åˆ™ï¼š é€šè¿‡å †æ ˆä¼ é€’å‚æ•°ï¼Œå…¥æ ˆçš„é¡ºåºæ˜¯ä»å³åˆ°å·¦ï¼Œè€Œå‚æ•°çš„è®¡ç®—æ˜¯ä»å·¦åˆ°å³ï¼› å‡½æ•°è¿”å›å€¼é€šè¿‡å †æ ˆä¼ é€’å¹¶ç”±è°ƒç”¨è€…é¢„å…ˆåˆ†é…å†…å­˜ç©ºé—´ï¼› è°ƒç”¨å‡½æ•°æ—¶éƒ½æ˜¯ä¼ å€¼ï¼Œæ¥æ”¶æ–¹ä¼šå¯¹å…¥å‚è¿›è¡Œå¤åˆ¶å†è®¡ç®—ï¼› ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:1","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.2 é—­åŒ… å‡½æ•°ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå¯ä»¥åšå‡½æ•°è¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°å˜é‡ã€‚ç§°è¿™æ ·çš„å‚æ•°ã€è¿”å›å€¼æˆ–å˜é‡ä¸º**function value**ã€‚ function valueæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†æ˜¯å¹¶ä¸ç›´æ¥æŒ‡å‘å‡½æ•°æŒ‡ä»¤å…¥å£ï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ªruntime.funcvalçš„ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“é‡Œåªæœ‰ä¸€ä¸ªåœ°å€ï¼Œå°±æ˜¯è¿™ä¸ªäºŒå‡½æ•°æŒ‡ä»¤çš„å…¥å£åœ°å€ã€‚ å°†ä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™å¤šä¸ªå˜é‡ï¼Œè¿™äº›å˜é‡ä¼šå…±ç”¨åŒä¸€ä¸ªfuncvalã€‚ é‚£ä¹ˆæ—¢ç„¶funcvalä¸­åªæœ‰ä¸€ä¸ªåœ°å€ï¼Œä¸ºå•¥ä¸ç›´æ¥ä½¿ç”¨è¿™ä¸ªåœ°å€å‘¢ï¼Ÿ è¿™æ˜¯ä¸ºäº†å¤„ç†é—­åŒ…ã€‚ é—­åŒ…çš„ä¸€ä¸ªç¤ºä¾‹ï¼š Go è¯­è¨€ä¸­ï¼Œé—­åŒ…å°±æ˜¯æœ‰æ•è·åˆ—è¡¨çš„Function Valueã€‚æ•è·åˆ—è¡¨ä¸­å­˜å‚¨çš„å€¼ï¼Œé€šè¿‡funcvalçš„åœ°å€+åç§»é‡æ¥è·å–ã€‚ ==é—­åŒ…éœ€è¦ç»´æŒæ•è·å˜é‡åœ¨å¤–å±‚å‡½æ•°å’Œå†…å±‚å‡½æ•°ä¸­çš„ä¸€è‡´æ€§ã€‚== ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:2","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.3 æ–¹æ³• 1.2.3.1 æ–¹æ³•çš„æœ¬è´¨ å¦‚æœå®šä¹‰ä¸€ä¸ªç±»å‹Aï¼Œå¹¶ç»™ä»–å…³è”ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡ç±»å‹Açš„å˜é‡æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼å…¶å®æ˜¯\"è¯­æ³•ç³–\"ï¼Œå®é™…ä¸Šå’Œä¸‹è¾¹é‚£ä¸ªè°ƒç”¨æ–¹å¼ä¸€æ ·ã€‚ Goè¯­è¨€ä¸­ï¼Œå‡½æ•°ç±»å‹åªå’Œå‚æ•°ä¸è¿”å›å€¼ç›¸å…³ï¼Œæ‰€ä»¥ä¸‹è¾¹è¾“å‡ºä¸ºTrueï¼Œå¯ä»¥è¯´æ˜==æ–¹æ³•æœ¬è´¨ä¸Šå°±æ˜¯æ™®é€šå‡½æ•°ï¼Œæ¥æ”¶è€…å°±æ˜¯éšå«çš„ç¬¬ä¸€ä¸ªå‚æ•°==ã€‚ 1.2.3.2 æ–¹æ³•è°ƒç”¨ å…¶å®å’Œå‡½æ•°è°ƒç”¨ä¸€æ ·ã€‚ ä¸¾ä¾‹è¯´æ˜è¿‡ç¨‹ï¼š Goè¯­è¨€ä¸­ä¼ å‚å€¼æ‹·è´ï¼Œæ­¤å¤„ä¸ºå€¼æ¥æ”¶è€…ï¼Œæ‰€ä»¥å‚æ•°é¦–å…ˆä¸ºï¼šdata=addr1 4ï¼› æ‰§è¡ŒName()ä¸­ç¬¬ä¸€è¡Œæ—¶ï¼ŒdataæŒ‡å‘æ–°çš„stringï¼Œæ›´æ–°ä¸ºï¼šdata=addr2 8ï¼› è¿”å›å€¼å°±æ˜¯å€¼æ‹·è´çš„å‚æ•°ï¼Œå› æ­¤mainä¸­çš„å±€éƒ¨å˜é‡å¹¶æœªå—åˆ°å½±å“ã€‚ å†ä¸¾ä¸ªä¾‹å­å¯¹æ¯”ï¼š Goè¯­è¨€ä¸­ä¼ å‚å€¼æ‹·è´ï¼Œæ­¤å¤„ä¸ºæŒ‡é’ˆæ¥æ”¶è€…ï¼Œæ‰€ä»¥å‚æ•°é¦–å…ˆä¸ºï¼špa=\u0026aï¼› æ‰§è¡ŒName()ä¸­ç¬¬ä¸€è¡Œæ—¶ï¼Œä¿®æ”¹paåœ°å€å¤„çš„å˜é‡ï¼Œä¹Ÿå°±æ˜¯aï¼ŒaæŒ‡å‘æ–°çš„stringï¼Œæ›´æ–°ä¸ºï¼šdata=addr2 8ï¼› è¿”å›å€¼å°±æ˜¯å€¼æ‹·è´çš„å‚æ•°ï¼Œå³aæŒ‡å‘çš„å˜é‡ã€‚æ­¤å¤„mainä¸­çš„å±€éƒ¨å˜é‡aä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚ ä¸Šè¿°ä¾‹å­ä¸­ï¼Œé€šè¿‡å€¼è°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•ï¼Œé€šè¿‡æŒ‡é’ˆè°ƒç”¨æŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœç”¨å€¼è°ƒç”¨æŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•æˆ–ç”¨æŒ‡é’ˆè°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•ï¼Œæ˜¯å¦å¯è¡Œå‘¢ï¼Ÿ ç­”ï¼šå¯è¡Œï¼Œè¿™äº›ä¹Ÿæ˜¯\"è¯­æ³•ç³–\"ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šè¿›è¡Œè½¬æ¢ã€‚ 1.2.3.3 æ–¹æ³•è¡¨è¾¾å¼å’Œæ–¹æ³•å˜é‡ æ¥çœ‹çœ‹å°†ä¸€ä¸ªæ–¹æ³•èµ‹ç»™ä¸€ä¸ªå˜é‡æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ Goè¯­è¨€ä¸­ï¼Œå‡½æ•°ä½œä¸ºå˜é‡ã€å‚æ•°å’Œè¿”å›å€¼æ—¶éƒ½æ˜¯ä»¥Function Valueå½¢å¼å­˜åœ¨çš„ï¼Œé—­åŒ…ä¹Ÿåªæ˜¯æœ‰æ•è·åˆ—è¡¨çš„Function Valueè€Œå·²ã€‚ å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯æ–¹æ³•è¡¨è¾¾å¼å’Œæ–¹æ³•å˜é‡ï¼š ä»æœ¬è´¨ä¸Šè®²ï¼Œæ–¹æ³•è¡¨è¾¾å¼å’Œæ–¹æ³•å˜é‡éƒ½æ˜¯Function Valueã€‚ çœ‹è¿™æ®µä»£ç ï¼š ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:3","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.4 æ¥å£ 1.2.4.1 æ¦‚è¿° è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ¥å£æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­å¤šä¸ªç»„ä»¶å…±äº«çš„è¾¹ç•Œï¼Œä¸åŒçš„ç»„ä»¶èƒ½å¤Ÿåœ¨è¾¹ç•Œä¸Šäº¤æ¢ä¿¡æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¥å£çš„æœ¬è´¨æ˜¯å¼•å…¥ä¸€ä¸ªæ–°çš„ä¸­é—´å±‚ï¼Œè°ƒç”¨æ–¹å¯ä»¥é€šè¿‡æ¥å£ä¸å…·ä½“å®ç°åˆ†ç¦»ï¼Œè§£é™¤ä¸Šä¸‹æ¸¸çš„è€¦åˆï¼Œä¸Šå±‚çš„æ¨¡å—ä¸å†éœ€è¦ä¾èµ–ä¸‹å±‚çš„å…·ä½“æ¨¡å—ï¼Œåªéœ€è¦ä¾èµ–ä¸€ä¸ªçº¦å®šå¥½çš„æ¥å£ã€‚ Go è¯­è¨€ä¸­çš„æ¥å£æ˜¯ä¸€ç§å†…ç½®çš„ç±»å‹ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„æ–¹æ³•çš„ç­¾åã€‚Go è¯­è¨€ä¸­æ¥å£çš„å®ç°éƒ½æ˜¯éšå¼çš„ï¼Œç±»å‹å®ç°æ¥å£æ—¶åªéœ€è¦å®ç°æ¥å£ä¸­çš„å…¨éƒ¨æ–¹æ³•ã€‚ åœ¨ Java ä¸­ï¼šå®ç°æ¥å£éœ€è¦æ˜¾å¼åœ°å£°æ˜æ¥å£å¹¶å®ç°æ‰€æœ‰æ–¹æ³•ï¼› åœ¨ Go ä¸­ï¼šå®ç°æ¥å£çš„æ‰€æœ‰æ–¹æ³•å°±éšå¼åœ°å®ç°äº†æ¥å£ï¼› 1.2.4.2 æ•°æ®ç»“æ„ Go è¯­è¨€æ ¹æ®æ¥å£ç±»å‹æ˜¯å¦åŒ…å«ä¸€ç»„æ–¹æ³•å°†æ¥å£ç±»å‹åˆ†æˆäº†ä¸¤ç±»ï¼š ä½¿ç”¨ runtime.iface ç»“æ„ä½“è¡¨ç¤ºåŒ…å«æ–¹æ³•çš„æ¥å£ï¼Œåˆç§°éç©ºæ¥å£ç±»å‹ï¼› ä½¿ç”¨ runtime.eface ç»“æ„ä½“è¡¨ç¤ºä¸åŒ…å«ä»»ä½•æ–¹æ³•çš„ interface{} ç±»å‹ï¼Œåˆç§°ç©ºæ¥å£ç±»å‹ï¼Œå¯ä»¥æ¥æ”¶ä»»æ„ç±»å‹çš„æ•°æ®ï¼› runtime.eface ç»“æ„ä½“ï¼š type eface struct { // 16 å­—èŠ‚ _type *_type // åŠ¨æ€ç±»å‹ï¼šè¡¨ç¤ºç±»å‹å…ƒæ•°æ® data unsafe.Pointer // åŠ¨æ€å€¼ï¼šè®°å½•åœ¨å“ª } ä¸¾ä¾‹è¯´æ˜ï¼šèµ‹å€¼å‰_typeå’Œdataå­—æ®µéƒ½ä¸ºnilï¼Œèµ‹å€¼åï¼š runtime.iface ç»“æ„ä½“ï¼š type iface struct { // 16 å­—èŠ‚ tab *itab // è®°å½•åŠ¨æ€ç±»å‹å’Œæ–¹æ³•åˆ—è¡¨ data unsafe.Pointer // åŠ¨æ€å€¼ } type itab struct { // 32 å­—èŠ‚ inter *interfacetype // æ¥å£çš„ç±»å‹å…ƒæ•°æ®ï¼ŒåŒ…å«æ¥å£çš„æ–¹æ³•åˆ—è¡¨ï¼šéœ€è¦å®ç°çš„æ–¹æ³• _type *_type // æ¥å£çš„åŠ¨æ€ç±»å‹å…ƒæ•°æ® hash uint32 // ç±»å‹å“ˆå¸Œå€¼ï¼šç”¨äºå¿«é€Ÿåˆ¤æ–­ç±»å‹æ˜¯å¦ç›¸ç­‰ï¼Œç±»å‹æ–­è¨€æ—¶ä¼šç”¨åˆ° _ [4]byte fun [1]uintptr // æ–¹æ³•åœ°å€æ•°ç»„ï¼šç”¨äºå¿«é€Ÿè°ƒç”¨æ–¹æ³•ï¼Œæ— éœ€å†å»æ¥å£çš„ç±»å‹å…ƒæ•°æ®å¯»æ‰¾æ–¹æ³•åœ°å€ } hash æ˜¯å¯¹ _type.hash çš„æ‹·è´ï¼Œå½“æˆ‘ä»¬æƒ³å°† interface ç±»å‹è½¬æ¢æˆå…·ä½“ç±»å‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å­—æ®µå¿«é€Ÿåˆ¤æ–­ç›®æ ‡ç±»å‹å’Œå…·ä½“ç±»å‹ runtime._type æ˜¯å¦ä¸€è‡´ï¼› fun æ˜¯ä¸€ä¸ªåŠ¨æ€å¤§å°çš„æ•°ç»„ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºåŠ¨æ€æ´¾å‘çš„è™šå‡½æ•°è¡¨ï¼Œå­˜å‚¨äº†ä¸€ç»„å‡½æ•°æŒ‡é’ˆã€‚è™½ç„¶è¯¥å˜é‡è¢«å£°æ˜æˆå¤§å°å›ºå®šçš„æ•°ç»„ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨æ—¶ä¼šé€šè¿‡åŸå§‹æŒ‡é’ˆè·å–å…¶ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥ fun æ•°ç»„ä¸­ä¿å­˜çš„å…ƒç´ æ•°é‡æ˜¯ä¸ç¡®å®šçš„ã€‚ ä¸¾ä¾‹è¯´æ˜ï¼šèµ‹å€¼å‰tabå’Œdataå­—æ®µéƒ½ä¸ºnilï¼Œèµ‹å€¼åï¼š ==Pointï¼š== itabç»“æ„ä½“å†…å®¹ä¸€æ—¦ç¡®å®š(æ¥å£ç±»å‹å’ŒåŠ¨æ€ç±»å‹)ï¼Œå®é™…ä¸Šæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå› æ­¤æ˜¯å¯å¤ç”¨çš„ã€‚Goè¯­è¨€ä¼šå°†itabç¼“å­˜èµ·æ¥ï¼Œå¹¶ä¸”ä»¥æ¥å£ç±»å‹å’ŒåŠ¨æ€ç±»å‹çš„ç»„åˆä¸ºkey(æ¥å£ç±»å‹çš„hash ^ åŠ¨æ€ç±»å‹çš„hash)ï¼Œä»¥\u0026itabä¸ºvalueæ„é€ ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚éœ€è¦ä¸€ä¸ªitabæ—¶ï¼Œä¼šå…ˆåœ¨è¿™é‡Œè¾¹å¯»æ‰¾ï¼Œå¦‚æœå·²ç»æœ‰å¯¹åº”çš„itabï¼Œå°±ç›´æ¥æ‹¿æ¥ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ–°åˆ›å»ºå¹¶æ·»åŠ ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:4","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.5 ç±»å‹æ–­è¨€ ç±»å‹æ–­è¨€ä½œç”¨åœ¨æŠ½è±¡ç±»å‹ä¸Šï¼ŒåŒ…æ‹¬ï¼šç©ºæ¥å£å’Œéç©ºæ¥å£ã€‚è€Œæ–­è¨€çš„ç›®æ ‡ç±»å‹å¯ä»¥æ˜¯å…·ä½“ç±»å‹æˆ–éç©ºæ¥å£ç±»å‹ã€‚è¿™æ ·å°±ç»„åˆå‡ºæ¥äº†å››ç§ç±»å‹æ–­è¨€ï¼š ç©ºæ¥å£.(å…·ä½“ç±»å‹) éç©ºæ¥å£.(å…·ä½“ç±»å‹) ç©ºæ¥å£.(éç©ºæ¥å£) éç©ºæ¥å£.(éç©ºæ¥å£) 1.2.5.1 ç©ºæ¥å£.(å…·ä½“ç±»å‹) 1.2.5.2 éç©ºæ¥å£.(å…·ä½“ç±»å‹) 1.2.5.3 ç©ºæ¥å£.(éç©ºæ¥å£) 1.2.5.4 éç©ºæ¥å£.(éç©ºæ¥å£) 1.2.5.5 å°ç»“ ç±»å‹æ–­è¨€çš„å…³é”®æ˜¯ï¼šæ˜ç¡®æ¥å£çš„**==åŠ¨æ€ç±»å‹==åŠå¯¹åº”çš„åŠ¨æ€ç±»å‹å®ç°äº†å“ªäº›æ–¹æ³•**ï¼Œè€Œæ˜ç¡®è¿™äº›çš„å…³é”®åˆåœ¨äºåŠ¨æ€ç±»å‹çš„ç±»å‹å…ƒæ•°æ®ï¼Œä»¥åŠç©ºæ¥å£ä¸éç©ºæ¥å£çš„**â€œæ•°æ®ç»“æ„â€**ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:5","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.6 åå°„ åå°„çš„ä½œç”¨å°±æ˜¯æŠŠç±»å‹å…ƒæ•°æ®æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨ã€‚ åå°„åŒ…ä¸­æœ‰ä¸¤å¯¹éå¸¸é‡è¦çš„å‡½æ•°å’Œç±»å‹ï¼Œä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ï¼š reflect.TypeOf èƒ½è·å–ç±»å‹ä¿¡æ¯ï¼› reflect.ValueOf èƒ½è·å–æ•°æ®çš„è¿è¡Œæ—¶è¡¨ç¤ºã€‚ ä¸¤ä¸ªç±»å‹æ˜¯ reflect.Type å’Œ reflect.Valueï¼Œå®ƒä»¬ä¸å‡½æ•°æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼š 1.2.6.1 ä¸‰å¤§æ³•åˆ™ Go è¯­è¨€åå°„çš„ä¸‰å¤§æ³•åˆ™ï¼š ä» interface{} å˜é‡å¯ä»¥åå°„å‡ºåå°„å¯¹è±¡ï¼› ä»åå°„å¯¹è±¡å¯ä»¥è·å– interface{} å˜é‡ï¼› è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»å¯è®¾ç½®ï¼› æ³•åˆ™1 ä¸ºä»€ä¹ˆæ˜¯ä» interface{} å˜é‡åˆ°åå°„å¯¹è±¡ï¼Ÿæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡Œreflect.ValueOf(1)å‘€ï¼Œ1æ˜¯intç±»å‹å‘€ï¼Œå¹¶ä¸æ˜¯interface{}ï¼Ÿ ç”±äº reflect.TypeOfã€reflect.ValueOf ä¸¤ä¸ªæ–¹æ³•çš„å…¥å‚éƒ½æ˜¯ interface{} ç±»å‹ï¼Œæ‰€ä»¥åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ç±»å‹è½¬æ¢ã€‚å› ä¸º Go è¯­è¨€çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯å€¼ä¼ é€’çš„ï¼Œæ‰€ä»¥å˜é‡ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶è¿›è¡Œç±»å‹è½¬æ¢ã€‚åŸºæœ¬ç±»å‹ int ä¼šè½¬æ¢æˆ interface{} ç±»å‹ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç¬¬ä¸€æ¡æ³•åˆ™æ˜¯ä»æ¥å£åˆ°åå°„å¯¹è±¡ã€‚ é€šè¿‡TypeOfè·å¾—å˜é‡ç±»å‹ï¼› é€šè¿‡ValueOfè·å¾—å˜é‡å€¼ï¼› ç„¶åå°±å¯ä»¥é€šè¿‡Methodè·å¾—ç±»å‹å®ç°çš„æ–¹æ³•ï¼› é€šè¿‡Fieldè·å¾—ç±»å‹åŒ…å«çš„å…¨éƒ¨å­—æ®µã€‚ æ³•åˆ™2 ä»åå°„å¯¹è±¡å¯ä»¥è·å– interface{} å˜é‡ã€‚reflect ä¸­çš„ reflect.Value.Interface å°±èƒ½å®Œæˆè¿™é¡¹å·¥ä½œã€‚ ä¸è¿‡è°ƒç”¨ reflect.Value.Interface æ–¹æ³•åªèƒ½è·å¾— interface{} ç±»å‹çš„å˜é‡ï¼Œè¿˜éœ€è¦è¿›è¡Œç±»å‹æ–­è¨€æ‰èƒ½å˜æˆåŸç±»å‹ã€‚ ä»åå°„å¯¹è±¡åˆ°æ¥å£å€¼çš„è¿‡ç¨‹æ˜¯ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡çš„é•œé¢è¿‡ç¨‹ï¼Œä¸¤ä¸ªè¿‡ç¨‹éƒ½éœ€è¦ç»å†ä¸¤æ¬¡è½¬æ¢ï¼š ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡ï¼š ä»åŸºæœ¬ç±»å‹åˆ°æ¥å£ç±»å‹çš„ç±»å‹è½¬æ¢ï¼› ä»æ¥å£ç±»å‹åˆ°åå°„å¯¹è±¡çš„è½¬æ¢ï¼› ä»åå°„å¯¹è±¡åˆ°æ¥å£å€¼ï¼š åå°„å¯¹è±¡è½¬æ¢æˆæ¥å£ç±»å‹ï¼› é€šè¿‡æ˜¾å¼ç±»å‹è½¬æ¢å˜æˆåŸå§‹ç±»å‹(å¦‚æœåŸæ¥å°±æ˜¯æ¥å£ç±»å‹ï¼Œé‚£ä¹ˆä¸å¿…è¿™ä¸€æ­¥)ã€‚ æ³•åˆ™3 å‡å¦‚æƒ³è¦æ›´æ–°åŸå˜é‡çš„å€¼ï¼Œå¦‚æœè¿™æ ·å†™ï¼Œæ˜¯ä¸è¡Œçš„ï¼š func main() { i := 1 v := reflect.ValueOf(i) v.SetInt(10) fmt.Println(i) } éœ€è¦è¿™æ ·å†™ï¼š func main() { i := 1 v := reflect.ValueOf(\u0026i) v.Elem().SetInt(10) fmt.Println(i) } è°ƒç”¨ reflect.ValueOf è·å–å˜é‡æŒ‡é’ˆï¼› è°ƒç”¨ reflect.Value.Elem è·å–æŒ‡é’ˆæŒ‡å‘çš„å˜é‡ï¼› è°ƒç”¨ reflect.Value.SetInt æ›´æ–°å˜é‡çš„å€¼ï¼š 1.2.6.2 ç±»å‹å’Œå€¼ TypeOf å¦‚ä½•ä¼ é€’å‚æ•° å¯ä»¥æ€è€ƒä¸€ä¸‹æ­¤å¤„æ ˆä¸Šå‚æ•°åˆ—è¡¨åº”è¯¥æ˜¯æ€æ ·çš„ï¼Ÿ ç”±äºTypeOfçš„å‚æ•°æ˜¯ç©ºæ¥å£ç±»å‹ï¼Œç©ºæ¥å£æ˜¯åŠ¨æ€ç±»å‹ï¼Œå®é™…å¤§å°ä¸çŸ¥é“ï¼Œå› æ­¤éœ€è¦ä¼ é€’åœ°å€ï¼Œä½†æ˜¯å¦‚æœä¼ é€’açš„åœ°å€è¿›å»ï¼Œå°±ä¼šè¿èƒŒGoè¯­è¨€å€¼æ‹·è´çš„ç‰¹æ€§ï¼Œå¯èƒ½ä¼šä¿®æ”¹åŸaçš„å€¼ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ å®é™…ä¸Šåœ¨ç¼–è¯‘é˜¶æ®µï¼Œä¼šå¯¹aè¿›è¡Œcopyï¼Œå®é™…ä¼ çš„æ˜¯copy of açš„åœ°å€ï¼Œæ‰€æœ‰å‚æ•°ä¸ºç©ºæ¥å£ç±»å‹çš„æƒ…å†µï¼Œéƒ½æ˜¯è¿™æ ·ã€‚ è¿”å›å€¼æ˜¯ä»€ä¹ˆï¼Ÿ é€šè¿‡TypeOfè¿”å›çš„ï¼Œå…¶å®æ˜¯ä¸€ä¸ªéç©ºæ¥å£å˜é‡ï¼š ValueOf å‚æ•°ä¼ é€’ åŒTypeOfï¼ŒåŒæ—¶ï¼ŒValueOfä¼šå°†è¿™ä¸ªä¸´æ—¶å˜é‡åœ°å€æ˜¾å¼çš„é€ƒé€¸åˆ°å †ä¸Šã€‚ ä¾‹ï¼š açš„åœ°å€è¢«æ˜¾å¼çš„é€ƒé€¸åˆ°å †ï¼Œæ³¨æ„æ­¤å¤„çš„è¿”å›å€¼ptr=\u0026aï¼š æ¥ä¸‹æ¥è°ƒç”¨v.Elem()ï¼Œä¼šæ‹¿åˆ°v.ptræŒ‡å‘çš„å˜é‡aï¼Œå¹¶æŠŠå®ƒåŒ…è£…æˆreflect.Valueç±»å‹çš„è¿”å›å€¼(ptråˆå˜ä¸º\u0026a)ï¼Œèµ‹å€¼ç»™vï¼š ç„¶ååœ¨è°ƒç”¨v.SetString()ï¼Œæ­¤æ—¶é€šè¿‡å‚æ•°væ‹¿åˆ°açš„åœ°å€ï¼Œä¿®æ”¹çš„å°±æ˜¯åŸæ¥çš„aï¼š ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:6","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.7 æ–¹æ³•é›† é—®é¢˜ï¼šTå’Œ*Tçš„æ–¹æ³•é›†æ˜¯å•¥å…³ç³»ï¼Ÿ Tå’Œ*Tæ˜¯ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æœ‰ç€è‡ªå·±çš„ç±»å‹å…ƒæ•°æ®ï¼Œè€Œæ ¹æ®è‡ªå®šä¹‰ç±»å‹çš„ç±»å‹å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ°è¯¥ç±»å‹å…³è”çš„æ–¹æ³•åˆ—è¡¨ï¼Œæ—¢ç„¶Tå’Œ*Tå„æœ‰å„çš„æ–¹æ³•é›†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦é™åˆ¶Tå’Œ*Tä¸èƒ½å®šä¹‰åŒåæ–¹æ³•ï¼Ÿåˆæ€ä¹ˆä¼šæœ‰\"*Tçš„æ–¹æ³•é›†åŒ…å«Tçš„æ–¹æ³•é›†\"è¿™ç§è¯´æ³•ï¼Ÿ **ç­”ï¼š**é¦–å…ˆï¼Œå¯ä»¥ç¡®å®šçš„æ˜¯ï¼ŒTçš„æ–¹æ³•é›†é‡Œï¼Œå…¨éƒ¨éƒ½æ˜¯æœ‰æ˜ç¡®å®šä¹‰çš„æ¥æ”¶è€…ä¸ºTç±»å‹çš„æ–¹æ³•ï¼›è€Œ*Tçš„æ–¹æ³•é›†é‡Œï¼Œé™¤äº†æœ‰æ˜ç¡®å®šä¹‰çš„æ¥æ”¶è€…ä¸º*Tçš„æ–¹æ³•ä»¥å¤–ï¼Œ**è¿˜ä¼šæœ‰ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸€äº›\"åŒ…è£…æ–¹æ³•\"ï¼š**è¿™äº›åŒ…è£…æ–¹æ³•æ˜¯å¯¹æ¥æ”¶è€…ä¸ºTç±»å‹çš„åŒåæ–¹æ³•çš„\"åŒ…è£…\"ï¼Œä¸ºä»€ä¹ˆç¼–è¯‘å™¨è¦ä¸ºæ¥æ”¶è€…ä¸ºTçš„æ–¹æ³•åŒ…è£…ä¸€ä¸ªæ¥æ”¶è€…ä¸º*Tçš„åŒåæ–¹æ³•å‘¢ï¼Ÿ ä½ å¯èƒ½ä¼šæƒ³åˆ° Go æ”¯æŒé€šè¿‡æŒ‡é’ˆå˜é‡è®¿é—®æ–¹æ³•ã€‚ä½†è¿™é‡Œé¦–å…ˆè¦æ˜ç¡®ä¸€ç‚¹ï¼šé€šè¿‡*Tç±»å‹çš„å˜é‡ç›´æ¥è°ƒç”¨Tç±»å‹æ¥æ”¶è€…çš„æ–¹æ³•åªæ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œç»éªŒè¯ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼ï¼Œç¼–è¯‘å™¨ä¼šå†è°ƒç”¨ç«¯è¿›è¡ŒæŒ‡é’ˆè§£å¼•ç”¨ï¼Œå¹¶ä¸ä¼šç”¨åˆ°è¿™é‡Œçš„åŒ…è£…æ–¹æ³•ã€‚ ==å®é™…ä¸Šï¼Œç¼–è¯‘å™¨ç”ŸæˆåŒ…è£…æ–¹æ³•ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒæ¥å£ã€‚== éç©ºæ¥å£çš„æ•°æ®ç»“æ„åªåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªå’Œç±»å‹å…ƒæ•°æ®ç›¸å…³ï¼Œä¸€ä¸ªå’Œæ¥å£è£…è½½çš„æ•°æ®ç›¸å…³ï¼Œè™½ç„¶æœ‰æ•°æ®æŒ‡é’ˆï¼Œä½†å´ä¸èƒ½åƒä¸Šè¿°è¯­æ³•ç³–é‚£æ ·ï¼Œé€šè¿‡æŒ‡é’ˆè§£å¼•ç”¨æ¥è°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•ã€‚**åŸå› ï¼š**æ–¹æ³•çš„æ¥æ”¶è€…æ˜¯æ–¹æ³•è°ƒç”¨æ—¶éšå«çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒGo ä¸­çš„å‡½æ•°å‚æ•°æ˜¯é€šè¿‡æ ˆæ¥ä¼ é€’çš„ï¼Œå¦‚æœå‚æ•°æŒ‡é’ˆç±»å‹ï¼Œé‚£å°±å¾ˆå¥½å®ç°ï¼šå¹³å°ç¡®å®šäº†ï¼ŒæŒ‡é’ˆå¤§å°å°±ç¡®å®šäº†ã€‚ä½†å¦‚æœè¦è§£å¼•ç”¨ä¸ºå€¼ç±»å‹ï¼Œå°±è¦æœ‰æ˜ç¡®çš„ç±»å‹ä¿¡æ¯ï¼Œç¼–è¯‘å™¨æ‰èƒ½ç¡®å®šè¿™ä¸ªå‚æ•°è¦åœ¨æ ˆä¸Šå ç”¨å¤šå¤§çš„å†…å­˜ç©ºé—´ã€‚è€Œå¯¹äºæ¥å£ï¼Œç¼–è¯‘é˜¶æ®µå¹¶ä¸èƒ½ç¡®å®šå®ƒä¼šè£…è½½å“ªä¸€ç±»çš„æ•°æ®ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¹¶ä¸èƒ½ç”Ÿæˆå¯¹åº”çš„æŒ‡ä»¤æ¥è§£å¼•ç”¨ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œ==æ¥å£ä¸èƒ½ç›´æ¥ä½¿ç”¨æ¥æ”¶è€…ä¸ºå€¼ç±»å‹çš„æ–¹æ³•==ã€‚ é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç¼–è¯‘å™¨é€‰æ‹©ä¸ºå€¼ç±»å‹æ¥æ”¶è€…çš„æ–¹æ³•ï¼Œç”ŸæˆæŒ‡é’ˆæ¥æ”¶è€…\"åŒå\"åŒ…è£…æ–¹æ³•è¿™ä¸€è§£å†³æ–¹æ¡ˆã€‚ å› æ­¤ï¼Œå›åˆ°æœ€åˆçš„é—®é¢˜ï¼šâ€œä¸ºä»€ä¹ˆè¿˜è¦é™åˆ¶Tå’Œ*Tä¸èƒ½å®šä¹‰åŒåæ–¹æ³•ï¼Ÿâ€ï¼Œå¦‚æœç»™Tå’Œ*Tå®šä¹‰äº†åŒåæ–¹æ³•ï¼Œå°±æœ‰å¯èƒ½å’Œç¼–è¯‘å™¨ç”Ÿæˆçš„åŒ…è£…æ–¹æ³•å‘ç”Ÿå†²çªï¼Œæ‰€ä»¥ Go å¹²è„†ä¸å…è®¸ä¸ºTå’Œ*Tå®šä¹‰åŒåæ–¹æ³•ã€‚ è‡³äºï¼Œ\"*Tçš„æ–¹æ³•é›†åŒ…å«Tçš„æ–¹æ³•é›†çš„æ‰€æœ‰æ–¹æ³•\"ï¼Œè¿™ç§è¯´æ³•å¯ä»¥è¿™æ ·ç†è§£ã€‚è™½ç„¶ç¼–è¯‘å™¨ä¼šä¸ºæ‰€æœ‰æ¥æ”¶è€…ä¸ºTçš„æ–¹æ³•ç”Ÿæˆæ¥æ”¶è€…ä¸º*Tçš„åŒ…è£…æ–¹æ³•ï¼Œä½†æ˜¯é“¾æ¥å™¨ä¼šæŠŠç¨‹åºä¸­ç¡®å®šç”¨ä¸åˆ°çš„æ–¹æ³•éƒ½è£å‰ªæ‰ï¼Œæ‰€ä»¥å¦‚æœå»åˆ†æå¯æ‰§è¡Œæ–‡ä»¶çš„è¯ï¼Œå°±ä¼šå‘ç°ä¸æ­¢æ˜¯è¿™äº›åŒ…è£…æ–¹æ³•ï¼Œå°±è¿æˆ‘ä»¬æ˜ç¡®å®šä¹‰çš„æ–¹æ³•ï¼Œä¹Ÿä¸ä¸€å®šä¼šå­˜åœ¨äºå¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚ä¸è¿‡ï¼Œä¸€å®šè¦ä»å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»åˆ†æï¼Œä¸èƒ½é€šè¿‡åå°„å»éªŒè¯ï¼Œå› ä¸ºåå°„çš„å®ç°ä¹Ÿæ˜¯åŸºäºæ¥å£ã€‚è‹¥é€šè¿‡åå°„æ¥éªŒè¯ï¼Œä¼šè¢«é“¾æ¥å™¨è®¤ä¸ºç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•ï¼Œä»è€ŒæŠŠå®ƒä¿ç•™ä¸‹æ¥ï¼Œè¿™å°±\"æµ‹ä¸å‡†\"äº†ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:7","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.2.8 æ³›å‹ go 1.17 åœ¨ä»£ç ä¸­ç»å¸¸ä¼šç”¨åˆ°ä¸€äº›æœ¬åœ°ç¼“å­˜ç»„ä»¶ï¼Œå®ƒä»¬æ˜¯å¤ç”¨æ€§æé«˜çš„åŸºç¡€ç»„ä»¶ï¼Œåœ¨ä½¿ç”¨ä½“éªŒä¸Šå’Œmapå·®ä¸å¤šï¼Œéƒ½æä¾›äº†Setå’ŒGetæ–¹æ³•ã€‚ä¸ºäº†æ”¯æŒä»»æ„ç±»å‹ï¼Œè¿™äº›æ–¹æ³•éƒ½ä½¿ç”¨äº†ç©ºæ¥å£ç±»å‹çš„å‚æ•°ï¼Œå†…éƒ¨å®é™…å­˜å‚¨æ•°æ®çš„æ˜¯ä¸ªå€¼ç±»å‹ä¸ºç©ºæ¥å£çš„mapã€‚ ä½¿ç”¨Setæ–¹æ³•æ—¶ï¼Œä¸€èˆ¬ä¸ä¼šè§‰å¾—æœ‰ä»€ä¹ˆä¸æ–¹ä¾¿ï¼Œå› ä¸ºä»å…·ä½“ç±»å‹æˆ–æ¥å£ç±»å‹ï¼Œåˆ°ç©ºæ¥å£çš„èµ‹å€¼ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚ä½†æ˜¯Getæ–¹æ³•ä½¿ç”¨æ—¶ï¼Œéœ€è¦é€šè¿‡ç±»å‹æ–­è¨€ï¼ŒæŠŠå–å‡ºæ¥çš„æ•°æ®è½¬æ¢æˆé¢„æœŸçš„ç±»å‹ã€‚æ¯”å¦‚æƒ³ä»æœ¬åœ°ç¼“å­˜cé‡Œé¢å–å‡ºæ¥ä¸€ä¸ªstringï¼Œå°±éœ€è¦è¿™æ ·å†™ï¼š if v, ok := c.Get(\"key\"); ok { if s, ok := v.(string); ok { // use s } } å¦‚æœæ˜¯ä»…ä»…å¤šè¿™ä¸€æ­¥ï¼Œé‚£ä¹Ÿæ— å¯åšéï¼Œå¯å®é™…ä¸Šå¹¶ä¸è¿™ä¹ˆç®€å•ã€‚ **ç©ºæ¥å£æœ¬è´¨ä¸Šæ˜¯ä¸€å¯¹æŒ‡é’ˆï¼Œç”¨æ¥è£…è½½å€¼ç±»å‹æ—¶ä¼šå‘ç”Ÿè£…ç®±ï¼Œé€ æˆå˜é‡é€ƒé€¸ã€‚**ä¾‹å¦‚ç”¨Cacheæ¥ç¼“å­˜int64ç±»å‹ï¼Œç¼“å­˜å¯¹è±¡cåº•å±‚æ˜¯ä¸ªmapï¼Œåœ¨mapçš„bucketsä¸­å­˜å‚¨ç€å…ƒç´ çš„å“ˆå¸Œå€¼ã€keyå’Œvalueï¼Œå¯¹äºcè€Œè¨€ï¼Œbucketè¿™é‡Œå­˜å‚¨çš„valueæ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ç©ºæ¥å£ï¼Œè€Œå®é™…ä¸Šçš„int64ä¼šåœ¨å †ä¸Šå•ç‹¬åˆ†é…ï¼Œç©ºæ¥å£çš„dataæŒ‡é’ˆæŒ‡å‘å †ä¸Šçš„int64ï¼Œç›¸è¾ƒäºç›´æ¥æŠŠint64å­˜å‚¨åœ¨mapçš„bucketé‡Œï¼Œå †åˆ†é…æ–¹å¼å‡­ç©ºå¤šå‡ºæ¥ä¸€æ¬¡å †åˆ†é…ï¼Œè€Œä¸”è¿˜å¤šå ç”¨äº†ä¸¤å€çš„å†…å­˜ç©ºé—´ã€‚ é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæ”¹é€ ä¸Šè¿°ç¼“å­˜ä¸ºæ³›å‹ç¼“å­˜ã€‚ å°†Cacheæ”¹ä¸ºcacheï¼Œå› ä¸º Go 1.17 çš„æ³›å‹å®ç°è¿˜ä¸æ”¯æŒå¯¼å‡ºï¼Œæ³›å‹ç›¸å…³çš„ç±»å‹å’Œå‡½æ•°åªèƒ½åœ¨å½“å‰åŒ…ä¸­ä½¿ç”¨ï¼› Go 1.17 çš„æ³›å‹æ”¯æŒé»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶åº”æŒ‡å®šå‚æ•°æ¥æ˜¾å¼çš„å¼€å¯ï¼Œè€Œä¸”ï¼Œæ®è§‚å¯Ÿbuildå‘½ä»¤åªæœ‰åœ¨ç¼–è¯‘mainåŒ…æ—¶ï¼Œæ‰ä¼šé€ä¼ è¿™ä¸ªå‚æ•°ï¼Œè¿™å°±é™åˆ¶äº†åªèƒ½åœ¨mainåŒ…ä¸­ä½¿ç”¨æ³›å‹ã€‚ æ”¹é€ å¥½åï¼ŒåŒæ ·ç”¨æ¥å­˜å‚¨int64ç±»å‹çš„æ•°å€¼ï¼Œç„¶åï¼Œé€šè¿‡åå°„è§‚å¯Ÿåº•å±‚mapå­˜å‚¨çš„æ˜¯ä»€ä¹ˆæ ·ç±»å‹çš„å…ƒç´ ï¼Œä¸‹è¾¹çš„ä»£ç ä¼šæ‰“å°int64ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ³›å‹ç¼“å­˜cacheçš„åº•å±‚mapä¼šç›´æ¥åœ¨bucketä¸­å­˜å‚¨int64ç±»å‹çš„æ•°å€¼ï¼Œæ²¡æœ‰é¢å¤–çš„å †åˆ†é…ã€‚ å¯ä»¥çœ‹å‡ºï¼Œæ³›å‹èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯æ²¡æœ‰ä»£ä»·çš„ã€‚ æ³›å‹çš„å®ç°ï¼š ä½¿ç”¨æ³›å‹æœ€ç›´æ¥çš„ä»£ä»·å°±æ˜¯ï¼šç¼–è¯‘å™¨ä¼šä¸ºåŒä¸€å¥—æ¨¡æ¿çš„æ¯ä¸ªç±»å‹ï¼Œéƒ½ç”Ÿæˆä¸€å¥—ä»£ç ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¯æ‰§è¡Œæ–‡ä»¶å¤§å°æœ‰æ‰€å¢åŠ ï¼›è€Œä¸”ï¼Œå³ä¾¿ä½¿ç”¨æ³›å‹ï¼Œè¦æƒ³åœ¨ä¸€ä¸ªç¼“å­˜å¯¹è±¡é‡Œé¢å­˜å‚¨å¤šç§ä¸åŒç±»å‹çš„å€¼ï¼Œä¾ç„¶è¦ä½¿ç”¨ç©ºæ¥å£ï¼Œå¦åˆ™ï¼Œä¸€ä¸ªç¼“å­˜å¯¹è±¡å°±åªèƒ½å­˜å‚¨ä¸€ç§ç±»å‹çš„å€¼ã€‚ æ‰€ä»¥è¯´ï¼Œæ³›å‹æœ¬è´¨ä¸Šæ˜¯ç¼–è¯‘é˜¶æ®µçš„ä»£ç ç”Ÿæˆï¼Œå®ƒå¹¶ä¸ä¼šæ›¿ä»£ç©ºæ¥å£ï¼Œç©ºæ¥å£ä¸»è¦ç”¨æ¥å®ç°è¯­è¨€çš„åŠ¨æ€ç‰¹æ€§ï¼Œå®ƒä»¬çš„é€‚ç”¨åœºæ™¯æ ¹æœ¬ä¸åŒ~ go 1.18 Go ä» 1.18 æ­£å¼å¼€å§‹æ”¯æŒæ³›å‹ï¼Œè¿™é‡Œçš„Tå°±æ˜¯ç±»å‹å‚æ•°ï¼Œä¸javaã€c++å¯¹æ¯”ï¼Œæ²¡æœ‰ä½¿ç”¨\u003c\u003eï¼Œè€Œæ˜¯ä½¿ç”¨[]ï¼š åŒæ—¶ï¼Œä¸ºäº†è®©ç¼–è¯‘å™¨èƒ½å¤Ÿæ›´é«˜æ•ˆçš„æ£€æŸ¥ç±»å‹å‚æ•°çš„åˆæ³•æ€§ï¼Œè¿˜å¼•å…¥äº†ç±»å‹å‚æ•°çš„çº¦æŸæ¡ä»¶ã€‚è¿™ä¸ªçº¦æŸæ¡ä»¶åœ¨è¯­æ³•å±‚é¢æ˜¯é€šè¿‡æ¥å£æ¥å®ç°çš„ï¼Œå®ƒæ˜ç¡®æè¿°äº†è°ƒç”¨æ–¹ä¼ å…¥çš„ç±»å‹å‚æ•°ï¼Œéœ€è¦ç¬¦åˆä»€ä¹ˆæ ·çš„è¦æ±‚ã€‚ è¿™é‡Œçš„fmt.Stringeræ¥å£é™åˆ¶äº†è°ƒç”¨ToStringæ–¹æ³•æ—¶ï¼Œä¼ å…¥çš„å‚æ•°å¿…é¡»å®ç°äº†String()æ–¹æ³•ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°ä¸ç¬¦åˆè¦æ±‚ï¼Œå°±æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å½“ç„¶ï¼Œæ­¤å¤„çš„æ¥å£ä¹Ÿå¹¶ä¸æ˜¯åŸæ¥çš„æ¥å£ã€‚ è‹¥ä½¿ç”¨åŸæ¥çš„æ¥å£ï¼Œå°±åªèƒ½é€šè¿‡æ¥å£çš„æ–¹æ³•é›†æ¥çº¦æŸç±»å‹å‚æ•°ï¼Œä½†è¿™æœ‰æ—¶æ˜¯è¡Œä¸é€šçš„ã€‚å› ä¸ºï¼Œè¿™äº›å†…ç½®ç±»å‹æ˜¯æ²¡æœ‰å®ç°ä»»ä½•æ–¹æ³•çš„ï¼Œæ¯”å¦‚int32ã€int64ã€‚ ä¾‹å¦‚ï¼Œå†™äº†ä¸€ä¸ªSum()å‡½æ•°ï¼Œæƒ³è®©å®ƒæ”¯æŒæ‰€æœ‰æ•´å‹ç±»å‹ï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ Go 1.18 å°†æ¥å£æ‰©å±•äº†ä¸€ä¸‹ã€‚åŸæ¥çš„æ¥å£åªèƒ½å®šä¹‰æ–¹æ³•é›†ï¼Œæ‰©å±•åçš„æ¥å£å¢åŠ äº†ç±»å‹é›†ï¼Œé€šè¿‡ç±»å‹é›†æŒ‡æ˜å“ªäº›ç±»å‹æ˜¯è¢«æ”¯æŒçš„ã€‚ ä¾‹å¦‚ï¼ŒIntegeræ¥å£ç”¨ä½œçº¦æŸæ¡ä»¶æ—¶ï¼Œå°±å¯ä»¥æ”¯æŒæ‰€æœ‰çš„æœ‰ç¬¦å·æ•´å‹ã€‚ ä½†è¿™ä¾ç„¶ä¸å¤Ÿï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†type MyInt intç±»å‹ï¼ŒåŒæ ·ä¹Ÿå¸Œæœ›è¢«æ”¯æŒï¼Œè¿™ä¸ªçº¦æŸæ¡ä»¶åˆè¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿæ€»ä¸èƒ½æ¯æ¬¡æ–°å¢åŠ è‡ªå®šä¹‰ç±»å‹éƒ½å»æ”¹ä¸€ä¸‹æ¥å£çš„ç±»å‹é›†å§ï¼Ÿ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒGo æ–°å¢åŠ äº†ç¬¦å·~ï¼Œåªè¦å†™~intï¼Œå°±å¯ä»¥æ”¯æŒ**intç±»å‹ä»¥åŠåŸºäºintåˆ›å»ºçš„æ‰€æœ‰è‡ªå®šä¹‰ç±»å‹**ï¼Œ **æ³¨æ„ï¼š**è¿™ç§æ‰©å±•åçš„æ¥å£ï¼Œç›®å‰åªç”¨äºæ³›å‹çš„çº¦æŸæ¡ä»¶ã€‚ ç°åœ¨æœ‰äº†æ³›å‹ï¼Œåªéœ€è¦å®ç°ä¸€éåŠŸèƒ½å‡½æ•°ï¼Œå°±å¯ä»¥é€šè¿‡å¤šç§ç±»å‹å‚æ•°æ¥è°ƒç”¨ã€‚ **é—®é¢˜ï¼š**ç¼–è¯‘å™¨ä¼šä¸ä¼šç»™æ¯ç§æ”¯æŒçš„ç±»å‹éƒ½ç”Ÿæˆä¸€å¥—ä»£ç å‘¢ï¼Ÿ// ==TODO== è²Œä¼¼ä¸ç”¨ã€‚é€šè¿‡å­—å…¸å’Œgcshapeå®ç°ã€‚æ²¡å¬æ‡‚ã€‚å…ˆè¿™æ ·å§ã€‚ã€‚ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:2:8","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.3 å¸¸ç”¨å…³é”®å­— ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:3:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.3.1 defer ä½¿ç”¨deferçš„æœ€å¸¸è§åœºæ™¯æ˜¯åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåå®Œæˆä¸€äº›æ”¶å°¾å·¥ä½œï¼Œé€šå¸¸ç”¨æ¥ï¼š å…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼› å…³é—­æ•°æ®åº“è¿æ¥ï¼› è§£é”èµ„æº é€šå¸¸ä½¿ç”¨deferä¼šé‡åˆ°ä¸¤ä¸ªå¸¸è§çš„é—®é¢˜ï¼š defer å…³é”®å­—çš„è°ƒç”¨æ—¶æœºä»¥åŠå¤šæ¬¡è°ƒç”¨ defer æ—¶æ‰§è¡Œé¡ºåºæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼› defer å…³é”®å­—ä½¿ç”¨ä¼ å€¼çš„æ–¹å¼ä¼ é€’å‚æ•°æ—¶ä¼šè¿›è¡Œé¢„è®¡ç®—ï¼Œå¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„ç»“æœã€‚ ==æ‰§è¡Œé¡ºåº== deferProc()è´Ÿè´£æŠŠè¦æ‰§è¡Œçš„å‡½æ•°ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œç§°ä¹‹ä¸º**deferæ³¨å†Œ**ï¼›deferæ³¨å†Œå®Œæˆåï¼Œä¼šç»§ç»­æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œç›´åˆ°è¿”å›ä¹‹å‰é€šè¿‡deferreturnæ‰§è¡Œæ³¨å†Œçš„deferå‡½æ•°ã€‚å³ï¼šå…ˆæ³¨å†Œï¼Œå†å»¶è¿Ÿè°ƒç”¨ã€‚ deferä¼šåœ¨å‡½æ•°è¿”å›ä¹‹å‰ï¼ŒæŒ‰ç…§å€’åºæ‰§è¡Œã€‚è¿™æ˜¯å› ä¸ºgoroutineè¿è¡Œæ—¶ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ç»“æ„ä½“gï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µæŒ‡å‘deferé“¾è¡¨å¤´ï¼Œdeferé“¾è¡¨é“¾èµ·æ¥çš„æ˜¯ä¸€ä¸ªä¸ª_deferç»“æ„ä½“ï¼Œæ–°æ³¨å†Œçš„deferä¼šæ·»åŠ åˆ°é“¾è¡¨å¤´ï¼Œæ‰§è¡Œæ—¶ä»å¤´å¼€å§‹ï¼Œå› æ­¤æ‰§è¡Œé¡ºåºæ˜¯æ³¨å†Œé¡ºåºçš„å€’åºã€‚ ==é¢„è®¡ç®—å‚æ•°== Go è¯­è¨€ä¸­æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯ä¼ å€¼çš„ï¼Œè™½ç„¶ defer æ˜¯å…³é”®å­—ï¼Œä½†æ˜¯ä¹Ÿç»§æ‰¿äº†è¿™ä¸ªç‰¹æ€§ã€‚å¦‚ä¸‹ä»£ç ï¼š func main() { startedAt := time.Now() defer fmt.Println(time.Since(startedAt)) time.Sleep(time.Second) } $ go run main.go 0s ä¸ºä»€ä¹ˆä¼šè¾“å‡º0å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼šè°ƒç”¨ defer å…³é”®å­—ä¼šç«‹åˆ»æ‹·è´å‡½æ•°ä¸­å¼•ç”¨çš„å¤–éƒ¨å‚æ•°ï¼Œæ‰€ä»¥ time.Since(startedAt) çš„ç»“æœä¸æ˜¯åœ¨ main å‡½æ•°é€€å‡ºä¹‹å‰è®¡ç®—çš„ï¼Œè€Œæ˜¯åœ¨ defer å…³é”®å­—è°ƒç”¨æ—¶è®¡ç®—çš„ï¼Œæœ€ç»ˆå¯¼è‡´ä¸Šè¿°ä»£ç è¾“å‡º 0sã€‚ æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å‘ defer å…³é”®å­—ä¼ å…¥åŒ¿åå‡½æ•°ï¼š func main() { startedAt := time.Now() defer func() { fmt.Println(time.Since(startedAt)) }() time.Sleep(time.Second) } $ go run main.go 1s 1.3.1.1 æ•°æ®ç»“æ„ deferåœ¨Goè¯­è¨€ä¸­çš„ç»“æ„ï¼š type _defer struct { siz int32 // å‚æ•°å’Œè¿”å›å€¼å…±å å¤šå°‘å­—èŠ‚ started bool // æ ‡è®°deferæ˜¯å¦å·²ç»æ‰§è¡Œ openDefer bool // sp uintptr // è°ƒç”¨è€…æ ˆæŒ‡é’ˆ pc uintptr // è¿”å›åœ°å€ fn *funcval // defer å…³é”®å­—ä¸­ä¼ å…¥çš„å‡½æ•°ï¼Œå³æ³¨å†Œå‡½æ•° _panic *_panic // è§¦å‘å»¶è¿Ÿè°ƒç”¨çš„ç»“æ„ä½“ï¼Œå¯èƒ½ä¸ºç©º link *_defer // ä¸‹ä¸€ä¸ª_deferæŒ‡é’ˆ } å¯ä»¥çœ‹å‡ºruntime._defer ç»“æ„ä½“å…¶å®æ˜¯_deferè°ƒç”¨é“¾è¡¨ä¸Šçš„ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€æœ‰çš„ç»“æ„ä½“éƒ½ä¼šé€šè¿‡ link å­—æ®µä¸²è”æˆé“¾è¡¨ã€‚ 1.3.1.2 æ‰§è¡Œæœºåˆ¶ å †åˆ†é…ã€æ ˆåˆ†é…å’Œå¼€æ”¾ç¼–ç æ˜¯å¤„ç† defer å…³é”®å­—çš„ä¸‰ç§æ–¹æ³•ã€‚ Go 1.12 å¼•å…¥ï¼šå †åˆ†é…runtime._defer ç»“æ„ä½“ï¼› Go 1.13 å¼•å…¥ï¼šæ ˆåˆ†é…çš„ç»“æ„ä½“ï¼› Go 1.14- å¼•å…¥ï¼šåŸºäºå¼€æ”¾ç¼–ç çš„ deferã€‚ 1.3.1.3 å †åˆ†é… deferprocå‡½æ•°æ‰§è¡Œæ—¶ï¼Œéœ€è¦å †åˆ†é…ä¸€æ®µç©ºé—´ï¼Œå­˜æ”¾_deferç»“æ„ä½“åŠå‚æ•°ä¸è¿”å›å€¼ã€‚å®é™…ä¸ŠGoè¯­è¨€ä¹Ÿä¼šé¢„åˆ†é…ä¸åŒè§„æ ¼çš„_deferæ± ï¼Œæ‰§è¡Œæ—¶ä»ç©ºé—²_deferæ± ä¸­å–å‡ºä¸€ä¸ªï¼Œæ²¡æœ‰åˆé€‚çš„æˆ–ç©ºé—²çš„å°±ä¼šè¿›è¡Œå †åˆ†é…ï¼Œç”¨å®Œä¹‹åå†æ”¾å…¥_deferæ± ï¼Œä»¥é¿å…é¢‘ç¹çš„å †åˆ†é…ä¸å›æ”¶ã€‚ Go 1.12 deferå¾ˆæ…¢ï¼åŸå› ï¼š _deferç»“æ„ä½“å †åˆ†é…ï¼šå³ä½¿æœ‰é¢„åˆ†é…çš„deferpoolï¼Œä¹Ÿéœ€è¦å»å †ä¸Šè·å–å’Œé‡Šæ”¾ï¼Œè€Œä¸”ï¼Œå‚æ•°è¿˜è¦åœ¨å †æ ˆé—´æ¥å›æ‹·è´ï¼› _deferæ³¨å†Œé€šè¿‡é“¾è¡¨ï¼šé“¾è¡¨æœ¬èº«çš„æ“ä½œå°±æ…¢ï¼ 1.3.1.4 æ ˆä¸Šåˆ†é… å…ˆæ¥å¯¹æ¯”ä¸€ä¸‹1.12ç‰ˆæœ¬å’Œ1.13ç‰ˆæœ¬ä¸­ï¼ŒdeferæŒ‡ä»¤ç¼–è¯‘åæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ 1.12 å°†_deferç»“æ„ä½“åˆ†é…åœ¨å †ä¸Šã€‚åœ¨1.13ä¸­ï¼Œé€šè¿‡åœ¨ç¼–è¯‘é˜¶æ®µï¼Œå¢åŠ å±€éƒ¨å˜é‡ï¼ŒæŠŠdeferä¿¡æ¯ä¿å­˜åˆ°å½“å‰å‡½æ•°æ ˆçš„å±€éƒ¨å˜é‡åŒºåŸŸï¼Œå†é€šè¿‡deferprocStackæŠŠæ ˆä¸Šè¿™ä¸ª_deferç»“æ„ä½“æ³¨å†Œåˆ°_deferé“¾è¡¨ä¸­ï¼Œæ‰§è¡Œä¾ç„¶æ˜¯é€šè¿‡deferreturnå®ç°ã€‚ä¼˜åŒ–ç‚¹ï¼šå‡å°‘deferä¿¡æ¯çš„å †åˆ†é…ã€‚ 1.13ä¸­çš„deferï¼Œå®˜æ–¹æä¾›çš„æ€§èƒ½æå‡æ˜¯30%ã€‚ 1.3.1.5 å¼€æ”¾ç¼–ç  Go 1.14æ˜¯é€šè¿‡åœ¨ç¼–è¯‘é˜¶æ®µæ’å…¥ä»£ç ï¼ŒæŠŠdeferå‡½æ•°çš„æ‰§è¡Œé€»è¾‘å±•å¼€åœ¨æ‰€å±å‡½æ•°å†…ï¼Œä»è€Œå…äºåˆ›å»º_deferç»“æ„ä½“ï¼Œè€Œä¸”ä¸éœ€è¦æ³¨å†Œåˆ°_deferé“¾è¡¨ã€‚è¿™ç§æ–¹å¼çœå»äº†æ„é€ _deferé“¾è¡¨é¡¹ï¼Œå¹¶æ³¨å†Œåˆ°é“¾è¡¨çš„è¿‡ç¨‹ã€‚ä¸¾ä¾‹è¯´æ˜ï¼š A1å¯ä»¥ç®€å•çš„é€šè¿‡ï¼šå®šä¹‰å±€éƒ¨å˜é‡ï¼Œå¹¶åœ¨returnå‰æ’å…¥è°ƒç”¨A1çš„æŒ‡ä»¤ æ¥å®ç°å»¶è¿Ÿè°ƒç”¨æ•ˆæœã€‚ä½†æ˜¯å¯¹äºA2å‘¢ï¼Ÿä»–åœ¨ç¼–è¯‘é˜¶æ®µæ˜¯æ— æ³•ç¡®å®šæ˜¯å¦è¢«è°ƒç”¨çš„ï¼Œå› æ­¤éœ€è¦ä¸€äº›å¤„ç†ã€‚ Goè¯­è¨€é€šè¿‡ä¸€ä¸ª**æ ‡è¯†å˜é‡df**æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ dfå˜é‡ä¸­çš„æ¯ä¸€ä½å¯¹åº”ä¸€ä¸ªdeferå‡½æ•°æ˜¯å¦è¦è¢«æ‰§è¡Œã€‚ è¿™é‡Œå…ˆä»¥A1ä¸¾ä¾‹ï¼š dfå˜é‡é¦–å…ˆéœ€è¦é€šè¿‡å¼‚æˆ–è¿ç®—|=å°†ç¬¬1ä½ç½®ä¸º1ï¼› returnå‰æ’å…¥çš„è°ƒç”¨æŒ‡ä»¤ä¹Ÿåº”è¯¥è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦åˆ¤æ–­dfå˜é‡ç¬¬1ä½æ˜¯å¦\u003e0ï¼Œè‹¥\u003e0ï¼Œåœ¨è°ƒç”¨A1å‰ï¼Œéœ€è¦å°†dfå˜é‡çš„ç¬¬1ä½ç½®ä¸º0ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…é‡å¤è°ƒç”¨ã€‚ å†ä»¥A2ä¸¾ä¾‹ï¼š é¦–å…ˆæ’å…¥ åˆ¤æ–­æ˜¯å¦éœ€è¦å°†A2çš„æ ‡å¿—ä½ç½®ä¸º1 çš„ä»£ç ï¼› ç„¶ååœ¨returnå‰æ’å…¥ æ£€æŸ¥dfæ ‡å¿—ä½ çš„ä»£ç ã€‚ è¿™ç§æ–¹æ³•å°†æ€§èƒ½æé«˜äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œä½†ä¸æ˜¯æ²¡æœ‰ä»£ä»·ã€‚ å¦‚æœåœ¨code to do somethingï¼Œä¹Ÿå°±æ˜¯è¿˜æœªæ‰§è¡Œåˆ°deferå‡½æ•°è°ƒç”¨å¤„ï¼Œå°±å‘ç”Ÿäº†panicæˆ–runtime.Goexitå‡½æ•°ï¼Œåé¢è¿™äº›ä»£ç æ ¹æœ¬æ— æ³•æ‰§è¡Œåˆ°ï¼Œå› æ­¤éœ€è¦é€šè¿‡æ ˆæ‰«æçš„æ–¹å¼æ¥å‘ç°ã€‚æ‰€ä»¥ï¼Œdeferå˜å¿«äº†ï¼Œä½†panicå˜å¾—æ›´æ…¢äº†ã€‚ 1.3.1.6 å°ç»“ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ˆä¸Šåˆ†é…å’Œå¼€æ”¾ç¼–ç çš„æ–¹æ³•å‡ä¸é€‚ç”¨äºå¾ªç¯ä¸­çš„deferï¼Œå› æ­¤ä¹Ÿä¿ç•™1.12ä¸­çš„å †åˆ†é…æ–¹æ³•ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:3:1","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"1.3.2 panicå’Œrecover panic èƒ½å¤Ÿæ”¹å˜ç¨‹åºçš„æ§åˆ¶æµï¼Œè°ƒç”¨ panic åä¼šç«‹åˆ»åœæ­¢æ‰§è¡Œå½“å‰å‡½æ•°çš„å‰©ä½™ä»£ç ï¼Œå¹¶åœ¨å½“å‰ Goroutine ä¸­é€’å½’æ‰§è¡Œè°ƒç”¨æ–¹çš„ deferï¼› recover å¯ä»¥ä¸­æ­¢ panic é€ æˆçš„ç¨‹åºå´©æºƒã€‚å®ƒæ˜¯ä¸€ä¸ªåªèƒ½åœ¨ defer ä¸­å‘æŒ¥ä½œç”¨çš„å‡½æ•°ï¼Œåœ¨å…¶ä»–ä½œç”¨åŸŸä¸­è°ƒç”¨ä¸ä¼šå‘æŒ¥ä½œç”¨ã€‚ 1.3.2.1 ç°è±¡ è·¨åç¨‹å¤±æ•ˆï¼španic åªä¼šè§¦å‘å½“å‰ Goroutine çš„ deferï¼› å¤±æ•ˆçš„å´©æºƒæ¢å¤ï¼šrecover åªæœ‰åœ¨ defer ä¸­è°ƒç”¨æ‰ä¼šç”Ÿæ•ˆï¼› åµŒå¥—å´©æºƒï¼španic å…è®¸åœ¨ defer ä¸­åµŒå¥—å¤šæ¬¡è°ƒç”¨ã€‚ è·¨åç¨‹å¤±æ•ˆ func main() { defer println(\"in main\") go func() { defer println(\"in goroutine\") panic(\"\") }() time.Sleep(1 * time.Second) } â¯ go run test_go.go in goroutine panic: ... ä¸Šè¿°ä»£ç æ²¡æœ‰æ‰§è¡Œmainä¸­çš„deferï¼Œåªæ‰§è¡Œäº† goroutine ä¸­çš„deferã€‚ **æ€»ç»“ï¼š**å½“ç¨‹åºå‘ç”Ÿå´©æºƒæ—¶åªä¼šè°ƒç”¨å½“å‰ goroutine çš„deferã€‚ å¤±æ•ˆçš„å´©æºƒæ¢å¤ func main() { defer println(\"in main\") if err := recover(); err != nil { fmt.Println(err) } panic(\"unknown err\") } â¯ go run test_go.go in main panic: unknown err ... åœ¨ä¸»ç¨‹åºä¸­è°ƒç”¨ recover è¯•å›¾ä¸­æ­¢ç¨‹åºçš„å´©æºƒï¼Œä½†æ˜¯ä»è¿è¡Œçš„ç»“æœä¸­æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºï¼Œç¨‹åºæ²¡æœ‰æ­£å¸¸é€€å‡ºã€‚åº”è¯¥å¦‚ä¸‹é¢è¿™æ ·å†™ï¼š func main() { defer println(\"in main\") defer func() { if err := recover(); err != nil { fmt.Println(\"é”™è¯¯å‘ç°:\", err) } }() panic(\"unknown err\") } â¯ go run test_go.go é”™è¯¯å‘ç°: unknown err in main å¯ä»¥å‘ç°ç¨‹åºæ­£å¸¸æ‰§è¡Œã€‚ æ€»ç»“ï¼šrecover åªæœ‰åœ¨å‘ç”Ÿ panic ä¹‹åè°ƒç”¨æ‰ä¼šç”Ÿæ•ˆã€‚ç„¶è€Œåœ¨ä¸Šé¢çš„æ§åˆ¶æµä¸­ï¼Œrecover æ˜¯åœ¨ panic ä¹‹å‰è°ƒç”¨çš„ï¼Œå¹¶ä¸æ»¡è¶³ç”Ÿæ•ˆçš„æ¡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ defer ä¸­ä½¿ç”¨ recover å…³é”®å­—ã€‚ åµŒå¥—å´©æºƒ func main() { defer println(\"in main\") defer func() { defer func() { panic(\"panic again and again\") }() panic(\"panic again\") }() panic(\"panic once\") } â¯ go run test_go.go in main panic: panic once panic: panic again panic: panic again and again ... å¯ä»¥ç¡®å®šç¨‹åºå¤šæ¬¡è°ƒç”¨ panic ä¹Ÿä¸ä¼šå½±å“ defer å‡½æ•°çš„æ­£å¸¸æ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨ defer è¿›è¡Œæ”¶å°¾å·¥ä½œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯å®‰å…¨çš„ã€‚ 1.3.2.2 æ•°æ®ç»“æ„ panic å…³é”®å­—åœ¨ Go è¯­è¨€çš„æºä»£ç æ˜¯ç”±æ•°æ®ç»“æ„ runtime._panic è¡¨ç¤ºçš„ï¼š type _panic struct { argp unsafe.Pointer // deferçš„å‚æ•°ç©ºé—´ arg interface{} // panicçš„å‚æ•° link *_panic // link to earlier panic recovered bool // æ˜¯å¦è¢« recover æ¢å¤ aborted bool // æ˜¯å¦è¢«ç»ˆæ­¢ pc uintptr sp unsafe.Pointer goexit bool } å’Œdeferä¸€æ ·ï¼Œpanicä¹Ÿæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå½“æœ‰æ–°çš„panicå‡ºç°ï¼Œä¹Ÿæ˜¯åœ¨é“¾è¡¨å¤´æ’å…¥æ–°çš„_panicç»“æ„ä½“ã€‚ panicæ‰§è¡Œdeferæ—¶ï¼Œæ˜¯ä»å¤´å¼€å§‹æ‰§è¡Œçš„ã€‚é¦–å…ˆæŠŠ_deferçš„startedå­—æ®µç½®ä¸ºtrueï¼Œæ ‡è®°è¯¥deferå·²ç»å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”ä¼šæŠŠpanicå­—æ®µæŒ‡å‘å½“å‰æ‰§è¡Œçš„panicï¼Œè¡¨ç¤ºè¿™ä¸ªdeferæ˜¯ç”±è¿™ä¸ªpanicè§¦å‘çš„ã€‚ å¦‚æœå‡½æ•°A2èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šç§»é™¤A2ã€‚ ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œæ˜¯ä¸ºäº†åº”å¯¹deferå‡½æ•°æ²¡æœ‰æ­£å¸¸ç»“æŸçš„æƒ…å†µã€‚å‡å¦‚æ­¤æ—¶A2é¡ºåˆ©æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰§è¡ŒA1ï¼š å› ä¸ºA1ä¹Ÿä¼šè§¦å‘panicï¼Œé‚£ä¹ˆéœ€è¦å°†panicA1é“¾åœ¨panicå¤´éƒ¨ï¼Œæ­¤æ—¶æ­£åœ¨æ‰§è¡Œçš„panicå°±å˜æˆäº†panicA1ï¼Œç„¶åä¹Ÿä¼šå»æ‰§è¡Œdeferé“¾è¡¨ï¼Œä»æ ‡è®°å­—æ®µä¼šå‘ç°A1å·²ç»åœ¨æ‰§è¡Œäº†ï¼Œä¸”è§¦å‘ä»–çš„panicæ˜¯panicAï¼Œæ‰€ä»¥ä¼šæ ¹æ®è¯¥æŒ‡é’ˆæ‰¾åˆ°panicAï¼ŒæŠŠä»–**abortedæ ‡è®°ä¸ºå·²ç»ˆæ­¢**ã€‚ æ‰€ä»¥ç°åœ¨panicAå·²ç»ˆæ­¢ï¼ŒA1ä¹Ÿæ‰§è¡Œå®Œæ¯•ï¼ŒA1ä¼šè¢«ç§»é™¤ï¼Œå½“å‰deferé“¾è¡¨ä¸ºç©ºã€‚ æ¥ä¸‹æ¥å°±è¯¥æ‰“å°panicä¿¡æ¯äº†ï¼Œæ³¨æ„ï¼š**panicæ‰“å°å¼‚å¸¸ä¿¡æ¯æ—¶ï¼Œä¼šä»é“¾è¡¨å°¾å¼€å§‹ï¼Œå³panicçš„å‘ç”Ÿé¡ºåºé€ä¸ªè¾“å‡ºã€‚**æ‰€ä»¥æ­¤å¤„ä¼šå…ˆpanicAï¼Œå†panic A1ã€‚ 1.3.2.3 recover ä¸Šè¿°è¿‡ç¨‹æ²¡æœ‰æ·»åŠ recoverï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æ·»åŠ recoverä¹‹åçš„æƒ…å†µã€‚ recoveråªåšä¸€ä»¶äº‹ï¼Œå°±æ˜¯æŠŠå½“å‰panicçš„recoveredå­—æ®µå˜ä¸ºtrueã€‚ **ä»¥ä¸‹ä¸ºä¾‹ã€‚**å½“æ‰§è¡Œå®ŒA2æ—¶ï¼Œä¼šå°†å½“å‰panicAçš„recovered=trueã€‚æ¯ä¸ªdeferæ‰§è¡Œå®Œæ¯•ï¼Œpanicéƒ½ä¼šæ£€æŸ¥å½“å‰recoveredæ˜¯å¦ä¸ºtrueã€‚æ­¤æ—¶ä¼šå‘ç°panicAå·²ç»è¢«æ¢å¤äº†ï¼Œå°±ä¼šæŠŠä»–ä»panicé“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶ä¸”ç§»é™¤A2ã€‚ä¸è¿‡A2è¢«ç§»é™¤ä¹‹å‰ï¼Œè¦ä¿å­˜_defer.spå’Œ_defer.pcï¼Œæ¥ä¸‹æ¥å°±è¦åˆ©ç”¨è¿™ä¸¤ä¸ªå€¼è·³å‡ºpanicAçš„å¤„ç†æµç¨‹ã€‚ spå’Œpcæ˜¯æ³¨å†Œdeferå‡½æ•°æ—¶ä¿å­˜çš„ã€‚è¿™é‡Œspå°±æ˜¯å‡½æ•°Açš„æ ˆæŒ‡é’ˆï¼Œè€Œpcå°±æ˜¯è°ƒç”¨deferprocå‡½æ•°çš„è¿”å›åœ°å€ã€‚ é€šè¿‡spå¯ä»¥è¿”å›åˆ°å‡½æ•°Açš„æ ˆå¸§ï¼Œé€šè¿‡pcå¯ä»¥è¿”å›åˆ°è°ƒç”¨deferprocå¤„(å³åˆ¤å®šr\u003e0)å¤„ã€‚è‹¥æ­¤æ—¶r=0ï¼Œé‚£ä¹ˆcode to do somethingå°±ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šå°†å¯„å­˜å™¨ä¸­çš„r=1ï¼Œè¿™æ ·å°±å¯ä»¥è·³è½¬åˆ°deferreturnå¤„ï¼Œç»§ç»­æ‰§è¡Œdeferé“¾è¡¨ã€‚**æ³¨æ„ï¼šdeferreturnåªè´Ÿè´£æ‰§è¡Œå½“å‰å‡½æ•°Aæ³¨å†Œçš„deferå‡½æ•°ï¼Œ**ä»–æ˜¯é€šè¿‡æ ˆæŒ‡é’ˆæ¥åˆ¤æ–­çš„ã€‚ æ‰€ä»¥ï¼ŒA2æ‰§è¡Œå®Œæ¯•ï¼Œè¿˜ä¼šç»§ç»­æ‰§è¡ŒA1ï¼Œæ‰§è¡Œå®Œæ¯•å°±ç»“æŸäº†ã€‚ **è¿™é‡Œè¦æ³¨æ„ï¼š**åªæœ‰å½“deferå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œpanicæ‰ä¼šå»æ£€æŸ¥æ˜¯å¦è¢«æ¢å¤ã€‚ä½†æ˜¯å¦‚æœdeferå…ˆrecoverï¼Œç„¶ååˆpanicäº†å‘¢ï¼Ÿ æ­¤æ—¶ï¼Œç”±äºå‘ç”Ÿäº†panicï¼Œæ‰€ä»¥ä¼šå°†panicA2æ³¨å†Œåˆ°panicé“¾è¡¨å¤´ï¼Œå¹¶æˆä¸ºå½“å‰çš„panicï¼Œä»–ä¼šå»æ‰§è¡Œdeferé“¾è¡¨ï¼Œå½“æ‰§è¡ŒA2æ—¶ï¼Œä»æ ‡è®°å­—æ®µå‘ç°A2å·²ç»å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”è§¦å‘è€…æ˜¯panicAï¼Œé‚£ä¹ˆä¼šå°†panicAç»ˆæ­¢(aborted=true)ï¼Œå¹¶æŠŠA2ä»deferé“¾è¡¨ç§»é™¤ã€‚ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªdeferï¼ŒA1å°±æ˜¯ç”±panicA2è§¦å‘çš„äº†ã€‚ A1æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè¢«ç§»é™¤ï¼Œæ­¤æ—¶deferé“¾è¡¨ä¸ºç©ºã€‚ æ¥ä¸‹æ¥å°±è¦è¾“å‡ºpanicä¿¡æ¯äº†ã€‚ æ³¨æ„ï¼šåœ¨è¾“å‡ºå·²ç»è¢«recoverçš„panicæ—¶ï¼Œæ‰“å°æ—¶ä¼šå¸¦ä¸Šrecoveredæ ‡è®°ã€‚panicæ¯ä¸€é¡¹è¢«è¾“å‡ºåï¼Œç¨‹åºé€€å‡ºã€‚ å°ç»“ ç”¨deferè¿›è¡Œæ”¶å°¾å·¥ä½œé€šå¸¸æ˜¯å®‰å…¨çš„ï¼Œè¿™æ˜¯å› ä¸ºpanicå¯ä»¥ç»ˆæ­¢å…¶ä»–ä»£ç çš„æ‰§è¡Œï¼Œä½†ä¸ä¼šå½±å“åˆ°deferçš„æ‰§è¡Œã€‚ åœ¨åˆ¤æ–­panicçš„æ‰§è¡Œè¿‡ç¨‹æ—¶ï¼Œåªéœ€è¦æŠŠæ¡ä½ä¸¤ä¸ªé“¾è¡¨deferå’Œpanicçš„æ‰§è¡Œé¡ºåºå³å¯ã€‚ äºŒã€è¿è¡Œæ—¶ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:3:2","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1 å¹¶å‘ç¼–ç¨‹ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.1 GMP 2.1.1.1 æ¦‚è¿° Goè¯­è¨€åœ¨å¹¶å‘ç¼–ç¨‹æ–¹é¢æœ‰å¼ºå¤§çš„èƒ½åŠ›ï¼Œè¿™ç¦»ä¸å¼€è¯­è¨€å±‚é¢å¯¹å¹¶å‘ç¼–ç¨‹çš„æ”¯æŒã€‚è°ˆåˆ°Goè¯­è¨€è°ƒåº¦å™¨ï¼Œç»•ä¸å¼€çš„æ˜¯æ“ä½œç³»ç»Ÿã€è¿›ç¨‹ä¸çº¿ç¨‹è¿™äº›æ¦‚å¿µã€‚ **å¤šä¸ªçº¿ç¨‹å¯ä»¥å±äºåŒä¸€ä¸ªè¿›ç¨‹å¹¶å…±äº«å†…å­˜ç©ºé—´ã€‚**å› ä¸ºå¤šçº¿ç¨‹ä¸éœ€è¦åˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä»¬ä¹Ÿä¸éœ€è¦å†…å­˜ç®¡ç†å•å…ƒå¤„ç†ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ä¹Ÿæ­£æ˜¯åŸºäºå…±äº«çš„å†…å­˜è¿›è¡Œçš„ï¼Œä¸é‡é‡çº§çš„è¿›ç¨‹ç›¸æ¯”ï¼Œçº¿ç¨‹æ˜¾å¾—æ¯”è¾ƒè½»é‡ã€‚è¿™ä¸æ˜¯æŒºå¥½çš„å˜›ï¼Œä¸ºå•¥è¿˜è¦å¼•å…¥goroutineï¼Ÿ **å¼•å…¥goroutineçš„åŸå› ï¼š**è™½ç„¶çº¿ç¨‹æ¯”è¾ƒè½»é‡ï¼Œä½†æ˜¯åœ¨è°ƒåº¦æ—¶ä¹Ÿæœ‰æ¯”è¾ƒå¤§çš„é¢å¤–å¼€é”€ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå ç”¨ 1M ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ï¼Œåœ¨åˆ‡æ¢çº¿ç¨‹æ—¶ä¸æ­¢ä¼šæ¶ˆè€—è¾ƒå¤šçš„å†…å­˜ï¼Œæ¢å¤å¯„å­˜å™¨ä¸­çš„å†…å®¹è¿˜éœ€è¦å‘æ“ä½œç³»ç»Ÿç”³è¯·æˆ–è€…é”€æ¯èµ„æºï¼Œæ¯ä¸€æ¬¡çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éƒ½éœ€è¦æ¶ˆè€— ~1us å·¦å³çš„æ—¶é—´ï¼Œä½†æ˜¯ Go è°ƒåº¦å™¨å¯¹ Goroutine çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çº¦ä¸º ~0.2usï¼Œå‡å°‘äº† 80% çš„é¢å¤–å¼€é”€ã€‚ ==Pointï¼š== Goè¯­è¨€ä¸­ï¼š åç¨‹å¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯runtime.gï¼› å·¥ä½œçº¿ç¨‹å¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯runtime.mï¼› åæ¥å¼•å…¥äº†runtine.pï¼Œ**å¼•å…¥åŸå› ï¼š**ä¸€å¼€å§‹æ‰€æœ‰çš„géƒ½åœ¨ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå¤šä¸ªmä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–gæ—¶éœ€è¦é¢‘ç¹çš„åŠ è§£é”åŠç­‰å¾…ï¼›å¼•å…¥påï¼Œmå°±å¯ä»¥ç›´æ¥ä»å…³è”çš„på¤„è·å–å¾…æ‰§è¡Œçš„gï¼Œä¸ç”¨æ¯æ¬¡éƒ½å’Œä¼—å¤šmä»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­äº‰æŠ¢ä»»åŠ¡ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚ å…¶ä¸­ï¼Œallgsã€allmã€allpåˆ†åˆ«è®°å½•æ‰€æœ‰çš„gã€må’Œpã€‚ é¦–å…ˆçœ‹ä¸€ä¸ªç®€å•çš„åœºæ™¯ åªæœ‰ä¸€ä¸ªmian.mainã€‚ åœ¨main goroutineåˆ›å»ºå‰ï¼ŒGã€Pã€Mçš„æƒ…å†µå¦‚ä¸Šå›¾ã€‚ main goroutineåˆ›å»ºåï¼Œè¢«åŠ å…¥å½“å‰Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼› ç„¶åé€šè¿‡mstartå¼€å¯è°ƒåº¦å¾ªç¯ã€‚è¿™ä¸ªmstartæ˜¯æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„å…¥å£ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨scheduleå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè°ƒåº¦å¾ªç¯ã€‚ å½“å‰é˜Ÿåˆ—ä¸­åªæœ‰main goroutineç­‰å¾…æ‰§è¡Œï¼Œæ‰€ä»¥m0åˆ‡æ¢åˆ°main goroutineï¼› æ‰§è¡Œå…¥å£è‡ªç„¶æ˜¯runtime.mainï¼Œå®ƒä¼šåšå¾ˆå¤šäº‹æƒ…ï¼šåˆ›å»ºç›‘æ§çº¿ç¨‹ã€è¿›è¡ŒåŒ…åˆå§‹åŒ–ç­‰ï¼ŒåŒ…æ‹¬è°ƒç”¨main.mainï¼Œç„¶åå°±å¯ä»¥æ‰§è¡Œmain.mainäº†ï¼ ä¸€ä¸ªæ”¹è¿›çš„åœºæ™¯ åœ¨main.mainä¸­åˆåˆ›å»ºæ–°çš„goroutineã€‚ æˆ‘ä»¬é€šè¿‡goå…³é”®å­—åˆ›å»ºgoroutineï¼Œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºnewprocå‡½æ•°è°ƒç”¨ã€‚(main goroutineä¹Ÿæ˜¯ç”±newprocåˆ›å»ºçš„) åˆ›å»ºgoroutineæ—¶ï¼Œæˆ‘ä»¬åªè´Ÿè´£æŒ‡å®šå…¥å£ã€å‚æ•°ï¼Œè€Œnewprocä¼šç»™goroutineæ„é€ ä¸€ä¸ªæ ˆå¸§ï¼Œç›®çš„æ˜¯è®©åç¨‹ä»»åŠ¡ç»“æŸåï¼Œè¿”å›åˆ°go exitå‡½æ•°ä¸­ï¼Œè¿›è¡Œåç¨‹èµ„æºå›æ”¶å¤„ç†ç­‰å·¥ä½œã€‚ æ–°åˆ›å»ºçš„goroutineï¼Œæ­¤å¤„å«åšhello goroutineï¼Œä¼šè¢«æ·»åŠ åˆ°å½“å‰Pçš„æœ¬åœ°runqä¸­ï¼› ç„¶åmain.mainå°±ä¼šè¿”å›äº†ï¼Œç„¶åexit()å‡½æ•°è¢«è°ƒç”¨ï¼Œè¿›ç¨‹å°±ç»“æŸäº†ã€‚æ‰€ä»¥æ­¤å¤„hello goroutineå¹¶æœªèƒ½æ‰§è¡Œã€‚ **é—®é¢˜ï¼š**é—®é¢˜åœ¨äºï¼Œå½“main.mainè¿”å›åï¼Œç›´æ¥ä¼šè°ƒç”¨exit()å‡½æ•°ï¼Œä¼šæŠŠè¿›ç¨‹éƒ½ç»“æŸæ‰ï¼Œæ²¡ç»™hello goroutineè°ƒåº¦æ‰§è¡Œçš„æ—¶é—´ã€‚æ‰€ä»¥åº”è¯¥åœ¨main.mainè¿”å›å‰ï¼Œæ‹–å»¶ç‚¹æ—¶é—´ç»™hello goroutineæ‰§è¡Œã€‚ 2.1.1.2 goroutineåˆ›å»ºã€è®©å‡ºä¸æ¢å¤ è¿˜é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹ã€‚ é€šè¿‡å‡½æ•°æ ˆå¸§çœ‹ä¸€ä¸‹newprocçš„è°ƒç”¨è¿‡ç¨‹ï¼š mainå‡½æ•°æ ˆå¸§è‡ªç„¶åˆ†é…åœ¨main goroutineçš„åç¨‹æ ˆä¸­ï¼› newprocä¸»è¦åšçš„å°±æ˜¯åˆ‡æ¢åˆ°g0æ ˆå»è°ƒç”¨newproc1å‡½æ•°ï¼›ä¸ºä»€ä¹ˆè¦åˆ‡æ¢åˆ°g0æ ˆå‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œg0æ ˆç©ºé—´å¤§ã€‚å› ä¸ºruntimeä¸­å¾ˆå¤šå‡½æ•°éƒ½æœ‰no-splitæ ‡è®°ï¼Œæ„å‘³ç€è¿™ä¸ªå‡½æ•°ä¸æ”¯æŒæ ˆå¢é•¿ï¼Œè€Œåç¨‹æ ˆç©ºé—´æœ¬æ¥å°±å°ï¼Œå®¹æ˜“æ ˆæº¢å‡ºï¼Œè€Œg0çš„æ ˆç›´æ¥åˆ†é…åœ¨çº¿ç¨‹æ ˆä¸Šï¼Œæ ˆç©ºé—´è¶³å¤Ÿå¤§ã€‚ newproc1(åç¨‹å…¥å£, å‚æ•°åœ°å€, å‚æ•°å¤§å°, çˆ¶åç¨‹, è¿”å›åœ°å€)ï¼› newproc1é¦–å…ˆé€šè¿‡acquirem()ç¦æ­¢å½“å‰mè¢«æŠ¢å ã€‚**ä¸ºä»€ä¹ˆä¸èƒ½è¢«æŠ¢å ï¼Ÿ**å› ä¸ºæ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ç¨‹åºä¸­ï¼Œå¯èƒ½ä¼šæŠŠå½“å‰pä¿å­˜åˆ°å±€éƒ¨å˜é‡ä¸­ï¼Œè‹¥æ­¤æ—¶mè¢«æŠ¢å ï¼Œpå…³è”åˆ°åˆ«çš„mï¼Œç­‰å†æ¬¡æ¢å¤æ—¶ï¼Œç»§ç»­ä½¿ç”¨è¿™ä¸ªå±€éƒ¨å˜é‡é‡Œä¿å­˜çš„pï¼Œå°±ä¼šé€ æˆé—®é¢˜ã€‚æ‰€ä»¥ä¸ºäº†ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œä¼šæš‚æ—¶ç¦æ­¢mè¢«æŠ¢å ã€‚ æ¥ä¸‹æ¥ï¼Œä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„gï¼Œå¦‚æœå½“å‰på’Œè°ƒåº¦å™¨ä¸­éƒ½æ²¡æœ‰ç©ºé—²çš„gï¼Œå°±åˆ›å»ºä¸€ä¸ªå¹¶æ·»åŠ åˆ°å…¨å±€å˜é‡allgsä¸­ã€‚æ­¤å¤„æˆ‘ä»¬ä¾ç„¶å°†æ­¤æ·»åŠ çš„gè®°ä¸ºhello goroutineï¼Œæ­¤æ—¶å®ƒçš„çŠ¶æ€æ˜¯_Gdeadï¼Œè€Œä¸”å·²ç„¶æ‹¥æœ‰è‡ªå·±çš„åç¨‹æ ˆã€‚ æ¥ä¸‹æ¥ï¼Œå¦‚æœåç¨‹å…¥å£å‡½æ•°æœ‰å‚æ•°ï¼Œå°±æŠŠå‚æ•°ç§»åŠ¨(æ‹·è´)åˆ°åç¨‹æ ˆä¸Šã€‚ æ¥ä¸‹æ¥ï¼Œä¼šæŠŠgoexit()çš„åœ°å€+1ï¼Œå‹å…¥åç¨‹æ ˆï¼Œå³è¿”å›åœ°å€ï¼› å†æŠŠåç¨‹(hello goroutine)å¯¹åº”çš„gçš„startpcç½®ä¸ºåç¨‹å…¥å£å‡½æ•°çš„èµ·å§‹åœ°å€ï¼Œgopcç½®ä¸ºçˆ¶åç¨‹è°ƒç”¨newprocåçš„è¿”å›åœ°å€ï¼Œg.schedç»“æ„ä½“ç”¨äºä¿å­˜ç°åœºï¼šg.sched.spç½®ä¸ºåç¨‹æ ˆæŒ‡é’ˆï¼Œg.sched.pcç½®ä¸ºåç¨‹å…¥å£å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚ ç­‰åˆ°è¿™ä¸ªåç¨‹å¾—åˆ°è°ƒåº¦æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡g.schedæ¢å¤ç°åœºï¼Œå°±ä¼šä»åç¨‹å…¥å£å‡½æ•°å¤„å¼€å§‹æ‰§è¡Œï¼Œè€Œå‡½æ•°ç»“æŸåä¾¿ä¼šè¿”å›åˆ°goexit()ä¸­ï¼Œæ‰§è¡Œåç¨‹èµ„æºå›æ”¶ç­‰æ”¶å°¾å·¥ä½œã€‚åˆ°æ­¤ï¼Œåç¨‹å¦‚ä½•å‡ºåœºä¸æ”¶åœºå°±éƒ½æœ‰äº†ç€è½ã€‚ æ¥ä¸‹æ¥ï¼Œnewproc1è¿˜ä¼šç»™æ–°å»ºçš„goroutineèµ‹äºˆä¸€ä¸ªå”¯ä¸€idã€‚ç»™g.goidèµ‹å€¼å‰ï¼Œä¼šæŠŠåç¨‹çš„çŠ¶æ€ç½®ä¸º_Grunnableï¼Œè¿™ä¸ªçŠ¶æ€æ„å‘³ç€è¿™ä¸ªgå¯ä»¥è¿›åˆ°run queueä¸­äº†ã€‚ æ‰€ä»¥æ¥ä¸‹æ¥ä¼šè°ƒç”¨runqputæŠŠè¿™ä¸ªgæ”¾åˆ°å½“å‰pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚ æ¥ä¸‹æ¥åˆ¤æ–­ï¼Œå¦‚æœå½“å‰æœ‰ç©ºé—²pï¼Œè€Œä¸”æ²¡æœ‰å¤„äºspinningçŠ¶æ€çš„mï¼Œå³æ‰€æœ‰méƒ½å¿™ï¼Œè€Œä¸”ä¸»åç¨‹å·²ç»å¼€å§‹æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå°±è°ƒç”¨wakep()ï¼šå¯åŠ¨ä¸€ä¸ªmå¹¶æŠŠå®ƒç½®ä¸ºspinningçŠ¶æ€ã€‚ æœ€åä¸ä¸€å¼€å§‹çš„acquirem()å‘¼åº”ï¼Œä¼šè°ƒç”¨releasem()å…è®¸å½“å‰mè¢«æŠ¢å ï¼›è€ŒspinningçŠ¶æ€çš„må¯åŠ¨åï¼Œä¼šä¸€ç›´æ‰§è¡Œè°ƒåº¦å¾ªç¯å¯»æ‰¾ä»»åŠ¡ï¼Œä»æœ¬åœ°runqåˆ°å…¨å±€runqå†åˆ°å…¶ä»–pçš„runqï¼Œåªä¸ºæ‰¾åˆ°ä¸ªå¾…æ‰§è¡Œçš„gã€‚ä½†æ­¤æ—¶ï¼Œè‹¥main.mainå·²ç»è¿”å›ï¼Œé‚£ä¹Ÿä¸ä¼šæ‰§è¡Œå‰©ä½™çš„gã€‚ æ­¤å¤„æˆ‘ä»¬é€šè¿‡ç­‰å¾…ä¸€ä¸ªchannelæ¥å®ç°è°ƒåº¦æ‰§è¡Œgã€‚ å½“å‰main goroutineä¼šé˜»å¡åœ¨\u003c-chè¿™é‡Œç­‰å¾…æ•°æ®ï¼› ç„¶åchanrecv()é€šè¿‡gopark()å‡½æ•°æŒ‚èµ·å½“å‰goroutineï¼Œè®©å‡ºcpuï¼› gopark()é¦–å…ˆä¼šè°ƒç”¨acquirem()ç¦æ­¢å½“å‰mè¢«æŠ¢å ï¼Œç„¶åæŠŠmain goroutineçš„çŠ¶æ€ä»_Grunningä¿®æ”¹ä¸º_Gwaitingï¼Œmain goroutineå°±ä¸å†æ˜¯æ‰§è¡Œä¸­çŠ¶æ€äº†ï¼› æ¥ä¸‹æ¥è°ƒç”¨releasem()è§£é™¤mçš„æŠ¢å ç¦ä»¤ï¼› æœ€åè°ƒç”¨mcall(park_m)ï¼šè´Ÿè´£ä¿å­˜å½“å‰åç¨‹çš„æ‰§è¡Œç°åœºï¼› ç„¶ååˆ‡æ¢åˆ°g0æ ˆï¼Œè°ƒç”¨ç”±mcallçš„å‚æ•°ä¼ å…¥çš„è¿™ä¸ªå‡½æ•°ï¼Œå¯¹åº”åˆ°è¿™é‡Œå°±æ˜¯park_m()å‡½æ•°ï¼› park_m()å‡½æ•°ä¼šæ ¹æ®g0æ‰¾åˆ°å½“å‰mï¼ŒæŠŠm.curgç½®ä¸ºnilã€‚æ­¤æ—¶å½“å‰mæ­£åœ¨æ‰§è¡Œçš„gä¾¿ä¸å†æ˜¯main goroutineäº†ï¼› æœ€åä¼šè°ƒç”¨schedule()å¯»æ‰¾ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„gã€‚ ç„¶åï¼Œhello goroutineè¦ä¹ˆè¢«å½“å‰m0è°ƒåº¦æ‰§è¡Œï¼Œè¦ä¹ˆè¢«å…¶ä»–mè°ƒåº¦æ‰§è¡Œï¼Œæ€»å½’æ˜¯èƒ½æ‰§è¡Œäº†ã€‚ ç­‰åˆ°hello goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå…³é—­main gorutineç­‰å¾…çš„channelæ—¶ï¼Œä¸æ­¢ä¼šä¿®æ”¹channelçš„closedçŠ¶æ€ï¼Œè¿˜ä¼šå¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„gï¼Œæœ€ç»ˆè°ƒç”¨goready()å‡½æ•°æ¥ç»“æŸè¿™ä¸ªgçš„ç­‰å¾…çŠ¶æ€ï¼› è€Œgoready()å‡½æ•°ä¼šåˆ‡æ¢åˆ°g0æ ˆï¼Œå¹¶æ‰§è¡Œruntime.ready()å‡½æ•°ï¼Œç›®å‰å¾…readyçš„åç¨‹è‡ªç„¶æ˜¯main goroutineï¼Œæ­¤æ—¶å®ƒçš„çŠ¶æ€æ˜¯_Gwaitingï¼Œæ¥ä¸‹æ¥ä¼šè¢«ä¿®æ”¹ä¸º_Grunnableï¼Œè¡¨ç¤ºå®ƒåˆå¯ä»¥è¢«è°ƒåº¦æ‰§è¡Œäº†ã€‚ ç„¶åï¼Œå®ƒä¼šè¢«æ”¾å…¥å½“å‰pçš„æœ¬åœ°runqä¸­ï¼ŒåŒåç¨‹åˆ›å»ºæ—¶ä¸€æ ·ï¼Œæ¥ä¸‹æ¥ä¹Ÿä¼šæ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²çš„pï¼Œå¹¶ä¸”æ²¡æœ‰spinningçŠ¶æ€çš„mï¼Œæ˜¯çš„è¯ï¼Œä¹Ÿä¼šè°ƒç”¨weakp()å‡½æ•°å¯åŠ¨æ–°çš„mï¼› æ¥ä¸‹æ¥hello goroutineç»“æŸï¼Œmain goroutineå¾—åˆ°è°ƒåº¦æ‰§è¡Œï¼Œæœ€ç»ˆç»“æŸè¿›ç¨‹ã€‚ æ€»ç»“ï¼šåº•å±‚é€šè¿‡newprocåˆ›å»ºgoroutineï¼Œé€šè¿‡goparkå®ç°åç¨‹è®©å‡ºï¼Œä½¿ç”¨goreadyæŠŠåç¨‹æ¢å¤åˆ°runnableçŠ¶æ€æ”¾å›åˆ°runqä¸­ æ¥ä¸‹æ¥ï¼Œå°±éœ€è¦äº†è§£è°ƒåº¦å¾ªç¯schedule()æ˜¯åšå•¥çš„äº†ï¼Œä»¥åŠå¦‚ä½•æŠŠä¸€ä¸ªå¯è¿è¡Œçš„åç¨‹çœŸæ­£çš„è¿è¡Œèµ·æ¥ï¼Ÿ 2.1.1.3 goroutineè®©å‡ºã€æŠ¢å ã€ç›‘æ§å’Œè°ƒåº¦ åç¨‹è®©å‡ºCPUåˆ†ä¸ºä¸¤ç§ï¼šä¸»åŠ¨è®©å‡ºå’Œè¢«åŠ¨è®©å‡º(æŠ¢å )ã€‚å…¶ä¸­ï¼Œä¸»åŠ¨è®©å‡ºæŒ‡åç¨‹è‡ªèº«è¦ç­‰å¾…æŸç§æ¡ä»¶è€Œä¸»åŠ¨è®©å‡ºï¼Œè¢«åŠ¨è®©å‡ºæŒ‡è°ƒåº¦å™¨é€šè¿‡æŸç§è§„åˆ™å¼ºåˆ¶ä½¿åç¨‹è®©å‡ºã€‚ ä¸»åŠ¨è®©å‡º ä¸»åŠ¨è®©å‡ºä¸»è¦åŒ…æ‹¬ä¸‰ç§å½¢å¼ï¼štime.Sleep()ï¼Œ\u003c-chanå’ŒI/Oæ“ä½œã€‚ time.Sleep() æ•´ä½“è¿‡ç¨‹ï¼šåç¨‹æ‰§è¡Œtime.Sleep()æ—¶ï¼ŒçŠ¶æ€ä¼šä»_Grunningå˜ä¸º_Gwaitingï¼Œå¹¶è¿›å…¥åˆ°å¯¹åº”çš„timerä¸­ç­‰å¾…ï¼Œè€Œtimerä¸­æŒæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨æŒ‡å®šæ—¶é—´åˆ°è¾¾åè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼ŒæŠŠç­‰åœ¨è¿™é‡Œçš„åç¨‹æ¢å¤åˆ°_GrunnableçŠ¶æ€å¹¶æ”¾å›åˆ°runqä¸­ã€‚ **è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Ÿ**è°è´Ÿè´£è§¦å‘timeræ³¨å†Œçš„å›è°ƒå‡½æ•°å‘¢ï¼Ÿ ç­”ï¼šå…¶å®æ¯ä¸ªpéƒ½æœ‰ä¸€ä¸ªæœ€å°å †ï¼Œå­˜å‚¨åœ¨p.timersä¸­ï¼Œç”¨äºç®¡ç†è‡ªå·±çš„timerï¼Œå †é¡¶çš„timerå°±æ˜¯æ¥ä¸‹æ¥è¦è§¦å‘çš„é‚£ä¸€ä¸ªã€‚è€Œæ¯æ¬¡è°ƒåº¦æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨checkTimers()å‡½æ•°ï¼Œæ£€æŸ¥å¹¶æ‰§è¡Œé‚£äº›å·²ç»åˆ°æ—¶é—´çš„timerã€‚ä¸è¿‡è¿™ä¸å¤Ÿç¨³å¦¥ï¼Œä¸‡ä¸€æ‰€æœ‰çš„méƒ½åœ¨å¿™ï¼Œé‚£ä¹ˆå°±ä¸èƒ½åŠæ—¶è§¦å‘è°ƒåº¦äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´timeræ‰§è¡Œæ—¶é—´å‘ç”Ÿè¾ƒå¤§åå·®ã€‚æ‰€ä»¥è¿˜ä¼šé€šè¿‡ç›‘æ§çº¿ç¨‹æ¥å¢åŠ ä¸€å±‚ä¿éšœã€‚ (æ¥ä¸Š)ã€‚ç›‘æ§çº¿ç¨‹æ˜¯ç”±main goroutineåˆ›å»ºçš„ï¼Œä¸GPMä¸­çš„å·¥ä½œ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:1","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.2 Mutex Mutexçš„ç”±æ¥ï¼Œåº”è¯¥æ˜¯mutual exclusionçš„å‰ç¼€ç»„åˆï¼Œç§°ä¸º\"äº’æ–¥é”\"ã€‚ 2.1.2.1 ä¸¤ç§æ¨¡å¼ Goè¯­è¨€syncåŒ…ä¸­Mutexçš„æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„ï¼š type Mutex struct { state int32 // å­˜å‚¨äº’æ–¥é”çš„çŠ¶æ€ sema uint32 // ä¿¡å·é‡, ç”¨ä½œç­‰å¾…é˜Ÿåˆ— } stateå­˜å‚¨äº’æ–¥é”çš„çŠ¶æ€ï¼ŒåŠ é”å’Œè§£é”éƒ½æ˜¯é€šè¿‡atomicåŒ…æä¾›çš„å‡½æ•°åŸå­æ€§çš„æ“ä½œè¯¥å­—æ®µï¼š semaç”¨ä½œä¸€ä¸ªä¿¡å·é‡ï¼Œä¸»è¦ç”¨ä½œç­‰å¾…é˜Ÿåˆ—ã€‚ Mutexæœ‰ä¸¤ç§æ¨¡å¼ï¼š **æ­£å¸¸æ¨¡å¼ï¼šåœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªå°è¯•åŠ é”çš„goroutineä¼šå…ˆè‡ªæ—‹å‡ æ¬¡ï¼Œå°è¯•é€šè¿‡åŸå­æ“ä½œè·å¾—é”ã€‚è‹¥å‡ æ¬¡è‡ªæ—‹(è‡ªæ—‹é˜¶æ®µ)**åä»ä¸èƒ½è·å¾—é”ï¼Œåˆ™é€šè¿‡ä¿¡å·é‡æ’é˜Ÿç­‰å¾…ï¼Œæ‰€æœ‰ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆå…¥å…ˆå‡º(FIFO)çš„é¡ºåºæ’é˜Ÿã€‚ ä½†æ˜¯å½“é”è¢«é‡Šæ”¾ï¼Œç¬¬ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå¹¶ä¸ä¼šç›´æ¥æ‹¥æœ‰é”ï¼Œè€Œæ˜¯éœ€è¦å’Œåæ¥è€…ç«äº‰ï¼Œä¹Ÿå°±æ˜¯é‚£äº›å¤„äºè‡ªæ—‹é˜¶æ®µï¼Œå°šæœªæ’é˜Ÿç­‰å¾…çš„goroutineï¼Œè¿™ç§æƒ…å†µä¸‹åæ¥è€…æ›´æœ‰ä¼˜åŠ¿ï¼šä¸€æ–¹é¢ï¼Œå®ƒä»¬æ­£åœ¨CPUè¿è¡Œï¼Œè‡ªç„¶æ¯”åˆšå”¤é†’çš„goroutineæ›´æœ‰ä¼˜åŠ¿ï¼Œå¦ä¸€æ–¹é¢å¤„äºè‡ªæ—‹çŠ¶æ€çš„goroutineå¯ä»¥æœ‰å¾ˆå¤šï¼Œè€Œè¢«å”¤é†’çš„goroutineæ¯æ¬¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„goroutineæœ‰å¾ˆå¤§æ¦‚ç‡æ‹¿ä¸åˆ°é”ã€‚ è¿™ç§æƒ…å†µä¸‹å®ƒä¼šè¢«é‡æ–°æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚è€Œå½“ä¸€ä¸ªgoroutineæœ¬æ¬¡åŠ é”ç­‰å¾…çš„æ—¶é—´è¶…è¿‡1msåï¼Œå®ƒä¼šæŠŠå½“å‰Mutexä»æ­£å¸¸æ¨¡å¼åˆ‡æ¢è‡³é¥¥é¥¿æ¨¡å¼ã€‚ **é¥¥é¥¿æ¨¡å¼ï¼š**åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼ŒMutexçš„æ‰€æœ‰æƒä»æ‰§è¡ŒUnlockçš„goroutineï¼Œç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨çš„goroutineã€‚åæ¥è€…ä¸ä¼šè‡ªæ—‹ï¼Œä¹Ÿä¸ä¼šå°è¯•è·å¾—é”ï¼Œå³ä½¿Mutexå¤„äºUnlockedçŠ¶æ€ã€‚å®ƒä»¬ä¼šç›´æ¥ä»é˜Ÿåˆ—çš„å°¾éƒ¨æ’é˜Ÿç­‰å¾…ã€‚ å½“ä¸€ä¸ªç­‰å¾…è€…è·å¾—é”åï¼Œå®ƒä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶å°†Mutexç”±é¥¥é¥¿æ¨¡å¼åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼ï¼š æ­¤è½®è·å¾—é”çš„ç­‰å¾…è€…çš„ç­‰å¾…æ—¶é—´å°äº1msï¼Œä¹Ÿå°±æ˜¯å®ƒåˆšæ¥ä¸ä¹…ï¼› å®ƒæ˜¯æœ€åä¸€ä¸ªç­‰å¾…è€…ï¼Œç­‰å¾…é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼Œåé¢è‡ªç„¶å°±æ²¡æœ‰é¥¥é¥¿çš„goroutineäº†ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼šåœ¨æ­£å¸¸æ¨¡å¼ä¸‹è‡ªæ—‹å’Œæ’é˜Ÿæ—¶åŒæ—¶å­˜åœ¨çš„ï¼Œæ‰§è¡ŒLockçš„goroutineä¼šå…ˆä¸€è¾¹è‡ªæ—‹ï¼Œå°è¯•è¿‡å‡ æ¬¡åå¦‚æœè¿˜æ²¡æ‹¿åˆ°é”ï¼Œå°±éœ€è¦å»æ’é˜Ÿç­‰å¾…äº†ã€‚è¿™ç§åœ¨æ’é˜Ÿä¹‹å‰å…ˆè®©å¤§å®¶æ¥æŠ¢çš„æ¨¡å¼ï¼Œèƒ½å¤Ÿæœ‰æ›´é«˜çš„ååé‡ï¼Œå› ä¸ºé¢‘ç¹çš„æŒ‚èµ·ã€å”¤é†’goroutineä¼šå¸¦æ¥è¾ƒå¤šçš„å¼€é”€ã€‚ä½†æ˜¯åˆä¸èƒ½æ— é™åˆ¶çš„è‡ªæ—‹ï¼Œè¦æŠŠè‡ªæ—‹çš„å¼€é”€æ§åˆ¶åœ¨è¾ƒå°çš„èŒƒå›´å†…ã€‚æ‰€ä»¥ï¼Œåœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼ŒMutexä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°é˜Ÿåˆ—å°¾ç«¯çš„goroutineè¿Ÿè¿ŸæŠ¢ä¸åˆ°é”çš„æƒ…å†µ(å°¾ç«¯å»¶è¿Ÿ)ã€‚ è€Œé¥¥é¥¿æ¨¡å¼ä¸‹ä¸å†å°è¯•è‡ªæ—‹ï¼Œæ‰€æœ‰goroutineéƒ½è¦æ’é˜Ÿï¼Œä¸¥æ ¼çš„å…ˆæ¥ååˆ°ï¼Œå¯¹äºé˜²æ­¢å‡ºç°å°¾ç«¯å»¶è¿Ÿéå¸¸é‡è¦ã€‚ 2.1.2.2 Lockå’ŒUnlock é¦–å…ˆçœ‹ä¸€ä¸‹å…³äºMutex.stateçš„å‡ ä¸ªå¸¸é‡å®šä¹‰ï¼šstateçš„ç±»å‹æ˜¯int32ã€‚ ç¬¬ä¸€ä½ç”¨ä½œé”çŠ¶æ€æ ‡è¯†ï¼Œç½®ä¸º1å°±è¡¨ç¤ºå·²åŠ é”ï¼Œå¯¹åº”æ©ç å¸¸é‡ä¸ºmutexLockedã€‚ ç¬¬äºŒä½ç”¨äºè®°å½•æ˜¯å¦å·²æœ‰goroutineè¢«å”¤é†’äº†ï¼Œç½®ä¸º1è¡¨ç¤ºå·²å”¤é†’ï¼Œå¯¹åº”æ©ç å¸¸é‡ä¸ºmutexWokenã€‚ ç¬¬ä¸‰ä½æ ‡è¯†Mutexçš„å·¥ä½œæ¨¡å¼ï¼Œ0ä»£è¡¨æ­£å¸¸æ¨¡å¼ï¼Œ1ä»£è¡¨é¥¥é¥¿æ¨¡å¼ï¼Œå¯¹åº”æ©ç å¸¸é‡ä¸ºmutexStarvingã€‚ è€Œå¸¸é‡mutexWaiterShiftç­‰äº3ï¼Œè¡¨ç¤ºé™¤äº†æœ€ä½3ä½ä»¥å¤–ï¼Œstateçš„å…¶ä»–ä½ç”¨æ¥è®°å½•æœ‰å¤šå°‘ä¸ªç­‰å¾…è€…åœ¨æ’é˜Ÿã€‚ æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Lockå’ŒUnlockçš„ä»£ç ï¼Œç²¾ç®€æ‰æ³¨é‡Šå’Œéƒ¨åˆ†raceæ£€æµ‹ç›¸å…³çš„ä»£ç ã€‚ ä¸¤ä¸ªæ–¹æ³•ä¸­ä¸»è¦é€šè¿‡atomicå‡½æ•°å®ç°äº†Fast pathï¼Œç›¸åº”çš„Slow pathè¢«å•ç‹¬æ”¾åœ¨äº†lockSlowå’ŒunlockSlowæ–¹æ³•ä¸­ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¾¿äºç¼–è¯‘å™¨å¯¹Fast pathè¿›è¡Œå†…è”ä¼˜åŒ–ã€‚ Lockæ–¹æ³•ä¸­çš„Fast pathæœŸæœ›Mutexå¤„äºUnlockedçŠ¶æ€ï¼Œæ²¡æœ‰goroutineåœ¨æ’é˜Ÿï¼Œæ›´ä¸ä¼šé¥¥é¥¿ã€‚ç†æƒ³çŠ¶å†µä¸‹ï¼Œä¸€ä¸ªCASæ“ä½œå°±å¯ä»¥è·å¾—é”ã€‚ä½†æ˜¯å¦‚æœCASæ“ä½œæ²¡èƒ½è·å¾—é”ï¼Œå°±éœ€è¦è¿›å…¥Slow pathï¼Œä¹Ÿå°±æ˜¯lockSlowæ–¹æ³•ã€‚ Unlockæ–¹æ³•åŒç†ï¼Œé¦–å…ˆé€šè¿‡åŸå­æ“ä½œä»stateä¸­å‡å»mutexLockedï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾é”ã€‚ç„¶åæ ¹æ®stateçš„æ–°å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒSlow pathã€‚å¦‚æœæ–°å€¼ä¸º0ï¼Œä¹Ÿå°±æ„å‘³ç€æ²¡æœ‰å…¶ä»–goroutineåœ¨æ’é˜Ÿï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰§è¡Œé¢å¤–æ“ä½œï¼›å¦‚æœæ–°å€¼ä¸ä¸º0ï¼Œé‚£å°±éœ€è¦è¿›å…¥Slow pathï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯éœ€è¦å”¤é†’æŸä¸ªgoroutineã€‚ 2.1.2.3 Slow path **é—®é¢˜ï¼š**å½“ä¸€ä¸ªgoroutineå°è¯•ç»™mutexåŠ é”æ—¶ï¼Œå¦‚æœå…¶ä»–goroutineå·²ç»åŠ äº†é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œè€Œä¸”å½“å‰mutexå·¥ä½œåœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ˜¯ä¸æ˜¯å°±è¦å¼€å§‹è‡ªæ—‹äº†å‘¢ï¼Ÿ ç­”ï¼šä¸ä¸€å®šã€‚å› ä¸ºå¦‚æœå½“å‰æ˜¯å•æ ¸åœºæ™¯ï¼Œæˆ–è€… GOMAXPROCS=1ï¼Œæˆ–è€…å½“å‰æ²¡æœ‰å…¶ä»–Pæ­£åœ¨è¿è¡Œã€‚è¿™äº›æƒ…å†µä¸‹è‡ªæ—‹æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼š è‡ªæ—‹çš„goroutineåœ¨ç­‰å¾…æŒæœ‰é”çš„goroutineé‡Šæ”¾é”ï¼Œè€ŒæŒæœ‰é”çš„goroutineåœ¨ç­‰å¾…è‡ªæ—‹çš„goroutineè®©å‡ºCPUã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœå½“å‰Pçš„æœ¬åœ°runqä¸ä¸ºç©ºï¼Œç›¸è¾ƒäºè‡ªæ—‹æ¥è¯´ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°goroutineæ›´æœ‰æ•ˆç‡ï¼Œæ‰€ä»¥ä¸ºä¿éšœååé‡ä¹Ÿä¸ä¼šè‡ªæ—‹ã€‚ é—®ï¼šGoroutine è‡ªæ—‹çš„æ¡ä»¶ï¼Ÿ æœ€ç»ˆï¼Œ==åªæœ‰åœ¨å¤šæ ¸åœºæ™¯ä¸‹ï¼Œä¸”GOMAXPROCS \u003e 1ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªå…¶ä»–çš„Pæ­£åœ¨runningï¼Œä¸”å½“å‰Pçš„æœ¬åœ°runqä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥è‡ªæ—‹ã€‚== è¿›å…¥è‡ªæ—‹çš„goroutineä¼šå…ˆå»äº‰æŠ¢mutexçš„å”¤é†’æ ‡è¯†ä½ï¼Œè®¾ç½®mutexWokenæ ‡è¯†ä½çš„ç›®çš„æ˜¯åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå‘ŠçŸ¥æŒæœ‰é”çš„goroutineåœ¨Unlockçš„æ—¶å€™ä¸ç”¨å†å”¤é†’å…¶ä»–goroutineäº†ï¼Œå·²ç»æœ‰goroutineåœ¨è¿™é‡Œç­‰å¾…ï¼Œä»¥å…å”¤é†’å¤ªå¤šçš„ç­‰å¾…goroutineã€‚ Mutexä¸­çš„è‡ªæ—‹ï¼Œåº•å±‚æ˜¯é€šè¿‡procyieldå¾ªç¯æ‰§è¡Œ30æ¬¡PAUSEï¼Œè‡ªæ—‹æ¬¡æ•°ä¸Šé™ä¸º4ï¼Œè€Œä¸”æ¯è‡ªæ—‹ä¸€æ¬¡éƒ½è¦é‡æ–°åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»§ç»­è‡ªæ—‹ã€‚å¦‚æœé”è¢«é‡Šæ”¾äº†ï¼Œæˆ–è€…é”è¿›å…¥äº†é¥¥é¥¿æ¨¡å¼ï¼Œäº¦æˆ–è€…å·²ç»è‡ªæ—‹äº†4æ¬¡ï¼Œéƒ½ä¼šç»“æŸè‡ªæ—‹ã€‚ ç»“æŸè‡ªæ—‹æˆ–è€…æ ¹æœ¬ä¸ç”¨è‡ªæ—‹çš„goroutineå°±è¯¥å°è¯•åŸå­æ“ä½œä¿®æ”¹mutexçš„çŠ¶æ€äº†ã€‚æŠŠæ­¤æ—¶mutex.stateä¿å­˜åˆ°oldä¸­ï¼ŒæŠŠè¦ä¿®æ”¹ä¸ºçš„æ–°stateè®°ä¸ºnewï¼š å¦‚æœoldå¤„äºé¥¥é¥¿æ¨¡å¼æˆ–åŠ é”çŠ¶æ€ï¼Œgoroutineå°±å¾—å»æ’é˜Ÿï¼Œæ‰€ä»¥è¿™äº›æƒ…å†µä¸‹æ’é˜Ÿè§„æ¨¡è¦åŠ 1ã€‚ å¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼ï¼Œå°±è¦å°è¯•è®¾ç½®lockä½ï¼Œæ‰€ä»¥newä¸­è¿™ä¸€ä½è¦ç½®ä¸º1ï¼› å¦‚æœå½“å‰goroutineç­‰å¾…çš„æ—¶é—´å·²ç»è¶…è¿‡1msï¼Œè€Œä¸”é”è¿˜æ²¡è¢«é‡Šæ”¾ï¼Œå°±è¦å°†mutexçš„çŠ¶æ€åˆ‡æ¢ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ æŠŠæ’é˜Ÿè§„æ¨¡å’Œå‡ ä¸ªæ ‡è¯†ä½éƒ½è®¾ç½®å¥½åï¼Œåœ¨æ‰§è¡ŒåŸå­æ“ä½œä¿®æ”¹stateå‰ï¼Œè‹¥æ˜¯å½“å‰goroutineæŒæœ‰å”¤é†’æ ‡è¯†çš„è¯ï¼Œè¿˜éœ€è¦å°†å”¤é†’æ ‡è¯†ä½é‡ç½®ï¼Œå› ä¸ºï¼Œæ¥ä¸‹æ¥æ— è®ºæ˜¯å»æŠ¢é”è¿˜æ˜¯å•çº¯å»æ’é˜Ÿï¼š å¦‚æœåŸå­æ“ä½œæˆåŠŸäº†ï¼Œè¦ä¹ˆæˆåŠŸæŠ¢åˆ°äº†é”ï¼Œè¦ä¹ˆæ˜¯æˆåŠŸè¿›åˆ°äº†ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“å‰goroutineéƒ½ä¸å†æ˜¯è¢«å”¤é†’çš„goroutineäº†ï¼Œæ‰€ä»¥è¦é‡Šæ”¾å”¤é†’æ ‡è¯†ã€‚ è€Œå¦‚æœåŸå­æ“ä½œå¤±è´¥ï¼Œä¹Ÿå°±æ„å‘³ç€å…¶ä»–goroutineåœ¨æˆ‘ä»¬ä¿å­˜mutex.stateåˆ°oldååˆä¿®æ”¹äº†stateçš„å€¼ï¼Œå½“å‰goroutineå°±è¦å›è¿‡å¤´å»ç»§ç»­ä»è‡ªæ—‹æ£€æŸ¥è¿™é‡Œå¼€å§‹å†æ¬¡å°è¯•ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦é‡Šæ”¾è‡ªå·±ä¹‹å‰æŠ¢åˆ°çš„å”¤é†’æ ‡è¯†ä½ï¼Œä»å¤´å†æ¥ã€‚ Lockæ“ä½œçš„Slow path ç»§ç»­å±•å¼€åŸå­æ“ä½œæˆåŠŸçš„åˆ†æ”¯ï¼š å¦‚æœæ˜¯æŠ¢é”æ“ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆåŠ é”çš„Slow pathå°±å¯ä»¥å®£å‘Šç»“æŸäº†ï¼› å¦‚æœæ˜¯æ’é˜Ÿè§„æ¨¡è®¾ç½®æˆåŠŸäº†ï¼Œè¿˜è¦å†³å®šæ˜¯æ’åœ¨ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨è¿˜æ˜¯å°¾éƒ¨ã€‚å¦‚æœå½“å‰goroutineå·²ç»æ’è¿‡é˜Ÿäº†ï¼Œæ˜¯åœ¨Unlockæ—¶ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å”¤é†’çš„ï¼Œé‚£å°±è¦æ’åˆ°ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨ï¼›å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ’é˜Ÿï¼Œå°±å¾—æ’åˆ°ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶ä¸”ä»ç¬¬ä¸€æ¬¡æ’é˜Ÿå¼€å§‹è®°å½•å½“å‰goroutineçš„ç­‰å¾…æ—¶é—´ã€‚æ¥ä¸‹æ¥å°±ä¼šè®©å‡ºï¼Œè¿›åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œé˜Ÿåˆ—é‡Œçš„goroutineè¢«å”¤é†’æ—¶ï¼Œè¦ä»ä¸Šæ¬¡è®©å‡ºçš„åœ°æ–¹å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚æ¥ä¸‹æ¥ä¼šåˆ¤æ–­ï¼Œå¦‚æœmutexå¤„åœ¨æ­£å¸¸æ¨¡å¼ï¼Œé‚£å°±æ¥ç€ä»è‡ªæ—‹å¼€å§‹æŠ¢é”ï¼Œå¦‚æœå”¤é†’åmutexå¤„åœ¨é¥¥é¥¿æ¨¡å¼ï¼Œé‚£å°±æ²¡æœ‰å…¶ä»–goroutineä¼šå’Œè‡ªå·±æŠ¢äº†ï¼Œé”å·²ç»è½®åˆ°è‡ªå·±è¿™é‡Œï¼Œåªéœ€è¦æŠŠmutex.stateä¸­lockæ ‡è¯†ä½è®¾ç½®ä¸ºåŠ é”ï¼ŒæŠŠç­‰å¾…é˜Ÿåˆ—è§„æ¨¡å‡å»1ï¼Œå†çœ‹çœ‹æ˜¯ä¸æ˜¯è¦åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±çš„ç­‰å¾…æ—¶é—´æ˜¯ä¸æ˜¯å°äº1msï¼Œæˆ–è€…ç­‰å¾…é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼Œæœ€åè®¾ç½®å¥½mutex.stateå°±ä¸€åˆ‡okäº†ã€‚ Unlockæ“ä½œçš„Slow path è¿›åˆ°Unlockçš„Slow pathè¯´æ˜é™¤å»lockæ ‡è¯†ä½ä»¥å¤–ï¼Œå‰©ä¸‹çš„ä½ä¸å…¨ä¸º0ã€‚ å¦‚æœå¤„åœ¨æ­£å¸¸æ¨¡å¼ï¼Œè‹¥ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…å·²ç»æœ‰goroutineè¢«å”¤é†’æˆ–è·å¾—äº†é”ï¼Œæˆ–è€…é”è¿›å…¥äº†é¥¥é¥¿æ¨¡å¼ï¼Œé‚£å°±ä¸éœ€è¦å”¤é†’æŸä¸ªgoroutineï¼Œç›´æ¥è¿”å›å³å¯ã€‚å¦åˆ™å°±è¦å°è¯•æŠ¢å mutexWokenæ ‡è¯†ä½ï¼Œè·å–å”¤é†’ä¸€ä¸ªgoroutineçš„æƒåˆ©ã€‚æŠ¢å æˆåŠŸåï¼Œå°±ä¼šé€šè¿‡runtime_Semreleaseå‡½æ•°å”¤é†’ä¸€ä¸ªgoroutineï¼›å¦‚æœæŠ¢å ä¸æˆåŠŸå°±è¿›è¡Œå¾ªç¯å°è¯•ï¼Œç›´åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…å·²ç»æœ‰ä¸€ä¸ªgoroutineè¢«å”¤é†’æˆ–è·å¾—äº†é”ï¼Œæˆ–è€…é”è¿›å…¥äº†é¥¥é¥¿æ¨¡å¼ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚ è€Œåœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œåæ¥çš„goroutineä¸ä¼šäº‰æŠ¢é”ï¼Œè€Œæ˜¯ç›´æ¥æ’é˜Ÿï¼Œé”çš„æ‰€æœ‰æƒæ˜¯ç›´æ¥ä»æ‰§è¡ŒUnlockçš„goroutineä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—ä¸­é¦–ä¸ªç­‰å¾…è€…çš„ï¼Œæ‰€ä»¥ä¸ç”¨æŠ¢å mutexWokenæ ‡è¯†ä½ã€‚ç¬¬ä¸€ä¸ªç­‰å¾…è€…å”¤é†’åï¼Œä¼šç»§æ‰¿å½“å‰goroutineçš„æ—¶é—´ç‰‡ç«‹åˆ»å¼€å§‹è¿è¡Œï¼Œä¹Ÿå°±æ˜¯ç»§ç»­lockSlowè¿™é‡Œgoroutineè¢«å”¤é†’ä»¥åçš„é€»è¾‘ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:2","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.3 ä¿¡å·é‡ ä¸ŠèŠ‚ä¸»è¦è®²è§£ sync.Mutex çš„ç¬¬ä¸€ä¸ªå­—æ®µ stateï¼Œæœ¬èŠ‚ä¸»è¦è®²è§£ sync.Mutex çš„ç¬¬äºŒä¸ªå­—æ®µ semaã€‚ **é—®é¢˜ï¼š**åç¨‹ç­‰å¾…ä¸€ä¸ªé”æ—¶ï¼Œè¦å¦‚ä½•ä¼‘çœ ã€ç­‰å¾…å’Œå”¤é†’å‘¢ï¼Ÿ **ç­”ï¼š**è¿™è¦é runtime.semaphoreæ¥å®ç°ï¼Œè¿™æ˜¯å¯ä¾›åç¨‹ä½¿ç”¨çš„ä¿¡å·é‡ã€‚runtimeå†…éƒ¨ä¼šé€šè¿‡ä¸€ä¸ªå¤§å°ä¸º251çš„sematableæ¥ç®¡ç†æ‰€æœ‰semaphoreï¼Œæ€ä¹ˆé€šè¿‡è¿™ä¸ªå¤§å°å›ºå®šçš„tableæ¥ç®¡ç†æ‰§è¡Œé˜¶æ®µæ•°é‡ä¸å®šçš„semaphoreå‘¢ï¼Ÿå¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š è¿™ä¸ªsematableå­˜å‚¨çš„æ˜¯251è¯¾å¹³è¡¡æ ‘çš„æ ¹ï¼Œå¹³è¡¡æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªsudogç±»å‹çš„å¯¹è±¡ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªä¿¡å·é‡æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªè®°å½•ä¿¡å·é‡æ•°å€¼çš„å˜é‡ï¼Œæ ¹æ®å®ƒçš„åœ°å€è¿›è¡Œè®¡ç®—ï¼Œæ˜ å°„åˆ°sematableä¸­çš„ä¸€é¢—å¹³è¡¡æ ‘ä¸Šï¼Œæ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹å°±æ‰¾åˆ°äº†è¯¥ä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„sync.Mutexä¸­ï¼Œæœ‰ä¸€ä¸ªsemaå­—æ®µï¼Œç”¨äºè®°å½•ä¿¡å·é‡çš„æ•°å€¼ï¼Œå¦‚æœæœ‰åç¨‹æƒ³è¦ç­‰å¾…è¿™ä¸ªMutexï¼Œå°±ä¼šæ ¹æ®semaå­—æ®µçš„åœ°å€è®¡ç®—æ˜ å°„åˆ°sematableä¸­çš„æŸæ£µå¹³è¡¡æ ‘ä¸Šï¼Œæ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ‰¾åˆ°äº†è¿™ä¸ªMutexçš„ç­‰å¾…é˜Ÿåˆ—äº†ã€‚æ‰€ä»¥ï¼Œsyne.Mutexæ˜¯é€šè¿‡ä¿¡å·é‡æ¥å®ç°æ’é˜Ÿçš„ã€‚ è€Œchanneléœ€è¦æœ‰è¯»(å‘é€)ç­‰å¾…é˜Ÿåˆ—ä»¥åŠå†™(æ¥æ”¶)ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿˜è¦æ”¯æŒç¼“å†²åŒºåŠŸèƒ½ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°æ’é˜Ÿï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€å¥—æ’é˜Ÿé€»è¾‘ã€‚ ä¸è¿‡ï¼Œæ— è®ºæ˜¯ä¿¡å·é‡è¿˜æ˜¯channelï¼Œåº•å±‚å®ç°éƒ½ç¦»ä¸å¼€runtime.mutexï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦ä¿éšœåœ¨é¢ä¸´å¤šçº¿ç¨‹å¹¶å‘æ—¶ï¼Œä¸ä¼šå‡ºç°åŒæ­¥é—®é¢˜ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:3","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.4 æŠ¢å å¼è°ƒåº¦ 2.1.4.1 Go 1.13 Go 1.13 çš„æŠ¢å æ–¹å¼æ˜¯ä¾èµ–äºæ ˆå¢é•¿æ£€æµ‹ä»£ç çš„ï¼Œå¹¶ä¸ç®—ä¸¥æ ¼æ„ä¹‰ä¸Šçš„æŠ¢å å¼è°ƒåº¦ã€‚ é¦–å…ˆçœ‹ä¸€æ®µä»£ç ï¼š æŒ‰ç†æ¥è¯´ï¼Œè¿™æ®µä»£ç è¿è¡Œååº”è¯¥ä¼šä¸æ–­è¾“å‡ºé€’å¢çš„æ•°å­—ï¼Œä½†æ˜¯åœ¨ Go 1.14 ä¹‹å‰ï¼Œè¿è¡Œè¿™æ®µä»£ç ä¼šå‘ç”Ÿé˜»å¡ã€‚ è¿è¡Œç¯å¢ƒæ˜¯åŒæ ¸CPUï¼Œæ’æŸ¥ä¹‹åå‘ç°æ˜¯åœ¨æ‰§è¡ŒSTWæ—¶å‘ç”Ÿçš„é˜»å¡ã€‚ GC å¼€å§‹å‰éœ€è¦STWæ¥è¿›è¡Œå¼€å¯å†™å±éšœç­‰å‡†å¤‡å·¥ä½œï¼Œæ‰€ä»¥STWå°±æ˜¯è¦æŠ¢å æ‰€æœ‰çš„Pï¼Œè®©GCå¾—ä»¥æ­£å¸¸å·¥ä½œã€‚è€Œç¤ºä¾‹ç¨‹åºä¸­çš„main goroutineæ²¡èƒ½è¢«æŠ¢å ï¼Œå®ƒä¸€ç›´åœ¨æ‰§è¡Œï¼Œè€ŒSTWä¸€ç›´åœ¨ç­‰å¾…å®ƒè®©å‡ºï¼Œè¿™æ ·å°±é™·å…¥äº†åƒµå±€ã€‚ **é—®é¢˜ï¼š**ä¸ºä»€ä¹ˆä¼šé™·å…¥è¿™æ ·çš„å±€é¢ï¼Ÿ ç­”ï¼šé¦–å…ˆï¼Œæ¢³ç†ä¸‹STWçš„ä¸»è¦é€»è¾‘ã€‚GCéœ€è¦æŠ¢å æ‰€æœ‰çš„Pï¼Œä½†è¿™ä¸æ˜¯è¯´æŠ¢å å°±okçš„ï¼Œæ‰€ä»¥å®ƒä¼šè®°å½•ä¸‹è‡ªå·±è¦ç­‰å¾…å¤šå°‘ä¸ªPè®©å‡ºï¼Œå½“è¿™ä¸ªå€¼å‡ä¸º0ï¼Œç›®çš„å°±è¾¾åˆ°äº†ã€‚å¯¹äºå½“å‰Pã€ä»¥åŠé™·å…¥ç³»ç»Ÿè°ƒç”¨çš„P(_Psyscall)ã€è¿˜æœ‰ç©ºé—²çŠ¶æ€çš„Pï¼Œç›´æ¥å°†å…¶è®¾ç½®ä¸º_Pgcstopå³å¯ã€‚å¯¹äºè¿˜æœ‰Gåœ¨è¿è¡Œçš„Pï¼Œåˆ™ä¼šå°†å¯¹åº”çš„g.stackguard0è®¾ç½®ä¸ºä¸€ä¸ªç‰¹æ®Šæ ‡è¯†(runtime.stackPreempt)ï¼Œå‘Šè¯‰å®ƒGCæ­£åœ¨ç­‰å¾…å®ƒè®©å‡ºã€‚æ­¤å¤–ï¼Œè¿˜ä¼šè®¾ç½®ä¸€ä¸ªgcwaitingæ ‡è¯†(sched.gcwaiting=1)ï¼Œæ¥ä¸‹æ¥å°±é€šè¿‡è¿™ä¸¤ä¸ªæ ‡è¯†ç¬¦çš„é…åˆï¼Œæ¥å®ç°è¿è¡Œä¸­çš„Pçš„æŠ¢å ã€‚ è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ goroutineåˆ›å»ºä¹‹åˆï¼Œæ ˆçš„å¤§å°æ—¶å›ºå®šçš„ï¼Œä¸ºäº†é˜²æ­¢å‡ºç°æ ˆæº¢å‡ºçš„æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šåœ¨æœ‰æ˜æ˜¾æ ˆæ¶ˆè€—çš„å‡½æ•°å¤´éƒ¨æ’å…¥ä¸€äº›æ£€æµ‹ä»£ç ã€‚é€šè¿‡g.stackguard0æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ ˆå¢é•¿ï¼Œä½†å¦‚æœg.stackguard0è¢«è®¾ç½®ä¸ºç‰¹æ®Šæ ‡è¯†runtime.stackPreemptï¼Œä¾¿ä¸ä¼šæ‰§è¡Œæ ˆå¢é•¿ï¼Œè€Œæ˜¯å»æ‰§è¡Œä¸€æ¬¡è°ƒåº¦(schedule())ï¼Œåœ¨schedule()è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œä¼šæ£€æµ‹gcwaitingæ ‡è¯†ï¼Œè‹¥å‘ç°GCåœ¨ç­‰å¾…æ‰§è¡Œï¼Œä¾¿ä¼šè®©å‡ºå½“å‰Pï¼Œå°†å…¶ç½®ä¸º_PgcstopçŠ¶æ€ã€‚ è¿™æ ·çœ‹æ¥ï¼Œç¤ºä¾‹main goroutineä¹‹æ‰€ä»¥æ²¡èƒ½è®©å‡ºï¼Œæ˜¯å› ä¸ºç©ºçš„forå¾ªç¯å¹¶æ²¡æœ‰è°ƒç”¨å‡½æ•°ï¼Œä¹Ÿå°±æ²¡æœ‰æœºä¼šæ‰§è¡Œæ ˆå¢é•¿æ£€æµ‹ä»£ç ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸çŸ¥é“GCåœ¨ç­‰å¾…å®ƒè®©å‡ºã€‚ 2.1.4.2 Go 1.14 ä¹‹å ä¾èµ–æ ˆå¢é•¿æ£€æµ‹ä»£ç çš„æŠ¢å æ–¹å¼ï¼Œé‡åˆ°æ²¡æœ‰å‡½æ•°è°ƒç”¨çš„æƒ…å†µå°±ä¼šå‡ºç°é—®é¢˜ã€‚ åœ¨ Go 1.14 åŠä¹‹åï¼Œè¿™ä¸€é—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚åœ¨Linuxç³»ç»Ÿä¸Šï¼Œè¿™ç§çœŸæ­£çš„æŠ¢å å¼è°ƒåº¦æ˜¯åŸºäºä¿¡å·æ¥å®ç°çš„ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºå¼‚æ­¥æŠ¢å ã€‚ å‡½æ•°preemptoneç”¨æ¥æŠ¢å ä¸€ä¸ªPï¼Œå®šä½åˆ°è¯¥å‡½æ•°ï¼Œå¯¹æ¯” 1.13 å’Œ 1.14 çš„å®ç°æœ‰ä½•ä¸åŒã€‚ ä¿¡å·å‘é€ 1.13 ä¸­ï¼Œpreemptoneå‡½æ•°ä¸»è¦è´Ÿè´£è®¾ç½®g.preempt=trueï¼Œå¹¶å°†g.stackguard0è®¾ç½®ä¸ºç‰¹æ®Šæ ‡è¯†(stackPreempt)ã€‚ è€Œåœ¨ 1.14 ä¸­ï¼Œå¢åŠ äº†æœ€åè¿™ä¸ªifè¯­å¥å—ï¼š ç¬¬ä¸€ä¸ªåˆ¤æ–­ç”¨äºç¡®è®¤å½“å‰ç¡¬ä»¶ç¯å¢ƒæ˜¯å¦æ”¯æŒè¿™ç§å¼‚æ­¥æŠ¢å ï¼Œè¿™ä¸ªå¸¸é‡å€¼(preemptMSupported)æ˜¯åœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šçš„ï¼› ç¬¬äºŒä¸ªåˆ¤æ–­(debug.asyncpreemptoff)ç”¨äºæ£€æµ‹ç”¨æˆ·æ˜¯å¦å…è®¸å¼€å¯å¼‚æ­¥æŠ¢å ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å…è®¸çš„ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥é€šè¿‡GODEBUGç¯å¢ƒå˜é‡æ¥ç¦ç”¨å¼‚æ­¥æŠ¢å ã€‚ å¦‚æœè¿™ä¸¤æ¡éªŒè¯éƒ½é€šè¿‡äº†ï¼Œå°±å°†p.preemptå­—æ®µç½®ä¸ºtrueï¼Œå®é™…çš„æŠ¢å æ“ä½œä¼šäº¤ç”±preemptMå‡½æ•°æ¥å®Œæˆã€‚ å®šä½åˆ°preemptMå‡½æ•°ï¼Œå®ƒçš„ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡runtime.signalMå‡½æ•°ï¼Œå‘æŒ‡å®šMå‘é€sigPreemptä¿¡å·ï¼Œæ€ä¹ˆå‘é€çš„å‘¢ï¼Ÿ signalMå‡½æ•°ä¼šé€šè¿‡è°ƒç”¨æ“ä½œç³»ç»Ÿä¸­ä¿¡å·ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æŒ‡å®šä¿¡å·å‘é€ç»™ç›®æ ‡çº¿ç¨‹ã€‚ä¿¡å·å‘å‡ºå»äº†ï¼Œå¼‚æ­¥æŠ¢å çš„å‰ä¸€åŠå·¥ä½œå°±ç®—æ˜¯å®Œæˆäº†ã€‚ ä¿¡å·å¤„ç† åä¸€åŠå·¥ä½œå°±è¦ç”±æ¥æ”¶åˆ°ä¿¡å·çš„å·¥ä½œçº¿ç¨‹æ¥å®Œæˆäº†ã€‚ çº¿ç¨‹æ¥æ”¶åˆ°ä¿¡å·åï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ä¿¡å·handleræ¥å¤„ç†ï¼ŒGo è¯­è¨€ä¸­çš„ä¿¡å·äº¤ç”±runtime.sighandleræ¥å¤„ç†ï¼Œsighandleråœ¨ç¡®å®šä¿¡å·ä¸ºsigPreemptä»¥åï¼Œä¼šè°ƒç”¨doSigPreemptå‡½æ•°ã€‚å®ƒä¼šé¦–å…ˆåˆ¤æ–­runtimeæ˜¯å¦è¦å¯¹æŒ‡å®šçš„Gè¿›è¡Œå¼‚æ­¥æŠ¢å ï¼Œé€šè¿‡ä»€ä¹ˆæ¥åˆ¤æ–­å‘¢ï¼Ÿ é¦–å…ˆï¼ŒæŒ‡å®šçš„Gä¸å…¶å¯¹åº”Pçš„preemptå­—æ®µéƒ½è¦ä¸ºtrueï¼Œè€Œä¸”æŒ‡å®šçš„Gè¿˜è¦å¤„åœ¨_GrunningçŠ¶æ€ï¼Œè¿˜è¦ç¡®è®¤åœ¨å½“å‰ä½ç½®æ‰“æ–­Gå¹¶æ‰§è¡ŒæŠ¢å æ˜¯å®‰å…¨çš„ï¼Œé‚£ä¹ˆæ€ä¹ˆç¡®ä¿å®‰å…¨æ€§å‘¢ï¼Ÿ æŒ‡å®šçš„Gå¯ä»¥æŒ‚èµ·å¹¶å®‰å…¨çš„æ‰«æå®ƒçš„æ ˆå’Œå¯„å­˜å™¨ï¼Œå¹¶ä¸”å½“å‰è¢«æ‰“æ–­çš„ä½ç½®å¹¶æ²¡æœ‰æ‰“æ–­å†™å±éšœï¼› æŒ‡å®šçš„Gè¿˜æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ³¨å…¥ä¸€ä¸ªå¼‚æ­¥æŠ¢å å‡½æ•°è°ƒç”¨(asyncPreempt)ï¼› è¿™é‡Œå¯ä»¥å®‰å…¨çš„å’Œruntimeè¿›è¡Œäº¤äº’ï¼Œä¸»è¦å°±æ˜¯ç¡®å®šå½“å‰å¹¶æ²¡æœ‰æŒæœ‰runtimeç›¸å…³çš„é”ï¼Œç»§è€Œä¸ä¼šåœ¨åç»­å°è¯•è·å¾—é”æ—¶å‘ç”Ÿæ­»é”ã€‚ ç¡®è®¤äº†è¦æŠ¢å è¿™ä¸ªGï¼Œå¹¶ä¸”æ­¤æ—¶æŠ¢å æ˜¯å®‰å…¨çš„ä»¥åï¼Œå°±å¯ä»¥æ”¾å¿ƒçš„é€šè¿‡pushCallå‘Gçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ³¨å…¥å¼‚æ­¥æŠ¢å å‡½æ•°è°ƒç”¨äº†ï¼Œè¢«æ³¨å…¥çš„å¼‚æ­¥æŠ¢å å‡½æ•°(asyncPreempt)æ˜¯ä¸€ä¸ªæ±‡ç¼–å‡½æ•°ï¼Œå®ƒä¼šå…ˆæŠŠå„ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨æ ˆä¸Šï¼Œä¹Ÿå°±æ˜¯å…ˆä¿å­˜ç°åœºåˆ°æ ˆä¸Šï¼Œç„¶åè°ƒç”¨runtime.asyncPreempt2å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šå»æ‰§è¡Œschedule()ï¼Œåˆ°è¿™é‡Œï¼Œå¼‚æ­¥æŠ¢å å°±å®Œæˆäº†ã€‚ å†å»æ‰§è¡Œä¸Šè¾¹çš„ç¤ºä¾‹ç¨‹åºï¼Œå‘ç°å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ç©ºçš„forå¾ªç¯æ²¡æœ‰è¢«æ’å…¥æ ˆå¢é•¿æ£€æµ‹ä»£ç ï¼Œåœ¨ 1.14 ä¸­ï¼Œé€šè¿‡æ³¨å…¥å¼‚æ­¥å›è°ƒå‡½æ•°çš„æ–¹å¼ï¼ŒåŒæ ·èƒ½å®ç°æŠ¢å å¼è°ƒåº¦ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:4","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.5 Channel 2.1.5.1 æ•°æ®ç»“æ„ type hchan struct { qcount uint dataqsiz uint buf unsafe.Pointer elemsize uint16 closed uint32 elemtype *_type sendx uint recvx uint recvq waitq sendq waitq lock mutex } é—®ï¼šchannelåº•å±‚æ•°æ®ç»“æ„æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Ÿ é€šè¿‡makeåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå¤§å°ä¸º5ï¼Œå…ƒç´ ç±»å‹ä¸ºintçš„channelï¼Œchæ˜¯å­˜åœ¨äºå‡½æ•°æ ˆå¸§ä¸Šçš„ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å †ä¸Šçš„hchanæ•°æ®ç»“æ„ã€‚ å› ä¸ºchannelæ”¯æŒåç¨‹é—´å¹¶å‘è®¿é—®ï¼Œæ‰€ä»¥è¦æœ‰ä¸€æŠŠé”lockæ¥ä¿æŠ¤æ•´ä¸ªæ•°æ®ç»“æ„ã€‚ å¯¹äºæœ‰ç¼“å†²æ¥è®²ï¼Œéœ€è¦çŸ¥é“ç¼“å†²åŒºåœ¨å“ªï¼Œå·²ç»å­˜å‚¨äº†å¤šå°‘ä¸ªå…ƒç´ ï¼Œæœ€å¤šå­˜å‚¨å¤šå°‘ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ å å¤šå¤§ç©ºé—´ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œç¼“å†²åŒºå°±æ˜¯ä¸ªæ•°ç»„bufã€elemsizeã€‚ å› ä¸º Go è¿è¡Œä¸­ï¼Œå†…å­˜å¤åˆ¶ã€åƒåœ¾å›æ”¶ç­‰æœºåˆ¶ä¾èµ–æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥hchanè¿˜è¦æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…ƒç´ ç±»å‹çš„ç±»å‹å…ƒæ•°æ®elemtypeã€‚ æ­¤å¤–ï¼Œchannelæ”¯æŒäº¤æ›¿çš„è¯»(æ¥æ”¶)å†™(å‘é€)ï¼Œéœ€è¦åˆ†åˆ«è®°å½•è¯»ã€å†™ä¸‹æ ‡çš„ä½ç½®recvxã€sendxã€‚ å½“è¯»å’Œå†™ä¸èƒ½ç«‹å³å®Œæˆæ—¶ï¼Œéœ€è¦èƒ½å¤Ÿè®©å½“å‰åç¨‹åœ¨channelä¸Šç­‰å¾…ï¼Œå¾…åˆ°æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè¦èƒ½å¤Ÿç«‹å³å”¤é†’ç­‰å¾…çš„åç¨‹ï¼Œæ‰€ä»¥è¦æœ‰ä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ†åˆ«é’ˆå¯¹è¯»(æ¥æ”¶)å’Œå†™(å‘é€)recvqã€sendqã€‚ æ­¤å¤–ï¼Œchannelèƒ½å¤Ÿcloseï¼Œæ‰€ä»¥è¿˜è¦è®°å½•å®ƒçš„å…³é—­çŠ¶æ€closedã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œchannelåº•å±‚å°±é•¿è¿™ä¸ªæ ·å­ï¼š åˆå§‹çŠ¶æ€ä¸‹ï¼Œchçš„ç¼“å†²åŒºä¸ºç©ºï¼Œè¯»ã€å†™ä¸‹æ ‡éƒ½æŒ‡å‘ä¸‹æ ‡0çš„ä½ç½®ï¼Œç­‰å¾…é˜Ÿåˆ—ä¹Ÿéƒ½ä¸ºç©ºã€‚ç„¶åï¼Œä¸€ä¸ªåç¨‹g1å‘chå‘é€æ•°æ®[1,5]ï¼Œæ­¤æ—¶ç¼“å†²åŒºå·²æ»¡ï¼Œè‹¥è¿˜è¦ç»§ç»­å‘é€æ•°å­—6ï¼Œg1å°±ä¼šè¿›åˆ°chçš„å‘é€ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªsudogç±»å‹çš„é“¾è¡¨ï¼Œé‡Œé¢ä¼šè®°å½•å“ªä¸ªåç¨‹åœ¨ç­‰å¾…ï¼Œç­‰å¾…å“ªä¸ªchannelï¼Œç­‰å¾…å‘é€çš„æ•°æ®åœ¨å“ªå„¿ç­‰ä¿¡æ¯ã€‚ æ¥ä¸‹æ¥åç¨‹g2ä»chæ¥æ”¶ä¸€ä¸ªå…ƒç´ ï¼ŒrecvxæŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼Œç¬¬0ä¸ªä½ç½®å°±ç©ºå‡ºæ¥äº†ï¼Œæ‰€ä»¥ä¼šå”¤é†’sendqä¸­çš„g1ï¼Œå°†è¿™é‡Œçš„æ•°æ®å‘é€ç»™chï¼Œç„¶åç¼“å†²åŒºå†æ¬¡æ»¡äº†ï¼Œsendqé˜Ÿåˆ—ä¸ºç©ºã€‚ è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œsendxå’Œrecvxéƒ½ä¼šä»0åˆ°4å†åˆ°0ï¼Œå¾ªç¯ç§»åŠ¨ï¼Œæ‰€ä»¥channelçš„ç¼“å†²åŒºä¹Ÿè¢«ç§°ä¸ºç¯å½¢ç¼“å†²åŒºã€‚ 2.1.5.2 å‘é€æ•°æ® é˜»å¡å¼å‘é€ å¦‚æœä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç»™channelå‘é€æ•°æ®ï¼š ch \u003c- 10 ä¸é˜»å¡çš„æƒ…å†µï¼š ç¼“å†²åŒºè¿˜æœ‰ç©ºé—²ä½ç½®ï¼› æœ‰åç¨‹åœ¨ç­‰ç€æ¥æ”¶æ•°æ®ï¼› é˜»å¡çš„æƒ…å†µï¼š chä¸ºnilï¼› chæ²¡æœ‰ç¼“å†²åŒºï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰åç¨‹ç­‰ç€æ¥æ”¶æ•°æ®ï¼› chæœ‰ç¼“å†²åŒºï¼Œä½†ç¼“å†²åŒºå·²ç”¨å°½ã€‚ éé˜»å¡å¼å‘é€ select { case ch \u003c- 10: ... default: ... } è‹¥é‡‡ç”¨è¿™ç§å†™æ³•ï¼Œå¦‚æœæ£€æµ‹åˆ°chå¯ä»¥å‘é€æ•°æ®ï¼Œå°±ä¼šæ‰§è¡Œcaseåˆ†æ”¯ï¼›å¦‚æœä¼šå‘ç”Ÿé˜»å¡å°±æ‰§è¡Œdefaultåˆ†æ”¯ã€‚ 2.1.5.3 æ¥æ”¶æ•°æ® é˜»å¡å¼æ¥æ”¶ ä»¥ä¸‹æ˜¯æ¥æ”¶æ•°æ®çš„ä¸‰ç§å†™æ³•ï¼Œéƒ½å…è®¸å‘ç”Ÿé˜»å¡ï¼š \u003c-ch // 1. ä¸¢å¼ƒç»“æœ v := \u003c-ch // 2. å°†ç»“æœèµ‹å€¼ç»™v v, ok := \u003c-ch // 3. comma oké£æ ¼çš„å†™æ³•ï¼Œokä¸ºfalseè¡¨ç¤ºchå·²å…³é—­ï¼Œæ­¤æ—¶væ˜¯channelå…ƒç´ ç±»å‹çš„é›¶å€¼ ä¸é˜»å¡çš„æƒ…å†µï¼š åœ¨ç¼“å†²åŒºä¸­æœ‰æ•°æ®ï¼› æœ‰åç¨‹ç­‰ç€å‘é€æ•°æ®ï¼› é˜»å¡çš„æƒ…å†µï¼š chä¸ºnilï¼› chæ— ç¼“å†²è€Œä¸”æ²¡æœ‰åç¨‹ç­‰ç€å‘é€æ•°æ®ï¼› chæœ‰ç¼“å†²ä½†ç¼“å†²åŒºæ— æ•°æ®ï¼› éé˜»å¡å¼æ¥æ”¶ select { case \u003c-ch: ... default: ... } è‹¥é‡‡ç”¨éé˜»å¡å¼æ¥æ”¶æ–¹å¼ï¼Œå¦‚æœæ£€æµ‹åˆ°chçš„recvæ“ä½œä¸ä¼šé˜»å¡æ—¶ï¼Œå°±ä¼šæ‰§è¡Œcaseåˆ†æ”¯ï¼›å¦‚æœä¼šé˜»å¡å°±ä¼šæ‰§è¡Œdefaultåˆ†æ”¯ã€‚ 2.1.5.4 å¤šè·¯select ä¸Šé¢çš„selectåªæ˜¯é’ˆå¯¹å•ä¸ªchannelçš„æ“ä½œã€‚å¤šè·¯selectæ˜¯æŒ‡å­˜åœ¨ä¸¤ä¸ªæˆ–æ›´å¤šçš„caseåˆ†æ”¯ï¼Œæ¯ä¸ªåˆ†æ”¯å¯ä»¥æ˜¯ä¸€ä¸ªchannelçš„sendæˆ–recvæ“ä½œã€‚ ä¾‹å¦‚ä¸€ä¸ªåç¨‹é€šè¿‡å¤šè·¯selectç­‰å¾…ch1å’Œch2ï¼Œè¿™é‡Œdefaultåˆ†æ”¯æ˜¯å¯é€‰çš„ï¼Œæš‚ä¸”æŠŠè¿™ä¸ªåç¨‹è®°ä¸ºg1ã€‚ å¤šè·¯selectä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.selectgoå‡½æ•°è°ƒç”¨ï¼Œé¦–å…ˆçœ‹å‚æ•°ï¼š ç¬¬ä¸€ä¸ªå‚æ•°cas0æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œè£…çš„æ˜¯selectä¸­æ‰€æœ‰çš„caseåˆ†æ”¯ï¼Œé¡ºåºæ˜¯sendåœ¨å‰recvåœ¨åï¼› ç¬¬äºŒä¸ªå‚æ•°order0æŒ‡å‘ä¸€ä¸ªuint16ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„å¤§å°ç­‰äºcaseåˆ†æ”¯çš„2å€ï¼Œå®é™…ä¸Šè¢«ç”¨ä½œä¸¤ä¸ªæ•°ç»„ï¼šç¬¬ä¸€ä¸ªæ•°ç»„ç”¨æ¥å¯¹æ‰€æœ‰channelçš„è½®è¯¢è¿›è¡Œä¹±åºï¼Œç¬¬äºŒä¸ªæ•°ç»„ç”¨æ¥å¯¹æ‰€æœ‰çš„channelçš„åŠ é”æ“ä½œè¿›è¡Œæ’åºã€‚è½®è¯¢éœ€è¦ä¹±åºæ‰èƒ½ä¿éšœå…¬å¹³æ€§ï¼Œè€ŒæŒ‰ç…§å›ºå®šç®—æ³•ç¡®å®šåŠ é”é¡ºåºæ‰èƒ½é¿å…æ­»é”ï¼› ç¬¬ä¸‰ä¸ªå‚æ•°pc0å’Œraceæ£€æµ‹ç›¸å…³ï¼› nsendså’Œnrecvsåˆ†åˆ«è¡¨ç¤ºæ‰€æœ‰caseä¸­ï¼Œæ‰§è¡Œsendå’Œrecvæ“ä½œçš„åˆ†æ”¯åˆ†åˆ«æœ‰å¤šå°‘ä¸ªã€‚ blockè¡¨ç¤ºå¤šè·¯selectæ˜¯å¦è¦é˜»å¡ç­‰å¾…ã€‚å¯¹åº”åˆ°ä»£ç ä¸­ï¼Œå°±æ˜¯æœ‰defaultåˆ†æ”¯çš„ä¸ä¼šè¢«é˜»å¡ï¼Œæ²¡æœ‰çš„ä¼šé˜»å¡ã€‚ å†çœ‹è¿”å›å€¼ï¼š ç¬¬ä¸€ä¸ªè¿”å›å€¼intç±»å‹ï¼Œä»£è¡¨æœ€ç»ˆå“ªä¸ªcaseåˆ†æ”¯è¢«æ‰§è¡Œäº†ï¼Œå¯¹åº”åˆ°cas0æŒ‡å‘çš„æ•°ç»„ä¸‹æ ‡ã€‚ä½†æ˜¯å¦‚æœè¿›å…¥åˆ°defaultåˆ†æ”¯ï¼Œå°±ä¼šå¯¹åº”-1ã€‚ ç¬¬äºŒä¸ªè¿”å›å€¼boolç±»å‹ï¼Œç”¨äºåœ¨æ‰§è¡Œrecvæ“ä½œçš„caseåˆ†æ”¯æ—¶ï¼Œè¡¨æ˜æ˜¯å®é™…æ¥æ”¶åˆ°äº†ä¸€ä¸ªå€¼ï¼Œè¿˜æ˜¯å› channelå…³é—­è€Œå¾—åˆ°äº†é›¶å€¼ã€‚ å¤šè·¯selectéœ€è¦è¿›è¡Œè½®è¯¢æ¥ç¡®å®šå“ªä¸ªcaseåˆ†æ”¯å¯æ“ä½œäº†ï¼Œä½†æ˜¯è½®è¯¢å‰éœ€è¦å…ˆåŠ é”ï¼Œæ‰€ä»¥selectgoå‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆæŒ‰ç…§æœ‰åºçš„åŠ é”é¡ºåºï¼Œå¯¹æ‰€æœ‰çš„channelåŠ é”ï¼› ç„¶åæŒ‰ç…§ä¹±åºçš„è½®è¯¢é¡ºåºæ£€æŸ¥æ‰€æœ‰channelçš„ç­‰å¾…é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼› å‡å¦‚æ£€æŸ¥åˆ°ch1æ—¶ï¼Œå‘ç°æœ‰æ•°æ®å¯è¯»ï¼Œé‚£å°±ç›´æ¥æ‹·è´æ•°æ®ï¼Œè¿›å…¥å¯¹åº”åˆ†æ”¯ï¼› å‡å¦‚æ‰€æœ‰çš„channeléƒ½ä¸å¯æ“ä½œï¼Œå°±æŠŠå½“å‰åç¨‹æ·»åŠ åˆ°æ‰€æœ‰channelçš„sendqæˆ–recvqä¸­ï¼Œå¯¹åº”è¿™ä¸ªä¾‹å­ï¼Œg1ä¼šè¢«æ·»åŠ åˆ°ch1çš„recvqåŠch2çš„sendqä¸­ï¼Œä¹‹åg1ä¼šè¢«æŒ‚èµ·ï¼Œå¹¶è§£é”æ‰€æœ‰çš„channelï¼› å‡å¦‚æ¥ä¸‹æ¥ch1æœ‰æ•°æ®å¯è¯»äº†ï¼Œg1å°±ä¼šè¢«å”¤é†’ï¼Œå®Œæˆå¯¹åº”çš„åˆ†æ”¯æ“ä½œåï¼Œä¼šå†æ¬¡æŒ‰ç…§åŠ é”é¡ºåºå¯¹æ‰€æœ‰channelåŠ é”ï¼Œç„¶åä»æ‰€æœ‰çš„sendqæˆ–recvqä¸­å°†è‡ªå·±ç§»é™¤ï¼› æœ€åå…¨éƒ¨è§£é”åè¿”å›ã€‚ è™½ç„¶ï¼Œchannelçš„è¯»å†™æ“ä½œå†™æ³•ä¼—å¤šï¼Œä½†äº‹å®ä¸Šï¼Œchannelé˜»å¡å¼çš„sendæ“ä½œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.chansend1()çš„è°ƒç”¨ï¼Œè€Œå®ƒå†…éƒ¨åªæ˜¯è°ƒç”¨äº†runtime.chansend()ï¼›éé˜»å¡å¼çš„sendæ“ä½œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.selectnbsend()çš„è°ƒç”¨ï¼Œå®ƒä¹Ÿä»…ä»…æ˜¯è°ƒç”¨äº†runtime.chansend()ã€‚æ‰€ä»¥ï¼Œsendæ“ä½œä¸»è¦æ˜¯é€šè¿‡runtime.chansend()å‡½æ•°å®ç°çš„ã€‚ åŒæ ·çš„ï¼Œchannelé˜»å¡å¼çš„recvæ“ä½œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.chanrecv1()çš„è°ƒç”¨ï¼Œè€Œå®ƒå†…éƒ¨åªæ˜¯è°ƒç”¨äº†runtime.chanrecv()ï¼›comma oké£æ ¼çš„å†™æ³•ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.chanrecv2()çš„è°ƒç”¨ï¼Œå®ƒçš„å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨runtime.chanrecv()ï¼Œåªä¸è¿‡æ¯”chanrecv1()å¤šäº†ä¸€ä¸ªè¿”å›å€¼ï¼›éé˜»å¡å¼çš„recvæ“ä½œä¼šæ ¹æ®æ˜¯å¦ä¸ºcomma oké£æ ¼ï¼Œè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹runtime.selectnbrecv()æˆ–selectnbrecv2()çš„è°ƒç”¨ï¼Œè€Œå®ƒä»¬ä¸¤ä¸ªä¹Ÿä»…ä»…æ˜¯è°ƒç”¨äº†runtime.chanrecv()ï¼Œæ‰€ä»¥ï¼Œrecvæ“ä½œä¸»è¦æ˜¯é€šè¿‡runtime.chanrecv()å‡½æ•°å®ç°çš„ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:5","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.1.6 åç¨‹ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:4:6","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.2 å†…å­˜ç®¡ç† ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:5:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.2.1 å†…å­˜åˆ†é…å™¨ ç¨‹åºä¸­çš„æ•°æ®å’Œå˜é‡éƒ½ä¼šè¢«åˆ†é…åˆ°ç¨‹åºæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå†…å­˜ç©ºé—´åŒ…å«ä¸¤ä¸ªé‡è¦åŒºåŸŸï¼šæ ˆåŒºï¼ˆStackï¼‰å’Œå †åŒºï¼ˆHeapï¼‰ã€‚å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€è¿”å›å€¼ä»¥åŠå±€éƒ¨å˜é‡å¤§éƒ½ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç”±ç¼–è¯‘å™¨è¿›è¡Œç®¡ç†ï¼›ä¸åŒç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ç®¡ç†å †åŒºçš„å†…å­˜ï¼ŒC++ ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆä¸»åŠ¨ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼ŒGo ä»¥åŠ Java ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆå’Œç¼–è¯‘å™¨å…±åŒç®¡ç†ï¼Œå †ä¸­çš„å¯¹è±¡ç”±å†…å­˜åˆ†é…å™¨åˆ†é…å¹¶ç”±åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚ ä»è¿›ç¨‹è™šæ‹Ÿç©ºé—´åœ°å€æ¥çœ‹ï¼š ç¨‹åºè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ¨ä»£ç æ®µï¼› å…¨å±€å˜é‡ã€é™æ€æ•°æ®ç­‰éƒ½ä¼šåˆ†é…åœ¨æ•°æ®æ®µï¼› å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°å’Œè¿”å›å€¼éƒ½ä¼šåˆ†é…åœ¨å‡½æ•°æ ˆå¸§ï¼› 2.2.1.1 è®¾è®¡åŸç† å†…å­˜ç®¡ç†ä¸€èˆ¬åŒ…å«ä¸‰ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰ã€åˆ†é…å™¨ï¼ˆAllocatorï¼‰å’Œæ”¶é›†å™¨ï¼ˆCollectorï¼‰ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:5:1","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.2.2 GC ä»è¿›ç¨‹è™šæ‹Ÿç©ºé—´åœ°å€æ¥çœ‹ï¼š ç¨‹åºè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ¨ä»£ç æ®µï¼› å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å¸¸é‡ç­‰éƒ½ä¼šåˆ†é…åœ¨**==æ•°æ®æ®µ==**ï¼› æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å¸¸é‡ç­‰éƒ½ä¼šåˆ†é…åœ¨**==BSSæ®µ==**ï¼› å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°å’Œè¿”å›å€¼éƒ½ä¼šåˆ†é…åœ¨**==å‡½æ•°æ ˆå¸§==**ï¼› ==Pointï¼š== ç”±äºå‡½æ•°è°ƒç”¨æ ˆä¼šåœ¨å‡½æ•°è¿”å›åé”€æ¯ï¼Œå› æ­¤ï¼Œå¦‚æœä¸èƒ½åœ¨ç¼–è¯‘é˜¶æ®µç¡®å®šæ•°æ®å¯¹è±¡çš„å¤§å°ï¼Œæˆ–è€…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¼šè¶…è¿‡å½“å‰æ‰€åœ¨å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¸é€‚åˆåˆ†é…åœ¨æ ˆä¸Šï¼Œè€Œåº”è¯¥åˆ†é…åˆ°å †ä¸Šã€‚ é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶ï¼Ÿ ä¸»è¦æ˜¯ä¸ºäº†é‡Šæ”¾==å †å†…å­˜==ã€‚éšç€ç¨‹åºè¿è¡Œï¼Œæœ‰äº›æ•°æ®ä¸ä¼šå†è¢«ç”¨åˆ°äº†ï¼Œç›´æ¥åˆ†é…åœ¨æ ˆä¸Šçš„æ•°æ®ï¼Œä¼šéšç€å‡½æ•°è°ƒç”¨æ ˆçš„é”€æ¯é‡Šæ”¾è‡ªèº«å ç”¨çš„å†…å­˜ï¼›ä½†æ˜¯åˆ†é…åœ¨å †ä¸Šçš„æ•°æ®ï¼Œå®ƒä»¬å ç”¨çš„å†…å­˜éœ€è¦ç¨‹åºä¸»åŠ¨é‡Šæ”¾æ‰å¯ä»¥é‡æ–°ä½¿ç”¨ï¼Œå¦åˆ™å°±ä¼šæˆä¸ºåƒåœ¾ï¼Œè€Œè¶Šç§¯è¶Šå¤šçš„åƒåœ¾ä¼šä¸æ–­çš„æ¶ˆè€—ç³»ç»Ÿå†…å­˜ã€‚ åƒåœ¾å›æ”¶æœ‰å‡ ç§å¸¸è§æ–¹å¼ï¼š æ‰‹åŠ¨åƒåœ¾å›æ”¶ï¼šCã€C++ã€Rustã€‚ä¸€æ—¦é‡Šæ”¾æ—©äº†ï¼Œåç»­å¯¹è¯¥æ•°æ®çš„è®¿é—®ä¾¿ä¼šå‡ºé”™ï¼Œè¿™å°±æ˜¯æ‰€è°“â€œæ‚¬æŒ‚æŒ‡é’ˆâ€é—®é¢˜ï¼›è€Œå¦‚æœå¿˜äº†é‡Šæ”¾ï¼Œå®ƒåˆä¼šä¸€ç›´å ç”¨å†…å­˜ï¼Œå‡ºç°â€œå†…å­˜æ³„éœ²â€ï¼› è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼šPythonã€Rubyã€Javaã€Goã€‚ç”±è¿è¡Œæ—¶è¯†åˆ«ä¸å†æœ‰ç”¨çš„æ•°æ®å¹¶é‡Šæ”¾ä»–ä»¬æ‰€å çš„å†…å­˜ï¼Œå†…å­˜ä½•æ—¶è¢«é‡Šæ”¾ï¼Œè¢«é‡Šæ”¾çš„å†…å­˜å¦‚ä½•å¤„ç†ï¼Œéƒ½ä¸éœ€è¦æˆ‘ä»¬å…³å¿ƒã€‚ è·Ÿè¸ªå¼åƒåœ¾å›æ”¶ å¼•ç”¨è®¡æ•°å¼åƒåœ¾å›æ”¶ 2.2.2.1 è®¾è®¡åŸç† é—®é¢˜ï¼šè‡ªåŠ¨åƒåœ¾å›æ”¶æ€ä¹ˆåŒºåˆ†å“ªäº›æ•°æ®æ˜¯åƒåœ¾å‘¢ï¼Ÿ å¯ä»¥ç¡®å®šï¼Œç¨‹åºä¸­ç”¨å¾—åˆ°çš„æ•°æ®ï¼Œä¸€å®šæ˜¯ä»==æ ˆã€æ•°æ®æ®µ==è¿™äº›æ ¹èŠ‚ç‚¹è¿½è¸ªå¾—åˆ°çš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»è¿™äº›æ ¹èŠ‚ç‚¹è¿½è¸ªä¸åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æ²¡ç”¨çš„æ•°æ®ï¼Œä¸€å®šæ˜¯åƒåœ¾ã€‚å› æ­¤ï¼Œç›®å‰ä¸»æµçš„è‡ªåŠ¨åƒåœ¾å›æ”¶ç®—æ³•éƒ½æ˜¯ä½¿ç”¨**â€œå¯è¾¾æ€§â€è¿‘ä¼¼ç­‰ä»·â€œå­˜æ´»æ€§â€**çš„ã€‚ æ ‡è®°-æ¸…æ‰«ç®—æ³• æ ‡è®°æ¸…é™¤ï¼ˆMark-Sweepï¼‰ç®—æ³•æ˜¯æœ€å¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ ‡è®°æ¸…é™¤æ”¶é›†å™¨æ˜¯è·Ÿè¸ªå¼åƒåœ¾æ”¶é›†å™¨ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†æˆ**æ ‡è®°ï¼ˆMarkï¼‰å’Œæ¸…é™¤ï¼ˆSweepï¼‰**ä¸¤ä¸ªé˜¶æ®µï¼š æ ‡è®°é˜¶æ®µ â€” ä»æ ¹å¯¹è±¡å‡ºå‘æŸ¥æ‰¾å¹¶æ ‡è®°å †ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼› æ¸…é™¤é˜¶æ®µ â€” éå†å †ä¸­çš„å…¨éƒ¨å¯¹è±¡ï¼Œå›æ”¶æœªè¢«æ ‡è®°çš„åƒåœ¾å¯¹è±¡å¹¶å°†å›æ”¶çš„å†…å­˜åŠ å…¥ç©ºé—²é“¾è¡¨ã€‚ ä¸‰è‰²æŠ½è±¡ ä¸‰è‰²æŠ½è±¡å¯ä»¥æ¸…æ™°çš„å±•ç°è¿½è¸ªå¼å›æ”¶ä¸­å¯¹è±¡çŠ¶æ€çš„å˜åŒ–è¿‡ç¨‹ã€‚ åƒåœ¾å›æ”¶å¼€å§‹æ—¶ï¼Œæ‰€æœ‰æ•°æ®å‡ä¸ºç™½è‰²ï¼› ç„¶åæŠŠç›´æ¥è¿½è¸ªåˆ°çš„rootèŠ‚ç‚¹éƒ½æ ‡è®°ä¸ºç°è‰²ï¼šç°è‰²ä»£è¡¨åŸºäºå½“å‰èŠ‚ç‚¹å±•å¼€çš„è¿½è¸ªè¿˜æœªå®Œæˆï¼› å½“åŸºäºæŸä¸ªèŠ‚ç‚¹çš„è¿½è¸ªä»»åŠ¡å®Œæˆåï¼Œä¾¿ä¼šæŠŠè¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºé»‘è‰²ï¼šè¡¨ç¤ºå®ƒæ˜¯å­˜æ´»æ•°æ®ï¼Œè€Œä¸”æ— éœ€åŸºäºå®ƒå†æ¬¡è¿›è¡Œè¿½è¸ªäº†ã€‚ åŸºäºé»‘è‰²èŠ‚ç‚¹æ‰¾åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«æ ‡è®°ä¸ºç°è‰²ï¼Œè¡¨ç¤ºè¿˜è¦åŸºäºå®ƒä»¬è¿›ä¸€æ­¥å¼€å§‹è¿½è¸ªã€‚ å½“æ²¡æœ‰ç°è‰²èŠ‚ç‚¹æ—¶ï¼Œå°±æ„å‘³ç€æ ‡è®°å·¥ä½œå¯ä»¥ç»“æŸäº†ã€‚æ­¤æ—¶ï¼Œæœ‰ç”¨æ•°æ®éƒ½ä¸ºé»‘è‰²ï¼Œåƒåœ¾éƒ½ä¸ºç™½è‰²ã€‚æ¥ä¸‹æ¥å›æ”¶è¿™äº›ç™½è‰²æ•°æ®å³å¯ã€‚ æ ‡è®°-æ¸…æ‰«ç®—æ³•çš„ç¼ºç‚¹ï¼š æ ‡è®°-æ¸…æ‰«ç®—æ³•å®¹æ˜“é€ æˆå¾ˆå¤šå°å†…å­˜ï¼Œè¿™ä¸€é—®é¢˜å¯ä»¥ï¼š åŸºäº**BiBOP(Big Bag of Pages)**çš„æ€æƒ³ï¼ŒæŠŠå†…å­˜å—åˆ’åˆ†ä¸ºå¤šç§å¤§å°è§„æ ¼ï¼Œå¯¹ç›¸åŒè§„æ ¼çš„å†…å­˜å—è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚ è¿˜å¯ä»¥é€šè¿‡ç´§å‡‘çš„æ–¹æ³•å‡å°‘ç¢ç‰‡åŒ–å†…å­˜ï¼Œä½†æ˜¯ä¼šå¸¦æ¥å¤šæ¬¡ç§»åŠ¨çš„å¼€é”€ã€‚ å¤åˆ¶å›æ”¶ç®—æ³• è¿˜æœ‰ä¸€ç§å¤åˆ¶å¼å›æ”¶ç®—æ³•ï¼Œä»–ä¼šæŠŠå †åˆ’åˆ†ä¸ºä¸¤ä¸ªç›¸ç­‰çš„ç©ºé—´Fromå’ŒToï¼Œç¨‹åºæ‰§è¡Œæ—¶ä½¿ç”¨Fromç©ºé—´ï¼Œåƒåœ¾å›æ”¶æ—¶ä¼šæ‰«æFromç©ºé—´ï¼ŒæŠŠèƒ½è¿½è¸ªåˆ°çš„æ•°æ®å¤åˆ¶åˆ°Toç©ºé—´ï¼Œå½“æ‰€æœ‰èƒ½è¿½è¸ªåˆ°çš„æ•°æ®éƒ½å¤åˆ¶åˆ°Toç©ºé—´åï¼ŒæŠŠFromå’ŒToç©ºé—´è§’è‰²å¯¹æ¢ï¼ŒåŸæ¥çš„Toå˜ä¸ºFromï¼ŒåŸæ¥çš„Fromå¯ä»¥å…¨éƒ¨å›æ”¶ç”¨ä½œæ–°çš„Toã€‚è¿™ç§å¤åˆ¶å¼ä¸ä¼šäº§ç”Ÿç¢ç‰‡åŒ–é—®é¢˜ï¼Œä½†æ˜¯ä¼šæµªè´¹ä¸€åŠçš„å †å†…å­˜ã€‚ ä¸ºäº†æé«˜å †å†…å­˜åˆ©ç”¨ç‡ï¼Œé€šå¸¸ä¼šå’Œå…¶ä»–åƒåœ¾å›æ”¶ç®—æ³•æ­é…ä½¿ç”¨ï¼Œåªåœ¨ä¸€éƒ¨åˆ†å †å†…å­˜ä¸­ä½¿ç”¨å¤åˆ¶å¼å›æ”¶ã€‚æ¯”å¦‚åˆ†ä»£å›æ”¶ã€‚ åˆ†ä»£å›æ”¶ åˆ†ä»£å›æ”¶ä¸»è¦åŸºäºå¼±åˆ†ä»£å‡è¯´ï¼šå¤§éƒ¨åˆ†å¯¹è±¡éƒ½ä¼šåœ¨å¹´è½»æ—¶æ­»äº¡ã€‚ æ–°ç”Ÿä»£å¯¹è±¡ï¼šæ–°åˆ›å»ºçš„å¯¹è±¡ï¼› è€å¹´ä»£å¯¹è±¡ï¼šç»å—ä½ç‰¹å®šæ¬¡æ•°GCè€Œä¾ç„¶å­˜æ´»çš„å¯¹è±¡ï¼› åŸºäºå¼±åˆ†ä»£å‡è¯´ï¼Œå¤§éƒ¨åˆ†å¯¹è±¡ä¼šåœ¨æœ€åˆç»å†çš„GCä¸­æ­»äº¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ–°ç”Ÿä»£å¯¹è±¡æˆä¸ºåƒåœ¾çš„æ¦‚ç‡é«˜äºè€å¹´ä»£å¯¹è±¡ã€‚å› æ­¤ï¼Œå¯ä»¥å°†æ•°æ®åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œé™ä½è€å¹´ä»£æ‰§è¡Œåƒåœ¾å›æ”¶çš„é¢‘ç‡ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¤„ç†æ‰€æœ‰æ•°æ®ï¼Œå°†æ˜æ˜¾æé«˜åƒåœ¾å›æ”¶æ‰§è¡Œçš„æ•ˆç‡ã€‚è€Œä¸”ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£è¿˜å¯ä»¥åˆ†åˆ«é‡‡ç”¨ä¸åŒçš„å›æ”¶ç­–ç•¥ï¼Œè¿›ä¸€æ­¥æå‡å›æ”¶æ•ˆç›Šå¹¶å‡å°‘å¼€é”€ã€‚ ä»¥ä¸Šå‡ä¸ºè·Ÿè¸ªå¼åƒåœ¾å›æ”¶ï¼Œè€Œå¼•ç”¨è®¡æ•°å¼åƒåœ¾å›æ”¶æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ å¼•ç”¨è®¡æ•°å¼ **å¼•ç”¨è®¡æ•°æŒ‡çš„æ˜¯ä¸€ä¸ªæ•°æ®å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚**ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæ›´æ–°æ•°æ®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œå¯ä»¥å›æ”¶å®ƒæ‰€å ç”¨çš„å†…å­˜ã€‚å› æ­¤ï¼Œåœ¨å¼•ç”¨è®¡æ•°æ³•ä¸­åƒåœ¾è¯†åˆ«çš„ä»»åŠ¡å·²ç»è¢«åˆ†æ‘Šåˆ°æ¯æ¬¡å¯¹æ•°æ®å¯¹è±¡çš„æ“ä½œä¸­ã€‚è™½ç„¶å¼•ç”¨è®¡æ•°æ³•å¯ä»¥åŠæ—¶å›æ”¶æ— ç”¨å†…å­˜ï¼Œä½†æ˜¯é«˜é¢‘ç‡çš„æ›´æ–°å¼•ç”¨è®¡æ•°ä¹Ÿä¼šé€ æˆä¸å°çš„å¼€é”€ï¼Œè€Œä¸”å¦‚æœå‘ç”Ÿå¾ªç¯å¼•ç”¨æƒ…å†µï¼Œé‚£ä¹ˆå°†æ— æ³•å›æ”¶ã€‚ ä»¥ä¸Šè®¨è®ºå‡æ˜¯åœ¨æš‚åœç”¨æˆ·ç¨‹åºï¼Œåªä¸“æ³¨äºåƒåœ¾å›æ”¶çš„å‰æä¸‹è¿›è¡Œçš„ï¼Œä¹Ÿå³æ‰€è°“**==STW==(Stop The World)**ã€‚ä½†å®é™…ä¸Šç”¨æˆ·ç¨‹åºæ— æ³•æ¥å—é•¿æ—¶é—´çš„æš‚åœã€‚ å¢é‡å¼åƒåœ¾å›æ”¶ **å¢é‡å¼åƒåœ¾å›æ”¶ï¼š**å°†é•¿æ—¶é—´çš„åƒåœ¾å›æ”¶ï¼Œåˆ†æˆè‹¥å¹²å°æ®µï¼Œå’Œç”¨æˆ·ç¨‹åºäº¤æ›¿æ‰§è¡Œï¼Œå³ç¼©çŸ­æ¯æ¬¡æš‚åœçš„æ—¶é—´ï¼Œä½†å¢åŠ æš‚åœçš„æ¬¡æ•°ã€‚ **è¿™ä¼šå¸¦æ¥æ–°çš„é—®é¢˜ï¼š**ä¿ä¸é½åƒåœ¾å›æ”¶ç¨‹åºå‰è„šåˆšæ ‡è®°ä¸€ä¸ªé»‘è‰²å¯¹è±¡ï¼Œç”¨æˆ·ç¨‹åºåè„šå°±ä¿®æ”¹äº†å®ƒ(å°†å®ƒæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œæ­¤æ—¶åŸé»‘è‰²å¯¹è±¡åº”å˜ä¸ºç°è‰²ï¼Œä½†å¹¶æ²¡æœ‰)ï¼Œåƒåœ¾å›æ”¶ç¨‹åºæœ‰å¯èƒ½è¯¯åˆ¤å°†ç™½è‰²å¯¹è±¡(åº”ä¸ºç°è‰²å¯¹è±¡)å›æ”¶ã€‚åŸå› å¦‚ä¸‹ï¼š åœ¨ä¸‰è‰²æŠ½è±¡ä¸­ï¼Œé»‘è‰²å¯¹è±¡å¤„ç†å®Œæ¯•ï¼Œä¸ä¼šè¢«å†æ¬¡æ‰«æï¼Œè€Œç°è‰²å¯¹è±¡è¿˜ä¼šè¢«å›æ”¶å™¨ç»§ç»­å¤„ç†ï¼Œæ‰€ä»¥è‹¥å‡ºç°é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼ŒåŒæ—¶æ²¡æœ‰ä»»ä½•ç°è‰²å¯¹è±¡å¯ä»¥æŠµè¾¾è¿™ä¸ªç™½è‰²å¯¹è±¡ï¼Œå®ƒå°±ä¼šè¢«åˆ¤ä¸ºåƒåœ¾ï¼Œä½†å®é™…ä¸Šå®ƒä»æ˜¯å­˜æ´»æ•°æ®ã€‚ å¼ºä¸‰è‰²ä¸å˜å¼ä¸å¼±ä¸‰è‰²ä¸å˜å¼ å¦‚æœèƒ½å¤Ÿåšåˆ°ä¸å‡ºç°é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œå°±å¿…ç„¶ä¸ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯äº†ã€‚è¿™è¢«ç§°ä¸º**â€œå¼ºä¸‰è‰²ä¸å˜å¼â€**ã€‚ è‹¥æŠŠæ¡ä»¶æ”¾å®½ä¸€ç‚¹ï¼Œå…è®¸å‡ºç°é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯é€šè¿‡ç°è‰²å¯¹è±¡å¯ä»¥æŠµè¾¾è¯¥ç™½è‰²å¯¹è±¡ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é¿å…è¿™ä¸ªé”™è¯¯ï¼Œè¿™è¢«ç§°ä¸º**â€œå¼±ä¸‰è‰²ä¸å˜å¼â€**ã€‚ è¯»å†™å±éšœ å®ç°**â€œå¼º/å¼±ä¸‰è‰²ä¸å˜å¼â€é€šå¸¸çš„åšæ³•æ˜¯å»ºç«‹â€œè¯»/å†™å±éšœâ€**ã€‚ **å†™å±éšœï¼š**ä¼šåœ¨å†™æ“ä½œä¸­æ’å…¥æŒ‡ä»¤ï¼Œç›®çš„æ˜¯æŠŠæ•°æ®å¯¹è±¡çš„ä¿®æ”¹é€šçŸ¥åˆ°åƒåœ¾å›æ”¶å™¨ï¼Œæ‰€ä»¥å†™å±éšœé€šå¸¸è¦æœ‰ä¸€ä¸ªè®°å½•é›†ï¼Œè€Œè®°å½•é›†æ˜¯é‡‡ç”¨é¡ºåºå­˜å‚¨è¿˜æ˜¯å“ˆå¸Œè¡¨ã€è®°å½•ç²¾ç¡®åˆ°è¢«ä¿®æ”¹çš„å¯¹è±¡è¿˜æ˜¯åªè®°å½•å…¶æ‰€åœ¨é¡µç­‰é—®é¢˜ï¼Œå°±æ˜¯å†™å±éšœå…·ä½“å®ç°è¦è€ƒè™‘çš„äº†ã€‚ â€œå¼ºä¸‰è‰²ä¸å˜å¼â€æé†’æˆ‘ä»¬å…³æ³¨ç™½è‰²æŒ‡é’ˆæŒ‡å‘é»‘è‰²å¯¹è±¡çš„å†™å…¥æ“ä½œï¼Œæ— è®ºå¦‚ä½•éƒ½ä¸å…è®¸å‡ºç°é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ã€‚å¯ä»¥æŠŠç™½è‰²æŒ‡é’ˆå˜ä¸ºç°è‰²ï¼Œä¹Ÿå¯ä»¥æŠŠé»‘è‰²å¯¹è±¡å˜ä¸ºç°è‰²ã€‚è¿™äº›éƒ½å±äº**==â€œæ’å…¥\"å†™å±éšœ==**ã€‚ â€œå¼±ä¸‰è‰²ä¸å˜å¼â€åˆ™æé†’æˆ‘ä»¬å…³æ³¨å¯¹é‚£äº›åˆ°ç™½è‰²å¯¹è±¡è·¯å¾„çš„ç ´åè¡Œä¸ºã€‚ä¾‹å¦‚è¦åˆ é™¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå¯ä»¥æŠŠç™½è‰²å¯¹è±¡å˜ä¸ºç°è‰²ã€‚è¿™ç§å†™å±éšœå±äº**==â€œåˆ é™¤\"å†™å±éšœ==**ã€‚ **è¯»å±éšœï¼š**ç¡®ä¿ç”¨æˆ·ç¨‹åºä¸ä¼šè®¿é—®åˆ°å·²ç»å­˜åœ¨å‰¯æœ¬çš„é™ˆæ—§å¯¹è±¡ã€‚ï¼ˆä¸»è¦é’ˆå¯¹å¤åˆ¶å¼å›æ”¶ï¼‰ å¤šæ ¸ **å¹¶è¡Œåƒåœ¾å›æ”¶ï¼š**å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œåƒåœ¾å›æ”¶ç¨‹åºã€‚ å¹¶å‘åƒåœ¾å›æ”¶ï¼šç”¨æˆ·ç¨‹åºä¸åƒåœ¾å›æ”¶ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´é”™è¯¯(æœ‰äº›çº¿ç¨‹å¼€å¯äº†å†™å±éšœï¼Œæœ‰äº›è¿˜æ²¡å¼€å¯ï¼Œæ‰€ä»¥é€šå¸¸é‡‡ç”¨ä¸‹è¾¹é‚£ç§) ä¸»ä½“å¹¶å‘å¼åƒåœ¾å›æ”¶ï¼šåœ¨æŸäº›é˜¶æ®µé‡‡å–STW(ç¡®ä¿å¤§ä¼™å„¿éƒ½å¼€å¯äº†å†™å±éšœ)ï¼Œåœ¨å…¶ä»–é˜¶æ®µæ”¯æŒå¹¶å‘ã€‚ ä¸»ä½“å¹¶å‘å¢é‡å¼åƒåœ¾å›æ”¶ï¼šåœ¨\"ä¸»ä½“å¹¶å‘å¼åƒåœ¾å›æ”¶\"åŸºç¡€ä¸Šæ”¯æŒå¢é‡å¼å›æ”¶ï¼Œ 2.2.2.2 Go Goè¯­è¨€çš„åƒåœ¾å›æ”¶é‡‡ç”¨æ ‡è®°-æ¸…æ‰«ç®—æ³•ï¼Œæ”¯æŒ**==ä¸»ä½“å¹¶å‘å¢é‡å¼å›æ”¶==ï¼Œä½¿ç”¨æ’å…¥ä¸åˆ é™¤ä¸¤ç§å†™å±éšœç»“åˆçš„æ··åˆå†™å±éšœ**ã€‚ Goè¯­è¨€çš„GCåœ¨å‡†å¤‡é˜¶æ®µ(Mark Setup)ä¼šä¸ºæ¯ä¸ªpåˆ›å»ºä¸€ä¸ªmark workeråç¨‹ï¼ŒæŠŠå¯¹åº”çš„gæŒ‡é’ˆå­˜å‚¨åˆ°pä¸­ï¼Œè¿™äº›åå°mark workeråˆ›å»ºåå¾ˆå¿«è¿›å…¥ä¼‘çœ ï¼Œç­‰åˆ°æ ‡è®°é˜¶æ®µå¾—åˆ°è°ƒåº¦æ‰§è¡Œã€‚ æ¥ä¸‹æ¥ç¬¬ä¸€æ¬¡STWï¼ŒGCè¿›å…¥_GCMarké˜¶æ®µã€‚å…¨å±€å˜é‡gcphaseè®°å½•GCé˜¶æ®µæ ‡è¯†ï¼Œå…¨å±€å˜é‡writeBarrierè®°å½•æ˜¯å¦å¼€å¯å†™å±éšœï¼Œå…¨å±€å˜é‡gcBlackenEnabledç”¨äºæ ‡è¯†æ˜¯å¦å…è®¸è¿›è¡ŒGCæ ‡è®°å·¥ä½œ(æ­¤å¤„ç½®ä¸º1ï¼Œæ ‡è¯†å…è®¸)ã€‚ åœ¨STWçš„æƒ…å†µä¸‹å¼€å¯å†™å±éšœã€‚ç­‰æ‰€æœ‰å‡†å¤‡å·¥ä½œåšå¥½ä»¥åï¼Œstart the worldï¼Œæ‰€æœ‰péƒ½ä¼šçŸ¥é“å†™å±éšœå·²å¼€å¯ï¼Œç„¶åè¿™äº›åå°mark workerå¯ä»¥å¾—åˆ°è°ƒåº¦æ‰§è¡Œï¼Œå±•å¼€æ ‡è®°å·¥ä½œã€‚ å½“æ²¡æœ‰æ ‡è®°ä»»åŠ¡æ—¶ï¼Œç¬¬äºŒæ¬¡STWï¼ŒGCè¿›å…¥_GCMarkTerminationé˜¶æ®µï¼Œç¡®è®¤æ ‡è®°å·¥ä½œç¡®å®å·²ç»å®Œæˆï¼Œç„¶ååœæ­¢æ ‡è®°å·¥ä½œï¼Œå°†gcBlackenEnabledç½®ä¸º0ã€‚ æ¥ä¸‹æ¥ï¼Œè¿›å…¥_GCOffé˜¶æ®µï¼Œå…³é—­å†™å±éšœã€‚**start the worldï¼Œè¿›å…¥æ¸…æ‰«é˜¶æ®µã€‚**è¿›å…¥_GCOffé˜¶æ®µå‰ï¼Œæ–°åˆ†é…çš„å¯¹è±¡ä¼šç›´æ¥æ ‡è®°ä¸ºé»‘è‰²ï¼Œè¿›å…¥_GCOffé˜¶æ®µåï¼Œå†æ–°åˆ†é…çš„å¯¹è±¡å°±æ˜¯ç™½è‰²çš„äº†ã€‚ æ‰§è¡Œæ¸…æ‰«å·¥ä½œçš„åç¨‹ç”±runtime.mainåœ¨gcenableä¸­åˆ›å»ºï¼Œå¯¹åº”gæŒ‡é’ˆå­˜å‚¨åœ¨å…¨å±€å˜é‡sweepä¸­ï¼Œåˆ°æ¸…æ‰«é˜¶æ®µï¼Œè¿™ä¸ªåå°çš„**sweeperä¼šè¢«åŠ å…¥åˆ°runqä¸­ï¼Œå®ƒå¾—åˆ°è°ƒåº¦æ‰§è¡Œæ—¶ä¼šæ‰§è¡Œæ¸…æ‰«ä»»åŠ¡**ï¼Œå› ä¸ºæ¸…æ‰«å·¥ä½œä¹Ÿæ˜¯å¢é‡è¿›è¡Œçš„ï¼Œæ‰€ä»¥æ¯ä¸€è½®GCå¼€å§‹å‰ï¼Œè¿˜è¦å…ˆç¡®ä¿å®Œæˆä¸Šä¸€è½®GCæœªå®Œæˆçš„æ¸…æ‰«å·¥ä½œã€‚ è¿™æ ·çœ‹æ¥ä¼¼ä¹åªéœ€è¦ä¸¤è½®STWï¼Œæ ‡è®°ä¸æ¸…æ‰«å·¥ä½œå¹¶å‘å¢é‡æ‰§è¡Œçš„GCè€Œå·²ã€‚ é—®é¢˜ï¼š **å…³äºGCæ ‡è®°å·¥ä½œï¼š**ä¾ç…§æ ‡è®°-æ¸…æ‰«ç®—æ³•ï¼Œæ ‡è®°å·¥ä½œè¦ä»æ‰«æbssæ®µã€æ•°æ®æ®µã€ä»¥åŠåç¨‹æ ˆä¸Šçš„è¿™äº›rootç»“ç‚¹å¼€å§‹ï¼Œè¿½è¸ªåˆ°å †ä¸Šçš„èŠ‚ç‚¹ï¼Œé‚£æ€ä¹ˆç¡®å®šè¿™äº›æ•°æ®å¯¹è±¡æ˜¯å¦æ˜¯GCæ„Ÿå…´è¶£çš„æŒ‡é’ˆå‘¢ï¼Ÿ Goè¯­è¨€åœ¨ç¼–è¯‘é˜¶æ®µä¼šç”Ÿæˆbssæ®µã€æ•°æ®æ®µç­‰å¯¹åº”çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œé€šè¿‡å„æ¨¡å—å¯¹åº”çš„moduledataå¯ä»¥è·å¾—gcdatamaskã€gcbssmaskç­‰ä¿¡æ¯ï¼Œå®ƒä»¬ä¼šè¢«ç”¨äºåˆ¤æ–­ç‰¹å®šrootèŠ‚ç‚¹æ˜¯å¦ä¸ºæŒ‡é’ˆã€‚ åç¨‹æ ˆä¹Ÿæœ‰å¯¹åº”çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨åœ¨stackmapä¸­ï¼Œæ‰«æåç¨‹æ ˆæ—¶ï¼Œé€šè¿‡å¯¹åº”å…ƒæ•°æ®ï¼Œå¯ä»¥çŸ¥é“æ ˆä¸Šçš„å±€éƒ¨å˜é‡ã€å‚æ•°ã€è¿”å›å€¼ç­‰å¯¹è±¡ä¸­é‚£äº›","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:5:2","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.2.3 å †å†…å­˜åˆ†é… Goè¯­è¨€çš„runtimeå°†å †åœ°å€ç©ºé—´åˆ’åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„arenaï¼ŒarenaåŒºåŸŸçš„èµ·å§‹åœ°å€è¢«å®šä¹‰ä¸ºå¸¸é‡arenaBaseOffsetï¼Œåœ¨amd64æ¶æ„ä¸‹çš„Linuxç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªarenaçš„å¤§å°æ˜¯64MBï¼Œèµ·å§‹åœ°å€ä¹Ÿå¯¹é½åˆ°64MBã€‚æ¯ä¸ªarenaåŒ…å«8192ä¸ªpageï¼Œæ‰€ä»¥æ¯ä¸ªpageå¤§å°ä¸º8KBã€‚ **é—®é¢˜ï¼š**å› ä¸ºç¨‹åºè¿è¡Œèµ·æ¥æ‰€éœ€åˆ†é…çš„å†…å­˜å—æœ‰å¤§æœ‰å°ï¼Œè€Œåˆ†æ•£çš„ã€å¤§å°ä¸ä¸€çš„ç¢ç‰‡åŒ–å†…å­˜ä¸€æ–¹é¢å¯èƒ½é™ä½å†…å­˜åˆ©ç”¨ç‡ï¼Œå¦ä¸€æ–¹é¢å¯èƒ½ä¼šæé«˜è¦æ‰¾åˆ°å¤§å°åˆé€‚çš„å†…å­˜å—çš„ä»£ä»·ã€‚ è§£å†³ï¼šä¸ºé™ä½ç¢ç‰‡åŒ–å†…å­˜ç»™ç¨‹åºæ€§èƒ½é€ æˆçš„ä¸è‰¯å½±å“ï¼ŒGoè¯­è¨€çš„å †åˆ†é…é‡‡ç”¨äº†ä¸tcmallocå†…å­˜åˆ†é…å™¨ç±»ä¼¼çš„ç®—æ³•ã€‚**ç®€å•æ¥è®²å°±æ˜¯ï¼š**æŒ‰ç…§ä¸€ç»„é¢„ç½®çš„å¤§å°è§„æ ¼æŠŠå†…å­˜é¡µåˆ’åˆ†æˆå—ï¼Œç„¶åæŠŠä¸åŒè§„æ ¼çš„å†…å­˜å—æ”¾å…¥å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­ã€‚ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œåˆ†é…å™¨ä¼šå…ˆæ ¹æ®è¦ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„è§„æ ¼ï¼Œç„¶åä»å¯¹åº”ç©ºé—²é“¾è¡¨ä¸­åˆ†é…ä¸€ä¸ªå†…å­˜å—ã€‚ Go 1.16 runtimeåŒ…ç»™å‡ºäº†67ç§é¢„ç½®çš„å¤§å°è§„æ ¼ï¼Œæœ€å°8Bï¼Œæœ€å¤§32KBã€‚ æ‰€ä»¥ï¼Œåœ¨åˆ’åˆ†çš„æ•´æ•´é½é½çš„arenaé‡Œï¼Œåˆä¼šæŒ‰éœ€åˆ’åˆ†å‡ºä¸åŒçš„spanï¼Œæ¯ä¸ªspanåŒ…å«ä¸€ç»„è¿ç»­çš„pageï¼Œå¹¶ä¸”æŒ‰ç…§ç‰¹å®šè§„æ ¼åˆ’åˆ†æˆç­‰å¤§çš„å†…å­˜å—ã€‚å¤§å°å…³ç³»æ˜¯ï¼šarena -\u003e span -\u003e page -\u003e å†…å­˜å—ã€‚è¿™äº›å°±ç»„æˆäº†å †å†…å­˜ã€‚ 2.2.3.1 æ•°æ®ç»“æ„ åœ¨å †å†…å­˜ä¹‹å¤–ï¼Œæœ‰ä¸€å¤§ç¥¨ç”¨äºç®¡ç†å †å†…å­˜çš„æ•°æ®ç»“æ„ã€‚ mheapç”¨äºç®¡ç†æ•´ä¸ªå †å†…å­˜ï¼› ä¸€ä¸ªarenaå¯¹åº”ä¸€ä¸ªheapArenaç»“æ„ï¼› ä¸€ä¸ªspanå¯¹åº”ä¸€ä¸ªmspanç»“æ„ï¼› mheapä¸­ï¼Œæœ‰ä¸€ä¸ªå…¨å±€çš„mspanç®¡ç†ä¸­å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º136çš„æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ æ˜¯ä¸€ä¸ª**mcentralç»“æ„**+ä¸€ä¸ªpaddingã€‚ é—®é¢˜ï¼šmcentralæ€ä¹ˆç®¡ç†spanå‘¢ï¼Ÿ **è§£ç­”ï¼š**å®é™…ä¸Šï¼Œä¸€ä¸ªmcentralå¯¹åº”ä¸€ç§mspanè§„æ ¼ç±»å‹ï¼Œè®°å½•åœ¨spanclassä¸­ï¼Œspanclassé«˜ä¸ƒä½æ ‡è®°å†…å­˜å—å¤§å°è§„æ ¼ç¼–å·ï¼Œruntimeæä¾›çš„é¢„ç½®è§„æ ¼å¯¹åº”ç¼–å·1åˆ°67ï¼Œç¼–å·0ç•™å‡ºæ¥ç”¨ä½œæ ‡è®°å¤§äº32KBçš„å¤§å—å†…å­˜ï¼Œä¹Ÿå³ä¸€å…±68ç§ã€‚ç„¶åæ¯ç§è§„æ ¼ä¼šæŒ‰ç…§æ˜¯å¦ä¸éœ€è¦GCæ‰«æï¼Œè¿›ä¸€æ­¥åŒºåˆ†å¼€ï¼Œç”¨æœ€ä½ä½è¿›è¡Œæ ‡è¯†ã€‚åŒ…å«æŒ‡é’ˆçš„éœ€è¦GCæ‰«æï¼Œå½’ä¸ºscannableè¿™ä¸€ç±»ï¼Œä¸å«æŒ‡é’ˆçš„å½’ä¸ºnoscanè¿™ä¸€ç±»ã€‚æ‰€ä»¥å…±åˆ†ä¸º136ç§ã€‚ æ¯ç§spanclassçš„mcentralä¸­ï¼Œä¼šè¿›ä¸€æ­¥å°†å·²ç”¨å°½ä¸æœªç”¨å°½çš„mspanåˆ†åˆ«ç®¡ç†ï¼Œæ¯ä¸€ç§åˆä¼šæ”¾åˆ°ä¸¤ä¸ªå¹¶å‘å®‰å…¨çš„setä¸­ï¼šä¸€ä¸ªæ˜¯å·²æ¸…æ‰«çš„ï¼Œä¸€ä¸ªæ˜¯æœªæ¸…æ‰«çš„ã€‚ å…¨å±€mspanç®¡ç†ä¸­å¿ƒmcentralæ–¹ä¾¿å–ç”¨å„ç§ç±»å‹çš„mspanï¼Œä½†æ˜¯ä¸ºäº†ä¿éšœå¤šä¸ªpä¹‹é—´å¹¶å‘å®‰å…¨ï¼Œå…ä¸äº†é¢‘ç¹çš„åŠ é”ã€è§£é”ï¼Œä¸ºé™ä½å¤šä¸ªpä¹‹é—´çš„ç«äº‰æ€§ï¼ŒGoè¯­è¨€çš„æ¯ä¸ªpéƒ½æœ‰ä¸€ä¸ªæœ¬åœ°å°å¯¹è±¡ç¼“å­˜p.mcacheï¼Œä»è¿™é‡Œå–ç”¨å°±ä¸ç”¨å†åŠ é”äº†ã€‚mcacheæœ‰ä¸€ä¸ªé•¿åº¦ä¸º136çš„*mspanç±»å‹çš„æ•°ç»„ï¼Œè¿˜æœ‰ä¸“é—¨ç”¨äºåˆ†é…å°äº16å­—èŠ‚çš„noscanç±»å‹çš„tinyå†…å­˜ï¼Œå½“å‰péœ€è¦ç”¨åˆ°ç‰¹å®šè§„æ ¼ç±»å‹çš„mspanæ—¶ï¼Œå…ˆå»æœ¬åœ°ç¼“å­˜è¿™é‡Œæ‰¾å¯¹åº”çš„mspanï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…ç”¨å®Œäº†ï¼Œå°±å»mcentralè·å–ä¸€ä¸ªæ”¾åˆ°æœ¬åœ°ï¼ŒæŠŠå·²ç”¨å°½çš„å½’è¿˜åˆ°mcentralçš„full setä¸­ï¼Œ æ¥ä¸‹æ¥çœ‹heapArenaï¼Œè¿™é‡Œå­˜å‚¨ç€arenaçš„å…ƒæ•°æ®ï¼Œé‡Œé¢æœ‰ä¸€ç¾¤ä½å›¾æ ‡è®°ã€‚ å…¶ä¸­ï¼Œbitmapä½å›¾ï¼Œç”¨ä¸€ä½æ ‡è®°è¿™ä¸ªarenaä¸­ä¸€ä¸ªæŒ‡é’ˆå¤§å°çš„å†…å­˜å•å…ƒåˆ°åº•æ˜¯æŒ‡é’ˆè¿˜æ˜¯æ ‡é‡ï¼Œå†ç”¨ä¸€ä½æ¥æ ‡è®°è¿™å—å†…å­˜å•å…ƒçš„åç»­å•å…ƒæ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œè€Œä¸”ä¸ºäº†ä¾¿äºæ“ä½œï¼Œbitmapä¸­ç”¨ä¸€å­—èŠ‚æ ‡è®°arenaä¸­4ä¸ªæŒ‡é’ˆå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œä½4ä½ç”¨äºç”¨äºæ ‡è®°æŒ‡é’ˆ/æ ‡é‡ï¼Œé«˜4ä½ç”¨äºæ ‡è®°æ‰«æ/ç»ˆæ­¢ã€‚ä¾‹å¦‚æ­¤å¤„sliceï¼Œbitmapç¬¬ä¸€å­—èŠ‚çš„0-3ä½åˆ†åˆ«æ ‡è®°ä¸‰ä¸ªå¯¹åº”å­—æ®µæ˜¯æŒ‡é’ˆè¿˜æ˜¯æ ‡é‡ï¼Œç¬¬4-6ä½åˆ†åˆ«æ ‡è®°ä¸‰ä¸ªå¯¹åº”å­—æ®µæ˜¯å¦éœ€è¦ç»§ç»­æ‰«æã€‚ pageInUseæ˜¯ä¸ªuint8ç±»å‹çš„æ•°ç»„ï¼Œé•¿åº¦ä¸º1024ï¼Œæ‰€ä»¥ä¸€å…±8192ä½ã€‚è¿™ä¸ªä½å›¾åªæ ‡è®°**å¤„äºä½¿ç”¨çŠ¶æ€(mSpanInUse)**çš„spançš„ç¬¬ä¸€ä¸ªpageã€‚ä¾‹å¦‚ï¼Œarenaä¸­ç¬¬ä¸€ä¸ªä½¿ç”¨çŠ¶æ€çš„spanåŒ…æ‹¬ä¸¤ä¸ªpageï¼Œå¯¹åº”pageInUseä¸­ç¬¬0ä½æ ‡ä¸º1ï¼Œç¬¬äºŒä¸ªspanä¹Ÿåœ¨ä½¿ç”¨ä¸­ï¼Œå®ƒåŒ…æ‹¬ä¸‰ä¸ªpageï¼Œä½†åªæœ‰ç¬¬ä¸€ä¸ªpageå¯¹åº”çš„ç¬¬2ä½ä¼šè¢«æ ‡è®°ä¸º1ã€‚ pageMarksçš„ç”¨æ³•å’ŒpageInUseä¸€æ ·ï¼Œåªæ ‡è®°æ¯ä¸ªspançš„ç¬¬ä¸€ä¸ªpageï¼Œåœ¨GCæ ‡è®°é˜¶æ®µä¼šä¿®æ”¹è¿™ä¸ªä½å›¾ï¼Œæ ‡è®°å“ªäº›spanä¸­å­˜åœ¨è¢«æ ‡è®°çš„å¯¹è±¡ï¼Œåœ¨GCæ¸…æ‰«é˜¶æ®µä¼šæ ¹æ®è¿™ä¸ªä½å›¾ï¼Œæ¥é‡Šæ”¾ä¸å«æ ‡è®°å¯¹è±¡çš„spanï¼Œ spansæ˜¯ä¸ª*mspanç±»å‹çš„æ•°ç»„ï¼Œå¤§å°ä¸º8192ï¼Œæ­£å¥½å¯¹åº”arenaä¸­çš„8192ä¸ªpageï¼Œæ‰€ä»¥ç”¨äºå®šä½ä¸€ä¸ªpageå¯¹åº”çš„mspanåœ¨å“ªå„¿ã€‚mspanç®¡ç†ç€spanä¸­ä¸€ç»„è¿ç»­çš„pageï¼ŒåŒmcentralä¸€æ ·ï¼Œå°†åˆ’åˆ†çš„å†…å­˜å—è§„æ ¼ç±»å‹è®°å½•åœ¨spanclassä¸­ã€‚ nelemè®°å½•ç€å½“å‰spanå…±åˆ’åˆ†æˆå¤šå°‘ä¸ªå†…å­˜å—ï¼ŒfreeIndexè®°å½•ç€ä¸‹ä¸ªç©ºé—²å†…å­˜å—çš„ç´¢å¼•ã€‚ ä¸heapArenaä¸åŒï¼Œmspanè¿™é‡Œçš„ä½å›¾æ ‡è®°ï¼Œé¢å‘çš„æ˜¯åˆ’åˆ†å¥½çš„å†…å­˜å—å•å…ƒã€‚ allocBitsä½å›¾ç”¨æ¥æ ‡è®°å“ªäº›å†…å­˜å—å·²ç»è¢«åˆ†é…äº†ã€‚ gcmarkBitsæ˜¯å½“å‰spançš„æ ‡è®°ä½å›¾ï¼Œåœ¨GCæ ‡è®°é˜¶æ®µä¼šå¯¹è¿™ä¸ªä½å›¾è¿›è¡Œæ ‡è®°ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶ä½å¯¹åº”spanä¸­çš„ä¸€ä¸ªå†…å­˜å—ï¼Œåˆ°GCæ¸…æ‰«é˜¶æ®µä¼šé‡Šæ”¾æ‰æ—§çš„allocBitsï¼Œç„¶åæŠŠæ ‡è®°å¥½çš„gcmarkBitsç”¨ä½œæ–°çš„allocBitsï¼Œè¿™æ ·æœªè¢«GCæ ‡è®°çš„å†…å­˜å—å°±èƒ½å›æ”¶åˆ©ç”¨äº†ã€‚å½“ç„¶ï¼Œè¿˜ä¼šé‡æ–°åˆ†é…ä¸€æ®µæ¸…é›¶çš„å†…å­˜ç»™gcmarkBitsä½å›¾ã€‚ 2.2.3.2 åˆ†é…ç­–ç•¥ mallocgcæ˜¯è´Ÿè´£å †åˆ†é…çš„å…³é”®å‡½æ•°ï¼Œruntimeä¸­çš„newç³»åˆ—å’Œmakeç³»åˆ—å‡½æ•°éƒ½ä¾èµ–å®ƒã€‚ å®ƒçš„ä¸»è¦é€»è¾‘å¯ä»¥åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š ç¬¬ä¸€éƒ¨åˆ†ï¼šè¾…åŠ©GCã€‚å¦‚æœç¨‹åºç”³è¯·å †å†…å­˜æ—¶ï¼Œæ­£å¤„äºGCæ ‡è®°é˜¶æ®µï¼Œå½“ä¸‹å·²åˆ†é…çš„å †å†…å­˜è¿˜æ²¡æ ‡è®°å®Œï¼Œä½ è¿™è¾¹åˆè¦åˆ†é…æ–°çš„å†…å­˜ï¼Œä¸‡ä¸€å†…å­˜ç”³è¯·çš„é€Ÿåº¦è¶…è¿‡äº†GCæ ‡è®°çš„é€Ÿåº¦ï¼Œå°±å¯èƒ½ä¼šå‡ºç°å†…å­˜ä¸å¤Ÿçš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œç”³è¯·ä¸€å­—èŠ‚å†…å­˜éœ€è¦åšå¤šå°‘æ‰«æå·¥ä½œï¼Ÿæˆ–è€…è¯´ï¼Œå®Œæˆä¸€å­—èŠ‚æ‰«æå·¥ä½œåå¯ä»¥åˆ†é…å¤šå¤§çš„å†…å­˜ç©ºé—´ï¼Ÿè¿™éƒ½æ˜¯æ ¹æ®GCæ‰«æçš„è¿›åº¦æ›´æ–°è®¡ç®—çš„ã€‚ æ¯æ¬¡æ‰§è¡Œè¾…åŠ©GCï¼Œæœ€å°‘è¦æ‰«æ64KBã€‚è¿™æ˜¯å› ä¸ºåç¨‹æ¯æ¬¡æ‰§è¡Œè¾…åŠ©GCï¼Œå¤šå‡ºæ¥çš„éƒ¨åˆ†ä¼šä½œä¸ºä¿¡ç”¨å­˜å‚¨åˆ°å½“å‰gä¸­ï¼Œå°±åƒä¿¡ç”¨å¡çš„é¢åº¦ä¸€æ ·ï¼Œåç»­å†æ‰§è¡Œmallocgc()æ—¶ï¼Œåªè¦ä¿¡ç”¨é¢åº¦ç”¨ä¸å®Œï¼Œå°±ä¸ç”¨æ‰§è¡Œè¾…åŠ©GCäº†ã€‚ æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥é€ƒé¿è¾…åŠ©GCï¼šçªƒå–ä¿¡ç”¨ã€‚åå°çš„GC mark workeræ‰§è¡Œæ‰«æä»»åŠ¡æ—¶ï¼Œä¼šåœ¨å…¨å±€gcControllerè¿™é‡Œ(bgScanCredit)ç§¯ç´¯ä¿¡ç”¨ï¼Œå¦‚æœèƒ½å¤Ÿçªƒå–è¶³å¤Ÿå¤šçš„ä¿¡ç”¨å€¼æ¥æŠµæ¶ˆå½“å‰åç¨‹èƒŒè´Ÿçš„å€ºåŠ¡(è¯´æ˜æ­¤æ—¶ç©ºé—²å†…å­˜è¶³å¤Ÿå¤§)ï¼Œé‚£å°±ä¸ç”¨æ‰§è¡Œè¾…åŠ©GCäº†ã€‚ **ç¬¬äºŒéƒ¨åˆ†ï¼šç©ºé—´åˆ†é…ã€‚**è¿™é‡Œéœ€è¦æ ¹æ®è¦åˆ†é…çš„ç©ºé—´å¤§å°ï¼Œä»¥åŠæ˜¯å¦ä¸ºnoscanå‹ç©ºé—´æ¥é€‰æ‹©ä¸åŒçš„åˆ†é…ç­–ç•¥ã€‚ å¦‚æœæ˜¯noscanç±»å‹ä¸”å¤§å°\u003cmaxTinySizeï¼Œä¼šä½¿ç”¨tiny allocatorï¼› å¤§å°\u003emaxSmallSizeçš„å†…å­˜åˆ†é…ï¼ŒåŒ…æ‹¬noscanå’Œscanableç±»å‹ï¼Œéƒ½ä¼šé‡‡ç”¨å¤§å—å†…å­˜åˆ†é…å™¨ï¼› maxSmallSzie\u003e=å¤§å°\u003e=maxTinySizeçš„noscanç±»å‹ã€ä»¥åŠmaxSmallSize\u003e=å¤§å°çš„scanableç±»å‹ï¼Œä¼šä½¿ç”¨ç›´æ¥åŒ¹é…é¢„ç½®å¤§å°è§„æ ¼æ¥åˆ†é…ã€‚ å¤§å°\u003e32KBçš„å¤§å—å†…å­˜é¢å¤–å¤„ç†ï¼Œè¿™æ˜¯å› ä¸ºé¢„ç½®çš„å†…å­˜è§„æ ¼æœ€å¤§æ‰32KBï¼Œæ‰€ä»¥ä¼šç›´æ¥æ ¹æ®æ‰€éœ€é¡µé¢æ•°ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„spanã€‚ è€Œå¯¹äº\u003c16Bçš„å†…å­˜åˆ†é…ï¼Œä¹Ÿä¸ç›´æ¥åŒ¹é…é¢„ç½®å†…å­˜è§„æ ¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æµªè´¹ï¼šå¦‚æœéœ€è¦è¿ç»­åˆ†é…16æ¬¡1Bçš„å†…å­˜ï¼Œæ¯æ¬¡åˆ†é…æ—¶åŒ¹é…é¢„ç½®çš„å†…å­˜è§„æ ¼ä¸º8B(è¿™æ˜¯æœ€å°çš„äº†)ï¼Œé‚£ä¹ˆæ¯æ¬¡å°±ä¼šæµªè´¹7Bã€‚è€Œ**tiny allocatorèƒ½å¤Ÿå°†å‡ ä¸ªå°å—çš„å†…å­˜åˆ†é…è¯·æ±‚åˆå¹¶**ï¼Œæ‰€ä»¥ä¾‹å­ä¸­16æ¬¡1Bçš„å†…å­˜åˆ†é…è¯·æ±‚å¯ä»¥åˆå¹¶åˆ°ä¸€ä¸ª16Bçš„å†…å­˜å—ä¸­ã€‚è¯¸å¦‚æ­¤ç±»ï¼Œå¯ä»¥æé«˜å†…å­˜ä½¿ç”¨ç‡ã€‚ **tiny allcoatoråˆ†é…å†…å­˜çš„å¤§è‡´è¿‡ç¨‹ï¼š**æ¯ä¸ªpçš„mcacheæœ‰ä¸“é—¨ç”¨äºtiny allocatorçš„å†…å­˜(mcache.tiny)ã€‚è¿™æ˜¯ä¸€ä¸ª16Bçš„å†…å­˜å•å…ƒï¼Œmcache.tinyoffsetè®°å½•è¿™æ®µå†…å­˜å·²ç»ç”¨åˆ°å“ªé‡Œäº†ï¼Œå¦‚æœtiny allocatorè¿˜å¤Ÿåˆ†é…sizeå¤§å°çš„å†…å­˜ï¼Œå°±åœ¨tinyå†…å­˜å—ä¸­ç›´æ¥åˆ†é…ã€‚ (æ¥ä¸Š)å¦‚æœå‰©ä½™çš„ç©ºé—´ä¸å¤Ÿäº†ï¼Œå°±ä»å½“å‰pçš„mcacheä¸­ï¼Œæ‰¾åˆ°å¯¹åº”çš„mspanï¼Œé‡æ–°æ‹¿ä¸€ä¸ª16Bå¤§å°çš„å†…å­˜å—æ¥ç”¨ã€‚å¦‚æœæœ¬åœ°ç¼“å­˜ä¸­ç›¸åº”è§„æ ¼çš„mspanä¹Ÿæ²¡æœ‰ç©ºé—´äº†ï¼Œå°±ä¼šä»mcentralä¸­æ‹¿ä¸€ä¸ªæ–°çš„mspanè¿‡æ¥ï¼Œåˆ†é…å®Œä»¥åï¼Œå¦‚æœæ–°æ‹¿æ¥çš„å†…å­˜å—çš„å‰©ä½™ç©ºé—´æ¯”æ—§å†…å­˜çš„å‰©ä½™ç©ºé—´è¿˜è¦å¤§ï¼Œé‚£å°±ç”¨æ–°çš„å†…å­˜å—æŠŠæ—§çš„tinyæ›¿æ¢æ‰(æ—§çš„è¿˜åœ¨mcacheï¼Œåªä¸è¿‡ä¸å¼•ç”¨äº†)ã€‚ å¯¹äºæœ€åä¸€ç§ï¼Œç›´æ¥é€šè¿‡æœ¬åœ°mcacheä¸å…¨å±€mcentralé…åˆå·¥ä½œï¼Œæ‰¾åˆ°åŒ¹é…è§„æ ¼çš„mspanå³å¯ã€‚ ç©ºé—´åˆ†é…å¥½äº†è¿˜æ²¡å®Œï¼Œè¿˜è¦è®°å½•ä¸‹å“ªäº›å†…å­˜å·²è¢«åˆ†é…ï¼Œå“ªäº›æ•°æ®éœ€è¦GCæ‰«æï¼Œæ‰èƒ½ç»§ç»­å†…å­˜ç®¡ç†å·¥ä½œã€‚æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦è¿›è¡Œä¸€ç³»åˆ—ä½å›¾æ ‡è®°ã€‚ 2.2.3.3 ä½å›¾æ ‡è®° **é—®é¢˜ï¼š**é€šè¿‡ä¸€ä¸ªå †å†…å­˜åœ°å€ï¼Œå¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„heapArenaå’Œmspanï¼Ÿ å·²çŸ¥ï¼šä¸€ä¸ªå †å†…å­˜åœ°å€pï¼ŒarenaåŒºåŸŸèµ·å§‹åœ°å€å¦‚å›¾(arenaBaseOffset)ï¼Œæ¯ä¸ªarenaå¤§å°ä¸ºheapArenaBytesã€‚ æ±‚ï¼špåœ¨ç¬¬å‡ ä¸ªarenaä¸­ï¼Ÿ ç­”ï¼šarenaç¼–å· = (p-arenaBaseOffset)/heapArenaBytes å·²çŸ¥ï¼šamd64æ¶æ„çš„Linuxç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªarenaå¤§å°å’Œå¯¹é½è¾¹ç•Œéƒ½æ˜¯64M(26ä½)ï¼Œè€Œè™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„çº¿æ€§åœ°å€æœ‰48ä½ï¼Œé‚£48ä½çš„çº¿æ€§åœ°å€å¯ä»¥å¯»å€çš„è™šæ‹Ÿç©ºé—´å°±æ˜¯2^48è¿™ä¹ˆå¤§ã€‚ æ±‚ï¼šè¿™ä¹ˆå¤§çš„ç©ºé—´å¯ä»¥åˆ’åˆ†æˆå¤šå°‘ä¸ªarenaï¼Ÿ ç­”ï¼š2^48/64M=4M Goå¼€å‘è€…æŠŠh","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:5:3","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"2.2.4 æ ˆå†…å­˜åˆ†é… 2.2.4.1 æ ˆå†…å­˜åˆ†é…è¿‡ç¨‹ å †å†…å­˜åˆ†é…ä¸­çš„arenaä¸­çš„spané™¤äº†ç”¨ä½œå †å†…å­˜åˆ†é…å¤–ï¼Œä¹Ÿç”¨äºæ ˆå†…å­˜åˆ†é…ï¼Œåªæ˜¯ç”¨é€”ä¸åŒçš„spanå¯¹åº”çš„mspançŠ¶æ€ä¸åŒï¼Œç”¨ä½œå †å†…å­˜çš„mspanæ˜¯mSpanInUseçŠ¶æ€ï¼Œç”¨ä½œæ ˆå†…å­˜çš„æ˜¯mSpanManualçŠ¶æ€ã€‚ ä¸ºæé«˜æ ˆå†…å­˜åˆ†é…æ•ˆç‡ï¼Œè°ƒåº¦å™¨åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸¤ä¸ªç”¨äºæ ˆå†…å­˜åˆ†é…çš„å…¨å±€å¯¹è±¡ï¼š stackpoolé¢å‘32KBä»¥ä¸‹çš„æ ˆåˆ†é…ï¼Œæ ˆå¤§å°å¿…é¡»æ˜¯2çš„å¹‚ï¼Œæœ€å°ä¸º2KBï¼› **å¤§äºç­‰äº32KBçš„æ ˆï¼Œç”±stackLarge**æ¥åˆ†é…è¿™ä¹Ÿæ˜¯ä¸ªmspané“¾è¡¨çš„æ•°ç»„ï¼Œé•¿åº¦ä¸º25ï¼Œmspanè§„æ ¼ä»8KBå¼€å§‹ï¼Œä¹‹åæ¯ä¸ªé“¾è¡¨çš„mspanè§„æ ¼éƒ½æ˜¯å‰ä¸€ä¸ªçš„2å€ï¼Œ8KBå’Œ16KBè¿™ä¸¤ä¸ªé“¾è¡¨å®é™…ä¸Šä¸€ç›´æ˜¯ç©ºçš„ï¼Œç•™ç€ä»–ä»¬æ˜¯æ–¹ä¾¿ä½¿ç”¨mspanåŒ…å«é¡µé¢æ•°çš„(ä»¥2ä¸ºåº•)å¯¹æ•°ä½œä¸ºæ•°ç»„ä¸‹æ ‡ã€‚ åˆå§‹åŒ–åï¼Œè¿™äº›é“¾è¡¨éƒ½è¿˜æ˜¯ç©ºçš„ï¼Œæ¥ä¸‹æ¥å®ƒä»¬ä¼šä½œä¸ºå…¨å±€æ ˆç¼“å­˜æ¥ä½¿ç”¨ã€‚ åŒå †å†…å­˜åˆ†é…ä¸€æ ·ï¼Œæ¯ä¸ªpä¹Ÿæœ‰ç”¨äºæ ˆåˆ†é…çš„æœ¬åœ°ç¼“å­˜ï¼Œè¿™ç›¸å½“äºæ˜¯stackpoolçš„æœ¬åœ°ç¼“å­˜ã€‚ è¦åˆ†é…æ ˆå†…å­˜æ—¶ï¼š å°äº32KBçš„æ ˆç©ºé—´ï¼Œä¼šä¼˜å…ˆä½¿ç”¨å½“å‰pçš„æœ¬åœ°ç¼“å­˜ã€‚å¦‚æœæœ¬åœ°ç¼“å­˜ä¸­å¯¹åº”è§„æ ¼çš„å†…å­˜å—é“¾è¡¨ä¸ºç©ºï¼Œå°±ä»stackpoolåˆ†é…16KBçš„å†…å­˜æ”¾åˆ°æœ¬åœ°ç¼“å­˜(stackcache)ä¸­ï¼Œç„¶åç»§ç»­ä»æœ¬åœ°ç¼“å­˜åˆ†é…ï¼›å¦‚æœstackpoolä¸­å¯¹åº”çš„é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œå°±ä»å †å†…å­˜ä¸­ç›´æ¥åˆ†é…ä¸€ä¸ª32KBçš„spanï¼Œåˆ’åˆ†æˆå¯¹åº”çš„å†…å­˜å—å¤§å°æ”¾åˆ°stackpoolä¸­ï¼›ä¸è¿‡æœ‰äº›æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„ï¼Œåœ¨ä¸èƒ½ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå°±ç›´æ¥ä»stackpoolåˆ†é…ï¼› æœ¬åœ°æ— å¯ç”¨ç¼“å­˜ï¼Œä»stackpoolåˆ†é…ï¼š stackpoolä¹Ÿä¸ºç©ºï¼š æ— æ³•ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼š å¤§äºç­‰äº32KBçš„æ ˆç©ºé—´ï¼Œå°±è®¡ç®—éœ€è¦çš„pageæ•°ç›®ï¼Œå¹¶ä»¥2ä¸ºåº•æ±‚å¯¹æ•°(log2npage)ï¼Œå°†å¾—åˆ°çš„ç»“æœä½œä¸ºstackLargeæ•°ç»„çš„ä¸‹æ ‡ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç©ºé—²spané“¾è¡¨ã€‚è‹¥é“¾è¡¨ä¸ä¸ºç©ºï¼Œå°±æ‹¿ä¸€ä¸ªè¿‡æ¥ç”¨ï¼›è‹¥é“¾è¡¨ä¸ºç©ºï¼Œå°±ç›´æ¥ä»å †å†…å­˜åˆ†é…ä¸€ä¸ªæ‹¥æœ‰è¿™ä¹ˆå¤šä¸ªé¡µé¢çš„spanï¼Œå¹¶æŠŠå®ƒæ•´ä¸ªç”¨äºåˆ†é…æ ˆå†…å­˜ï¼Œ é“¾è¡¨ä¸ä¸ºç©ºï¼š é“¾è¡¨ä¸ºç©ºï¼š 2.2.4.2 æ ˆå¢é•¿ æ ˆå†…å­˜åˆå§‹åˆ†é…å‘ç”Ÿåœ¨goroutineåˆ›å»ºæ—¶ï¼Œç”±äºåˆå§‹æ ˆå¤§å°éƒ½æ˜¯2KBï¼Œåœ¨å®é™…ä¸šåŠ¡ä¸­å¯èƒ½ä¼šä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥éœ€è¦å®ç°ä¸€ç§åœ¨è¿è¡Œé˜¶æ®µåŠ¨æ€å¢é•¿æ ˆçš„æœºåˆ¶ã€‚ goroutineçš„æ ˆå¢é•¿ï¼Œæ˜¯é€šè¿‡ç¼–è¯‘å™¨å’Œruntimeåˆä½œå®ç°çš„ã€‚ç¼–è¯‘å™¨ä¼šåœ¨å‡½æ•°çš„å¤´éƒ¨å®‰æ’æ£€æµ‹ä»£ç ï¼Œæ£€æŸ¥å½“å‰å‰©ä½™çš„æ ˆç©ºé—´æ˜¯å¦å¤Ÿç”¨ã€‚è‹¥ä¸å¤Ÿç”¨ï¼Œå°±è°ƒç”¨runtimeä¸­çš„ç›¸å…³å‡½æ•°æ¥å¢é•¿æ ˆç©ºé—´(runtime.morestack_noctxt)ï¼Œæ ˆç©ºé—´æ˜¯æˆå€å¢é•¿çš„ï¼Œéœ€è¦å¢é•¿æ—¶ï¼Œå°±å…ˆæŠŠå½“å‰çš„æ ˆç©ºé—´å¤§å°x2ï¼Œå¹¶æŠŠåç¨‹çŠ¶æ€ç½®ä¸º_Gcopystackï¼Œæ¥ä¸‹æ¥è°ƒç”¨copystackå‡½æ•°åˆ†é…æ–°çš„æ ˆç©ºé—´å¹¶æ‹·è´æ—§æ ˆä¸Šçš„æ•°æ®ï¼Œé‡Šæ”¾æ—§æ ˆçš„ç©ºé—´ï¼Œæœ€åæ¢å¤åç¨‹è¿è¡Œ_Grunningã€‚ 2.2.4.3 æ ˆæ”¶ç¼© æ ˆæ”¶ç¼©å¯ä»¥å‡å°‘è¿è¡Œä¸­çš„åç¨‹å¯¹æ ˆç©ºé—´çš„æµªè´¹ã€‚ æ ˆæ”¶ç¼©ä¸ä¼šç¼©åˆ°æ¯”2KBè¿˜å°ã€‚ å”¯ä¸€å¯ä»¥è§¦å‘æ ˆæ”¶ç¼©çš„åœ°æ–¹å°±æ˜¯**GC**ã€‚ GCé€šè¿‡scanstackå‡½æ•°å¯»æ‰¾æ ‡è®°rootèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœå‘ç°å¯ä»¥å®‰å…¨çš„æ”¶ç¼©æ ˆï¼Œå°±ä¼šæ‰§è¡Œæ ˆæ”¶ç¼©ï¼›ä¸èƒ½é©¬ä¸Šæ‰§è¡Œæ—¶ï¼Œå°±è®¾ç½®æ ˆæ”¶ç¼©æ ‡è¯†(g.preemptShrink=true)ï¼Œç­‰åˆ°åç¨‹æ£€æµ‹åˆ°æŠ¢å æ ‡è¯†(stackPreempt)ï¼Œåœ¨è®©å‡ºCPUå‰ä¼šæ£€æŸ¥è¿™ä¸ªæ ˆæ”¶ç¼©æ ‡è¯†ï¼Œä¸ºtrueæ—¶å°±ä¼šå…ˆè¿›è¡Œæ ˆæ”¶ç¼©ï¼Œå†è®©å‡ºCPUã€‚ 2.2.4.4 æ ˆé‡Šæ”¾ ä½†æ˜¯ç»“æŸè¿è¡Œçš„åç¨‹çš„æ ˆç©ºé—´è¯¥æ€ä¹ˆå›æ”¶åˆ©ç”¨ï¼Ÿ å¸¸è§„gorontineç»“æŸæ—¶ï¼Œä¼šè¢«æ”¾åˆ°è°ƒåº¦å™¨å¯¹è±¡çš„ç©ºé—²gé˜Ÿåˆ—(sched.gFree)ä¸­ï¼Œè¿™é‡Œçš„ç©ºé—²åç¨‹åˆ†ä¸¤ç§ï¼š ä¸€ç§æœ‰åç¨‹æ ˆ(sched.gFree.stack)ï¼› ä¸€ç§æ²¡æœ‰åç¨‹æ ˆ(sched.gFree.noStack)ã€‚ åˆ›å»ºåç¨‹æ—¶ï¼Œä¼šå…ˆçœ‹çœ‹è¿™é‡Œæœ‰æ²¡æœ‰ç©ºé—²åç¨‹å¯ä»¥ç”¨ï¼Œä¼˜å…ˆä½¿ç”¨æœ‰æ ˆçš„åç¨‹ï¼Œå…¶æ¬¡ä½¿ç”¨æ— æ ˆçš„åç¨‹ã€‚ ä¸è¿‡ï¼Œå¸¸è§„goroutineè¿è¡Œç»“æŸæ—¶ï¼Œéƒ½æœ‰åç¨‹æ ˆï¼Œåº”è¯¥è¿›åˆ°å“ªä¸ªé˜Ÿåˆ—å‘¢ï¼Ÿ å¦‚æœåç¨‹æ ˆæ²¡æœ‰å¢é•¿è¿‡(è¿˜æ˜¯2KB)ï¼Œå°±æŠŠè¿™ä¸ªåç¨‹æ”¾åˆ°æœ‰æ ˆçš„ç©ºé—²gé˜Ÿåˆ—ä¸­ã€‚è€Œè¿™äº›ç©ºé—²åç¨‹çš„æ ˆï¼Œä¹Ÿä¼šåœ¨GCæ‰§è¡Œmarkrootæ—¶è¢«é‡Šæ”¾ï¼Œåˆ°æ—¶å€™æœ‰æ ˆçš„ç©ºé—²gä¹Ÿä¼šåŠ å…¥åˆ°æ— æ ˆçš„ç©ºé—²gé˜Ÿåˆ—ä¸­ã€‚ å¦‚æœåç¨‹æ ˆæœ‰å¢é•¿è¿‡ï¼Œå°±æŠŠåç¨‹æ ˆé‡Šæ”¾æ‰ï¼Œå†æŠŠåç¨‹æ ˆæ”¾å…¥æ— æ ˆçš„ç©ºé—²gé˜Ÿåˆ—ä¸­ã€‚ **é—®é¢˜ï¼š**é‚£ä¹ˆæ ˆé‡Šæ”¾åˆ°å“ªé‡Œäº†å‘¢ï¼Ÿæ˜¯æ”¾å›åˆ°å½“å‰pçš„æœ¬åœ°ç¼“å­˜ï¼Ÿè¿˜æ˜¯æ”¾å›åˆ°å…¨å±€æ ˆç¼“å­˜ï¼ŸæŠ‘æˆ–æ˜¯ç›´æ¥è¿˜ç»™å †å†…å­˜ï¼Ÿ **ç­”ï¼š**å…¶å®éƒ½æœ‰å¯èƒ½ï¼Œè¦è§†æƒ…å†µè€Œå®šã€‚ å°äº32KBçš„æ ˆï¼šåœ¨é‡Šæ”¾æ—¶ä¼šå…ˆæ”¾å›æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¦‚æœæœ¬åœ°ç¼“å­˜å¯¹åº”é“¾è¡¨ä¸­æ ˆç©ºé—´æ€»å’Œå¤§äº32KBï¼Œå°±æŠŠä¸€éƒ¨åˆ†æ”¾å›stackpoolä¸­ï¼Œæœ¬åœ°è¿™ä¸ªé“¾è¡¨åªä¿ç•™16KBï¼›å¦‚æœæœ¬åœ°ç¼“å­˜ä¸å¯ç”¨ï¼Œä¹Ÿä¼šç›´æ¥æ”¾å›stackpoolä¸­ã€‚è€Œä¸”ï¼Œå¦‚æœå‘ç°è¿™ä¸ªmspanä¸­ï¼Œæ‰€æœ‰å†…å­˜å—éƒ½è¢«é‡Šæ”¾äº†å°±ä¼šæŠŠå®ƒå½’è¿˜ç»™å †å†…å­˜ã€‚ **å¤§äºç­‰äº32KBçš„æ ˆï¼š**å¦‚æœå½“å‰å¤„äºGCæ¸…ç†é˜¶æ®µ(gcphase == _GCoff)ï¼Œå°±ç›´æ¥é‡Šæ”¾åˆ°å †å†…å­˜ï¼›å¦åˆ™å…ˆæŠŠå®ƒæ”¾å›åˆ°stackLargeã€‚ ä¸‰ã€é¢è¯•é¢˜ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:5:4","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.1 Goroutineè°ƒåº¦ é¢˜ç›®ï¼š1 func main() { runtime.GOMAXPROCS(1) var wg sync.WaitGroup wg.Add(3) go func(n int) { println(n) wg.Done() }(1) go func(n int) { println(n) wg.Done() }(2) go func(n int) { println(n) wg.Done() }(3) wg.Wait() } é¦–å…ˆï¼Œç¬¬2è¡Œruntime.GOMAXPROCS(1)æŠŠGMPæ¨¡å‹ä¸­**Pçš„æ•°é‡é™åˆ¶ä¸º1**ï¼Œè¿™ä¹Ÿå°±é™åˆ¶äº†ä»»ä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªMæ‰§è¡ŒGoä»£ç ã€‚åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œå†æ¥åˆ†æè¿™å‡ ä¸ªgoroutineçš„æ‰§è¡Œé¡ºåºã€‚ é€šè¿‡å…³é”®å­—goæ¥åˆ›å»ºæ–°çš„goroutineï¼Œå®é™…ä¸Šä¼šè¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸ºå¯¹runtime.newprocçš„è°ƒç”¨ã€‚è¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘å°±æ˜¯å…ˆåˆ‡æ¢è‡³ç³»ç»Ÿæ ˆï¼Œç„¶åè°ƒç”¨newproc1å‡½æ•°ï¼Œåˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„gï¼Œå†é€šè¿‡runqputæŠŠæ–°çš„gæ·»åŠ åˆ°**å½“å‰Pçš„æœ¬åœ°runq**ä¸­ã€‚ å¬èµ·æ¥ï¼Œæœ€åçš„è¾“å‡ºåº”è¯¥æ˜¯1 2 3ã€‚ä½†å®é™…ä¸Šæœ€åçš„è¾“å‡ºæ˜¯3 1 2ã€‚ å®é™…ä¸Šï¼ŒPä¸ä»…æœ‰æœ¬åœ°runqï¼Œè¿˜æœ‰ä¸€ä¸ªrunnextå­—æ®µï¼Œç”¨æ¥ä¿å­˜ä¸‹æ¬¡è¦è¿è¡Œçš„gï¼Œnewproc1ä¸­è°ƒç”¨runqputæ—¶ä¼šç”¨åˆ°è¿™ä¸ªrunnextã€‚è¿‡ç¨‹å¦‚ä¸‹ï¼Œæˆ‘ä»¬å°†è¾“å‡ºçš„æ•°å€¼ä½œä¸ºå¯¹åº”goroutineçš„ä»£å·ï¼Œï¼š é¦–å…ˆï¼Œ1å·goroutineè¢«è®°åœ¨runnextä¸­ï¼Œ2å·goroutineæŠŠ1å·goroutineæŒ¤èµ°ï¼Œ1å·goroutineè¿›å…¥åˆ°æœ¬åœ°runqï¼› æ¥ä¸‹æ¥ï¼Œ3å·goroutineåˆä¼šæŠŠ2å·goroutineæŒ¤èµ°ï¼Œ2å·goroutineä¼šè¿›å…¥æœ¬åœ°runqé˜Ÿåˆ—å°¾éƒ¨ï¼› è°ƒåº¦goroutineæ‰§è¡Œæ—¶ï¼Œé€šè¿‡runqgetè·å–å¾…æ‰§è¡Œçš„gã€‚è€Œrunqgetä¹Ÿä¼šå¯¹runnextç‰¹æ®Šå¤„ç†ï¼Œ**ä¼˜å…ˆè°ƒåº¦runnext**è¿™é‡Œè®°å½•çš„gï¼Œå†æŒ‰é¡ºåºè°ƒåº¦æœ¬åœ°runqä¸­è®°å½•çš„gï¼› å› æ­¤ï¼Œ3å·goroutineä¼˜å…ˆæ‰§è¡Œï¼Œç„¶åæ˜¯æœ¬åœ°runqé˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯3 1 2ã€‚ **æœ¬é¢˜åªæœ‰ 3 ä¸ªgoroutineï¼Œé‚£å¦‚æœæ˜¯ 4ã€5ã€6ã€â€¦ ä¸ªå‘¢ï¼Ÿ**åˆæ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿè¯·çœ‹ä¸‹é¢˜ï¼ é¢˜ç›®ï¼š2 func main() { runtime.GOMAXPROCS(1) var wg sync.WaitGroup N := 4 // å¯ä»¥ä¸æ–­å¢å¤§ Nï¼Œä¸´ç•Œç‚¹åœ¨ 257 for i := 1; i \u003c= N; i++ { wg.Add(1) go func(n int) { println(n) wg.Done() }(i) } wg.Wait() } å…¶ä¸­ï¼Œ4ä¸ªgoroutineçš„è¾“å‡ºæ˜¯4 1 2 3ï¼Œ5ä¸ªgoroutineçš„è¾“å‡ºæ˜¯5 1 2 3 4ï¼Œç›´åˆ°257ä¸ªgoroutineçš„è¾“å‡ºæ˜¯257 1 2 ... 256ï¼Œå¯ä»¥çœ‹å‡ºN \u003c= 257æ—¶ï¼Œéƒ½æ˜¯è¿™ä¸ªè§„å¾‹ã€‚ ä½†æ˜¯N \u003e 257æ—¶åˆæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿä¸è¦å¿˜è®°å…¨å±€runqï¼ï¼ï¼ å…ˆè§£é‡Šä¸€ä¸‹N \u003c= 257æ˜¯ä¸ºå•¥ï¼ŸPçš„runnextå¯ä»¥è®°å½•1ä¸ªgï¼Œæœ¬åœ°runqå¯ä»¥è®°å½•256ä¸ªgï¼Œä¸€å…±å°±æ˜¯257ä¸ªã€‚æ‰€ä»¥è‹¥N = 257ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µï¼š æ¥ä¸‹æ¥è‹¥åˆåˆ°è¾¾258å·gï¼Œä¼šæŠŠ257å·gæŒ¤èµ°ï¼Œä½†æœ¬åœ°runqå·²æ»¡ï¼Œæ‰€ä»¥**257å·gä¼šå’Œæœ¬åœ°runqä¸­çš„å‰ä¸€åŠg**ä¸€èµ·è¿›åˆ°å…¨å±€runqä¸­(ä¹‹æ‰€ä»¥å–å‰ä¸€åŠæ˜¯ä¸ºäº†é˜²æ­¢é¥¥é¥¿ï¼Œä¹‹æ‰€ä»¥éšæœºæ”¾åˆ°å…¨å±€runqæ˜¯ä¸ºäº†é¿å…å¤šæ ¸cpuä¿®æ”¹åŒä¸€ä¸ªç¼“å­˜)ã€‚ æŒ‰ç…§å¹³æ—¶æè¿°çš„è°ƒåº¦é€»è¾‘ï¼šå…ˆä»æœ¬åœ°runqè·å–å¾…æ‰§è¡Œçš„gï¼Œæ²¡æœ‰çš„è¯å†ä»å…¨å±€runqè·å–ï¼Œè¿˜æ²¡æœ‰çš„è¯å°±å»åˆ«çš„pé‚£é‡Œstealä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥ï¼š è¿™é‡Œæœ€å…ˆæ‰§è¡Œçš„æ˜¯runnextä¸­çš„258å·goroutineï¼› æ¥ä¸‹æ¥æ˜¯æœ¬åœ°runqä¸­çš„129å·-256å·ï¼› æœ€åå…¨å±€é˜Ÿåˆ—ä¸­çš„gæ‰ä¼šè¢«æ‹¿å›æœ¬åœ°runqã€‚ ==ä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤==ã€‚å®é™…è¿è¡Œå‘ç°ï¼Œåœ¨129å·-256å·ä¹‹é—´ï¼Œä¼šå‘ç°1å·å’Œ2å·ä¹Ÿç©¿æ’åœ¨è¿™æ®µåŒºé—´å†…è¢«æ‰§è¡Œäº†ã€‚è¿™ä¸ªé—®é¢˜ä¸runqçš„æ’é˜Ÿé€»è¾‘æ— å…³ï¼Œå±äºè°ƒåº¦é€»è¾‘çš„èŒƒç•´ã€‚ åœ¨ä»‹ç»runtime.scheduleæ—¶ï¼Œä»‹ç»è¿‡æ¯éš”61ä¸ªschedtickå°±ä¼šä¼˜å…ˆä»å…¨å±€runqä¸­è·å–goroutineï¼Œè¿™æ ·æ˜¯ä¸ºäº†é¿å…åœ¨æ¯ä¸ªpçš„æœ¬åœ°runqéƒ½ç¹å¿™çš„æ—¶å€™ï¼Œå…¨å±€runqä¸­çš„goroutineè¿Ÿè¿Ÿå¾—ä¸åˆ°è°ƒåº¦çš„æƒ…å†µã€‚ é—®ç­”é¢˜é›†åˆ é—®ï¼šGPMæ¨¡å‹ä¸­ï¼ŒPå¼•å…¥çš„åŸå› ï¼Ÿ ç­”ï¼š ä¸€å¼€å§‹æ‰€æœ‰çš„géƒ½åœ¨ä¸€ä¸ªå…¨å±€runqä¸­ï¼Œç”¨ä¸€ä¸ªå…¨å±€çš„mutexä¿æŠ¤å…¨å±€runqï¼Œå¤šä¸ªmä»å…¨å±€runqä¸­è·å–gæ—¶éœ€è¦é¢‘ç¹çš„åŠ è§£é”åŠç­‰å¾…ï¼› gçš„æ¯æ¬¡æ‰§è¡Œä¼šè¢«éšæœºçš„åˆ†åˆ°ä¸åŒçš„mï¼Œé€ æˆåœ¨ä¸åŒmçš„é¢‘ç¹åˆ‡æ¢ï¼Œç ´åç¨‹åºçš„å±€éƒ¨æ€§ï¼›(è¿™ç‚¹æœ‰ç‚¹æ€ªï¼Œæœ‰å¾…ç¡®å®š) æ¯ä¸ªméƒ½ä¼šå…³è”ä¸€ä¸ªå†…å­˜åˆ†é…ç¼“å­˜ï¼Œé€ æˆå¤§é‡çš„å†…å­˜å¼€é”€ï¼Œä½†å®é™…ä¸Šåªæœ‰æ‰§è¡Œgçš„mæ‰éœ€è¦ï¼Œé‚£äº›é˜»å¡åœ¨è°ƒåº¦çš„mæ ¹æœ¬ä¸éœ€è¦ï¼› å¼•å…¥påï¼Œmå°±å¯ä»¥ç›´æ¥ä»på¤„è·å–å¾…æ‰§è¡Œçš„gï¼Œä¸ç”¨æ¯æ¬¡éƒ½å’Œä¼—å¤šmä»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­äº‰æŠ¢ä»»åŠ¡ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚ é—®ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å±äºåŒä¸€ä¸ªè¿›ç¨‹å¹¶å…±äº«å†…å­˜ç©ºé—´ã€‚ å› ä¸ºå¤šçº¿ç¨‹ä¸éœ€è¦åˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä»¬ä¹Ÿä¸éœ€è¦å†…å­˜ç®¡ç†å•å…ƒå¤„ç†ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ä¹Ÿæ­£æ˜¯åŸºäºå…±äº«çš„å†…å­˜è¿›è¡Œçš„ï¼Œä¸é‡é‡çº§çš„è¿›ç¨‹ç›¸æ¯”ï¼Œçº¿ç¨‹æ˜¾å¾—æ¯”è¾ƒè½»é‡ã€‚è¿™ä¸æ˜¯æŒºå¥½çš„å˜›ï¼Œä¸ºå•¥è¿˜è¦å¼•å…¥goroutineï¼Ÿ ç­”ï¼š è™½ç„¶çº¿ç¨‹æ¯”è¾ƒè½»é‡ï¼Œä½†æ˜¯åœ¨è°ƒåº¦æ—¶ä¹Ÿæœ‰æ¯”è¾ƒå¤§çš„é¢å¤–å¼€é”€ï¼› æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦ä¸€ä¸ªç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆï¼Œå½“éœ€è¦ä½¿ç”¨ç³»ç»Ÿèµ„æºçš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€ã€‚(ä¸ºä»€ä¹ˆè¦åˆ†å¼€ï¼Ÿä¸ºäº†é˜²æ­¢ç”¨æˆ·æ€ä»£ç è®¿é—®å†…æ ¸æ•°æ®)ã€‚å½“ç³»ç»Ÿçš„çº¿ç¨‹è¾¾åˆ°ä¸€å®šè§„æ¨¡ï¼Œå†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆä¼šå ç”¨å¤§é‡å†…å­˜ï¼›å¹¶ä¸”ï¼Œæ“ä½œç³»ç»ŸåŸºäºæ—¶é—´ç‰‡çš„ç­–ç•¥è°ƒåº¦æ‰€æœ‰çº¿ç¨‹ï¼Œè‹¥çº¿ç¨‹è§„æ¨¡è¿‡å¤§ï¼Œä¸ºäº†é™ä½å»¶è¿Ÿï¼Œçº¿ç¨‹æ¯æ¬¡è·å¾—çš„æ—¶é—´ç‰‡ä¼šè¢«å‹ç¼©ï¼Œä»è€Œå¯¼è‡´çº¿ç¨‹åˆ‡æ¢é¢‘ç‡å˜å¤§ã€‚çº¿ç¨‹çš„é¢‘ç¹åˆ‡æ¢ä¹Ÿä¼šå ç”¨å¤§é‡CPUèµ„æºã€‚è€Œé«˜å¹¶å‘çš„åœºæ™¯éœ€æ±‚å°±æ˜¯è¦é¢‘ç¹åˆ‡æ¢ã€‚ å¼•å…¥åç¨‹ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ï¼Œé™ä½è°ƒåº¦ä»£ä»·ã€‚åç¨‹çš„è°ƒåº¦ä¸éœ€è¦æ“ä½œç³»ç»Ÿå‚ä¸ï¼Œåªéœ€è¦ç”¨æˆ·æ€ç¨‹åºè°ƒåº¦ã€‚ æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå ç”¨ 1M ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ï¼Œåœ¨åˆ‡æ¢çº¿ç¨‹æ—¶ä¸æ­¢ä¼šæ¶ˆè€—è¾ƒå¤šçš„å†…å­˜ï¼Œæ¢å¤å¯„å­˜å™¨ä¸­çš„å†…å®¹è¿˜éœ€è¦å‘æ“ä½œç³»ç»Ÿç”³è¯·æˆ–è€…é”€æ¯èµ„æºï¼Œæ¯ä¸€æ¬¡çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éƒ½éœ€è¦æ¶ˆè€— ~1us å·¦å³çš„æ—¶é—´ï¼Œä½†æ˜¯ Go è°ƒåº¦å™¨å¯¹ Goroutine çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çº¦ä¸º ~0.2usï¼Œå‡å°‘äº† 80% çš„é¢å¤–å¼€é”€ã€‚ **é—®ï¼š**è°è´Ÿè´£è§¦å‘timeræ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Ÿ ç­”ï¼štimerçš„è§¦å‘åˆ†ä¸ºè°ƒåº¦è§¦å‘å’Œç›‘æ§çº¿ç¨‹è§¦å‘ï¼Œä¸¤è€…ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•°checkTimers()æ¥å®ç°ã€‚ å…¶å®æ¯ä¸ªpéƒ½æœ‰ä¸€ä¸ªæœ€å°å †p.timersï¼Œç”¨äºç®¡ç†è‡ªå·±çš„timerï¼Œå †é¡¶çš„timerå°±æ˜¯æ¥ä¸‹æ¥è¦è§¦å‘çš„é‚£ä¸€ä¸ª(è€ç‰ˆæœ¬è¿™ä¸ªå †æ˜¯å…¨å±€çš„ï¼Œå°±å¾ˆæ…¢ï¼)ã€‚è€Œå·¥ä½œçº¿ç¨‹æ¯æ¬¡è°ƒåº¦æ—¶(æ‰§è¡Œschedule()æ—¶)ï¼Œéƒ½ä¼šè°ƒç”¨checkTimers()å‡½æ•°ï¼Œæ£€æŸ¥å¹¶æ‰§è¡Œé‚£äº›å·²ç»åˆ°æ—¶é—´çš„timerã€‚ä¸è¿‡è¿™ä¸å¤Ÿç¨³å¦¥ï¼Œä¸‡ä¸€æ‰€æœ‰çš„méƒ½åœ¨å¿™ï¼Œé‚£ä¹ˆå°±ä¸èƒ½åŠæ—¶è§¦å‘è°ƒåº¦äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´timeræ‰§è¡Œæ—¶é—´å‘ç”Ÿè¾ƒå¤§åå·®ã€‚æ‰€ä»¥è¿˜ä¼šé€šè¿‡ç›‘æ§çº¿ç¨‹æ¥å¢åŠ ä¸€å±‚ä¿éšœã€‚ ç›‘æ§çº¿ç¨‹æ˜¯ç”±main goroutineåˆ›å»ºçš„ï¼Œä¸GPMä¸­çš„å·¥ä½œçº¿ç¨‹ä¸åŒï¼Œå¹¶ä¸éœ€è¦ä¾èµ–pï¼Œä¹Ÿä¸ç”±GPMè°ƒåº¦ã€‚ç›‘æ§çº¿ç¨‹æœ‰å¤šä¸ªä»»åŠ¡ï¼Œå…¶ä¸­ä¸€é¡¹ä¾¿æ˜¯ä¿éšœtimerçš„æ­£å¸¸æ‰§è¡Œã€‚ç›‘æ§çº¿ç¨‹æ£€æµ‹åˆ°æ¥ä¸‹æ¥æœ‰timerè¦æ‰§è¡Œæ—¶(éå†æ‰€æœ‰çš„pï¼Œæ‰¾å‡ºä¸‹æ¬¡æœ€å…ˆæ‰§è¡Œ(æ—¶é—´å€¼æœ€å°)çš„æ—¶é—´å’Œå…¶æ‰€åœ¨çš„p)ï¼Œè‹¥æ­¤æ—¶æ— ç©ºé—²mï¼Œä¾¿ä¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ä»¥ä¿éšœtimerå¯ä»¥é¡ºåˆ©æ‰§è¡Œã€‚ é—®ï¼šå¦‚ä½•æŠ¢å ï¼Ÿå…·ä½“è¯´è¯´ï¼Ÿ ç­”ï¼šç›‘æ§çº¿ç¨‹è¦æœ¬ç€å…¬å¹³è°ƒåº¦çš„åŸåˆ™ï¼Œå¯¹è¿è¡Œæ—¶é—´è¿‡é•¿çš„på®è¡Œ**â€œæŠ¢å â€**æ“ä½œã€‚å°±æ˜¯å‘Šè¯‰é‚£äº›è¿è¡Œæ—¶é—´è¶…è¿‡ç‰¹å®šé˜ˆå€¼(10ms)çš„gï¼Œè¯¥è®©å‡ºäº†ï¼ Go 1.14ä¹‹å‰ä¾èµ–äºæ ˆå¢é•¿ã€‚**å±•å¼€ï¼š**å½“runtimeå¸Œæœ›æŸä¸ªåç¨‹è®©å‡ºCPUæ—¶ï¼Œå°±ä¼šæŠŠä»–çš„stackguardèµ‹å€¼ä¸ºstackPreemptï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼ŒçœŸæ­£çš„æ ˆæŒ‡é’ˆä¸ä¼šæŒ‡å‘è¿™ä¸ªä½ç½®ï¼Œå› æ­¤ç”¨ä½œç‰¹æ®Šæ ‡è¯†ã€‚è¿›è€Œä¼šè·³è½¬åˆ°morestackå¤„ï¼Œè€Œmorestackä¼šè°ƒç”¨runtime.newstack()å‡½æ•°ï¼Œè´Ÿè´£æ ˆå¢é•¿å·¥ä½œã€‚ä¸è¿‡ä»–åœ¨è¿›è¡Œæ ˆå¢é•¿å·¥ä½œå‰ä¼šå…ˆåˆ¤æ–­stackguard0æ˜¯å¦ç­‰äºstackPreemptï¼Œç­‰äºçš„è¯å°±ä¸è¿›è¡Œæ ˆå¢é•¿äº†ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€æ¬¡åç¨‹è°ƒåº¦ã€‚è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯è¿‡åº¦ä¾èµ–æ ˆå¢é•¿ä»£ç ï¼Œå¦‚æœæ¥ä¸ªç©ºçš„for{}å¾ªç¯ï¼Œå› ä¸ºä¸æ ˆå¢é•¿æ— å…³ï¼Œç¨‹åºå°±ä¼šå¡æ­»åœ¨è¿™ä¸ªåœ°æ–¹ã€‚ å…¶å®ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨CPUï¼Œç›‘æ§çº¿ç¨‹è¿˜ä¼šæŠ¢å å¤„åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­çš„pï¼Œå› ä¸ºä¸€ä¸ªåç¨‹è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå°±è¦åˆ‡æ¢åˆ°g0æ ˆï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨æ²¡æ‰§è¡Œå®Œä¹‹å‰ï¼Œè¿™ä¸ªmå’Œgå…¶å®ç»‘å®šäº†ï¼Œä¸èƒ½è¢«åˆ†å¼€ï¼Œä¹Ÿå°±ç”¨ä¸åˆ°pï¼Œæ‰€ä»¥åœ¨é™·å…¥ç³»ç»Ÿè°ƒç”¨å‰ï¼Œå½“å‰mä¼šè®©å‡ºpï¼Œè§£é™¤m.pä¸å½“å‰pçš„å¼ºå…³è”ï¼Œåªåœ¨m.oldpä¸­è®°å½•è¿™ä¸ªpã€‚pçš„æ•°ç›®æ¯•ç«Ÿæœ‰é™ï¼Œå¦‚æœæœ‰å…¶ä»–åç¨‹æ­£åœ¨ç­‰å¾…æ‰§è¡Œï¼Œé‚£å°±ä¼šæŠŠä»–å…³è”åˆ°å…¶ä»–mã€‚ ä¸è¿‡å¦‚æœå½“å‰mä»ç³»ç»Ÿè°ƒç”¨ä¸­æ¢å¤ï¼Œä¼šå…ˆæ£€æµ‹ä¹‹å‰çš„pæ˜¯å¦è¢«å ç”¨ï¼Œæ²¡æœ‰çš„è¯å°±ç»§ç»­ä½¿ç”¨ï¼Œå¦åˆ™å†å»ç”³è¯·ä¸€ä¸ªï¼Œæ²¡ç”³è¯·åˆ°çš„è¯ï¼Œå°±æŠŠå½“å‰gæ”¾å…¥å…¨å±€runqä¸­ï¼Œç„¶åå½“å‰çº¿ç¨‹å°±ç¡çœ äº†ã€‚ **é—®ï¼š**é‚£æŠ¢å æ—¶ï¼Œæ€ä¹ˆçŸ¥é“æŸä¸ªgè¿è¡Œæ—¶é—´è¿‡é•¿äº†å‘¢ï¼Ÿ ç­”ï¼špé‡Œé¢æœ‰ä¸€ä¸ªschedtickå­—æ®µï¼Œæ¯å½“è°ƒåº¦æ‰§è¡Œä¸€ä¸ªæ–°çš„gï¼Œå¹¶ä¸”ä¸ç»§æ‰¿ä¸Šä¸ªgçš„æ—¶é—´ç‰‡æ—¶ï¼Œå°±ä¼šæŠŠp.schedtick++ï¼Œè€Œsysmontick.schedwhenè®°å½•ä¸Šä¸€æ¬¡è°ƒåº¦çš„æ—¶é—´ã€‚ç›‘æ§çº¿ç¨‹å¦‚æœç›‘æµ‹åˆ°sysmontick.schedtickä¸p.schedtickä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿™ä¸ªpå‘ç”Ÿäº†æ–°çš„è°ƒåº¦ï¼Œå°±ä¼šåŒæ­¥sysmontick.schedtickçš„å€¼ï¼Œå¹¶æ›´æ–°è°ƒåº¦æ—¶é—´sysmontick.schedwhenï¼›ä½†è‹¥äºŒè€…ç›¸ç­‰ï¼Œè¯´æ˜æ²¡å‘ç”Ÿæ–°çš„è°ƒåº¦ï¼Œæˆ–è€…å³ä½¿å‘ç”Ÿäº†æ–°çš„è°ƒåº¦ï¼Œä¹Ÿæ²¿ç”¨äº†ä¹‹å‰çš„æ—¶é—´ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å½“å‰æ—¶é—´ä¸sysmontick.schedwhençš„å·®å€¼æ¥åˆ¤æ–­å½“å‰pä¸Šçš„gæ˜¯","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:6:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.2 ç»„åˆå¼ç»§æ‰¿ é—®ï¼šå¦‚ä¸‹ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ é—®ï¼šç»„åˆå¼ç»§æ‰¿ä¸­ï¼Œç¼–è¯‘å™¨ç”ŸæˆåŒ…è£…æ–¹æ³•çš„è§„åˆ™ï¼Ÿ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:7:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.3 é—­åŒ… func main() { x()() } func x() (y func()) { y = func() { println(\"y\") } return func() { println(\"z\") y() } } ä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ ä¼šä¸æ–­çš„è¾“å‡ºzã€‚ å…ˆçœ‹mainå‡½æ•°çš„æ ˆå¸§ï¼š xå‡½æ•°åªæœ‰è¿”å›å€¼æ²¡æœ‰å‚æ•°ï¼Œè€Œxçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å‡½æ•°ä½œä¸ºå‚æ•°ã€è¿”å›å€¼æˆ–è€…è¢«èµ‹å€¼ç»™å˜é‡æ—¶ï¼Œå°±è¢«ç§°ä¸ºFunction Valueã€‚æ‰€ä»¥è¿™é‡Œçš„yæ˜¯ä¸€ä¸ªFunction Valueã€‚Function Valueæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªruntime.funcvalç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å­˜å‚¨äº†å¯¹åº”å‡½æ•°çš„æŒ‡ä»¤å…¥å£åœ°å€ã€‚xè¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°ä¸­æ•è·äº†yï¼Œæ‰€ä»¥è¿™ä¸ªè¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å¯¹è±¡ã€‚é—­åŒ…å¯¹è±¡å°±æ˜¯ä¸€ä¸ªæœ‰æ•è·åˆ—è¡¨çš„Function Valueè€Œå·²ã€‚ ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ä¸ªå‡½æ•°å…¥å£åœ°å€åé¢ï¼Œä¼šæœ‰è¯¥é—­åŒ…å‡½æ•°æ•è·çš„å˜é‡ï¼Œ**ä¸è¿‡è¿™é‡Œæ•è·çš„ç©¶ç«Ÿæ˜¯å˜é‡çš„å€¼è¿˜æ˜¯å®ƒçš„åœ°å€ï¼Ÿ**å…¶å®ï¼Œå¦‚æœè¢«æ•è·çš„å˜é‡åœ¨å…¶èµ‹åˆå€¼åæ²¡æœ‰åœ¨è¢«ä¿®æ”¹è¿‡ï¼Œå°±ä¼šæ•è·å˜é‡çš„å€¼ï¼›åä¹‹ï¼Œå°±æ•è·å˜é‡çš„åœ°å€ã€‚ åœ¨å‡½æ•°xä¸­ï¼Œå…ˆç»™yèµ‹åˆå€¼ï¼Œreturnåˆå°†æ–°çš„è¿”å›å€¼å†™åˆ°äº†yï¼Œæ‰€ä»¥é—­åŒ…å¯¹è±¡è¿™é‡Œæ•è·çš„æ˜¯å˜é‡çš„åœ°å€ã€‚ ä½†æ˜¯å½“yçš„åœ°å€è¢«æ•è·äº†ï¼Œå½“xæ‰§è¡Œç»“æŸï¼Œmainå‡½æ•°è°ƒç”¨è¿”å›çš„yæ—¶ï¼Œè¿™é‡Œçš„æ ˆå¸§å°±ä¸å†ä¸ºè°ƒç”¨xæœåŠ¡äº†ï¼Œæ‰€ä»¥è¢«æ•è·çš„å˜é‡éœ€è¦é€ƒé€¸åˆ°å †ä¸Šï¼Œè¿”å›å€¼è¿™é‡Œå°±è¦å­˜å‚¨yåœ¨å †ä¸Šçš„åœ°å€ï¼Œä½†æ˜¯ï¼Œè¿™æ ·å°±æ”¹å˜äº†è¿”å›å€¼çš„ç±»å‹ï¼Œæ‰€ä»¥è®©yé€ƒé€¸åˆ°å †ä¸Šæ˜¯è¡Œä¸é€šçš„ã€‚ é‚£ä¹ˆï¼Œç¼–è¯‘å™¨ä¼šæ€æ ·å¤„ç†è¿”å›å€¼çš„åœ°å€è¢«æ•è·çš„æƒ…å†µå‘¢ï¼Ÿ å®é™…ä¸Šï¼Œç¼–è¯‘å™¨ä¼šåœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªyçš„å‰¯æœ¬ï¼Œè®°ä¸ºy'ï¼ŒåŒæ—¶ä¸ºxç”Ÿæˆä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå­˜å‚¨y'åœ¨å †ä¸Šçš„åœ°å€ï¼Œè®°ä¸ºpy'ï¼Œç„¶ååœ¨å‡½æ•°xå’Œè¿”å›çš„é—­åŒ…å¯¹è±¡ä¸­éƒ½ä½¿ç”¨å‰¯æœ¬y'ï¼Œè¿™é‡Œæ•è·çš„æ˜¯y'çš„åœ°å€ï¼Œåªåœ¨xè¿”å›å‰å°†y'çš„å€¼æ‹·è´åˆ°è¿”å›å€¼ç©ºé—´ï¼Œè¿™æ ·yå’Œy'éƒ½æŒ‡å‘å †ä¸Šçš„åŒä¸€ä¸ªé—­åŒ…å¯¹è±¡ã€‚è€Œåœ¨è°ƒç”¨xçš„æ ˆå¸§é”€æ¯åï¼Œè¿™ä¸ªé—­åŒ…å¯¹è±¡ä¾ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨å…¶æ•è·çš„å˜é‡ã€‚ å½“è¿”å›å€¼yè¢«è°ƒç”¨ï¼Œæ‰¾åˆ°è¿™é‡Œçš„é—­åŒ…å‡½æ•°ï¼Œè¾“å‡ºç¬¬ä¸€ä¸ªå­—æ¯zï¼Œç„¶åé€šè¿‡æ•è·åˆ—è¡¨æ‰¾åˆ°y'ï¼Œè°ƒç”¨y'æŒ‡å‘çš„å‡½æ•°-è¿˜æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œå› æ­¤ä¼šä¸åœè¾“å‡ºzã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:8:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.4 GC é—®ï¼šè‡ªåŠ¨åƒåœ¾å›æ”¶æ€ä¹ˆåŒºåˆ†å“ªäº›æ•°æ®æ˜¯åƒåœ¾å‘¢ï¼Ÿ å¯ä»¥ç¡®å®šï¼Œç¨‹åºä¸­ç”¨å¾—åˆ°çš„æ•°æ®ï¼Œä¸€å®šæ˜¯ä»æ ˆã€æ•°æ®æ®µè¿™äº›æ ¹èŠ‚ç‚¹è¿½è¸ªå¾—åˆ°çš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»è¿™äº›æ ¹èŠ‚ç‚¹è¿½è¸ªä¸åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æ²¡ç”¨çš„æ•°æ®ï¼Œä¸€å®šæ˜¯åƒåœ¾ã€‚å› æ­¤ï¼Œç›®å‰ä¸»æµçš„è‡ªåŠ¨åƒåœ¾å›æ”¶ç®—æ³•éƒ½æ˜¯ä½¿ç”¨**â€œå¯è¾¾æ€§â€è¿‘ä¼¼ç­‰ä»·â€œå­˜æ´»æ€§â€**çš„ã€‚ ==æ ‡è®°-æ¸…æ‰«ç®—æ³•== æ ‡è®°æ¸…é™¤ï¼ˆMark-Sweepï¼‰ç®—æ³•æ˜¯æœ€å¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ ‡è®°æ¸…é™¤æ”¶é›†å™¨æ˜¯è·Ÿè¸ªå¼åƒåœ¾æ”¶é›†å™¨ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†æˆ**æ ‡è®°ï¼ˆMarkï¼‰å’Œæ¸…é™¤ï¼ˆSweepï¼‰**ä¸¤ä¸ªé˜¶æ®µï¼š æ ‡è®°é˜¶æ®µ â€” ä»æ ¹å¯¹è±¡å‡ºå‘æŸ¥æ‰¾å¹¶æ ‡è®°å †ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼› æ¸…é™¤é˜¶æ®µ â€” éå†å †ä¸­çš„å…¨éƒ¨å¯¹è±¡ï¼Œå›æ”¶æœªè¢«æ ‡è®°çš„åƒåœ¾å¯¹è±¡å¹¶å°†å›æ”¶çš„å†…å­˜åŠ å…¥ç©ºé—²é“¾è¡¨ã€‚ ==ä¸‰è‰²æŠ½è±¡== ä¸‰è‰²æŠ½è±¡å¯ä»¥æ¸…æ™°çš„å±•ç°è¿½è¸ªå¼å›æ”¶ä¸­å¯¹è±¡çŠ¶æ€çš„å˜åŒ–è¿‡ç¨‹ã€‚ åƒåœ¾å›æ”¶å¼€å§‹æ—¶ï¼Œæ‰€æœ‰æ•°æ®å‡ä¸ºç™½è‰²ï¼› ç„¶åæŠŠç›´æ¥è¿½è¸ªåˆ°çš„rootèŠ‚ç‚¹éƒ½æ ‡è®°ä¸ºç°è‰²ï¼šç°è‰²ä»£è¡¨åŸºäºå½“å‰èŠ‚ç‚¹å±•å¼€çš„è¿½è¸ªè¿˜æœªå®Œæˆï¼› å½“åŸºäºæŸä¸ªèŠ‚ç‚¹çš„è¿½è¸ªä»»åŠ¡å®Œæˆåï¼Œä¾¿ä¼šæŠŠè¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºé»‘è‰²ï¼šè¡¨ç¤ºå®ƒæ˜¯å­˜æ´»æ•°æ®ï¼Œè€Œä¸”æ— éœ€åŸºäºå®ƒå†æ¬¡è¿›è¡Œè¿½è¸ªäº†ã€‚ åŸºäºé»‘è‰²èŠ‚ç‚¹æ‰¾åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«æ ‡è®°ä¸ºç°è‰²ï¼Œè¡¨ç¤ºè¿˜è¦åŸºäºå®ƒä»¬è¿›ä¸€æ­¥å¼€å§‹è¿½è¸ªã€‚ å½“æ²¡æœ‰ç°è‰²èŠ‚ç‚¹æ—¶ï¼Œå°±æ„å‘³ç€æ ‡è®°å·¥ä½œå¯ä»¥ç»“æŸäº†ã€‚æ­¤æ—¶ï¼Œæœ‰ç”¨æ•°æ®éƒ½ä¸ºé»‘è‰²ï¼Œåƒåœ¾éƒ½ä¸ºç™½è‰²ã€‚æ¥ä¸‹æ¥å›æ”¶è¿™äº›ç™½è‰²æ•°æ®å³å¯ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:9:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.5 Mutex é—®ï¼šRWMutex æ˜¯è¯»ä¼˜å…ˆè¿˜æ˜¯å†™ä¼˜å…ˆï¼Ÿè¯»ä¼˜å…ˆçš„è¯ï¼Œå¦‚æœä¸€ç›´æœ‰è¯»è¯·æ±‚ï¼Œé‚£ä¹ˆå†™è¯·æ±‚ä¼šé¥¥é¥¿å—ï¼Ÿâ­ğŸš© RWMutex æ˜¯ä¸€ä¸ªè¯»/å†™äº’æ–¥é”ï¼Œåœ¨æŸä¸€æ—¶åˆ»åªèƒ½ç”±ä»»æ„æ•°é‡çš„ reader æŒæœ‰ æˆ–è€… ä¸€ä¸ª writer æŒæœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¹ˆæ”¾è¡Œä»»æ„æ•°é‡çš„ readerï¼Œå¤šä¸ª reader å¯ä»¥å¹¶è¡Œè¯»ï¼›è¦ä¹ˆæ”¾è¡Œä¸€ä¸ª writerï¼Œå¤šä¸ª writer éœ€è¦ä¸²è¡Œå†™ã€‚ ä¸€æ—¦æ¶‰åŠåˆ°å¤šä¸ª reader å’Œ writer ï¼Œå°±éœ€è¦è€ƒè™‘ä¼˜å…ˆçº§é—®é¢˜ï¼Œæ˜¯ reader ä¼˜å…ˆè¿˜æ˜¯ writer ä¼˜å…ˆï¼š è¯»è€…ä¼˜å…ˆï¼ˆreaders-preferenceï¼‰ï¼šè¯»è€…ä¼˜å…ˆæ˜¯è¯»æ“ä½œä¼˜å…ˆäºå†™æ“ä½œï¼Œå³ä½¿å†™æ“ä½œæå‡ºç”³è¯·èµ„æºï¼Œä½†åªè¦è¿˜æœ‰è¯»è€…åœ¨è¯»å–æ“ä½œï¼Œå°±è¿˜å…è®¸å…¶ä»–è¯»è€…ç»§ç»­è¯»å–æ“ä½œï¼Œç›´åˆ°æ‰€æœ‰è¯»è€…ç»“æŸè¯»å–ï¼Œæ‰å¼€å§‹å†™ã€‚è¯»ä¼˜å…ˆå¯ä»¥æä¾›å¾ˆé«˜çš„å¹¶å‘å¤„ç†æ€§èƒ½ï¼Œä½†æ˜¯åœ¨é¢‘ç¹è¯»å–çš„ç³»ç»Ÿä¸­ï¼Œä¼šé•¿æ—¶é—´å†™é˜»å¡ï¼Œå¯¼è‡´å†™é¥¥é¥¿ã€‚ å†™è€…ä¼˜å…ˆï¼ˆwriters-preferenceï¼‰ï¼šå†™è€…ä¼˜å…ˆæ˜¯å†™æ“ä½œä¼˜å…ˆäºè¯»æ“ä½œï¼Œå¦‚æœæœ‰å†™è€…æå‡ºç”³è¯·èµ„æºï¼Œåœ¨ç”³è¯·ä¹‹å‰å·²ç»å¼€å§‹è¯»å–æ“ä½œçš„å¯ä»¥ç»§ç»­æ‰§è¡Œè¯»å–ï¼Œä½†æ˜¯å¦‚æœå†æœ‰è¯»è€…ç”³è¯·è¯»å–æ“ä½œï¼Œåˆ™ä¸èƒ½å¤Ÿè¯»å–ï¼Œåªæœ‰åœ¨æ‰€æœ‰çš„å†™è€…å†™å®Œä¹‹åæ‰å¯ä»¥è¯»å–ã€‚å†™è€…ä¼˜å…ˆè§£å†³äº†è¯»è€…ä¼˜å…ˆé€ æˆå†™é¥¥é¥¿çš„é—®é¢˜ã€‚ä½†æ˜¯è‹¥åœ¨é¢‘ç¹å†™å…¥çš„ç³»ç»Ÿä¸­ï¼Œä¼šé•¿æ—¶é—´è¯»é˜»å¡ï¼Œå¯¼è‡´è¯»é¥¥é¥¿ã€‚ RWMutex çš„æ•°æ®ç»“æ„ï¼š type RWMutex struct { w Mutex // ç”¨äºæ§åˆ¶å¤šä¸ªå†™é”ï¼Œè·å¾—å†™é”é¦–å…ˆè¦è·å–è¯¥é”ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå†™é”åœ¨è¿›è¡Œï¼Œé‚£ä¹ˆå†åˆ°æ¥çš„å†™é”å°†ä¼šé˜»å¡äºæ­¤ writerSem uint32 // å†™é˜»å¡ç­‰å¾…çš„ä¿¡å·é‡ï¼Œæœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾é”æ—¶ä¼šé‡Šæ”¾ä¿¡å·é‡ readerSem uint32 // è¯»é˜»å¡çš„åç¨‹ç­‰å¾…çš„ä¿¡å·é‡ï¼ŒæŒæœ‰å†™é”çš„åç¨‹é‡Šæ”¾é”åä¼šé‡Šæ”¾ä¿¡å·é‡ readerCount int32 // è®°å½•è¯»è€…ä¸ªæ•° readerWait int32 // è®°å½•å†™é˜»å¡æ—¶è¯»è€…ä¸ªæ•° } RWMutex è®¾è®¡é‡‡ç”¨å†™ä¼˜å…ˆæ–¹æ³•ã€‚ é—®é¢˜è¦ç‚¹ï¼š å†™æ“ä½œæ˜¯å¦‚ä½•é˜»æ­¢å†™æ“ä½œçš„ï¼Ÿ RWMutexåŒ…å«ä¸€ä¸ªäº’æ–¥é”(Mutex)ï¼Œå†™é”å®šå¿…é¡»è¦å…ˆè·å–è¯¥äº’æ–¥é”ã€‚ å†™æ“ä½œæ˜¯å¦‚ä½•é˜»æ­¢è¯»æ“ä½œçš„ï¼Ÿ RWMutex.readerCountæ˜¯ä¸ªæ•´å‹å€¼ï¼Œç”¨äºè¡¨ç¤ºè¯»è€…æ•°é‡ï¼Œä¸è€ƒè™‘å†™æ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è¯»é”å®šå°†è¯¥å€¼+1ï¼Œæ¯æ¬¡è§£é™¤è¯»é”å®šå°†è¯¥å€¼-1ï¼Œæ‰€ä»¥readerCountå–å€¼ä¸º[0, N]ï¼ŒNä¸ºè¯»è€…ä¸ªæ•°ï¼Œå®é™…ä¸Šæœ€å¤§å¯æ”¯æŒ2^30^ä¸ªå¹¶å‘è¯»è€…ã€‚ å½“å†™é”å®šè¿›è¡Œæ—¶ï¼Œä¼šå…ˆå°†readerCountå‡å»2^30^ï¼Œä»è€ŒreaderCountå˜æˆäº†è´Ÿå€¼ï¼Œæ­¤æ—¶å†æœ‰è¯»é”å®šåˆ°æ¥æ—¶æ£€æµ‹åˆ°readerCountä¸ºè´Ÿå€¼ï¼Œä¾¿çŸ¥é“æœ‰å†™æ“ä½œåœ¨è¿›è¡Œï¼Œåªå¥½é˜»å¡ç­‰å¾…ï¼ŒåŒæ—¶è¿˜ä¼šå¯¹readerCount+1ï¼Œè¿™æ ·ç­‰å¾…çš„è¯»æ“ä½œä¸ªæ•°å¹¶ä¸ä¼šä¸¢å¤±ï¼Œåªéœ€è¦å°†readerCountåŠ ä¸Š2^30^å³å¯è·å¾—ã€‚ æ‰€ä»¥ï¼Œå†™æ“ä½œå°†readerCountå˜æˆè´Ÿå€¼æ¥é˜»æ­¢è¯»æ“ä½œã€‚ è¯»æ“ä½œæ˜¯å¦‚ä½•é˜»æ­¢å†™æ“ä½œçš„ï¼Ÿ å†™æ“ä½œåˆ°æ¥æ—¶ï¼Œä¼šæŠŠRWMutex.readerCountå€¼æ‹·è´åˆ°RWMutex.readerWaitä¸­ï¼Œç”¨äºæ ‡è®°æ’åœ¨å†™æ“ä½œå‰é¢çš„è¯»è€…ä¸ªæ•°ã€‚å‰é¢çš„è¯»æ“ä½œç»“æŸåï¼Œé™¤äº†ä¼šé€’å‡RWMutex.readerCountï¼Œè¿˜ä¼šé€’å‡RWMutex.readerWaitå€¼ï¼Œå½“RWMutex.readerWaitå€¼å˜ä¸º0æ—¶å”¤é†’å†™æ“ä½œã€‚ ä¸ºä»€ä¹ˆå†™é”å®šä¸ä¼šè¢«é¥¿æ­»ï¼Ÿ å†™æ“ä½œè¦ç­‰å¾…è¯»æ“ä½œç»“æŸåæ‰å¯ä»¥è·å¾—é”ï¼Œå†™æ“ä½œç­‰å¾…æœŸé—´å¯èƒ½è¿˜æœ‰æ–°çš„è¯»æ“ä½œæŒç»­åˆ°æ¥ï¼Œå¦‚æœå†™æ“ä½œç­‰å¾…æ‰€æœ‰è¯»æ“ä½œç»“æŸï¼Œå¾ˆå¯èƒ½è¢«é¥¿æ­»ã€‚ç„¶è€Œï¼Œé€šè¿‡RWMutex.readerWaitå¯å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å†™æ“ä½œåˆ°æ¥æ—¶ï¼Œä¼šæŠŠRWMutex.readerCountå€¼æ‹·è´åˆ°RWMutex.readerWaitä¸­ï¼Œç”¨äºæ ‡è®°æ’åœ¨å†™æ“ä½œå‰é¢çš„è¯»è€…ä¸ªæ•°ã€‚ å‰é¢çš„è¯»æ“ä½œç»“æŸåï¼Œé™¤äº†ä¼šé€’å‡RWMutex.readerCountï¼Œè¿˜ä¼šé€’å‡RWMutex.readerWaitå€¼ï¼Œå½“RWMutex.readerWaitå€¼å˜ä¸º0æ—¶å”¤é†’å†™æ“ä½œã€‚ é—®ï¼šMutexçš„å·¥ä½œæ¨¡å¼ï¼Ÿæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ï¼Ÿ Mutex å…±æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚ æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªå°è¯•åŠ é”çš„goroutineä¼šå…ˆè‡ªæ—‹å‡ æ¬¡ï¼Œå°è¯•é€šè¿‡åŸå­æ“ä½œè·å¾—é”ã€‚è‹¥å‡ æ¬¡è‡ªæ—‹ä¹‹åä¸èƒ½è·å¾—é”ï¼Œå°±ä¼šé€šè¿‡ä¿¡å·é‡è¿›è¡Œæ’é˜Ÿç­‰å¾…ã€‚æ‰€æœ‰çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ’é˜Ÿï¼Œä½†æ˜¯å½“é”è¢«é‡Šæ”¾ï¼Œè¢«å”¤é†’çš„ç­‰å¾…è€…å¹¶ä¸ä¼šç›´æ¥è·å¾—é”ï¼Œå®ƒéœ€è¦å’Œå¤„äºè‡ªæ—‹é˜¶æ®µå°šæœªæ’é˜Ÿçš„goroutineè¿›è¡Œç«äº‰ã€‚ è¿™ç§æƒ…å†µåæ¥è€…æ›´æœ‰ä¼˜åŠ¿ï¼Œé¦–å…ˆæ˜¯å› ä¸ºå¤„äºè‡ªæ—‹çŠ¶æ€çš„goroutineå¯èƒ½æœ‰å¤šä¸ªï¼Œä¸”åæ¥è€…æ­£åœ¨CPUä¸Šè¿è¡Œï¼Œæ˜¾ç„¶æ¯”åˆšè¢«å”¤é†’çš„goroutineæœ‰ä¼˜åŠ¿ã€‚å¦‚æœè¢«å”¤é†’çš„goroutineæ²¡æœ‰è·å¾—é”ï¼Œå®ƒå°†å†æ¬¡è¿›å…¥æ’é˜Ÿé˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯ç›´æ¥åœ¨é˜Ÿå¤´ã€‚ å½“ä¸€ä¸ªgoroutineæœ¬æ¬¡ç­‰å¾…åŠ é”çš„æ—¶é—´è¶…è¿‡1msï¼Œå®ƒä¼šæŠŠå½“å‰Mutexåˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ï¼ŒMutexçš„æ‰€æœ‰æƒç›´æ¥è½¬è®©ç»™é˜Ÿé¦–goroutineï¼Œæ­¤æ—¶åæ¥è€…ä¹Ÿä¸å†è‡ªæ—‹ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥é˜Ÿåˆ—å°¾éƒ¨å¼€å§‹æ’é˜Ÿã€‚ å½“è·å¾—Mutexçš„goroutineæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ—¶ï¼Œæˆ–è€…å®ƒçš„ç­‰å¾…æ—¶é—´å°äº1msï¼Œå®ƒä¼šæŠŠMutexçš„çŠ¶æ€æ”¹å›æ­£å¸¸æ¨¡å¼ã€‚ æ­£å¸¸æ¨¡å¼éœ€è¦å¤§å®¶äº‰æŠ¢é”ï¼Œä»è€Œè·å¾—æ›´é«˜çš„ååé‡ï¼›è€Œé¥¥é¥¿æ¨¡å¼å¯¹é˜²æ­¢å‡ºç°å°¾ç«¯å»¶è¿Ÿç‰¹åˆ«é‡è¦ã€‚ é—®ï¼šä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè‡ªæ—‹ï¼Ÿ åŠ é”æ—¶ï¼Œå¦‚æœå½“å‰ Locked ä½ä¸º1ï¼Œåˆ™è¯´æ˜å½“å‰è¯¥é”ç”±å…¶ä»–åç¨‹æŒæœ‰ï¼Œå°è¯•åŠ é”çš„åç¨‹å¹¶ä¸æ˜¯é©¬ä¸Šè½¬å…¥é˜»å¡ï¼Œè€Œæ˜¯ä¼šæŒç»­æ¢æµ‹ Locked ä½æ˜¯å¦å˜ä¸º0ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ã€Œè‡ªæ—‹ã€ã€‚å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†30æ¬¡PAUSEã€‚ å¤šæ ¸åœºæ™¯ã€‚å› ä¸ºå•æ ¸åœºæ™¯æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä¸€ä¸ªå ç€CPUè¿›è¡Œè‡ªæ—‹ç­‰å¾…é”ï¼Œä¸€ä¸ªå ç€é”ã€‚è¿™æ— æ„ä¹‰ã€‚ gomaxprocs\u003e1ã€‚åŒä¸Šã€‚ è‡³å°‘æœ‰ä¸€ä¸ªå…¶ä»–çš„pæ­£åœ¨running \u0026\u0026 å½“å‰pçš„æœ¬åœ°runqé˜Ÿåˆ—ä¸ºç©ºã€‚æ¯”èµ·è°ƒåº¦è¿™ä¸ªgoroutineè¿›è¡Œè‡ªæ—‹ï¼Œä¸å¦‚è°ƒåº¦åˆ«çš„goroutineã€‚ è‡ªæ—‹ä¸Šé™ä¸º4ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡è‡ªæ—‹éƒ½ä¼šé‡æ–°åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»§ç»­è‡ªæ—‹ã€‚å¦‚æœé”è¢«é‡Šæ”¾äº†ï¼Œæˆ–è€…é”è¿›å…¥äº†é¥¥é¥¿æ¨¡å¼ï¼Œæˆ–è€…å·²ç»è‡ªæ—‹äº†4æ¬¡ï¼Œéƒ½ä¼šç»“æŸè‡ªæ—‹ã€‚ é—®ï¼šä¸ºä»€ä¹ˆè‡ªæ—‹æ¬¡æ•°æœ‰ä¸Šé™ï¼Ÿ è‡ªæ—‹æ˜¯ä¸ºäº†é¿å…é¢‘ç¹è·å¾—é”å¤±è´¥å¯¼è‡´çš„åç¨‹åˆ‡æ¢ï¼Œè¿™æ ·å¼€é”€å¾ˆå¤§ã€‚è‹¥é”çš„æŒæœ‰æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹å‡ æ¬¡å°±èƒ½è·å¾—ï¼Œè¿™æ ·å°±èƒ½å‡å°‘åˆ‡æ¢ï¼Œä½†å¦‚æœé”çš„æŒæœ‰æ—¶é—´å¾ˆé•¿ï¼Œé‚£å°±ä¼šæ— æ„ä¹‰çš„è‡ªæ—‹ï¼Œåå€’æµªè´¹äº†CPUèµ„æºï¼Œæ‰€ä»¥é€šå¸¸é™åˆ¶è‡ªæ—‹æ¬¡æ•°ï¼Œè‡ªæ—‹æ¬¡æ•°å†…æ— æ³•è·å¾—é”å°±è®©å‡ºCPUï¼Œä»¥å…é•¿æ—¶é—´æ— æ„ä¹‰çš„ç­‰å¾…ã€‚ é—®ï¼šåç¨‹æ˜¯å¦‚ä½•è¿›è¡Œæ’é˜Ÿçš„å‘¢ï¼Ÿ é€šè¿‡semaå­—æ®µã€‚runtimeå†…éƒ¨ä¼šé€šè¿‡ä¸€ä¸ªå¤§å°ä¸º251çš„sematableæ¥ç®¡ç†æ‰€æœ‰semaphoreï¼Œè¿™ä¸ªsematableå­˜å‚¨çš„æ˜¯251è¯¾å¹³è¡¡æ ‘çš„æ ¹ï¼Œå¹³è¡¡æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªsudogç±»å‹çš„å¯¹è±¡ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªä¿¡å·é‡æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªè®°å½•ä¿¡å·é‡æ•°å€¼çš„å˜é‡ï¼Œæ ¹æ®å®ƒçš„åœ°å€è¿›è¡Œè®¡ç®—ï¼Œæ˜ å°„åˆ°sematableä¸­çš„ä¸€é¢—å¹³è¡¡æ ‘ä¸Šï¼Œæ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹å°±æ‰¾åˆ°äº†è¯¥ä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œè¯¥ä¿¡å·é‡çš„åç¨‹å°±åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­è¿›è¡Œç­‰å¾…å”¤é†’ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:10:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.6 æ–¹æ³•é›† é—®ï¼šä¸ºä»€ä¹ˆè¦é™åˆ¶ T å’Œ *T ä¸èƒ½å£°æ˜åŒåæ–¹æ³•ï¼Ÿ é¦–å…ˆï¼ŒTå’Œ*Tæ˜¯ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æœ‰ç€è‡ªå·±çš„ç±»å‹å…ƒæ•°æ®ï¼Œè€Œæ ¹æ®è‡ªå®šä¹‰ç±»å‹çš„ç±»å‹å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ°è¯¥ç±»å‹å…³è”çš„æ–¹æ³•åˆ—è¡¨ã€‚ å¯ä»¥ç¡®å®šçš„æ˜¯ï¼ŒTçš„æ–¹æ³•é›†é‡Œï¼Œå…¨éƒ¨éƒ½æ˜¯æœ‰æ˜ç¡®å®šä¹‰çš„æ¥æ”¶è€…ä¸ºTç±»å‹çš„æ–¹æ³•ï¼›è€Œ*Tçš„æ–¹æ³•é›†é‡Œï¼Œé™¤äº†æœ‰æ˜ç¡®å®šä¹‰çš„æ¥æ”¶è€…ä¸º*Tçš„æ–¹æ³•ä»¥å¤–ï¼Œ**è¿˜ä¼šæœ‰ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸€äº›\"åŒ…è£…æ–¹æ³•â€ï¼š**è¿™äº›åŒ…è£…æ–¹æ³•æ˜¯å¯¹æ¥æ”¶è€…ä¸ºTç±»å‹çš„åŒåæ–¹æ³•çš„\"åŒ…è£…â€ã€‚ å¦‚æœç»™Tå’Œ*Tå®šä¹‰äº†åŒåæ–¹æ³•ï¼Œå°±æœ‰å¯èƒ½å’Œç¼–è¯‘å™¨ç”Ÿæˆçš„åŒ…è£…æ–¹æ³•å‘ç”Ÿå†²çªï¼Œæ‰€ä»¥ Go å¹²è„†ä¸å…è®¸ä¸ºTå’Œ*Tå®šä¹‰åŒåæ–¹æ³•ã€‚ é—®ï¼šä¸ºä»€ä¹ˆç¼–è¯‘å™¨è¦ä¸º *T ç”Ÿæˆ T çš„åŒåæ–¹æ³•ï¼Ÿ è¿™é‡Œé¦–å…ˆè¦æ˜ç¡®ä¸€ç‚¹ï¼šé€šè¿‡*Tç±»å‹çš„å˜é‡ç›´æ¥è°ƒç”¨Tç±»å‹æ¥æ”¶è€…çš„æ–¹æ³•åªæ˜¯ä¸€ç§è¯­æ³•ç³–ã€‚ç»éªŒè¯ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨ç«¯è¿›è¡ŒæŒ‡é’ˆè§£å¼•ç”¨ï¼Œå¹¶ä¸ä¼šç”¨åˆ°è¿™é‡Œçš„åŒ…è£…æ–¹æ³•ã€‚ ==å®é™…ä¸Šï¼Œç¼–è¯‘å™¨ç”ŸæˆåŒ…è£…æ–¹æ³•ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒæ¥å£ã€‚== é—®ï¼šä¸ºä»€ä¹ˆæ˜¯ä¸ºäº†æ”¯æŒæ¥å£ï¼Ÿ éç©ºæ¥å£åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼šä¸€ä¸ªå’Œç±»å‹å…ƒæ•°æ®ç›¸å…³ï¼Œä¸€ä¸ªå’Œæ¥å£è£…è½½çš„æ•°æ®ç›¸å…³ã€‚è™½ç„¶æœ‰æ•°æ®æŒ‡é’ˆï¼Œä½†æ˜¯å¹¶ä¸èƒ½åƒè¯­æ³•ç³–é‚£æ ·ï¼Œå¯¹æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨æ¥è°ƒç”¨å€¼æ¥æ”¶è€…çš„æ–¹æ³•ã€‚è¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ åŸå› ï¼šæ–¹æ³•çš„æ¥æ”¶è€…æ˜¯æ–¹æ³•è°ƒç”¨æ—¶éšå«çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒGo ä¸­çš„å‡½æ•°å‚æ•°é€šè¿‡æ ˆè¿›è¡Œä¼ é€’ï¼Œå¦‚æœå‚æ•°æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå¹³å°ç¡®å®šäº†ï¼ŒæŒ‡é’ˆå¤§å°ä¹Ÿå°±ç¡®å®šäº†ã€‚ä½†å¦‚æœè¦è§£å¼•ç”¨ä¸ºå€¼ç±»å‹ï¼Œå°±å¿…é¡»æœ‰æ˜ç¡®çš„ç±»å‹ä¿¡æ¯ï¼Œç¼–è¯‘å™¨æ‰èƒ½çŸ¥é“è¿™ä¸ªå‚æ•°è¯¥åœ¨æ ˆä¸Šåˆ†é…å¤šå¤§çš„å†…å­˜ç©ºé—´ã€‚å¯¹äºæ¥å£æ¥è¯´ï¼Œç¼–è¯‘é˜¶æ®µå¹¶ä¸èƒ½ç¡®å®šè¯¥æ¥å£ä¼šè£…è½½çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿå°±ä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè§£å¼•ç”¨ã€‚æ‰€ä»¥é€‰æ‹©ä¸º*Tç”Ÿæˆä¸€å¥—Tçš„åŒ…è£…æ–¹æ³•ã€‚ åœ¨é“¾æ¥é˜¶æ®µï¼Œä¸ä¼šç”¨åˆ°çš„æ–¹æ³•ä¼šè¢«å¿½ç•¥ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:11:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.7 æŠ¢å å¼è°ƒåº¦ é—®ï¼šå¦‚ä½•è¿›è¡ŒæŠ¢å å¼è°ƒåº¦ï¼Ÿ Go 1.14 ä¹‹å‰ï¼Œæ˜¯å€ŸåŠ©äºæ ˆå¢é•¿æ£€æµ‹æ¥å®ç°æŠ¢å å¼è°ƒåº¦çš„ï¼Œè‹¥goroutineä¸­æ²¡æœ‰å¯¼è‡´æ ˆå¢é•¿çš„ä»£ç ï¼Œå°±ä¸ä¼šè¢«æŠ¢å ï¼Œæ‰€ä»¥è¿™ä¸ç®—çœŸæ­£çš„æŠ¢å å¼è°ƒåº¦ã€‚ ä»¥GCä¸¾ä¾‹ï¼ŒSTWé˜¶æ®µéœ€è¦æŠ¢å æ‰€æœ‰çš„Pï¼Œä½†ä¸æ˜¯è¯´æŠ¢å å°±èƒ½æŠ¢å çš„ï¼Œä¼šå…ˆè®°å½•è¦ç­‰å¾…å¤šå°‘ä¸ªPï¼Œå½“è¿™ä¸ªå€¼å‡ä¸º0ï¼Œç›®çš„å°±è¾¾åˆ°äº†ã€‚ å¯¹äºå½“å‰Pã€ä»¥åŠé™·å…¥ç³»ç»Ÿè°ƒç”¨çš„P(_Psyscall)ã€è¿˜æœ‰ç©ºé—²çŠ¶æ€çš„Pï¼Œç›´æ¥å°†å…¶è®¾ç½®ä¸º_Pgcstopå³å¯ï¼› å¯¹äºè¿˜æœ‰Gåœ¨è¿è¡Œçš„Pï¼Œåˆ™ä¼šå°†å¯¹åº”çš„g.stackguard0è®¾ç½®ä¸ºä¸€ä¸ªç‰¹æ®Šæ ‡è¯†(runtime.stackPreempt)ï¼Œå‘Šè¯‰å®ƒGCæ­£åœ¨ç­‰å¾…å®ƒè®©å‡ºã€‚æ­¤å¤–ï¼Œè¿˜ä¼šè®¾ç½®ä¸€ä¸ªgcwaitingæ ‡è¯†(è®¾ç½®gcwaiting=1)ï¼Œæ¥ä¸‹æ¥å°±é€šè¿‡è¿™ä¸¤ä¸ªæ ‡è¯†ç¬¦çš„é…åˆï¼Œæ¥å®ç°è¿è¡Œä¸­çš„Pçš„æŠ¢å ã€‚ goroutineåˆ›å»ºä¹‹åˆï¼Œæ ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸ºäº†é˜²æ­¢å‡ºç°æ ˆæº¢å‡ºçš„æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šåœ¨æœ‰æ˜æ˜¾æ ˆæ¶ˆè€—çš„å‡½æ•°å¤´éƒ¨æ’å…¥ä¸€äº›æ£€æµ‹ä»£ç ï¼Œé€šè¿‡g.stackguard0æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ ˆå¢é•¿ï¼šå¦‚æœg.stackguard0è¢«è®¾ç½®ä¸ºç‰¹æ®Šæ ‡è¯†runtime.stackPreemptï¼Œä¾¿ä¸ä¼šæ‰§è¡Œæ ˆå¢é•¿ï¼Œè€Œæ˜¯å»æ‰§è¡Œä¸€æ¬¡è°ƒåº¦(schedule())ï¼›åœ¨schedule()è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œä¼šæ£€æµ‹gcwaitingæ ‡è¯†ï¼Œè‹¥å‘ç°GCåœ¨ç­‰å¾…æ‰§è¡Œï¼Œä¾¿ä¼šè®©å‡ºå½“å‰Pï¼Œå°†å…¶ç½®ä¸º_PgcstopçŠ¶æ€ã€‚ ä¾èµ–æ ˆå¢é•¿æ£€æµ‹ä»£ç çš„æŠ¢å æ–¹å¼ï¼Œé‡åˆ°æ²¡æœ‰å‡½æ•°è°ƒç”¨çš„æƒ…å†µå°±ä¼šå‡ºç°é—®é¢˜ã€‚ Go 1.14 ä¹‹åï¼Œpreemptoneå‡½æ•°ä¼šåˆ¤æ–­å½“å‰ç¡¬ä»¶ç¯å¢ƒæ˜¯å¦æ”¯æŒå¼‚æ­¥æŠ¢å ï¼Œè¿˜ä¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…è®¸å¼€å¯å¼‚æ­¥æŠ¢å ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å…è®¸çš„ã€‚å¦‚æœè¿™ä¸¤æ¡éªŒè¯éƒ½é€šè¿‡äº†ï¼Œå°±å°†p.preemptå­—æ®µç½®ä¸ºtrueï¼Œå®é™…çš„æŠ¢å æ“ä½œä¼šäº¤ç”±preemptMå‡½æ•°æ¥å®Œæˆã€‚preemptMå‡½æ•°ä¼šè°ƒç”¨signalMå‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨æ“ä½œç³»ç»Ÿä¸­ä¿¡å·ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æŒ‡å®šä¿¡å·å‘é€ç»™ç›®æ ‡çº¿ç¨‹ã€‚ çº¿ç¨‹æ¥æ”¶åˆ°ä¿¡å·åï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ä¿¡å·å¤„ç†å‡½æ•°sighandleræ¥å¤„ç†ï¼Œsighandleråœ¨ç¡®å®šä¿¡å·ä¸ºsigPreempt(æŠ¢å ä¿¡å·)ä»¥åï¼Œå®ƒä¼šé¦–å…ˆåˆ¤æ–­runtimeæ˜¯å¦è¦å¯¹æŒ‡å®šçš„Gè¿›è¡Œå¼‚æ­¥æŠ¢å ï¼Œé€šè¿‡ä»€ä¹ˆæ¥åˆ¤æ–­å‘¢ï¼Ÿ æŒ‡å®šçš„Gä¸å…¶å¯¹åº”Pçš„preemptå­—æ®µéƒ½è¦ä¸ºtrueï¼Œè€Œä¸”æŒ‡å®šçš„Gè¿˜è¦å¤„åœ¨_GrunningçŠ¶æ€ï¼› è¿˜è¦ç¡®è®¤åœ¨å½“å‰ä½ç½®æ‰“æ–­Gå¹¶æ‰§è¡ŒæŠ¢å æ˜¯å®‰å…¨çš„ æŒ‡å®šçš„Gå¯ä»¥æŒ‚èµ·å¹¶å®‰å…¨çš„æ‰«æå®ƒçš„æ ˆå’Œå¯„å­˜å™¨ï¼Œå¹¶ä¸”å½“å‰è¢«æ‰“æ–­çš„ä½ç½®å¹¶æ²¡æœ‰æ‰“æ–­å†™å±éšœï¼› æŒ‡å®šçš„Gè¿˜æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ³¨å…¥ä¸€ä¸ªå¼‚æ­¥æŠ¢å å‡½æ•°è°ƒç”¨(asyncPreempt)ï¼› è¿™é‡Œå¯ä»¥å®‰å…¨çš„å’Œruntimeè¿›è¡Œäº¤äº’ï¼Œä¸»è¦å°±æ˜¯ç¡®å®šå½“å‰å¹¶æ²¡æœ‰æŒæœ‰runtimeç›¸å…³çš„é”ï¼Œç»§è€Œä¸ä¼šåœ¨åç»­å°è¯•è·å¾—é”æ—¶å‘ç”Ÿæ­»é”ã€‚ ç¡®è®¤äº†è¦æŠ¢å è¿™ä¸ªGï¼Œå¹¶ä¸”æ­¤æ—¶æŠ¢å æ˜¯å®‰å…¨çš„ä»¥åï¼Œå°±å¯ä»¥æ”¾å¿ƒçš„é€šè¿‡pushCallå‘Gä¸­æ³¨å…¥å¼‚æ­¥æŠ¢å å‡½æ•°è°ƒç”¨äº†ï¼Œè¢«æ³¨å…¥çš„å¼‚æ­¥æŠ¢å å‡½æ•°(asyncPreempt)æœ€ç»ˆä¼šå»æ‰§è¡Œschedule()ï¼Œåˆ°è¿™é‡Œï¼Œå¼‚æ­¥æŠ¢å å°±å®Œæˆäº†ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:12:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.8 Channel é—®ï¼šchannel æ˜¯å¦æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Ÿ æ˜¯æ»´ é—®ï¼šæ€ä¹ˆé€šè¿‡ channel å®ç°åç¨‹é—´çš„é€šä¿¡ï¼Ÿ é—®ï¼šå‘å·²å…³é—­çš„ channel å†™ ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿä»å·²å…³é—­çš„ channel è¯» ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿâ­ func testClose() { intChan := make(chan int, 3) intChan \u003c- 2 // 1. å…³é—­ä¸€ä¸ªchannel close(intChan) // 2. å‘å…³é—­çš„channelä¸­å†™å…¥æ•°æ® //intChan \u003c- 3 // ä¼šæŠ¥é”™ panic: send on closed channel // 3. ä»å…³é—­çš„channelè¯»å–æ•°æ® num, ok := \u003c-intChan fmt.Println(num, ok) // 2 true num, ok = \u003c-intChan fmt.Println(num, ok) // 0 false } é—®ï¼šå¦‚ä½•ä¼˜é›…å…³é—­ä¸€ä¸ª Channelï¼Ÿâ­â­ å…ˆè¯´è¯´ä¸ºå•¥Channelå…³é—­è¿™ä¹ˆéº»çƒ¦ï¼š ä¸èƒ½æ— è„‘å…³é—­ï¼Œå¦‚æœä¸€ä¸ªchannelå·²ç»å…³é—­ï¼Œé‡å¤å…³é—­channelä¼šå¯¼è‡´panic å¾€ä¸€ä¸ªå…³é—­çš„channelå†™æ•°æ®ï¼Œä¹Ÿä¼šå¯¼è‡´panic **channelçš„å…³é—­åŸåˆ™ï¼š**â­ ä¸è¦åœ¨æ¶ˆè´¹è€…ç«¯å…³é—­channel ä¸è¦åœ¨æœ‰å¤šä¸ªå¹¶è¡Œçš„ç”Ÿäº§è€…æ—¶å…³é—­channel(åº”è¯¥åªåœ¨å”¯ä¸€æˆ–è€…æœ€åä¸€ä¸ªç”Ÿäº§è€…åç¨‹ä¸­å…³é—­channel) ==ä¼˜é›…çš„å…³é—­ï¼Œå…¶å®è¦åˆ†æƒ…å†µçš„ï¼š== å•ä¸ªç”Ÿäº§è€…ï¼Œå•ä¸ªæ¶ˆè´¹è€… â€‹ ç›´æ¥è®©ç”Ÿäº§è€…å…³é—­ã€‚ å•ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€… è¿™ç§æƒ…å†µå¾ˆç®€å•ï¼Œç›´æ¥è®©ç”Ÿäº§è€…å…³é—­å³å¯ã€‚ å¤šä¸ªç”Ÿäº§è€…ï¼Œå•ä¸ªæ¶ˆè´¹è€… â€‹ ä¸èƒ½åœ¨æ¶ˆè´¹ç«¯å…³é—­ï¼Œè¿™è¿èƒŒäº†channelå…³é—­åŸåˆ™ã€‚å¯ä»¥è®©æ¶ˆè´¹è€…æ ‡è®°ä¸€ä¸ªcloseä¿¡å·ï¼Œé€šçŸ¥ç”Ÿäº§è€…ä¸è¦ç»§ç»­å†™æ•°æ®ã€‚ å¤šä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€… â€‹ å¯ä»¥è®¾ç½®ä¸€ä¸ªä¸­é—´è°ƒè§£è€…è§’è‰²ã€‚ é¦–å…ˆè®¾ç½®ä¸€ä¸ªé€šé“toStopï¼Œå½“ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…è¾¾åˆ°æ¡ä»¶ï¼Œå°±å‘toStopå‘é€å…³é—­ä¿¡å·ï¼Œä¸­é—´è§’è‰²æ”¶åˆ°åå…³é—­stopCh(ä»…ç”¨ä½œé€šçŸ¥å‘é€è€…ä¸è¦å†å‘æ•°æ®é€šé“dataChå†™æ•°æ®äº†)ï¼Œç”Ÿäº§è€…æ”¶åˆ°stopChçš„å…³é—­ä¿¡å·åï¼Œä¸å†å‘dataChå†™æ•°æ®ã€‚ è¯·æ³¨æ„ï¼Œä¿¡å·é€šé“toStopçš„å®¹é‡å¿…é¡»è‡³å°‘ä¸º1ã€‚å¦‚æœå®ƒçš„å®¹é‡ä¸º0ï¼Œåˆ™åœ¨ä¸­é—´è°ƒè§£è€…è¿˜æœªå‡†å¤‡å¥½çš„æƒ…å†µä¸‹å°±å·²ç»æœ‰æŸä¸ªåç¨‹å‘toStopå‘é€ä¿¡å·æ—¶ï¼Œæ­¤ä¿¡å·æœ‰å¯èƒ½è¢«æŠ›å¼ƒã€‚ å‚è€ƒæ–‡ç« ï¼š https://gfw.go101.org/article/channel-closing.html é—®ï¼šchannel çš„å‘é€ã€æ¥æ”¶ã€å…³é—­ï¼Ÿ å‘é€ï¼š å‘é€æ“ä½œä¼šå¯¹ hchan åŠ é”ï¼› å½“ recvq ä¸­å­˜åœ¨ç­‰å¾…æ¥æ”¶çš„ goroutine æ—¶ï¼Œè‹¥æœ‰ goroutine è¦å‘é€æ•°æ®ï¼Œå°±ä¼šè°ƒç”¨ memmove å‡½æ•°ä»å‘é€ goroutine çš„æ ˆä¸­ï¼Œç›´æ¥æ‹·è´æ•°æ®åˆ°æ¥æ”¶ goroutine çš„æ ˆä¸­ï¼Œä¸ç»è¿‡ channel (æ— è®º channel æ˜¯å¦æœ‰ç¼“å†²åŒº)ï¼› å½“ recvq ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šåˆ¤æ–­ hchan.buf æ˜¯å¦å¯ç”¨ã€‚å¦‚æœå¯ç”¨ï¼Œåˆ™ä¼šå°†å‘é€çš„æ•°æ®æ‹·è´è‡³ hchan.buf ä¸­ï¼› å¦‚æœ hchan.buf å·²æ»¡ï¼Œé‚£ä¹ˆå°†å½“å‰å‘é€ goroutine ç½®äº sendq ä¸­æ’é˜Ÿï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸­æŒ‚èµ·ï¼› å‘å·²ç»å…³é—­çš„ channel å‘é€æ•°æ®ï¼Œä¼šå¼•å‘ panicï¼› å¯¹äºæ— ç¼“å†²çš„ channel æ¥è¯´ï¼Œå®ƒå¤©ç„¶å°±æ˜¯ hchan.buf å·²æ»¡çš„æƒ…å†µï¼Œå› ä¸ºå®ƒçš„ hchan.buf çš„å®¹é‡ä¸º 0ã€‚ æ¥æ”¶ï¼š æ¥æ”¶æ“ä½œä¼šå¯¹ hchan åŠ é”ã€‚ å½“ sendq ä¸­å­˜åœ¨ç­‰å¾…å‘é€çš„ goroutine æ—¶ï¼Œæ„å‘³ç€æ­¤æ—¶çš„ hchan.buf å·²æ»¡ï¼ˆæ— ç¼“å­˜çš„å¤©ç„¶å·²æ»¡ï¼‰ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š å¦‚æœæ˜¯æœ‰ç¼“å­˜çš„ hchanï¼Œé‚£ä¹ˆå…ˆå°†ç¼“å†²åŒºçš„æ•°æ®æ‹·è´ç»™æ¥æ”¶ goroutineï¼Œå†å°† sendq çš„é˜Ÿå¤´ sudog å‡ºé˜Ÿï¼Œå°†å‡ºé˜Ÿçš„ sudog ä¸Šçš„å…ƒç´ æ‹·è´è‡³ hchan çš„ç¼“å­˜åŒºã€‚ å¦‚æœæ˜¯æ— ç¼“å­˜çš„ hchanï¼Œé‚£ä¹ˆç›´æ¥å°†å‡ºé˜Ÿçš„ sudog ä¸Šçš„å…ƒç´ æ‹·è´ç»™æ¥æ”¶ goroutineã€‚ä¸¤ç§æƒ…å†µçš„æœ€åéƒ½ä¼šå”¤é†’å‡ºé˜Ÿçš„ sudog ä¸Šçš„å‘é€ goroutineã€‚ å½“ sendq å‘é€é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šåˆ¤æ–­ hchan.buf æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœå¯ç”¨ï¼Œåˆ™ä¼šå°† hchan.buf çš„æ•°æ®æ‹·è´ç»™æ¥æ”¶ goroutineã€‚ å¦‚æœ hchan.buf ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå°†å½“å‰æ¥æ”¶ goroutine ç½®äº recvq ä¸­æ’é˜Ÿï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸­æŒ‚èµ·ã€‚ ä¸å‘é€ä¸åŒçš„æ˜¯ï¼Œå½“ channel å…³é—­æ—¶ï¼Œgoroutine è¿˜èƒ½ä» channel ä¸­è·å–æ•°æ®ã€‚å¦‚æœ recvq ç­‰å¾…åˆ—è¡¨ä¸­æœ‰ goroutinesï¼Œé‚£ä¹ˆå®ƒä»¬éƒ½ä¼šè¢«å”¤é†’æ¥æ”¶æ•°æ®ã€‚å¦‚æœ hchan.buf ä¸­è¿˜æœ‰æœªæ¥æ”¶çš„æ•°æ®ï¼Œé‚£ä¹ˆ goroutine ä¼šæ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¦åˆ™ goroutine ä¼šè·å–åˆ°å…ƒç´ çš„é›¶å€¼ã€‚ å…³é—­ï¼š å¦‚æœå…³é—­å·²å…³é—­çš„ channel ä¼šå¼•å‘ paincã€‚ å…³é—­ channel åï¼Œå¦‚æœæœ‰é˜»å¡çš„è¯»å–æˆ–å‘é€ goroutines å°†ä¼šè¢«å”¤é†’ï¼š è¯»å– goroutine ä¼šè·å–åˆ° hchan çš„å·²æ¥æ”¶å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·å–åˆ°å…ƒç´ é›¶å€¼ï¼› å‘é€ goroutine çš„æ‰§è¡Œåˆ™ä¼šå¼•å‘ paincã€‚ é—®ï¼šchannel éå¾—å…³é—­å—ï¼Ÿâ­ğŸš© ä¸ç”¨ï¼Œchannel æ²¡æœ‰è¢«ä»»ä½•åç¨‹ç”¨åˆ°åæœ€ç»ˆä¼šè¢« GC å›æ”¶ã€‚ ä½†ï¼Œéœ€è¦åˆ†åˆ«è€ƒè™‘ä¸¤ç§æƒ…å†µï¼š channel çš„å‘é€æ¬¡æ•° == æ¥æ”¶æ¬¡æ•°ï¼š å‘é€è€… goroutine å’Œæ¥æ”¶è€… goroutine åˆ†åˆ«éƒ½ä¼šåœ¨å‘é€æˆ–æ¥æ”¶ç»“æŸæ—¶ç»“æŸå„è‡ªçš„ goroutine (ä¹Ÿå³æ˜¯channelä¸­æ²¡æœ‰é˜»å¡çš„goroutine)ï¼Œæ­¤æ—¶ï¼Œchannelç”±äºæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå°±ä¼šè¢«åƒåœ¾æ”¶é›†å™¨è‡ªåŠ¨å›æ”¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å…³é—­ channelï¼Œæ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚ channel çš„å‘é€æ¬¡æ•° != æ¥æ”¶æ¬¡æ•°ï¼š channel çš„å‘é€æ¬¡æ•°ä¸ç­‰äºæ¥æ”¶æ¬¡æ•°æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‘é€è€…æˆ–æ¥æ”¶è€…é˜»å¡åœ¨channelã€‚å› æ­¤channelç”±äºä¸€ç›´è¢«ä½¿ç”¨ï¼Œå¯¼è‡´æ— æ³•è¢«åƒåœ¾å›æ”¶ã€‚é˜»å¡çš„ goroutine å’Œæœªè¢«å›æ”¶çš„ channel éƒ½é€ æˆäº†å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ é—®ï¼šå¦‚ä½•åˆ¤æ–­channelå·²å…³é—­ï¼ŸğŸ¤”â“ é€šè¿‡ v, ok := \u003c-chanï¼Œè‹¥å·²å…³é—­ï¼Œok å°±æ˜¯ falseï¼› ä¼¼ä¹å¾—åˆ†æœ‰ç¼“å†²å’Œæ— ç¼“å†²ï¼š // 1. æœ‰ç¼“å†²æ—¶ï¼Œåªè¦ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œokå°±æ˜¯trueï¼Œå› æ­¤ä¸èƒ½ç”¨è¿™ç§æ–¹æ³•åˆ¤æ–­ func main() { ch := make(chan int, 2) ch \u003c- 1 close(ch) // æ­¤å¤„å·²å…³é—­ï¼Œä½†channelä¾ç„¶æœ‰æ•°æ®æœªè¯»å®Œ v1, ok1 := \u003c-ch // æ­¤æ—¶channelä¾ç„¶æœ‰æ•°æ®æœªè¯»å®Œ fmt.Println(v1, ok1) // 1 true v2, ok2 := \u003c-ch // æ­¤æ—¶channelæ²¡æ•°æ®å¯è¯» fmt.Println(v2, ok2) // 0 false } // 2. æ— ç¼“å†²æ—¶ï¼Œå¯ä»¥é…±ç´«åˆ¤æ–­ã€‚ func main() { ch := make(chan int) //ch \u003c- 1 close(ch) // æ­¤å¤„å·²å…³é—­ v1, ok1 := \u003c-ch fmt.Println(v1, ok1) // 0 false v2, ok2 := \u003c-ch // æ­¤æ—¶channelæ²¡æ•°æ®å¯è¯» fmt.Println(v2, ok2) // 0 false } é€šè¿‡ for rangeï¼Œä¼šè‡ªåŠ¨åˆ¤æ–­ channel æ˜¯å¦ç»“æŸï¼Œå¦‚æœç»“æŸåˆ™è‡ªåŠ¨é€€å‡º for å¾ªç¯ã€‚ åŒä¸Šï¼Œä¹Ÿå¾—åˆ†æœ‰æ— ç¼“å†²ã€‚ ä¼¼ä¹ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½åŠæ³•ï¼Ÿ é—®ï¼šChannel æœ‰å•¥åº”ç”¨ï¼Ÿ ç»ˆæ­¢ä¿¡å·é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œmain goroutineç­‰å¾…hello goroutineæ‰§è¡Œå®Œæ¯•ï¼› ä»»åŠ¡å®šæ—¶ã€‚ä¸timerç»“åˆï¼Œå®ç°è¶…æ—¶æ§åˆ¶ã€‚Etcdä¸­å¾ˆå¸¸è§ select { case \u003c-time.After(100 * time.Millisecond): case \u003c-s.stopc: return false } ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚ç”Ÿäº§è€…å‘Channelå†™æ•°æ®ï¼Œæ¶ˆè´¹è€…ä»Channelè¯»æ•°æ®ï¼› æ§åˆ¶å¹¶å‘æ•°ï¼› var limit = make(chan int, 3) func main() { // â€¦â€¦â€¦â€¦ for _, w := range work { go func() { limit \u003c- 1 w() \u003c-limit }() } // â€¦â€¦â€¦â€¦ } é—®ï¼šChannel å•¥æ—¶å€™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ æ³„æ¼çš„åŸå› æ˜¯ goroutine æ“ä½œ channel åï¼Œå¤„äºå‘é€æˆ–æ¥æ”¶é˜»å¡çŠ¶æ€ï¼Œè€Œ channel å¤„äºæ»¡æˆ–ç©ºçš„çŠ¶æ€ï¼Œä¸€ç›´å¾—ä¸åˆ°æ”¹å˜ã€‚ æ­¤æ—¶ goroutine ä¸€ç›´é˜»å¡ï¼Œå¾—ä¸åˆ°é‡Šæ”¾ï¼Œå°±é€ æˆäº†å†…å­˜æ³„éœ²ã€‚å…¶å®å¹¶ä¸æ˜¯channelæœ¬èº«çš„å†…å­˜æ³„æ¼ï¼Ÿ é—®ï¼šchannelçš„åº•å±‚æ˜¯æ€æ ·çš„ï¼Ÿ ç”¨makeåˆ›å»ºchanæ—¶ï¼Œå‡½æ•°æ ˆå¸§ä¸Šä¼šå­˜å‚¨chançš„æŒ‡é’ˆï¼ŒæŒ‡å‘å †ä¸Šçš„hchanç»“æ„ä½“ã€‚ å› ä¸ºchannelæ”¯æŒåç¨‹é—´å¹¶å‘è®¿é—®ï¼Œæ‰€ä»¥è¦æœ‰ä¸€æŠŠ**é”lock**æ¥ä¿æŠ¤æ•´ä¸ªæ•°æ®ç»“æ„ã€‚ å¯¹äºæœ‰ç¼“å†²æ¥è®²ï¼Œéœ€è¦çŸ¥é“ç¼“å†²åŒºåœ¨å“ªï¼Œå·²ç»å­˜å‚¨äº†å¤šå°‘ä¸ªå…ƒç´ ï¼Œæœ€å¤šå­˜å‚¨å¤šå°‘ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ å å¤šå¤§ç©ºé—´ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œç¼“å†²åŒºå°±æ˜¯ä¸ªæ•°ç»„bufã€elemsizeã€‚ å› ä¸º Go è¿è¡Œä¸­ï¼Œå†…å­˜å¤åˆ¶ã€åƒåœ¾å›æ”¶ç­‰æœºåˆ¶ä¾èµ–æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥hchanè¿˜è¦æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…ƒç´ ç±»å‹çš„ç±»å‹å…ƒæ•°æ®elemtypeã€‚ æ­¤å¤–ï¼Œchannelæ”¯æŒäº¤æ›¿çš„è¯»(æ¥æ”¶)å†™(å‘é€)ï¼Œéœ€è¦åˆ†åˆ«è®°å½•è¯»ã€å†™ä¸‹æ ‡çš„ä½ç½®recvxã€sendxã€‚ å½“è¯»å’Œå†™ä¸èƒ½ç«‹å³å®Œæˆæ—¶ï¼Œéœ€è¦èƒ½å¤Ÿè®©å½“å‰åç¨‹åœ¨channelä¸Šç­‰å¾…ï¼Œå¾…åˆ°æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè¦èƒ½å¤Ÿç«‹å³å”¤é†’ç­‰å¾…çš„åç¨‹ï¼Œæ‰€ä»¥è¦æœ‰ä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ†åˆ«é’ˆå¯¹è¯»(æ¥æ”¶)å’Œå†™(å‘é€)rec","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:13:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.9 å†…å­˜ é—®ï¼šå†…å­˜é€ƒé€¸ï¼Ÿâ­ğŸš© ç¼–è¯‘å™¨ä¼šæ ¹æ®å˜é‡æ˜¯å¦è¢«å¤–éƒ¨å¼•ç”¨æ¥å†³å®šæ˜¯å¦é€ƒé€¸ï¼š å¦‚æœå‡½æ•°å¤–éƒ¨æ²¡æœ‰å¼•ç”¨ï¼Œåˆ™ä¼˜å…ˆæ”¾åˆ°æ ˆä¸­ï¼› å¦‚æœå‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ï¼Œåˆ™å¿…å®šæ”¾åˆ°å †ä¸­ï¼› å¦‚æœæ ˆä¸Šæ”¾ä¸ä¸‹ï¼Œåˆ™å¿…å®šæ”¾åˆ°å †ä¸Šï¼› æ¡ˆä¾‹ï¼š **æŒ‡é’ˆé€ƒé€¸ï¼š**å‡½æ•°è¿”å›å€¼ä¸ºå±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œå‡½æ•°è™½ç„¶é€€å‡ºäº†ï¼Œä½†æ˜¯å› ä¸ºæŒ‡é’ˆçš„å­˜åœ¨ï¼ŒæŒ‡å‘çš„å†…å­˜ä¸èƒ½éšç€å‡½æ•°ç»“æŸè€Œå›æ”¶ï¼Œå› æ­¤åªèƒ½åˆ†é…åœ¨å †ä¸Šã€‚ **æ ˆç©ºé—´ä¸è¶³ï¼š**å½“æ ˆç©ºé—´è¶³å¤Ÿæ—¶ï¼Œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œä½†æ˜¯å½“å˜é‡è¿‡å¤§æ—¶ï¼Œå·²ç»å®Œå…¨è¶…è¿‡æ ˆç©ºé—´çš„å¤§å°æ—¶ï¼Œå°†ä¼šå‘ç”Ÿé€ƒé€¸åˆ°å †ä¸Šåˆ†é…å†…å­˜ã€‚å±€éƒ¨å˜é‡så ç”¨å†…å­˜è¿‡å¤§ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶åˆ†é…åˆ°å †ä¸Šï¼› **å˜é‡å¤§å°ä¸ç¡®å®šï¼š**ç¼–è¯‘æœŸé—´æ— æ³•ç¡®å®šsliceçš„é•¿åº¦ï¼Œè¿™ç§æƒ…å†µä¸ºäº†ä¿è¯å†…å­˜çš„å®‰å…¨ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šè§¦å‘é€ƒé€¸ï¼Œåœ¨å †ä¸Šè¿›è¡Œåˆ†é…å†…å­˜ï¼› **åŠ¨æ€ç±»å‹ï¼š**åŠ¨æ€ç±»å‹å°±æ˜¯ç¼–è¯‘æœŸé—´ä¸ç¡®å®šå‚æ•°çš„ç±»å‹ã€å‚æ•°çš„é•¿åº¦ä¹Ÿä¸ç¡®å®šçš„æƒ…å†µä¸‹å°±ä¼šå‘ç”Ÿé€ƒé€¸ï¼› **é—­åŒ…å¼•ç”¨å¯¹è±¡ï¼š**é—­åŒ…å‡½æ•°ä¸­å±€éƒ¨å˜é‡iåœ¨åç»­å‡½æ•°æ˜¯ç»§ç»­ä½¿ç”¨çš„ï¼Œç¼–è¯‘å™¨å°†å…¶åˆ†é…åˆ°å †ä¸Šï¼› åå°„ï¼šValueOfã€‚ é—®ï¼šmakeå’Œnewæœ‰å•¥åŒºåˆ«ï¼Ÿ **ä¸¤è€…çš„ä½œç”¨ç±»å‹ä¸åŒï¼š**newç»™intã€stringã€æ•°ç»„åˆ†é…å†…å­˜ï¼Œmakeç»™sliceã€mapã€channelåˆ†é…å†…å­˜ï¼› **ä¸¤è€…çš„è¿”å›å€¼ä¸åŒï¼š**newçš„è¿”å›å€¼ç±»å‹ä¸ºä¸€ä¸ªæŒ‡å‘æ–°åˆ†é…å¥½çš„å†…å­˜ç©ºé—´çš„ä¸€ä¸ªæŒ‡å®šç±»å‹æŒ‡é’ˆã€‚è€Œmakeçš„è¿”å›å€¼ç±»å‹ä¸ºå®ƒæœ¬èº«ã€‚ hash := make(map[int]bool, 10) // hash æ˜¯ä¸€ä¸ªæŒ‡å‘ runtime.hmap ç»“æ„ä½“çš„æŒ‡é’ˆ ch := make(chan int, 5) // ch æ˜¯ä¸€ä¸ªæŒ‡å‘ runtime.hchan ç»“æ„ä½“çš„æŒ‡é’ˆ newåˆ†é…çš„å†…å­˜ç©ºé—´ä¼šè¢«æ¸…é›¶ï¼Œmakeåˆ†é…ç©ºé—´ä¹‹åä¼šè¢«åˆå§‹åŒ–ã€‚ newåˆ†é…çš„å†…å­˜ç©ºé—´ä¸ä¸€å®šä¼šåœ¨å †ä¸Šåˆ†é…ï¼Œæ¯”å¦‚è¯´è¯¥æŒ‡é’ˆå°±åœ¨æœ¬å‡½æ•°å†…ä½¿ç”¨ã€‚ è‹¥ç”¨ps := new([]string)åˆå§‹åŒ–ï¼Œnew æ˜¯ä¸è´Ÿè´£åº•å±‚æ•°ç»„çš„åˆ†é…çš„ï¼Œä»…ä»…è¿”å›sliceçš„èµ·å§‹åœ°å€ï¼Œæ­¤æ—¶è¿™ä¸ªsliceè¿˜æ²¡æœ‰åº•å±‚æ•°ç»„ï¼Œå¦‚æœå¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œå°±ä¼šå‡ºé”™ã€‚ éœ€è¦é€šè¿‡Appendè¿›è¡Œåˆ†é…åº•å±‚æ•°ç»„ã€‚ é—®ï¼šä¸ºä»€ä¹ˆè¦å†…å­˜å¯¹é½ï¼Ÿ é¦–å…ˆï¼ŒCPU è®¿é—®å†…å­˜æ—¶ï¼Œå¹¶ä¸æ˜¯é€ä¸ªå­—èŠ‚è®¿é—®ï¼Œè€Œæ˜¯ä»¥å­—é•¿ï¼ˆword sizeï¼‰ä¸ºå•ä½è®¿é—®ã€‚æ¯”å¦‚ 32 ä½çš„ CPU ï¼Œå­—é•¿ä¸º 4 å­—èŠ‚ï¼Œé‚£ä¹ˆ CPU è®¿é—®å†…å­˜çš„å•ä½ä¹Ÿæ˜¯ 4 å­—èŠ‚ã€‚ æœ‰ä¸¤ä¸ªç›®çš„ï¼š å‡å°‘è®¿å­˜æ¬¡æ•°ï¼› ä¾¿äºåŸå­æ€§æ“ä½œã€‚ å‡å°‘ CPU è®¿é—®å†…å­˜çš„æ¬¡æ•°ï¼ŒåŠ å¤§ CPU è®¿é—®å†…å­˜çš„ååé‡ã€‚æ¯”å¦‚ï¼š å½“å†…å­˜å¯¹é½æ—¶ï¼Œè¯»å– b åªéœ€è¦è¯»å–ä¸€æ¬¡å†…å­˜ã€‚ éå†…å­˜å¯¹é½æ—¶ï¼Œè¯»å– b éœ€è¦ä¸¤æ¬¡è®¿å­˜([0, 3]ï¼Œ[4, 7]ï¼Œç„¶åæ‹¼æ¥å‡º b)ï¼š å†…å­˜å¯¹é½å¯¹å®ç°å˜é‡çš„åŸå­æ€§æ“ä½œä¹Ÿæ˜¯æœ‰å¥½å¤„çš„ï¼Œæ¯æ¬¡å†…å­˜è®¿é—®æ˜¯åŸå­çš„ï¼Œå¦‚æœå˜é‡çš„å¤§å°ä¸è¶…è¿‡å­—é•¿ï¼Œé‚£ä¹ˆå†…å­˜å¯¹é½åï¼Œå¯¹è¯¥å˜é‡çš„è®¿é—®å°±æ˜¯åŸå­çš„ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨å¹¶å‘åœºæ™¯ä¸‹è‡³å…³é‡è¦ã€‚ é—®ï¼šç»“æ„ä½“æ˜¯æ€ä¹ˆè¿›è¡Œå†…å­˜å¯¹é½çš„ï¼Ÿæˆå‘˜çš„é¡ºåºä¸åŒï¼Œç»“æ„ä½“çš„å¤§å°ä¼šä¸åŒå—ï¼Ÿ type demo1 struct { a int8 b int16 c int32 } type demo2 struct { a int8 c int32 b int16 } func main() { fmt.Println(unsafe.Sizeof(demo1{})) // 8 fmt.Println(unsafe.Sizeof(demo2{})) // 12 } ==ç»“æ„ä½“å†…å­˜å¯¹é½è§„åˆ™==ï¼š æ¯ä¸ªå­—æ®µæŒ‰ç…§è‡ªèº«çš„å¯¹é½å€æ•°æ¥ç¡®å®šåœ¨å†…å­˜ä¸­çš„åç§»é‡ï¼Œå¯¹é½å€æ•° = min(è‡ªèº«çš„é•¿åº¦ï¼Œæœºå™¨å­—é•¿)ï¼› æ’åˆ—å®Œæˆåï¼Œéœ€è¦å¯¹ç»“æ„ä½“æ•´ä½“å†è¿›è¡Œä¸€æ¬¡å†…å­˜å¯¹é½ã€‚ æˆå‘˜çš„é¡ºåºä¸åŒï¼Œç»“æ„ä½“çš„å¤§å°å¯èƒ½ä¸åŒï¼Œå› æ­¤ç»“æ„ä½“çš„å†…å­˜å¯¹é½æœ‰æŠ€å·§ã€‚ åˆ†æä¸Šé¢çš„ä»£ç ç¤ºä¾‹(æœºå™¨å­—é•¿ 32 ä½)ï¼Œé¦–å…ˆæ˜¯ demo1ï¼š a æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µï¼Œé»˜è®¤æ˜¯å·²ç»å¯¹é½çš„ï¼Œä»ç¬¬ 0 ä¸ªä½ç½®å¼€å§‹å æ® 1 å­—èŠ‚ã€‚ b æ˜¯ç¬¬äºŒä¸ªå­—æ®µï¼Œå¯¹é½å€æ•°ä¸º 2ï¼Œå› æ­¤ï¼Œå¿…é¡»ç©ºå‡º 1 ä¸ªå­—èŠ‚ï¼Œåç§»é‡æ‰æ˜¯ 2 çš„å€æ•°ï¼Œä»ç¬¬ 2 ä¸ªä½ç½®å¼€å§‹å æ® 2 å­—èŠ‚ã€‚ c æ˜¯ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå¯¹é½å€æ•°ä¸º 4ï¼Œæ­¤æ—¶ï¼Œå†…å­˜å·²ç»æ˜¯å¯¹é½çš„ï¼Œä»ç¬¬ 4 ä¸ªä½ç½®å¼€å§‹å æ® 4 å­—èŠ‚å³å¯ã€‚ å› æ­¤ demo1 çš„å†…å­˜å ç”¨ä¸º 8 å­—èŠ‚ã€‚ å…¶æ¬¡æ˜¯ demo2ï¼š a æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µï¼Œé»˜è®¤æ˜¯å·²ç»å¯¹é½çš„ï¼Œä»ç¬¬ 0 ä¸ªä½ç½®å¼€å§‹å æ® 1 å­—èŠ‚ã€‚ c æ˜¯ç¬¬äºŒä¸ªå­—æ®µï¼Œå¯¹é½å€æ•°ä¸º 4ï¼Œå› æ­¤ï¼Œå¿…é¡»ç©ºå‡º 3 ä¸ªå­—èŠ‚ï¼Œåç§»é‡æ‰æ˜¯ 4 çš„å€æ•°ï¼Œä»ç¬¬ 4 ä¸ªä½ç½®å¼€å§‹å æ® 4 å­—èŠ‚ã€‚ b æ˜¯ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå¯¹é½å€æ•°ä¸º 2ï¼Œä»ç¬¬ 8 ä¸ªä½ç½®å¼€å§‹å æ® 2 å­—èŠ‚ã€‚ demo2 çš„å¯¹é½å€æ•°ç”± c çš„å¯¹é½å€æ•°å†³å®šï¼Œä¹Ÿæ˜¯ 4ï¼Œå› æ­¤ï¼Œdemo2 çš„å†…å­˜å ç”¨ä¸º 12 å­—èŠ‚ã€‚ ==é¢å¤–çš„é—®é¢˜==ï¼šç©º struct{} çš„å¯¹é½ ç©º struct{} å¤§å°ä¸º 0ï¼Œä½œä¸ºå…¶ä»– struct çš„å­—æ®µæ—¶ï¼Œä¸€èˆ¬ä¸éœ€è¦å†…å­˜å¯¹é½ã€‚ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µé™¤å¤–ï¼šå³å½“ struct{} ä½œä¸ºç»“æ„ä½“æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦å†…å­˜å¯¹é½ã€‚å› ä¸ºå¦‚æœæœ‰æŒ‡é’ˆæŒ‡å‘è¯¥å­—æ®µï¼Œè¿”å›çš„åœ°å€å°†åœ¨ç»“æ„ä½“ä¹‹å¤–ï¼Œå¦‚æœæ­¤æŒ‡é’ˆä¸€ç›´å­˜æ´»ä¸é‡Šæ”¾å¯¹åº”çš„å†…å­˜ï¼Œå°±ä¼šæœ‰å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼ˆè¯¥å†…å­˜ä¸å› ç»“æ„ä½“é‡Šæ”¾è€Œé‡Šæ”¾ï¼‰ã€‚ å› æ­¤ï¼Œå½“ struct{} ä½œä¸ºå…¶ä»– struct æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦å¡«å……é¢å¤–çš„å†…å­˜ä¿è¯å®‰å…¨ã€‚æˆ‘ä»¬åšä¸ªè¯•éªŒï¼ŒéªŒè¯ä¸‹è¿™ç§æƒ…å†µã€‚ type demo3 struct { c int32 a struct{} } type demo4 struct { a struct{} c int32 } func main() { fmt.Println(unsafe.Sizeof(demo3{})) // 8 fmt.Println(unsafe.Sizeof(demo4{})) // 4 } å¯ä»¥çœ‹åˆ°ï¼Œdemo4{} çš„å¤§å°ä¸º 4 å­—èŠ‚ï¼Œä¸å­—æ®µ c å æ®ç©ºé—´ä¸€è‡´ï¼Œè€Œ demo3{} çš„å¤§å°ä¸º 8 å­—èŠ‚ï¼Œå³é¢å¤–å¡«å……äº† 4 å­—èŠ‚çš„ç©ºé—´ã€‚ å¦ï¼Œæ²¡æœ‰ä»»ä½•å­—æ®µçš„ç©º struct{} å’Œæ²¡æœ‰ä»»ä½•å…ƒç´ çš„ array å æ®çš„å†…å­˜ç©ºé—´å¤§å°ä¸º 0ï¼Œä¸åŒçš„å¤§å°ä¸º 0 çš„å˜é‡å¯èƒ½æŒ‡å‘åŒä¸€å—åœ°å€ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:14:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.10 æ•°æ®ç»“æ„ é—®ï¼šmap æ˜¯å¹¶å‘å®‰å…¨çš„å—ï¼Ÿé‚£æ€ä¹ˆè®©ä»–å¹¶å‘å®‰å…¨ï¼Ÿé‚£åŠ é”çš„ map å’Œ sync.map æœ‰å•¥åŒºåˆ«ï¼Ÿsync.map çš„é€‚ç”¨åœºæ™¯ï¼Ÿâ­ğŸš© æ™®é€šçš„mapä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œsync.mapæ˜¯å¹¶å‘å®‰å…¨çš„ã€‚ å¦‚ä½•è®©æ™®é€šçš„mapå¹¶å‘å®‰å…¨ï¼Œä¸€èˆ¬çš„æ€è·¯æœ‰ä¸¤ç§ï¼š åŠ é”ï¼Œæ“ä½œå‰å…ˆè·å–é”ï¼Œæ“ä½œå®Œé‡Šæ”¾ã€‚ç¼ºç‚¹æ˜¯ï¼šç²’åº¦å¤ªå¤§ï¼Œæ•ˆç‡ä¸é«˜ï¼› åˆ’åˆ†æˆå‡ ä¸ªå°çš„ mapï¼Œåªæ“ä½œç›¸åº”å°çš„ mapã€‚ç¼ºç‚¹æ˜¯ï¼šå®ç°å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚ å…ˆçœ‹çœ‹sync.mapï¼š type Map struct { mu Mutex // ä¿æŠ¤ dirty å’Œ read read atomic.Value // readOnlyï¼Œåªè¯»ï¼Œæ‰€ä»¥æ˜¯å¹¶å‘å®‰å…¨çš„ dirty map[interface{}]*entry // ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„åŸå§‹ map misses int // è®¡æ•°ä½œç”¨ã€‚æ¯æ¬¡ä»readä¸­è¯»å¤±è´¥ï¼Œåˆ™è®¡æ•°+1 } map+é” å’Œ sync.map çš„å¯¹æ¯”ï¼š è‡ªå·±å®ç°çš„åŠ é”çš„Mapï¼Œæ¯æ¬¡æ“ä½œéƒ½éœ€è¦å…ˆè·å¾—é”ï¼Œè¿™å°±é€ æˆæå¤§çš„æ€§èƒ½æµªè´¹ï¼› sync.mapä¸­æœ‰åªè¯»æ•°æ®readã€é”muã€æ™®é€šçš„Mapdirtyã€è®¡æ•°å™¨missesã€‚å…¶ä¸­ï¼Œæ‰§è¡Œå¢åˆ æŸ¥æ”¹å‰ï¼Œéƒ½ä¼šå…ˆå¯¹readè¿›è¡Œæ“ä½œï¼Œå› ä¸ºè¿™æ˜¯åªè¯»çš„ï¼Œæ”¯æŒåŸå­æ“ä½œï¼Œä¹Ÿå°±æ”¯æŒå¹¶å‘è®¿é—®ã€‚è¿™å°±ä¼šçœå»å¾ˆå¤§ä¸€éƒ¨åˆ†åŠ é”è§£é”å¸¦æ¥çš„å¼€é”€ã€‚ æ€§èƒ½æµ‹è¯•ç»“è®ºï¼š æ’å…¥å…ƒç´ ï¼šSyncMapStore \u003c MapStore \u003c RwMapStoreï¼› æŸ¥æ‰¾å…ƒç´ ï¼šMapLookup \u003c RwMapLookup \u003c SyncMapLookupï¼› åˆ é™¤å…ƒç´ ï¼šRwMapDelete \u003c MapDelete \u003c SyncMapDelete æµ‹è¯•å¦‚ä¸‹ï¼š â¯ go test -bench=. goos: windows goarch: amd64 pkg: goLearn/sync/08-sync.map cpu: 12th Gen Intel(R) Core(TM) i7-12700K BenchmarkBuiltinMapStoreParalell-20 15114511 81.30 ns/op BenchmarkBuiltinRwMapStoreParalell-20 16176103 83.39 ns/op BenchmarkSyncMapStoreParalell-20 8515656 171.0 ns/op BenchmarkBuiltinMapLookupParalell-20 21025113 61.02 ns/op BenchmarkBuiltinRwMapLookupParalell-20 26539101 45.61 ns/op BenchmarkSyncMapLookupParalell-20 285766286 4.159 ns/op BenchmarkBuiltinMapDeleteParalell-20 20315636 60.36 ns/op BenchmarkBuiltinRwMapDeleteParalell-20 18308758 69.12 ns/op BenchmarkSyncMapDeleteParalell-20 296166151 4.112 ns/op PASS ok goLearn/sync/08-sync.map 13.145s åœºæ™¯åˆ†æï¼š sync.mapçš„è¯»å’Œåˆ ï¼Œæ€§èƒ½éå¸¸å¥½ï¼Œé¢†å…ˆ map+é”ï¼› å†™ï¼Œæ€§èƒ½éå¸¸å·®ï¼Œè½åäº map+é”ã€‚ sync.mapçš„é€‚ç”¨åœºæ™¯ï¼šå¤§é‡è¯»ï¼Œå°‘é‡å†™ã€‚è¿™æ˜¯å› ä¸ºï¼Œsync.mapæœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº†**==è¯»å†™åˆ†ç¦»==ï¼Œå¦‚æœæ˜¯å¤§é‡å†™çš„åœºæ™¯ï¼Œä¼šå¯¼è‡´missessä¸€ç›´å¢åŠ ï¼Œä¹Ÿå°±ä¼šä¸€ç›´è§¦å‘dirtyæ™‹å‡ä¸ºreadï¼Œå¯¼è‡´æ€§èƒ½åè€Œä¸å¦‚æ™®é€šçš„Map+é”**ã€‚ æ€ç»´å‘æ•£ï¼š å¯ä»¥å¯¹å¤§Mapè¿›ä¸€æ­¥åˆ’åˆ†ï¼Œåˆ†æˆå¾ˆå¤šä¸ªå°Mapï¼Œå•ç‹¬å¯¹æ¯éƒ¨åˆ†åŠ é”è§£é”ï¼Œä¹Ÿå°±æ˜¯ç»†åŒ–é”çš„ç²’åº¦ã€‚åªæ˜¯å®ç°èµ·æ¥å¤ªéº»çƒ¦äº†ã€‚ é—®ï¼šmapä¸­ï¼Œkeyå¯ä»¥ä¸ºnilå—ï¼Ÿâ­ğŸš© éœ€è¦åˆ†æƒ…å†µè®¨è®ºã€‚ nilæ˜¯interface{}ã€chanã€mapç­‰ç±»å‹çš„é›¶å€¼ã€‚å› æ­¤ï¼Œå¦‚æœmapçš„keyçš„ç±»å‹æ˜¯interface{}ï¼Œé‚£ä¹ˆkeyå¯ä»¥ä¸ºnilï¼Œå°±è·Ÿç©ºæ¥å£æ•ˆæœä¸€æ ·ï¼› å¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œnilæ˜¯è‚¯å®šä¸è¡Œçš„ï¼Œä½†æ˜¯å¯¹åº”ç±»å‹çš„é›¶å€¼æ˜¯okçš„ã€‚ é—®ï¼šmapä¸­ï¼Œfunc å¯ä»¥åškeyå—ï¼Ÿä»€ä¹ˆç±»å‹èƒ½åšï¼Ÿä¸ºä»€ä¹ˆï¼Ÿâ­ğŸš© **ä¸å¯ä»¥ã€‚**å¿…é¡»æ˜¯å¯æ¯”è¾ƒç±»å‹æ‰èƒ½åškeyã€‚é‚£ä¸ºä»€ä¹ˆè¦å¯æ¯”è¾ƒçš„ç±»å‹æ‰èƒ½åškeyå‘¢ï¼Ÿä¸æ˜¯ç›´æ¥é€šè¿‡ top 8 ä½å°±èƒ½æ‹¿åˆ°å—ï¼Ÿ å› ä¸ºæŸ¥æ‰¾ key çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šå½“å‡ºç°å“ˆå¸Œå†²çªï¼Œå°±ä¼šåˆ°åŒä¸€ä¸ªæ¡¶ä¸­å¯»æ‰¾ï¼Œé€šè¿‡ top 8 ä½æ‰¾åˆ°å¯¹åº”çš„ keyâ€™ï¼Œç”¨ keyâ€™ å’Œ key è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€æ ·ï¼Œå°±å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„ valueã€‚ å› ä¸ºè¿˜éœ€è¦ä¸€æ¬¡ å¯¹æ¯”ï¼æ‰€ä»¥å½“ç„¶è¦å¯æ¯”è¾ƒã€‚ã€‚ã€‚ é—®ï¼š[]byte{} å’Œ string æ€ä¹ˆè½¬æ¢ï¼Ÿæ€§èƒ½ï¼ŸåŸç†ï¼Ÿå„è‡ªçš„é€‚ç”¨åœºæ™¯ï¼Ÿâ­ğŸš© å…±ä¸¤ç§æ–¹æ³•ï¼š æ ‡å‡†è½¬æ¢ s1 := \"hello\" b := []byte(s1) s2 := string(b) å¼ºåˆ¶è½¬æ¢ func String2Bytes(s string) []byte { sh := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) bh := reflect.SliceHeader{ Data: sh.Data, Len: sh.Len, Cap: sh.Len, } return *(*[]byte)(unsafe.Pointer(\u0026bh)) } func Bytes2String(b []byte) string { return *(*string)(unsafe.Pointer(\u0026b)) } å¼ºè½¬æ¢æ–¹å¼çš„æ€§èƒ½ä¼šæ˜æ˜¾ä¼˜äºæ ‡å‡†è½¬æ¢ã€‚ ==å¯ä»¥å»¶ä¼¸å¦‚ä¸‹é—®é¢˜==ï¼š ä¸ºå•¥å¼ºè½¬æ¢æ€§èƒ½ä¼šæ¯”æ ‡å‡†è½¬æ¢å¥½ï¼Ÿ å¯¹äºæ ‡å‡†è½¬æ¢ï¼Œæ— è®ºæ˜¯ä»[]byteè½¬stringè¿˜æ˜¯stringè½¬[]byteéƒ½ä¼šæ¶‰åŠåº•å±‚æ•°ç»„çš„æ‹·è´ã€‚è€Œå¼ºè½¬æ¢æ˜¯ç›´æ¥æ›¿æ¢æŒ‡é’ˆçš„æŒ‡å‘ï¼Œä»è€Œä½¿å¾—stringå’Œ[]byteæŒ‡å‘åŒä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚è¿™æ ·ï¼Œå½“ç„¶åè€…çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ ä¸ºå•¥å½“xçš„æ•°æ®è¾ƒå¤§æ—¶ï¼Œæ ‡å‡†è½¬æ¢æ–¹å¼ä¼šæœ‰ä¸€æ¬¡åˆ†é…å†…å­˜çš„æ“ä½œï¼Œä»è€Œå¯¼è‡´å…¶æ€§èƒ½æ›´å·®ï¼Œè€Œå¼ºè½¬æ¢æ–¹å¼å´ä¸å—å½±å“ï¼Ÿ æ ‡å‡†è½¬æ¢æ—¶ï¼Œå½“æ•°æ®é•¿åº¦å¤§äº32ä¸ªå­—èŠ‚æ—¶ï¼Œéœ€è¦é€šè¿‡mallocgcç”³è¯·æ–°çš„å†…å­˜ï¼Œä¹‹åå†è¿›è¡Œæ•°æ®æ‹·è´å·¥ä½œã€‚è€Œå¼ºè½¬æ¢åªæ˜¯æ›´æ”¹æŒ‡é’ˆæŒ‡å‘ã€‚æ‰€ä»¥ï¼Œå½“è½¬æ¢æ•°æ®è¾ƒå¤§æ—¶ï¼Œä¸¤è€…æ€§èƒ½å·®è·ä¼šæ„ˆåŠ æ˜æ˜¾ã€‚ æ—¢ç„¶å¼ºè½¬æ¢æ–¹å¼æ€§èƒ½è¿™ä¹ˆå¥½ï¼Œä¸ºå•¥goæä¾›ç»™æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ ‡å‡†è½¬æ¢æ–¹å¼ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“Goæ˜¯ä¸€é—¨ç±»å‹å®‰å…¨çš„è¯­è¨€ï¼Œè€Œå®‰å…¨çš„ä»£ä»·å°±æ˜¯æ€§èƒ½çš„å¦¥åã€‚ä½†æ˜¯ï¼Œæ€§èƒ½çš„å¯¹æ¯”æ˜¯ç›¸å¯¹çš„ï¼Œè¿™ç‚¹æ€§èƒ½çš„å¦¥åå¯¹äºç°åœ¨çš„æœºå™¨è€Œè¨€å¾®ä¹å…¶å¾®ã€‚å¦å¤–å¼ºè½¬æ¢çš„æ–¹å¼ï¼Œä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥æå¤§çš„å®‰å…¨éšæ‚£ã€‚å¦‚ä¸‹ä»£ç ä¼šç›´æ¥æŠ¥é”™ï¼š func main() { s := \"hello\" b := String2Bytes(s) fmt.Println(b) b[0] = 'l' fmt.Println(s) } unexpected fault address 0x6c47f8 fatal error: fault [signal 0xc0000005 code=0x1 addr=0x6c47f8 pc=0x6ab5aa] sæ˜¯stringç±»å‹ï¼Œæ˜¯ä¸å¯ä¿®æ”¹çš„ã€‚é€šè¿‡å¼ºè½¬æ¢å°†sçš„åº•å±‚æ•°ç»„èµ‹ç»™bï¼Œè€Œbæ˜¯ä¸€ä¸ª[]byteç±»å‹ï¼Œå®ƒçš„å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œæ‰€ä»¥è¿™æ—¶å¯¹åº•å±‚æ•°ç»„çš„å€¼è¿›è¡Œä¿®æ”¹ï¼Œå°†ä¼šé€ æˆä¸¥é‡çš„é”™è¯¯ï¼ˆé€šè¿‡defer+recoverä¹Ÿä¸èƒ½æ•è·ï¼‰ã€‚ stringä¸ºå•¥è¦è®¾è®¡æˆä¸å¯ä¿®æ”¹çš„ï¼Ÿ stringä¸å¯ä¿®æ”¹ï¼Œæ„å‘³å®ƒæ˜¯åªè¯»å±æ€§ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼šåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åŠ é”çš„æ§åˆ¶ä¸‹ï¼Œå¤šæ¬¡ä½¿ç”¨åŒä¸€å­—ç¬¦ä¸²ï¼Œåœ¨ä¿è¯é«˜æ•ˆå…±äº«çš„æƒ…å†µä¸‹è€Œä¸ç”¨æ‹…å¿ƒå®‰å…¨é—®é¢˜ã€‚ å› æ­¤ï¼Œå¯¹äºè¿™ä¸¤ç§æ–¹æ³•çš„é€‚ç”¨åœºæ™¯ï¼Œæœ‰å¦‚ä¸‹å‚è€ƒï¼š åœ¨ä½ ä¸ç¡®å®šå®‰å…¨éšæ‚£çš„æ¡ä»¶ä¸‹ï¼Œå°½é‡é‡‡ç”¨æ ‡å‡†æ–¹å¼è¿›è¡Œæ•°æ®è½¬æ¢ã€‚ å½“ç¨‹åºå¯¹è¿è¡Œæ€§èƒ½æœ‰é«˜è¦æ±‚ï¼ŒåŒæ—¶æ»¡è¶³å¯¹æ•°æ®ä»…ä»…åªæœ‰è¯»æ“ä½œçš„æ¡ä»¶ï¼Œä¸”å­˜åœ¨é¢‘ç¹è½¬æ¢ï¼ˆä¾‹å¦‚æ¶ˆæ¯è½¬å‘åœºæ™¯ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¼ºè½¬æ¢ã€‚ é—®ï¼šä¸¤ç§æ–¹æ³•çš„è½¬æ¢åŸç†ï¼Ÿ // slice çš„åº•å±‚æ•°æ®ç»“æ„ type slice struct { array unsafe.Pointer // æŒ‡å‘çš„æ˜¯æŸä¸ªæ•°ç»„çš„é¦–åœ°å€ len int cap int } // string çš„åº•å±‚æ•°æ®ç»“æ„ type stringStruct struct { str unsafe.Pointer // æŒ‡å‘çš„æ˜¯æŸä¸ªæ•°ç»„çš„é¦–åœ°å€ len int } æ ‡å‡†è½¬æ¢ const tmpStringBufSize = 32 type tmpBuf [tmpStringBufSize]byte func stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026\u0026 len(s) \u003c= len(buf) { *buf = tmpBuf{} b = buf[:len(s)] } else { b = rawbyteslice(len(s)) } copy(b, s) return b } // rawbyteslice allocates a new byte slice. The byte slice is not zeroed. func rawbyteslice(size int) (b []byte) { cap := roundupsize(uintptr(size)) p := mallocgc(cap, nil, false) if cap != uintptr(size) { memclrNoHeapPoint","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:15:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.11 ç»“æ„ä½“å’Œæ¥å£ åŸºç¡€ é—®ï¼šGo å¦‚ä½•å®ç° å¤šæ€ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­ğŸš© å¦‚ä½•å®ç°ï¼š å¤šæ€ä½¿å†…éƒ¨ç»“æ„ä¸åŒçš„å¯¹è±¡å¯ä»¥å…±äº«ç›¸åŒçš„å¤–éƒ¨æ¥å£ã€‚ Go é€šè¿‡æ¥å£å®ç°å¤šæ€ï¼š æŸä¸ªç±»å‹è‹¥å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œå°±éšå¼çš„å®ç°äº†è¯¥æ¥å£ï¼› æŸä¸ªç±»å‹çš„å¯¹è±¡å¯ä»¥èµ‹ç»™å®ƒæ‰€å®ç°çš„ä»»æ„æ¥å£ç±»å‹çš„å˜é‡ï¼› (ç½‘ä¸Šæ²¡æ‰¾åˆ°å•¥å¥½çš„è®²è§£ï¼Œè‡ªå·±å°è¯•å†™ä¸ªå§â€¦) åŸç†ï¼š é¦–å…ˆè¦æ˜ç¡®ï¼Œæ¯ä¸ªç±»å‹åœ¨åº•å±‚éƒ½ä¼šæœ‰ä¸€ä¸ªç±»å‹å…ƒæ•°æ®ï¼Œå­˜æ”¾ç€ç±»å‹ä¿¡æ¯å’Œæ–¹æ³•å…ƒæ•°æ®åˆ—è¡¨ã€‚ ç„¶åï¼Œå®šä¹‰ä¸€ä¸ªéç©ºæ¥å£ï¼Œå¹¶è®©æŸç±»å‹å®ç°è¯¥æ¥å£ï¼› åœ¨å¤šæ€çš„åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°çš„å…¥å‚æ˜¯å®šä¹‰çš„éç©ºæ¥å£ç±»å‹ï¼Œè°ƒç”¨è¯¥å‡½æ•°æ—¶ä¼ å‚ä¸ºå…·ä½“ç±»å‹çš„å¯¹è±¡ï¼Œå…¶å®å°±ä¼šæŠŠè¯¥å…·ä½“ç±»å‹çš„å¯¹è±¡èµ‹å€¼ç»™è¯¥éç©ºæ¥å£ã€‚è¿™é‡Œè¦äº†è§£ï¼Œéç©ºæ¥å£çš„åº•å±‚ç»“æ„ä½“é‡Œå…±æœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯itabï¼Œä¸€ä¸ªæ˜¯dataï¼š itabä¸­ä¼šè®°å½•æ¥å£çš„ç±»å‹å…ƒæ•°æ®(åŒ…å«æ¥å£çš„æ–¹æ³•åˆ—è¡¨)ã€åŠ¨æ€ç±»å‹å…ƒæ•°æ®ã€åŠ¨æ€ç±»å‹å®ç°çš„(æ¥å£æ‰€éœ€è¦çš„)æ–¹æ³•çš„åœ°å€åˆ—è¡¨funï¼› dataä¸ºåŠ¨æ€å€¼ï¼ŒæŒ‡å‘å…·ä½“ç±»å‹çš„å¯¹è±¡ã€‚ å› æ­¤ï¼Œèµ‹å€¼è¿‡ç¨‹å°±æ˜¯æŠŠdataæŒ‡å‘å…·ä½“ç±»å‹çš„å¯¹è±¡ï¼Œä¿®æ”¹itabä¸­çš„åŠ¨æ€ç±»å‹å…ƒæ•°æ®ä¸ºå…·ä½“ç±»å‹çš„ç±»å‹å…ƒæ•°æ®ï¼Œå¹¶ä»è¯¥ç±»å‹å…ƒæ•°æ®ä¸­çš„æ–¹æ³•å…ƒæ•°æ®åˆ—è¡¨æ‹·è´æ–¹æ³•åœ°å€åˆ°funã€‚ ç»™å‡ºä¸€æ®µç¤ºä¾‹ä»£ç ï¼š type test interface { print() } type hello struct { } func (h hello) print() { fmt.Println(\"hello\") } // å¤šæ€åœºæ™¯ func hi(t test) { t.print() } func main() { h := hello{} // ç¬¬ä¸€ç§è°ƒç”¨æ–¹å¼ var t test t = h t.print() // ç¬¬äºŒç§ hi(h) } é—®ï¼šGo å¦‚ä½•å®ç° ç»„åˆ å’Œ ç»§æ‰¿ï¼Ÿ Go è¯­è¨€ä¸­æ²¡æœ‰ç»§æ‰¿çš„æ¦‚å¿µï¼Œæ›´æå€¡çš„æ˜¯ç»„åˆã€‚æ¥å£å’Œç»“æ„ä½“éƒ½å¯ä»¥ç»„åˆã€‚ æ¥å£çš„ç»„åˆï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š type Reader interface { Read(p []byte) (n int, err error) } type Writer interface { Write(p []byte) (n int, err error) } //ReadWriteræ˜¯Readerå’ŒWriterçš„ç»„åˆ type ReadWriter interface { Reader Writer } ReadWriter æ¥å£å°±æ˜¯ Reader å’Œ Writer çš„ç»„åˆï¼Œç»„åˆåçš„ ReadWriter æ¥å£å…·æœ‰ Reader å’Œ Writer ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œè¿™æ ·æ–°æ¥å£ ReadWriter å°±ä¸ç”¨å®šä¹‰è‡ªå·±çš„æ–¹æ³•äº†ï¼Œç»„åˆ Reader å’Œ Writer çš„å°±å¯ä»¥äº†ã€‚ ç»“æ„ä½“çš„ç»„åˆï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š type person struct { name string age uint address } ç›´æ¥æŠŠç»“æ„ä½“ç±»å‹æ”¾è¿›æ¥ï¼Œå°±æ˜¯ç»„åˆï¼Œä¸éœ€è¦å­—æ®µåã€‚ç»„åˆåï¼Œè¢«ç»„åˆçš„ address ç§°ä¸ºå†…éƒ¨ç±»å‹ï¼Œperson ç§°ä¸ºå¤–éƒ¨ç±»å‹ï¼š å¤–éƒ¨ç±»å‹ä¸ä»…å¯ä»¥ä½¿ç”¨å†…éƒ¨ç±»å‹çš„å­—æ®µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…éƒ¨ç±»å‹çš„æ–¹æ³•ï¼Œå°±åƒä½¿ç”¨è‡ªå·±çš„æ–¹æ³•ä¸€æ ·ï¼› å¦‚æœå¤–éƒ¨ç±»å‹å®šä¹‰äº†å’Œå†…éƒ¨ç±»å‹åŒæ ·çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¤–éƒ¨ç±»å‹çš„ä¼šè¦†ç›–å†…éƒ¨ç±»å‹ï¼Œè¿™å°±æ˜¯æ–¹æ³•çš„è¦†å†™ã€‚æ–¹æ³•è¦†å†™ä¸ä¼šå½±å“å†…éƒ¨ç±»å‹çš„æ–¹æ³•å®ç°ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼š p:=person{ age:30, name:\"é£é›ªæ— æƒ…\", address:address{ province: \"åŒ—äº¬\", city: \"åŒ—äº¬\", }, } //åƒä½¿ç”¨è‡ªå·±çš„å­—æ®µä¸€æ ·ï¼Œç›´æ¥ä½¿ç”¨ fmt.Println(p.province) å› ä¸º person ç»„åˆäº† addressï¼Œæ‰€ä»¥ address çš„å­—æ®µå°±åƒ person è‡ªå·±çš„ä¸€æ ·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ é¢˜ç›®ï¼š1 type People struct{} func (p *People) ShowA() { fmt.Println(\"showA\") p.ShowB() } func (p *People) ShowB() { fmt.Println(\"showB\") } type Teacher struct { People } func (t *Teacher) ShowB() { fmt.Println(\"teacher showB\") } func main() { t := Teacher{} t.ShowA() } è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªç±»å‹ï¼Œç±»å‹Teacherä¸­åµŒå…¥äº†ç±»å‹Peopleã€‚**é—®é¢˜æ˜¯ï¼š**é€šè¿‡Teacherç±»å‹çš„å˜é‡tè°ƒç”¨æ–¹æ³•showA()ï¼Œè¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ ç­”æ¡ˆï¼š showA showB è§£é‡Šï¼š é¦–å…ˆè¦æ˜ç¡®Tå’Œ*Tæ˜¯ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«å¯¹åº”è‡ªå·±çš„ç±»å‹å…ƒæ•°æ®ï¼Œæœ‰ç€å„è‡ªçš„æ–¹æ³•é›†ï¼Œå…¶ä¸­åŒ…å«äº†è‡ªå®šä¹‰çš„æ–¹æ³•ä»¥åŠç¼–è¯‘å™¨ç”Ÿæˆçš„æ–¹æ³•ã€‚é€šè¿‡go tool compile -l -p main main.goå¯ä»¥ç”Ÿæˆmain.goçš„objæ–‡ä»¶ï¼Œå†é€šè¿‡go tool nm main.oå°±å¯ä»¥æŸ¥çœ‹æ–¹æ³•åˆ—è¡¨ï¼š â¯ go tool nm main.o | grep 'T' | grep People 301c T main.(*People).ShowA 308a T main.(*People).ShowB â¯ go tool nm main.o | grep 'T' | grep Teacher 36d9 T main.(*Teacher).ShowA 30e0 T main.(*Teacher).ShowB å¯ä»¥å‘ç°ï¼ŒPeopleå’Œ*Peopleçš„æ–¹æ³•é›†åŒä»£ç ä¸­å®šä¹‰çš„ä¸€è‡´ï¼Œä½†Teacherå’Œ*Teacherç›¸å…³çš„æ–¹æ³•åˆ—è¡¨ä¸­å¤šäº†ä¸€ä¸ªShowA()æ–¹æ³•ï¼Œè¿™å°±æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„äº†ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸º*Teacherç”Ÿæˆäº†è¿™æ ·ä¸€ä¸ªåŒ…è£…æ–¹æ³•(çº¢å­—éƒ¨åˆ†)ï¼š æ‰€ä»¥ï¼Œè°ƒç”¨è¿‡ç¨‹ä¸ºï¼št.ShowA()ä¼šåœ¨è¯­æ³•ç³–çš„ä½œç”¨ä¸‹è½¬æ¢ä¸ºå¯¹(*Teacher).ShowA()æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œå®ƒåˆä¼šå–å‡ºPeopleæˆå‘˜çš„åœ°å€ä½œä¸ºæ¥æ”¶è€…å»æ‰§è¡Œ*Peopleè¿™é‡Œçš„ShowA()æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šæœ‰å¦‚ä¸Šè¾“å‡ºã€‚ é¢˜ç›®ï¼š2 è§£é‡Šåˆ°è¿™é‡Œï¼Œè¿™é“é¢˜å·²ç»è§£å†³äº†ã€‚ä½†æ— æ³•çŸ¥é“ä¸ºä»€ä¹ˆç¼–è¯‘å™¨åªç»™*Teacherç”Ÿæˆäº†åŒ…è£…æ–¹æ³•ï¼Ÿä¸ºæ­¤æ¢ç´¢ä¸€ä¸‹ç¼–è¯‘å™¨ç”ŸæˆåŒ…è£…æ–¹æ³•çš„è§„åˆ™ã€‚ type A int func (a A) Value() int { return int(a) } func (a *A) Set(n int) { *a = A(n) } type B struct { A b int } type C struct { *A c int } åˆ†æä»¥ä¸ŠBå’ŒCä¼šåˆ†åˆ«ç»§æ‰¿å“ªäº›æ–¹æ³•ã€‚ é¦–å…ˆï¼Œå€¼æ¥æ”¶è€…Aæœ‰Value()æ–¹æ³•ï¼Œå‰é¢å·²ç»è®²è¿‡ï¼Œä¸ºäº†æ”¯æŒæ¥å£ï¼Œç¼–è¯‘å™¨ä¼šä¸ºå€¼æ¥æ”¶è€…æ–¹æ³•ç”ŸæˆæŒ‡é’ˆæ¥æ”¶è€…çš„åŒ…è£…æ–¹æ³•ï¼Œæ‰€ä»¥*Aä¼šæœ‰Value()å’ŒSet()æ–¹æ³•ï¼›Bå’ŒCæ‹¥æœ‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š å…¶ä¸­ï¼Œåªæœ‰Båªç»§æ‰¿äº†Value()æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºä»¥Bä¸ºæ¥æ”¶è€…è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ–¹æ³•æ“ä½œçš„å·²ç»æ˜¯Bçš„å‰¯æœ¬ï¼Œæ— æ³•è·å–åµŒå…¥çš„Açš„åŸå§‹åœ°å€ï¼›è€Œ*Açš„æ–¹æ³•ä»è¯­ä¹‰ä¸Šæ¥è®²éœ€è¦æ“ä½œåŸå§‹å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºBè€Œè¨€å®ƒç»§æ‰¿*Açš„æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¹¶æ²¡æœ‰ç»™Bç”ŸæˆSet()æ–¹æ³•ã€‚ **ç»“è®ºå°±æ˜¯ï¼š**æ— è®ºæ˜¯åµŒå…¥å€¼è¿˜æ˜¯åµŒå…¥æŒ‡é’ˆï¼Œå€¼æ¥æ”¶è€…æ–¹æ³•å§‹ç»ˆèƒ½å¤Ÿè¢«ç»§æ‰¿ï¼›è€Œåªæœ‰åœ¨èƒ½å¤Ÿæ‹¿åˆ°åµŒå…¥å¯¹è±¡çš„åœ°å€æ—¶ï¼Œæ‰èƒ½ç»§æ‰¿æŒ‡é’ˆæ¥æ”¶è€…æ–¹æ³•ã€‚ ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:16:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["Go","é¢è¯•"],"content":"3.12 å¯¹æ¯” Java é—®ï¼šGo å’Œ Java çš„åŒºåˆ«ï¼Ÿ æ€§èƒ½ï¼šæ— è®ºåœ¨ä¸²è¡Œè¿˜æ˜¯å¹¶å‘çš„çš„ä¸šåŠ¡ä¸‹ï¼ŒJavaçš„æ€§èƒ½éƒ½æ¯”Goå·®ï¼› goroutine é»˜è®¤å ç”¨å†…å­˜è¿œæ¯” Java ã€C çš„çº¿ç¨‹å°‘(goroutineï¼š2KBï¼Œçº¿ç¨‹ï¼š8MB)ï¼Œå ç”¨èµ„æºæ›´å°‘ï¼› goroutine å¯ä»¥é¿å…å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢å¯¼è‡´çš„æˆæœ¬ã€‚ éƒ¨ç½²ç¼–è¯‘ï¼š Javaé€šè¿‡è™šæ‹Ÿæœºç¼–è¯‘ï¼Œä½¿ç”¨JVMè·¨å¹³å°ç¼–è¯‘ï¼› Goè¯­è¨€é’ˆå¯¹ä¸åŒçš„å¹³å°ï¼Œç¼–è¯‘å¯¹åº”çš„æœºå™¨ç ã€‚ è®¿é—®æƒé™ï¼š Javaä½¿ç”¨publicã€protectedã€privateã€é»˜è®¤ç­‰å‡ ç§ä¿®é¥°ç¬¦æ¥æ§åˆ¶è®¿é—®æƒé™ï¼› Goè¯­è¨€é€šè¿‡å¤§å°å†™æ§åˆ¶åŒ…å¤–å¯è®¿é—®è¿˜æ˜¯ä¸å¯è®¿é—®ã€‚Goè¯­è¨€ä¸­æ ¹æ®é¦–å­—æ¯çš„å¤§å°å†™æ¥ç¡®å®šå¯ä»¥è®¿é—®çš„æƒé™ã€‚æ— è®ºæ˜¯æ–¹æ³•åã€å¸¸é‡ã€å˜é‡åè¿˜æ˜¯ç»“æ„ä½“çš„åç§°ï¼Œå¦‚æœé¦–å­—æ¯å¤§å†™ï¼Œåˆ™å¯ä»¥è¢«å…¶ä»–çš„åŒ…è®¿é—®ï¼›å¦‚æœé¦–å­—æ¯å°å†™ï¼Œåˆ™åªèƒ½åœ¨æœ¬åŒ…ä¸­ä½¿ç”¨ã€‚å¯ä»¥ç®€å•çš„ç†è§£æˆï¼Œé¦–å­—æ¯å¤§å†™æ˜¯å…¬æœ‰çš„ï¼Œé¦–å­—æ¯å°å†™æ˜¯ç§æœ‰çš„ã€‚ æ¥å£ Javaç­‰é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¥å£æ˜¯ä¾µå…¥å¼æ¥å£ï¼Œéœ€è¦æ˜ç¡®å£°æ˜è‡ªå·±å®ç°äº†æŸä¸ªæ¥å£ï¼› Goè¯­è¨€çš„éä¾µå…¥å¼æ¥å£ä¸éœ€è¦é€šè¿‡ä»»ä½•å…³é”®å­—å£°æ˜ç±»å‹ä¸æ¥å£ä¹‹é—´çš„å®ç°å…³ç³»ï¼Œåªè¦ä¸€ä¸ªç±»å‹å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å‹å°±æ˜¯è¿™ä¸ªæ¥å£çš„å®ç°ç±»å‹ã€‚ å¼‚å¸¸å¤„ç† Javaä¸­é”™è¯¯ï¼ˆErrorï¼‰å’Œå¼‚å¸¸(Exception)è¢«åˆ†ç±»ç®¡ç†ï¼ŒäºŒè€…çš„åŒºåˆ«æ˜¯ï¼š Errorï¼ˆé”™è¯¯ï¼‰ï¼šç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€é‡åˆ°çš„ç¡¬ä»¶æˆ–æ“ä½œç³»ç»Ÿçš„é”™è¯¯ã€‚é”™è¯¯å¯¹ç¨‹åºè€Œè¨€æ˜¯è‡´å‘½çš„ï¼Œå°†å¯¼è‡´ç¨‹åºæ— æ³•è¿è¡Œã€‚å¸¸è§çš„é”™è¯¯æœ‰å†…å­˜æº¢å‡ºï¼Œjvmè™šæ‹Ÿæœºè‡ªèº«çš„éæ­£å¸¸è¿è¡Œï¼Œcalssæ–‡ä»¶æ²¡æœ‰ä¸»æ–¹æ³•ã€‚ç¨‹åºæœ¬ç”Ÿæ˜¯ä¸èƒ½å¤„ç†é”™è¯¯çš„ï¼Œåªèƒ½ä¾é å¤–ç•Œå¹²é¢„ã€‚Erroræ˜¯ç³»ç»Ÿå†…éƒ¨çš„é”™è¯¯ï¼Œç”±jvmæŠ›å‡ºï¼Œäº¤ç»™ç³»ç»Ÿæ¥å¤„ç†ï¼› EXCEPTIONï¼ˆå¼‚å¸¸ï¼‰ï¼šæ˜¯ç¨‹åºæ­£å¸¸è¿è¡Œä¸­ï¼Œå¯ä»¥é¢„æ–™çš„æ„å¤–æƒ…å†µã€‚æ¯”å¦‚æ•°æ®åº“è¿æ¥ä¸­æ–­ï¼Œç©ºæŒ‡é’ˆï¼Œæ•°ç»„ä¸‹æ ‡è¶Šç•Œã€‚å¼‚å¸¸å‡ºç°å¯ä»¥å¯¼è‡´ç¨‹åºéæ­£å¸¸ç»ˆæ­¢ï¼Œä¹Ÿå¯ä»¥é¢„å…ˆæ£€æµ‹ï¼Œè¢«æ•è·å¤„ç†æ‰ï¼Œä½¿ç¨‹åºç»§ç»­è¿è¡Œã€‚ Goè¯­è¨€ä¸­åªæœ‰errorï¼Œä¸€æ—¦å‘ç”Ÿé”™è¯¯é€å±‚è¿”å›ï¼Œç›´åˆ°è¢«å¤„ç†ã€‚Golangä¸­å¼•å…¥ä¸¤ä¸ªå†…ç½®å‡½æ•°panicå’Œrecoveræ¥è§¦å‘å’Œç»ˆæ­¢å¼‚å¸¸å¤„ç†æµç¨‹ï¼ŒåŒæ—¶å¼•å…¥å…³é”®å­—deferæ¥å»¶è¿Ÿæ‰§è¡Œdeferåé¢çš„å‡½æ•°ã€‚golangå¼±åŒ–äº†å¼‚å¸¸ï¼Œåªæœ‰é”™è¯¯ï¼Œåœ¨æ„æ–™ä¹‹å¤–çš„panicå‘ç”Ÿæ—¶ï¼Œåœ¨deferä¸­é€šè¿‡recoveræ•è·è¿™ä¸ªææ…Œï¼Œè½¬åŒ–ä¸ºé”™è¯¯ä»¥code,messageçš„å½¢å¼è¿”å›ç»™æ–¹æ³•è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å»å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯goæç®€çš„ç²¾é«“ã€‚ ç»§æ‰¿ Javaçš„ç»§æ‰¿é€šè¿‡extendså…³é”®å­—å®Œæˆï¼Œä¸æ”¯æŒå¤šç»§æ‰¿ï¼› Goè¯­è¨€çš„ç»§æ‰¿é€šè¿‡åŒ¿åç»„åˆå®Œæˆï¼šåŸºç±»ä»¥Structçš„æ–¹å¼å®šä¹‰ï¼Œå­ç±»åªéœ€è¦æŠŠåŸºç±»ä½œä¸ºæˆå‘˜æ”¾åœ¨å­ç±»çš„å®šä¹‰ä¸­ï¼Œæ”¯æŒå¤šç»§æ‰¿ã€‚ å¤šæ€ Javaçš„å¤šæ€ï¼Œå¿…é¡»æ»¡è¶³ç»§æ‰¿ï¼Œé‡å†™ï¼Œå‘ä¸Šè½¬å‹ï¼›ä»»ä½•ç”¨æˆ·å®šä¹‰çš„ç±»å‹éƒ½å¯ä»¥å®ç°ä»»ä½•æ¥å£ï¼Œæ‰€ä»¥é€šè¿‡ä¸åŒå®ä½“ç±»å‹å¯¹æ¥å£å€¼æ–¹æ³•çš„è°ƒç”¨å°±æ˜¯å¤šæ€ã€‚ åœ¨Goè¯­è¨€ä¸­é€šè¿‡æ¥å£å®ç°å¤šæ€ï¼Œå¯¹æ¥å£çš„å®ç°åªéœ€è¦æŸä¸ªç±»å‹Tå®ç°äº†æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå°±ç›¸å½“äºå®ç°äº†è¯¥æ¥å£ã€‚ æŒ‡é’ˆ Javaä¸­ä¸å­˜åœ¨æ˜¾å¼çš„æŒ‡é’ˆï¼Œè€ŒGolangä¸­å­˜åœ¨æ˜¾å¼çš„æŒ‡é’ˆæ“ä½œï¼Œä½¿ç”¨ * æ¥å®šä¹‰å’Œå£°æ˜æŒ‡é’ˆï¼Œé€šè¿‡\u0026æ¥å–å¾—å¯¹è±¡çš„æŒ‡é’ˆã€‚æ³¨æ„ï¼ŒJavaå’ŒGolangéƒ½æ˜¯åªå­˜åœ¨å€¼ä¼ é€’ã€‚ å¹¶å‘ åœ¨Javaä¸­ï¼Œé€šå¸¸å€ŸåŠ©äºå…±äº«å†…å­˜ï¼ˆå…¨å±€å˜é‡ï¼‰ä½œä¸ºçº¿ç¨‹é—´é€šä¿¡çš„åª’ä»‹ï¼Œé€šå¸¸ä¼šæœ‰çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨äº†åŠ é”ï¼ˆåŒæ­¥åŒ–ï¼‰ã€ä½¿ç”¨åŸå­ç±»ã€ä½¿ç”¨volatileæå‡å¯è§æ€§ç­‰è§£å†³ï¼› ä½†åœ¨Goè¯­è¨€ä¸­ä½¿ç”¨çš„æ˜¯é€šé“ï¼ˆChannelï¼‰ä½œä¸ºåç¨‹é—´é€šä¿¡çš„åª’ä»‹ï¼Œè¿™ä¹Ÿæ˜¯Goè¯­è¨€ä¸­å¼ºè°ƒçš„ï¼šä¸è¦é€šè¿‡å…±äº«å†…å­˜é€šä¿¡ï¼Œè€Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚ åƒåœ¾å›æ”¶å’Œå†…å­˜ç®¡ç†æœºåˆ¶ JavaåŸºäºJVMè™šæ‹Ÿæœºçš„åˆ†ä»£æ”¶é›†ç®—æ³•å®ŒæˆGCï¼ŒGoè¯­è¨€å†…å­˜é‡Šæ”¾æ˜¯è¯­è¨€å±‚é¢ï¼Œå¯¹ä¸å†ä½¿ç”¨çš„å†…å­˜èµ„æºè¿›è¡Œè‡ªåŠ¨å›æ”¶ï¼Œä½¿ç”¨ä¸‰è‰²æ ‡è®°ç®—æ³•ï¼› ","date":"2023-04-25","objectID":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/:17:0","tags":["Go"],"title":"æ·±åº¦æ¢ç´¢Goè¯­è¨€","uri":"/10-%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2go%E8%AF%AD%E8%A8%80/"},{"categories":["é€šç”¨"],"content":" å‰è¨€ï¼šæœ¬èŠ‚æè¿°æ­£å‘ä»£ç†å’Œåå‘ä»£ç†ï¼ŒåŠå…¶ä¹‹é—´çš„å¯¹æ¯”ã€‚ ","date":"2023-04-23","objectID":"/%E4%BB%A3%E7%90%86/:0:0","tags":["è®¡ç®—æœºåŸºç¡€","ä»£ç†"],"title":"ä»£ç†","uri":"/%E4%BB%A3%E7%90%86/"},{"categories":["é€šç”¨"],"content":"ä¸€ã€æ­£å‘ä»£ç† 1.1 æ¦‚å¿µ **æ­£å‘ä»£ç†ï¼ˆforward proxyï¼‰ï¼š**æ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´çš„æœåŠ¡å™¨(ä»£ç†æœåŠ¡å™¨)ï¼Œä¸ºäº†ä»ç›®æ ‡æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è¿™ç§ä»£ç†å…¶å®åœ¨ç”Ÿæ´»ä¸­æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œæ¯”å¦‚è®¿é—®å¤–å›½ç½‘ç«™æŠ€æœ¯ï¼Œå…¶ç”¨åˆ°çš„å°±æ˜¯ä»£ç†æŠ€æœ¯ã€‚ æœ‰æ—¶å€™ï¼Œç”¨æˆ·æƒ³è¦è®¿é—®æŸå›½å¤–ç½‘ç«™ï¼Œè¯¥ç½‘ç«™æ— æ³•åœ¨å›½å†…ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®¿é—®åˆ°ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè¿™ä¸ªä»£ç†æœåŠ¡å™¨å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªå›½å¤–ç½‘ç«™ã€‚è¿™æ ·å‘¢ï¼Œç”¨æˆ·å¯¹è¯¥å›½å¤–ç½‘ç«™çš„è®¿é—®å°±éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨æ¥è½¬å‘è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥ä»£ç†æœåŠ¡å™¨ä¹Ÿä¼šå°†è¯·æ±‚çš„å“åº”å†è¿”å›ç»™ç”¨æˆ·ã€‚è¿™ä¸ªä¸Šç½‘çš„è¿‡ç¨‹å°±æ˜¯ç”¨åˆ°äº†æ­£å‘ä»£ç†ã€‚ æ‰€ä»¥ï¼Œæ­£å‘ä»£ç†ï¼Œå…¶å®æ˜¯\"ä»£ç†æœåŠ¡å™¨\"ä»£ç†äº†\"å®¢æˆ·ç«¯\"ï¼Œå»å’Œ\"ç›®æ ‡æœåŠ¡å™¨\"è¿›è¡Œäº¤äº’ã€‚ é€šè¿‡æ­£å‘ä»£ç†æœåŠ¡å™¨è®¿é—®ç›®æ ‡æœåŠ¡å™¨ï¼Œç›®æ ‡æœåŠ¡å™¨æ˜¯ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯æ˜¯è°çš„ï¼Œç”šè‡³ä¸çŸ¥é“è®¿é—®è‡ªå·±çš„æ˜¯ä¸€ä¸ªä»£ç† 1.2 ä½œç”¨ çªç ´è®¿é—®é™åˆ¶ é€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥çªç ´è‡ªèº«IPè®¿é—®é™åˆ¶ï¼Œè®¿é—®å›½å¤–ç½‘ç«™ï¼Œæ•™è‚²ç½‘ç­‰ã€‚ æé«˜è®¿é—®é€Ÿåº¦ é€šå¸¸ä»£ç†æœåŠ¡å™¨éƒ½è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„ç¡¬ç›˜ç¼“å†²åŒºï¼Œä¼šå°†éƒ¨åˆ†è¯·æ±‚çš„å“åº”ä¿å­˜åˆ°ç¼“å†²åŒºä¸­ï¼Œå½“å…¶ä»–ç”¨æˆ·å†è®¿é—®ç›¸åŒçš„ä¿¡æ¯æ—¶ï¼Œ åˆ™ç›´æ¥ç”±ç¼“å†²åŒºä¸­å–å‡ºä¿¡æ¯ï¼Œä¼ ç»™ç”¨æˆ·ï¼Œä»¥æé«˜è®¿é—®é€Ÿåº¦ã€‚ éšè—å®¢æˆ·ç«¯çœŸå®IP ä¸Šç½‘è€…ä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•éšè—è‡ªå·±çš„IPï¼Œå…å—æ”»å‡»ã€‚ ","date":"2023-04-23","objectID":"/%E4%BB%A3%E7%90%86/:0:1","tags":["è®¡ç®—æœºåŸºç¡€","ä»£ç†"],"title":"ä»£ç†","uri":"/%E4%BB%A3%E7%90%86/"},{"categories":["é€šç”¨"],"content":"äºŒã€åå‘ä»£ç† 2.1 æ¦‚å¿µ åå‘ä»£ç†ï¼ˆreverse proxyï¼‰ï¼šæ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å—internetä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™internetä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚ æ‰€ä»¥ï¼Œåå‘ä»£ç†ï¼Œå…¶å®æ˜¯\"ä»£ç†æœåŠ¡å™¨\"ä»£ç†äº†\"ç›®æ ‡æœåŠ¡å™¨\"ï¼Œå»å’Œ\"å®¢æˆ·ç«¯\"è¿›è¡Œäº¤äº’ã€‚ é€šè¿‡åå‘ä»£ç†æœåŠ¡å™¨è®¿é—®ç›®æ ‡æœåŠ¡å™¨æ—¶ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“çœŸæ­£çš„ç›®æ ‡æœåŠ¡å™¨æ˜¯è°çš„ï¼Œç”šè‡³ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ç†ã€‚ 2.2 ä½œç”¨ éšè—æœåŠ¡å™¨çœŸå®IP ä½¿ç”¨åå‘ä»£ç†ï¼Œå¯ä»¥å¯¹å®¢æˆ·ç«¯éšè—æœåŠ¡å™¨çš„IPåœ°å€ã€‚ è´Ÿè½½å‡è¡¡ åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥åšè´Ÿè½½å‡è¡¡ï¼Œæ ¹æ®æ‰€æœ‰çœŸå®æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼Œå°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„çœŸå®æœåŠ¡å™¨ä¸Šã€‚ æé«˜è®¿é—®é€Ÿåº¦ åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥å¯¹äºé™æ€å†…å®¹åŠçŸ­æ—¶é—´å†…æœ‰å¤§é‡è®¿é—®è¯·æ±‚çš„åŠ¨æ€å†…å®¹æä¾›ç¼“å­˜æœåŠ¡ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚ æä¾›å®‰å…¨ä¿éšœ åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ä½œä¸ºåº”ç”¨å±‚é˜²ç«å¢™ï¼Œä¸ºç½‘ç«™æä¾›å¯¹åŸºäºWebçš„æ”»å‡»è¡Œä¸ºï¼ˆä¾‹å¦‚DoS/DDoSï¼‰çš„é˜²æŠ¤ï¼Œæ›´å®¹æ˜“æ’æŸ¥æ¶æ„è½¯ä»¶ç­‰ã€‚è¿˜å¯ä»¥ä¸ºåç«¯æœåŠ¡å™¨ç»Ÿä¸€æä¾›åŠ å¯†å’ŒSSLåŠ é€Ÿï¼ˆå¦‚SSLç»ˆç«¯ä»£ç†ï¼‰ï¼Œæä¾›HTTPè®¿é—®è®¤è¯ç­‰ã€‚ ","date":"2023-04-23","objectID":"/%E4%BB%A3%E7%90%86/:0:2","tags":["è®¡ç®—æœºåŸºç¡€","ä»£ç†"],"title":"ä»£ç†","uri":"/%E4%BB%A3%E7%90%86/"},{"categories":["é€šç”¨"],"content":"ä¸‰ã€æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„åŒºåˆ« è™½ç„¶æ­£å‘ä»£ç†æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨æ‰€å¤„çš„ä½ç½®éƒ½æ˜¯å®¢æˆ·ç«¯å’ŒçœŸå®æœåŠ¡å™¨ä¹‹é—´ï¼Œæ‰€åšçš„äº‹æƒ…ä¹Ÿéƒ½æ˜¯æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼Œå†æŠŠæœåŠ¡å™¨çš„å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯äºŒè€…ä¹‹é—´è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®å¼‚çš„ã€‚ 1ã€æ­£å‘ä»£ç†å…¶å®æ˜¯å®¢æˆ·ç«¯çš„ä»£ç†ï¼Œå¸®åŠ©å®¢æˆ·ç«¯è®¿é—®å…¶æ— æ³•è®¿é—®çš„æœåŠ¡å™¨èµ„æºã€‚åå‘ä»£ç†åˆ™æ˜¯æœåŠ¡å™¨çš„ä»£ç†ï¼Œå¸®åŠ©æœåŠ¡å™¨åšè´Ÿè½½å‡è¡¡ï¼Œå®‰å…¨é˜²æŠ¤ç­‰ã€‚ 2ã€æ­£å‘ä»£ç†ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨ä¸Šå®‰è£…ä¸€ä¸ªä»£ç†è½¯ä»¶ã€‚è€Œåå‘ä»£ç†ä¸€èˆ¬æ˜¯æœåŠ¡å™¨æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚ 3ã€æ­£å‘ä»£ç†ä¸­ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯åˆ°åº•æ˜¯è°ï¼Œä»¥ä¸ºè®¿é—®è‡ªå·±çš„å°±æ˜¯çœŸå®çš„å®¢æˆ·ç«¯ã€‚è€Œåœ¨åå‘ä»£ç†ä¸­ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸæ­£çš„æœåŠ¡å™¨æ˜¯è°ï¼Œä»¥ä¸ºè‡ªå·±è®¿é—®çš„å°±æ˜¯çœŸå®çš„æœåŠ¡å™¨ã€‚ 4ã€æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„ä½œç”¨å’Œç›®çš„ä¸åŒã€‚æ­£å‘ä»£ç†ä¸»è¦æ˜¯ç”¨æ¥è§£å†³è®¿é—®é™åˆ¶é—®é¢˜ï¼›è€Œåå‘ä»£ç†åˆ™æ˜¯æä¾›è´Ÿè½½å‡è¡¡ã€å®‰å…¨é˜²æŠ¤ç­‰ä½œç”¨ã€‚äºŒè€…å‡èƒ½æé«˜è®¿é—®é€Ÿåº¦ã€‚ ","date":"2023-04-23","objectID":"/%E4%BB%A3%E7%90%86/:0:3","tags":["è®¡ç®—æœºåŸºç¡€","ä»£ç†"],"title":"ä»£ç†","uri":"/%E4%BB%A3%E7%90%86/"},{"categories":["é¢è¯•"],"content":"[toc] ä¸€äº›æ¯”è¾ƒå¥½çš„æ–‡æ¡£ï¼š https://tanxinyu.work/raft/ https://github.com/OneSizeFitsQuorum/raft-thesis-zh_cn/blob/master/raft-thesis-zh_cn.md https://tanxinyu.work/consistency-and-consensus/ https://tanxinyu.work/zookeeper-thesis/ Zookeeper Etcd https://mp.weixin.qq.com/s/x-AdmN0UN5KT58XWO1BCOA(æœª) ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:0:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"å¸¸è§é¢è¯•é¢˜ RAFT ç®—æ³• ä¸»èŠ‚ç‚¹é€‰ä¸¾è¿‡ç¨‹ï¼Ÿ æ€ä¹ˆä¿è¯ä¸ªèŠ‚ç‚¹çš„ä¸€è‡´æ€§ï¼ŸG ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€åˆ†å¸ƒå¼ç†è®ºå’Œä¸€è‡´æ€§æ¨¡å‹ ==CAP== Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬ï¼› Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ï¼šéæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”ï¼ˆä¸æ˜¯é”™è¯¯æˆ–è€…è¶…æ—¶çš„å“åº”ï¼‰ï¼› Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚ **æ³¨ï¼š**ä»€ä¹ˆæ˜¯ç½‘ç»œåˆ†åŒºï¼Ÿ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹å‰çš„ç½‘ç»œæœ¬æ¥æ˜¯è¿é€šçš„ï¼Œä½†æ˜¯å› ä¸ºæŸäº›æ•…éšœï¼ˆæ¯”å¦‚éƒ¨åˆ†èŠ‚ç‚¹ç½‘ç»œå‡ºäº†é—®é¢˜ï¼‰æŸäº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸï¼Œè¿™å°±å« ç½‘ç»œåˆ†åŒºã€‚ é—®ï¼šæ‰€è°“çš„ â€œ3é€‰2â€ ï¼Ÿ å…¶å®ä¸æ˜¯ä»»æ„çš„ â€œ3é€‰2â€ã€‚ å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½ 2 é€‰ 1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹å P æ˜¯å‰æï¼Œå†³å®šäº† P ä¹‹åæ‰æœ‰ C å’Œ A çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚ ==ç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼š==CAP ç†è®ºä¸­åˆ†åŒºå®¹é”™æ€§ P æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåªèƒ½æ»¡è¶³å¯ç”¨æ€§ A æˆ–è€…ä¸€è‡´æ€§ Cã€‚ å› æ­¤ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œ==åªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„==ã€‚ é—®ï¼šä¸ºå•¥ä¸å¯èƒ½åŒæ—¶æ»¡è¶³ CAP å‘¢ï¼Ÿ é¦–å…ˆï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿè¦ä¿éšœæ•´ä½“çš„æœåŠ¡ï¼Œå°±å¿…é¡»æ‹¥æœ‰åˆ†åŒºå®¹é”™æ€§ Pã€‚ ç„¶åï¼Œå¯ä»¥ä¸¾ä¸ªä¾‹å­ã€‚è‹¥ç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€ï¼Œåˆ†ä¸ºAã€Bï¼š æœ‰å†™è¯·æ±‚è¿›æ¥ï¼Œä¿®æ”¹äº† A ä¸­æŸæ•°æ®ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¦åŒæ­¥ç»™ Bï¼Œä½†åˆ†åŒºçŠ¶æ€ï¼Œå‘ç”ŸåŒæ­¥å¤±è´¥ï¼› æ­¤æ—¶ï¼ŒB æ¥äº†è¯»è¯·æ±‚ï¼Œè¦ä¹ˆä¿è¯ä¸€è‡´æ€§ï¼Œé˜»å¡è¯·æ±‚ï¼Œç­‰å¾…åˆ†åŒºçŠ¶æ€ç»“æŸå†ç»§ç»­æœåŠ¡ï¼›è¦ä¹ˆä¿è¯å¯ç”¨æ€§ï¼Œè¿”å›ç»™æ—§çš„æ•°æ®ã€‚ ==BASE== BASEï¼šBasically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ã€**Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰**å’Œ Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚ **åŸºæœ¬å¯ç”¨ï¼š**æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œä¾‹å¦‚å“åº”æ—¶é—´å˜é•¿ï¼Œç³»ç»Ÿæä¾›çš„åŠŸèƒ½å˜å°‘ç­‰ï¼› **è½¯çŠ¶æ€ï¼š**å…è®¸ç³»ç»Ÿå­˜åœ¨çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´ï¼› æœ€ç»ˆä¸€è‡´æ€§ï¼šç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚ AP æ–¹æ¡ˆåªæ˜¯åœ¨ç³»ç»Ÿå‘ç”Ÿåˆ†åŒºçš„æ—¶å€™æ”¾å¼ƒä¸€è‡´æ€§ï¼Œè€Œä¸æ˜¯æ°¸è¿œæ”¾å¼ƒä¸€è‡´æ€§ã€‚åœ¨åˆ†åŒºæ•…éšœæ¢å¤åï¼Œç³»ç»Ÿåº”è¯¥è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚ ==ä¸€è‡´æ€§æ¨¡å‹== åˆ†å¸ƒå¼ç³»ç»ŸæŒ‰ç…§å¯¹ä¸€è‡´æ€§è¦æ±‚çš„ä¸åŒï¼Œä¸»è¦åˆ†ä¸ºå¼ºä¸€è‡´æ€§ï¼Œå¼±ä¸€è‡´æ€§è¿™ä¸¤å¤§ç±»ï¼Œå‰è€…æ˜¯åŸºäº safety çš„æ¦‚å¿µï¼Œåè€…æ˜¯åŸºäº liveness çš„æ¦‚å¿µã€‚ å¼ºä¸€è‡´æ€§ é¡ºåºä¸€è‡´æ€§ï¼šå¦‚æœä¸€ä¸ªå¹¶å‘æ‰§è¡Œè¿‡ç¨‹æ‰€åŒ…å«çš„æ‰€æœ‰è¯»å†™æ“ä½œèƒ½å¤Ÿé‡æ’æˆä¸€ä¸ªå…¨å±€çº¿æ€§æœ‰åºçš„åºåˆ—ï¼Œå¹¶ä¸”è¿™ä¸ªåºåˆ—æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå¹¶å‘æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ï¼š é‡æ’åçš„åºåˆ—ä¸­æ¯ä¸€ä¸ªè¯»æ“ä½œè¿”å›çš„å€¼ï¼Œå¿…é¡»ç­‰äºå‰é¢å¯¹åŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„æœ€è¿‘ä¸€æ¬¡å†™æ“ä½œæ‰€å†™å…¥çš„å€¼ï¼› åŸæ¥æ¯ä¸ªè¿›ç¨‹ä¸­å„ä¸ªæ“ä½œçš„æ‰§è¡Œå…ˆåé¡ºåºï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­å¿…é¡»ä¿æŒä¸€è‡´ã€‚ **çº¿æ€§ä¸€è‡´æ€§ï¼š**å’Œé¡ºåºä¸€è‡´æ€§å¾ˆç›¸ä¼¼ï¼Œé™¤äº†æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶å¤–ï¼Œè¿˜éœ€è¦æ»¡è¶³ï¼š ä¸åŒè¿›ç¨‹çš„æ“ä½œï¼Œå¦‚æœåœ¨æ—¶é—´ä¸Šä¸é‡å ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œå…ˆåé¡ºåºï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­å¿…é¡»ä¿æŒä¸€è‡´ã€‚ åŒºåˆ«ï¼š çº¿æ€§ä¸€è‡´æ€§è€ƒè™‘äº†æ—¶é—´å…ˆåé¡ºåºï¼Œè€Œé¡ºåºä¸€è‡´æ€§æ²¡æœ‰ã€‚ æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè‚¯å®šéƒ½æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼›åä¹‹ä¸ä¸€å®šã€‚ çº¿æ€§ä¸€è‡´æ€§æ€»æ˜¯èƒ½è¯»åˆ°æœ€æ–°çš„æ•°æ®ï¼Œé¡ºåºä¸€è‡´æ€§æœ‰å¯èƒ½è¯»åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ã€‚ å¼±ä¸€è‡´æ€§ å¼±ä¸€è‡´æ€§æ˜¯æŒ‡ç³»ç»Ÿåœ¨æ•°æ®æˆåŠŸå†™å…¥ä¹‹åï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¼šå…·ä½“æ‰¿è¯ºå¤šä¹…è¯»åˆ°ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åœ¨æŸä¸ªæ—¶é—´çº§åˆ«ä¹‹åï¼Œå¯ä»¥è®©æ•°æ®è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€ã€‚å…¶ä¸­åŒ…æ‹¬äº†æœ€ç»ˆä¸€è‡´æ€§ã€‚ é—®ï¼šé‚£å…±è¯†å’Œä¸€è‡´æ€§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ä¸€è‡´æ€§æŒ‡çš„æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªå‰¯æœ¬å¯¹å¤–å‘ˆç°çš„æ•°æ®çŠ¶æ€ï¼Œæ¯”å¦‚é¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ç­‰ã€‚ å…±è¯†åˆ™æŒ‡çš„æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œå½¼æ­¤å¯¹æŸä¸ªçŠ¶æ€è¾¾æˆä¸€è‡´ç»“æœçš„è¿‡ç¨‹ï¼Œæ¯”å¦‚Paxosã€Raftç­‰ç®—æ³•ã€‚ å› æ­¤ï¼Œä¸€è‡´æ€§æè¿°çš„æ˜¯ç»“æœçŠ¶æ€ï¼Œå…±è¯†åˆ™æ˜¯è¾¾æˆä¸€è‡´æ€§çš„ä¸€ç§æ‰‹æ®µã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"é”™è¯¯ç±»å‹ä¸é”™è¯¯å®¹å¿(Fault Tolerance) åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­å¯èƒ½å‡ºç°çš„é”™è¯¯ä¸»è¦æœ‰ä¸¤ç§ï¼š CF (Crash Fault)ï¼šå®•æœºæ•…éšœï¼Œç³»ç»Ÿä¸­çš„æŸäº›èŠ‚ç‚¹å¯èƒ½å‡ºç°å®•æœºæ•…éšœï¼Œä¸ä¼šå“åº”è¯·æ±‚ï¼Œä½†æ˜¯ä¸ä¼šæ¶æ„å“åº”ï¼› BF (Byzantine Fault): æ‹œå åº­æ•…éšœï¼Œç³»ç»Ÿä¸­çš„æŸäº›èŠ‚ç‚¹å¯èƒ½å‡ºç°æ‹œå åº­æ•…éšœï¼Œå¯èƒ½ä¼šä¸å“åº”è¯·æ±‚ï¼Œä¹Ÿå¯èƒ½é”™è¯¯å“åº”è¯·æ±‚ã€‚ å‡ºç°æ‹œå åº­æ•…éšœçš„èŠ‚ç‚¹æˆ‘ä»¬ç§°ä¸ºæ‹œå åº­èŠ‚ç‚¹ã€‚ èƒ½å¤Ÿå®¹å¿å®•æœºæ•…éšœçš„ç³»ç»Ÿæˆ‘ä»¬ç§°ä¸º CFTï¼ˆCrash Fault Toleranceï¼‰ç³»ç»Ÿï¼› èƒ½å¤Ÿå®¹å¿æ‹œå åº­æ•…éšœçš„ç³»ç»Ÿæˆ‘ä»¬ç§°ä¸º BFTï¼ˆByzantine Fault Toleranceï¼‰ç³»ç»Ÿã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:2:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"äºŒã€Paxos ç®—æ³• æ¦‚è¿° ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š Basic Paxos ç®—æ³•ï¼šæè¿°çš„æ˜¯å¤šèŠ‚ç‚¹ä¹‹é—´å¦‚ä½•å°±æŸä¸ªå€¼(ææ¡ˆ Value)è¾¾æˆå…±è¯†ã€‚ Multi-Paxos æ€æƒ³ï¼šæè¿°çš„æ˜¯æ‰§è¡Œå¤šä¸ª Basic Paxos å®ä¾‹ï¼Œå°±ä¸€ç³»åˆ—å€¼è¾¾æˆå…±è¯†ã€‚Multi-Paxos è¯´ç™½äº†å°±æ˜¯æ‰§è¡Œå¤šæ¬¡ Basic Paxos ï¼Œæ ¸å¿ƒè¿˜æ˜¯ Basic Paxos ã€‚ Basic Paxos ä¸­å­˜åœ¨ 3 ä¸ªé‡è¦çš„è§’è‰²ï¼š æè®®è€…ï¼ˆProposerï¼‰ï¼šä¹Ÿå¯ä»¥å«åšåè°ƒè€…ï¼ˆcoordinatorï¼‰ï¼Œæè®®è€…è´Ÿè´£æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶å‘èµ·ææ¡ˆã€‚ææ¡ˆä¿¡æ¯é€šå¸¸åŒ…æ‹¬ææ¡ˆç¼–å· (Proposal ID) å’Œæè®®çš„å€¼ (Value)ã€‚ æ¥å—è€…ï¼ˆAcceptorï¼‰ï¼šä¹Ÿå¯ä»¥å«åšæŠ•ç¥¨å‘˜ï¼ˆvoterï¼‰ï¼Œè´Ÿè´£å¯¹æè®®è€…çš„ææ¡ˆè¿›è¡ŒæŠ•ç¥¨ï¼ŒåŒæ—¶éœ€è¦è®°ä½è‡ªå·±çš„æŠ•ç¥¨å†å²ï¼› å­¦ä¹ è€…ï¼ˆLearnerï¼‰ï¼šå¦‚æœæœ‰è¶…è¿‡åŠæ•°æ¥å—è€…å°±æŸä¸ªæè®®è¾¾æˆäº†å…±è¯†ï¼Œé‚£ä¹ˆå­¦ä¹ è€…å°±éœ€è¦æ¥å—è¿™ä¸ªæè®®ï¼Œå¹¶å°±è¯¥æè®®ä½œå‡ºè¿ç®—ï¼Œç„¶åå°†è¿ç®—ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ Multi-Paxos æ€æƒ³ï¼š æ€æƒ³çš„æ ¸å¿ƒå°±æ˜¯é€šè¿‡å¤šä¸ª Basic Paxos å®ä¾‹å°±ä¸€ç³»åˆ—å€¼è¾¾æˆå…±è¯†ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼šBasic Paxos æ˜¯ Multi-Paxos æ€æƒ³çš„æ ¸å¿ƒï¼ŒMulti-Paxos å°±æ˜¯å¤šæ‰§è¡Œå‡ æ¬¡ Basic Paxosã€‚ ä¸¤é˜¶æ®µ prepare é˜¶æ®µ Proposerææ¡ˆè€…ï¼šè´Ÿè´£æå‡º proposalã€‚åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ª å…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·å…³è”å…¶è¦æå‡ºçš„ææ¡ˆï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µæ˜¯åªå°†ææ¡ˆç¼–å·å‘é€ç»™æ‰€æœ‰çš„è¡¨å†³è€…ï¼› Acceptorè¡¨å†³è€…ï¼šæ¯ä¸ªè¡¨å†³è€…åœ¨ accept æŸææ¡ˆç¼–å·åï¼Œä¼šå°†è¯¥ææ¡ˆç¼–å·Nè®°å½•åœ¨æœ¬åœ°ï¼Œè¿™æ ·æ¯ä¸ªè¡¨å†³è€…ä¸­ä¿å­˜çš„å·²ç»è¢« accept çš„ææ¡ˆä¸­ä¼šå­˜åœ¨ä¸€ä¸ªç¼–å·æœ€å¤§çš„ææ¡ˆï¼Œå…¶ç¼–å·å‡è®¾ä¸º maxNã€‚æ¯ä¸ªè¡¨å†³è€…ä»…ä¼š accept ç¼–å·å¤§äºè‡ªå·±æœ¬åœ° maxN çš„ææ¡ˆï¼Œåœ¨æ‰¹å‡†ææ¡ˆæ—¶è¡¨å†³è€…ä¼šå°†ä»¥å‰æ¥å—è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™ Proposer ã€‚ accept é˜¶æ®µ å½“Proposeræ”¶åˆ°è¶…è¿‡åŠæ•°çš„Accepterçš„å“åº”åï¼Œå°±ä¼šå‘é€ææ¡ˆçš„å†…å®¹ä¸ç¼–å·ï¼› å½“Accepteræ”¶åˆ°ææ¡ˆå†…å®¹ä¸ç¼–å·åï¼Œè‹¥ææ¡ˆç¼–å·æ˜¯è‡ªå·±æ‰¹å‡†è¿‡çš„æœ€å¤§ç¼–å·ï¼Œé‚£å°±Acceptè¯¥ææ¡ˆã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€RAFT ç®—æ³• åŠ¨æ€æ¼”ç¤º RAFT åªæœ‰ä¸‰ç§ç±»å‹çš„èŠ‚ç‚¹ï¼š **Leaderï¼š**è´Ÿè´£å‘èµ·å¿ƒè·³ï¼Œå“åº”å®¢æˆ·ç«¯ï¼Œåˆ›å»ºæ—¥å¿—ï¼ŒåŒæ­¥æ—¥å¿—ã€‚ Candidateï¼šLeader é€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²ï¼Œç”±Followerè½¬åŒ–è€Œæ¥ï¼Œå‘èµ·æŠ•ç¥¨å‚ä¸ç«é€‰ã€‚ **Followerï¼š**æ¥å—Leaderçš„å¿ƒè·³å’Œæ—¥å¿—åŒæ­¥æ•°æ®ï¼ŒæŠ•ç¥¨ç»™ Candidateã€‚ ä»»æœŸ(Term) RAFT ç®—æ³•åˆ’åˆ†ä»»æ„æ—¶é—´é•¿åº¦çš„ä»»æœŸ(Term)ï¼Œä»»æœŸç”¨è¿ç»­çš„æ•°å­—è¡¨ç¤ºï¼Œçœ‹ä½œå½“å‰ term å·ã€‚ é—®ï¼šTerm å·çš„ä½œç”¨ï¼Ÿ æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨å½“å‰çš„ term å·ï¼Œå½“æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶ä¼šäº¤æ¢å½“å‰çš„ term å·ã€‚ å¦‚æœæœ‰æœåŠ¡å™¨å‘ç°è‡ªå·±çš„ term å·æ¯”å…¶ä»–äººå°ï¼Œé‚£ä¹ˆä»–ä¼šæ›´æ–°åˆ°è¾ƒå¤§çš„ term å€¼ï¼› å¦‚æœä¸€ä¸ª**Candidateæˆ–è€…Leader**å‘ç°è‡ªå·±çš„ term è¿‡æœŸäº†ï¼Œä»–ä¼šç«‹å³é€€å›æˆ Followerï¼› å¦‚æœä¸€å°æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚çš„ term å·æ˜¯è¿‡æœŸçš„ï¼Œé‚£ä¹ˆå®ƒä¼šæ‹’ç»æ­¤æ¬¡è¯·æ±‚ã€‚ æ—¥å¿—(Log) entryï¼šæ¯ä¸€ä¸ªäº‹ä»¶æˆä¸º entryï¼Œåªæœ‰ Leader å¯ä»¥åˆ›å»º entryã€‚entry çš„å†…å®¹ä¸º\u003cterm, index, cmd\u003eï¼Œå…¶ä¸­ cmd æ˜¯å¯ä»¥åº”ç”¨åˆ°çŠ¶æ€æœºçš„æ“ä½œã€‚ logï¼šç”± entry æ„æˆçš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ª entry éƒ½æœ‰ä¸€ä¸ªè¡¨æ˜è‡ªå·±åœ¨ log ä¸­çš„ indexã€‚åªæœ‰ Leader æ‰å¯ä»¥æ”¹å˜å…¶ä»–èŠ‚ç‚¹çš„ logã€‚entry æ€»æ˜¯å…ˆè¢« Leader æ·»åŠ åˆ°è‡ªå·±çš„ log æ•°ç»„ä¸­ï¼Œç„¶åå†å‘èµ·å…±è¯†è¯·æ±‚ï¼Œè·å¾—åŒæ„åæ‰ä¼šè¢« Leader æäº¤ç»™çŠ¶æ€æœºã€‚Follower åªèƒ½ä» Leader è·å–æ–°æ—¥å¿—å’Œå½“å‰çš„ commitIndexï¼Œç„¶åæŠŠå¯¹åº”çš„ entry åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ã€‚ RAFT å¼ºåŒ–äº† Leader çš„åœ°ä½ï¼Œæ—¥å¿—ç®—æ³•åªèƒ½ç”± Leader å¤åˆ¶ç»™å…¶ä»–æˆå‘˜ï¼Œè¿™æ„å‘³ç€æ—¥å¿—å¤åˆ¶æ˜¯å•å‘çš„ï¼ŒLeader ä»ä¸ä¼šè¦†ç›–æœ¬åœ°æ—¥å¿—ï¼Œå³æ‰€æœ‰çš„æ—¥å¿—å‡ä»¥ Leader ä¸ºåŸºå‡†ã€‚ ==Leader é€‰ä¸¾== RAFT ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘Leaderçš„é€‰ä¸¾ã€‚ å¦‚æœä¸€å°æœåŠ¡å™¨èƒ½å¤Ÿæ”¶åˆ°æ¥è‡ªLeaderæˆ–è€…Candidateçš„æœ‰æ•ˆä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒä¼šä¸€ç›´ä¿æŒä¸ºFollowerçŠ¶æ€ï¼Œå¹¶ä¸”åˆ·æ–°è‡ªå·±çš„ electionè®¡æ—¶å™¨ï¼Œé‡æ–°è®¡æ—¶ã€‚ é—®ï¼šé€‰ä¸»è¿‡ç¨‹ï¼Ÿ æ¯ä¸ªFollowerèŠ‚ç‚¹éƒ½ä¿æŒä¸€ä¸ªelectionè®¡æ—¶å™¨ï¼Œå¦‚æœä¸€ä¸ªFolloweråœ¨ä¸€ä¸ªå‘¨æœŸå†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œå°±å«åšé€‰ä¸¾è¶…æ—¶ï¼Œç„¶åå®ƒå°±ä¼šè®¤ä¸ºæ­¤æ—¶æ²¡æœ‰å¯ç”¨çš„ Leaderï¼Œå¹¶ä¸”å¼€å§‹è¿›è¡Œä¸€æ¬¡é€‰ä¸¾ä»¥é€‰å‡ºä¸€ä¸ªæ–°çš„ Leaderï¼š Follower ä¼šè‡ªå¢è‡ªå·±çš„termå·å¹¶ä¸”è½¬æ¢çŠ¶æ€ä¸º Candidate(å€™é€‰è€…)ï¼› ç„¶åä»–ä¼šå‘æ‰€æœ‰èŠ‚ç‚¹å‘èµ·**RequestVoteRPC(æŠ•ç¥¨è¯·æ±‚)ï¼šè‡ªèº«çš„ä»»æœŸ termã€memberIdã€æœ€æ–°æ—¥å¿—(å³æœ€åä¸€ä¸ªEntry)çš„ä»»æœŸ term å’Œ indexã€‚æ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ç¥¨(ä¿è¯æ¯ä¸ªTermè‡³å¤šåªæœ‰ä¸€ä¸ªLeaderï¼Œé¿å…split brain)ï¼Œå¦‚æœå‘ç° å€™é€‰è€…çš„ä»»æœŸ \u003e= è‡ªèº«ä»»æœŸ å¹¶ä¸” å€™é€‰è€…çš„æœ€æ–°æ—¥å¿— \u003e= è‡ªèº«çš„æœ€æ–°æ—¥å¿—ï¼Œåˆ™å›å¤åŒæ„ï¼›è¿™æ ·å¯ä»¥ä¿è¯æ–° leader èŠ‚ç‚¹ä¸€å®šåŒ…å«æœ€æ–°æäº¤çš„æ—¥å¿—**ã€‚ Candidateçš„çŠ¶æ€ä¼šæŒç»­åˆ°ä»¥ä¸‹æƒ…å†µå‘ç”Ÿï¼š èµ¢å¾—é€‰ä¸¾ï¼šæ”¶åˆ°äº†æ¥è‡ªé›†ç¾¤å†…çš„å¤šæ•°é€‰ç¥¨(N/2+1)ï¼› å…¶ä»–èŠ‚ç‚¹èµ¢å¾—é€‰ä¸¾ï¼› ä¸€è½®é€‰ä¸¾ç»“æŸï¼Œæ— äººèƒœå‡ºã€‚ åœ¨Candidateç­‰å¾…é€‰ç¥¨çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å£°æ˜è‡ªå·±æ˜¯Leaderçš„å¿ƒè·³ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§æƒ…å†µï¼š è¯¥Leaderçš„termå·\u003e=è‡ªå·±çš„termå·ï¼Œè¯´æ˜å¯¹æ–¹å·²ç»æˆä¸º Leaderï¼Œåˆ™è‡ªå·±å›é€€ä¸º Followerã€‚ è¯¥Leaderçš„termå·\u003cè‡ªå·±çš„termå·ï¼Œé‚£ä¹ˆä¼šæ‹’ç»è¯¥è¯·æ±‚å¹¶è®©è¯¥èŠ‚ç‚¹æ›´æ–° termã€‚ é—®ï¼šä¼šå‡ºç°é€‰ä¸å‡ºä¸»çš„æƒ…å†µå—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ ä¼šã€‚åŒä¸€æ—¶åˆ»å‡ºç°å¤šä¸ª Candidateï¼Œå¯¼è‡´æ²¡æœ‰Candidateè·å¾—å¤§å¤šæ•°é€‰ç¥¨ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ‰‹æ®µæ¥é‡æ–°åˆ†é…é€‰ç¥¨çš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæ— é™é‡å¤ä¸‹å»ã€‚ RAFT é€šè¿‡éšæœºçš„electionæ—¶é—´æ¥ç¼“è§£è¿™ä¸€é—®é¢˜ï¼šæ¯ä¸€ä¸ªCandidateåœ¨å‘èµ·é€‰ä¸¾åï¼Œéƒ½ä¼šéšæœºåŒ–ä¸€ä¸ªæ–°çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œä¸€æ—¦è¶…æ—¶åè¿˜æ²¡å®Œæˆé€‰ä¸¾ï¼Œåˆ™è‡ªå¢è‡ªå·±çš„Termï¼Œç„¶åå‘èµ·æ–°ä¸€è½®çš„é€‰ä¸¾(Term è¾ƒå¤§çš„æœ‰æ›´å¤§çš„æ¦‚ç‡å‹å€’å…¶ä»–èŠ‚ç‚¹)ã€‚è¿™ç§æœºåˆ¶ä½¿å¾—å„ä¸ªæœåŠ¡å™¨èƒ½å¤Ÿåˆ†æ•£å¼€æ¥ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¼šç‡å…ˆè¶…æ—¶ï¼›å®ƒä¼šåœ¨å…¶ä»–æœåŠ¡å™¨è¶…æ—¶ä¹‹å‰èµ¢å¾—é€‰ä¸¾ã€‚ ==æ—¥å¿—å¤åˆ¶== é—®ï¼šæ—¥å¿—å¤åˆ¶çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ ä¸€æ—¦é€‰å‡ºLeaderï¼Œå®ƒå°±è´Ÿè´£æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½åŒ…å«ä¸€æ¡éœ€è¦è¢«å¤åˆ¶çŠ¶æ€æœºï¼ˆReplicated State Mechineï¼‰æ‰§è¡Œçš„å‘½ä»¤ï¼› Leader æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œä¼šç”Ÿæˆä¸€ä¸ª entryï¼ŒåŒ…å«\u003cindex, term, cmd\u003eï¼Œå†å°†è¿™ä¸ªentryæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—æœ«å°¾å( Append Entries)ï¼› ç„¶å Leader ä¼šç”Ÿæˆæ—¥å¿—å¤åˆ¶è¯·æ±‚ï¼ŒåŒ…å«æœ¬æ¬¡å¾…å¤åˆ¶çš„æ—¥å¿—åˆ—è¡¨(æ–°çš„entry)ã€ä¸Šä¸€æ¡æ—¥å¿—(å·²æäº¤çš„æœ€åä¸€ä¸ªentry)ç­‰ä¿¡æ¯ï¼Œå¹¶è¡Œåœ°å‘æ‰€æœ‰ä»èŠ‚ç‚¹å¹¿æ’­è¯¥è¯·æ±‚ï¼› Followeræ”¶åˆ°æ—¥å¿—å¤åˆ¶è¯·æ±‚åï¼š å¦‚æœå‘ç° leader çš„ä»»æœŸ \u003e= è‡ªèº«ä»»æœŸ å¹¶ä¸” æ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥ é€šè¿‡ï¼Œå°±æ¥å—å¾…å¤åˆ¶çš„æ—¥å¿—åˆ—è¡¨ï¼ŒåŒæ—¶è¿”å›ç»™LeaderåŒæ„ï¼› å¦åˆ™ï¼Œè¿”å›æ‹’ç»ã€‚ å¦‚æœLeaderæ”¶åˆ°äº†å¤šæ•°çš„æˆåŠŸå“åº”ï¼ŒLeader ä¼šå°†è¿™ä¸ªentryåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼Œä¹‹åå¯ä»¥è®¤ä¸ºè¿™ä¸ªentryæ˜¯ committed çš„ï¼Œå¹¶ä¸”å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡Œç»“æœã€‚ ==RAFT ä¿è¯ä»¥ä¸‹ä¸¤ä¸ªæ€§è´¨ï¼š== åœ¨ä¸¤ä¸ªæ—¥å¿—é‡Œï¼Œæœ‰ä¸¤ä¸ª entry æ‹¥æœ‰ç›¸åŒçš„ index å’Œ termï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€å®šæœ‰ç›¸åŒçš„ cmdã€‚ åœ¨ä¸¤ä¸ªæ—¥å¿—é‡Œï¼Œæœ‰ä¸¤ä¸ª entry æ‹¥æœ‰ç›¸åŒçš„ index å’Œ termï¼Œé‚£ä¹ˆå®ƒä»¬å‰é¢çš„ entry ä¹Ÿä¸€å®šç›¸åŒ ç¬¬ä¸€æ¡é€šè¿‡**åªæœ‰Leaderæ‰èƒ½ç”Ÿæˆentryæ¥ä¿è¯ï¼›ç¬¬äºŒæ¡é€šè¿‡ä¸€è‡´æ€§æ£€æŸ¥**æ¥ä¿è¯ã€‚ é—®ï¼šä¸€è‡´æ€§æ£€æŸ¥çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ/å¦‚ä½•ä¿è¯èŠ‚ç‚¹ä¸€è‡´æ€§ï¼Ÿâ­â­ leader åœ¨é€šè¿‡AppendEntriesRPCå’Œfolloweré€šè®¯æ—¶ï¼Œä¼šæºå¸¦**ä¸Šä¸€ä¸ªentry **çš„ä¿¡æ¯ï¼› followeråœ¨æ”¶åˆ°åä¼šå¯¹æ¯”è‡ªå·±çš„æ—¥å¿—ï¼šå¦‚æœå‘ç°è¿™ä¸ªentryçš„ä¿¡æ¯(indexã€term)å’Œè‡ªå·±æ—¥å¿—å†…çš„ä¸åŒ¹é…ï¼Œåˆ™ä¼šæ‹’ç»è¯¥è¯·æ±‚ï¼› ä¸€æ—¦leaderå‘ç°æœ‰followeræ‹’ç»äº†è¯·æ±‚ï¼Œåˆ™ä¼šä¸è¯¥followerä¸æ–­è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œç›´åˆ°æ‰¾åˆ°åŒæ–¹æœ€å¤§çš„å…±è¯†ç‚¹ï¼Œç„¶åç”¨leaderçš„entriesè®°å½•è¦†ç›–followeråœ¨æœ€å¤§å…±è¯†ç‚¹ä¹‹åçš„æ‰€æœ‰æ•°æ®ã€‚ è¿™æ ·ï¼Œä¸»ä»èŠ‚ç‚¹å°±ä¸€è‡´äº†ã€‚ é—®ï¼šä¸€è‡´æ€§æ£€æŸ¥å¤±æ•ˆçš„æƒ…å†µï¼Ÿå¦‚ä½•è§£å†³å‘¢ï¼Ÿ åœ¨å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œä¸åŒåˆ†åŒºAã€Bå°±ä¼šå‡ºç°ä¸åŒçš„Leaderï¼Œç„¶åä¸¤ä¸ªåˆ†åŒºå°±æœ‰å¯èƒ½å‡ºç°æ—¥å¿—ä¸ä¸€è‡´(å› ä¸ºæ²¡åŠæ³•åŒæ­¥äº†å‘€)ï¼Œä¾‹å¦‚ï¼š å¦‚æœåˆ†åŒºçŠ¶æ€ç»“æŸï¼Œé‡æ–°åˆå¹¶ä¸ºä¸€ä¸ªåŒºï¼ŒTermå·å°çš„èŠ‚ç‚¹å°±ä¼šæ‰¾åˆ°å’Œ**Termå¤§çš„èŠ‚ç‚¹**çš„æ—¥å¿—ä¸­æœ€åä¸€ä¸ªç›¸åŒçš„entryï¼Œå¹¶å›æ»šè¯¥ä½ç½®ä¹‹åçš„æ‰€æœ‰entryï¼Œç„¶åå¤åˆ¶Termå¤§çš„èŠ‚ç‚¹çš„æ—¥å¿—Appendåˆ°åé¢ï¼Œæ­¤æ—¶æ‰€æœ‰èŠ‚ç‚¹çš„æ—¥å¿—å°±ä¸€è‡´äº†ã€‚ é—®ï¼šå‚åŠ é€‰ä¸¾çš„èŠ‚ç‚¹æœ‰æ²¡æœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ **Leader éœ€è¦ä¿è¯è‡ªå·±å­˜å‚¨å…¨éƒ¨å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚**è¿™æ ·æ‰å¯ä»¥ä½¿æ—¥å¿—æ¡ç›®åªæœ‰ä¸€ä¸ªæµå‘ï¼šä» Leader æµå‘ Followerï¼ŒLeader æ°¸è¿œä¸ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ã€‚ **æ¯ä¸ª Candidate å‘é€ RequestVoteRPC æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šæœ€åä¸€ä¸ª entry çš„ä¿¡æ¯ã€‚**æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨ä¿¡æ¯æ—¶ï¼Œä¼šå¯¹è¯¥ entry è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°è‡ªå·±çš„æ›´æ–°ï¼Œåˆ™æ‹’ç»æŠ•ç¥¨ç»™è¯¥ Candidateã€‚ **åˆ¤æ–­æ—¥å¿—æ–°æ—§çš„æ–¹å¼ï¼š**å¦‚æœä¸¤ä¸ªæ—¥å¿—çš„ term ä¸åŒï¼Œterm å¤§çš„æœ€æ–°ï¼›å¦‚æœ term ç›¸åŒï¼Œindex å¤§çš„æœ€æ–°ã€‚ é—®ï¼šèŠ‚ç‚¹å´©æºƒä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ LeaderèŠ‚ç‚¹å´©æºƒï¼šé›†ç¾¤ä¸­çš„èŠ‚ç‚¹åœ¨electionTimeoutæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°Leaderçš„å¿ƒè·³ä¿¡æ¯å°±ä¼šè§¦å‘æ–°ä¸€è½®çš„é€‰ä¸»ï¼Œåœ¨é€‰ä¸»æœŸé—´æ•´ä¸ªé›†ç¾¤å¯¹å¤–æ˜¯ä¸å¯ç”¨çš„ï¼› Followerã€CandidateèŠ‚ç‚¹å´©æºƒï¼šé‚£ä¹ˆå‘é€ç»™å®ƒçš„ RequestVoteRPC å’Œ AppendEntriesRPC ä¼šå¤±è´¥ï¼Œä½†ç”±äº raft çš„æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥å¤±è´¥çš„è¯ä¼šæ— é™çš„é‡è¯•ã€‚å¦‚æœå´©æºƒæ¢å¤åï¼Œå°±å¯ä»¥æ”¶åˆ°æ–°çš„è¯·æ±‚ï¼Œç„¶åé€‰æ‹©è¿½åŠ æˆ–è€…æ‹’ç» entryã€‚ é—®ï¼šRAFT ä¸­çš„å„ç§æ—¶é—´è®¾ç½®ï¼Ÿ broadcastTime \u003c\u003c electionTimeout \u003c\u003c MTBF broadcastTimeï¼šå‘å…¶ä»–èŠ‚ç‚¹å¹¶å‘å‘é€æ¶ˆæ¯çš„å¹³å‡å“åº”æ—¶é—´ï¼› electionTimeoutï¼šé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼› MTBF(mean time between failures)ï¼šå•å°æœºå™¨çš„å¹³å‡å¥åº·æ—¶é—´ï¼› broadcastTimeåº”è¯¥æ¯”electionTimeoutå°ä¸€ä¸ªæ•°é‡çº§ï¼Œä¸ºçš„æ˜¯ä½¿Leaderèƒ½å¤ŸæŒç»­å‘é€å¿ƒè·³ä¿¡æ¯ï¼ˆheartbeatï¼‰æ¥é˜»æ­¢Followerå¼€å§‹é€‰ä¸¾ï¼› electionTimeoutä¹Ÿè¦æ¯”MTBFå°å‡ ä¸ªæ•°é‡çº§ï¼Œä¸ºçš„æ˜¯ä½¿å¾—ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚å½“Leaderå´©æºƒæ—¶ï¼Œå¤§çº¦ä¼šåœ¨æ•´ä¸ªelectionTimeoutçš„æ—¶é—´å†…ä¸å¯ç”¨ã€‚æˆ‘ä»¬å¸Œæœ›è¿™ç§æƒ…å†µä»…å å…¨éƒ¨æ—¶é—´çš„å¾ˆå°ä¸€éƒ¨åˆ†ã€‚ ç”±äºbroadcastTimeå’ŒMTBFæ˜¯ç”±ç³»ç»Ÿå†³å®šçš„å±æ€§ï¼Œå› æ­¤éœ€è¦å†³å®šelectionTimeoutçš„æ—¶é—´ã€‚ ä¸€èˆ¬æ¥è¯´ï¼ŒbroadcastTime ä¸€èˆ¬ä¸º 0.5ï½20msï¼ŒelectionTimeout å¯ä»¥è®¾ç½®ä¸º 150ï½300msï¼ŒMTBF ä¸€èˆ¬ä¸ºä¸€ä¸¤ä¸ªæœˆã€‚ æ—¥å¿—å‹ç¼© åŒå…¶ä»–ç³»ç»Ÿä¸€æ ·ï¼Œæ—¥å¿—æ€»ä¸èƒ½æ— é™åˆ¶çš„å¢é•¿ï¼Œè¿™æ ·ä¸ä»…ä¼šå¯¼è‡´æ—¥å¿—æ–‡ä»¶å¾ˆå¤§ï¼Œè¿˜ä¼šå¯¼è‡´æ¢å¤æ•°æ®æ—¶æ‰§è¡Œæ—¥å¿—çš„æ—¶é—´å¾ˆé•¿ã€‚å› æ­¤ï¼Œéœ€è¦å®šæ—¶çš„å¿«ç…§(snapshot)ã€‚snapsh","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:4:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"å››ã€PBFT ç®—æ³• å‚è€ƒæ–‡ç« ï¼š https://chenquan.me/posts/pbft-key-points/ https://learnblockchain.cn/2019/08/29/pbft https://sammyne.github.io/pbft/ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ç®€ä»‹ PBFT æ˜¯ Practical Byzantine Fault Tolerance çš„ç¼©å†™ï¼Œæ„ä¸ºå®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•ã€‚ è¯¥ç®—æ³•é¦–æ¬¡å°†æ‹œå åº­å®¹é”™ç®—æ³•å¤æ‚åº¦ä»æŒ‡æ•°çº§é™ä½åˆ°äº†å¤šé¡¹å¼çº§ï¼Œå…¶å¯ä»¥åœ¨æ¶æ„èŠ‚ç‚¹ä¸é«˜äºæ€»æ•° 1/3 çš„æƒ…å†µä¸‹åŒæ—¶ä¿è¯å®‰å…¨æ€§ï¼ˆSafetyï¼‰å’Œæ´»æ€§ï¼ˆLivenessï¼‰ã€‚ çº¦å®šå˜é‡ é›†ç¾¤æ•°é‡å®šä¹‰ä¸º Nï¼Œå…¶æ•°é‡å®šä¹‰ä¸º âˆ£Nâˆ£=n æ‹œå åº­æˆ–è€…æ˜¯å®•æœºèŠ‚ç‚¹é›†åˆä¸ºå®šä¹‰ä¸º Fï¼Œå…¶æ•°é‡å®šä¹‰ä¸º âˆ£Fâˆ£=f quorum æ³•å®šæˆå‘˜é›†åˆQï¼Œå³æ¯æ¬¡è®¿é—®çš„èŠ‚ç‚¹æ•°é‡âˆ£Qâˆ£ æœ¯è¯­ Primary: ä¸»èŠ‚ç‚¹ Replica: å‰¯æœ¬èŠ‚ç‚¹ Client: å®¢æˆ·ç«¯ï¼Œç”¨äºå‘å…±è¯†é›†ç¾¤å‘é€æ¶ˆæ¯ï¼Œè¯·æ±‚å…±è¯† View: è§†å›¾ï¼ŒPrimary å’Œ Replica å…±åŒè¾¾æˆçš„ä¸€ä¸ªçŠ¶æ€è§†å›¾ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½åŸºäºæŸä¸ªè§†å›¾è¿›è¡Œå…±è¯† Sequence Numberï¼šåºåˆ—å·ï¼Œç”±ä¸»èŠ‚ç‚¹ç”Ÿæˆçš„åºåˆ—å·ï¼Œç”¨äºæ ‡è¯†å…±è¯†è½®æ¬¡ Check Point: æ£€æŸ¥ç‚¹ï¼Œå¦‚æœæŸä¸ªåºåˆ—å·è¢«ç¡®è®¤ï¼Œåˆ™æˆä¸ºæ£€æŸ¥ç‚¹ Stable checkpoint: ç¨³å®šæ£€æŸ¥ç‚¹ï¼Œè¯¥æ£€æŸ¥ç‚¹é€šå¸¸ä¼šè¢«æŒä¹…åŒ– N \u003e 3f + 1 è¿™é‡Œå…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éœ€è¦è¯»å†™å¤šå°‘å°èŠ‚ç‚¹æ‰å¯ä»¥æ»¡è¶³æ­£ç¡®æ€§è¦æ±‚ï¼Œå³ quorum çš„å€¼ä¸ºå¤šå°‘æ¯”è¾ƒåˆé€‚ï¼Ÿ å…ˆç»™å‡ºç»“è®ºï¼š åœ¨ CFT ç³»ç»Ÿä¸­ï¼Œåªéœ€è¦è¾¾åˆ°2f + 1å°±å¯ä»¥äº†ï¼› åœ¨ BFT ç³»ç»Ÿä¸­ï¼Œå°±éœ€è¦è¾¾åˆ°3f + 1æ‰è¡Œï¼Œå› ä¸ºæ˜¯å…è®¸åŒæ—¶å­˜åœ¨æ•…éšœèŠ‚ç‚¹å’Œæ‹œå åº­èŠ‚ç‚¹çš„ã€‚ ç»™å‡ºåˆ†æï¼š èŠ‚ç‚¹æ€»æ•°æ˜¯nï¼Œå…¶ä¸­ä½œæ¶èŠ‚ç‚¹æœ‰fï¼Œé‚£ä¹ˆå‰©ä¸‹çš„æ­£ç¡®èŠ‚ç‚¹ä¸ºn - fï¼Œæ„å‘³ç€åªè¦æ”¶åˆ°n - fä¸ªæ¶ˆæ¯å°±èƒ½åšå‡ºå†³å®šï¼Œä½†æ˜¯è¿™n - fä¸ªæ¶ˆæ¯æœ‰å¯èƒ½æœ‰fä¸ªæ˜¯ç”±ä½œæ¶èŠ‚ç‚¹å†’å……çš„ï¼Œé‚£ä¹ˆæ­£ç¡®çš„æ¶ˆæ¯å°±æ˜¯n - f - fä¸ªï¼Œä¸ºäº†å¤šæ•°ä¸€è‡´ï¼Œæ­£ç¡®æ¶ˆæ¯å¿…é¡»å å¤šæ•°ï¼Œä¹Ÿå°±æ˜¯ n - f - f \u003e fï¼Œä½†æ˜¯èŠ‚ç‚¹å¿…é¡»æ˜¯æ•´æ•°ä¸ªï¼Œæ‰€ä»¥ n æœ€å°‘æ˜¯ 3f + 1 ä¸ªã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ç®—æ³•æµç¨‹ çº¦å®šç¬¦å· iï¼šèŠ‚ç‚¹ID(replica id)ï¼Œåº”è¯¥æ˜¯åœ¨ [0, Nâˆ’1] èŒƒå›´å†…çš„å€¼ï¼› v#ï¼šè§†å›¾ç¼–å·(view number)ï¼Œåˆå§‹ä¸ºé›¶ï¼Œç”¨ v# è¡¨ç¤ºï¼› Primaryï¼šä¸»èŠ‚ç‚¹ï¼Œé€šå¸¸é‡‡ç”¨æ¨¡è¿ç®—å–å¾—: Primary = v# mod Nï¼› mï¼šå³æœ¬è½®å…±è¯†çš„å…·ä½“æ“ä½œï¼Œå¯ä»¥æ˜¯æ•°æ®åº“æ“ä½œï¼Œä¹Ÿå¯ä»¥æ˜¯åŒºå—å†™å…¥æ“ä½œï¼› d(m)ï¼šæ˜¯mçš„æ‘˜è¦ä¿¡æ¯(digest)ï¼› seq# ä¸º sequence numberï¼› logï¼šæ“ä½œæ—¥å¿—ï¼Œé€šå¸¸è®°å½•äº†å½“å‰æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå½¢å¼ä¸º \u003cv#, seq#, status, d\u003e status ä¸º pre-prepared ã€preparedæˆ–è€…æ˜¯committedï¼› æ¶ˆæ¯ç»“æ„ è¿™é‡Œåˆ—å‡ºäº†ä¸‰é˜¶æ®µåè®®ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ï¼Œå…¶ä¸­åªæœ‰ PRE-PREPARE æ¶ˆæ¯åŒ…å«æ–°ç”Ÿæˆçš„åŒºå—ï¼Œå…¶ä»–æ¶ˆæ¯åˆ™ä¸»è¦åŒ…å«ä¸€äº› idã€sequence numberã€åŒºå—æ‘˜è¦å’Œç­¾åç­‰ä¿¡æ¯ã€‚ æ ¸å¿ƒè¿‡ç¨‹ STEP 1: å®¢æˆ·ç«¯å‘é€è¯·æ±‚ç»™ä¸»èŠ‚ç‚¹(æˆ–è€…å‘ç»™æ‰€æœ‰èŠ‚ç‚¹)ï¼Œä¹‹åä¸»èŠ‚ç‚¹å°†ä¼šè§¦å‘ä¸‰é˜¶æ®µåè®®ã€‚è¿™é‡Œå¯ä»¥æœ‰ä¸€ä¸ªä¼˜åŒ–ï¼ŒèŠ‚ç‚¹å¯ä»¥å…ˆæŠŠè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œç­‰åˆ°æ”’å¤Ÿä¸€å †è¯·æ±‚ä¹‹åå†ä¸€èµ·å‘é€ï¼Œè¿™æ ·å¯ä»¥é™ä½ç½‘ç»œå¼€é”€å’Œç³»ç»Ÿè´Ÿè½½ã€‚ STEP 2: ä¸»èŠ‚ç‚¹æ”¶åˆ°å®¢æˆ·ç«¯å‘é€æ¥çš„æ¶ˆæ¯åï¼Œæ„é€ pre-prepareæ¶ˆæ¯ç»“æ„ä½“ \u003c\u003cPRE-PREPARE, v#, seq#, d, sig\u003e, m\u003e (p)ï¼Œå…¶ä¸­ (p) è¡¨ç¤ºç”±ä¸»èŠ‚ç‚¹å‘å‡ºï¼Œdæ˜¯å½“å‰æ¶ˆæ¯æ‘˜è¦ï¼Œmä¸ºåŸå§‹æ¶ˆæ¯ï¼Œsig ä¸ºdçš„æ•°å­—ç­¾å PRE-PREPAREæ ‡è¯†å½“å‰æ¶ˆæ¯æ‰€å¤„çš„åè®®é˜¶æ®µï¼› v#æ ‡è¯†å½“å‰è§†å›¾ç¼–å·ï¼› seq#ä¸ºä¸»èŠ‚ç‚¹å¹¿æ’­æ¶ˆæ¯çš„ä¸€ä¸ªå”¯ä¸€é€’å¢åºå·ï¼› dä¸ºmçš„æ¶ˆæ¯æ‘˜è¦ï¼› sig ä¸ºdçš„æ•°å­—ç­¾åï¼› mä¸ºå®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯ã€‚ STEP 3: ä»èŠ‚ç‚¹æ£€æŸ¥ä¸»èŠ‚ç‚¹å‘é€çš„ pre-prepare æ¶ˆæ¯ï¼Œæ£€æŸ¥é€šè¿‡ä¼šå­˜å‚¨åœ¨æœ¬èŠ‚ç‚¹æ—¥å¿—ã€‚æ£€æŸ¥é€šè¿‡ä¼šè¿›å…¥PREPAREçŠ¶æ€ï¼Œå¹¿æ’­æ¶ˆæ¯\u003cPREPARE, v#, seq#, d, i,\u003e (i)ï¼Œå…¶ä¸­ (i) æ ‡è¯†ä»ièŠ‚ç‚¹å‘å‡ºã€‚æ¶ˆæ¯çš„æœ‰æ•ˆæ€§æ£€æŸ¥è¿‡ç¨‹å¦‚ä¸‹ï¼š æ£€æŸ¥æ”¶åˆ°çš„æ¶ˆæ¯ä½“ä¸­æ‘˜è¦dï¼Œæ˜¯å¦å’Œè‡ªå·±å¯¹mç”Ÿæˆçš„æ‘˜è¦ä¸€è‡´ï¼Œç¡®ä¿æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚ æ£€æŸ¥v#æ˜¯å¦å’Œå½“å‰è§†å›¾v#ä¸€è‡´ã€‚ æ£€æŸ¥åºå·seq#æ˜¯å¦åœ¨æ°´çº¿hå’ŒHä¹‹é—´ï¼Œé¿å…å¿«é€Ÿæ¶ˆè€—å¯ç”¨åºå·ã€‚ æ£€æŸ¥ä¹‹å‰æ˜¯å¦æ¥æ”¶è¿‡ç›¸åŒåºå·seq#å’Œv#ï¼Œä½†æ˜¯æ‘˜è¦dä¸åŒçš„æ¶ˆæ¯ã€‚ STEP 4: æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°PREPAREæ¶ˆæ¯åï¼ŒåŒæ ·ä¹Ÿä¼šå¯¹æ¶ˆæ¯è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å†…å®¹ä¹Ÿæ˜¯ STEP3 ä¸­çš„1, 2, 3, 4ã€‚ å½“æ”¶åˆ°2f(åŒ…æ‹¬è‡ªå·±)ä¸ªæ£€æŸ¥é€šè¿‡ä¸”ä¸€è‡´çš„PREPAREæ¶ˆæ¯åï¼Œä¼šè¿›å…¥COMMITé˜¶æ®µï¼Œå¹¶ä¸”å¹¿æ’­æ¶ˆæ¯\u003cCOMMIT, v#, seq#, d, i\u003e (i) 2f-1 ä¸ªä»å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°çš„prepareæ¶ˆæ¯(ä¸åŒ…æ‹¬è‡ªå·±çš„)ã€‚è¿™é‡Œæ˜¯å› ä¸ºä¸»èŠ‚ç‚¹ä¸ä¼šå†å‘é€prepareæ¶ˆæ¯ï¼Œå› æ­¤æ”¶åˆ°2f-1ä¸ªprepareï¼ŒåŠ ä¸Šä¸»èŠ‚ç‚¹çš„pre-prepareï¼Œä»¥åŠè‡ªå·±çš„prepareï¼Œå°±æ˜¯2f+1ä¸ªäº†ï¼› STEP 5: æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°COMMITæ¶ˆæ¯åï¼ŒåŒæ ·ä¹Ÿä¼šå¯¹æ¶ˆæ¯è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å†…å®¹ä¹Ÿæ˜¯ STEP3 ä¸­çš„1, 2, 3, 4ã€‚ å½“æ”¶åˆ°2f+1(åŒ…æ‹¬è‡ªå·±)ä¸ªæ£€æŸ¥é€šè¿‡ä¸”ä¸€è‡´çš„COMMITæ¶ˆæ¯åï¼Œè¿›å…¥committed-localçŠ¶æ€ï¼ŒæŒ‰ç…§mä¸­çš„è¯·æ±‚é¡ºåºæ‰§è¡Œæ“ä½œã€‚ æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰€æœ‰èŠ‚ç‚¹å°†å‘é€ç»“æœç»™åˆ°å®¢æˆ·ç«¯ã€‚ STEP 6: å®¢æˆ·ç«¯æ”¶åˆ°è¶…è¿‡2f+1çš„ä¸€è‡´æ¶ˆæ¯åˆ™ç¡®è®¤å½“å‰ç»“æœæˆåŠŸ æ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦è¦æ±‚æ‰€æœ‰çš„æ¶ˆæ¯æ˜¯æœ‰åºåˆ°è¾¾çš„ï¼Œå› ä¸ºseq#ä¼šä¿è¯é¡ºåºï¼Œåªéœ€è¦å¯¹åº”çš„pre-prepareï¼Œprepareå’Œcommitæ¶ˆæ¯éƒ½æ˜¯å®Œæ•´çš„å³å¯ã€‚ ä¸€ç§ä¼˜åŒ–æµç¨‹ ä»¥ä¸‹æ˜¯åŸºäºå…¬å¼€èµ„æ–™æ”¶é›†çš„ Hyperchain ä¼˜åŒ–ä¹‹åçš„ RBFT ç®—æ³• ä¸»è¦ä¼˜åŒ–ç‚¹ï¼š å®¢æˆ·ç«¯å¯ä»¥å‘é€è¯·æ±‚åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯ä¸»èŠ‚ç‚¹çš„è¯ï¼Œå°†ä¼šè¿›è¡Œä¸€æ¬¡å¹¿æ’­ï¼›(ç±»ä¼¼è¯»å†™åˆ†ç¦») ä¸»èŠ‚ç‚¹æ”¶åˆ°äº¤æ˜“ä¹‹åä¼šå…ˆè¿›è¡ŒéªŒè¯ï¼Œå¹¶æŠŠéªŒè¯ç»“æœæ”¾åœ¨pre-prepareä¸­ï¼Œå¹¶ä¸”pre-prepareæ˜¯ä»¥åŒºå—ä¸ºå•ä½å¤„ç†çš„ï¼Œè¿™æ ·çš„ pre-prepare æ¶ˆæ¯ä¸­æ—¢åŒ…å«äº†æ’å¥½åºçš„äº¤æ˜“ä¿¡æ¯ä¹ŸåŒ…å«äº†åŒºå—éªŒè¯ç»“æœï¼› ä»èŠ‚ç‚¹æ”¶åˆ°pre-prepareåï¼Œä¹Ÿæ˜¯å…ˆéªŒè¯æ¶ˆæ¯çš„åˆæ³•æ€§ï¼Œç„¶åå¹¿æ’­prepareã€‚ä¸åŒçš„æ˜¯ï¼Œåœ¨æ”¶åˆ°2fä¸ªprepareåä¼šå¯¹åŒºå—å†…å®¹è¿›è¡ŒéªŒè¯ï¼Œå¹¶ä¸pre-prepareä¸­çš„éªŒè¯ç»“æœå¯¹æ¯”ï¼Œè‹¥ä¸€è‡´ï¼Œåˆ™å¹¿æ’­ commit è¡¨æ˜æœ¬èŠ‚ç‚¹åŒæ„ä¸»èŠ‚ç‚¹çš„éªŒè¯ç»“æœï¼›è‹¥ä¸ä¸€è‡´ï¼Œç›´æ¥å‘èµ· view-change è¡¨æ˜æœ¬èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹å­˜åœ¨å¼‚å¸¸è¡Œä¸ºï¼Œéœ€è¦åˆ‡æ¢ä¸»èŠ‚ç‚¹ã€‚ RBFT å…·ä½“æµç¨‹ï¼š **äº¤æ˜“è½¬å‘é˜¶æ®µï¼š**å®¢æˆ·ç«¯å°†äº¤æ˜“å‘é€åˆ°åŒºå—é“¾ä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å…±è¯†èŠ‚ç‚¹ä¸è®°è´¦èŠ‚ç‚¹ï¼‰ï¼Œå…¶ä¸­è®°è´¦èŠ‚ç‚¹åœ¨æ”¶åˆ°äº¤æ˜“åä¼šä¸»åŠ¨è½¬å‘ç»™ä¸å…¶ç›¸è¿çš„å…±è¯†èŠ‚ç‚¹ï¼›è€Œå…±è¯†èŠ‚ç‚¹åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„äº¤æ˜“åå°†å…¶å¹¿æ’­ç»™å…¶ä»–å…±è¯†èŠ‚ç‚¹ï¼Œè¿™æ ·æ‰€æœ‰å…±è¯†èŠ‚ç‚¹çš„äº¤æ˜“æ± ä¸­éƒ½ä¼šç»´æŠ¤ä¸€ä»½å®Œæ•´çš„äº¤æ˜“åˆ—è¡¨ï¼› å…±è¯†èŠ‚ç‚¹å°±æ˜¯å‚ä¸RBFTå…±è¯†è¿‡ç¨‹çš„èŠ‚ç‚¹ï¼Œè®°è´¦èŠ‚ç‚¹æ˜¯ä¸å‚ä¸å…±è¯†ï¼Œåªæ¥å—ç»“æœå¹¶å†™å…¥åŒºå—çš„èŠ‚ç‚¹ PrePrepare é˜¶æ®µï¼šä¸»èŠ‚ç‚¹æŒ‰ç…§å¦‚ä¸‹ç­–ç•¥è¿›è¡Œæ‰“åŒ…ï¼šç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰æ‰“åŒ…çš„è¶…æ—¶æ—¶é—´ï¼ˆbatch timeoutï¼‰ä¸æ‰“åŒ…çš„æœ€å¤§åŒºå—å¤§å°ï¼ˆbatch sizeï¼‰ï¼Œä¸»èŠ‚ç‚¹åœ¨è¶…æ—¶æ—¶é—´å†…æ”¶é›†åˆ°äº†è¶³å¤Ÿå¤šï¼ˆè¶…è¿‡æœ€å¤§åŒºå—å¤§å°ä¸ªæ•°ï¼‰çš„äº¤æ˜“æˆ–è€…è¶…æ—¶æ—¶é—´åˆ°è¾¾åä»æœªæ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„äº¤æ˜“éƒ½ä¼šè§¦å‘ä¸»èŠ‚ç‚¹çš„æ‰“åŒ…äº‹ä»¶ã€‚ä¸»èŠ‚ç‚¹å°†äº¤æ˜“æŒ‰ç…§æ¥æ”¶çš„æ—¶é—´é¡ºåºæ‰“åŒ…æˆå—ï¼Œå¹¶è¿›è¡ŒéªŒè¯ï¼Œè®¡ç®—æ‰§è¡Œç»“æœï¼Œæœ€åå°†å®šå¥½åºçš„äº¤æ˜“ä¿¡æ¯è¿åŒéªŒè¯ç»“æœç­‰å†™å…¥ pre-prepare æ¶ˆæ¯ä¸­ï¼Œå¹¿æ’­ç»™æ‰€æœ‰å…±è¯†èŠ‚ç‚¹ï¼Œå¼€å§‹ä¸‰é˜¶æ®µå¤„ç†æµç¨‹ï¼› Prepare é˜¶æ®µï¼š ä»èŠ‚ç‚¹åœ¨æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„ pre-prepare æ¶ˆæ¯åï¼Œé¦–å…ˆè¿›è¡Œæ¶ˆæ¯åˆæ³•æ€§æ£€æŸ¥ï¼Œæ£€æŸ¥å½“å‰çš„è§†å›¾ä¸åºåˆ—å·å·ç­‰ä¿¡æ¯ï¼Œæ£€æŸ¥é€šè¿‡åå‘å…±è¯†èŠ‚ç‚¹å¹¿æ’­ prepare æ¶ˆæ¯ï¼› **Commit é˜¶æ®µï¼š**ä»èŠ‚ç‚¹åœ¨æ”¶åˆ°quorum-1 å³(2f) ä¸ªprepare æ¶ˆæ¯ä»¥åŠç›¸åº”çš„ pre-prepare æ¶ˆæ¯åè¿›è¡ŒéªŒè¯ï¼Œå¹¶å°†éªŒè¯ç»“æœä¸ä¸»èŠ‚ç‚¹å†™å…¥pre-prepare æ¶ˆæ¯ä¸­çš„éªŒè¯ç»“æœè¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹ç»“æœä¸€è‡´åˆ™å¹¿æ’­ commit è¡¨æ˜æœ¬èŠ‚ç‚¹åŒæ„ä¸»èŠ‚ç‚¹çš„éªŒè¯ç»“æœï¼Œå¦åˆ™ç›´æ¥å‘èµ· view-change è¡¨æ˜æœ¬èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹å­˜åœ¨å¼‚å¸¸è¡Œä¸ºï¼Œéœ€è¦åˆ‡æ¢ä¸»èŠ‚ç‚¹ï¼› **å†™å…¥è´¦æœ¬ï¼š**æ‰€æœ‰å…±è¯†èŠ‚ç‚¹åœ¨æ”¶åˆ° quorum ä¸ª commit æ¶ˆæ¯åå°†æ‰§è¡Œç»“æœå†™å…¥æœ¬åœ°è´¦æœ¬ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"æ—¥å¿—å‹ç¼© PBFTçš„æ¯ä¸ªé˜¶æ®µéƒ½å†™å…¥äº†æ—¥å¿—ï¼Œé•¿æ—¶é—´è¿è¡Œå†…å­˜æ€»ä¼šä¸å¤Ÿç”¨ï¼Œéœ€è¦ä¸€ç§æ—¥å¿—å‹ç¼©æœºåˆ¶ã€‚PBFTé€šè¿‡æ£€æŸ¥ç‚¹å®ç°æ—¥å¿—å‹ç¼©ï¼Œå…¶æœ¬è´¨å’ŒRAFTç®—æ³•é‡‡ç”¨å¿«ç…§çš„å½¢å¼æ¸…ç†æ—¥å¿—æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ç°çš„æ–¹å¼ä¸åŒã€‚ ä¸ºæ¯ä¸€æ¬¡æ“ä½œåˆ›å»ºä¸€ä¸ªé›†ç¾¤ä¸­ç¨³å®šæ£€æŸ¥ç‚¹ï¼Œä»£ä»·æ˜¯éå¸¸æ˜‚è´µçš„ã€‚å› æ­¤ï¼ŒPBFTä¸ºå¸¸æ•°kä¸ªæ“ä½œåˆ›å»ºä¸€æ¬¡ç¨³å®šæ£€æŸ¥ç‚¹ï¼Œæ¯”å¦‚æ¯100ä¸ªæ“ä½œåˆ›å»ºä¸€æ¬¡æ£€æŸ¥ç‚¹checkpointï¼Œå½“è¿™ä¸ªcheckpointå¾—åˆ°é›†ç¾¤ä¸­å¤šæ•°èŠ‚ç‚¹è®¤å¯ä»¥åï¼Œå°±å˜æˆäº†ç¨³å®šæ£€æŸ¥ç‚¹stable checkpointã€‚ æ€»ä¹‹ï¼Œç¨³å®šæ£€æŸ¥ç‚¹æ˜¯ä¸€ä¸ªç¡®å®šæ€§çš„ç³»ç»ŸçŠ¶æ€å¿«ç…§ï¼Œå¯ä»¥ç”¨æ¥æ¢å¤ç³»ç»ŸçŠ¶æ€ï¼Œç±»æ¯”äº**RDBå¿«ç…§**ï¼›è€Œæ°´ä½çº¿[h, H]é—´çš„æ¶ˆæ¯å°±ç›¸å½“äº**AOFæ–‡ä»¶**ã€‚ ç¨³å®šæ£€æŸ¥ç‚¹ ç”Ÿæˆè¿‡ç¨‹ï¼š å½“ replica i ç”Ÿæˆäº†ä¸€ä¸ª checkpointï¼Œå°†å¹¿æ’­æ¶ˆæ¯ \u003cCHECKPOINT, seq#, d(state), i\u003eï¼Œå…¶ä¸­ï¼Œseq#æ˜¯æœ€åä¸€æ¬¡æ‰§è¡Œçš„æ¶ˆæ¯åºå·ï¼Œdæ˜¯seqæ‰§è¡Œåçš„çŠ¶æ€æœºçŠ¶æ€çš„æ‘˜è¦ï¼› å½“æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°äº†2f+1ä¸ªæ‹¥æœ‰ç›¸åŒçš„ seq# å’Œ d(state) çš„æ£€æŸ¥ç‚¹æ¶ˆæ¯(åŒ…æ‹¬è‡ªå·±)åï¼Œå°†ä¼šç”Ÿæˆstable checkpointã€‚ ä½œç”¨ï¼š å½“stable checkpointç”Ÿæˆä¹‹åï¼Œå°†ä¼šåˆ é™¤stable checkpointä¹‹å‰(seq#ä¹‹å‰)çš„ pre-prepareã€prepareã€commitæ¶ˆæ¯ï¼Œæ—¥å¿—å°±è¢«å‹ç¼©äº†ï¼Œå¹¶ä¸”ç¨³å®šæ£€æŸ¥ç‚¹æ˜¯ä¸€ä¸ªç¡®å®šæ€§çš„ç³»ç»ŸçŠ¶æ€å¿«ç…§ï¼Œå¯ä»¥ç”¨æ¥æ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚ åŒæ—¶checkpointè¿˜æœ‰ä¸€ä¸ª**æé«˜æ°´çº¿(water mark)**çš„ä½œç”¨ï¼Œå½“ä¸€ä¸ªstable checkpointè¢«åˆ›å»ºçš„æ—¶å€™ï¼Œæ°´çº¿hè¢«ä¿®æ”¹ä¸ºstable checkpointçš„seq#ï¼Œæ°´çº¿Hä¸ºh + kè€Œkå°±æ˜¯ä¹‹å‰ç”¨åˆ°åˆ›å»ºcheckpointçš„é‚£ä¸ªå¸¸æ•°ã€‚ æ°´ä½çº¿ æ°´ä½çº¿æœºåˆ¶ç”¨äºé™åˆ¶æ¶ˆæ¯åºå·çš„æœ‰æ•ˆèŒƒå›´ï¼ŒåŒ…æ‹¬ï¼š ä½æ°´ä½çº¿(low-water mark) hï¼› é«˜æ°´ä½çº¿(high water mark) H = h + kã€‚ è®¾ç½®è§„åˆ™ï¼š é€šå¸¸æ¥è®²ï¼Œä½æ°´ä½çº¿æ˜¯æœ€è¿‘çš„ä¸€ä¸ªç¨³å®šæ£€æŸ¥ç‚¹çš„seq#ï¼Œè€Œé«˜æ°´ä½çº¿éœ€è¦åœ¨ä½æ°´ä½çº¿ä¸ŠåŠ ä¸Šä¸€ä¸ªå¸¸é‡kã€‚ kè¦è¶³å¤Ÿå¤§ï¼Œé¿å…éœ€è¦é¢‘ç¹åˆ›å»ºç¨³å®šæ£€æŸ¥ç‚¹ï¼› ä½†**kåˆä¸èƒ½å¤ªå¤§**ï¼Œé¿å…å‡ºç°æ•…éšœæˆ–é”™è¯¯ï¼Œè¿›è¡ŒçŠ¶æ€æ¢å¤æ—¶éœ€è¦é‡æ”¾å¤§é‡çš„è¯·æ±‚æ•°é‡ã€‚ ä½œç”¨ï¼š åœ¨å…±è¯†è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œç”±äºèŠ‚ç‚¹ä¹‹é—´çš„æ€§èƒ½å·®è·ï¼Œå¯èƒ½ä¼šå‡ºç°èŠ‚ç‚¹é—´è¿è¡Œé€Ÿç‡å·®å¼‚è¿‡å¤§çš„æƒ…å†µã€‚éƒ¨åˆ†èŠ‚ç‚¹æ‰§è¡Œçš„åºå·å¯èƒ½ä¼šé¢†å…ˆäºå…¶ä»–èŠ‚ç‚¹ï¼Œå¯¼è‡´äºé¢†å…ˆèŠ‚ç‚¹çš„å…±è¯†æ•°æ®é•¿æ—¶é—´å¾—ä¸åˆ°æ¸…ç†ï¼Œé€ æˆå†…å­˜å ç”¨è¿‡å¤§çš„é—®é¢˜ï¼Œè€Œé«˜ä½æ°´ä½çš„ä½œç”¨å°±æ˜¯å¯¹é›†ç¾¤æ•´ä½“çš„è¿è¡Œé€Ÿç‡è¿›è¡Œé™åˆ¶ï¼Œä»è€Œé™åˆ¶äº†èŠ‚ç‚¹çš„å…±è¯†æ•°æ®å¤§å°ã€‚åœ¨æ‰§è¡Œåˆ°æœ€é«˜æ°´ä½ H æ—¶ï¼Œå¦‚æœä½æ°´ä½ h æ²¡æœ‰è¢«æ›´æ–°ï¼ŒèŠ‚ç‚¹ä¼šæš‚åœæ‰§è¡Œåºå·æ›´å¤§çš„è¯·æ±‚ï¼Œç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œå¾…ä½æ°´ä½ h æ›´æ–°åé‡æ–°å¼€å§‹æ‰§è¡Œæ›´å¤§åºå·çš„è¯·æ±‚ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"è§†å›¾åˆ‡æ¢ è§†å›¾åˆ‡æ¢(view-change)æ˜¯ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œä¸»è¦å‘ç”Ÿåœ¨ï¼š ä¸»èŠ‚ç‚¹è¶…æ—¶ï¼› ä»èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹æ˜¯æ‹œå åº­èŠ‚ç‚¹ã€‚ view-changeé€šè¿‡å®šæ—¶å™¨æ¥è¿›è¡Œåˆ‡æ¢ï¼Œé¿å…ä»èŠ‚ç‚¹é•¿æ—¶é—´ç­‰å¾…è¯·æ±‚ã€‚ åŸæ–‡ä¸­æ˜¯è¿™æ ·åšçš„ï¼šåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸»èŠ‚ç‚¹å°†ä¼šå‘é€ pre-prepare æ¥æ­£å¸¸è¿›è¡Œå…±è¯†ï¼Œä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ¶ˆæ¯ç¡®è®¤ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå› æ­¤å¦‚æœè¶…è¿‡ä¸€æ®µæ—¶é—´æ²¡æœ‰æ”¶åˆ° pre-prepare çš„è¯å°±ä¼šè®¤ä¸ºè¯¥ä¸»èŠ‚ç‚¹æœ‰é—®é¢˜ï¼› å·¥ç¨‹ä¸Šï¼šåœ¨å®é™…è¿è¡Œå½“ä¸­ï¼Œé•¿æ—¶é—´æ²¡æœ‰pre-prepareæ˜¯å¸¸è§çš„ï¼Œå› æ­¤ä¸€èˆ¬ä¼šé€šè¿‡å¿ƒè·³+å®šæ—¶å™¨æ¥è¿›è¡Œæ¢æµ‹ä¿æ´»ã€‚ View-Change è¿‡ç¨‹ å½“ä»èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¦‚æœæœ‰å®šæ—¶å™¨åœ¨è¿è¡Œå°±é‡ç½®(reset)å®šæ—¶å™¨ï¼Œå¦åˆ™å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ã€‚ä½†æ˜¯ä¸»èŠ‚ç‚¹å®•æœºçš„æ—¶å€™ï¼Œä»èŠ‚ç‚¹iå°±ä¼šåœ¨å½“å‰è§†å›¾v#ä¸­è¶…æ—¶ï¼Œè¿™ä¸ªæ—¶å€™è¯¥ä»èŠ‚ç‚¹iå°±ä¼šè§¦å‘view-changeï¼š ä»èŠ‚ç‚¹iä¼šå°†è§†å›¾åˆ‡æ¢ä¸ºv#+1ï¼Œåœæ­¢æ¥æ”¶é™¤äº†checkpointï¼Œview-changeå’Œnew view-changeä»¥å¤–çš„è¯·æ±‚ï¼ŒåŒæ—¶å¹¿æ’­æ¶ˆæ¯\u003cVIEW-CHANGE, v#+1, seq#(stable_checkpoint), C-set, P-set, i\u003e (i)åˆ°é›†ç¾¤ï¼š seq#æ˜¯èŠ‚ç‚¹içŸ¥é“çš„æœ€åä¸€ä¸ªstable checkpointçš„æ¶ˆæ¯åºå·ï¼› C-setæ˜¯èŠ‚ç‚¹iä¿å­˜çš„ 2f+1 ä¸ªèƒ½å¤Ÿè¯æ˜seq#(stable_checkpoint)æ˜¯æ­£ç¡®æ£€æŸ¥ç‚¹çš„çš„æ¶ˆæ¯é›†åˆï¼› P-setæ˜¯ä¸€ä¸ªä¿å­˜äº†seq#ä¹‹åæ‰€æœ‰å·²ç»è¾¾åˆ°preparedçŠ¶æ€æ¶ˆæ¯çš„é›†åˆï¼Œé€šè¿‡P-setå¯ä»¥æŠŠåŸæ¥çš„åœ¨ç¨³å®šæ£€æŸ¥ç‚¹ä¹‹åç¡®å®šçš„äº¤æ˜“è¿›è¡Œé‡æ–°å…±è¯†ã€‚ å½“è§†å›¾(v#+1)ä¸­çš„**æ–°ä¸»èŠ‚ç‚¹p1**æ¥æ”¶åˆ°2fä¸ªæœ‰æ•ˆçš„è§†å›¾åˆ‡æ¢æ¶ˆæ¯ä»¥åï¼Œp1å°±ä¼šå¹¿æ’­æ¶ˆæ¯\u003cNEW-VIEW, v#+1, V-set, Q-set\u003e (p)ï¼š V-setæ˜¯p1æ”¶åˆ°çš„ï¼ŒåŒ…æ‹¬è‡ªå·±å‘é€çš„view-changeçš„æ¶ˆæ¯é›†åˆï¼› Q-setæ˜¯PRE-PREPAREçŠ¶æ€çš„æ¶ˆæ¯é›†åˆï¼Œæ˜¯ä»P-setè½¬æ¢è¿‡æ¥çš„ï¼š ä¸»èŠ‚ç‚¹æ ¹æ®æœ€æ–°stable_checkpointçš„seq# s å’ŒP-setçš„æœ€å¤§seq# tï¼Œå°†[s, t]é—´çš„æ‰€æœ‰seq#åˆ›å»ºpre-prepareæ¶ˆæ¯æˆä¸ºQ-setï¼› ä»èŠ‚ç‚¹æ¥æ”¶åˆ°NEW-VIEWæ¶ˆæ¯åï¼Œæ ¡éªŒç­¾åï¼ŒVå’ŒQä¸­çš„æ¶ˆæ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚éªŒè¯é€šè¿‡ï¼Œå°†æ‰§è¡ŒQ-setä¸­çš„è¯·æ±‚ï¼Œç„¶åä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½è¿›å…¥è§†å›¾v#+1ã€‚ Cã€Pã€Q å½“p1æ¥æ”¶åˆ°2fä¸ªVIEW-CHANGEæ¶ˆæ¯ä»¥åï¼Œå¯ä»¥ç¡®å®š**stable checkpointä¹‹å‰çš„æ¶ˆæ¯åœ¨è§†å›¾åˆ‡æ¢çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸¢**ã€‚ ä½†æ˜¯**[å½“å‰æ£€æŸ¥ç‚¹ï¼Œä¸‹ä¸€ä¸ªæ£€æŸ¥ç‚¹]é—´å·²ç»é€šè¿‡PREPAREé˜¶æ®µçš„æ¶ˆæ¯**å¯èƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œæ‰€ä»¥åœ¨è§†å›¾åˆ‡æ¢åˆ°v+1åï¼ŒPBFTä¼šæŠŠæ—§è§†å›¾ä¸­å·²ç»PREPAREçš„æ¶ˆæ¯å˜ä¸ºPRE-PREPAREï¼Œç»„æˆQç„¶åå¹¿æ’­ã€‚ å¦‚æœé›†åˆPä¸ºç©ºï¼Œåˆ›å»º\u003cPRE-PREPARE, v#+1, seq#, null\u003eï¼Œæ¥æ”¶èŠ‚ç‚¹å°±ä»€ä¹ˆä¹Ÿä¸åšï¼› å¦‚æœé›†åˆPä¸ä¸ºç©ºï¼Œåˆ›å»º\u003cPRE-PREPARE, v#+1, seq#, d\u003eã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨view-changeä¸­æœ€é‡è¦çš„å°±æ˜¯Cï¼ŒPï¼ŒQä¸‰ä¸ªæ¶ˆæ¯çš„é›†åˆï¼š Cç¡®ä¿äº†è§†å›¾å˜æ›´çš„æ—¶å€™ï¼Œstable checkpointä¹‹å‰çš„çŠ¶æ€å®‰å…¨ï¼› Pç¡®ä¿äº†è§†å›¾å˜æ›´å‰ï¼Œå·²ç»PREPAREçš„æ¶ˆæ¯çš„å®‰å…¨ï¼› Qç¡®ä¿äº†è§†å›¾å˜æ›´åï¼ŒP-setä¸­çš„æ¶ˆæ¯å®‰å…¨ã€‚ å›æƒ³ä¸€ä¸‹pre-prepareå’Œprepareé˜¶æ®µæœ€é‡è¦çš„ä»»åŠ¡æ˜¯ä¿è¯åŒä¸€ä¸ªä¸»èŠ‚ç‚¹å‘å‡ºçš„è¯·æ±‚åœ¨åŒä¸€ä¸ªè§†å›¾(view)ä¸­çš„é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œè€Œåœ¨è§†å›¾åˆ‡æ¢è¿‡ç¨‹ä¸­çš„Cï¼ŒPï¼ŒQä¸‰ä¸ªé›†åˆå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚ Leader é€‰ä¸¾ åœ¨ä»‹ç» view-change æ—¶ï¼Œå¹¶æ²¡æœ‰è¯´æ˜åœ¨æ–°çš„è§†å›¾ä¸­ï¼Œæ–°ä¸»èŠ‚ç‚¹æ˜¯å¦‚ä½•é€‰å‡ºæ¥çš„ï¼Œå…¶å®ä¸åŒçš„ç³»ç»Ÿåšæ³•ä¸åŒï¼š FISCO BCOSç³»ç»Ÿä¸­ï¼Œleaderç´¢å¼•çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š leader_idx = (view + block_number) % node_num ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:4","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ä¸»åŠ¨æ¢å¤ åŒºå—é“¾ç½‘ç»œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”±äºç½‘ç»œæŠ–åŠ¨ã€çªç„¶æ–­ç”µã€ç£ç›˜æ•…éšœç­‰åŸå› ï¼Œå¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹çš„æ‰§è¡Œé€Ÿåº¦è½åäºå¤§å¤šæ•°èŠ‚ç‚¹ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼ŒèŠ‚ç‚¹éœ€è¦èƒ½å¤Ÿåšåˆ°è‡ªåŠ¨æ¢å¤æ‰èƒ½ç»§ç»­å‚ä¸åç»­çš„å…±è¯†æµç¨‹ã€‚ ä¼ ç»Ÿçš„PBFTå¹¶æ²¡æœ‰å®ç°ä¸»åŠ¨æ¢å¤çš„åŠŸèƒ½ï¼Œä½†**RBFTæä¾›äº†ä¸€ç§åŠ¨æ€æ•°æ®è‡ªåŠ¨æ¢å¤çš„æœºåˆ¶(recovery)ï¼Œrecovery é€šè¿‡ä¸»åŠ¨ç´¢å–ç°æœ‰å…±è¯†ç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹çš„è§†å›¾ã€æœ€æ–°åŒºå—é«˜åº¦ç­‰ä¿¡æ¯ï¼Œæ›´æ–°è‡ªèº«çš„å­˜å‚¨çŠ¶æ€ï¼Œæœ€ç»ˆåŒæ­¥è‡³æ•´ä¸ªç³»ç»Ÿçš„æœ€æ–°çŠ¶æ€**ã€‚ åœ¨èŠ‚ç‚¹å¯åŠ¨ã€èŠ‚ç‚¹é‡å¯æˆ–è€…èŠ‚ç‚¹è½åçš„æ—¶å€™ï¼ŒèŠ‚ç‚¹å°†ä¼šè‡ªåŠ¨è¿›å…¥ recoveryï¼ŒåŒæ­¥è‡³æ•´ä¸ªç³»ç»Ÿçš„æœ€æ–°çŠ¶æ€ã€‚ æ¯”å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹è½åå¤ªå¤šï¼Œè¿™ä¸ªæ—¶å€™å®ƒæ”¶åˆ°ä¸»èŠ‚ç‚¹å‘æ¥çš„æ¶ˆæ¯æ—¶ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œæ°´ä½æ£€æŸ¥ä¼šå¤±è´¥ï¼Œå½“è®¡æ—¶å™¨è¶…æ—¶ï¼Œå°±ä¼šå‘é€view-changeçš„æ¶ˆæ¯ï¼Œä½†æ˜¯ç”±äºåªæœ‰è‡ªå·±å‘èµ·view-changeè¾¾ä¸åˆ°2f+1ä¸ªèŠ‚ç‚¹çš„æ•°é‡ï¼Œæœ¬æ¥æ­£å¸¸è¿è¡Œçš„èŠ‚ç‚¹å°±é€€åŒ–ä¸ºä¸€ä¸ªæ‹œå åº­èŠ‚ç‚¹ã€‚ è§†å›¾åå•† æ–°å¢/è½åèŠ‚ç‚¹Replica 4å‘èµ·NegotiateViewæ¶ˆæ¯ç»™å…¶ä»–èŠ‚ç‚¹ï¼› å…¶ä½™èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯ä»¥åï¼Œè¿”å›NegotiateViewResponseæ¶ˆæ¯ï¼ŒåŒ…å«è‡ªå·±çš„è§†å›¾ä¿¡æ¯ï¼ŒèŠ‚ç‚¹IDï¼ŒèŠ‚ç‚¹æ€»æ•°Nï¼› Replica 4æ”¶åˆ°2f+1ä¸ªNegotiateViewResponseæ¶ˆæ¯åï¼Œåˆ™æ›´æ–°æœ¬èŠ‚ç‚¹çš„è§†å›¾ä¿¡æ¯ï¼› Replica 4åŒæ­¥å®Œè§†å›¾åï¼Œå¹¿æ’­RecoveryInitæ¶ˆæ¯åˆ°å…¶ä½™èŠ‚ç‚¹ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹æœ¬èŠ‚ç‚¹éœ€è¦è¿›è¡Œè‡ªåŠ¨æ¢å¤ï¼Œè¯·æ±‚å…¶ä½™èŠ‚ç‚¹çš„æ£€æŸ¥ç‚¹ä¿¡æ¯å’Œæœ€æ–°åŒºå—ä¿¡æ¯ï¼› å…¶ä½™èŠ‚ç‚¹æ”¶åˆ°RecoveryInitåå°†è‡ªèº«æœ€æ–°çš„æ£€æŸ¥ç‚¹ä¿¡æ¯å’ŒåŒºå—ä¿¡æ¯è¿”å›ç»™Replica 4; Replica 4æ”¶åˆ°quorumä¸ªRecoveryResponseæ¶ˆæ¯åï¼Œæ›´æ–°è‡ªå·±çš„æ£€æŸ¥ç‚¹åˆ°æœ€æ–°ï¼› æ›´æ–°å®Œæˆåï¼Œè¿˜è¦å‘æ­£å¸¸èŠ‚ç‚¹ç´¢è¦P-setã€Q-setå’ŒC-setçš„ä¿¡æ¯ï¼ŒåŒæ­¥è‡³å…¨ç½‘æœ€æ–°çŠ¶æ€ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:5","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"å¢åˆ èŠ‚ç‚¹(éšä¾¿çœ‹çœ‹è€Œå·²) ä¼ ç»Ÿçš„PBFTç®—æ³•ä¸æ”¯æŒèŠ‚ç‚¹çš„åŠ¨æ€å¢åˆ ï¼ŒRBFT ä¸ºäº†èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿åœ°æ§åˆ¶è”ç›Ÿæˆå‘˜çš„å‡†å…¥å’Œå‡†å‡ºï¼Œæ·»åŠ äº†ä¿æŒé›†ç¾¤éåœæœºçš„æƒ…å†µä¸‹åŠ¨æ€å¢åˆ èŠ‚ç‚¹çš„åŠŸèƒ½ã€‚ å¢åŠ èŠ‚ç‚¹ Replica 5æ–°èŠ‚ç‚¹åŠ å…¥çš„æµç¨‹ï¼š æ–°å¢èŠ‚ç‚¹Replica 5ä¸»åŠ¨å‘ç°æœ‰çš„æ‰€æœ‰èŠ‚ç‚¹å‘èµ·è¿æ¥ï¼Œç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹è¿æ¥æˆåŠŸåæ›´æ–°è‡ªèº«çš„è·¯ç”±è¡¨ï¼Œå¹¶å‘èµ·recoveryï¼› ç°æœ‰èŠ‚ç‚¹æ¥æ”¶åˆ°Replica 5çš„è¿æ¥è¯·æ±‚åå‘å…¨ç½‘å¹¿æ’­AddNodeæ¶ˆæ¯ï¼Œè¡¨æ˜è‡ªå·±åŒæ„è¯¥æ–°èŠ‚ç‚¹åŠ å…¥æ•´ä¸ªå…±è¯†ç½‘ç»œï¼› å½“ç°æœ‰èŠ‚ç‚¹æ”¶åˆ°Næ¡ï¼ˆNä¸ºç°æœ‰åŒºå—é“¾å…±è¯†ç½‘ç»œä¸­èŠ‚ç‚¹æ€»æ•°ï¼‰AddNodeæ¶ˆæ¯åï¼Œæ›´æ–°è‡ªèº«çš„è·¯ç”±è¡¨ï¼Œéšåå¼€å§‹å›åº”æ–°å¢èŠ‚ç‚¹çš„å…±è¯†æ¶ˆæ¯è¯·æ±‚ï¼ˆåœ¨æ­¤ä¹‹å‰ï¼Œæ–°å¢èŠ‚ç‚¹çš„æ‰€æœ‰å…±è¯†æ¶ˆæ¯æ˜¯ä¸äºˆå¤„ç†çš„ï¼‰ï¼› Replica 5å®Œæˆrecoveryä¹‹åï¼Œå‘å…¨ç½‘ç°æœ‰èŠ‚ç‚¹å¹¿æ’­ReadyForNè¯·æ±‚ï¼› ç°æœ‰èŠ‚ç‚¹åœ¨æ”¶åˆ°ReadyForNè¯·æ±‚åï¼Œé‡æ–°è®¡ç®—æ–°å¢èŠ‚ç‚¹åŠ å…¥ä¹‹åçš„Nï¼Œviewç­‰ä¿¡æ¯ï¼Œéšåå°†å…¶ä¸PQCæ¶ˆæ¯å°è£…åˆ°AgreeUpdateNæ¶ˆæ¯ä¸­ï¼Œè¿›è¡Œå…¨ç½‘å¹¿æ’­ï¼› Replica 5åŠ å…¥åçš„å…±è¯†ç½‘ç»œä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè¯¥ä¸»èŠ‚ç‚¹åœ¨æ”¶åˆ°N-fä¸ªAgreeUpdateNæ¶ˆæ¯åï¼Œä»¥æ–°çš„ä¸»èŠ‚ç‚¹çš„èº«ä»½å‘é€UpdateNæ¶ˆæ¯ï¼› å…¨ç½‘æ‰€æœ‰èŠ‚ç‚¹åœ¨æ”¶åˆ°UpdateNæ¶ˆæ¯ä¹‹åç¡®è®¤æ¶ˆæ¯çš„æ­£ç¡®æ€§ï¼Œè¿›è¡ŒVCResetï¼› æ¯ä¸ªèŠ‚ç‚¹å®ŒæˆVCResetåï¼Œå…¨ç½‘å¹¿æ’­FinishUpdateæ¶ˆæ¯ï¼› èŠ‚ç‚¹åœ¨æ”¶åˆ°N-fä¸ªFinishUpdateæ¶ˆæ¯åï¼Œå¤„ç†åç»­è¯·æ±‚ï¼Œå®Œæˆæ–°å¢èŠ‚ç‚¹æµç¨‹ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:5:6","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"äº”ã€åˆ†å¸ƒå¼IDâ­ å‚è€ƒæ–‡ç«  é—®ï¼šä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼IDï¼Ÿ ä¾‹å¦‚ï¼Œå¤šæœº MySQL ä¸­ï¼Œä¹Ÿå°±æ˜¯åˆ†åº“äº†ï¼Œæ•°æ®åº“çš„è‡ªå¢ä¸»é”®å·²ç»æ²¡åŠæ³•æ»¡è¶³ç”Ÿæˆçš„ä¸»é”®æ˜¯å”¯ä¸€çš„äº†ã€‚å¦‚ä½•åœ¨ä¸åŒèŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ä¸»é”®ï¼Ÿ è¿™ä¸ªæ—¶å€™å°±éœ€è¦ åˆ†å¸ƒå¼ID ã€‚ é—®ï¼šåˆ†å¸ƒå¼ID éœ€è¦æ»¡è¶³å•¥æ¡ä»¶ï¼Ÿ å…¶å®æœ€ä¸»è¦çš„å°±æ˜¯ å…¨å±€å”¯ä¸€ã€‚ ==å…¨å±€å”¯ä¸€==ï¼šID çš„å…¨å±€å”¯ä¸€æ€§è‚¯å®šæ˜¯é¦–å…ˆè¦æ»¡è¶³çš„ï¼ é«˜æ€§èƒ½ï¼šåˆ†å¸ƒå¼ ID çš„ç”Ÿæˆé€Ÿåº¦è¦å¿«ï¼Œå¯¹æœ¬åœ°èµ„æºæ¶ˆè€—è¦å°ã€‚ é«˜å¯ç”¨ï¼šç”Ÿæˆåˆ†å¸ƒå¼ ID çš„æœåŠ¡è¦ä¿è¯å¯ç”¨æ€§æ— é™æ¥è¿‘äº 100%ã€‚ é™¤äº†è¿™äº›ä¹‹å¤–ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åˆ†å¸ƒå¼ ID è¿˜åº”ä¿è¯ï¼š å®‰å…¨ï¼šID ä¸­ä¸æš´éœ²ç³»ç»Ÿå’Œä¸šåŠ¡çš„ä¿¡æ¯ã€‚ æœ‰åºé€’å¢ï¼šå¦‚æœè¦æŠŠ ID å­˜æ”¾åœ¨æ•°æ®åº“çš„è¯ï¼ŒID çš„æœ‰åºæ€§å¯ä»¥æå‡æ•°æ®åº“å†™å…¥é€Ÿåº¦ã€‚å¹¶ä¸”ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜å¾ˆæœ‰å¯èƒ½ä¼šç›´æ¥é€šè¿‡ ID æ¥è¿›è¡Œæ’åºã€‚ æœ‰å…·ä½“çš„ä¸šåŠ¡å«ä¹‰ï¼šç”Ÿæˆçš„ ID å¦‚æœèƒ½æœ‰å…·ä½“çš„ä¸šåŠ¡å«ä¹‰ï¼Œå¯ä»¥è®©å®šä½é—®é¢˜ä»¥åŠå¼€å‘æ›´é€æ˜åŒ–ï¼ˆé€šè¿‡ ID å°±èƒ½ç¡®å®šæ˜¯å“ªä¸ªä¸šåŠ¡ï¼‰ã€‚ ç‹¬ç«‹éƒ¨ç½²ï¼šä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå•ç‹¬æœ‰ä¸€ä¸ªå‘å·å™¨æœåŠ¡ï¼Œä¸“é—¨ç”¨æ¥ç”Ÿæˆåˆ†å¸ƒå¼ IDã€‚è¿™æ ·å°±ç”Ÿæˆ ID çš„æœåŠ¡å¯ä»¥å’Œä¸šåŠ¡ç›¸å…³çš„æœåŠ¡è§£è€¦ã€‚ä¸è¿‡ï¼Œè¿™æ ·åŒæ ·å¸¦æ¥äº†ç½‘ç»œè°ƒç”¨æ¶ˆè€—å¢åŠ çš„é—®é¢˜ã€‚æ€»çš„æ¥è¯´ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼ ID çš„åœºæ™¯æ¯”è¾ƒå¤šçš„è¯ï¼Œç‹¬ç«‹éƒ¨ç½²çš„å‘å·å™¨æœåŠ¡è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ â­é—®ï¼šåˆ†å¸ƒå¼ID å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼Ÿ **==æ•°æ®åº“ä¸»é”®è‡ªå¢==**â­ æ•°æ®åº“è‡ªå¢ ID æ˜¯æœ€å¸¸è§çš„ä¸€ç§ç”Ÿæˆ ID æ–¹å¼ã€‚ä¼˜åŠ¿æ˜¯ä½¿ç”¨ç®€å•ï¼Œæ»¡è¶³åŸºæœ¬ä¸šåŠ¡éœ€æ±‚ï¼Œå¤©ç„¶æœ‰åºï¼›ç¼ºç‚¹æ˜¯å¼ºä¾èµ– DBï¼Œä¼šç”±äºæ•°æ®åº“éƒ¨ç½²çš„ä¸€äº›ç‰¹æ€§è€Œå­˜åœ¨å•ç‚¹æ•…éšœã€æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚ ä»¥ MySQL ä¸¾ä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹å¼å³å¯ã€‚ åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¡¨ã€‚ CREATE TABLE `sequence_id` ( `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, `stub` char(10) NOT NULL DEFAULT '', PRIMARY KEY (`id`), UNIQUE KEY `stub` (`stub`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; stub å­—æ®µæ— æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†å ä½ï¼Œä¾¿äºæˆ‘ä»¬æ’å…¥æˆ–è€…ä¿®æ”¹æ•°æ®ã€‚å¹¶ä¸”ç»™ stub å­—æ®µåˆ›å»ºäº†å”¯ä¸€ç´¢å¼•ï¼Œä¿è¯å…¶å”¯ä¸€æ€§ã€‚ é€šè¿‡ replace into æ¥æ’å…¥æ•°æ®ã€‚ BEGIN; REPLACE INTO sequence_id (stub) VALUES ('stub'); SELECT LAST_INSERT_ID(); COMMIT; æ’å…¥æ•°æ®è¿™é‡Œï¼Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ insert into è€Œæ˜¯ä½¿ç”¨ replace into æ¥æ’å…¥æ•°æ®ï¼Œå…·ä½“æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š ç¬¬ä¸€æ­¥ï¼šå°è¯•æŠŠæ•°æ®æ’å…¥åˆ°è¡¨ä¸­ã€‚ ç¬¬äºŒæ­¥ï¼šå¦‚æœä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å­—æ®µå‡ºç°é‡å¤æ•°æ®é”™è¯¯è€Œæ’å…¥å¤±è´¥æ—¶ï¼Œå…ˆä»è¡¨ä¸­åˆ é™¤å«æœ‰é‡å¤å…³é”®å­—å€¼çš„å†²çªè¡Œï¼Œç„¶åå†æ¬¡å°è¯•æŠŠæ•°æ®æ’å…¥åˆ°è¡¨ä¸­ã€‚ **ä¼˜ç‚¹ï¼š**å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ã€ID æœ‰åºé€’å¢ã€å­˜å‚¨æ¶ˆè€—ç©ºé—´å° **ç¼ºç‚¹ï¼š**æ”¯æŒçš„å¹¶å‘é‡ä¸å¤§ã€æ¯æ¬¡è·å– ID éƒ½è¦è®¿é—®ä¸€æ¬¡æ•°æ®åº“ **==æ•°æ®åº“å·æ®µæ¨¡å¼==**â­â­ æ•°æ®åº“ä¸»é”®è‡ªå¢æ¨¡å¼çš„è¯ï¼ŒæŸä¸ªèŠ‚ç‚¹æ¯æ¬¡è·å– ID éƒ½è¦è®¿é—®ä¸€æ¬¡æ•°æ®åº“ï¼Œè¿™è‚¯å®šä¸å¤ªå¥½ã€‚å› æ­¤ï¼Œæ•°æ®åº“å·æ®µæ¨¡å¼å°±æ‰¹é‡è·å–ä¸€æ‰¹ IDï¼Œå­˜åœ¨è¯¥èŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥æ¯æ¬¡ç”¨çš„æ—¶å€™å°±ä»å†…å­˜ä¸­æ…¢æ…¢è·å–äº†ï¼Œä¸å¤Ÿç”¨äº†å°±å†ç”³è¯·ä¸€æ‰¹ï¼Œç¾æ»‹æ»‹~~ ä»¥ MySQL ä¸¾ä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹å¼å³å¯ã€‚ åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¡¨ã€‚ CREATE TABLE `sequence_id_generator` ( `id` int(10) NOT NULL, `current_max_id` bigint(20) NOT NULL COMMENT 'å½“å‰æœ€å¤§id', `step` int(10) NOT NULL COMMENT 'å·æ®µçš„é•¿åº¦', `version` int(20) NOT NULL COMMENT 'ç‰ˆæœ¬å·', `biz_type` int(20) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹', PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; current_max_id å­—æ®µå’Œstepå­—æ®µä¸»è¦ç”¨äºè·å–æ‰¹é‡ IDï¼Œè·å–çš„æ‰¹é‡ ID ä¸ºï¼š current_max_id ~ current_max_id+stepã€‚ ==Redis è‡ªå¢== ä¼˜åŠ¿æ˜¯ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œä½¿ç”¨çµæ´»ï¼Œæ€§èƒ½ä¹Ÿä¼˜äºæ•°æ®åº“ï¼›è€Œç¼ºç‚¹åˆ™æ˜¯å¯èƒ½è¦å¼•å…¥æ–°çš„ç»„ä»¶ Redisï¼Œå¦‚æœ Redis å‡ºç°å•ç‚¹æ•…éšœé—®é¢˜ï¼Œåˆ™ä¼šå½±å“åºå·æœåŠ¡çš„å¯ç”¨æ€§ã€‚ é€šè¿‡ Redis çš„ incr å‘½ä»¤å³å¯å®ç°å¯¹ id åŸå­é¡ºåºé€’å¢ã€‚ 127.0.0.1:6379\u003e set sequence_id_biz_type 1 OK 127.0.0.1:6379\u003e incr sequence_id_biz_type (integer) 2 127.0.0.1:6379\u003e get sequence_id_biz_type \"2\" **==UUID==**â­ UUID ç”±32ä½çš„16è¿›åˆ¶æ•°ç»„æˆï¼Œå¯ä»¥ä¿è¯å”¯ä¸€æ€§ï¼Œæœ‰å¦‚ä¸‹ç”Ÿæˆè§„åˆ™ï¼š åŸºäºæ—¶é—´çš„ UUIDï¼šä¸»è¦ä¾èµ–å½“å‰çš„æ—¶é—´æˆ³å’Œæœºå™¨ mac åœ°å€ã€‚ä¼˜åŠ¿æ˜¯èƒ½åŸºæœ¬ä¿è¯å…¨çƒå”¯ä¸€æ€§ï¼Œç¼ºç‚¹æ˜¯ç”±äºä½¿ç”¨äº† mac åœ°å€ï¼Œä¼šæš´éœ² mac åœ°å€å’Œç”Ÿæˆæ—¶é—´ï¼› åŸºäºéšæœºæ•°çš„ UUIDï¼šåŸºäºéšæœºæ•°æˆ–ä¼ªéšæœºæ•°ç”Ÿæˆã€‚ä¼˜åŠ¿æ˜¯å®ç°ç®€å•ï¼Œç¼ºç‚¹æ˜¯é‡å¤å‡ ç‡å¯è®¡ç®—ï¼› åŸºäºåå­—ç©ºé—´çš„ UUID(MD5 ç‰ˆ)ï¼šåŸºäºæŒ‡å®šçš„åå­—ç©ºé—´/åå­—ç”Ÿæˆ MD5 æ•£åˆ—å€¼å¾—åˆ°ï¼Œä¼˜åŠ¿æ˜¯ä¸åŒåå­—ç©ºé—´/åå­—ä¸‹çš„ UUID æ˜¯å”¯ä¸€çš„ï¼Œç¼ºç‚¹æ˜¯ MD5 ç¢°æ’é—®é¢˜ï¼› å› ä¸ºå…¶ç”Ÿæˆè§„åˆ™åŒ…æ‹¬ MAC åœ°å€ã€æ—¶é—´æˆ³ã€åå­—ç©ºé—´ã€éšæœºæˆ–ä¼ªéšæœºæ•°ã€æ—¶åºç­‰å…ƒç´ ï¼Œè®¡ç®—æœºåŸºäºè¿™äº›è§„åˆ™ç”Ÿæˆçš„ UUID æ˜¯è‚¯å®šä¸ä¼šé‡å¤çš„ã€‚ å¾ˆå°‘ä½¿ç”¨ UUIDã€‚ **ä¼˜ç‚¹ï¼š**ç”Ÿæˆé€Ÿåº¦å¿«ï¼Œç®€å•æ˜“ç”¨ï¼› **ç¼ºç‚¹ï¼š**å­˜å‚¨æ¶ˆè€—ç©ºé—´å¤ªå¤§(128ä½)ã€æ— åº(éå¸¸å½±å“MySQLçš„æ€§èƒ½)ã€æ²¡æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€æœ‰å¯èƒ½å‡ºç°é‡å¤ IDã€ä¸å®‰å…¨(åŸºäº MAC åœ°å€ç”Ÿæˆçš„è¯ï¼Œæœ‰å¯èƒ½ä¼šæ³„éœ² MACåœ°å€) **==é›ªèŠ±ç®—æ³•(Snowflake)==**â­â­â­ Snowflake ç”± 64 bit çš„äºŒè¿›åˆ¶æ•°å­—ç»„æˆï¼Œè¿™ 64bit çš„äºŒè¿›åˆ¶è¢«åˆ†æˆäº†å‡ éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†å­˜å‚¨çš„æ•°æ®éƒ½æœ‰ç‰¹å®šçš„å«ä¹‰ï¼š ç¬¬ 0 ä½ï¼šç¬¦å·ä½(æ ‡è¯†æ­£è´Ÿ)ï¼Œå§‹ç»ˆä¸º 0ï¼Œæ²¡æœ‰ç”¨ï¼Œä¸ç”¨ç®¡ã€‚ ç¬¬ 1~41 ä½ï¼šä¸€å…± 41 ä½ï¼Œç”¨æ¥è¡¨ç¤ºæ—¶é—´æˆ³ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œå¯ä»¥æ”¯æ’‘ 2 ^41 æ¯«ç§’(çº¦ 69 å¹´) ç¬¬ 42~51 ä½ï¼šä¸€å…± 10 ä½ï¼Œæœºå™¨ç¼–ç ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå‰ 5 ä½è¡¨ç¤ºæœºæˆ¿ IDï¼Œå 5 ä½è¡¨ç¤ºæœºå™¨ ID(å®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)ã€‚è¿™æ ·å°±å¯ä»¥åŒºåˆ†ä¸åŒé›†ç¾¤/æœºæˆ¿çš„èŠ‚ç‚¹ã€‚ ç¬¬ 52~63 ä½ï¼šä¸€å…± 12 ä½ï¼Œç”¨æ¥è¡¨ç¤ºåºåˆ—å·ã€‚åºåˆ—å·ä¸ºè‡ªå¢å€¼ï¼Œä»£è¡¨å•å°æœºå™¨æ¯æ¯«ç§’èƒ½å¤Ÿäº§ç”Ÿçš„æœ€å¤§ ID æ•°(2^12 = 4096)ï¼Œä¹Ÿå°±æ˜¯è¯´å•å°æœºå™¨æ¯æ¯«ç§’æœ€å¤šå¯ä»¥ç”Ÿæˆ 4096 ä¸ª å”¯ä¸€ IDã€‚ **ä¼˜ç‚¹ï¼š**å•æœºç”Ÿæˆçš„ ID æœ‰åºé€’å¢ã€ç”Ÿæˆé€Ÿåº¦æ¯”è¾ƒå¿«ã€æ¯”è¾ƒçµæ´»(å¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´bitä½)ï¼› ç¼ºç‚¹ï¼šé‡å¤ ID é—®é¢˜(å¼ºä¾èµ–æ—¶é—´ï¼Œå½“æœºå™¨æ—¶é—´å›æ‹¨çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ä¼šäº§ç”Ÿé‡å¤ ID)ã€ID å¯èƒ½ä¸æ˜¯å…¨å±€é€’å¢ï¼Œè™½ç„¶ ID åœ¨å•æœºä¸Šæ˜¯é€’å¢çš„ï¼Œä½†æ˜¯ç”±äºæ¶‰åŠåˆ°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ¯ä¸ªæœºå™¨èŠ‚ç‚¹ä¸Šçš„æ—¶é’Ÿï¼Œå¯èƒ½ä¼šå‡ºç°ä¸æ˜¯å…¨å±€é€’å¢çš„åœºæ™¯ã€‚ ==åˆ©ç”¨Zookeeper== zookeeper æ˜¯é€šè¿‡ æ ‘å½¢ç»“æ„ æ¥å­˜å‚¨æ•°æ®èŠ‚ç‚¹çš„ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„ å…¨è·¯å¾„ï¼Œå®ƒå¿…å®šæ˜¯å”¯ä¸€çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹çš„å…¨è·¯å¾„ä½œä¸ºå‘½åæ–¹å¼äº†ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:6:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"å…­ã€åˆ†å¸ƒå¼é”â­ æ¦‚è¿° åˆ†å¸ƒå¼é”ç¤ºæ„å›¾ï¼š ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆ†å¸ƒå¼é”éœ€è¦æ»¡è¶³ï¼š å¤šè¿›ç¨‹å¯è§â­ï¼šä½ æ€»å¾—è®©äººçŸ¥é“æœ‰é”çš„å­˜åœ¨å§ï¼Ÿ äº’æ–¥â­ï¼šä»»æ„ä¸€ä¸ªæ—¶åˆ»ï¼Œé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼› é«˜å¯ç”¨ï¼šé”æœåŠ¡æ˜¯é«˜å¯ç”¨çš„ã€‚å¹¶ä¸”ï¼Œå³ä½¿å®¢æˆ·ç«¯çš„é‡Šæ”¾é”çš„ä»£ç é€»è¾‘å‡ºç°é—®é¢˜ï¼Œé”æœ€ç»ˆä¸€å®šè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚ å¯é‡å…¥ï¼šä¸€ä¸ªèŠ‚ç‚¹è·å–äº†é”ä¹‹åï¼Œè¿˜å¯ä»¥å†æ¬¡è·å–é”ã€‚ åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œç›®å‰å¸¸ç”¨çš„æ–¹æ¡ˆæœ‰ä»¥ä¸‹ä¸‰ç±»ï¼š æ•°æ®åº“ä¹è§‚é”ï¼› åŸºäºåˆ†å¸ƒå¼ç¼“å­˜å®ç°çš„é”æœåŠ¡ï¼Œå…¸å‹ä»£è¡¨æœ‰ Redis å’ŒåŸºäº Redis çš„ RedLockï¼› åŸºäºåˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å®ç°çš„é”æœåŠ¡ï¼Œå…¸å‹ä»£è¡¨æœ‰ ZooKeeper å’Œ ETCDã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ZooKeeperæˆ–è€…Redisè·å¾—åˆ†å¸ƒå¼é”ï¼ŒRedisç”¨çš„å¤šä¸€äº›ã€‚ åŸºäº Mysql å®ç°åˆ†å¸ƒå¼é” åˆ©ç”¨MySQLæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶ï¼Œä¸»è¦æ˜¯åŸºäºä¸»é”®å’Œå”¯ä¸€ç´¢å¼•ã€‚æ¯”å¦‚è¯´ä¸¤ä¸ªçº¿ç¨‹å»åŒä¸€ä¸ªæ•°æ®åº“è¡¨è¿›è¡Œæ“ä½œï¼Œåˆ©ç”¨ä¸»é”®å†²çªæ¥ä¿è¯ã€‚ åŸºäº Redis å®ç°åˆ†å¸ƒå¼é” åŠ è§£é”æµç¨‹ åŠ é” SET lock_name my_random_value NX PX 30000 # SETNX è·å¾—é” lock_nameï¼šé”å(key)ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå¯¹äºæŸä¸€ç¡®å®šçš„å…¬å…±èµ„æºï¼Œæ‰€æœ‰äº‰ç”¨æ–¹ï¼ˆå®¢æˆ·ç«¯ï¼‰éƒ½åº”è¯¥çŸ¥é“å¯¹åº”é”çš„åå­—ï¼Œå…¨å±€å¯çŸ¥ï¼› my_random_valueï¼šéšæœºå­—ç¬¦ä¸²(value)ï¼Œä½œä¸ºæŒæœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œé¿å…è¯¯åˆ ï¼› NXï¼šåªæœ‰å½“lock_nameä¸å­˜åœ¨çš„æ—¶å€™æ‰èƒ½ SET æˆåŠŸï¼Œä»è€Œä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å¾—é”ï¼Œè€Œå…¶å®ƒå®¢æˆ·ç«¯åœ¨é”è¢«é‡Šæ”¾ä¹‹å‰éƒ½æ— æ³•è·å¾—é”ï¼Œä¿è¯äº’æ–¥ï¼› PX 30000ï¼šè¡¨ç¤ºè¿™ä¸ªé”èŠ‚ç‚¹æœ‰ä¸€ä¸ª 30 ç§’çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”ã€‚ é‡Šæ”¾é” é¦–å…ˆï¼Œå‘ Redis èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œè·å–é”å¯¹åº”çš„ Value GET lock_name å¦‚æœæŸ¥è¯¢å›æ¥çš„ value å’Œå®¢æˆ·ç«¯è‡ªèº«çš„ my_random_value ä¸€è‡´ï¼Œåˆ™å¯ç¡®è®¤è‡ªå·±æ˜¯é”çš„æŒæœ‰è€…ï¼Œå¯ä»¥å‘èµ·è§£é”æ“ä½œï¼Œå³ä¸»åŠ¨åˆ é™¤å¯¹åº”çš„ Keyï¼Œå‘é€å‘½ä»¤ï¼š DEL lock_name å®‰å…¨æ€§åˆ†æ æ­»é”é¿å… å…¸å‹çš„æ­»é”åœºæ™¯ï¼šè·å¾—é”çš„å®¢æˆ·ç«¯ï¼Œåœ¨é‡Šæ”¾é”ä¹‹å‰å´©æºƒäº†ï¼Œå¯¼è‡´é”ä¸€ç›´æ— æ³•è¢«é‡Šæ”¾ï¼Œè¿›è€Œå¯¼è‡´æ­»é”ã€‚ ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œå¯¹é”è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå½“é”åˆ°æœŸåï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤è¯¥é”å¯¹åº”çš„ key-valueï¼Œä¹Ÿå°±é‡Šæ”¾äº†é”ã€‚ ä½†å­˜åœ¨éšæ‚£ï¼Œæ¯”å¦‚è¿™ä¸ªåœºæ™¯ï¼š å®¢æˆ·ç«¯ A è·å–é”æˆåŠŸï¼› å®¢æˆ·ç«¯ A åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¾ˆé•¿æ—¶é—´ï¼› è¿‡æœŸæ—¶é—´åˆ°ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼› å®¢æˆ·ç«¯ B è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ï¼› å®¢æˆ·ç«¯ A ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œè®¤ä¸ºè‡ªå·±ä¾æ—§æŒæœ‰é”ï¼Œç»§ç»­æ“ä½œåŒä¸€ä¸ªèµ„æºï¼Œå¯¼è‡´äº’æ–¥æ€§å¤±æ•ˆã€‚ ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œæœ‰å¦‚ä¸‹æ–¹æ¡ˆï¼š æœ‰éšæ‚£çš„æ–¹æ¡ˆï¼Œä½†ç½‘ä¸Šå¾ˆå¤šéƒ½æ˜¯è¿™æ ·åšçš„ã€‚ç¬¬ 5 æ­¥ä¸­ï¼Œå®¢æˆ·ç«¯ A æ¢å¤åï¼Œå¯ä»¥æ¯”è¾ƒä¸‹ç›®å‰å·²ç»æŒæœ‰é”çš„æ—¶é—´ï¼Œå¦‚æœå‘ç°å·²ç»è¿‡æœŸï¼Œåˆ™æ”¾å¼ƒå¯¹å…±äº«èµ„æºçš„æ“ä½œï¼Œå³å¯é¿å…äº’æ–¥æ€§å¤±æ•ˆçš„é—®é¢˜ã€‚ä½†åˆ†å¸ƒå¼ä¸­ï¼Œå„èŠ‚ç‚¹çš„æ—¶é’Ÿä¸ä¸€å®šæ˜¯å¼ºä¸€è‡´çš„ï¼Œå¯¼è‡´äº†ä¸€å®šçš„éšæ‚£ã€‚å…¶å®ï¼Œä»»ä½•ä¾èµ–ä¸¤ä¸ªèŠ‚ç‚¹æ—¶é—´æ¯”è¾ƒç»“æœçš„äº’æ–¥æ€§ç®—æ³•ï¼Œéƒ½å­˜åœ¨éšæ‚£ï¼› å¯å–çš„æ–¹æ¡ˆã€‚å¯ä»¥æ¯”è¾ƒ my_random_valueï¼Œå³å®¢æˆ·ç«¯ A æ¢å¤åï¼Œåœ¨æ“ä½œå…±äº«èµ„æºå‰åº”æ¯”è¾ƒç›®å‰è‡ªèº«æ‰€æŒæœ‰é”çš„ my_random_value ä¸ Redis ä¸­å­˜å‚¨çš„ my_random_value æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜å·²ç»ä¸å†æŒæœ‰é”ï¼Œåˆ™æ”¾å¼ƒå¯¹å…±äº«èµ„æºçš„æ“ä½œä»¥é¿å…äº’æ–¥æ€§å¤±æ•ˆçš„é—®é¢˜ã€‚ è§£é”æ“ä½œçš„åŸå­æ€§ ä¸ºäº†ä¿è¯è§£é”çš„æ­£ç¡®æ€§ï¼Œå¼•å…¥äº†my_random_valueã€‚å…·ä½“çš„è§£é”è¿‡ç¨‹å°±åˆ†æˆäº†ä¸¤æ­¥ï¼š å…ˆæŸ¥è¯¢(GET)é”å¯¹åº”çš„ Valueï¼Œä¸è‡ªå·±åŠ é”æ—¶è®¾ç½®çš„ my_random_value è¿›è¡Œå¯¹æ¯”ï¼› å¦‚æœç›¸åŒï¼Œåˆ™å¯ç¡®è®¤è¿™æŠŠé”æ˜¯è‡ªå·±åŠ çš„ï¼Œç„¶åå†å‘èµ·è§£é”(DEL)ã€‚ ä½†æ˜¯ï¼ŒGET å’Œ DEL æ˜¯ä¸¤ä¸ªæ“ä½œå¦‚æœæ˜¯éåŸå­æ€§çš„ï¼Œé‚£ä¹ˆè§£é”æœ¬èº«ä¹Ÿä¼šå­˜åœ¨ç ´åäº’æ–¥æ€§çš„å¯èƒ½ã€‚ æ¯”å¦‚åœ¨æŸ¥è¯¢å®Œï¼Œé‡Šæ”¾å‰ï¼Œåˆé˜»å¡äº†å¾ˆé•¿æ—¶é—´ã€‚ä¸‹é¢æ˜¯å…¸å‹åœºæ™¯ï¼š å®¢æˆ·ç«¯ A è·å–é”æˆåŠŸï¼› å®¢æˆ·ç«¯ A è®¿é—®å…±äº«èµ„æºï¼› å®¢æˆ·ç«¯ A ä¸ºäº†é‡Šæ”¾é”ï¼Œå…ˆæ‰§è¡Œ GET æ“ä½œè·å–é”å¯¹åº”çš„éšæœºå­—ç¬¦ä¸²çš„å€¼ï¼› å®¢æˆ·ç«¯ A åˆ¤æ–­éšæœºå­—ç¬¦ä¸²çš„å€¼ï¼Œä¸é¢„æœŸçš„å€¼ç›¸ç­‰ï¼› å®¢æˆ·ç«¯ A ç”±äºæŸä¸ªåŸå› é˜»å¡äº†å¾ˆé•¿æ—¶é—´ï¼› è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†ï¼› å®¢æˆ·ç«¯ B è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ï¼› å®¢æˆ·ç«¯ A ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œæ‰§è¡Œ DEL æ“çºµï¼Œé‡Šæ”¾æ‰äº†å®¢æˆ·ç«¯ B æŒæœ‰çš„é”ã€‚ ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œæœ‰å¦‚ä¸‹æ–¹æ¡ˆï¼š Redis æ”¯æŒ Lua è„šæœ¬å¹¶ä¿è¯å…¶åŸå­æ€§ï¼Œä½¿ç”¨ Lua è„šæœ¬å®ç°é”æ ¡éªŒä¸é‡Šæ”¾ï¼Œå¹¶ä½¿ç”¨ Redis çš„ eval å‡½æ•°æ‰§è¡Œ Lua è„šæœ¬ã€‚ // Luaè„šæœ¬ï¼Œç”¨äºæ ¡éªŒå¹¶é‡Šæ”¾é” String script = \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\"; // æ‰§è¡ŒLuaè„šæœ¬ï¼Œæ ¡éªŒå¹¶é‡Šæ”¾é” jedis.eval(script, Collections.singletonList(\"lock_name\"), Collections.singletonList(\"my_random_value\")); ä¸»å¤‡åˆ‡æ¢çš„ä¸€è‡´æ€§ å½“ä¸»ä»åˆ‡æ¢æ—¶ï¼Œç”±äº Redis çš„ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œå°±å¯èƒ½å¯¼è‡´åˆ‡æ¢è¿‡ç¨‹ä¸­ä¸§å¤±é”çš„å®‰å…¨æ€§ã€‚ å…¸å‹åœºæ™¯ï¼š å®¢æˆ·ç«¯ A ä» Master è·å–äº†é”ï¼› Master å®•æœºäº†ï¼Œå­˜å‚¨é”çš„ Key è¿˜æ²¡æœ‰æ¥å¾—åŠåŒæ­¥åˆ° Slave ä¸Šï¼› Slave å‡çº§ä¸º Masterï¼› å®¢æˆ·ç«¯ B ä»æ–°çš„ Master è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ï¼› å®¢æˆ·ç«¯ A å’Œå®¢æˆ·ç«¯ B åŒæ—¶æŒæœ‰äº†åŒä¸€ä¸ªèµ„æºçš„é”ï¼Œé”çš„å®‰å…¨æ€§è¢«æ‰“ç ´ã€‚ å¯ä»¥é€šè¿‡ RedLock æ¥è§£å†³ã€‚ è¿è¡Œ Redlock ç®—æ³•çš„å®¢æˆ·ç«¯ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼Œæ¥è¿›è¡ŒåŠ é”çš„æ“ä½œï¼š è·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼ˆæ¯«ç§’æ•°ï¼‰ï¼› æŒ‰é¡ºåºä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹æ‰§è¡Œè·å–é”çš„æ“ä½œã€‚è¿™ä¸ªè·å–æ“ä½œè·Ÿå‰é¢åŸºäºå• Redis èŠ‚ç‚¹è·å–é”çš„è¿‡ç¨‹ç›¸åŒï¼ŒåŒ…å«éšæœºå­—ç¬¦ä¸² my_random_valueï¼Œä¹ŸåŒ…å«è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ PX 30000ï¼Œå³é”çš„æœ‰æ•ˆæ—¶é—´ï¼‰ã€‚ä¸ºäº†ä¿è¯åœ¨æŸä¸ª Redis èŠ‚ç‚¹ä¸å¯ç”¨çš„æ—¶å€™ç®—æ³•èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼Œè¿™ä¸ªè·å–é”çš„æ“ä½œè¿˜æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆTime Outï¼‰ï¼Œå®ƒè¦è¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼ˆå‡ åæ¯«ç§’é‡çº§ï¼‰ã€‚å®¢æˆ·ç«¯åœ¨å‘æŸä¸ª Redis èŠ‚ç‚¹è·å–é”å¤±è´¥ä»¥åï¼Œåº”è¯¥ç«‹å³å°è¯•ä¸‹ä¸€ä¸ª Redis èŠ‚ç‚¹ã€‚è¿™é‡Œçš„å¤±è´¥ï¼Œåº”è¯¥åŒ…å«ä»»ä½•ç±»å‹çš„å¤±è´¥ï¼Œæ¯”å¦‚è¯¥ Redis èŠ‚ç‚¹ä¸å¯ç”¨ï¼› è®¡ç®—è·å–é”çš„æ•´ä¸ªè¿‡ç¨‹æ€»å…±æ¶ˆè€—äº†å¤šé•¿æ—¶é—´ï¼Œè®¡ç®—æ–¹æ³•æ˜¯ç”¨å½“å‰æ—¶é—´å‡å»ç¬¬ 1 æ­¥è®°å½•çš„æ—¶é—´ã€‚å¦‚æœå®¢æˆ·ç«¯ä»å¤§å¤šæ•° Redis èŠ‚ç‚¹ï¼ˆ\u003e=N/2+1ï¼‰æˆåŠŸè·å–åˆ°äº†é”ï¼Œå¹¶ä¸”è·å–é”æ€»å…±æ¶ˆè€—çš„æ—¶é—´æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´ï¼ˆLock Validity Timeï¼‰ï¼Œé‚£ä¹ˆè¿™æ—¶å®¢æˆ·ç«¯æ‰è®¤ä¸ºæœ€ç»ˆè·å–é”æˆåŠŸï¼›å¦åˆ™ï¼Œè®¤ä¸ºæœ€ç»ˆè·å–é”å¤±è´¥ï¼› å¦‚æœæœ€ç»ˆè·å–é”æˆåŠŸäº†ï¼Œå°±è¦é‡æ–°è®¡ç®—è¿™ä¸ªé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œç­‰äºæœ€åˆçš„é”çš„æœ‰æ•ˆæ—¶é—´å‡å»ç¬¬ 3 æ­¥è®¡ç®—å‡ºæ¥çš„è·å–é”æ¶ˆè€—çš„æ—¶é—´ï¼› å¦‚æœæœ€ç»ˆè·å–é”å¤±è´¥äº†ï¼ˆå¯èƒ½ç”±äºè·å–åˆ°é”çš„ Redis èŠ‚ç‚¹ä¸ªæ•°å°‘äº N/2+1ï¼Œæˆ–è€…æ•´ä¸ªè·å–é”çš„è¿‡ç¨‹æ¶ˆè€—çš„æ—¶é—´è¶…è¿‡äº†é”çš„æœ€åˆæœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åº”è¯¥ç«‹å³å‘æ‰€æœ‰ Redis èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”çš„æ“ä½œã€‚ é‡Šæ”¾é”çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼šå³å®¢æˆ·ç«¯å‘æ‰€æœ‰ Redis èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”çš„æ“ä½œï¼Œä¸ç®¡è¿™äº›èŠ‚ç‚¹åœ¨è·å–é”çš„æ—¶å€™æˆåŠŸä¸å¦ã€‚ ä½† RedLockä¹Ÿæœ‰ç¼ºé™·(å¦‚ä¸‹åœºæ™¯)ï¼Œä¸€èˆ¬ä¸å»ºè®®ç”¨è¿™ç§æ–¹å¼ï¼ŒçœŸè¦ç”¨çš„è¯ï¼ŒçœŸä¸å¦‚ç”¨Zookeeperæ¥åšã€‚ å¦‚ä¸‹åœºæ™¯ï¼Œå‡è®¾ä¸€å…±æœ‰ 5 ä¸ª Redis èŠ‚ç‚¹ï¼šAã€Bã€Cã€Dã€Eã€‚ å®¢æˆ·ç«¯ 1 æˆåŠŸé”ä½äº† Aã€Bã€Cï¼Œè·å–é”æˆåŠŸï¼ˆä½† D å’Œ E æ²¡æœ‰é”ä½ï¼‰ã€‚ èŠ‚ç‚¹ C æ—¶é—´å¼‚å¸¸ï¼Œå¯¼è‡´ C ä¸Šçš„é”æ•°æ®æå‰åˆ°æœŸï¼Œè€Œè¢«é‡Šæ”¾ã€‚ å®¢æˆ·ç«¯ 2 æ­¤æ—¶å°è¯•è·å–åŒä¸€æŠŠé”ï¼šé”ä½äº†Cã€Dã€Eï¼Œè·å–é”æˆåŠŸã€‚ å¯é‡å…¥ é—®ï¼šå¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿâ­ å¯é‡å…¥é”æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œä¸€ä¸ªå¸¦é”çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­åˆè°ƒç”¨äº†å¦ä¸€ä¸ªéœ€è¦ç›¸åŒé”çš„æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥ç›´æ¥æ‰§è¡Œè°ƒç”¨çš„æ–¹æ³•å³å¯é‡å…¥ï¼Œè€Œæ— éœ€é‡æ–°è·å¾—é”ã€‚ å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯æ˜¯çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå·±çš„é”ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ç”¨å†é‡æ–°è·å–äº†ã€‚ å®ç°æ€è·¯ï¼šå¯ä»¥ä¸ºæ¯ä¸ªé”å…³è”ä¸€ä¸ªå¯é‡å…¥è®¡æ•°å™¨å’Œä¸€ä¸ªå æœ‰å®ƒçš„çº¿ç¨‹ã€‚è‹¥å¯é‡å…¥è®¡æ•°å™¨å¤§äº 0ï¼Œåˆ™è¡¨ç¤ºé”è¢«å æœ‰ï¼Œéœ€è¦åˆ¤æ–­å æœ‰è¯¥é”çš„çº¿ç¨‹å’Œè¯·æ±‚è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºåŒä¸€ä¸ªã€‚æ¯æ¬¡è·å–é”æ—¶ï¼Œè®¡æ•°å™¨+1ï¼Œæ¯æ¬¡é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨-1ã€‚ é—®ï¼šå¦‚æœå¯¹èµ„æºçš„æ“ä½œè¿˜æœªç»“æŸï¼Œé”å°±åˆ°æœŸäº†å’‹åŠï¼Ÿâ­ è¿™å°±æ¶‰åŠåˆ°å¦‚ä½•ç»™é”ä¼˜é›…çš„ç»­æœŸäº†ã€‚æœ‰éå¸¸æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼šJava-Redissonã€Go-Redsyncç­‰ã€‚ã€‚ã€‚ **åŸç†ç®€å•æ¥è¯´å°±æ˜¯ï¼š**æä¾›äº†ä¸€ä¸ªä¸“é—¨ç”¨æ¥ç›‘æ§å’Œç»­æœŸé”çš„ Watch Dogï¼ˆ çœ‹é—¨ç‹—ï¼‰ï¼Œå¦‚æœæ“ä½œå…±äº«èµ„æºçš„çº¿ç¨‹è¿˜æœªæ‰§è¡Œå®Œæˆçš„è¯ï¼ŒWatch Dog ä¼šä¸æ–­åœ°å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ï¼Œè¿›è€Œä¿è¯é”ä¸ä¼šå› ä¸ºè¶…æ—¶è€Œè¢«é‡Šæ”¾ã€‚ åŸºäº Zookeeper å®ç°åˆ†å¸ƒå¼é” ä¸»è¦æ˜¯åˆ©ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚ é—®ï¼šæ€ä¹ˆåˆ©ç”¨ Zookeeper å®ç°åˆ†å¸ƒå¼é”å‘¢ï¼Ÿèƒ½å®ç°å…±äº«é”å’Œç‹¬å é”å˜›ï¼Ÿ ä¸»è¦æ˜¯åˆ©ç”¨åˆ›å»ºèŠ‚ç‚¹çš„æœ‰åºæ€§ã€‚ å¯ä»¥è®©å¤šä¸ªå®¢æˆ·ç«¯åœ¨æŒ‡å®šèŠ‚ç‚¹(é€šå¸¸æ˜¯æŒä¹…èŠ‚ç‚¹)ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±åˆ›å»ºçš„æ˜¯å¦æ˜¯æœ‰åºèŠ‚ç‚¹ä¸­åºå·æœ€å°çš„é‚£ä¸ªï¼Œè‹¥æ˜¯å°±è·å¾—é”ï¼›è‹¥ä¸æ˜¯ï¼Œå°±é€šè¿‡Watcherè¿›è¡Œç›‘å¬ï¼Œè‹¥è‡ªå·±å‰è¾¹çš„åºå·éƒ½å¤±æ•ˆäº†ï¼Œå°±è¯´æ˜é”é‡Šæ”¾äº†ï¼Œå°±å¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°å°è¯•å¾—åˆ°è¯¥é”ã€‚ åŒæ—¶å®ç°å…±äº«é”å’Œç‹¬å é”ï¼š è¯»è¯·æ±‚ï¼šå¦‚æœ æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œæˆ–æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹éƒ½æ˜¯è¯»è¯·æ±‚ï¼Œåˆ™å¯ä»¥è·å–è¯»é”ï¼› å†™è¯·æ±‚ï¼šå¦‚æœ æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥è·å¾—å†™é”ã€‚ ä¸ºé¿å…ç¾Šç¾¤æ•ˆåº”ï¼Œå¯ä»¥è®©","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:7:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ä¸ƒã€åˆ†å¸ƒå¼äº‹åŠ¡ åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ã€äº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œåˆ†å¸ƒå¼äº‹åŠ¡è¦ä¿è¯è¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚**æœ¬è´¨ä¸Šï¼š**å°±æ˜¯ä¸ºäº†ä¿è¯ä¸åŒæ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚ ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:8:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"å…«ã€Zookeeper Zookeeper åŸºç¡€ç†è®º é—®ï¼šZookeeper æ˜¯ä»€ä¹ˆï¼Ÿ Zookeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆé›†ï¼Œä¿è¯äº† CPï¼Œå¯ç”¨æ¥å®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ/è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Master é€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚ ZooKeeper å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚ é—®ï¼šZookeeper å…·æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿâ­ é¡ºåºä¸€è‡´æ€§â­ï¼šä»ä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œæœ€ç»ˆéƒ½ä¼šä¸¥æ ¼æŒ‰ç…§å…¶å‘èµ·é¡ºåºè¢«åº”ç”¨åˆ° ZooKeeper ä¸­ã€‚å®ç°åŸç†ï¼šåŸå­å¹¿æ’­ã€‚ **åŸå­æ€§â­ï¼š**æ‰€æœ‰äº‹åŠ¡è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œå³æ•´ä¸ªé›†ç¾¤è¦ä¹ˆéƒ½æˆåŠŸåº”ç”¨äº†æŸä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ã€‚å®ç°åŸç†ï¼šäº‹åŠ¡ã€‚ å•ä¸€è§†å›¾â­ï¼šæ— è®ºå®¢æˆ·ç«¯è¿æ¥çš„æ˜¯å“ªä¸ª Zookeeper æœåŠ¡å™¨ï¼Œå…¶çœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚ **é«˜å¯ç”¨â­ï¼š**åŸºäºå‰¯æœ¬æœºåˆ¶å®ç°ï¼Œæ­¤å¤– ZooKeeper æ”¯æŒæ•…éšœæ¢å¤ã€‚å®ç°åŸç†ï¼šé€‰ä¸¾ Leaderã€‚ **é«˜æ€§èƒ½ï¼š**ZooKeeper å°†æ•°æ®å…¨é‡å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥å…¶æ€§èƒ½å¾ˆé«˜ã€‚ é—®ï¼šZookeeper æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿâ­ zookeeper æ•°æ®æ¨¡å‹é‡‡ç”¨æ ‘å½¢ç»“æ„ï¼Œä½¿ç”¨äº† znode ä½œä¸ºæ•°æ®èŠ‚ç‚¹ã€‚ znode æ˜¯ zookeeper ä¸­çš„æœ€å°æ•°æ®å•å…ƒï¼Œæ¯ä¸ª znode ä¸Šéƒ½å¯ä»¥ä¿å­˜æ•°æ®ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‚è½½å­èŠ‚ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæ ‘å½¢åŒ–å‘½åç©ºé—´ã€‚ æŒä¹…èŠ‚ç‚¹ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨(å³ä½¿ ZooKeeper é›†ç¾¤å®•æœº)ï¼Œç›´åˆ°ä¸»åŠ¨å°†å…¶åˆ é™¤ï¼› **ä¸´æ—¶èŠ‚ç‚¹ï¼š**ä¸´ å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰ç»“æŸåˆ™èŠ‚ç‚¹æ¶ˆå¤± ã€‚å¹¶ä¸”ï¼Œä¸´æ—¶èŠ‚ç‚¹åªèƒ½åšå¶å­èŠ‚ç‚¹ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ï¼› æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼šé™¤äº†å…·æœ‰æŒä¹…èŠ‚ç‚¹çš„ç‰¹æ€§å¤–ï¼ŒèŠ‚ç‚¹IDè¿˜å…·æœ‰é¡ºåºæ€§ï¼Œå¦‚/node1/app0000000001ã€/node1/app0000000002 **ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼š**é™¤äº†å…·æœ‰ä¸´æ—¶èŠ‚ç‚¹ç‰¹æ€§å¤–ï¼ŒèŠ‚ç‚¹IDè¿˜å…·æœ‰é¡ºåºæ€§ã€‚ æ¯ä¸ª znode ç”± 2 éƒ¨åˆ†ç»„æˆ: statï¼šçŠ¶æ€ä¿¡æ¯ï¼› dataï¼šèŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®çš„å…·ä½“å†…å®¹ã€‚ é—®ï¼šZookeeper é›†ç¾¤ä¸­æœ‰å“ªäº›è§’è‰²ï¼Ÿâ­ å…±æœ‰ Leaderã€Follower å’Œ Observer ä¸‰ç§è§’è‰²ï¼š Leaderï¼š è´Ÿè´£å‘èµ·å¹¶ç»´æŠ¤ä¸å„ Follower åŠ Observer é—´çš„å¿ƒè·³ï¼› æ‰€æœ‰çš„å†™æ“ä½œå¿…é¡»è¦é€šè¿‡ Leader å®Œæˆå†ç”± Leader å°†å†™æ“ä½œå¹¿æ’­ç»™å…¶å®ƒæœåŠ¡å™¨ï¼› ä¸€ä¸ª Zookeeper é›†ç¾¤åŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªå®é™…å·¥ä½œçš„ Leaderã€‚ Followerï¼š å“åº” Leader çš„å¿ƒè·³ï¼› Follower å¯ç›´æ¥å¤„ç†å¹¶è¿”å›å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚ï¼ŒåŒæ—¶ä¼šå°†å†™è¯·æ±‚è½¬å‘ç»™ Leader å¤„ç†ï¼Œå¹¶ä¸”è´Ÿè´£åœ¨ Leader å¤„ç†å†™è¯·æ±‚æ—¶å¯¹è¯·æ±‚è¿›è¡ŒæŠ•ç¥¨ï¼› ä¸€ä¸ª Zookeeper é›†ç¾¤å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ª Followerã€‚ Observerï¼šè§’è‰²ä¸ Follower ç±»ä¼¼ï¼Œä½†æ˜¯æ— æŠ•ç¥¨æƒã€‚ Zookeeper å·¥ä½œåŸç† è¯»æ“ä½œ Leader/Follower/Observer éƒ½å¯ç›´æ¥å¤„ç†è¯»è¯·æ±‚ï¼Œä»æœ¬åœ°å†…å­˜ä¸­è¯»å–æ•°æ®å¹¶è¿”å›ç»™å®¢æˆ·ç«¯å³å¯ã€‚ ç”±äºå¤„ç†è¯»è¯·æ±‚ä¸éœ€è¦æœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ï¼ŒFollower/Observer è¶Šå¤šï¼Œæ•´ä½“ç³»ç»Ÿçš„è¯»è¯·æ±‚ååé‡è¶Šå¤§ï¼Œä¹Ÿå³è¯»æ€§èƒ½è¶Šå¥½ã€‚ å†™æ“ä½œ æ‰€æœ‰çš„å†™è¯·æ±‚å®é™…ä¸Šéƒ½è¦äº¤ç»™ Leader å¤„ç†ã€‚Leader å°†å†™è¯·æ±‚ä»¥äº‹åŠ¡å½¢å¼å‘ç»™æ‰€æœ‰ Follower å¹¶ç­‰å¾… ACKï¼Œä¸€æ—¦æ”¶åˆ°åŠæ•°ä»¥ä¸Š Follower çš„ ACKï¼Œå³è®¤ä¸ºå†™æ“ä½œæˆåŠŸã€‚Follower/Observer å‡å¯æ¥å—å†™è¯·æ±‚ï¼Œä½†ä¸èƒ½ç›´æ¥å¤„ç†ï¼Œè€Œéœ€è¦å°†å†™è¯·æ±‚è½¬å‘ç»™ Leader å¤„ç†ã€‚ é—®ï¼šWatcher(äº‹ä»¶ç›‘å¬å™¨) æœ‰å•¥ç”¨ï¼Ÿâ­ å®¢æˆ·ç«¯æ³¨å†Œç›‘å¬å®ƒå…³å¿ƒçš„ znodeï¼Œå½“ znode çŠ¶æ€å‘ç”Ÿå˜åŒ–(æ•°æ®å˜åŒ–ã€å­èŠ‚ç‚¹å¢å‡å˜åŒ–)æ—¶ï¼ŒZooKeeper æœåŠ¡ä¼šæ¨é€ç»™å®¢æˆ·ç«¯ã€‚ Watcher å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ã€å‘å¸ƒè®¢é˜…ç­‰åŠŸèƒ½ã€‚ é—®ï¼šä¼šè¯æœºåˆ¶ï¼Ÿ(Zookeeper æ˜¯å’‹æ¨é€ç»™å®¢æˆ·ç«¯çš„å‘¢ï¼Ÿ) å®¢æˆ·ç«¯é€šè¿‡TCP é•¿è¿æ¥ä¸ ZooKeeper æœåŠ¡é›†ç¾¤å»ºç«‹ä¼šè¯(Session)ï¼Œä¹‹åé€šè¿‡å¿ƒè·³æ£€æµ‹æœºåˆ¶æ¥ä¿æŒæœ‰æ•ˆçš„ä¼šè¯çŠ¶æ€ã€‚é€šè¿‡è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯å¯ä»¥å‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ¥æ”¶åˆ° Watch äº‹ä»¶çš„é€šçŸ¥ã€‚ æ¯ä¸ªä¼šè¯éƒ½ä¼šæœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå®¢æˆ·ç«¯é€šè¿‡å¿ƒè·³æ–¹å¼(ping)æ¥ä¿æŒä¼šè¯ä¸è¿‡æœŸï¼Œè‹¥æœåŠ¡å™¨åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ä»»ä½•è¯·æ±‚æˆ–å¿ƒè·³ï¼Œåˆ™ç›¸åº”ä¼šè¯è¢«è§†ä¸ºè¿‡æœŸã€‚ ZAB åè®® ZAB åè®®ä¸»è¦å®šä¹‰äº†ä¸¤ä¸ªå¯ä»¥æ— é™å¾ªç¯çš„æµç¨‹ï¼š å´©æºƒæ¢å¤ï¼šç”¨äºæ•…éšœæ¢å¤ã€‚å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œé€‰ä¸¾ Leaderï¼Œä»è€Œä¿è¯é«˜å¯ç”¨ã€‚ åŸå­å¹¿æ’­ï¼šç”¨äºä¸»ä»åŒæ­¥ï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ åœ¨ ZAB ä¸­å¾ˆé‡è¦çš„å­—æ®µï¼š **zxidï¼š**æ˜¯ä¸€ä¸ª 64 ä½é•¿åº¦çš„ Long ç±»å‹ã€‚å…¶ä¸­é«˜ 32 ä½è¡¨ç¤º epochï¼Œä½ 32 è¡¨ç¤º xidï¼› $$ zxid = (epoch, xid) $$ epochï¼šæ¯ä¸ª Leader éƒ½ä¼šå…·æœ‰ä¸€ä¸ªä¸åŒçš„ epochï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„æ—¶æœŸï¼ˆå¯ä»¥ç†è§£ä¸ºæœä»£çš„å¹´å·ï¼‰ï¼› xidï¼šäº‹åŠ¡ idï¼Œæ˜¯ä¸€ä¸ªæµæ°´å·ã€‚æ¯æ¬¡æœä»£æ›´æ›¿ï¼Œå³ leader æ›´æ¢æ—¶ï¼Œä¼šé‡æ–°ä» 0 å¼€å§‹é€’å¢ï¼› æ¯å½“é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªæ–°çš„ Leader ï¼Œå°±ä¼šä»è¿™ä¸ª Leader æœåŠ¡å™¨ä¸Šå–å‡ºæœ¬åœ°äº‹åŠ¡æ—¥å¿—ä¸­æœ€å¤§ç¼–å· Proposal çš„ zxidï¼Œå¹¶ä» zxid ä¸­è§£æå¾—åˆ°å¯¹åº”çš„ epoch ç¼–å·ï¼Œç„¶åå†å¯¹å…¶åŠ  1ï¼Œä¹‹åè¯¥ç¼–å·å°±ä½œä¸ºæ–°çš„ epoch å€¼ï¼Œå¹¶å°†ä½ 32 ä½æ•°å­—å½’é›¶ï¼Œç”± 0 å¼€å§‹é‡æ–°ç”Ÿæˆ zxidã€‚ **myidï¼š**èŠ‚ç‚¹idã€‚ é—®ï¼šZookeeper å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿå´©æºƒæ¢å¤/é€‰ä¸¾è¿‡ç¨‹æ˜¯å•¥æ ·çš„ï¼Ÿâ­â­ Zookeeper é€šè¿‡å‰¯æœ¬æœºåˆ¶ï¼Œå‰¯æœ¬æœºåˆ¶é€šè¿‡åŸå­å¹¿æ’­å®ç°ï¼Œå½“ Leader å‡ºç°æ•…éšœæ—¶ï¼Œä¼šè¿›è¡Œå´©æºƒæ¢å¤æ¥ä¿è¯é«˜å¯ç”¨ã€‚ å…³é”®ç‚¹ï¼šä¿è¯é€‰ä¸¾å‡ºçš„æ–° Leader æ‹¥æœ‰é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ä¸­æœ€å¤§ç¼–å·(zxid)çš„äº‹åŠ¡ï¼ï¼ å´©æºƒæ¢å¤çš„è¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š **è‡ªå¢é€‰ä¸¾è½®æ¬¡ï¼š**æ¯ä¸ªæœåŠ¡å™¨åœ¨å¼€å§‹æ–°ä¸€è½®æŠ•ç¥¨æ—¶ï¼Œä¼šå…ˆå¯¹è‡ªå·±ç»´æŠ¤çš„ logicClock è¿›è¡Œè‡ªå¢æ“ä½œï¼› åˆå§‹æŠ•ç¥¨ï¼šæ¯ä¸ªæœåŠ¡å™¨æœ€å¼€å§‹éƒ½é€šè¿‡å¹¿æ’­æŠŠç¥¨æŠ•ç»™è‡ªå·±ï¼ŒæŠ•ç¥¨å†…å®¹ä¸ºæ‰€æŠ•ç¥¨æœåŠ¡å™¨çš„ myid å’Œ zxidï¼› æ¥æ”¶å¤–éƒ¨æŠ•ç¥¨ï¼šæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¼šæ¥æ”¶å…¶å®ƒæœåŠ¡å™¨çš„æŠ•ç¥¨ï¼Œå¹¶è®°å…¥è‡ªå·±çš„æŠ•ç¥¨ç®±å†…ï¼› **åˆ¤æ–­é€‰ä¸¾è½®æ¬¡ï¼š**æ”¶åˆ°å¤–éƒ¨æŠ•ç¥¨åï¼Œé¦–å…ˆä¼šæ ¹æ®æŠ•ç¥¨ä¿¡æ¯ä¸­çš„ logicClock è¿›è¡Œåˆ¤æ–­ï¼š è‹¥å¤–éƒ¨æŠ•ç¥¨çš„ logicClock å¤§äºè‡ªå·±çš„ï¼Œè¯´æ˜è‡ªå·±è½åï¼Œä¼šç«‹å³æ¸…ç©ºå¹¶æ›´æ–°è‡ªå·±çš„æŠ•ç¥¨ç®±ï¼› è‹¥å¤–éƒ¨æŠ•ç¥¨çš„ logicClock å°äºè‡ªå·±çš„ï¼Œç›´æ¥å¿½ç•¥è¯¥é€‰ç¥¨ï¼› è‹¥ç­‰äºï¼Œå°±å°†è¯¥é€‰ç¥¨å­˜å…¥æŠ•ç¥¨ç®±ï¼Œä¹‹åè¿›è¡ŒæŠ•ç¥¨ PKï¼› **æŠ•ç¥¨ PKï¼š**æ¯ä¸ªèŠ‚ç‚¹éƒ½åªæœ‰ä¸€ç¥¨ï¼Œè¿™æ­¥å°±æ˜¯ç¡®å®šæœ€ç»ˆæŠ•ç»™è°ã€‚**ä¼˜å…ˆé€‰æ‹© zxid å¤§çš„ï¼Œç„¶åé€‰æ‹© myid å¤§çš„ã€‚**ç„¶åå°†æœ€ç»ˆæŠ•ç¥¨å¹¿æ’­å‡ºå»ï¼› **ç»Ÿè®¡é€‰ç¥¨ï¼š**è‹¥æŸä¸ª Server çš„æŠ•ç¥¨æ•°å¤§äºåŠæ•°ä»¥ä¸Šï¼Œåˆ™è¯¥ Server å°±æˆä¸ºäº† Leaderï¼› **åŒæ­¥çŠ¶æ€ï¼š**åˆ©ç”¨ leader å‰ä¸€é˜¶æ®µè·å¾—çš„æœ€æ–°æè®®ï¼ŒåŒæ­¥é›†ç¾¤ä¸­æ‰€æœ‰çš„å‰¯æœ¬ã€‚åŒæ­¥å®Œæˆä¹‹åï¼Œå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚ é—®ï¼šZookeeper å¦‚ä½•å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼Ÿâ­â­ Zookeeper ä¸»è¦ä¾èµ– ZAB åè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼ŒZABåè®®æ˜¯é¡ºåºä¸€è‡´æ€§çš„ã€‚ä¸»è¦æ˜¯é€šè¿‡åŸå­å¹¿æ’­æ¥ä¿è¯ã€‚ è¯¦ç»†è¿‡ç¨‹ï¼š ZooKeeper ä¸­æ‰€æœ‰çš„å†™è¯·æ±‚éƒ½ç”± Leader èŠ‚ç‚¹æ¥å¤„ç†ï¼š å®¢æˆ·ç«¯çš„å†™è¯·æ±‚è¿›æ¥ä¹‹åï¼ŒLeader ä¼šå°†å†™è¯·æ±‚åŒ…è£…æˆ Proposal äº‹åŠ¡ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªé€’å¢äº‹åŠ¡ IDï¼Œä¹Ÿå°±æ˜¯ Zxidã€‚Zxid æ˜¯å•è°ƒé€’å¢çš„ï¼Œä»¥ä¿è¯æ¯ä¸ªæ¶ˆæ¯çš„å…ˆåé¡ºåºï¼› å¹¿æ’­è¿™ä¸ª Proposal äº‹åŠ¡ã€‚Leader ä¼šä¸ºæ¯ä¸€ä¸ª Follower æœåŠ¡å™¨åˆ†é…ä¸€ä¸ªå•ç‹¬çš„ FIFO é˜Ÿåˆ—ï¼Œç„¶åæŠŠ Proposal æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼› Follower èŠ‚ç‚¹æ”¶åˆ°å¯¹åº”çš„ Proposal ä¹‹åä¼šæŠŠå®ƒæŒä¹…åˆ°ç£ç›˜ä¸Šï¼Œå½“å®Œå…¨å†™å…¥ä¹‹åï¼Œå‘ä¸€ä¸ª ACK ç»™ Leaderï¼› å½“ Leader æ”¶åˆ°è¶…è¿‡åŠæ•° Follower çš„ ACK ä¹‹åï¼Œä¼šæäº¤æœ¬åœ°æœºå™¨ä¸Šçš„äº‹åŠ¡ï¼ŒåŒæ—¶å¼€å§‹å¹¿æ’­ commitï¼› Follower æ”¶åˆ° commit ä¹‹åï¼Œå®Œæˆå„è‡ªçš„äº‹åŠ¡æäº¤ã€‚ é—®ï¼šZookeeper å¦‚ä½•ä¿è¯äº‹åŠ¡(Proposal)å‘é€çš„é¡ºåºæ€§ï¼Ÿâ­â­ å¦‚æœFolloweræ”¶åˆ°äº‹åŠ¡çš„é¡ºåºä¸åŒï¼Œé‚£ä¹ˆä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„ã€‚ ä¸»è¦æ˜¯é **Zxidå’Œé˜Ÿåˆ—**ï¼š Leaderä¼šä¸ºæ¯ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå…¨å±€é€’å¢çš„äº‹åŠ¡ID(Zxid)ï¼Œç”Ÿæˆäº‹åŠ¡åï¼ŒæŒ‰ç…§è¯¥ ID è¿›è¡Œæ’åºï¼Œä»¥ä¿è¯é¡ºåºï¼› Leaderä¼šä¸ºæ¯ä¸€ä¸ªFolloweråˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œç„¶åå°†äº‹åŠ¡ Proposal ä¾æ¬¡æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ ¹æ® FIFO(å…ˆè¿›å…ˆå‡º) çš„ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚ é—®ï¼šä¸ºå•¥é›†ç¾¤ä¸­çš„æœºå™¨æœ€å¥½æ˜¯å¥‡æ•°å°ï¼Ÿ Zookeeperé›†ç¾¤ä¸­ï¼Œå­˜æ´»ä¸»æœºæ•°ç›® \u003e å®•æœºæ•°ç›® æ—¶ï¼Œæ‰èƒ½ç»§ç»­æä¾›æœåŠ¡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ2n å’Œ 2n-1 çš„å®¹å¿åº¦æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ n-1ã€‚æ—¢ç„¶å¤šå‡ºä¸€å°ä¹Ÿä¸€æ ·ï¼Œé‚£ä½•å¿…å‘¢ï¼Ÿ é—®ï¼šZookeeper é›†ç¾¤å¦‚ä½•é˜²æ­¢è„‘è£‚ç°è±¡ï¼Ÿâ­ ==é‡‡ç”¨è¿‡åŠæœºåˆ¶ã€‚==åœ¨æ”¶åˆ°å¤§äºä¸€åŠçš„é€‰ç¥¨æ‰èƒ½æˆä¸º Leaderã€‚ ZooKeeper çš„è¿‡åŠæœºåˆ¶å¯¼è‡´ä¸å¯èƒ½äº§ç”Ÿ 2 ä¸ª leaderï¼Œå› ä¸ºå°‘äºç­‰äºä¸€åŠæ˜¯ä¸å¯èƒ½äº§ç”Ÿ leader çš„ï¼Œè¿™å°±ä½¿å¾—ä¸è®ºæœºæˆ¿çš„æœºå™¨å¦‚ä½•åˆ†é…éƒ½ä¸å¯èƒ½å‘ç”Ÿè„‘è£‚ã€‚ Zookeeper åº”ç”¨ å‚è€ƒé“¾æ¥ å› ä¸ºZookeeperçš„å¼ºä¸€è‡´æ€§ï¼Œå¯ä»¥ä¿è¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹åˆ›å»ºå…¨å±€å”¯ä¸€çš„èŠ‚ç‚¹ã€‚ åˆ†å¸ƒå¼ID åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé€šå¸¸éœ€è¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åå­—ï¼Œå¦‚ç”Ÿæˆå…¨å±€å”¯ä¸€çš„è®¢å•å·ç­‰ï¼ŒZooKeeper å¯ä»¥é€šè¿‡é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€ IDï¼Œä»è€Œå¯ä»¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿæä¾›å‘½åæœ","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:9:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"ä¹ã€Etcd ä¸»è¦å‚è€ƒï¼š æ·±å…¥è§£è¯»RAFTç®—æ³•ä¸ETCDå·¥ç¨‹å®ç° ETCDåŸç†ä¸å®ç° Etcd æ˜¯ä¸€ä¸ªåŸºäº Raft å…±è¯†ç®—æ³•å®ç°çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨æœåŠ¡ï¼Œæ˜¯ K8s çš„æ ¸å¿ƒå­˜å‚¨ã€‚åœ¨é¡¹ç›®ç»“æ„ä¸Šé‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸‰ä¸ªéƒ¨åˆ†æ˜¯å®ç°åˆ†å¸ƒå¼å…±è¯†çš„ Raft æ¨¡å—ã€å®ç°æ•°æ®æŒä¹…åŒ–çš„ WAL æ¨¡å—å’Œå®ç°çŠ¶æ€æœºå­˜å‚¨çš„ MVCC æ¨¡å—ã€‚ æ›´è¯¦ç»†çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š api æ¥å£æ”¯æŒ http åè®®å’Œ grpc åè®®ï¼› node ä¸»è¦è´Ÿè´£ raft ç®—æ³•çš„å®ç°ï¼› storage ä¸»è¦è´Ÿè´£ raft æ—¥å¿—ä»¥åŠ snap å¿«ç…§æ–‡ä»¶çš„å­˜å‚¨ï¼› transport ä¸»è¦è´Ÿè´£é›†ç¾¤èŠ‚ç‚¹é—´çš„é€šä¿¡ï¼› kvstore åˆ†ä¸º v2 å’Œ v3 ä¸¤ä¸ªç‰ˆæœ¬æ•°æ®åº“ï¼Œä¸»è¦è´Ÿè´£ä¸šåŠ¡æ•°æ®çš„å­˜å‚¨ï¼Œå…¶ä¸­ v3 ç‰ˆæœ¬æ•°æ®åº“çš„å®ç°é‡‡ç”¨ lboltdb å’Œ keyIndexï¼Œæ”¯æŒ mvcc æœºåˆ¶ã€‚ RAFT æ¨¡å— ==æ—¥å¿—å¤åˆ¶== åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦è®©ä¸€ä¸ªæœåŠ¡å…·æœ‰å®¹é”™èƒ½åŠ›ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯è®©ä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªå‰¯æœ¬åŒæ—¶è¿è¡Œåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚ä¸ºäº†ä¿è¯å¤šä¸ªå‰¯æœ¬åœ¨è¿è¡Œæ—¶çš„çŠ¶æ€éƒ½æ˜¯åŒæ­¥çš„ï¼Œå³å®¢æˆ·ç«¯æ— è®ºå°†è¯·æ±‚å‘é€åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼Œæœ€åéƒ½èƒ½å¾—åˆ°ç›¸åŒçš„ç»“æœï¼Œé€šå¸¸é‡‡ç”¨çŠ¶æ€æœºå¤åˆ¶ï¼ˆState Machine Replicationï¼‰æ–¹æ³•ã€‚ Etcdä½¿ç”¨æ—¥å¿—å¤åˆ¶å®ç°ã€‚Etcd å°†æ—¥å¿—å®ä¾‹åŒ–ä¸º Entry æ—¥å¿—ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå­˜å‚¨ä¸€ç³»åˆ— Entry æ—¥å¿—ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ Entry æ—¥å¿—éƒ½ç›¸åŒå¹¶ä¸”é¡ºåºä¹Ÿä¸€è‡´ï¼ŒçŠ¶æ€æœºæŒ‰é¡ºåºæ‰§è¡Œ Entry ä¸­çš„å‘½ä»¤ï¼Œå› æ­¤æ¯ä¸ªçŠ¶æ€æœºå¤„ç†ç›¸åŒçš„å‘½ä»¤åºåˆ—ï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°ç›¸åŒçš„æ•°æ®çŠ¶æ€å’Œè¾“å‡ºåºåˆ—ã€‚ RAFT å°±æ˜¯ç”¨æ¥ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šçš„Consensusæ¨¡å—æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å†™è¯·æ±‚ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ° WAL (Write Ahead Logï¼Œé¢„å†™æ—¥å¿—ï¼‰ä¸­ã€‚éšåè¯¥æœåŠ¡å™¨ä¸å…¶ä»–æœåŠ¡å™¨ä¸Šçš„Consensusæ¨¡å—é€šä¿¡ï¼Œä»¥ç¡®ä¿æ¯ä¸ªæœåŠ¡å™¨ä¸Šå…·æœ‰ç›¸åŒçš„æ—¥å¿—åºåˆ—ã€‚æ¯ä¸ªæœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºæŒ‰é¡ºåºæ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·å°±å½¢æˆäº†é«˜å¯ç”¨çš„å¤åˆ¶çŠ¶æ€æœºã€‚ æ•°æ®é€šé“ ä¸ºäº†ç½‘ç»œå±‚èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†ä¸åŒæ•°æ®é‡çš„æ¶ˆæ¯ï¼Œetcd é‡‡å–åˆ†ç±»å¤„ç†çš„æ–¹å¼ï¼Œå®ƒæŠ½è±¡å‡º 2 ç§ç±»å‹çš„æ¶ˆæ¯ä¼ è¾“é€šé“ï¼š **Stream é€šé“ï¼š**ç”¨äºå¤„ç†æ•°æ®é‡è¾ƒå°‘ã€å‘é€æ¯”è¾ƒé¢‘ç¹çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚å¿ƒè·³æ¶ˆæ¯ã€è¿½åŠ æ—¥å¿—æ¶ˆæ¯ç­‰ï¼ŒèŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´åªç»´æŠ¤ 1 ä¸ª HTTP é•¿è¿æ¥ï¼Œäº¤æ›¿å‘è¿æ¥ä¸­å†™å…¥æ•°æ®ï¼› **Pipeline é€šé“ï¼š**ç”¨äºå¤„ç†æ•°æ®é‡å¤§çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¼ è¾“å¿«ç…§æ¶ˆæ¯ã€‚è¿™ç§ç±»å‹çš„æ¶ˆæ¯éœ€è¦ä¸å¿ƒè·³æ¶ˆæ¯ç­‰åˆ†å¼€å¤„ç†ï¼Œå¦åˆ™ä¼šé˜»å¡å¿ƒè·³åŒ…çš„ä¼ è¾“ï¼Œè¿›è€Œå½±å“é›†ç¾¤çš„ç¨³å®šæ€§ã€‚Pipeline é€šé“åªé€šè¿‡çŸ­è¿æ¥ä¼ è¾“æ•°æ®ï¼Œç”¨å®Œå³å…³é—­ã€‚ è¿™ä¸¤ç§æ¶ˆæ¯ä¼ è¾“é€šé“éƒ½ä½¿ç”¨ gRPC ä¼ è¾“æ•°æ®ã€‚ ==Leader é€‰ä¸¾== Raft é€šè¿‡ã€leader é€‰ä¸¾æœºåˆ¶ã€é€‰ä¸¾å‡ºä¸€ä¸ª Leaderï¼Œç”±å®ƒå…¨æƒç®¡ç†æ—¥å¿—å¤åˆ¶æ¥å®ç°ä¸€è‡´æ€§ã€‚ Raft ç®—æ³•è®ºæ–‡è§„å®šäº†ä¸‰ç§èŠ‚ç‚¹èº«ä»½ï¼šLeaderã€Follower å’Œ Candidateï¼ŒEtcd çš„å®ç°ä¸­åˆæ·»åŠ äº† PreCandidate å’Œ Learner è¿™ä¸¤ç§èº«ä»½ã€‚ é›†ç¾¤å¯åŠ¨æ—¶æ‰€æœ‰èŠ‚ç‚¹åˆå§‹çŠ¶æ€å‡ä¸º Followerï¼Œéšåä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹é€‰ä¸¾æˆåŠŸæˆä¸º Leaderï¼Œåœ¨ç»å¤§å¤šæ•°æ—¶é—´é‡Œé›†ç¾¤å†…çš„èŠ‚ç‚¹ä¼šå¤„äºè¿™ä¸¤ç§èº«ä»½ä¹‹ä¸€ï¼› å½“ä¸€ä¸ª Follower èŠ‚ç‚¹çš„é€‰ä¸¾è®¡æ—¶å™¨è¶…æ—¶åï¼Œä¼šåˆ‡æ¢ä¸º PreCandidate èº«ä»½ï¼Œè¿›è¡Œ**preVote**ï¼Œä¸è‡ªå¢ä»»æœŸå·ä»…å‘èµ·é¢„æŠ•ç¥¨ï¼Œä¹Ÿå°±æ˜¯è¯¢é—®é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹æ˜¯å¦æ„¿æ„å‚ä¸é€‰ä¸¾ï¼š å¦‚æœé›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹èƒ½å¤Ÿæ­£å¸¸æ”¶åˆ° Leader çš„å¿ƒè·³æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šæ‹’ç»å‚ä¸é€‰ä¸¾ï¼› å¦‚æœæœ‰è¶…è¿‡æ³•å®šäººæ•°çš„èŠ‚ç‚¹å“åº”å¹¶è¡¨ç¤ºå‚ä¸æ–°ä¸€è½®é€‰ä¸¾ï¼Œè¯¥èŠ‚ç‚¹ä¼šä» PreCandidate èº«ä»½åˆ‡æ¢åˆ° Candidateï¼Œè‡ªå¢ä»»æœŸå·å¹¶æŠ•ç¥¨ç»™è‡ªå·±ï¼Œå¹¶å‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­ç«é€‰æŠ•ç¥¨ä¿¡æ¯ï¼› å½“èŠ‚ç‚¹æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„ç«é€‰æ¶ˆæ¯åï¼Œé¦–å…ˆåˆ¤æ–­ç«é€‰èŠ‚ç‚¹çš„ä»»æœŸå·å¤§äºæœ¬èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥æŠ•ç¥¨ç»™ç«é€‰èŠ‚ç‚¹ï¼Œå¦åˆ™æ‹’ç»æŠ•ç¥¨ã€‚ å½“ä¸€ä¸ªèŠ‚ç‚¹æˆä¸º Leader åä¼šç«‹å³æäº¤ä¸€æ¡ç©ºæ—¥å¿—ï¼Œå°†è‡ªèº«æºå¸¦çš„æ‰€æœ‰æ—¥å¿—éƒ½è®¾ç½®ä¸ºæäº¤çŠ¶æ€ï¼ŒåŒ…æ‹¬ç”±å…¶å®ƒ Leader åˆ›å»ºä½†è¿˜æ²¡æœ‰æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œç„¶åå‘é›†ç¾¤å†…çš„å…¶å®ƒèŠ‚ç‚¹åŒæ­¥ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯é›†ç¾¤æ•°æ®çš„ä¸€è‡´æ€§ï¼Œé˜²æ­¢ Leader èŠ‚ç‚¹åˆ‡æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿæ•°æ®ä¸¢å¤±ã€‚ å½“ä¸€ä¸ªæ–°èŠ‚ç‚¹åˆšè¿›å…¥é›†ç¾¤ï¼Œæ­¤æ—¶å°±æ˜¯ Learner èº«ä»½ï¼Œä¸»è¦æ˜¯å› ä¸ºéœ€è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´æ¥åŒæ­¥æ—¥å¿—ï¼Œè¿™å¯èƒ½å¯¼è‡´é›†ç¾¤æ— æ³•å¤„ç†æ–°çš„è¯·æ±‚ï¼Œä¸ºäº†é¿å…è¿™ç§é—´éš”ï¼Œæ‰€ä»¥ Learner ä¸å…·æœ‰æŠ•ç¥¨æƒï¼Œæ¥æ”¶ Leader å‘æ¥çš„å¿«ç…§ä»¥å¿«é€Ÿèµ¶ä¸Šæ—¥å¿—ï¼Œå½“å’ŒLeaderæ—¥å¿—ä¸€è‡´åä¼šè½¬å˜èº«ä»½ä¸º Followerã€‚ Entry Raft æ¨¡å—ç»´æŠ¤çš„**æ‰€æœ‰æ•°æ®ï¼ˆé”®å€¼å¯¹ï¼‰**éƒ½è¢«å®ä¾‹åŒ–ä¸º Entry æ—¥å¿—è¡¨ç¤ºã€‚ Raft ç®—æ³•ä¸­æ‰€æœ‰å†™è¯·æ±‚éƒ½æ˜¯ç”± Leader èŠ‚ç‚¹å¤„ç†çš„ï¼Œå¦‚æœæ”¶åˆ°ææ¡ˆçš„èŠ‚ç‚¹æ˜¯ Followerï¼Œå®ƒä¼šè½¬å‘ç»™ Leaderã€‚ Leader æ”¶åˆ°ææ¡ˆåï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å°è£…ä¸º Entry æ—¥å¿—ï¼š Dataå­—æ®µæ˜¯å®¢æˆ·ç«¯å‘é€çš„é”®å€¼å¯¹ï¼› Termå­—æ®µæ˜¯å½“å‰é›†ç¾¤çš„ä»»æœŸï¼› Indexå­—æ®µæ˜¯è¯¥ Entry æ—¥å¿—çš„ç´¢å¼•ï¼Œç›¸å½“äºå…¨å±€å”¯ä¸€æ ‡è¯† IDã€‚ å°è£…å®Œæ•°æ®åä¼šå°†è¿™äº› Entry æ—¥å¿—è¿½åŠ åˆ° Raft Log ä¸­ã€‚ å†™è¯·æ±‚æµç¨‹ client é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ª Etcd èŠ‚ç‚¹ï¼Œå‘èµ· gRPC è°ƒç”¨ï¼Œå‘é€ K-V è¯·æ±‚ï¼› ç»è¿‡æ£€éªŒä¹‹åï¼Œä¼ é€’ææ¡ˆç»™ä¸Šå±‚ï¼ŒRAFT æ¨¡å—æ”¶åˆ°ææ¡ˆåï¼Œè‹¥å½“å‰èŠ‚ç‚¹æ˜¯ Followerï¼Œå°±ä¼šè½¬å‘ç»™ Leaderï¼Œåªæœ‰ Leader æ‰èƒ½å¤„ç†å†™è¯·æ±‚ï¼› Leader æ”¶åˆ°ææ¡ˆåï¼Œé€šè¿‡ RAFT æ¨¡å—ç”Ÿæˆ Entryï¼Œå¹¶ä¿å­˜åˆ° unstableä¸­ï¼› Leader è·å¾— Entry åï¼Œä¼šå°†å…¶å†™å…¥ WAL æ–‡ä»¶ï¼ŒåŒæ—¶å°†å…¶å¹¿æ’­ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼› ç„¶å Leader çš„ RAFT æ¨¡å—ä¼šæŠŠè¯¥ Entry ç§»åˆ° MemoryStorageï¼› å¾…è¯¥ Entry æ—¥å¿—è¢«å¤åˆ¶åˆ°é›†ç¾¤åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æ—¶ï¼Œè¯¥ Entry æ—¥å¿—ä¼šè¢« Leader èŠ‚ç‚¹ç¡®è®¤ä¸ºå·±æäº¤ï¼ŒLeader ä¼šå›å¤å®¢æˆ·ç«¯å†™è¯·æ±‚æ“ä½œæˆåŠŸï¼› ç„¶å Leader å°†è¯¥ Entry åº”ç”¨åˆ°çŠ¶æ€æœºã€‚ çº¿æ€§ä¸€è‡´è¯» ETCD ä¸­ï¼Œæ‰€æœ‰çš„å†™è¯·æ±‚éƒ½åªç”±Leaderå¤„ç†ï¼Œå†é€šè¿‡æ—¥å¿—å¤åˆ¶çš„æ–¹æ³•åŒæ­¥ç»™å…¶ä»–Followerã€‚ ä½†æ‰€æœ‰çš„èŠ‚ç‚¹(Leader+Follower)éƒ½å¯ä»¥å¤„ç†è¯»è¯·æ±‚ã€‚ç”±äºä»¥ä¸‹åŸå› ï¼Œä»ä¸åŒçš„èŠ‚ç‚¹è¯»æ•°æ®å¯èƒ½ä¼šå‡ºç°ä¸ä¸€è‡´: Etcd åº”ç”¨æ—¥å¿—çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼ŒFollowerçš„çŠ¶æ€æ€»çš„è½åäºLeaderï¼Œä¸”Followerä¹‹é—´çš„çŠ¶æ€ä¹Ÿå¯èƒ½å­˜åœ¨å·®å¼‚ï¼› è‹¥å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œè¿›è€Œå‡ºç°è„‘è£‚ï¼Œæ–°æ—§Leaderçš„çŠ¶æ€ä¹Ÿä¼šä¸ä¸€è‡´ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå„ä¸ªèŠ‚ç‚¹å¹¶éæ˜¯ å®æ—¶ ä¸€è‡´ï¼Œæ‰€ä»¥è¯»å–æ•°æ®å¾ˆæœ‰å¯èƒ½è¯»å–åˆ°ä¸ä¸€è‡´çš„æ—§æ•°æ®ã€‚ é—®ï¼šæ€ä¹ˆè§£å†³çº¿æ€§ä¸€è‡´è¯»é—®é¢˜ï¼Ÿâ­ Etcd é‡‡ç”¨ ReadIndex æœºåˆ¶å®ç°çº¿æ€§ä¸€è‡´è¯»ï¼ŒåŸºæœ¬åŸç†ï¼š Leaderé¦–å…ˆé€šè¿‡æŸç§æœºåˆ¶ç¡®è®¤è‡ªå·±ä¾ç„¶æ˜¯Leaderï¼› Leaderéœ€è¦ç»™å®¢æˆ·ç«¯è¿”å›æœ€è¿‘å·²åº”ç”¨çš„æ•°æ®ï¼šå³æœ€æ–°è¢«åº”ç”¨åˆ°çŠ¶æ€æœºçš„æ•°æ®ã€‚ æµç¨‹å¦‚ä¸‹ï¼š å½“ Follower èŠ‚ç‚¹æ”¶åˆ°ä¸€ä¸ªçº¿æ€§è¯»è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¼šå‘ Leader è¯·æ±‚è·å–é›†ç¾¤æœ€æ–°çš„ã€å·²æäº¤çš„æ—¥å¿—ç´¢å¼•ï¼Œè®°ä¸ºReadIndexï¼› Leader æ”¶åˆ° ReadIndex è¯·æ±‚æ—¶ï¼Œä¼šå‘ Follower å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡æ³•å®šäººæ•°çš„èŠ‚ç‚¹å“åº”äº†å¿ƒè·³æ¶ˆæ¯ï¼Œå°±è¯´æ˜è‡ªå·±æ˜¯åˆæ³•çš„ Leaderï¼Œç„¶åæ‰èƒ½å°†è¯»æ—¶å·²æäº¤çš„ç´¢å¼•è¿”å›ç»™è¯·æ±‚èŠ‚ç‚¹ï¼› Follower æ‹¿åˆ°åï¼Œç­‰å¾…çŠ¶æ€æœºã€è‡³å°‘ã€åº”ç”¨åˆ°ReadIndexï¼Œå³ AppliedIndex \u003e= ReadIndexï¼Œç„¶åæ‰§è¡Œè¯»è¯·æ±‚ï¼Œå°†ç»“æœè¿”å›ç»™ Clientã€‚ æ—¥å¿—å­˜å‚¨ RAFT å…±æœ‰ä¸¤ç±»æ•°æ®éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼š **RAFT æ—¥å¿—ï¼š**å·²æäº¤çš„æ—¥å¿—æ˜¯ä¸èƒ½ä¸¢å¤±çš„ï¼› èŠ‚ç‚¹çš„çŠ¶æ€ï¼šåŒ…æ‹¬å½“å‰çš„ä»»æœŸ termã€å½“å‰çš„æŠ•ç¥¨ç›®æ ‡ voteã€å·²æäº¤çš„æœ€åä¸€æ¡æ—¥å¿—ç´¢å¼•ã€‚å‰ä¸¤ä¸ªå­—æ®µæ˜¯ leader é€‰ä¸¾æµç¨‹ä¸­çš„æ‰¿è¯ºï¼Œç¬¬ä¸‰ä¸ªå­—æ®µæ˜¯èŠ‚ç‚¹åœ¨é‡å¯æ¢å¤æ—¶ç”¨æ¥æ§åˆ¶æ—¥å¿—å›æ”¾åˆ°å“ªä¸€æ¡æ—¥å¿—ã€‚ WAL é—®ï¼šä»€ä¹ˆæ˜¯ WAL ï¼Ÿ ETCD ä½¿ç”¨ WAL(Write Ahead Logï¼Œé¢„å†™æ—¥å¿—) ä¿å­˜ä¸Šé¢ä¸¤ç§æ•°æ®ã€‚ æ‰€æœ‰æ•°æ®åœ¨æäº¤ä¹‹å‰éƒ½è¦å…ˆå†™å…¥ WAL ä¸­ï¼› ç„¶åå®šæœŸå¯¹æ•°æ®è¿›è¡Œå¿«ç…§å¤‡ä»½ï¼Œå¿«ç…§æ–‡ä»¶å­˜å‚¨äº†æŸä¸€æ—¶åˆ» ETCD çš„æ‰€æœ‰æ•°æ®ï¼Œæ•°æ®å·²ç»å­˜å‚¨åœ¨å¿«ç…§ä¸­çš„ WAL æ–‡ä»¶å°±å¯ä»¥åˆ é™¤ã€‚ é—®ï¼šWAL å¦‚ä½•å·¥ä½œï¼Ÿ WAL çš„å·¥ä½œè¿‡ç¨‹éå¸¸åƒåŒºå—é“¾ï¼š é¦–ä¸ª WAL æ–‡ä»¶çš„æ–‡ä»¶å¼€å¤´ crc32 åˆå§‹å€¼ä¸º 0ï¼Œä¹‹åæ¯ä¸ªè®°å½•(raft æ—¥å¿—æˆ–è€…èŠ‚ç‚¹çŠ¶æ€)çš„ crc32å€¼ = calc(pre_crc32, æœ¬è®°å½•çš„äºŒè¿›åˆ¶å€¼)ï¼› å¯¹äºç¬¬äºŒä¸ªåŠä»¥åçš„ WAL æ–‡ä»¶ï¼Œæ–‡ä»¶å¼€å¤´çš„åˆå§‹ crc32 å€¼ = ä¸Šä¸€ä¸ª wal æ–‡ä»¶æœ€åä¸€æ¡è®°å½•çš„ crc32 å€¼ã€‚ è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰ WAL æ–‡ä»¶ï¼Œå…¶æ‰€æœ‰è®°å½•çš„ crc32 å€¼å¯ä»¥å½¢æˆä¸€ä¸ªå¯è¿›è¡Œå¼ºæ ¡éªŒçš„é“¾è¡¨ã€‚è¿™æ ·åœ¨é‡å¯æ¢å¤çš„æ—¶å€™ï¼ŒETCD å°±å¯ä»¥å¯¹ WAL æ–‡ä»¶çš„å†…å®¹è¿›è¡Œç²¾ç»†åŒ–çš„æ ¡éªŒã€‚ æ—¥å¿—å‹ç¼© WAL æ˜¯ä¸€ç§ Append Only çš„æ—¥å¿—æ–‡ä»¶ï¼Œåªä¼šåœ¨æ–‡ä»¶ç»“å°¾ä¸æ–­åœ°æ·»åŠ æ–°æ—¥å¿—ã€‚å½“æ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼ŒWAL æ–‡ä»¶å°±ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¼šå ç”¨å¤§é‡ç©ºé—´ï¼Œå¹¶ä¸”ï¼Œé€šè¿‡è¿™ä¹ˆå¤§çš„ WAL æ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤æ—¶ï¼Œä¹Ÿä¼šè€—è´¹å¾ˆé•¿æ—¶é—´ã€‚å› æ­¤ï¼ŒåŒ Redis ä¸€æ ·ï¼Œä¼šå®šæœŸåˆ›å»ºå¿«ç…§ï¼Œå°†æ•´ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†™å…¥ç¨³å®šçš„å¿«ç…§æ–‡ä»¶ä¸­ï¼Œåœ¨è¯¥å¿«ç…§æ–‡ä»¶ä¹‹å‰çš„æ—¥å¿—è®°å½•å°±å¯ä»¥å…¨éƒ¨ä¸¢å¼ƒæ‰ã€‚ åœ¨ RATF æ—¥å¿—ä¸­ï¼Œé¦–å…ˆå®šä¹‰å‡ ä¸ªæ¦‚å¿µï¼š **log_indexï¼š**æœ€æ–°çš„æ—¥å¿—ä½ç½®ç´¢å¼•ã€‚ **commit_indexï¼š**å·²è¾¾æˆå¤šæ•°æ´¾ä¸€è‡´ï¼Œå¯æäº¤çš„æœ€å¤§æ—¥å¿—ä½ç½®ç´¢å¼•ã€‚ appl","date":"2023-04-23","objectID":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/:10:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"åˆ†å¸ƒå¼","uri":"/09-%E5%88%86%E5%B8%83%E5%BC%8F/"},{"categories":["é¢è¯•"],"content":"[toc] å‚è€ƒæ–‡ç« ï¼š å¼€æºæ¶ˆæ¯å¼•æ“ç³»ç»Ÿ Kafka 3 æ–°ç‰¹æ€§ https://juejin.cn/post/7176576097205616700 https://mp.weixin.qq.com/s/vzvmOXGcsX7rwY4J_--onw 20é“ç»å…¸çš„Kafkaé¢è¯•é¢˜è¯¦è§£ ã€Šæ·±å…¥ç†è§£Kafkaï¼šæ ¸å¿ƒè®¾è®¡ä¸å®è·µåŸç†ã€‹ ","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:0:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ— è¿™é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—æŒ‡çš„æ˜¯å„ä¸ªæœåŠ¡ä»¥åŠç³»ç»Ÿå†…éƒ¨å„ä¸ªç»„ä»¶/æ¨¡å—ä¹‹å‰çš„é€šä¿¡ï¼Œå±äºä¸€ç§ä¸­é—´ä»¶ã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥é™ä½ç³»ç»Ÿè€¦åˆæ€§ã€å®ç°ä»»åŠ¡å¼‚æ­¥ã€æœ‰æ•ˆåœ°è¿›è¡Œæµé‡å‰Šå³°ï¼Œæ˜¯åˆ†å¸ƒå¼å’Œå¾®æœåŠ¡ç³»ç»Ÿä¸­é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ã€‚ é—®ï¼šä¸ºå•¥è¦ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—æœ‰å•¥ç”¨ï¼Ÿ å…­ä¸ªå­—æ€»ç»“ï¼šè§£è€¦ã€å¼‚æ­¥ã€å‰Šå³° è§£è€¦ ä¼ ç»Ÿæ¨¡å¼ä¸‹ç³»ç»Ÿé—´çš„è€¦åˆæ€§å¤ªå¼ºã€‚ä¸¾ä¸ªä¾‹å­ï¼šç³»ç»Ÿ A é€šè¿‡æ¥å£è°ƒç”¨å‘é€æ•°æ®åˆ° Bã€Cã€D ä¸‰ä¸ªç³»ç»Ÿï¼Œå¦‚æœå°†æ¥ E ç³»ç»Ÿæ¥å…¥æˆ–è€… B ç³»ç»Ÿä¸éœ€è¦æ¥å…¥äº†ï¼Œé‚£ä¹ˆç³»ç»Ÿ A è¿˜éœ€è¦ä¿®æ”¹ä»£ç ï¼Œéå¸¸éº»çƒ¦ã€‚ å¦‚æœç³»ç»Ÿ A äº§ç”Ÿäº†ä¸€æ¡æ¯”è¾ƒå…³é”®çš„æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±è¦æ—¶æ—¶åˆ»åˆ»è€ƒè™‘ Bã€Cã€Dã€E å››ä¸ªç³»ç»Ÿå¦‚æœæŒ‚äº†è¯¥å’‹åŠï¼Ÿè¿™æ¡æ•°æ®å®ƒä»¬æ˜¯å¦éƒ½æ”¶åˆ°äº†ï¼Ÿæ˜¾ç„¶ï¼Œç³»ç»Ÿ A è·Ÿå…¶å®ƒç³»ç»Ÿä¸¥é‡è€¦åˆã€‚ **è€Œå¦‚æœæˆ‘ä»¬å°†æ•°æ®ï¼ˆæ¶ˆæ¯ï¼‰å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦æ¶ˆæ¯çš„ç³»ç»Ÿç›´æ¥è‡ªå·±ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹ã€‚**è¿™æ ·ä¸‹æ¥ï¼Œç³»ç»Ÿ A å°±ä¸éœ€è¦å»è€ƒè™‘è¦ç»™è°å‘é€æ•°æ®ï¼Œä¸éœ€è¦å»ç»´æŠ¤è¿™ä¸ªä»£ç ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘å…¶ä»–ç³»ç»Ÿæ˜¯å¦è°ƒç”¨æˆåŠŸã€å¤±è´¥è¶…æ—¶ç­‰æƒ…å†µï¼Œåæ­£æˆ‘åªè´Ÿè´£ç”Ÿäº§ï¼Œåˆ«çš„æˆ‘ä¸ç®¡ã€‚ å¼‚æ­¥ å°†ç”¨æˆ·çš„è¯·æ±‚æ•°æ®å­˜å‚¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åå°±ç«‹å³è¿”å›ç»“æœï¼Œæ¶ˆæ¯å‘é€è€…ä¸éœ€è¦ç­‰å¾…æ¶ˆæ¯æ¥æ”¶è€…çš„å“åº”ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚éšåï¼Œç³»ç»Ÿå†å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚ å› ä¸ºç”¨æˆ·è¯·æ±‚æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åå°±ç«‹å³è¿”å›ç»™ç”¨æˆ·äº†ï¼Œä½†æ˜¯è¯·æ±‚æ•°æ®åœ¨åç»­çš„ä¸šåŠ¡æ ¡éªŒã€å†™æ•°æ®åº“ç­‰æ“ä½œä¸­å¯èƒ½å¤±è´¥ã€‚å› æ­¤ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥å¤„ç†ä¹‹åï¼Œéœ€è¦é€‚å½“ä¿®æ”¹ä¸šåŠ¡æµç¨‹è¿›è¡Œé…åˆï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨æäº¤è®¢å•ä¹‹åï¼Œè®¢å•æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸èƒ½ç«‹å³è¿”å›ç”¨æˆ·è®¢å•æäº¤æˆåŠŸï¼Œéœ€è¦åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„è®¢å•æ¶ˆè´¹è€…è¿›ç¨‹çœŸæ­£å¤„ç†å®Œè¯¥è®¢å•ä¹‹åï¼Œç”šè‡³å‡ºåº“åï¼Œå†é€šè¿‡ç”µå­é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·è®¢å•æˆåŠŸï¼Œä»¥å…äº¤æ˜“çº çº·ã€‚è¿™å°±ç±»ä¼¼æˆ‘ä»¬å¹³æ—¶æ‰‹æœºè®¢ç«è½¦ç¥¨å’Œç”µå½±ç¥¨ã€‚ å‰Šå³° å…ˆå°†çŸ­æ—¶é—´é«˜å¹¶å‘äº§ç”Ÿçš„äº‹åŠ¡æ¶ˆæ¯å­˜å‚¨åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶ååç«¯æœåŠ¡(mysql)å†æ…¢æ…¢æ ¹æ®è‡ªå·±çš„èƒ½åŠ›å»æ¶ˆè´¹è¿™äº›æ¶ˆæ¯ï¼Œè¿™æ ·å°±é¿å…ç›´æ¥æŠŠåç«¯æœåŠ¡æ‰“å®æ‰ã€‚ é—®ï¼šå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ ç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼šåœ¨åŠ å…¥ MQ ä¹‹å‰ï¼Œä½ ä¸ç”¨è€ƒè™‘æ¶ˆæ¯ä¸¢å¤±æˆ–è€…è¯´ MQ æŒ‚æ‰ç­‰ç­‰çš„æƒ…å†µï¼› ç³»ç»Ÿå¤æ‚æ€§æé«˜ï¼šåŠ å…¥ MQ ä¹‹åï¼Œä½ éœ€è¦ä¿è¯æ¶ˆæ¯æ²¡æœ‰è¢«é‡å¤æ¶ˆè´¹ã€å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€ä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ç­‰ç­‰é—®é¢˜ï¼ ä¸€è‡´æ€§é—®é¢˜ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°å¼‚æ­¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„å¼‚æ­¥ç¡®å®å¯ä»¥æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œä¸‡ä¸€æ¶ˆæ¯çš„çœŸæ­£æ¶ˆè´¹è€…å¹¶æ²¡æœ‰æ­£ç¡®æ¶ˆè´¹æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿè¿™æ ·å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µäº†! é—®ï¼šé˜Ÿåˆ—æ¨¡å‹æ˜¯å•¥ï¼Ÿå­˜åœ¨å•¥é—®é¢˜ï¼Ÿ ä½¿ç”¨é˜Ÿåˆ—ï¼ˆQueueï¼‰ä½œä¸ºæ¶ˆæ¯é€šä¿¡è½½ä½“ï¼Œæ»¡è¶³ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ï¼Œæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ç›´åˆ°è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚ å­˜åœ¨çš„é—®é¢˜ï¼š å‡å¦‚æˆ‘ä»¬å­˜åœ¨è¿™æ ·ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬éœ€è¦å°†ç”Ÿäº§è€…äº§ç”Ÿçš„æ¶ˆæ¯åˆ†å‘ç»™å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”æ¯ä¸ªæ¶ˆè´¹è€…éƒ½èƒ½æ¥æ”¶åˆ°å®Œæ•´çš„æ¶ˆæ¯å†…å®¹ã€‚é˜Ÿåˆ—æ¨¡å‹å°±ä¸å¥½è§£å†³äº†ã€‚ é—®ï¼šå‘å¸ƒ-è®¢é˜…æ¨¡å‹æ˜¯å•¥ï¼Ÿ å‘å¸ƒ-è®¢é˜…æ¨¡å‹ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é˜Ÿåˆ—æ¨¡å‹å­˜åœ¨çš„é—®é¢˜ã€‚ å‘å¸ƒ-è®¢é˜…æ¨¡å‹(Pub-Sub)ä½¿ç”¨ä¸»é¢˜(Topic)ä½œä¸ºæ¶ˆæ¯é€šä¿¡è½½ä½“ï¼Œç±»ä¼¼äºå¹¿æ’­æ¨¡å¼ï¼šå‘å¸ƒè€…å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯é€šè¿‡ä¸»é¢˜ä¼ é€’ç»™æ‰€æœ‰çš„è®¢é˜…è€…ï¼Œåœ¨ä¸€æ¡æ¶ˆæ¯å¹¿æ’­ä¹‹åæ‰è®¢é˜…çš„ç”¨æˆ·åˆ™æ˜¯æ”¶ä¸åˆ°è¯¥æ¡æ¶ˆæ¯çš„ã€‚ åœ¨å‘å¸ƒ-è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªè®¢é˜…è€…ï¼Œé‚£å®ƒå’Œé˜Ÿåˆ—æ¨¡å‹å°±åŸºæœ¬æ˜¯ä¸€æ ·çš„äº†ã€‚æ‰€ä»¥è¯´ï¼Œå‘å¸ƒ-è®¢é˜…æ¨¡å‹åœ¨åŠŸèƒ½å±‚é¢ä¸Šæ˜¯å¯ä»¥å…¼å®¹é˜Ÿåˆ—æ¨¡å‹çš„ã€‚ ","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"äºŒã€Kafka Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ã€‚ ","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"2.1 Kafka åº”ç”¨ç”Ÿæ€ ==Kafka åº”ç”¨æ¶æ„ï¼š== è¿™å¼ å›¾ä¸­å±…äºæ ¸å¿ƒåœ°ä½çš„æ˜¯ Kafka Core çš„é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯å¸¸ç”¨çš„æ¶ˆæ¯å¼•æ“çš„è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œæ˜¯æœ¬ç¯‡çš„é‡ç‚¹ï¼› æ ¸å¿ƒçš„å·¦å³ä¸¤ç«¯åˆ†ä¸¤å±‚ï¼Œä¸‹å±‚åˆ†åˆ«æ˜¯ Producer å’Œ Consumer çš„åŸºç¡€ APIï¼Œæä¾›åŸºç¡€äº‹ä»¶æµæ¶ˆæ¯çš„æ¨é€å’Œæ¶ˆè´¹ï¼›ä¸Šå±‚æä¾›äº†æ›´åŠ é«˜çº§çš„ Connect APIï¼Œèƒ½å¤Ÿå®ç° Kafka å’Œå…¶ä»–æ•°æ®ç³»ç»Ÿçš„è¿æ¥ï¼Œæ¯”å¦‚æ¶ˆæ¯æ•°æ®è‡ªåŠ¨æ¨é€åˆ° MySQL æ•°æ®åº“æˆ–è€…å°† RPC è¯·æ±‚è½¬æ¢ä¸ºäº‹ä»¶æµæ¶ˆæ¯è¿›è¡Œæ¨é€ï¼› æœ€ä¸Šé¢çš„æ˜¯ï¼ŒKafka åŸºäºæ¶ˆæ¯å¼•æ“æ‰“é€ äº†ä¸€ä¸ªæµå¼è®¡ç®—å¹³å° Streamsï¼Œæä¾›æµå¼çš„è®¡ç®—å’Œå­˜å‚¨ä¸€ä½“åŒ–çš„æœåŠ¡ã€‚ ==å…·æœ‰ä¸‰ä¸ªå…³é”®åŠŸèƒ½ï¼š== æ¶ˆæ¯é˜Ÿåˆ—ï¼šå‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯æµï¼Œè¿™ä¸ªåŠŸèƒ½ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿæ˜¯ Kafka ä¹Ÿè¢«å½’ç±»ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„åŸå› ã€‚ å­˜å‚¨äº‹ä»¶æµï¼šKafka ä¼šæŠŠæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæœ‰æ•ˆé¿å…äº†æ¶ˆæ¯ä¸¢å¤±çš„é£é™©ã€‚ å¤„ç†äº‹ä»¶æµï¼šåœ¨æ¶ˆæ¯å‘å¸ƒçš„æ—¶å€™è¿›è¡Œå¤„ç†ï¼ŒKafka æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµå¼å¤„ç†ç±»åº“ã€‚ ==Kafka ä¸»è¦æœ‰ä¸¤å¤§åº”ç”¨åœºæ™¯ï¼š== æ•°æ®æ”¶é›†ï¼šå¯ä»¥å°†ä¸åŒæ¥æºçš„æ•°æ®æµé€šè¿‡Kafkaè¿›è¡Œé›†ä¸­æ”¶é›†å’Œå¤„ç†ï¼› æ¶ˆæ¯é˜Ÿåˆ—ï¼šå»ºç«‹å®æ—¶æµæ•°æ®ç®¡é“ï¼Œä»¥å¯é åœ°åœ¨ç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºä¹‹é—´è·å–æ•°æ®ã€‚ æµå¼å¤„ç†ï¼šæ„å»ºå®æ—¶çš„æµæ•°æ®å¤„ç†ç¨‹åºæ¥è½¬æ¢æˆ–å¤„ç†æ•°æ®æµã€‚ ","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:2:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"2.2 Kafka Core æ¶æ„ 2.2.1 æ¶ˆæ¯æ¨¡å‹ é—®ï¼šKafka ä½¿ç”¨å•¥æ¶ˆæ¯æ¨¡å‹ï¼Ÿ Kafka ä½¿ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å‹ã€‚ æ¶ˆè´¹ç«¯ï¼šæ¶ˆè´¹è€…é€šè¿‡æ¶ˆè´¹è€…ç»„è¿›è¡Œåˆ’åˆ†ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½ç”±æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ¶ˆè´¹ä»é˜Ÿåˆ—çš„å¤´éƒ¨å¼€å§‹ï¼Œåœ¨ HW å‰ç»“æŸï¼› æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯å­˜å‚¨æ˜¯é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼Œåªå…è®¸æ¶ˆæ¯è¿½åŠ å†™å…¥ï¼Œæ­¤å¤–ï¼ŒKafka çš„é˜Ÿåˆ—è¿˜è®¾è®¡äº†é«˜æ°´ä½æœºåˆ¶ï¼Œé¿å…æœªè¢«ä»å‰¯æœ¬å®ŒæˆåŒæ­¥çš„æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ„ŸçŸ¥å¹¶æ¶ˆè´¹ï¼› ç”Ÿäº§ç«¯ï¼šç”Ÿäº§ç«¯çš„ Producer æŒç»­å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯è¿½åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œé€šè¿‡æŒ‡å®šåˆ†åŒºç®—æ³•å¯ä»¥å†³å®šæ¶ˆæ¯å‘å¾€ Topic ä¸‹çš„å“ªä¸ªåˆ†åŒºã€‚ Kafka å°†ç”Ÿäº§è€…å‘å¸ƒçš„æ¶ˆæ¯å‘é€åˆ° **Topic **ä¸­ï¼Œéœ€è¦è¿™äº›æ¶ˆæ¯çš„æ¶ˆè´¹è€…å¯ä»¥è®¢é˜…è¿™äº› **Topic **ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é—®ï¼šKafkaæ¶ˆæ¯æ¨¡å‹ä¸­æœ‰å“ªäº›è§’è‰²å’Œå®ä½“ï¼Ÿ æ¶ˆæ¯æ¨¡å‹çš„å›¾ä¸­ä¹Ÿä¸ºæˆ‘ä»¬å¼•å‡ºäº†ï¼ŒKafka æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ¦‚å¿µï¼š Producer(ç”Ÿäº§è€…)ï¼šå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®š Topic çš„ Partition ä¸­ï¼Œå†™å…¥åˆ° LEO çš„ä½ç½®ï¼› Consumer(æ¶ˆè´¹è€…)ï¼šä»æŒ‡å®šçš„ Topic å’Œ Partition ä¸­æ‹‰å–æˆ–æ¨é€æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šæ¶ˆè´¹ç»„(Consumer Group)å’Œæ¶ˆè´¹ä½ç§»(Consumer Offset)ç­‰å‚æ•°ï¼› Consumer Group(æ¶ˆè´¹è€…ç»„)ï¼šæ¶ˆè´¹è€…ç»„ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆï¼ŒåŒä¸€ä¸ªç»„ä¸­çš„æ¶ˆè´¹è€…å¯¹äºåŒä¸€æ¡æ¶ˆæ¯åªæ¶ˆè´¹ä¸€æ¬¡ã€‚æ¯ä¸ªåˆ†åŒºåªèƒ½ç”±åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…(consumer)æ¥æ¶ˆè´¹(é¿å…ç«äº‰)ï¼Œå¯ä»¥ç”±ä¸åŒçš„æ¶ˆè´¹è€…ç»„æ¥æ¶ˆè´¹ï¼› Controller(ç®¡ç†è€…)ï¼šæ•´ä¸ª Kafka é›†ç¾¤çš„ç®¡ç†è€…è§’è‰²ï¼Œä»»ä½•é›†ç¾¤èŒƒå›´å†…çš„çŠ¶æ€å˜æ›´éƒ½éœ€è¦é€šè¿‡ Controller è¿›è¡Œï¼Œåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯ä¸ªå•ç‚¹çš„æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡é€‰ä¸¾åè®®è¿›è¡Œæ•…éšœè½¬ç§»ï¼› Topicçš„æ–°å»ºå’Œåˆ é™¤ï¼› Partitionçš„æ–°å»ºã€é‡æ–°åˆ†é…ï¼› Broker çš„åŠ å…¥ã€é€€å‡ºï¼› è§¦å‘åˆ†åŒº Leader é€‰ä¸¾ã€‚ Broker(ä»£ç†)ï¼šBrokeræ˜¯Kafkaä¸­è´Ÿè´£å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œå®ƒå¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå¹¶ä¸”é€šè¿‡Zookeeperè¿›è¡Œåè°ƒå’Œç®¡ç†ã€‚ Topic(ä¸»é¢˜)ï¼šä¸€ä¸ªTopicä»£è¡¨ä¸€ç±»æ¶ˆæ¯ï¼Œæ˜¯æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ã€‚æ¯ä¸ªTopicå¯ä»¥è¢«åˆ†ä¸ºå¤šä¸ªåˆ†åŒº(Partition)ï¼Œæ¯ä¸ªåˆ†åŒºå¯ä»¥å­˜å‚¨ä¸€å®šæ•°é‡çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDã€‚Producer å°†æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šçš„ä¸»é¢˜ï¼ŒConsumer é€šè¿‡è®¢é˜…ç‰¹å®šçš„ Topic(ä¸»é¢˜)æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼› Partition(åˆ†åŒº)ï¼šä¸€ä¸ªPartitionæ˜¯Topicçš„ç‰©ç†åˆ’åˆ†ï¼Œæ˜¯æ¶ˆæ¯çš„å­˜å‚¨å•ä½ã€‚æ¯ä¸ªPartitionä¸­çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ¶ˆè´¹ï¼› Replica(å‰¯æœ¬)ï¼šæ¯ä¸ªPartitionå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªå‰¯æœ¬æ˜¯Leaderï¼Œè´Ÿè´£å¤„ç†è¯»å†™è¯·æ±‚ï¼Œå…¶ä»–å‰¯æœ¬æ˜¯Followerï¼Œè´Ÿè´£åŒæ­¥Leaderçš„æ•°æ®ã€‚ â€‹ ä¸»é¢˜ä¸‹çš„æ¯æ¡æ¶ˆæ¯åªä¼šä¿å­˜åœ¨æŸä¸€ä¸ªåˆ†åŒºä¸­ï¼Œè€Œä¸ä¼šåœ¨å¤šä¸ªåˆ†åŒºä¸­è¢«ä¿å­˜å¤šä»½ã€‚ é—®ï¼šKafka æ˜¯é€šè¿‡ Push è¿˜æ˜¯ Pullï¼Ÿ Kafkaä¸­ï¼Œæ¶ˆè´¹ç«¯æ˜¯é€šè¿‡ä¸»åŠ¨ pull æ¶ˆæ¯çš„æ–¹å¼æ¥æ¶ˆè´¹çš„ã€‚ç›´è§‰ä¸Šä¼šè§‰å¾—æœ¬æ¥å°±åº”è¯¥è¿™æ ·ï¼Œä½†å…¶å®ä¸æ˜¯ã€‚Kafka çš„æ–‡æ¡£é‡Œæœ‰è®¨è®ºè¿™ç‚¹ï¼Œä¸»è¦å›´ç»•ï¼šæ¶ˆæ¯æ¶ˆè´¹çš„æµæ§ç­–ç•¥åº”è¯¥æ”¾åœ¨ Broker ç«¯è¿˜æ˜¯ Consumer ç«¯ã€‚ 2.2.2 é›†ç¾¤æ¶æ„ ä¸€ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ Kafka é›†ç¾¤é€šå¸¸å…·å¤‡ï¼š 1 ä¸ªç‹¬ç«‹çš„ ZK é›†ç¾¤ï¼› 3 ä¸ªéƒ¨ç½²åœ¨ä¸åŒèŠ‚ç‚¹çš„ Broker å®ä¾‹ã€‚ å°±ä»¥ä¸€ä¸ªè¿™æ ·çš„å…¸å‹é›†ç¾¤çš„ä¸ºä¾‹æ¥ä»‹ç» Kafka çš„æ•´ä½“æ¶æ„ï¼š 2.2.3 Zookeeper çš„ä½œç”¨ å‚è€ƒæ–‡ç« ï¼š æ·±å…¥è§£è¯»åŸºäº Kafka å’Œ ZooKeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åŸç† ","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:2:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"2.3 æ ¸å¿ƒæœºåˆ¶ 2.3.1 æ°´ä½æœºåˆ¶ é—®ï¼šæ°´ä½æœºåˆ¶çš„ä½œç”¨ï¼Ÿ æ°´ä½æœºåˆ¶å…±æœ‰ä¸¤ä¸ªä½œç”¨ï¼š è¾…åŠ©ä»å‰¯æœ¬å®Œæˆå¼‚æ­¥åŒæ­¥ï¼› å®šä¹‰æ¶ˆæ¯å¯è§æ€§ï¼Œå³æ ‡è¯†å“ªäº›æ¶ˆæ¯å¯æ¶ˆè´¹ã€‚ é—®ï¼šPartition ä¸­çš„æ°´ä½æœºåˆ¶ï¼Ÿâ­ æ¯ä¸ª Partition æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š LSO(Log Stable Offset) æ˜¯èµ·ç‚¹ï¼Œæ­¤åç§»ä¼šéšç€æ¶ˆæ¯è¿‡æœŸæ—¶é—´ç­‰çš„å½±å“ï¼Œé€æ¸å‘å³ç§»åŠ¨ï¼› HW æ˜¯å·²æäº¤æ¶ˆæ¯çš„å¯è§æ€§çš„è¾¹ç•Œï¼Œä»…åœ¨æ­¤åç§»ä¹‹ä¸‹çš„æ¶ˆæ¯å¯¹å¤–æ˜¯å¯è§çš„(æ³¨æ„ï¼Œä¸å« HW æœ¬èº«): Leader HW = min(LEO)ï¼› Follower HW = min(Followeræœ¬åœ° LEO, Leader HW)ã€‚ LEO(Log End Offset) æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ç»ˆç‚¹ï¼Œä¸‹ä¸€æ¡æ¶ˆæ¯å°†åœ¨è¿™ä¸ªåœ°æ–¹å†™å…¥ã€‚ å…¶ä¸­ï¼Œ[LSO, HW) å°±æ˜¯æ¶ˆæ¯çš„å¯è§èŒƒå›´(å·²æäº¤)ã€‚ é—®ï¼šæ°´ä½æ›´æ–°ï¼Ÿâ­ (è¿™ä¸ªæ„Ÿè§‰æœ‰ç‚¹é—®é¢˜ã€‚) ä¸»è¦æ˜¯é«˜æ°´ä½æ˜¯å¦‚ä½•æ›´æ–°çš„ï¼Œè¿™é‡Œç”¨ä¸€ä¸ª 3 å‰¯æœ¬çš„åœºæ™¯æè¿°é«˜æ°´ä½æ˜¯å¦‚ä½•æ›´æ–°åˆ° 5 çš„ï¼š é˜¶æ®µ1ï¼šæ­¤æ—¶ ISR ä¸­æœ€å° LEO ä¸º 4ã€‚å‰¯æœ¬ 1 å‘å‡ºåŒæ­¥è¯·æ±‚ï¼Œè·å– Offset = 4 çš„æ•°æ®ï¼› é˜¶æ®µ2ï¼šåŒæ—¶ï¼ŒHW æ›´æ–°ä¸º 4ï¼› é˜¶æ®µ3ï¼šå½“å‰¯æœ¬ 1 æ”¶åˆ° Offset = 4 çš„æ•°æ®ï¼Œæ›´æ–°æœ¬åœ° LEO ä¸º 5ã€‚æ­¤æ—¶ ISR ä¸­æœ€å° LEO æ›´æ–°ä¸º 5ï¼Œäºæ˜¯ HW æ›´æ–°åˆ° 5ã€‚ å‚è€ƒæ–‡ç« ï¼š https://juejin.cn/post/7070319066325450765 2.3.2 Partition å’Œ Replica Kafka ä¸­é€šè¿‡åˆ†åŒºçš„å¤šå‰¯æœ¬ç­–ç•¥è§£å†³æ¶ˆæ¯å¤‡ä»½é—®é¢˜ï¼Œæœ‰å¦‚ä¸‹æ¦‚å¿µï¼š AR: **æ‰€æœ‰å‰¯æœ¬(replicas)**ç»Ÿç§°ä¸ºassigned replicasï¼Œå³ ARï¼› ISR: leader å‰¯æœ¬ ä»¥åŠä¸ leader å‰¯æœ¬ä¿æŒä¸€å®šåŒæ­¥çš„ follower å‰¯æœ¬ï¼Œå« In Sync Replicaï¼› OSR: ä¸ leader å‰¯æœ¬åŒæ­¥æ•°æ®æœ‰ä¸€äº›å»¶è¿Ÿçš„ follower èŠ‚ç‚¹ã€‚ é—®ï¼šKafka çš„å¤šåˆ†åŒº(Partition)ä»¥åŠå¤šå‰¯æœ¬(Replica)æœºåˆ¶æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿâ­ å¤šåˆ†åŒº(Partition)çš„å¥½å¤„ï¼š è§£å†³ä¼¸ç¼©æ€§é—®é¢˜ï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½ï¼šæ¯ä¸ªTopicå¯ä»¥è¢«åˆ’åˆ†ä¸ºå¤šä¸ªPartitionï¼Œå„ä¸ªPartitionå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„Brokerä¸Šï¼Œæ¯ä¸ªPartitionå¯ä»¥è¢«ä¸åŒçš„Producerå’ŒConsumerå¹¶è¡Œè¯»å†™ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚ å¤šå‰¯æœ¬(Replica)çš„å¥½å¤„ï¼š æé«˜å®¹é”™èƒ½åŠ›ï¼šæ¯ä¸ªPartitionå¯ä»¥æœ‰å¤šä¸ªReplicaï¼Œå…¶ä¸­ä¸€ä¸ªReplicaæ˜¯Leaderï¼Œè´Ÿè´£å¤„ç†è¯»å†™è¯·æ±‚ï¼Œå…¶ä»–Replicaæ˜¯Followerï¼Œè´Ÿè´£åŒæ­¥Leaderçš„æ•°æ®ã€‚å½“Leaderå‡ºç°æ•…éšœæ—¶ï¼ŒZookeeperä¼šè‡ªåŠ¨é€‰ä¸¾ä¸€ä¸ªFollowerä½œä¸ºæ–°çš„Leaderï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨ã€‚ é—®ï¼šKafka åˆ†åŒºçš„åˆ†é…ç­–ç•¥æœ‰å“ªäº›ï¼Ÿâ­ æ¶ˆè´¹è€…ä¸ä¸»é¢˜ä¹‹é—´çš„åˆ†åŒºåˆ†é…ç­–ç•¥ï¼šç”¨æ¥è§£å†³åˆ°åº•ç”±å“ªä¸ªconsumeræ¥æ¶ˆè´¹å“ªä¸ªpartitionçš„æ•°æ®ã€‚Kafka æä¾›äº†é»˜è®¤çš„åˆ†åŒºç­–ç•¥ï¼ŒåŒæ—¶æ”¯æŒè‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚ Range(å¹³å‡)ï¼šå°†æ¯ä¸ªä¸»é¢˜çš„åˆ†åŒºå¹³å‡åˆ†é…ç»™æ¶ˆè´¹è€…ã€‚è¿™ç§ç­–ç•¥é€‚åˆæ¯ä¸ªä¸»é¢˜çš„åˆ†åŒºæ•°ç›¸åŒï¼Œä¸”æ¶ˆè´¹è€…æ•°é‡ç¨³å®šçš„åœºæ™¯ã€‚ Round Robin(è½®è¯¢)â­ï¼šè½®æµå°†æ¯ä¸ªåˆ†åŒºåˆ†é…ç»™æ¶ˆè´¹è€…ã€‚è¿™ç§ç­–ç•¥é€‚åˆæ¯ä¸ªä¸»é¢˜çš„åˆ†åŒºæ•°ä¸åŒï¼Œä¸”éœ€è¦å®ç°è´Ÿè½½å‡è¡¡çš„åœºæ™¯ã€‚ Sticky(ç²˜æ€§)ï¼šåœ¨ä¿æŒä¹‹å‰åˆ†é…ç»“æœä¸å˜çš„å‰æä¸‹ï¼Œå°½é‡å‡å°‘å†å¹³è¡¡æ—¶é‡æ–°åˆ†é…çš„åˆ†åŒºæ•°é‡ã€‚è¿™ç§ç­–ç•¥é€‚åˆéœ€è¦é¿å…é¢‘ç¹å†å¹³è¡¡å¯¼è‡´æ€§èƒ½ä¸‹é™çš„åœºæ™¯ã€‚ é—®ï¼šLeader Replica å’Œ Follower Replica çš„åŒæ­¥æœºåˆ¶ï¼Ÿâ­ ==// TODO== é—®ï¼šPartition çš„å¹¶å‘æ€§ï¼Ÿ ä¸€å¥è¯æ€»ç»“ï¼šåŒä¸€ä¸ª Topic ä¸åŒ Partition ä¹‹é—´æ˜¯æ”¯æŒå¹¶å‘å†™å…¥æ¶ˆæ¯çš„ï¼ŒåŒä¸€ä¸ª Partition ä¸æ”¯æŒå¹¶å‘å†™å…¥æ¶ˆæ¯ã€‚ è¿™å¾ˆå¥½ç†è§£ï¼Œå•ä¸ª Partition æ˜¯ä¸´ç•Œèµ„æºï¼Œéœ€è¦ç”¨é”æ¥è¿›è¡Œå†²çªæ£€æµ‹ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€æ‰¹æ¶ˆæ¯åœ¨å†™å…¥é¿å…å‡ºç°æ¶ˆæ¯ä¹±åºæˆ–è€…å†™å…¥è¢«è¦†ç›–çš„æƒ…å†µã€‚ é—®ï¼šKafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„æ¶ˆè´¹é¡ºåºï¼Ÿâ­ Kafka æ˜¯ä¸èƒ½ä¿è¯å…¨å±€æ¶ˆæ¯é¡ºåºçš„ï¼Œåªèƒ½ä¿è¯å•ä¸ª Partition ä¸‹çš„é¡ºåº Kafka ä¸­ Partition(åˆ†åŒº) æ˜¯çœŸæ­£ä¿å­˜æ¶ˆæ¯çš„åœ°æ–¹ï¼Œæ¯æ¬¡æ·»åŠ æ¶ˆæ¯åˆ° Partition(åˆ†åŒº) çš„æ—¶å€™éƒ½ä¼šé‡‡ç”¨å°¾åŠ æ³•ï¼Œå³ Kafka åªèƒ½ä¸ºæˆ‘ä»¬ä¿è¯ å•ä¸ªPartition(åˆ†åŒº) ä¸­çš„æ¶ˆæ¯æœ‰åºã€‚å› æ­¤ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§åšæ³•ï¼š ä¸€ä¸ª Topic åªæ‹¥æœ‰ä¸€ä¸ª Partitionï¼› åœ¨éœ€è¦ä¿è¯é¡ºåºçš„åœºæ™¯å¯ä»¥ä½¿ç”¨ Key-Ordering ç­–ç•¥å°†åŒä¸€ä¸ªç”¨æˆ·çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€åˆ†åŒºï¼Œå³å¯ä¿è¯é¡ºåºã€‚ä¾‹å¦‚è®¢å•IDæˆ–ç”¨æˆ·IDç­‰ï¼Œè¿™æ ·åŒä¸€ä¸šåŠ¡å­—æ®µçš„æ¶ˆæ¯ä¼šå‘é€åˆ°åŒä¸€åˆ†åŒºï¼Œå¹¶ä¸”æ¶ˆè´¹è€…ä¹ŸæŒ‰ç…§ä¸šåŠ¡å­—æ®µè¿›è¡Œæ¶ˆè´¹ã€‚ 2.3.3 æŒä¹…åŒ– Kafka é€šè¿‡ï¼š ä½¿ç”¨**æ—¥å¿—(Log)**æ¥ä¿å­˜æ•°æ®ï¼Œä¸€ä¸ªæ—¥å¿—å°±æ˜¯ç£ç›˜ä¸Šä¸€ä¸ªåªèƒ½è¿½åŠ å†™(Append-only)æ¶ˆæ¯çš„ç‰©ç†æ–‡ä»¶ï¼› æ—¥å¿—è¶Šæ¥è¶Šå¤§ï¼Œå¿…ç„¶è¦å®šæœŸåœ°åˆ é™¤æ—¥å¿—ä»¥å›æ”¶ç£ç›˜ï¼Œè¿™æ˜¯é€šè¿‡æ—¥å¿—æ®µ(Log Segment)æœºåˆ¶ã€‚ Kafka çš„æ—¥å¿—æ¶æ„ï¼š ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Topic æœ‰å¾ˆå¤š Partitionï¼Œæ¯ä¸ª Partition å°±å¯¹åº”ä¸€ä¸ª Log å¯¹è±¡ï¼Œåœ¨ç‰©ç†ç£ç›˜ä¸Šåˆ™å¯¹åº”äºä¸€ä¸ªå­ç›®å½•ã€‚æ¯”å¦‚åˆ›å»ºäº†ä¸€ä¸ªåŒ Partition çš„ Topic:test-topicï¼Œé‚£ä¹ˆï¼ŒKafka åœ¨ç£ç›˜ä¸Šä¼šåˆ›å»ºä¸¤ä¸ªå­ç›®å½•ï¼štest-topic-0 å’Œ test-topic-1ã€‚è€Œåœ¨æœåŠ¡å™¨ç«¯ï¼Œè¿™å°±æ˜¯ä¸¤ä¸ª Log å¯¹è±¡ï¼Œæ¯ä¸ªå­ç›®å½•ä¸‹å­˜åœ¨å¤šç»„æ—¥å¿—æ®µï¼Œä¹Ÿå°±æ˜¯å¤šç»„.logã€.indexã€.timeindexæ–‡ä»¶ç»„åˆï¼Œåªä¸è¿‡æ–‡ä»¶åä¸åŒï¼Œå› ä¸ºæ¯ä¸ªæ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»ä¸åŒã€‚ 2.3.4 æ¶ˆæ¯ä¸¢å¤±ä¸é‡å¤æ¶ˆè´¹ æ¶ˆæ¯ä¸¢å¤± ä¸€å¥è¯æ¦‚æ‹¬ï¼ŒKafka åªå¯¹â€œå·²æäº¤â€çš„æ¶ˆæ¯(committed message)åšæœ‰é™åº¦çš„æŒä¹…åŒ–ä¿è¯ã€‚ ç¬¬ä¸€ä¸ªæ ¸å¿ƒè¦ç´ æ˜¯å·²æäº¤çš„æ¶ˆæ¯ã€‚ ä»€ä¹ˆæ˜¯å·²æäº¤çš„æ¶ˆæ¯ï¼Ÿå½“ Kafka çš„è‹¥å¹²ä¸ª Broker æˆåŠŸåœ°æ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯å¹¶å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶åï¼Œå®ƒä»¬ä¼šå‘Šè¯‰ç”Ÿäº§è€…ç¨‹åºè¿™æ¡æ¶ˆæ¯å·²æˆåŠŸæäº¤ã€‚æ­¤æ—¶ï¼Œè¿™æ¡æ¶ˆæ¯åœ¨ Kafka çœ‹æ¥å°±æ­£å¼å˜ä¸ºâ€œå·²æäº¤â€æ¶ˆæ¯äº†ã€‚ é‚£ä¸ºä»€ä¹ˆæ˜¯è‹¥å¹²ä¸ª Broker å‘¢ï¼Ÿè¿™å–å†³äºä½ å¯¹â€œå·²æäº¤â€çš„å®šä¹‰ã€‚ä½ å¯ä»¥é€‰æ‹©åªè¦æœ‰ä¸€ä¸ª Broker æˆåŠŸä¿å­˜è¯¥æ¶ˆæ¯å°±ç®—æ˜¯å·²æäº¤ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»¤æ‰€æœ‰ Broker éƒ½æˆåŠŸä¿å­˜è¯¥æ¶ˆæ¯æ‰ç®—æ˜¯å·²æäº¤ã€‚ä¸è®ºå“ªç§æƒ…å†µï¼ŒKafka åªå¯¹å·²æäº¤çš„æ¶ˆæ¯åšæŒä¹…åŒ–ä¿è¯è¿™ä»¶äº‹æƒ…æ˜¯ä¸å˜çš„ã€‚ ==æ€»ç»“ï¼š==å½“è¾¾åˆ°è®¾å®šæ•°é‡çš„BrokeræˆåŠŸæ¥æ”¶æ¶ˆæ¯å¹¶å†™å…¥ä¿å­˜ä¹‹åï¼Œè¯¥æ¶ˆæ¯å°±è®¤ä¸ºæ˜¯å·²æäº¤çš„ã€‚ ç¬¬äºŒä¸ªæ ¸å¿ƒè¦ç´ å°±æ˜¯æœ‰é™åº¦çš„æŒä¹…åŒ–ä¿è¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ Kafka ä¸å¯èƒ½ä¿è¯åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½åšåˆ°ä¸ä¸¢å¤±æ¶ˆæ¯ã€‚ æœ‰é™åº¦å…¶å®å°±æ˜¯è¯´ Kafka ä¸ä¸¢æ¶ˆæ¯æ˜¯æœ‰å‰ææ¡ä»¶çš„ã€‚å‡å¦‚ä½ çš„æ¶ˆæ¯ä¿å­˜åœ¨ N ä¸ª Kafka Broker ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªå‰ææ¡ä»¶å°±æ˜¯è¿™ N ä¸ª Broker ä¸­è‡³å°‘æœ‰ 1 ä¸ªå­˜æ´»ã€‚åªè¦è¿™ä¸ªæ¡ä»¶æˆç«‹ï¼ŒKafka å°±èƒ½ä¿è¯ä½ çš„è¿™æ¡æ¶ˆæ¯æ°¸è¿œä¸ä¼šä¸¢å¤±ã€‚ é—®ï¼šKafka å¦‚ä½•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼Ÿ åœ¨ä½¿ç”¨ MQ çš„æ—¶å€™æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ¶ˆæ¯ä¸¢å¤±ï¼Œå¸¸è§çš„ä¸¢å¤±æƒ…å†µå¦‚ä¸‹ï¼š 1ï¼‰Producer ç«¯ä¸¢å¤± 2ï¼‰Broker ç«¯ä¸¢å¤± 3ï¼‰Consumer ç«¯ä¸¢å¤± ä¸€æ¡æ¶ˆæ¯ä»ç”Ÿäº§åˆ°æ¶ˆè´¹ä¸€å…±è¦ç»è¿‡ä»¥ä¸‹ 3 ä¸ªæµç¨‹ï¼š 1ï¼‰Producer å‘é€åˆ° Broker 2ï¼‰Broker ä¿å­˜æ¶ˆæ¯(æŒä¹…åŒ–) 3ï¼‰Consumer æ¶ˆè´¹æ¶ˆæ¯ 3 ä¸ªæ­¥éª¤åˆ†åˆ«å¯¹åº”äº†ä¸Šè¿°çš„ 3 ç§æ¶ˆæ¯ä¸¢å¤±åœºæ™¯ï¼š ==å®é™…æƒ…å†µåˆ†æï¼š== Producer ç«¯ä¸¢å¤± **åŸå› ï¼š**ç”±äºç½‘ç»œæˆ–è€…Brokerå¼‚å¸¸é€ æˆçš„ã€‚ è§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯é‡ä¼ ã€‚ å…·ä½“å®ç°ï¼šProducer ä¸ä½¿ç”¨fire and forgetçš„å‘é€æ–¹å¼ï¼Œæ°¸è¿œè¦ä½¿ç”¨å¸¦æœ‰å›è°ƒé€šçŸ¥çš„å‘é€ APIï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¦ä½¿ç”¨ producer.send(msg)ï¼Œè€Œè¦ä½¿ç”¨ producer.send(msg, callback)ã€‚é€šè¿‡å›è°ƒï¼Œå¦‚æœProducerå‘é€æ¶ˆæ¯åæ²¡æœ‰æ”¶åˆ°Brokerçš„ç¡®è®¤å›å¤ï¼Œå°±ä¼šè®¤ä¸ºå‘é€å¤±è´¥ï¼Œè¿›è€Œé‡ä¼ ã€‚å¦‚æœé‡è¯•ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤ï¼›å¦‚æœæ”¾å¼ƒï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ Broker ç«¯ä¸¢å¤± åŸå› ï¼šKafka ä¸ºäº†å‡å°‘ç£ç›˜ I/Oï¼Œé‡‡ç”¨å¼‚æ­¥æ‰¹é‡çš„åˆ·ç›˜ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§ä¸€å®šçš„æ¶ˆæ¯é‡å’Œé—´éš”æ—¶é—´è¿›è¡Œåˆ·ç›˜ã€‚Kafka æ”¶åˆ°æ¶ˆæ¯åä¼šå…ˆå­˜å‚¨åœ¨ä¹Ÿç¼“å­˜ä¸­(Page Cache)ä¸­ï¼Œä¹‹åç”±æ“ä½œç³»ç»Ÿæ ¹æ®è‡ªå·±çš„ç­–ç•¥è¿›è¡Œåˆ·ç›˜æˆ–è€…é€šè¿‡ fsync å‘½ä»¤å¼ºåˆ¶åˆ·ç›˜ã€‚å¦‚æœç³»ç»ŸæŒ‚æ‰ï¼Œåœ¨ PageCache ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚ è§£å†³æ–¹æ¡ˆï¼šè€ƒè™‘ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½² Kafka æœåŠ¡ï¼Œé€šè¿‡éƒ¨ç½²å¤šä¸ªå‰¯æœ¬å¤‡ä»½æ•°æ®ï¼Œä¿è¯æ¶ˆæ¯å°½é‡ä¸ä¸¢å¤±ã€‚ å…·ä½“å®ç°ï¼šKafka é›†ç¾¤ä¸­æœ‰ä¸€ä¸ª Leader è´Ÿè´£æ¶ˆæ¯çš„å†™å…¥å’Œæ¶ˆè´¹ï¼Œå¯ä»¥æœ‰å¤šä¸ª Follower è´Ÿè´£æ•°æ®çš„å¤‡ä»½ã€‚Follower ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„é›†åˆå«åš ISRï¼Œå½“ Leader æ•…éšœæ—¶ï¼Œä¼šä» ISR ä¸­æ–°é€‰ä¸¾å‡ºæ¥ Leaderã€‚Leader çš„æ•°æ®ä¼šå¼‚æ­¥åœ°å¤åˆ¶ç»™ Followerï¼Œè¿™æ ·åœ¨ Leader å‘ç”Ÿæ‰ç”µæˆ–è€…å®•æœºæ—¶ï¼ŒKafka ä¼šä» Follower ä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼Œå‡å°‘æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½ã€‚ ç”±äºæ¶ˆæ¯æ˜¯å¼‚æ­¥åœ°ä» Leader å¤åˆ¶åˆ° Follower çš„ï¼Œæ‰€ä»¥ä¸€æ—¦ Leader å®•æœºï¼Œé‚£äº›è¿˜æ²¡æœ‰æ¥å¾—åŠå¤åˆ¶åˆ° Follower çš„æ¶ˆæ¯è¿˜æ˜¯ä¼šä¸¢å¤±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKafka ä¸ºç”Ÿäº§è€…æä¾›ä¸€ä¸ªé€‰é¡¹å«åš acksï¼Œå½“è¿™ä¸ªé€‰é¡¹è¢«è®¾ç½®ä¸º all æ—¶ï¼Œç”Ÿäº§è€…å‘é€çš„æ¯ä¸€æ¡æ¶ˆæ¯é™¤äº†å‘ç»™ Leader å¤–è¿˜ä¼šå‘ç»™æ‰€æœ‰çš„ ISRï¼Œå¹¶ä¸”å¿…é¡»å¾—åˆ° Leader å’Œæ‰€æœ‰ IS","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:2:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€å¸¸è§é¢è¯•é¢˜ ä»€ä¹ˆæ˜¯ Kafkaï¼Œå®ƒæœ‰å“ªäº›ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼Ÿ Kafka çš„æ¶æ„æ˜¯æ€æ ·çš„ï¼Œå®ƒåŒ…å«å“ªäº›ç»„ä»¶å’Œè§’è‰²ï¼Ÿ Kafka æ˜¯å¦‚ä½•å®ç°é«˜ååé‡å’Œé«˜å¯ç”¨æ€§çš„ï¼Ÿ Kafka æ˜¯å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§å’Œä¸€è‡´æ€§çš„ï¼Ÿ Kafka æ˜¯å¦‚ä½•å®ç°åˆ†åŒºå’Œå‰¯æœ¬çš„ï¼Œå®ƒä»¬æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ Kafka æ˜¯å¦‚ä½•å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„é€šä¿¡çš„ï¼Œå®ƒä»¬æœ‰å“ªäº›å‚æ•°å’Œç­–ç•¥å¯ä»¥é…ç½®ï¼Ÿ Kafka æ˜¯å¦‚ä½•ç»´æŠ¤æ¶ˆè´¹è€…çš„æ¶ˆè´¹çŠ¶æ€å’Œåç§»é‡çš„ï¼Œå®ƒä»¬å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ Kafkaä½¿ç”¨æ¶ˆè´¹è€…ç»„æ¥ç»´æŠ¤æ¶ˆè´¹è€…çš„æ¶ˆè´¹çŠ¶æ€å’Œåç§»é‡ã€‚æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šè¯»å–ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶åç§»é‡å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚Kafkaä½¿ç”¨ä¸€ä¸ªåä¸º__consumer_offsetsçš„å†…éƒ¨ä¸»é¢˜æ¥å­˜å‚¨æ¶ˆè´¹è€…ç»„çš„åç§»é‡ä¿¡æ¯ã€‚æ¯ä¸ªæ¶ˆè´¹è€…ç»„éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„__consumer_offsetsä¸»é¢˜ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªåˆ†åŒºçš„åç§»é‡ä¿¡æ¯ã€‚æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šå®šæœŸå°†å…¶åç§»é‡æäº¤åˆ°__consumer_offsetsä¸»é¢˜ä¸­ï¼Œä»¥ä¾¿å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥çŸ¥é“å“ªäº›æ•°æ®å·²ç»è¢«æ¶ˆè´¹ï¼Œå“ªäº›æ•°æ®è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ã€‚ Kafka æœ‰å“ªäº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼Œå®ƒä¸å…¶ä»–æ¶ˆæ¯ç³»ç»Ÿæœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ Zookeeper å¯¹äº Kafka çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå¦‚æœ Zookeeper å®•æœºäº†ä¼šæ€æ ·ï¼Ÿ å¦‚ä½•ç›‘æ§å’Œåº¦é‡ Kafka çš„è¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡ï¼Ÿ å¦‚ä½•ä¼˜åŒ– Kafka çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ€§èƒ½ï¼Œæé«˜ååé‡å’Œé™ä½å»¶è¿Ÿï¼Ÿ å¦‚ä½•ä¿è¯ Kafka çš„æ•°æ®å®‰å…¨æ€§ï¼Œé¿å…æ•°æ®ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹ï¼Ÿ å¦‚ä½•å¤„ç† Kafka çš„å¼‚å¸¸æƒ…å†µï¼Œæ¯”å¦‚åˆ†åŒºä¸å¹³è¡¡ã€ä¸»ä»åˆ‡æ¢ã€æ¶ˆæ¯å †ç§¯ç­‰ï¼Ÿ é—®ï¼šKafkaæ˜¯ä»€ä¹ˆï¼Ÿ Kafka æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶ï¼Œç”¨äºå®æ—¶æ„å»ºæµå¤„ç†åº”ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒçš„åŠŸèƒ½å¹¿ä¸ºäººçŸ¥ï¼Œå³ä½œä¸ºä¼ä¸šçº§çš„æ¶ˆæ¯å¼•æ“è¢«å¹¿æ³›ä½¿ç”¨ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿâ­ æ ‡å‡†ç­”æ¡ˆï¼šå…³äºå®ƒçš„å®šä¹‰ï¼Œå®˜ç½‘ä¸Šçš„ä»‹ç»è¨€ç®€æ„èµ…ï¼Œ**å³æ¶ˆè´¹è€…ç»„æ˜¯ Kafka æä¾›çš„å¯æ‰©å±•ä¸”å…·æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚**åˆ‡è®°ï¼Œä¸€å®šè¦åŠ ä¸Šå‰é¢é‚£å¥ï¼Œä»¥æ˜¾ç¤ºä½ å¯¹å®˜ç½‘å¾ˆç†Ÿæ‚‰ã€‚ å¦å¤–ï¼Œæœ€å¥½å†ä»‹ç»ä¸‹æ¶ˆè´¹è€…ç»„çš„åŸç†ï¼šåœ¨ Kafka ä¸­ï¼Œæ¶ˆè´¹è€…ç»„æ˜¯ä¸€ä¸ªç”±å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹æ„æˆçš„ç»„ã€‚å¤šä¸ªå®ä¾‹å…±åŒè®¢é˜…è‹¥å¹²ä¸ªä¸»é¢˜ï¼Œå®ç°å…±åŒæ¶ˆè´¹ã€‚åŒä¸€ä¸ªç»„ä¸‹çš„æ¯ä¸ªå®ä¾‹éƒ½é…ç½®æœ‰ç›¸åŒçš„ç»„IDï¼Œè¢«åˆ†é…ä¸åŒçš„è®¢é˜…åˆ†åŒºã€‚å½“æŸä¸ªå®ä¾‹æŒ‚æ‰çš„æ—¶å€™ï¼Œå…¶ä»–å®ä¾‹ä¼šè‡ªåŠ¨åœ°æ‰¿æ‹…èµ·å®ƒè´Ÿè´£æ¶ˆè´¹çš„åˆ†åŒºã€‚ æ­¤æ—¶ï¼Œåˆæœ‰ä¸€ä¸ªå°æŠ€å·§ç»™åˆ°ä½ ï¼šæ¶ˆè´¹è€…ç»„çš„é¢˜ç›®ï¼Œèƒ½å¤Ÿå¸®ä½ åœ¨æŸç§ç¨‹åº¦ä¸ŠæŒæ§ä¸‹é¢çš„é¢è¯•æ–¹å‘ã€‚ å¦‚æœä½ æ“…é•¿ä½ç§»å€¼åŸç†ï¼Œå°±ä¸å¦¨å†æä¸€ä¸‹æ¶ˆè´¹è€…ç»„çš„ä½ç§»æäº¤æœºåˆ¶ï¼› å¦‚æœä½ æ“…é•¿Kafka Brokerï¼Œå¯ä»¥æä¸€ä¸‹æ¶ˆè´¹è€…ç»„ä¸Brokerä¹‹é—´çš„äº¤äº’ï¼› å¦‚æœä½ æ“…é•¿ä¸æ¶ˆè´¹è€…ç»„å®Œå…¨ä¸ç›¸å…³çš„Producerï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿™ä¹ˆè¯´ï¼šâ€œæ¶ˆè´¹è€…ç»„è¦æ¶ˆè´¹çš„æ•°æ®å®Œå…¨æ¥è‡ªäºProducerç«¯ç”Ÿäº§çš„æ¶ˆæ¯ï¼Œæˆ‘å¯¹Producerè¿˜æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ã€‚â€ ä½¿ç”¨è¿™ä¸ªç­–ç•¥çš„è¯ï¼Œé¢è¯•å®˜å¯èƒ½ä¼šè¢«ä½ çš„è¯æœ¯æ‰€å½±å“ï¼Œåç¦»ä»–ä¹‹å‰æƒ³é—®çš„çŸ¥è¯†è·¯å¾„ã€‚å½“ç„¶äº†ï¼Œå¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ“…é•¿ï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹çœ‹é¢˜ç›®å§ã€‚ é—®ï¼šåœ¨ Kafka ä¸­ï¼ŒZooKeeper çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼ŸğŸš©â­ è¿™æ˜¯ä¸€é“èƒ½å¤Ÿå¸®åŠ©ä½ è„±é¢–è€Œå‡ºçš„é¢˜ç›®ã€‚ç¢°åˆ°è¿™ä¸ªé¢˜ç›®ï¼Œè¯·åœ¨å¿ƒä¸­æš—ç¬‘ä¸‰å£°ã€‚ æ ‡å‡†ç­”æ¡ˆï¼šç›®å‰ï¼ŒKafka ä½¿ç”¨ ZooKeeper å­˜æ”¾é›†ç¾¤å…ƒæ•°æ®ã€æˆå‘˜ç®¡ç†ã€Controller é€‰ä¸¾ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ç®¡ç†ç±»ä»»åŠ¡ã€‚KIP-500 ææ¡ˆä¹‹åï¼ŒKafka å°±ä¸å†ä¾èµ–äº ZooKeeperã€‚ å­˜æ”¾å…ƒæ•°æ®ï¼šæ˜¯æŒ‡ä¸»é¢˜åˆ†åŒºçš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ZooKeeperä¸­ï¼Œä¸”ä»¥å®ƒä¿å­˜çš„æ•°æ®ä¸ºæƒå¨ï¼Œå…¶ä»–â€œäººâ€éƒ½è¦ä¸å®ƒä¿æŒå¯¹é½ï¼› æˆå‘˜ç®¡ç†ï¼šæ˜¯æŒ‡BrokerèŠ‚ç‚¹çš„æ³¨å†Œã€æ³¨é”€ä»¥åŠå±æ€§å˜æ›´ï¼› Controlleré€‰ä¸¾ï¼šæ˜¯æŒ‡é€‰ä¸¾é›†ç¾¤Controllerï¼Œè€Œå…¶ä»–ç®¡ç†ç±»ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äºä¸»é¢˜åˆ é™¤ã€å‚æ•°é…ç½®ç­‰ã€‚ KIP-500ï¼šæ˜¯ä½¿ç”¨ç¤¾åŒºè‡ªç ”çš„åŸºäºRaftçš„å…±è¯†ç®—æ³•ï¼Œæ›¿ä»£ZooKeeperï¼Œå®ç°Controllerè‡ªé€‰ä¸¾ã€‚ é—®ï¼šè§£é‡Šä¸‹ Kafka ä¸­ä½ç§»(offset)çš„ä½œç”¨ï¼Ÿ åœ¨ Kafka ä¸­ï¼Œæ¯ä¸ª Partition ä¸‹çš„æ¯æ¡æ¶ˆæ¯éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªå”¯ä¸€çš„ ID æ•°å€¼ï¼Œç”¨äºæ ‡è¯†å®ƒåœ¨åˆ†åŒºä¸­çš„ä½ç½®ã€‚è¿™ä¸ªIDæ•°å€¼ï¼Œå°±è¢«ç§°ä¸ºä½ç§»ï¼Œæˆ–è€…å«åç§»é‡ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«å†™å…¥åˆ°åˆ†åŒºæ—¥å¿—ï¼Œå®ƒçš„ä½ç§»å€¼å°†ä¸èƒ½è¢«ä¿®æ”¹ã€‚ ä¸»è¦æ˜¯ç”¨æ¥ï¼š è®°å½•å½“å‰æ¶ˆè´¹åˆ°å“ªé‡Œäº†ï¼Ÿ è®°å½•å½“å‰æ—¥å¿—æäº¤åˆ°å“ªé‡Œäº†ï¼Ÿå¼•å‡ºæ°´ä½æœºåˆ¶ã€‚ é—®ï¼šé˜è¿°ä¸‹ Kafka ä¸­çš„ä¸»å‰¯æœ¬(Leader Replica)å’Œä»å‰¯æœ¬(Follower Replica)çš„åŒºåˆ«ï¼Ÿ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼šKafka å‰¯æœ¬åˆ†ä¸º Leader å‰¯æœ¬å’Œ Replica å‰¯æœ¬ã€‚åªæœ‰ Leader å‰¯æœ¬æ‰èƒ½å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œå“åº” Clients ç«¯çš„è¯·æ±‚ã€‚Follower å‰¯æœ¬åªæ˜¯é‡‡ç”¨æ‹‰(PULL)çš„æ–¹å¼ï¼Œè¢«åŠ¨åœ°åŒæ­¥Leaderå‰¯æœ¬ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨ Leader å‰¯æœ¬æ‰€åœ¨çš„ Broker å®•æœºåï¼Œéšæ—¶å‡†å¤‡é€‰ä¸¾æˆ Leader å‰¯æœ¬ï¼Œå®ç°é«˜å¯ç”¨æ€§ã€‚ é€šå¸¸æ¥è¯´ï¼Œå›ç­”åˆ°è¿™ä¸ªç¨‹åº¦ï¼Œå…¶å®æ‰åªè¯´äº†60%ï¼Œå› æ­¤ï¼Œæˆ‘å»ºè®®ä½ å†å›ç­”ä¸¤ä¸ªé¢å¤–çš„åŠ åˆ†é¡¹ã€‚ å¼ºè°ƒ Follower å‰¯æœ¬ä¹Ÿèƒ½å¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚è‡ª Kafka 2.4 ç‰ˆæœ¬å¼€å§‹ï¼Œç¤¾åŒºé€šè¿‡å¼•å…¥æ–°çš„ Broker ç«¯å‚æ•°ï¼Œå…è®¸ Follower å‰¯æœ¬æœ‰é™åº¦åœ°æä¾›è¯»æœåŠ¡ï¼› å¼ºè°ƒ Leader å’Œ Follower çš„æ¶ˆæ¯åºåˆ—åœ¨å®é™…åœºæ™¯ä¸­ä¸ä¸€è‡´ã€‚å¾ˆå¤šåŸå› éƒ½å¯èƒ½é€ æˆLeaderå’ŒFollowerä¿å­˜çš„æ¶ˆæ¯åºåˆ—ä¸ä¸€è‡´ï¼Œæ¯”å¦‚ç¨‹åºBugã€ç½‘ç»œé—®é¢˜ç­‰ã€‚è¿™æ˜¯å¾ˆä¸¥é‡çš„é”™è¯¯ï¼Œå¿…é¡»è¦å®Œå…¨è§„é¿ã€‚ä½ å¯ä»¥è¡¥å……ä¸‹ï¼Œä¹‹å‰ç¡®ä¿ä¸€è‡´æ€§çš„ä¸»è¦æ‰‹æ®µæ˜¯é«˜æ°´ä½æœºåˆ¶ï¼Œä½†é«˜æ°´ä½å€¼æ— æ³•ä¿è¯Leaderè¿ç»­å˜æ›´åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå› æ­¤ï¼Œç¤¾åŒºå¼•å…¥äº†Leader Epochæœºåˆ¶ï¼Œæ¥ä¿®å¤é«˜æ°´ä½å€¼çš„å¼Šç«¯ã€‚å…³äºâ€œLeader Epochæœºåˆ¶â€ï¼Œå›½å†…çš„èµ„æ–™ä¸æ˜¯å¾ˆå¤šï¼Œå®ƒçš„æ™®åŠåº¦è¿œä¸å¦‚é«˜æ°´ä½ï¼Œä¸å¦¨å¤§èƒ†åœ°æŠŠè¿™ä¸ªæ¦‚å¿µç§€å‡ºæ¥ï¼ŒåŠ›æ±‚æƒŠè‰³ä¸€æŠŠã€‚ä¸Šä¸€å­£ä¸“æ çš„[ç¬¬27èŠ‚è¯¾]è®²çš„å°±æ˜¯Leader Epochæœºåˆ¶çš„åŸç†ï¼Œæ¨èä½ èµ¶ç´§å»å­¦ä¹ ä¸‹ã€‚ é—®ï¼šLEOã€LSOã€ARã€ISRã€HW éƒ½è¡¨ç¤ºä»€ä¹ˆå«ä¹‰ï¼Ÿ LEOï¼šLog End Offsetã€‚æ—¥å¿—æœ«ç«¯ä½ç§»å€¼æˆ–æœ«ç«¯åç§»é‡ï¼Œè¡¨ç¤ºæ—¥å¿—ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ—¥å¿—æœ‰10æ¡æ¶ˆæ¯ï¼Œä½ç§»å€¼ä»0å¼€å§‹ï¼Œé‚£ä¹ˆï¼Œç¬¬10æ¡æ¶ˆæ¯çš„ä½ç§»å€¼å°±æ˜¯9ã€‚æ­¤æ—¶ï¼ŒLEO = 10ï¼› LSOï¼šLog Stable Offsetã€‚è¿™æ˜¯Kafkaäº‹åŠ¡çš„æ¦‚å¿µã€‚å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨åˆ°äº‹åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¸å­˜åœ¨ï¼ˆå…¶å®ä¹Ÿä¸æ˜¯ä¸å­˜åœ¨ï¼Œåªæ˜¯è®¾ç½®æˆä¸€ä¸ªæ— æ„ä¹‰çš„å€¼ï¼‰ã€‚è¯¥å€¼æ§åˆ¶äº†äº‹åŠ¡å‹æ¶ˆè´¹è€…èƒ½å¤Ÿçœ‹åˆ°çš„æ¶ˆæ¯èŒƒå›´ã€‚å®ƒç»å¸¸ä¸Log Start Offsetï¼Œå³æ—¥å¿—èµ·å§‹ä½ç§»å€¼ç›¸æ··æ·†ï¼Œå› ä¸ºæœ‰äº›äººå°†åè€…ç¼©å†™æˆLSOï¼Œè¿™æ˜¯ä¸å¯¹çš„ã€‚åœ¨Kafkaä¸­ï¼ŒLSOå°±æ˜¯æŒ‡ä»£Log Stable Offsetï¼› HWï¼šé«˜æ°´ä½å€¼ï¼ˆHigh watermarkï¼‰ã€‚è¿™æ˜¯æ§åˆ¶æ¶ˆè´¹è€…å¯è¯»å–æ¶ˆæ¯èŒƒå›´çš„é‡è¦å­—æ®µã€‚ä¸€ä¸ªæ™®é€šæ¶ˆè´¹è€…åªèƒ½â€œçœ‹åˆ°â€Leaderå‰¯æœ¬ä¸Šä»‹äºLog Start Offsetå’ŒHWï¼ˆä¸å«ï¼‰ä¹‹é—´çš„æ‰€æœ‰æ¶ˆæ¯ã€‚æ°´ä½ä»¥ä¸Šçš„æ¶ˆæ¯æ˜¯å¯¹æ¶ˆè´¹è€…ä¸å¯è§çš„ï¼› ARï¼šAssigned Replicasã€‚ARæ˜¯ä¸»é¢˜è¢«åˆ›å»ºåï¼Œæ‰€æœ‰å‰¯æœ¬ç»Ÿç§°ä¸ºassigned replicasï¼Œå³ ARï¼› ISRï¼šIn-Sync Replicasã€‚æŒ‡ä»£çš„æ˜¯ARä¸­é‚£äº›ä¸Leaderä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆã€‚åœ¨ARä¸­çš„å‰¯æœ¬å¯èƒ½ä¸åœ¨ISRä¸­ï¼Œä½†Leaderå‰¯æœ¬å¤©ç„¶å°±åŒ…å«åœ¨ISRä¸­ã€‚å…³äºISRï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ç›®æ˜¯å¦‚ä½•åˆ¤æ–­å‰¯æœ¬æ˜¯å¦åº”è¯¥å±äºISRã€‚ç›®å‰çš„åˆ¤æ–­ä¾æ®æ˜¯ï¼šFollower LEOè½åLeader LEOçš„æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡äº†Brokerç«¯å‚æ•°replica.lag.time.max.mså€¼ã€‚å¦‚æœè¶…è¿‡äº†ï¼Œå‰¯æœ¬å°±ä¼šè¢«ä»ISRä¸­ç§»é™¤ã€‚ é—®ï¼šLeader Partition çš„é€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ/åœ¨å“ªäº›åœºæ™¯ä¸‹éœ€è¦æ‰§è¡Œ Leader é€‰ä¸¾ï¼Ÿ Partition çš„ Leader é€‰ä¸¾ç”± Controller è´Ÿè´£ã€‚å½“å‰ï¼ŒKafkaæœ‰ 4 ç§ Leader Partition é€‰ä¸¾ç­–ç•¥ï¼š OfflinePartition Leaderé€‰ä¸¾ï¼šæ¯å½“æœ‰åˆ†åŒºä¸Šçº¿æ—¶ï¼Œå°±éœ€è¦æ‰§è¡Œ Leader é€‰ä¸¾ã€‚æ‰€è°“çš„åˆ†åŒºä¸Šçº¿ï¼Œå¯èƒ½æ˜¯åˆ›å»ºäº†æ–°åˆ†åŒºï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰çš„ä¸‹çº¿åˆ†åŒºé‡æ–°ä¸Šçº¿ã€‚è¿™æ˜¯æœ€å¸¸è§çš„åˆ†åŒº Leader é€‰ä¸¾åœºæ™¯ã€‚ ReassignPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-reassign-partitionså‘½ä»¤ï¼Œæˆ–è€…æ˜¯è°ƒç”¨Adminçš„alterPartitionReassignmentsæ–¹æ³•æ‰§è¡Œåˆ†åŒºå‰¯æœ¬é‡åˆ†é…æ—¶ï¼Œå¯èƒ½è§¦å‘æ­¤ç±»é€‰ä¸¾ã€‚å‡è®¾åŸæ¥çš„ARæ˜¯[1ï¼Œ2ï¼Œ3]ï¼ŒLeaderæ˜¯1ï¼Œå½“æ‰§è¡Œå‰¯æœ¬é‡åˆ†é…åï¼Œå‰¯æœ¬é›†åˆARè¢«è®¾ç½®æˆ[4ï¼Œ5ï¼Œ6]ï¼Œæ˜¾ç„¶ï¼ŒLeaderå¿…é¡»è¦å˜æ›´ï¼Œæ­¤æ—¶ä¼šå‘ç”ŸReassign Partition Leaderé€‰ä¸¾ã€‚ PreferredReplicaPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-preferred-replica-electionå‘½ä»¤ï¼Œæˆ–è‡ªåŠ¨è§¦å‘äº†Preferred Leaderé€‰ä¸¾æ—¶ï¼Œè¯¥ç±»ç­–ç•¥è¢«æ¿€æ´»ã€‚æ‰€è°“çš„Preferred Leaderï¼ŒæŒ‡çš„æ˜¯ARä¸­çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬ã€‚æ¯”å¦‚ARæ˜¯[3ï¼Œ2ï¼Œ1]ï¼Œé‚£ä¹ˆï¼ŒPreferred Leaderå°±æ˜¯3ã€‚ ControlledShutdownPartition Leaderé€‰ä¸¾ï¼šå½“Brokeræ­£å¸¸å…³é—­æ—¶ï¼Œè¯¥Brokerä¸Šçš„æ‰€æœ‰Leaderå‰¯æœ¬éƒ½ä¼šä¸‹çº¿ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸ºå—å½±å“çš„åˆ†åŒºæ‰§è¡Œç›¸åº”çš„Leaderé€‰ä¸¾ã€‚ è¿™ 4 ç±»é€‰ä¸¾ç­–ç•¥çš„å¤§è‡´æ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼Œå³ä» AR ä¸­æŒ‘é€‰é¦–ä¸ªåœ¨ ISR ä¸­çš„å‰¯æœ¬ï¼Œä½œä¸ºæ–° Leaderã€‚ é—®ï¼šKafka çš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´(Zero Copy)ï¼Ÿâ­ Zero Copyæ˜¯ç‰¹åˆ«å®¹æ˜“è¢«é—®åˆ°çš„é«˜é˜¶é¢˜ç›®ã€‚Kafkaçš„æ•°æ®æ˜¯æŒä¹…","date":"2023-04-22","objectID":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ¶ˆæ¯é˜Ÿåˆ—","uri":"/08-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"categories":["é¢è¯•"],"content":"[toc] ","date":"2023-04-21","objectID":"/07-redis/:0:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"å¸¸è§é¢è¯•é¢˜ è®°å½•ä¸€ä¸‹å¸¸è§çš„é¢è¯•é¢˜ï¼Œç”¨äºè‡ªæµ‹~~ ğŸš©ï¼šä»£è¡¨è¢«é—®è¿‡ Redis æ•°æ®ç±»å‹å’Œç»“æ„ï¼ˆå¿…é—®â­â­ï¼‰ Rediså¸¸è§çš„æ•°æ®ç±»å‹ï¼Œä½¿ç”¨åœºæ™¯ï¼ŸG å„æ•°æ®ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼ŸG å„æ•°æ®ç»“æ„çš„åº•å±‚å®ç°ï¼Œåšäº†å“ªäº›ä¼˜åŒ–ï¼ŸğŸš©G Zsetåº•å±‚ç”¨çš„è·³è¡¨ï¼Œä¸ºå•¥è·³è¡¨è¿™ä¹ˆå¿«ï¼ŸG ä¸ºä»€ä¹ˆç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼ŸG Redis æ¶æ„ï¼ˆå¿…é—®â­â­â­ï¼‰ Redis ä¸ºå•¥è¿™ä¹ˆå¿«ï¼ŸğŸš©ğŸš©G Redis æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿå“ªéƒ¨åˆ†æ˜¯å•çº¿ç¨‹ï¼Ÿå“ªéƒ¨åˆ†æ˜¯å¤šçº¿ç¨‹ï¼ŸG Redis çš„çº¿ç¨‹æ¨¡å‹ï¼ŸG Redis ä¸ºå•¥é€‰æ‹©å•çº¿ç¨‹å‘¢ï¼ŸG Redis é›†ç¾¤ï¼ˆå¿…é—®â­â­â­ï¼‰ Redis æ˜¯æ€ä¹ˆå®ç°é«˜å¯ç”¨çš„ï¼ŸG å¤šä¸ªèŠ‚ç‚¹é—´çš„ä¸€è‡´æ€§æ˜¯å’‹å®ç°çš„ï¼Ÿä¸»ä»å¤åˆ¶æ˜¯æ€ä¹ˆå®ç°çš„ï¼ŸğŸš©G ä¸»èŠ‚ç‚¹å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªä»èŠ‚ç‚¹æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡æ¥åŒæ­¥æ•°æ®ï¼ŸG å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼ŸG å“¨å…µæ¨¡å¼æ˜¯æ€ä¹ˆå®ç°çš„ï¼ŸğŸš©G åˆ†ç‰‡é›†ç¾¤æ˜¯æ€ä¹ˆå®ç°çš„ï¼ŸG Redis æŒä¹…åŒ–ï¼ˆâ­â­ï¼‰ Redis å¦‚ä½•å®ç°æ•°æ®æŒä¹…åŒ–å­˜å‚¨ï¼ŸğŸš©G æŒä¹…åŒ–æœºåˆ¶ã€æŒä¹…åŒ–æ–¹å¼æ˜¯ä»€ä¹ˆï¼Œå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼ŸG æ··åˆæŒä¹…åŒ–æ˜¯ä»€ä¹ˆï¼ŸG AOF æ—¥å¿—é‡å†™æœºåˆ¶ï¼ŸG åå°é‡å†™ï¼ŸG å†™æ—¶å¤åˆ¶æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å•¥ç”¨ï¼ŸG RDB åˆ›å»ºå¿«ç…§æ—¶ä¼šé˜»å¡ä¸»è¿›ç¨‹å—ï¼Ÿè‹¥ä¸ä¼šé˜»å¡ï¼Œé‚£æ•°æ®èƒ½è¢«ä¿®æ”¹å—ï¼ŸG BigKey æœ‰å•¥å½±å“ï¼ŸG Redis ç¼“å­˜ï¼ˆâ­â­ï¼‰ ç¼“å­˜ç©¿é€åŠè§£å†³æ–¹æ¡ˆï¼ŸG å¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼ŸG ç¼“å­˜å‡»ç©¿åŠè§£å†³æ–¹æ¡ˆï¼ŸG ç¼“å­˜é›ªå´©åŠè§£å†³æ–¹æ¡ˆï¼ŸG å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼ŸğŸš©G Redis å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼ŸG Redis æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªé”®å€¼å¯¹æ˜¯å¦è¿‡æœŸï¼ŸG å¯¹äºè¿‡æœŸ Key çš„ç­–ç•¥ï¼ŸG LRU å’Œ LFU æœ‰å•¥åŒºåˆ«ï¼ŸRedis æ˜¯å’‹å®ç°çš„ï¼ŸG ","date":"2023-04-21","objectID":"/07-redis/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€Redis æ¦‚å¿µ é—®ï¼šä»€ä¹ˆæ˜¯ Redisï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ/ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ Redis æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå¯¹æ•°æ®çš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆï¼Œå› æ­¤è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå¸¸ç”¨äºç¼“å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é”ç­‰åœºæ™¯ã€‚ **é«˜æ€§èƒ½ï¼š**è‹¥ä»æ•°æ®åº“è¯»å–æ•°æ®ï¼Œå°±æ˜¯ä»ç£ç›˜è¯»å–ï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼›è€Œä»ç¼“å­˜ä¸­è¯»å–æ•°æ®æ˜¯ä»å†…å­˜è¯»å–çš„ã€‚è‹¥æŠŠéœ€è¦é¢‘ç¹è¯»å–çš„æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œé‚£ä¹ˆæ•ˆç‡å°±ä¼šå¤§å¤§æé«˜ï¼› **é«˜å¹¶å‘ï¼š**ç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„æ•°æ®åº“è¯·æ±‚æ•°é‡æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥ä¼šæé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘ã€‚ é—®ï¼šRedis ä¸ºå•¥å¿«ï¼Ÿ Redis åŸºäºå†…å­˜ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦æ˜¯ç£ç›˜çš„ä¸Šåƒå€ï¼› Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹ï¼Œä¸»è¦æ˜¯å•çº¿ç¨‹äº‹ä»¶å¾ªç¯å’Œ IO å¤šè·¯å¤ç”¨ï¼› Redis å†…ç½®äº†å¤šç§ä¼˜åŒ–è¿‡åçš„æ•°æ®ç»“æ„å®ç°ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚ é—®ï¼šRedis å’Œ Memcached çš„åŒºåˆ«ï¼Ÿ å…±åŒç‚¹ï¼š éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“åšç¼“å­˜ä½¿ç”¨ã€‚ éƒ½æœ‰è¿‡æœŸç­–ç•¥ã€‚ ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚ åŒºåˆ«ï¼š Redis æ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼‰ã€‚Redis ä¸ä»…ä»…æ”¯æŒç®€å•çš„ k/v ç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾› listï¼Œsetï¼Œzsetï¼Œhash ç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚Memcached åªæ”¯æŒæœ€ç®€å•çš„ k/v æ•°æ®ç±»å‹ã€‚ Redis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨,è€Œ Memcached æŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ã€‚ **Redis æœ‰ç¾éš¾æ¢å¤æœºåˆ¶ã€‚**å› ä¸ºå¯ä»¥æŠŠç¼“å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚ Redis åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå¯ä»¥å°†ä¸ç”¨çš„æ•°æ®æ”¾åˆ°ç£ç›˜ä¸Šã€‚ä½†æ˜¯ï¼ŒMemcached åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå°±ä¼šç›´æ¥æŠ¥å¼‚å¸¸ã€‚ Memcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›ä½†æ˜¯ Redis ç›®å‰æ˜¯åŸç”Ÿæ”¯æŒ cluster æ¨¡å¼çš„ã€‚ Redis ä½¿ç”¨å•çº¿ç¨‹çš„å¤šè·¯ IO å¤ç”¨æ¨¡å‹ï¼›Memcached æ˜¯å¤šçº¿ç¨‹ï¼Œéé˜»å¡ IO å¤ç”¨çš„ç½‘ç»œæ¨¡å‹ã€‚ Redis æ”¯æŒå‘å¸ƒ-è®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒã€‚å¹¶ä¸”ï¼ŒRedis æ”¯æŒæ›´å¤šçš„ç¼–ç¨‹è¯­è¨€ã€‚ Redis åŒæ—¶ä½¿ç”¨äº†æƒ°æ€§åˆ é™¤ä¸å®šæœŸåˆ é™¤ï¼›Memcached è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥åªç”¨äº†æƒ°æ€§åˆ é™¤ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"äºŒã€Redis æ•°æ®ç»“æ„ æ•°æ®ç±»å‹ é—®ï¼šRedis å¸¸ç”¨çš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿä½¿ç”¨åœºæ™¯ï¼Ÿ 5 ç§åŸºç¡€æ•°æ®ç±»å‹ï¼šString(å­—ç¬¦ä¸²)ã€List(åˆ—è¡¨ï¼Œç±»ä¼¼åŒå‘é“¾è¡¨)ã€Set(é›†åˆ)ã€Hash(æ•£åˆ—)ã€Zset(æœ‰åºé›†åˆ)ã€‚ 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹ï¼šHyperLogLogs(åŸºæ•°ç»Ÿè®¡)ã€Bitmap(ä½å­˜å‚¨)ã€Geospatial(åœ°ç†ä½ç½®)ã€‚ String ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼šç¼“å­˜sessionã€tokenã€å¸¸è§„è®¡æ•°ã€åˆ†å¸ƒå¼é”ã€å…±äº« session ä¿¡æ¯ç­‰ã€‚ List ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š1. ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®ç°å…¨å±€å”¯ä¸€ IDï¼›2. ä¸èƒ½ä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®ï¼‰ç­‰ã€‚ Hash ç±»å‹ï¼šç¼“å­˜å¯¹è±¡ã€è´­ç‰©è½¦ç­‰ã€‚ Set ç±»å‹ï¼šèšåˆè®¡ç®—åœºæ™¯ï¼Œæ¯”å¦‚ç‚¹èµã€å…±åŒå…³æ³¨(äº¤é›†)ã€æŠ½å¥–æ´»åŠ¨(å»é‡)ç­‰ã€‚ Zset ç±»å‹ï¼šæ’åºåœºæ™¯ï¼Œæ¯”å¦‚æ’è¡Œæ¦œã€ç”µè¯å’Œå§“åæ’åºç­‰ã€‚ é—®ï¼šString è¿˜æ˜¯ Hash å­˜å‚¨å¯¹è±¡æ•°æ®æ›´å¥½ï¼Ÿ ä¾æ®ä½¿ç”¨åœºæ™¯ï¼š String å­˜å‚¨çš„æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡æ•°æ®ï¼Œå­˜æ”¾çš„æ˜¯æ•´ä¸ªå¯¹è±¡ã€‚Hash æ˜¯å¯¹å¯¹è±¡çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ï¼Œå¯ä»¥è·å–éƒ¨åˆ†å­—æ®µçš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…æ·»åŠ éƒ¨åˆ†å­—æ®µï¼ŒèŠ‚çœç½‘ç»œæµé‡ã€‚å¦‚æœå¯¹è±¡ä¸­æŸäº›å­—æ®µéœ€è¦ç»å¸¸å˜åŠ¨æˆ–è€…ç»å¸¸éœ€è¦å•ç‹¬æŸ¥è¯¢å¯¹è±¡ä¸­çš„ä¸ªåˆ«å­—æ®µä¿¡æ¯ï¼ŒHash å°±éå¸¸é€‚åˆã€‚æ¯”å¦‚è´­ç‰©è½¦ã€‚ String å­˜å‚¨ç›¸å¯¹æ¥è¯´æ›´åŠ èŠ‚çœå†…å­˜ï¼Œç¼“å­˜ç›¸åŒæ•°é‡çš„å¯¹è±¡æ•°æ®ï¼ŒString æ¶ˆè€—çš„å†…å­˜çº¦æ˜¯ Hash çš„ä¸€åŠã€‚å¹¶ä¸”ï¼Œå­˜å‚¨å…·æœ‰å¤šå±‚åµŒå¥—çš„å¯¹è±¡æ—¶ä¹Ÿæ–¹ä¾¿å¾ˆå¤šã€‚å¦‚æœç³»ç»Ÿå¯¹æ€§èƒ½å’Œèµ„æºæ¶ˆè€—éå¸¸æ•æ„Ÿçš„è¯ï¼ŒString å°±éå¸¸é€‚åˆã€‚ é—®ï¼šå¸¸è§çš„æ•°æ®ç±»å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ Redis åŸºæœ¬æ•°æ®ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„å®ç°å¦‚ä¸‹ï¼š String List Hash Set Zset SDS LinkedList/ZipList/QuickList Hash Tableã€ZipList ZipListã€Intset ZipListã€SkipList æ•°æ®ç»“æ„ SDSâ­ é—®ï¼šSDS çš„åº•å±‚å®ç°ï¼Ÿâ­ Redisæ²¡æœ‰ç›´æ¥ç”¨Cä¸­çš„char*å®ç°å­—ç¬¦ä¸²ï¼Œä¸»è¦æ˜¯å› ä¸ºchar*æœ‰å¦‚ä¸‹ç¼ºé™·ï¼š è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼› å­—ç¬¦ä¸²çš„ç»“å°¾æ˜¯ä»¥ \\0 å­—ç¬¦æ ‡è¯†ï¼Œå­—ç¬¦ä¸²é‡Œé¢ä¸èƒ½åŒ…å«æœ‰ \\0 å­—ç¬¦ï¼Œå› æ­¤ä¸èƒ½ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼› å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ä¸é«˜æ•ˆä¸”ä¸å®‰å…¨ï¼Œæ¯”å¦‚æœ‰ç¼“å†²åŒºæº¢å‡ºçš„é£é™©ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç¨‹åºè¿è¡Œç»ˆæ­¢ï¼› è€ŒRedisä¸­ï¼ŒString ç±»å‹çš„åº•å±‚çš„æ•°æ®ç»“æ„å®ç°ä¸»è¦æ˜¯ SDSï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰(ç±»ä¼¼Goçš„)ï¼š SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œå› ä¸º SDS ä½¿ç”¨ len å±æ€§çš„å€¼ è€Œä¸æ˜¯\\0å­—ç¬¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼› SDS ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼› å½“åˆ¤æ–­å‡ºç¼“å†²åŒºå¤§å°ä¸å¤Ÿç”¨æ—¶ï¼ŒSDS æ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œé¿å…ç¼“å†²åŒºæº¢å‡ºã€‚æ‰©å®¹è§„åˆ™ï¼š å¦‚æœæ–°çš„ sds é•¿åº¦(newlen) å°äº 1 MBï¼Œé‚£ä¹ˆæœ€åçš„æ‰©å®¹æ˜¯æŒ‰ç…§ç¿»å€æ‰©å®¹æ¥æ‰§è¡Œçš„ï¼Œå³ 2 * newlen + 1ï¼›(+1 æ˜¯å› ä¸ºç»“æŸæ ‡è¯†ç¬¦\\0) å¦‚æœæ–°çš„ sds é•¿åº¦(newlen) è¶…è¿‡ 1 MBï¼Œé‚£ä¹ˆæœ€åçš„æ‰©å®¹é•¿åº¦åº”è¯¥æ˜¯ newlen + 1MB + 1ã€‚ åˆ†é…å¤šä½™çš„ç©ºé—´ï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ã€‚ è¿™æ˜¯SDSçš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸æ˜¯è´¼åƒGoçš„ï¼š lenï¼Œè®°å½•äº†å­—ç¬¦ä¸²é•¿åº¦ã€‚è¿™æ ·è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶å€™ï¼Œåªéœ€è¦è¿”å›è¿™ä¸ªæˆå‘˜å˜é‡å€¼å°±è¡Œï¼Œæ—¶é—´å¤æ‚åº¦åªéœ€è¦ O(1)ã€‚ allocï¼Œåˆ†é…ç»™å­—ç¬¦æ•°ç»„çš„ç©ºé—´é•¿åº¦ã€‚è¿™æ ·åœ¨ä¿®æ”¹å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ alloc - len è®¡ç®—å‡ºå‰©ä½™çš„ç©ºé—´å¤§å°ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹éœ€æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨å°† SDS çš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œä¿®æ”¹æ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰æ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨ SDS æ—¢ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ SDS çš„ç©ºé—´å¤§å°ï¼Œä¹Ÿä¸ä¼šå‡ºç°å‰é¢æ‰€è¯´çš„ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚ flagsï¼Œç”¨æ¥è¡¨ç¤ºä¸åŒç±»å‹çš„ SDSã€‚ä¸€å…±è®¾è®¡äº† 5 ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ sdshdr5ã€sdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64ï¼Œä»£è¡¨äº†SDSçš„æœ€å¤§é•¿åº¦ï¼Œæ¯”å¦‚2^8^-1ã€2^16^-1ã€‚ buf[]ï¼Œå­—ç¬¦æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜å®é™…æ•°æ®ã€‚ä¸ä»…å¯ä»¥ä¿å­˜å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ã€‚ String ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼šç¼“å­˜sessionã€tokenã€å¸¸è§„è®¡æ•°ã€åˆ†å¸ƒå¼é”ã€å…±äº« session ä¿¡æ¯ç­‰ã€‚ intset é—®ï¼šæ•´æ•°é›†åˆ(intset) çš„åº•å±‚å®ç°ï¼Ÿ æ•´æ•°é›†åˆæœ¬è´¨ä¸Šæ˜¯ä¸€å—è¿ç»­å†…å­˜ç©ºé—´ï¼š typedef struct intset { //ç¼–ç æ–¹å¼ï¼šint16_tã€int32_tã€int64_t uint32_t encoding; //é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ uint32_t length; //ä¿å­˜å…ƒç´ çš„æ•°ç»„ int8_t contents[]; } intset; å…¶ä¸­ï¼Œcontents[] çš„çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§çš„å€¼ã€‚ æ’å…¥å…ƒç´ ä¼šæŒ‰åºæ’åˆ—ï¼Œä¸”å ç”¨ç©ºé—´ç›¸åŒï¼Œæ–¹ä¾¿ç”¨ä¸‹æ ‡å¯»å€ã€‚ ==å‡çº§æœºåˆ¶ï¼š== ä¸»è¦é’ˆå¯¹ï¼šæ’å…¥æ–°å…ƒç´ æ—¶ï¼Œè‹¥æ–°å…ƒç´ çš„ç±»å‹ï¼ˆint32_tï¼‰æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹ï¼ˆint16_tï¼‰éƒ½è¦é•¿æ—¶ï¼Œæ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§ã€‚ä¹Ÿå°±æ˜¯æŒ‰æ–°å…ƒç´ çš„ç±»å‹ï¼ˆint32_tï¼‰æ‰©å±• contents æ•°ç»„çš„ç©ºé—´å¤§å°ï¼Œç„¶åæ‰èƒ½å°†æ–°å…ƒç´ åŠ å…¥åˆ°æ•´æ•°é›†åˆé‡Œã€‚ ä¾‹ï¼Œå‘set[1, 2, 3]æ’å…¥65535ï¼š å¥½å¤„å°±æ˜¯èŠ‚çœå†…å­˜ã€‚ åªæœ‰å‡çº§æ“ä½œï¼Œæ²¡æœ‰é™çº§æ“ä½œã€‚ å“ˆå¸Œè¡¨â­ é—®ï¼šå“ˆå¸Œè¡¨(dict) çš„åº•å±‚å®ç°ï¼Ÿ å“ˆå¸Œè¡¨çš„å®ç°æ–¹å¼ä¹‹ä¸€å°±æ˜¯ dict (å…ƒç´ æ•°é‡ \u003e 500æ—¶)ã€‚å¯ä»¥ä»¥ O(1) çš„å¤æ‚åº¦å¿«é€ŸæŸ¥è¯¢æ•°æ®ã€‚ typedef struct dictht { //å“ˆå¸Œè¡¨æ•°ç»„ï¼Œæ¡¶æ•°ç»„ dictEntry **table; //å“ˆå¸Œè¡¨å¤§å° unsigned long size; //å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ unsigned long sizemask; //è¯¥å“ˆå¸Œè¡¨å·²æœ‰çš„èŠ‚ç‚¹æ•°é‡ unsigned long used; } dictht; å“ˆå¸Œè¡¨æ¯”è¾ƒç†Ÿæ‚‰(å› ä¸ºè·ŸGoçš„å¥½åƒhhh)ï¼Œè¿™é‡Œåªè®°å‡ ä¸ªå…³é”®è¯ï¼š ä¸è¿ç®—ï¼› æ‹‰é“¾æ³•ï¼› æ¸è¿›å¼æ‰©å®¹ï¼› è´Ÿè½½å› å­ï¼š å½“è´Ÿè½½å› å­ \u003e= 1 ï¼Œå¹¶ä¸”Redisæ²¡æœ‰æ‰§è¡Œ RDB å¿«ç…§æˆ–æ²¡æœ‰è¿›è¡Œ AOF é‡å†™çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œ rehash æ“ä½œï¼› å½“è´Ÿè½½å› å­ \u003e 5 æ—¶ï¼Œæ­¤æ—¶è¯´æ˜å“ˆå¸Œå†²çªéå¸¸ä¸¥é‡äº†ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æœ‰åœ¨æ‰§è¡Œ RDB å¿«ç…§æˆ– AOF é‡å†™ï¼Œéƒ½ä¼šå¼ºåˆ¶è¿›è¡Œ rehash æ“ä½œã€‚ å½“è´Ÿè½½å› å­ \u003c 0.1 æ—¶ï¼Œä¼šåšå“ˆå¸Œè¡¨æ”¶ç¼©ã€‚ å°†é¦–ä¸ª 2^n^ \u003e æ–°çš„æ‰€éœ€å®¹é‡ï¼Œä½œä¸ºæ‰©å®¹/æ”¶ç¼©åçš„å®¹é‡ã€‚ list é—®ï¼šlist çš„åº•å±‚å®ç°ï¼Ÿ listçš„åº•å±‚å®ç°æ–¹å¼ä¹‹ä¸€å°±æ˜¯ç”¨Listã€‚ å…¶å®å°±æ˜¯ä¸ªåŒå‘é“¾è¡¨ã€‚ // é“¾è¡¨ typedef struct list { //é“¾è¡¨å¤´èŠ‚ç‚¹ listNode *head; //é“¾è¡¨å°¾èŠ‚ç‚¹ listNode *tail; //èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•° void *(*dup)(void *ptr); //èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•° void (*free)(void *ptr); //èŠ‚ç‚¹å€¼æ¯”è¾ƒå‡½æ•° int (*match)(void *ptr, void *key); //é“¾è¡¨èŠ‚ç‚¹æ•°é‡ unsigned long len; } list; // é“¾è¡¨èŠ‚ç‚¹ typedef struct listNode { //å‰ç½®èŠ‚ç‚¹ struct listNode *prev; //åç½®èŠ‚ç‚¹ struct listNode *next; //èŠ‚ç‚¹çš„å€¼ void *value; } listNode; ä¸€ä¸ª3èŠ‚ç‚¹é“¾è¡¨çš„ç¤ºæ„å›¾ï¼š ä¼˜ç‚¹ï¼š è·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦åªéœ€O(1)ï¼› è·å–é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æ•°é‡çš„æ—¶é—´å¤æ‚åº¦åªéœ€O(1)ï¼› è·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹æˆ–åç½®èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦åªéœ€O(1)ã€‚ ç¼ºç‚¹ï¼š ä¿å­˜ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹çš„å€¼éƒ½éœ€è¦ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ç»“æ„å¤´çš„åˆ†é…ï¼Œå†…å­˜å¼€é”€è¾ƒå¤§ã€‚ ziplistâ­ é—®ï¼šå‹ç¼©åˆ—è¡¨(ziplist) çš„åº•å±‚å®ç°ï¼Ÿ Redis å¯¹è±¡(List å¯¹è±¡ã€Hash å¯¹è±¡ã€Zset å¯¹è±¡)åŒ…å«çš„å…ƒç´ æ•°é‡è¾ƒå°‘ï¼Œæˆ–è€…å…ƒç´ å€¼ä¸å¤§çš„æƒ…å†µæ‰ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ã€‚ å‹ç¼©åˆ—è¡¨æ˜¯ç”±è¿ç»­å†…å­˜ç»„æˆçš„é¡ºåºå‹æ•°æ®ç»“æ„ï¼Œç±»ä¼¼æ•°ç»„ã€‚ å‹ç¼©åˆ—è¡¨è¡¨å¤´ï¼š zlbytesï¼Œè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨å­—èŠ‚æ•°ï¼› zltailï¼Œè®°å½•å‹ç¼©åˆ—è¡¨ã€Œå°¾éƒ¨ã€èŠ‚ç‚¹è·ç¦»èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯åˆ—è¡¨å°¾çš„åç§»é‡ï¼› zllenï¼Œè®°å½•å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼› zlendï¼Œæ ‡è®°å‹ç¼©åˆ—è¡¨çš„ç»“æŸç‚¹ï¼Œå›ºå®šå€¼ 0xFFï¼ˆåè¿›åˆ¶255ï¼‰ã€‚ ==èŠ‚ç‚¹ entry==ï¼š ==prevlen==ï¼Œè®°å½•äº†ã€Œå‰ä¸€ä¸ªèŠ‚ç‚¹ã€çš„é•¿åº¦ï¼Œç›®çš„æ˜¯ä¸ºäº†å®ç°ä»åå‘å‰éå†ã€‚(å½“æ–°æ’å…¥çš„å…ƒç´ è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åç»­å…ƒç´ çš„ prevlen å ç”¨ç©ºé—´éƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´è¿ç»­æ›´æ–°)ï¼› encodingï¼Œè®°å½•äº†å½“å‰èŠ‚ç‚¹å®é™…æ•°æ®çš„ã€Œç±»å‹å’Œé•¿åº¦ã€ï¼Œç±»å‹ä¸»è¦æœ‰ä¸¤ç§ï¼šå­—ç¬¦ä¸²å’Œæ•´æ•°ã€‚ dataï¼Œè®°å½•äº†å½“å‰èŠ‚ç‚¹çš„å®é™…æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦éƒ½ç”± encoding å†³å®šï¼› ä¼˜ç‚¹ï¼š å‹ç¼©åˆ—è¡¨æ’å…¥æ•°æ®æ—¶ï¼Œä¼šæ ¹æ®æ•°æ®å¤§å°å’Œç±»å‹è¿›è¡Œä¸åŒçš„ç©ºé—´å¤§å°åˆ†é…ï¼ŒèŠ‚çœå†…å­˜ï¼› ç¼ºç‚¹ï¼š ä¸èƒ½ä¿å­˜è¿‡å¤šçš„å…ƒç´ ï¼Œå¦åˆ™æŸ¥è¯¢æ•ˆç‡å°±ä¼šé™ä½ï¼› æ–°å¢æˆ–ä¿®æ”¹æŸä¸ªå…ƒç´ æ—¶ï¼Œå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜ç©ºé—´éœ€è¦é‡æ–°åˆ†é…ï¼Œç”šè‡³å¯èƒ½å¼•å‘**==è¿é”æ›´æ–°==**çš„é—®é¢˜ã€‚ å› æ­¤ï¼Œå‹ç¼©åˆ—è¡¨åªä¼šç”¨äºä¿å­˜çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šçš„åœºæ™¯ã€‚ ==è¿é”æ›´æ–°ï¼š== é—®é¢˜æ ¹æºæ˜¯ï¼Œæ–°æ’å…¥å…ƒç´ æ—¶ï¼Œåä¸€å…ƒç´ çš„prevlenå ç”¨ç©ºé—´å¯èƒ½ä¼šå˜å¤§ï¼Œå¯¼è‡´è‡ªèº«å ç”¨ç©ºé—´å˜å¤§ï¼Œç„¶åå¯èƒ½å¯¼è‡´åç»­å…ƒç´ çš„ prevlen å ç”¨ç©ºé—´éƒ½å‘ç”Ÿå˜åŒ–ï¼Œå‘ç”Ÿè¿é”æ›´æ–°ã€‚ quicklist é—®ï¼šquicklist çš„åº•å±‚å®ç°ï¼Ÿ List çš„åº•å±‚å¯¹è±¡å°±æ˜¯ quicklistã€‚ å…¶å® quick","date":"2023-04-21","objectID":"/07-redis/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€Redis çº¿ç¨‹æ¨¡å‹ é—®ï¼šRedis åˆ°åº•æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ æ ¸å¿ƒä¸šåŠ¡éƒ¨åˆ†ç”±å•ä¸ªçº¿ç¨‹(ä¸»çº¿ç¨‹)æ¥å®Œæˆï¼šã€Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚-\u003eè§£æè¯·æ±‚ -\u003eè¿›è¡Œæ•°æ®è¯»å†™ç­‰æ“ä½œ-\u003eå‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ã€ ä½†æ•´ä¸ª Redis æ˜¯å¤šçº¿ç¨‹çš„æ˜¯ä¼šå¯åŠ¨åå°çº¿ç¨‹(BIO)çš„ï¼š å…³é—­æ–‡ä»¶ï¼› AOF åˆ·ç›˜ï¼› é‡Šæ”¾å†…å­˜ã€‚ ä¸€å…±ä¸‰ä¸ªåå°çº¿ç¨‹ï¼Œç”¨äºå¤„ç†è¿™äº›æ¯”è¾ƒè€—æ—¶çš„ä»»åŠ¡ã€‚ åå°çº¿ç¨‹ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æŠŠè€—æ—¶ä»»åŠ¡ä¸¢åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…ï¼ˆBIOï¼‰ä¸åœè½®è¯¢è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ‹¿å‡ºä»»åŠ¡å°±å»æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å³å¯ã€‚ é—®ï¼šRedis çš„å•çº¿ç¨‹æ¨¡å‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿâ­ é¦–å…ˆåˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªserver socketå¹¶å¼€å§‹ç›‘å¬å®ƒçš„ FDï¼Œåˆå§‹åŒ–å®Œåï¼Œä¸»çº¿ç¨‹å°±è¿›å…¥åˆ°ä¸€ä¸ªç›‘å¬äº‹ä»¶å¾ªç¯å‡½æ•°ï¼Œä¸»è¦ä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š é¦–å…ˆï¼Œå…ˆè°ƒç”¨å¤„ç†å‘é€é˜Ÿåˆ—å‡½æ•°ï¼Œæ£€æŸ¥å‘é€é˜Ÿåˆ—é‡Œæ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰å‘é€ä»»åŠ¡ï¼Œå°±ä¼šæ³¨å†Œå†™äº‹ä»¶(åˆ°è¿™é‡Œå°±å½¢æˆé—­ç¯äº†ï¼šè¿æ¥-\u003eè¯»-\u003eå†™-\u003eè¿”å›)ï¼Œç­‰å¾… epoll_wait å¤„ç†ã€‚ æ¥ç€ï¼Œæ‰ä¼šè°ƒç”¨ epoll_wait å‡½æ•°ç­‰å¾…äº‹ä»¶å°±ç»ªï¼š å¦‚æœæ˜¯è¿æ¥äº‹ä»¶åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨è¿æ¥äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ accpet è·å–å·²è¿æ¥çš„ socket -\u003e è°ƒç”¨ epoll_ctl å°†å·²è¿æ¥çš„ socket åŠ å…¥åˆ° epoll -\u003e æ³¨å†Œ**ã€Œè¯»äº‹ä»¶ã€**å¤„ç†å‡½æ•°ï¼› å¦‚æœæ˜¯è¯»äº‹ä»¶å°±ç»ªï¼Œåˆ™ä¼šè°ƒç”¨è¯»äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ read è·å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å¹¶å†™åˆ°å®¢æˆ·ç«¯å¯¹è±¡çš„æ¥æ”¶ç¼“å†²åŒº -\u003e è§£æå‘½ä»¤ -\u003e å¤„ç†å‘½ä»¤ -\u003e å°†æ‰§è¡Œç»“æœå†™åˆ°å®¢æˆ·ç«¯å¯¹è±¡çš„å‘é€ç¼“å­˜åŒºç­‰å¾…å‘é€ -\u003e å°†å®¢æˆ·ç«¯å¯¹è±¡æ·»åŠ åˆ°å‘é€é˜Ÿåˆ—ï¼› å¦‚æœæ˜¯å†™äº‹ä»¶å°±ç»ªï¼Œåˆ™ä¼šè°ƒç”¨å†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šé€šè¿‡ write å‡½æ•°å°†å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºé‡Œçš„æ•°æ®å‘é€å‡ºå»ï¼Œå¦‚æœè¿™ä¸€è½®æ•°æ®æ²¡æœ‰å‘é€å®Œï¼Œå°±ä¼šç»§ç»­æ³¨å†Œå†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç­‰å¾… epoll_wait å‘ç°å¯å†™åå†å¤„ç†ã€‚ å¤šçº¿ç¨‹çš„éƒ¨åˆ†ä¸»è¦æ˜¯åœ¨ ç½‘ç»œI/O éƒ¨åˆ†ï¼š è¯»äº‹ä»¶åˆ°æ¥ï¼Œè¦è¯»å–è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¼€å¯å¤šçº¿ç¨‹ï¼› å†™äº‹ä»¶ï¼Œè¦æŠŠæ•°æ®å†™åˆ°ç½‘ç»œï¼Œåœ¨è¿™é‡Œå¯ä»¥å¼€å¯å¤šçº¿ç¨‹ã€‚ å…¶ä½™æ‰§è¡Œæ“ä½œæ—¶ï¼Œå‡ä¸ºå•çº¿ç¨‹ã€‚ å¯ä»¥çœ‹åˆ° socketå¯¹è±¡çš„å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºï¼š å½“ socket çŠ¶æ€å¤„äº Establishedæ—¶ï¼š Recv-Q è¡¨ç¤º socket ç¼“å†²åŒºä¸­è¿˜æ²¡æœ‰è¢«åº”ç”¨ç¨‹åºè¯»å–çš„å­—èŠ‚æ•°ï¼› Send-Q è¡¨ç¤º socket ç¼“å†²åŒºä¸­è¿˜æ²¡æœ‰è¢«è¿œç«¯ä¸»æœºç¡®è®¤çš„å­—èŠ‚æ•°ï¼› è€Œå½“ socket çŠ¶æ€å¤„äº Listen æ—¶ï¼š Recv-Q è¡¨ç¤ºå…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼› Send-Q è¡¨ç¤ºå…¨è¿æ¥é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼› é»‘é©¬Redisçš„è§†é¢‘ï¼šP171 åŸç†ç¯‡-27 é—®ï¼šä¸ºå•¥ Redis çš„å•çº¿ç¨‹è¿˜è¿™ä¹ˆå¿«ï¼Ÿ å¤§éƒ¨åˆ†æ“ä½œåœ¨å†…å­˜ä¸­å®Œæˆï¼Œå¹¶ä¸”é‡‡ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼› å•çº¿ç¨‹å¯ä»¥é¿å…å¤šçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼› é‡‡ç”¨äº†I/Oå¤šè·¯å¤ç”¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚ æ³¨ï¼šI/O å¤šè·¯å¤ç”¨æœºåˆ¶æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ª IO æµï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ select/epoll æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼Œåœ¨ Redis åªè¿è¡Œå•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œè¯¥æœºåˆ¶å…è®¸å†…æ ¸ä¸­ï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªç›‘å¬ Socket å’Œå·²è¿æ¥ Socketã€‚å†…æ ¸ä¼šä¸€ç›´ç›‘å¬è¿™äº› Socket ä¸Šçš„è¿æ¥è¯·æ±‚æˆ–æ•°æ®è¯·æ±‚ã€‚ä¸€æ—¦æœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°±ä¼šäº¤ç»™ Redis çº¿ç¨‹å¤„ç†ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ª Redis çº¿ç¨‹å¤„ç†å¤šä¸ª IO æµçš„æ•ˆæœã€‚ é—®ï¼šRedis 6.0 ä¹‹å‰ä¸ºå•¥å•çº¿ç¨‹ï¼Œ6.0 ä¹‹åä¸ºå•¥å¤šçº¿ç¨‹ï¼Ÿâ­ ==ä¸ºå•¥è¦é€‰æ‹©å•çº¿ç¨‹ï¼Ÿ== Redis æ˜¯åœ¨å†…å­˜æ“ä½œ(æœ€ä¸»è¦åŸå› â­)ï¼Œæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå®ƒçš„æ€§èƒ½ç“¶é¢ˆæ˜¯ ç½‘ç»œI/Oï¼Œè€Œä¸æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œå› æ­¤å¤šçº¿ç¨‹å¹¶ä¸ä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æå‡ï¼› å¼•å…¥å¤šçº¿ç¨‹çš„è¯ï¼Œä¼šé¢ä¸´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ï¼ŒåŒæ—¶å¯èƒ½å¼•å‘çº¿ç¨‹åˆ‡æ¢ã€åŠ é”è§£é”ç­‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚ ==ä¸ºå•¥åˆé€‰æ‹©å¤šçº¿ç¨‹ï¼Ÿ== 6.0 ä¹‹åé‡‡ç”¨å¤šä¸ª I/O çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™æ˜¯å› ä¸ºéšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼ŒRedis çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ I/O çš„å¤„ç†ä¸Šã€‚æ‰€ä»¥ä¸ºäº†æé«˜ç½‘ç»œ I/O çš„å¹¶è¡Œåº¦ï¼ŒRedis 6.0 **==ä»…å¯¹äºç½‘ç»œ I/O é‡‡ç”¨å¤šçº¿ç¨‹==**æ¥å¤„ç†ã€‚ä½†æ˜¯å¯¹äºå‘½ä»¤çš„æ‰§è¡Œï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:4:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"å››ã€Redis æŒä¹…åŒ– é—®ï¼šRedis å¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ ä¸ºäº†ä¿è¯å†…å­˜ä¸­çš„æ•°æ®ä¸ä¸¢å¤±ï¼ŒRedis å®ç°äº†æ•°æ®æŒä¹…åŒ–çš„æœºåˆ¶ï¼Œä¼šæŠŠæ•°æ®å­˜å‚¨åˆ°ç£ç›˜ã€‚ å…±æœ‰ä¸‰ç§æ•°æ®æŒä¹…åŒ–çš„æ–¹å¼ï¼š AOF æ—¥å¿—ï¼šæ¯æ‰§è¡Œä¸€æ¡å†™æ“ä½œå‘½ä»¤ï¼Œå°±æŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼› RDB å¿«ç…§ï¼šå°†æŸä¸€æ—¶åˆ»çš„å†…å­˜æ•°æ®ï¼Œä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å†™å…¥ç£ç›˜ï¼› æ··åˆæŒä¹…åŒ–æ–¹å¼ï¼šRedis 4.0 æ–°å¢çš„æ–¹å¼ï¼Œé›†æˆäº† AOF å’Œ RBD çš„ä¼˜ç‚¹ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯ AOF æ—¥å¿—ï¼Ÿ Redis åœ¨æ‰§è¡Œå®Œä¸€æ¡å†™æ“ä½œå‘½ä»¤åï¼Œä¼šæŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç„¶å Redis é‡å¯æ—¶ï¼Œä¼šè¯»å–è¯¥æ–‡ä»¶è®°å½•çš„å‘½ä»¤ï¼Œç„¶åé€ä¸€æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®æ¢å¤ã€‚ é—®ï¼šAOF ä¸­ï¼Œä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå†™æ“ä½œå‘½ä»¤ï¼Œå†å†™å…¥æ—¥å¿—ï¼Ÿ **é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼š**å…ˆæ‰§è¡Œå¯ä»¥æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ­£ç¡®ï¼Œè¦æ˜¯å…ˆå†™å…¥æ—¥å¿—åˆå‘ç°å‘½ä»¤æœ‰é”™è¯¯ï¼Œå°±ä¸å¥½åŠäº†ã€‚ ä¸ä¼šé˜»å¡å½“å‰å†™æ“ä½œã€‚ ä¹Ÿä¼šå¸¦æ¥é£é™©ï¼š **æ•°æ®ä¸¢å¤±ï¼š**åˆšæ‰§è¡Œå®Œï¼Œè¿˜æ²¡æ¥å¾—åŠå†™å…¥æ—¥å¿—ï¼ŒRedis å°±å¯„äº†ã€‚ **å¯èƒ½é˜»å¡åä¸€ä¸ªæŒ‡ä»¤ï¼š**AOF æ“ä½œä¹Ÿæ˜¯ç”±ä¸»çº¿ç¨‹å®Œæˆï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šé˜»å¡ä¸‹ä¸€ä¸ªæ“ä½œæ— æ³•æ‰§è¡Œã€‚ é—®ï¼šAOF å†™å›ç­–ç•¥æœ‰å“ªå‡ ç§ï¼Ÿ ç”±ä¸»è¿›ç¨‹æ‰§è¡Œå†™å…¥ï¼Œå†™å…¥ AOF æ—¥å¿—çš„è¿‡ç¨‹ï¼š 3 ç§å†™å›ç­–ç•¥çš„ä¼˜ç¼ºç‚¹ï¼š é—®ï¼šAOF æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶ï¼Ÿ AOF æ—¥å¿—æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéšç€æ‰§è¡Œçš„å†™æ“ä½œå‘½ä»¤è¶Šæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„å¤§å°ä¼šè¶Šæ¥è¶Šå¤§ã€‚ å¦‚æœå½“ AOF æ—¥å¿—æ–‡ä»¶è¿‡å¤§å°±ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚é‡å¯ Redis åï¼Œéœ€è¦è¯» AOF æ–‡ä»¶çš„å†…å®¹ä»¥æ¢å¤æ•°æ®ï¼Œå¦‚æœæ–‡ä»¶è¿‡å¤§ï¼Œæ•´ä¸ªæ¢å¤çš„è¿‡ç¨‹å°±ä¼šå¾ˆæ…¢ã€‚ æ‰€ä»¥ï¼ŒRedis ä¸ºäº†é¿å… AOF æ–‡ä»¶è¶Šå†™è¶Šå¤§ï¼Œæä¾›äº† ==AOF é‡å†™æœºåˆ¶==ã€‚å½“ AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼åï¼ŒRedis å°±ä¼šå¯ç”¨ AOF é‡å†™æœºåˆ¶ï¼Œæ¥å‹ç¼© AOF æ–‡ä»¶ã€‚ é—®ï¼šAOF é‡å†™æœºåˆ¶çš„è¿‡ç¨‹ï¼Ÿ å½“ AOF å˜å¾—å¤ªå¤§æ—¶ï¼ŒRedis èƒ½å¤Ÿåœ¨åå°è‡ªåŠ¨é‡å†™ AOF äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶(ç›¸å½“äºå‹ç¼©ç‰ˆ AOF)ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°ã€‚ åœ¨ AOF é‡å†™æœŸé—´ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œé‡å†™æ“ä½œï¼› å­è¿›ç¨‹ä¼šå°†ç”Ÿæˆçš„æ–° AOF æ–‡ä»¶ä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶ä¸»è¿›ç¨‹ä¼šç»§ç»­å°†æ–°çš„å†™å‘½ä»¤è¿½åŠ åˆ°æ—§çš„ AOF æ–‡ä»¶å’Œä¸€ä¸ªé‡å†™ç¼“å†²åŒºä¸­(æ­¤å¤„ä¸ºä»€ä¹ˆè¿˜è¦è¿½åŠ åˆ°æ—§çš„ AOFï¼Ÿæ˜¯å› ä¸ºæ€•å®•æœºå¯¼è‡´ä¸¢å¤±æ•°æ®ï¼Œå¦‚æœä¸è¿½åŠ åˆ°æ—§çš„ AOFï¼Œå¯èƒ½ä¼šå‘ç”Ÿå®•æœºå¯¼è‡´é‡å†™ç¼“å†²åŒºæ²¡äº†ï¼Œç„¶åè¿™éƒ¨åˆ†å†™æ“ä½œä¹Ÿæ²¡åŠ åˆ°æ—§çš„ AOFï¼Œå°±é€ æˆä¸¢å¤±äº†ã€‚)ï¼› å½“å­è¿›ç¨‹å®Œæˆé‡å†™æ“ä½œåï¼Œå®ƒä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œä¸»è¿›ç¨‹ä¼šå°†é‡å†™ç¼“å†²åŒºçš„å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶ä¸­ï¼Œç„¶åç”¨æ–° AOF æ–‡ä»¶æ›¿æ¢æ—§ AOF æ–‡ä»¶ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»è¿›ç¨‹ä¸»è¦å®Œæˆä¸‰ä¸ªå·¥ä½œï¼š æ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤ï¼› å°†æ‰§è¡Œåçš„å†™å‘½ä»¤è¿½åŠ åˆ°ã€ŒAOF ç¼“å†²åŒºã€ï¼› å°†æ‰§è¡Œåçš„å†™å‘½ä»¤è¿½åŠ åˆ°ã€ŒAOF é‡å†™ç¼“å†²åŒºã€ã€‚ æ³¨æ„ï¼š é‡å†™æ“ä½œï¼šæ‰«ææ•°æ®åº“ä¸­æ‰€æœ‰æ•°æ®ï¼Œé€ä¸€æŠŠå†…å­˜æ•°æ®çš„é”®å€¼å¯¹è½¬æ¢æˆä¸€æ¡å‘½ä»¤ï¼Œå†å°†å‘½ä»¤è®°å½•åˆ°é‡å†™æ—¥å¿—ã€‚ **ä¸ºå•¥èƒ½å‡å°‘å‘½ä»¤æ•°ç›®å‘¢ï¼Ÿ**å°±æ¯”å¦‚ï¼š é—®ï¼šAOF åå°é‡å†™ï¼Ÿ æ™®é€šçš„å†™å…¥ AOF æ—¥å¿—çš„æ“ä½œæ˜¯åœ¨ä¸»è¿›ç¨‹å®Œæˆçš„ï¼Œå› ä¸ºå®ƒå†™å…¥çš„å†…å®¹ä¸å¤šï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å¤ªå½±å“å‘½ä»¤çš„æ“ä½œã€‚ä½† AOF é‡å†™æ—¶ï¼Œä¸€èˆ¬ AOF æ–‡ä»¶éƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥ä¸åº”è¯¥æ”¾åˆ°ä¸»è¿›ç¨‹é‡Œå®Œæˆã€‚ Redis çš„é‡å†™ AOF è¿‡ç¨‹æ˜¯ç”±åå°å­è¿›ç¨‹ bgrewriteaof æ¥å®Œæˆçš„ï¼Œä¼˜ç‚¹ï¼šå­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œä»è€Œé¿å…é˜»å¡ä¸»è¿›ç¨‹ã€‚ æ€è€ƒï¼šä¸ºä»€ä¹ˆæ˜¯å­è¿›ç¨‹è€Œä¸æ˜¯å­çº¿ç¨‹ï¼Ÿ å› ä¸ºå¦‚æœæ˜¯ä½¿ç”¨çº¿ç¨‹ï¼Œå¤šçº¿ç¨‹ä¹‹é—´ä¼šå…±äº«å†…å­˜ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹å…±äº«å†…å­˜æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡åŠ é”æ¥ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œè€Œè¿™æ ·å°±ä¼šé™ä½æ€§èƒ½ã€‚è€Œä½¿ç”¨å­è¿›ç¨‹ï¼Œåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œçˆ¶å­è¿›ç¨‹æ˜¯å…±äº«å†…å­˜æ•°æ®çš„ï¼Œä¸è¿‡è¿™ä¸ªå…±äº«çš„å†…å­˜åªèƒ½ä»¥åªè¯»çš„æ–¹å¼ï¼Œè€Œå½“çˆ¶å­è¿›ç¨‹ä»»æ„ä¸€æ–¹ä¿®æ”¹äº†è¯¥å…±äº«å†…å­˜ï¼Œå°±ä¼šå‘ç”Ÿ**ã€Œå†™æ—¶å¤åˆ¶ã€**ï¼Œäºæ˜¯çˆ¶å­è¿›ç¨‹å°±æœ‰äº†ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ï¼Œå°±ä¸ç”¨åŠ é”æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚ é—®ï¼šå†™æ—¶å¤åˆ¶æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ åœ¨å­è¿›ç¨‹æ‰§è¡Œ AOF é‡å†™ æˆ– æ‰§è¡Œ RDB çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»è¿›ç¨‹åˆä¿®æ”¹äº†æ•°æ®ï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™æ€ä¹ˆåŠï¼Ÿ å®é™…ä¸Šï¼Œå½“ä¸»è¿›ç¨‹ä¿®æ”¹äº†æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ï¼Œå­è¿›ç¨‹å°±ä¼šæ‹¥æœ‰åŸå§‹æœªæ›´æ”¹çš„æ•°æ®å‰¯æœ¬äº†ã€‚ ä¸»è¿›ç¨‹åœ¨é€šè¿‡ fork ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆ bgrewriteaof å­è¿›ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠä¸»è¿›ç¨‹çš„ã€Œé¡µè¡¨ã€å¤åˆ¶ä¸€ä»½ç»™å­è¿›ç¨‹ï¼Œè¿™ä¸ªé¡µè¡¨è®°å½•ç€è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„å…³ç³»ï¼Œè€Œä¸ä¼šå¤åˆ¶ç‰©ç†å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤è€…çš„è™šæ‹Ÿç©ºé—´ä¸åŒï¼Œä½†å…¶å¯¹åº”çš„ç‰©ç†ç©ºé—´æ˜¯åŒä¸€ä¸ªã€‚è¿™æ ·å¯ä»¥å…±äº«ç‰©ç†å†…å­˜èµ„æºï¼ŒèŠ‚çœå†…å­˜ã€‚åŒæ—¶ï¼Œé¡µè¡¨å¯¹åº”çš„é¡µè¡¨é¡¹çš„å±æ€§ä¼šæ ‡è®°è¯¥ç‰©ç†å†…å­˜çš„æƒé™ä¸ºåªè¯»ã€‚ å½“çˆ¶è¿›ç¨‹æˆ–è€…å­è¿›ç¨‹åœ¨ä¿®æ”¹å…±äº«å†…å­˜ä¸­çš„æŸæ¡æ•°æ®æ—¶ï¼ŒCPU å°±ä¼šè§¦å‘å†™ä¿æŠ¤ä¸­æ–­ï¼Œæ‰§è¡Œå†™æ—¶å¤åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å‘ç”Ÿå†™æ“ä½œæ—¶ï¼Œæ“ä½œç³»ç»Ÿæ‰å»å¤åˆ¶ç‰©ç†å†…å­˜ã€‚è¿™ä¸ªè¿‡ç¨‹è¿˜ä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚ä¹‹åï¼Œä¸»è¿›ç¨‹å°±å¯ä»¥å¯¹æ•°æ®å‰¯æœ¬è¿›è¡Œæ“ä½œï¼Œå­è¿›ç¨‹å°±å¯ä»¥å¯¹åŸæ•°æ®è¿›è¡Œ AOF é‡å†™ã€‚ ç»¼ä¸Šï¼Œå…±æœ‰ä¸¤å¤„é˜»å¡ä¸»è¿›ç¨‹çš„åœ°æ–¹ï¼š åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œéœ€è¦å¤åˆ¶é¡µè¡¨ç­‰ï¼Œä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼› å‘ç”Ÿå†™æ—¶å¤åˆ¶æ—¶ï¼Œéœ€è¦å¤åˆ¶æ•°æ®å‰¯æœ¬ï¼Œä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯ RDB å¿«ç…§ï¼Ÿ RDB æ˜¯ Redis é»˜è®¤é‡‡ç”¨çš„æŒä¹…åŒ–æ–¹å¼ï¼Œå®ƒä¼šå°†æŸä¸€æ—¶åˆ»çš„å†…å­˜æ•°æ®ä»¥æ–‡ä»¶çš„å½¢å¼ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œè®°å½•çš„æ˜¯å®é™…çš„æ•°æ®ã€‚ ä½œç”¨ï¼š å¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼ˆRedis ä¸»ä»ç»“æ„ï¼Œä¸»è¦ç”¨æ¥æé«˜ Redis æ€§èƒ½ï¼‰; è¿˜å¯ä»¥å°†å¿«ç…§ç•™åœ¨åŸåœ°ä»¥ä¾¿é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨ã€‚ Redis çš„å¿«ç…§æ˜¯å…¨é‡å¿«ç…§ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡æ‰§è¡Œå¿«ç…§ï¼Œéƒ½æ˜¯æŠŠå†…å­˜ä¸­çš„ã€Œæ‰€æœ‰æ•°æ®ã€éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œã€‚ é—®ï¼šRDB åˆ›å»ºå¿«ç…§æ—¶ä¼šé˜»å¡ä¸»è¿›ç¨‹å—ï¼Ÿè‹¥ä¸ä¼šé˜»å¡ï¼Œé‚£æ•°æ®èƒ½è¢«ä¿®æ”¹å—ï¼Ÿ æä¾›ä¸¤ç§æ–¹å¼ï¼š save : ä¸»è¿›ç¨‹æ‰§è¡Œï¼Œä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼› bgsave : å­è¿›ç¨‹æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼Œé»˜è®¤é€‰é¡¹ è‹¥é€šè¿‡bgsaveçš„æ–¹å¼ï¼Œæ‰§è¡Œ bgsave è¿‡ç¨‹ä¸­ï¼ŒRedis ä¾ç„¶å¯ä»¥ç»§ç»­å¤„ç†æ“ä½œå‘½ä»¤çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ˜¯èƒ½è¢«ä¿®æ”¹çš„ã€‚ ä¸»è¦æ˜¯é€šè¿‡ å†™æ—¶å¤åˆ¶ æ¥å®ç°çš„ã€‚è¯¦ç»†è§ AOF ã€‚ é—®ï¼šå¦‚ä½•é€‰æ‹© RDB è¿˜æ˜¯ AOFï¼Ÿ RDB æ›´å¥½çš„åœ°æ–¹ï¼š RDB æ–‡ä»¶å­˜å‚¨çš„å†…å®¹æ˜¯ç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œ ä¿å­˜ç€æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®é›†ï¼Œæ–‡ä»¶å¾ˆå°ï¼Œé€‚åˆåšæ•°æ®çš„å¤‡ä»½ï¼Œç¾éš¾æ¢å¤ã€‚AOF æ–‡ä»¶å­˜å‚¨çš„æ˜¯æ¯ä¸€æ¬¡å†™å‘½ä»¤ï¼Œç±»ä¼¼äº MySQL çš„ binlog æ—¥å¿—ï¼Œé€šå¸¸ä¼šæ¯” RDB æ–‡ä»¶å¤§å¾ˆå¤šã€‚ ä½¿ç”¨ RDB æ–‡ä»¶æ¢å¤æ•°æ®ï¼Œç›´æ¥è§£æè¿˜åŸæ•°æ®å³å¯ï¼Œä¸éœ€è¦ä¸€æ¡ä¸€æ¡åœ°æ‰§è¡Œå‘½ä»¤ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚è€Œ AOF åˆ™éœ€è¦ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå†™å‘½ä»¤ï¼Œé€Ÿåº¦éå¸¸æ…¢ã€‚ AOF æ›´å¥½çš„åœ°æ–¹ï¼š AOF å¯ä»¥è¿‘å®æ—¶çš„æŒä¹…åŒ–æ•°æ®ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼› AOF è®°å½•äº†æ‰€æœ‰çš„å‘½ä»¤æ“ä½œï¼Œå¯ä»¥ç”¨äºå®¡è®¡å’Œæ•…éšœæ’æŸ¥ï¼Œå®‰å…¨æ€§æ›´å¥½ã€‚ ç»¼åˆæ¥è¯´ï¼š å¦‚æœéœ€è¦é«˜æ€§èƒ½å’Œå¿«é€Ÿæ¢å¤ï¼Œå¹¶ä¸”å¯ä»¥å®¹å¿ä¸€å®šç¨‹åº¦çš„æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥é€‰æ‹© RDBï¼› å¦‚æœéœ€è¦é«˜å¯é æ€§å’Œå®Œæ•´æ€§ï¼Œå¹¶ä¸”å¯ä»¥å®¹å¿ä¸€å®šç¨‹åº¦çš„æ€§èƒ½æŸè€—å’Œæ¢å¤å»¶è¿Ÿï¼Œå¯ä»¥é€‰æ‹© AOFï¼› å¦‚æœéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤è€…çš„éœ€æ±‚ï¼Œå¹¶ä¸”æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å’Œå†…å­˜èµ„æºï¼Œå¯ä»¥é€‰æ‹©æ··åˆæŒä¹…åŒ–ï¼ˆRDB + AOFï¼‰ã€‚ é—®ï¼šAOF ä¼šä¸¢å¤±æ•°æ®å—ï¼Ÿ å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œå†™å…¥æ—¥å¿—çš„æ—¶å€™å®•æœºäº†ï¼Œå‘½ä»¤æ²¡æœ‰å†™å…¥åˆ°æ—¥å¿—ä¸­ï¼Œè¿™æ—¶å€™å°±æœ‰ä¸¢å¤±æ•°æ®çš„é£é™©äº†ã€‚ å¦‚æœ AOF æ–‡ä»¶æŸåäº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æ¢å¤å¤±è´¥æˆ–è€…éƒ¨åˆ†ä¸¢å¤±ã€‚ é—®ï¼šä¸ºå•¥è¦æ··åˆæŒä¹…åŒ–ï¼Ÿ RDB ä¼˜ç‚¹æ˜¯æ•°æ®æ¢å¤é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¿«ç…§çš„é¢‘ç‡ä¸å¥½æŠŠæ¡ã€‚é¢‘ç‡å¤ªä½ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¼šæ¯”è¾ƒå¤šï¼Œé¢‘ç‡å¤ªé«˜ï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚ AOF ä¼˜ç‚¹æ˜¯ä¸¢å¤±æ•°æ®å°‘ï¼Œä½†æ˜¯æ•°æ®æ¢å¤ä¸å¿«ã€‚ Redis 4.0 æå‡ºäº†æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œ RDB å†…å­˜å¿«ç…§ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ã€‚æ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚ ==ä»€ä¹ˆæ˜¯æ··åˆæŒä¹…åŒ–ï¼š== æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ AOF æ—¥å¿—é‡å†™è¿‡ç¨‹ï¼Œé‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹ç”¨æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ã€‚ æ··åˆæŒä¹…åŒ–çš„åŸç†æ˜¯ï¼Œåœ¨ AOF é‡å†™çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠ RDB æ ¼å¼çš„å…¨é‡æ•°æ®å†™åˆ° AOF æ–‡ä»¶çš„å¼€å¤´ï¼Œç„¶åå†è¿½åŠ  AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚è¿™æ ·ï¼Œå½“ Redis å¯åŠ¨æ—¶ï¼Œåªéœ€è¦åŠ è½½ä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥æ¢å¤æ‰€æœ‰æ•°æ®ï¼Œè€Œä¸éœ€è¦å…ˆåŠ è½½ RDB æ–‡ä»¶å†åŠ è½½ AOF æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚ ==æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š== å¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼› åŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚ ==æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š== AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼› å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:5:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"äº”ã€Redis äº‹åŠ¡ é—®ï¼šå¦‚ä½•ä½¿ç”¨äº‹åŠ¡ï¼Ÿ Redis å¯ä»¥é€šè¿‡ MULTIï¼ŒEXECï¼ŒDISCARD å’Œ WATCH ç­‰å‘½ä»¤æ¥å®ç°äº‹åŠ¡(transaction)åŠŸèƒ½ã€‚ MULTI å‘½ä»¤åå¯ä»¥è¾“å…¥å¤šä¸ªå‘½ä»¤ï¼ŒRedis ä¸ä¼šç«‹å³æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾åˆ°é˜Ÿåˆ—ï¼Œå½“è°ƒç”¨äº† EXEC å‘½ä»¤åï¼Œå†æ‰§è¡Œæ‰€æœ‰çš„å‘½ä»¤ã€‚ é€šè¿‡ DISCARD å‘½ä»¤å–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ã€‚ é€šè¿‡ WATCH å‘½ä»¤ç›‘å¬æŒ‡å®šçš„ Keyï¼Œå½“è°ƒç”¨ EXEC å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œå¦‚æœä¸€ä¸ªè¢« WATCH å‘½ä»¤ç›‘è§†çš„ Key è¢« å…¶ä»–å®¢æˆ·ç«¯/Session ä¿®æ”¹çš„è¯ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚ é—®ï¼šRedis æ”¯æŒåŸå­æ€§å—ï¼Ÿ Redis äº‹åŠ¡åœ¨è¿è¡Œé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œé™¤äº†æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„å‘½ä»¤å¤–ï¼Œå…¶ä»–å‘½ä»¤éƒ½èƒ½æ­£å¸¸æ‰§è¡Œã€‚å¹¶ä¸”ï¼ŒRedis æ˜¯ä¸æ”¯æŒå›æ»šï¼ˆroll backï¼‰æ“ä½œçš„ã€‚å› æ­¤ï¼ŒRedis äº‹åŠ¡å…¶å®æ˜¯ä¸æ»¡è¶³åŸå­æ€§çš„ï¼ˆè€Œä¸”ä¸æ»¡è¶³æŒä¹…æ€§ï¼‰ã€‚ **åŸå› ï¼š**Redis å¼€å‘è€…ä»¬è§‰å¾—æ²¡å¿…è¦æ”¯æŒå›æ»šï¼Œå‘½ä»¤æ‰§è¡Œé”™è¯¯åº”è¯¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å°±è¢«å‘ç°è€Œä¸æ˜¯ç”Ÿäº§è¿‡ç¨‹ä¸­ã€‚ å¯ä»¥å°† Redis ä¸­çš„äº‹åŠ¡å°±ç†è§£ä¸ºï¼šRedis äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…çš„åŠŸèƒ½ã€‚ç„¶åï¼Œå†æŒ‰é¡ºåºæ‰§è¡Œæ‰“åŒ…çš„æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ä¸­é€”æ‰“æ–­ã€‚ å®é™…ä¸­ï¼Œä¸å»ºè®®ä½¿ç”¨ Redis çš„äº‹åŠ¡ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:6:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"å…­ã€Redis æ€§èƒ½ä¼˜åŒ– ","date":"2023-04-21","objectID":"/07-redis/:7:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"6.1 é”®å€¼è®¾è®¡ Key çš„æœ€ä½³å®è·µï¼š å›ºå®šæ ¼å¼ï¼š[ä¸šåŠ¡å]:[æ•°æ®å]:[id] è¶³å¤Ÿç®€çŸ­ï¼Œä¸è¶…è¿‡44å­—èŠ‚ï¼› ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚ Valueçš„æœ€ä½³å®è·µï¼š åˆç†æ‹†åˆ†æ•°æ®ï¼Œæ‹’ç»bigkeyï¼› é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ï¼› Hash ç»“æ„çš„ entry æ•°é‡ä¸è¶…è¿‡ 1000ï¼› è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:7:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"6.2 bigkey 6.2.1 bigkey å‘ç°ä¸åˆ é™¤ é—®ï¼šä»€ä¹ˆæ˜¯ bigkeyï¼Ÿ ç®€å•æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ª key å¯¹åº”çš„ value æ‰€å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ bigkeyã€‚ ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š String ç±»å‹çš„å€¼å¤§äº 10 KBï¼› Hashã€Listã€Setã€ZSet ç±»å‹çš„å…ƒç´ çš„ä¸ªæ•°è¶…è¿‡ 5000 ä¸ªï¼› é—®ï¼šbigkey ä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ã€‚ç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶(æ…¢æŸ¥è¯¢)ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ï¼› å¼•å‘ç½‘ç»œé˜»å¡ã€‚æ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼› æŒä¹…åŒ–æ—¶ï¼Œè‹¥å¯¹ bigkey è¿›è¡Œä¿®æ”¹ï¼Œä¼šè§¦å‘å†™æ—¶å¤åˆ¶ï¼Œç”±äºæ˜¯ bigkeyï¼Œå¯èƒ½ä¼šé˜»å¡ä¸»è¿›ç¨‹è¾ƒé•¿çš„æ—¶é—´ï¼› å†…å­˜åˆ†å¸ƒä¸å‡ã€‚æœ‰å¤§ key çš„ Redis èŠ‚ç‚¹å ç”¨å†…å­˜å¤šï¼Œå‡ºç°æ•°æ®å’ŒæŸ¥è¯¢å€¾æ–œæƒ…å†µã€‚ é—®ï¼šå¦‚ä½•å‘ç° bigkeyï¼Ÿ redis-cli --bigkeys ä½¿ç”¨ Redis è‡ªå¸¦çš„ --bigkeys å‚æ•°æ¥æŸ¥æ‰¾ï¼Œå¯ä»¥éå†åˆ†ææ‰€æœ‰çš„ keyï¼Œå¹¶è¿”å› key çš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ä¸æ¯ä¸ªæ•°æ®çš„ Top1 çš„ bigkeyã€‚ åˆ†æ RDB æ–‡ä»¶ ç½‘ä¸Šæœ‰ç°æˆçš„ä»£ç /å·¥å…·RDB-Toolsï¼Œå¯ä»¥è¿›è¡Œç¦»çº¿çš„åˆ†æ RDB æ–‡ä»¶ã€‚ ç½‘ç»œç›‘æ§ è‡ªå®šä¹‰å·¥å…·ï¼Œç›‘æ§è¿›å‡º Redis çš„ç½‘ç»œæ•°æ®ï¼Œè¶…å‡ºé¢„è­¦å€¼æ—¶ä¸»åŠ¨å‘Šè­¦ã€‚ é—®ï¼šå¦‚ä½•åˆ é™¤ bigkeyï¼Ÿ bigkey å†…å­˜å ç”¨è¾ƒå¤šï¼Œå¯¼è‡´å³ä½¿æ˜¯åˆ é™¤ bigkeyï¼Œä¹Ÿè´¼æ…¢ã€‚ã€‚ unlink -keynameã€‚redis 4.0 åæä¾›çš„å¼‚æ­¥åˆ é™¤æ–¹å¼ã€‚ è‹¥æ˜¯é›†åˆç±»å‹ï¼Œå¯ä»¥éå†bigkeyçš„å…ƒç´ ï¼Œå…ˆé€ä¸ªåˆ é™¤å­å…ƒç´ ï¼Œå†åˆ é™¤è¯¥ bigkeyã€‚ 6.2.2 bigkey é¿å… é—®ï¼šå‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ æ–¹æ¡ˆä¸€ æ–¹æ¡ˆäºŒ æ¯ä¸ª key å­˜å‚¨çš„æ—¶å€™ï¼Œè¿˜ä¼šå­˜å‚¨å®ƒçš„å…ƒä¿¡æ¯ï¼Œåº”å°½é‡å‡å°‘ key çš„æ•°é‡ã€‚ æ–¹æ¡ˆä¸‰â­ ","date":"2023-04-21","objectID":"/07-redis/:7:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"6.3 æ‰¹å¤„ç†ä¼˜åŒ– 6.3.1 ä»€ä¹ˆæ˜¯æ‰¹å¤„ç† æ™®é€šæ‰§è¡Œ N æ¡å‘½ä»¤ï¼šå°† N æ¡å‘½ä»¤ä¾æ¬¡å‘é€å’Œæ‰§è¡Œã€‚ $$ N æ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ = N æ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + N æ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶ $$ å…¶ä¸­ï¼Œå‘½ä»¤è€—æ—¶ æ˜¯éå¸¸çŸ­çš„ä¹Ÿå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´éƒ½æµªè´¹åœ¨äº† ç½‘ç»œä¼ è¾“ã€‚ æ‰¹é‡æ‰§è¡Œï¼šå°† N æ¡å‘½ä»¤æ‰¹é‡å‘é€å’Œæ‰§è¡Œã€‚ $$ N æ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ = 1 æ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + N æ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶ $$ é‚£ä¹ˆå¦‚ä½•å®ç°ä¸Šè¿°çš„æ‰¹é‡æ“ä½œå‘¢ï¼Ÿ 6.3.2 æ‰¹å¤„ç†æ–¹æ¡ˆ 6.3.2.1 Mset Redis æä¾›äº†å¾ˆå¤š Mxxx è¿™æ ·çš„å‘½ä»¤ï¼Œå¯ä»¥å®ç°æ‰¹é‡æ’å…¥æ•°æ®ï¼Œä¾‹å¦‚ï¼š mset hmset ä½† mset åªèƒ½æ“ä½œ string ç±»å‹ï¼Œå› æ­¤å…·æœ‰å±€é™æ€§ã€‚ 6.3.2.2 Pipelineâ­ mset è™½ç„¶èƒ½æ‰¹å¤„ç†ï¼Œä½†æ˜¯å´åªèƒ½æ“ä½œéƒ¨åˆ†æ•°æ®ç±»å‹ï¼Œå› æ­¤å¦‚æœæœ‰å¯¹å¤æ‚æ•°æ®ç±»å‹çš„æ‰¹å¤„ç†éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨ Pipelineã€‚ æ³¨æ„äº‹é¡¹ï¼š æ‰¹å¤„ç†æ—¶è¦é¿å…ä¸€æ¬¡æ€§å‘é€è¿‡å¤šå‘½ä»¤ï¼Œå¯¼è‡´ç®¡é“å†…çš„å‘½ä»¤å¤ªå¤šï¼Œè¿›è€Œå‘ç”Ÿç½‘ç»œé˜»å¡ï¼› Pipeline çš„å¤šä¸ªå‘½ä»¤ä¹‹é—´ä¸å…·å¤‡åŸå­æ€§ï¼Œè€Œ mset å…·å¤‡åŸå­æ€§ã€‚å³ Pipeline å¤šä¸ªå‘½ä»¤é—´å¯èƒ½æœ‰åˆ«çš„å‘½ä»¤æ’é˜Ÿã€‚ 6.3.2.3 å¹¶è¡Œslot é›†ç¾¤ä¸­ï¼Œæ‰¹å¤„ç†æ“ä½œé€šå¸¸ä¸ä¼šæˆåŠŸï¼Œå› ä¸ºä¸åŒçš„ key-val åˆ†å¸ƒåœ¨ä¸åŒçš„ slot ä¸­ã€‚è¿™æ—¶ï¼Œå¯ä»¥é‡‡ç”¨å¹¶è¡Œ slot æ“ä½œ(spring å·²ç»å®ç°äº†)ã€‚ å®ç°æ€è·¯ï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†æˆä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œå¹¶è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤ã€‚ $$ N æ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ = 1 æ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + N æ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶ $$ ","date":"2023-04-21","objectID":"/07-redis/:7:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"6.4 æœåŠ¡ç«¯ä¼˜åŒ– 6.4.1 æ…¢æŸ¥è¯¢ æ…¢æŸ¥è¯¢ï¼šåœ¨ Redis æ‰§è¡Œæ—¶è€—æ—¶è¶…è¿‡æŸä¸ªé˜ˆå€¼çš„å‘½ä»¤ï¼Œç§°ä¸ºæ…¢æŸ¥è¯¢ã€‚ é€šå¸¸ï¼Œbigkey ä¼šå¯¼è‡´æ…¢æŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—å‘ç°å“ªäº›å‘½ä»¤è§¦å‘äº†æ…¢æŸ¥è¯¢ï¼Œè¿›è€Œä¼˜åŒ–ã€‚ é€šå¸¸ï¼Œæ…¢æŸ¥è¯¢çš„åŸå› ä¸»è¦æœ‰ï¼š ä½¿ç”¨å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤ bigkeyé—®é¢˜ é›†ä¸­è¿‡æœŸ 6.4.2 å†…å­˜é…ç½® å½“ Redis å†…å­˜ä¸è¶³æ—¶ï¼Œå¯èƒ½å¯¼è‡´ Key é¢‘ç¹è¢«åˆ é™¤ã€å“åº”æ—¶é—´å˜é•¿ã€QPS ä¸ç¨³å®šç­‰é—®é¢˜ã€‚å½“å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° 90% ä»¥ä¸Šæ—¶å°±éœ€è¦è­¦æƒ•ï¼Œå¹¶å¿«é€Ÿå®šä½åˆ°å†…å­˜å ç”¨çš„åŸå› ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:7:4","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"6.5 é›†ç¾¤ä¼˜åŒ– 6.5.1 å¯ç”¨æ€§ åœ¨ Redis çš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ª slot ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ã€‚ ä¸ºäº†ä¿è¯é«˜å¯ç”¨æ€§ï¼Œå¯ä»¥å°† cluster-require-full-coverage = falseã€‚è¿™æ ·ï¼Œåªæœ‰ down çš„ slot ä¸å¯ç”¨ã€‚ 6.5.2 é›†ç¾¤å¸¦å®½é—®é¢˜ é›†ç¾¤èŠ‚ç‚¹é—´ä¼šä¸æ–­çš„äº’ç›¸ ping æ¥ç¡®å®šé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹çŠ¶æ€ã€‚æ¯æ¬¡ ping æºå¸¦çš„ä¿¡æ¯è‡³å°‘åŒ…æ‹¬ï¼š slot ä¿¡æ¯ï¼› é›†ç¾¤çŠ¶æ€ä¿¡æ¯ã€‚ é›†ç¾¤ä¸­èŠ‚ç‚¹è¶Šå¤šï¼Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯é‡ä¹Ÿè¶Šå¤§ï¼Œæ­¤æ—¶æ¯æ¬¡é›†ç¾¤äº’é€šæ‰€éœ€å¸¦å®½å°±ä¼šéå¸¸é«˜ã€‚ è§£å†³é€”å¾„ï¼š é¿å…å¤§é›†ç¾¤ï¼Œé›†ç¾¤èŠ‚ç‚¹æ•°ä¸è¦å¤ªå¤šï¼Œæœ€å¥½ \u003c 1000ï¼Œå¦‚æœä¸šåŠ¡åºå¤§ï¼Œåˆ™å»ºç«‹å¤šä¸ªé›†ç¾¤ï¼› é¿å…åœ¨å•ä¸ªç‰©ç†æœºä¸Šè¿è¡Œå¤ªå¤š Redis å®ä¾‹ï¼› é…ç½®åˆé€‚çš„ cluster-node-timeout å€¼ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:7:5","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"ä¸ƒã€Redis ç¼“å­˜è®¾è®¡ 7.1 ç¼“å­˜ç©¿é€ Cache Penetration é—®ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå¤§é‡è¯·æ±‚çš„ key æ˜¯ä¸åˆç†çš„ï¼Œæ ¹æœ¬ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚å¯¼è‡´è¿™äº›è¯·æ±‚ç›´æ¥ç ¸åˆ°äº†æ•°æ®åº“ä¸Šï¼Œæ ¹æœ¬æ²¡æœ‰ç»è¿‡ç¼“å­˜è¿™ä¸€å±‚ï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚ é—®ï¼šæœ‰å“ªäº›è§£å†³æ–¹æ³•ï¼Ÿ ç¼“å­˜æ— æ•ˆ keyã€‚å°±æ˜¯æŠŠç¼“å­˜æ‰¾ä¸åˆ°çš„ã€æ•°æ®åº“ä¹ŸæŸ¥ä¸åˆ°çš„ keyï¼Œå†™å…¥åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ä½†æ— æ³•æ ¹æœ¬ä¸Šè§£å†³ï¼Œç¼“å­˜ä¸€å †æ²¡ç”¨çš„æ•°æ®ç…§æ ·èƒ½ç»™ä½ å¹²å®•æœºã€‚ å¸ƒéš†è¿‡æ»¤å™¨ã€‚å¯ä»¥å¸®åŠ©å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨äºæµ·é‡æ•°æ®ä¸­ã€‚å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼šæŠŠæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è¯·æ±‚çš„å€¼éƒ½å­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå½“ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„è¯·æ±‚çš„å€¼æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ä¸å­˜åœ¨çš„è¯ï¼Œç›´æ¥è¿”å›è¯·æ±‚å‚æ•°é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå­˜åœ¨çš„è¯æ‰ä¼šèµ°ä¹‹åçš„æµç¨‹(ç¼“å­˜ã€æ•°æ®åº“)ã€‚ é—®ï¼šå¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼Ÿç¼ºé™·åŠè§£å†³ï¼Ÿ å…ƒç´ åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨çš„è¿‡ç¨‹ï¼š ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼ï¼ˆæœ‰å‡ ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°å‡ ä¸ªå“ˆå¸Œå€¼ï¼‰ã€‚ æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨å¤šä¸ªä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º 1ã€‚ åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨çš„è¿‡ç¨‹ï¼š å¯¹ç»™å®šå…ƒç´ å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼› å¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­å¯¹åº”ä¸‹æ ‡å…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ å¸ƒéš†è¿‡æ»¤å™¨çš„ç¼ºç‚¹ï¼š è¿˜æ˜¯æœ‰å‡ ç‡ç¼“å­˜ç©¿é€ï¼Œå¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨ã€‚è§£å†³æ–¹æ³•ï¼šå¯ä»¥å¢å¤šå“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—å‡ºå¤šä¸ªå“ˆå¸Œå€¼ï¼Œåªæœ‰æ‰€æœ‰å“ˆå¸Œå€¼å¯¹åº”çš„æ•°ç»„ä¸­çš„å€¼éƒ½ä¸º 1 æ—¶ï¼Œæ‰ä¼šè®¤ä¸ºè¿™ä¸ªå…ƒç´ åœ¨é›†åˆä¸­ã€‚ ä¸æ”¯æŒåˆ é™¤å…ƒç´ ï¼Œè¿™ä¹Ÿå’Œå“ˆå¸Œå†²çªæœ‰å…³ã€‚è§£å†³æ–¹æ³•ï¼šè®©æ•°ç»„ä¸­ä¸å†åªæœ‰ 0 å’Œ 1 ä¸¤ä¸ªå€¼ï¼Œè€Œæ˜¯å­˜å‚¨ä¸€ä¸ªè®¡æ•°ã€‚æ¯”å¦‚å¦‚æœ A å’Œ B åŒæ—¶å‘½ä¸­äº†ä¸€ä¸ªæ•°ç»„çš„ç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªä½ç½®çš„å€¼å°±æ˜¯ 2ï¼Œå¦‚æœ A è¢«åˆ é™¤äº†å°±æŠŠè¿™ä¸ªå€¼ä» 2 æ”¹ä¸º 1ã€‚ä½†è¿™ä¼šå¢åŠ ç©ºé—´çš„æ¶ˆè€—ã€‚æ‰€ä»¥ï¼Œè¦ä¾æ®ä¸šåŠ¡åœºæ™¯æ¥é€‰æ‹©ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚ 7.2 ç¼“å­˜å‡»ç©¿ Hotspot Invalid é—®ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ ç¼“å­˜å‡»ç©¿ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œè¯¥æ•°æ®å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰ã€‚è¿™å°±å¯èƒ½ä¼šå¯¼è‡´ç¬æ—¶å¤§é‡çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚ **æ¯”å¦‚ï¼š**ç§’æ€è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼“å­˜ä¸­çš„æŸä¸ªç§’æ€å•†å“çš„æ•°æ®çªç„¶è¿‡æœŸï¼Œè¿™å°±å¯¼è‡´ç¬æ—¶å¤§é‡å¯¹è¯¥å•†å“çš„è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚ é—®ï¼šæœ‰å•¥è§£å†³æ–¹æ³•ï¼Ÿ è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸæˆ–è€…è¿‡æœŸæ—¶é—´æ¯”è¾ƒé•¿ã€‚ é’ˆå¯¹çƒ­ç‚¹æ•°æ®æå‰é¢„çƒ­ï¼Œå°†å…¶å­˜å…¥ç¼“å­˜ä¸­å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´æ¯”å¦‚ç§’æ€åœºæ™¯ä¸‹çš„æ•°æ®åœ¨ç§’æ€ç»“æŸä¹‹å‰ä¸è¿‡æœŸã€‚ åˆ†å¸ƒå¼é”ã€‚æ§åˆ¶åœ¨æŸä¸€ä¸ªçƒ­ç‚¹ç¼“å­˜é¡¹å¤±æ•ˆä¹‹åå¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹è·å¾—é”ï¼Œç©¿é€åˆ°æ•°æ®åº“ï¼Œå°†æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œåœ¨ç¼“å­˜æœªåŠ è½½ä¹‹å‰ï¼Œæ‰€æœ‰è®¿é—®è¿™ä¸ªç¼“å­˜çš„è¯·æ±‚éƒ½é˜»å¡æˆ–ç›´æ¥è¿”å›ï¼› é€»è¾‘è¿‡æœŸï¼Œå½“å‘ç°æ•°æ®è¿‡æœŸï¼Œå¹¶ä¸”å°è¯•è·å–äº’æ–¥é”å¤±è´¥æ—¶ï¼Œä¼šè¿”å›æ—§æ•°æ®ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»æœ‰å…¶ä»–çº¿ç¨‹å»æ›´æ–°æ•°æ®äº†ã€‚è¿™ä¸»è¦ä¿è¯æ•°æ®å¯ç”¨æ€§ã€‚ é—®ï¼šç¼“å­˜ç©¿é€å’Œç¼“å­˜å‡»ç©¿çš„åŒºåˆ«ï¼Ÿ ç¼“å­˜ç©¿é€ä¸­ï¼Œè¯·æ±‚çš„ key æ—¢ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚ ç¼“å­˜å‡»ç©¿ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯ çƒ­ç‚¹æ•°æ® ï¼Œè¯¥æ•°æ® å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰ã€‚ 7.3 ç¼“å­˜é›ªå´© é—®ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚ **æ¯”å¦‚ï¼š**æ•°æ®åº“ä¸­çš„å¤§é‡æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼Œè¿™ä¸ªæ—¶å€™çªç„¶æœ‰å¤§é‡çš„è¯·æ±‚éœ€è¦è®¿é—®è¿™äº›è¿‡æœŸçš„æ•°æ®ã€‚ é—®ï¼šæœ‰å•¥è§£å†³æ–¹æ³•ï¼Ÿ ==é’ˆå¯¹ Redis å®•æœºçš„æƒ…å†µï¼š== é‡‡ç”¨ Redis é›†ç¾¤ï¼Œé¿å…å•æœºå‡ºç°é—®é¢˜æ•´ä¸ªç¼“å­˜æœåŠ¡éƒ½æ²¡åŠæ³•ä½¿ç”¨ã€‚ æœåŠ¡é™çº§é™æµ å› ä¸º Redis æ•…éšœå®•æœºè€Œå¯¼è‡´ç¼“å­˜é›ªå´©é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨æœåŠ¡é™çº§é™æµæœºåˆ¶ï¼Œæš‚åœä¸šåŠ¡åº”ç”¨å¯¹ç¼“å­˜æœåŠ¡çš„è®¿é—®ï¼Œè¿”å›é»˜è®¤å€¼æˆ–å‹å¥½æç¤ºï¼Œä¸ç”¨å†ç»§ç»­è®¿é—®æ•°æ®åº“ï¼Œç„¶åç­‰åˆ° Redis æ¢å¤æ­£å¸¸åï¼Œå†å…è®¸ä¸šåŠ¡åº”ç”¨è®¿é—®ç¼“å­˜æœåŠ¡ã€‚ æœåŠ¡é™çº§é™æµæœºåˆ¶æ˜¯ä¿æŠ¤æ•°æ®åº“çš„æ­£å¸¸å…è®¸ï¼Œä½†æ˜¯æš‚åœäº†ä¸šåŠ¡åº”ç”¨è®¿é—®ç¼“å­˜æœç³»ç»Ÿï¼Œå…¨éƒ¨ä¸šåŠ¡éƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚ è¯·æ±‚é™æµ ä¸ºäº†å‡å°‘å¯¹ä¸šåŠ¡çš„å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨è¯·æ±‚é™æµæœºåˆ¶ï¼Œåªå°†å°‘éƒ¨åˆ†è¯·æ±‚å‘é€åˆ°æ•°æ®åº“è¿›è¡Œå¤„ç†ï¼Œå†å¤šçš„è¯·æ±‚å°±åœ¨å…¥å£ç›´æ¥æ‹’ç»æœåŠ¡ï¼Œç­‰åˆ° Redis æ¢å¤æ­£å¸¸å¹¶æŠŠç¼“å­˜é¢„çƒ­å®Œåï¼Œå†è§£é™¤è¯·æ±‚é™æµçš„æœºåˆ¶ã€‚ ==å¤§é‡æ•°æ®åŒæ—¶è¿‡æœŸçš„æƒ…å†µï¼š== **å‡åŒ€(éšæœº)**è®¾ç½®è¿‡æœŸæ—¶é—´ï¼› äº’æ–¥é”ã€‚å¦‚æœå‘ç°è®¿é—®çš„æ•°æ®ä¸åœ¨ Redis é‡Œï¼Œå°±åŠ ä¸ªäº’æ–¥é”ï¼Œä¿è¯åŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªè¯·æ±‚æ¥æ„å»ºç¼“å­˜ã€‚ é—®ï¼šç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æœ‰å•¥åŒºåˆ«ï¼Ÿ ç¼“å­˜é›ªå´©æ˜¯ç¼“å­˜ä¸­çš„å¤§é‡æˆ–æ‰€æœ‰æ•°æ®å¤±æ•ˆï¼› ç¼“å­˜å‡»ç©¿æ˜¯æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸å­˜åœ¨ä¸ç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰ã€‚ 7.4 ç¼“å­˜ä¸€è‡´æ€§â­ ç¼“å­˜ä¸€è‡´æ€§çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šåœ¨æ›´æ–°æ•°æ®åº“æ•°æ®æ—¶ï¼Œå¦‚ä½•ä¿è¯ç¼“å­˜æ•°æ®ä¹ŸåŒæ­¥æ›´æ–°æˆ–å¤±æ•ˆï¼Œé¿å…è¯»å–åˆ°è¿‡æœŸæˆ–é”™è¯¯çš„æ•°æ®ã€‚ å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥æœ‰ä»¥ä¸‹å‡ ç§ï¼š Cache Asideâ­ï¼šæ—è·¯ç¼“å­˜ç­–ç•¥ï¼› Read/Write Throughï¼šè¯»ç©¿/å†™ç©¿ç­–ç•¥ï¼› Write Backï¼šå†™å›ç­–ç•¥ã€‚ ä»¥ä¸Šç­–ç•¥éƒ½ä¸èƒ½å®Œå…¨ä¿è¯å¼ºä¸€è‡´æ€§ï¼ˆå³ä»»ä½•æ—¶åˆ»éƒ½èƒ½è¯»å–åˆ°æœ€æ–°çš„æ•°æ®ï¼‰ï¼Œåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå³ç»è¿‡ä¸€æ®µæ—¶é—´åèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼‰ã€‚è¦å®ç°å¼ºä¸€è‡´æ€§ï¼Œåˆ™éœ€è¦ç‰ºç‰²ç³»ç»Ÿçš„å¯ç”¨æ€§æˆ–åˆ†åŒºå®¹å¿æ€§ï¼ˆæ ¹æ®CAPç†è®ºï¼‰ã€‚ è¿™é‡Œä¸»è¦ä»‹ç»äº†æ—è·¯ç¼“å­˜ç­–ç•¥ï¼Œæœ‰ç©ºå†çœ‹å…¶ä»–ä¸¤ç§ç­–ç•¥ã€‚ é—®ï¼šå¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Ÿâ­â­ å®é™…å¼€å‘ä¸­ï¼ŒRedis å’Œ MySQL çš„æ›´æ–°ç­–ç•¥ç”¨çš„æ˜¯æ—è·¯ç¼“å­˜ç­–ç•¥(Cache Aside)ã€‚ç­–ç•¥å¯ä»¥ç»†åˆ†ä¸ºã€Œè¯»ç­–ç•¥ã€å’Œã€Œå†™ç­–ç•¥ã€ã€‚ å†™ç­–ç•¥ï¼š é‡‡ç”¨å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜â­ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼› ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§ã€‚å•ä½“ç³»ç»Ÿå¤©ç”Ÿå°±èƒ½åŸå­æ€§ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯å°±ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ è¯»ç­–ç•¥ï¼š ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼› ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´(ç›¸å½“äºå…œåº•æ–¹æ¡ˆï¼Œé¿å…å†™æ–¹æ¡ˆæ›´æ–°ç¼“å­˜å¤±æ•ˆ)ã€‚ é—®ï¼šå†™ç­–ç•¥ä¸­ï¼Œèƒ½å¦å…ˆåˆ é™¤ç¼“å­˜ï¼Œåæ›´æ–°æ•°æ®åº“å‘¢ï¼Ÿâ­ ä¸èƒ½æ»´~~ å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼šè¿™ç§æ–¹å¼å¯ä»¥ä¿è¯ä¸ä¼šè¯»å–åˆ°è¿‡æœŸçš„ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚å¦‚æœåœ¨åˆ é™¤ç¼“å­˜åã€æ›´æ–°æ•°æ®åº“å‰ï¼Œæœ‰å…¶ä»–çº¿ç¨‹è¯»å–äº†è¯¥æ•°æ®ï¼Œå¹¶å°†æ—§æ•°æ®å†™å…¥äº†ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´ã€‚ å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜â­ï¼šè¿™ç§æ–¹å¼å…¶å®ç†è®ºä¸Šä¹Ÿæœ‰é—®é¢˜ï¼š å­˜åœ¨å»¶è¿Ÿé—®é¢˜(ä¼šè¯»åˆ°æ—§æ•°æ®)ã€‚å¦‚æœåœ¨æ›´æ–°æ•°æ®åº“åã€åˆ é™¤ç¼“å­˜å‰ï¼Œæœ‰å…¶ä»–çº¿ç¨‹è¯»å–äº†è¯¥æ•°æ®ï¼Œå°±ä¼šè¯»å–åˆ°è¿‡æœŸçš„æ—§æ•°æ®ï¼› ç†è®ºä¸Šä¹Ÿå¯èƒ½å‡ºç°ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸ä¸€è‡´ï¼Œä¸è¿‡å‡ºç°çš„æœºç‡è¿œå°äºç¬¬ä¸€ç§ã€‚åŸå› æ˜¯ç¼“å­˜çš„å†™å…¥é€šå¸¸è¿œè¿œå¿«äºæ•°æ®åº“çš„å†™å…¥ï¼Œæ‰€ä»¥åœ¨å®é™…ä¸­å¾ˆéš¾å‡ºç°è¯·æ±‚ B å·²ç»æ›´æ–°äº†æ•°æ®åº“å¹¶ä¸”æ¸…ç©ºäº†ç¼“å­˜ï¼Œè¯·æ±‚ A æ‰æ›´æ–°å®Œç¼“å­˜çš„æƒ…å†µã€‚è€Œä¸€æ—¦è¯·æ±‚ A æ—©äºè¯·æ±‚ B æ¸…ç©ºç¼“å­˜ä¹‹å‰æ›´æ–°äº†ç¼“å­˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚å°±ä¼šå› ä¸ºç¼“å­˜ä¸ºç©ºè€Œä»æ•°æ®åº“ä¸­é‡æ–°åŠ è½½æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚ ç®€å•æ€»ç»“ï¼Œè¶³ä»¥é€‚åº”ç»å¤§éƒ¨åˆ†çš„äº’è”ç½‘å¼€å‘åœºæ™¯çš„å†³ç­–ï¼š é’ˆå¯¹å¤§éƒ¨åˆ†è¯»å¤šå†™å°‘åœºæ™¯ï¼Œå»ºè®®é€‰æ‹©æ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜çš„ç­–ç•¥ã€‚ é’ˆå¯¹è¯»å†™ç›¸å½“æˆ–è€…å†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œå»ºè®®é€‰æ‹©æ›´æ–°æ•°æ®åº“åæ›´æ–°ç¼“å­˜çš„ç­–ç•¥ã€‚ é—®ï¼šCache Aside æœ‰å•¥é—®é¢˜å—ï¼Ÿ Cache Aside å­˜åœ¨çš„æœ€å¤§çš„é—®é¢˜æ˜¯å½“å†™å…¥æ¯”è¾ƒé¢‘ç¹æ—¶ï¼Œç¼“å­˜ä¸­çš„æ•°æ®ä¼šè¢«é¢‘ç¹åœ°æ¸…ç†ï¼Œè¿™æ ·ä¼šå¯¹ç¼“å­˜çš„å‘½ä¸­ç‡æœ‰ä¸€äº›å½±å“ã€‚å¦‚æœä½ çš„ä¸šåŠ¡å¯¹ç¼“å­˜å‘½ä¸­ç‡æœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š ä¸€ç§åšæ³•æ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶ä¹Ÿæ›´æ–°ç¼“å­˜ï¼Œåªæ˜¯åœ¨æ›´æ–°ç¼“å­˜å‰å…ˆåŠ ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œå› ä¸ºè¿™æ ·åœ¨åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ›´æ–°ç¼“å­˜ï¼Œå°±ä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜äº†ã€‚å½“ç„¶è¿™ä¹ˆåšå¯¹äºå†™å…¥çš„æ€§èƒ½ä¼šæœ‰ä¸€äº›å½±å“ï¼› å¦ä¸€ç§åšæ³•åŒæ ·ä¹Ÿæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶æ›´æ–°ç¼“å­˜ï¼Œåªæ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å³ä½¿å‡ºç°ç¼“å­˜ä¸ä¸€è‡´çš„æƒ…å†µï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šå¾ˆå¿«åœ°è¿‡æœŸï¼Œå¯¹ä¸šåŠ¡çš„å½±å“ä¹Ÿæ˜¯å¯ä»¥æ¥å—ã€‚ å‚è€ƒæ–‡ç« ï¼š ä¸‡å­—å›¾æ–‡è®²é€æ•°æ®åº“ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ 7.5 è¿‡æœŸã€æ·˜æ±° é—®ï¼šRedis æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªé”®å€¼å¯¹æ˜¯å¦è¿‡æœŸï¼Ÿ å¯ä»¥é€šè¿‡expireè®¾ç½®è¿‡æœŸæ—¶é—´ttlã€‚åˆ©ç”¨ä¸¤ä¸ª Dict åˆ†åˆ«è®°å½•key-valueå’Œkey-ttlã€‚ typedef struct redisDb { dict *dict; /* æ•°æ®åº“é”®ç©ºé—´ï¼Œå­˜æ”¾ç€æ‰€æœ‰çš„é”®å€¼å¯¹ */ dict *expires; /* é”®çš„è¿‡æœŸæ—¶é—´ */ .... } redisDb; é—®ï¼šRedis å¯¹äºè¿‡æœŸ Key çš„ç­–ç•¥ï¼Ÿ å¯¹äºè¿‡æœŸ keyï¼ŒRedis é‡‡ç”¨çš„æ˜¯ å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤ ç­–ç•¥ã€‚ æƒ°æ€§åˆ é™¤ï¼šåœ¨è®¿é—®ä¸€ä¸ªkeyæ—¶ï¼Œå…ˆæ£€æŸ¥å®ƒæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±åˆ é™¤å®ƒã€‚ ä¼˜ç‚¹ï¼šåœ¨è®¿é—®æ—¶æ‰ä¼šæ£€æŸ¥ï¼Œåªä¼šä½¿ç”¨å¾ˆå°‘çš„ç³»ç»Ÿèµ„æºï¼Œå¯¹ CPU å‹å¥½ï¼› ç¼ºç‚¹ï¼šè‹¥ key è¿‡æœŸï¼Œä¹‹åä¸€ç›´æ²¡è¢«è®¿é—®åˆ°ï¼Œå°±ä¼šä¸€ç›´å ç”¨å†…å­˜ã€‚ å®šæœŸåˆ é™¤ï¼šå‘¨æœŸæ€§çš„å–å‡ºéƒ¨åˆ† key è¿›è¡Œæ£€æŸ¥ï¼Œç„¶ååˆ é™¤å…¶ä¸­è¿‡æœŸçš„ã€‚ ä¼˜ç‚¹ï¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ï¼Œæ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ï¼ŒåŒæ—¶ä¹Ÿèƒ½è§„é¿æƒ°æ€§åˆ é™¤çš„é—®é¢˜ï¼› ç¼ºç‚¹ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœçªç„¶é‡åˆ°å¤§é‡è¿‡æœŸ key çš„è¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å¿…é¡»ç­‰å¾…å®šæœŸæ¸…ç†è¿‡æœŸ key ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œå› ä¸ºè¿™ä¸ªè¿™ä¸ªå®šæœŸä»»åŠ¡çº¿ç¨‹æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚è¿™å°±å¯¼è‡´å®¢æˆ·ç«¯è¯·æ±‚æ²¡åŠæ³•è¢«åŠæ—¶å¤„ç†ï¼Œå“åº”é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚ é—®ï¼šå¤§é‡ key é›†ä¸­è¿‡æœŸçš„æƒ…å†µæ€ä¹ˆåŠï¼Ÿ å¸¸é‡‡ç”¨ä»¥ä¸‹ä¸¤ç§è§£å†³æ–¹æ³•ï¼š ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ï¼› å¼€å¯æƒ°æ€§åˆ é™¤ï¼Œè®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚ é—®ï¼šRedis éƒ½æœ‰å•¥å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ Redis å†…å­˜æ·˜æ±°ç­–ç•¥å…±æœ‰ 8 ç§ï¼Œè¿™ 8","date":"2023-04-21","objectID":"/07-redis/:8:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"å…«ã€Redis é›†ç¾¤ ","date":"2023-04-21","objectID":"/07-redis/:9:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"8.1 ä¸»ä»å¤åˆ¶ é—®ï¼šRedis å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ **æ•°æ®æŒä¹…åŒ–ï¼š**è¿™æ˜¯åŸºç¡€ï¼Œä¿è¯ç³»ç»Ÿåœ¨å‘ç”Ÿå®•æœºæˆ–è€…é‡å¯ä¹‹åæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ ==ä¸‰ç§æ¨¡å¼ï¼š== **ä¸»ä»å¤åˆ¶ï¼š**å°†æ•°æ®å­˜å‚¨è‡³å¤šå°æœåŠ¡å™¨ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œä¿è¯èƒ½å¤Ÿå¾ˆå¿«çš„åˆ‡æ¢ï¼› å“¨å…µï¼šç›‘æ§ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè‹¥ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œè‡ªåŠ¨é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶å®Œæˆæ•…éšœè½¬ç§»ï¼› é›†ç¾¤ï¼šæä¾›äº†å¤šä¸»å¤šä»çš„ Redis åˆ†å¸ƒå¼é›†ç¾¤ç¯å¢ƒï¼Œå®ç°åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸åŒçš„å†…å®¹ï¼ŒèŠ‚çœäº†å†…å­˜ä¹Ÿæé«˜äº†å¯ç”¨æ€§ã€‚ é—®ï¼šå¦‚ä½•ä¿è¯å¤šä¸ª Redis èŠ‚ç‚¹é—´çš„æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿ é€šè¿‡ä¸»ä»å¤åˆ¶å’Œè¯»å†™åˆ†ç¦»ã€‚ é—®ï¼šä¸»ä»å¤åˆ¶æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿâ­ğŸš© ä¸»ä»å¤åˆ¶æ˜¯ Redis é«˜å¯ç”¨æœåŠ¡çš„æœ€åŸºç¡€çš„ä¿è¯ã€‚å®ç°æ–¹æ¡ˆå°±æ˜¯å°†ä»å‰çš„ä¸€å° Redis æœåŠ¡å™¨ï¼ŒåŒæ­¥æ•°æ®åˆ°å¤šå°ä» Redis æœåŠ¡å™¨ä¸Šï¼Œå³ä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œä¸”ä¸»ä»æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨çš„æ˜¯**ã€Œè¯»å†™åˆ†ç¦»ã€**çš„æ–¹å¼ã€‚ ==è¯»å†™åˆ†ç¦»ï¼š== è¯»å†™åˆ†ç¦»æŒ‡ä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å’Œå†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼›è€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œç„¶åå°†æœ€æ–°çš„æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚ è¯¥æ–¹å¼ï¼Œæ— æ³•å®ç°å¼ºä¸€è‡´æ€§ä¿è¯ï¼ˆä¸»ä»æ•°æ®æ—¶æ—¶åˆ»åˆ»ä¿æŒä¸€è‡´ï¼‰ï¼Œæ•°æ®ä¸ä¸€è‡´æ˜¯éš¾ä»¥é¿å…çš„ã€‚ ==ä¸»ä»å¤åˆ¶ï¼š== å…¨é‡åŒæ­¥(ä»èŠ‚ç‚¹æ˜¯æ–°åŠ å…¥é›†ç¾¤çš„)ï¼š ä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€ slaveof å‘½ä»¤ï¼ŒåŒ…æ‹¬(replid=?, offset=-1)ï¼Œå»ºç«‹å¤åˆ¶å…³ç³»ï¼Œå¹¶å‘é€è¯·æ±‚åŒæ­¥å‘½ä»¤ã€‚ ä¸»èŠ‚ç‚¹æ”¶åˆ°å‘½ä»¤åï¼Œåˆ¤æ–­è¦è¿›è¡Œå“ªç§åŒæ­¥ï¼Œè‹¥æ˜¯å…¨é‡åŒæ­¥ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåå°å­çº¿ç¨‹ï¼Œè´Ÿè´£å°†è‡ªå·±çš„æ•°æ®**å¿«ç…§ï¼ˆRDBæ–‡ä»¶ï¼‰**å‘é€ç»™ä»èŠ‚ç‚¹ã€‚ ä»èŠ‚ç‚¹æ”¶åˆ°æ•°æ®å¿«ç…§åï¼Œä¼šå…ˆä¿å­˜åœ¨æœ¬åœ°ï¼Œç„¶åæ¸…ç©ºè‡ªå·±çš„æ•°æ®ï¼Œå¹¶è½½å…¥æ”¶åˆ°çš„æ•°æ®å¿«ç…§ã€‚ ä¸»èŠ‚ç‚¹åœ¨ç­‰å¾…ä»èŠ‚ç‚¹åŒæ­¥æ•°æ®çš„åŒæ—¶ï¼Œè¿˜ä¼šå°†è‡ªå·±æ–°æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ç¼“å­˜åœ¨ replication buffer ä¸­ã€‚ å½“ä»èŠ‚ç‚¹å®Œæˆæ•°æ®å¿«ç…§çš„è½½å…¥åï¼Œä¼šå‘ä¸»èŠ‚ç‚¹å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶å†™å‘½ä»¤ã€‚ ä¸»èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šå°† replication buffer ä¸­çš„å†™å‘½ä»¤ä¾æ¬¡å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä½¿å¾—ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹ä¿æŒä¸€è‡´ã€‚ æ­¤åï¼Œä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¿æŒä¸€ä¸ªé•¿è¿æ¥ã€‚æ¯æ‰§è¡Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œå°±ä¼šå°†è¯¥å‘½ä»¤åŒæ­¥ç»™æ‰€æœ‰çš„ä»èŠ‚ç‚¹ã€‚ å¢é‡åŒæ­¥(ä»èŠ‚ç‚¹é‡å¯ååŒæ­¥)ï¼š è‹¥ç½‘ç»œä¸å¥½ï¼Œé•¿è¿æ¥æ–­äº†ã€‚æ¢å¤åï¼Œä¸»ä»æœåŠ¡å™¨ä¼šé‡‡ç”¨å¢é‡åŒæ­¥çš„æ–¹å¼ç»§ç»­åŒæ­¥ã€‚ ä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹å‘é€åŒæ­¥å‘½ä»¤(replid, offset)ï¼› ä¸»èŠ‚ç‚¹åˆ¤æ–­ replid æ˜¯å¦ä¸€è‡´ï¼Œè‹¥ä¸€è‡´ä¸”ä»èŠ‚ç‚¹çš„ offset è·Ÿä¸»èŠ‚ç‚¹çš„ offset å·®è·æ²¡æœ‰è¿‡å¤§(æœªåŒæ­¥çš„æ•°æ®æ²¡è¢«è¦†ç›–)ï¼Œå°±ä¼šå¢é‡å¤‡ä»½ï¼Œä¸»èŠ‚ç‚¹ä¼šä»repl_baklogè·å–ä»èŠ‚ç‚¹offsetä¹‹åçš„å¢é‡æ•°æ®ï¼Œå°†å¢é‡æ•°æ®å†™å…¥åˆ° replication buffer ç¼“å†²åŒºï¼Œç„¶åå‘é€ç»™ä»èŠ‚ç‚¹ã€‚ é—®ï¼šä¸»èŠ‚ç‚¹å¦‚ä½•åˆ¤æ–­ä»èŠ‚ç‚¹æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡æ¥åŒæ­¥æ•°æ®ï¼Ÿâ­ ä¸¤ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼š **Replication Idï¼š**ç®€ç§°replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œidä¸€è‡´è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰å”¯ä¸€çš„replidï¼Œä»èŠ‚ç‚¹ä¼šç»§æ‰¿ä¸»èŠ‚ç‚¹çš„replidã€‚ Offsetï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨repl_baklogä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚ä»èŠ‚ç‚¹å®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetã€‚å¦‚æœä»èŠ‚ç‚¹çš„offsetå°äºä¸»èŠ‚ç‚¹çš„offsetï¼Œè¯´æ˜ä»èŠ‚ç‚¹æ•°æ®è½åäºä¸»èŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–°ã€‚ ä»èŠ‚ç‚¹åŒæ­¥æ•°æ®æ—¶ï¼Œå¿…é¡»å‘ä¸»èŠ‚ç‚¹å£°æ˜è‡ªå·±çš„replidå’Œoffsetï¼Œç„¶åç”±ä¸»èŠ‚ç‚¹åˆ¤æ–­éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ï¼š è‹¥replidä¸º â€œ?â€ æˆ– ä¸ä¸€æ ·ï¼Œå°±æ˜¯ç¬¬ä¸€æ¬¡ï¼Œå°†è¿›è¡Œå…¨é‡åŒæ­¥ï¼› è‹¥replidä¸€æ ·ï¼Œå°±é€šè¿‡offsetè¿›è¡Œå¢é‡åŒæ­¥ã€‚ ==æ³¨æ„ï¼š==éš¾é“ä»èŠ‚ç‚¹æ–­è”ç‰¹åˆ«ä¹…ï¼Œå†è¿æ¥ä¸Šä¹Ÿæ˜¯å¢é‡åŒæ­¥å—ï¼Ÿ å½“ç„¶ä¸æ˜¯ï¼è¿™å°±è·Ÿrepl_baklogæœ‰å…³äº†~ repl_baklogç›¸å½“äºä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œå†™æ»¡ä¹‹åå°±ä¼šè¦†ç›–æœ€æ—©çš„æ•°æ®ã€‚å¦‚æœä»èŠ‚ç‚¹æ–­å¼€è¿‡ä¹…ï¼Œå¯¼è‡´å°šæœªå¤‡ä»½çš„æ•°æ®å·²ç»è¢«è¦†ç›–äº†ï¼Œå°±æ— æ³•åŸºäºrepl_baklogåšå¢é‡åŒæ­¥äº†ï¼Œåªèƒ½è§¦å‘å…¨é‡åŒæ­¥ï¼ é—®ï¼šå…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥çš„åŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ åŒºåˆ«ï¼š **å…¨é‡åŒæ­¥ï¼š**ä¸»èŠ‚ç‚¹å°†å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹ã€‚åç»­å‘½ä»¤è®°å½•åœ¨baklogä¸­ï¼Œé€ä¸ªå‘é€ç»™ä»èŠ‚ç‚¹ï¼› **å¢é‡åŒæ­¥ï¼š**ä»èŠ‚ç‚¹æäº¤è‡ªå·±çš„offsetåˆ°ä¸»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹è·å–baklogä¸­çš„offsetä¹‹åçš„å‘½ä»¤ç»™ä»èŠ‚ç‚¹ã€‚ ä»€ä¹ˆæ—¶å€™å…¨é‡åŒæ­¥ï¼š ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥åˆ°ä¸»èŠ‚ç‚¹æ—¶ï¼› ä»èŠ‚ç‚¹ç¦»å¼€å¤ªä¹…ï¼ŒæœªåŒæ­¥çš„baklogå·²ç»è¢«è¦†ç›–ï¼› ä»€ä¹ˆæ—¶å€™å¢é‡åŒæ­¥ï¼š ä»èŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨baklogä¸­èƒ½æ‰¾åˆ°offsetæ—¶ã€‚ é—®ï¼šå¦‚ä½•ä¼˜åŒ–ä¸»ä»æ•°æ®åŒæ­¥ï¼Ÿ ä¼˜åŒ–å…¨é‡åŒæ­¥ï¼š åœ¨ç½‘ç»œæ¡ä»¶å¾ˆå¥½çš„æ—¶å€™ï¼Œåœ¨ master å¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯ä¸æŠŠ RDB æ–‡ä»¶å†™å…¥åˆ°ç£ç›˜ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥ç½‘ç»œIOï¼Œå‡å°‘ç£ç›˜çš„å¤åˆ¶ï¼› å‡å°‘å…¨é‡åŒæ­¥æ¬¡æ•°ï¼š é€‚å½“æé«˜repl_backlogï¼› å‘ç°ä»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥ï¼› é™åˆ¶ä¸€ä¸ªä¸»èŠ‚ç‚¹ä¸Šçš„ä»èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨å¤ªå¤šä»èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨ ä¸»-ä»-ä» çš„ç»“æ„ï¼Œå‡å°‘ä¸»èŠ‚ç‚¹å‹åŠ›ã€‚ é—®ï¼šRedisä¸»ä»èŠ‚ç‚¹æ—¶é•¿è¿æ¥è¿˜æ˜¯çŸ­è¿æ¥ï¼Ÿ é•¿è¿æ¥ã€‚ é—®ï¼šæ€ä¹ˆåˆ¤æ–­ Redis æŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ Redis åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡äº’ç›¸çš„ ping-pong å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œå¦‚æœæœ‰ä¸€åŠä»¥ä¸Šçš„èŠ‚ç‚¹å» ping ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™æ²¡æœ‰ pong å›åº”ï¼Œé›†ç¾¤å°±ä¼šè®¤ä¸ºè¿™ä¸ªèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä¼šæ–­å¼€ä¸è¿™ä¸ªèŠ‚ç‚¹çš„è¿æ¥ã€‚ Redis ä¸»ä»èŠ‚ç‚¹å‘é€çš„å¿ƒè·³é—´éš”æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œä¸”ä½œç”¨ä¹Ÿæœ‰ä¸€ç‚¹åŒºåˆ«ï¼š Redis ä¸»èŠ‚ç‚¹é»˜è®¤æ¯éš” 10 ç§’å¯¹ä»èŠ‚ç‚¹å‘é€ ping å‘½ä»¤ï¼Œåˆ¤æ–­ä»èŠ‚ç‚¹çš„å­˜æ´»æ€§å’Œè¿æ¥çŠ¶æ€ï¼Œå¯é€šè¿‡å‚æ•°repl-ping-slave-periodæ§åˆ¶å‘é€é¢‘ç‡ã€‚ Redis ä»èŠ‚ç‚¹æ¯éš” 1 ç§’å‘é€ replconf ack{offset} å‘½ä»¤ï¼Œç»™ä¸»èŠ‚ç‚¹ä¸ŠæŠ¥è‡ªèº«å½“å‰çš„å¤åˆ¶åç§»é‡ï¼Œç›®çš„æ˜¯ä¸ºäº†ï¼š å®æ—¶ç›‘æµ‹ä¸»ä»èŠ‚ç‚¹ç½‘ç»œçŠ¶æ€ï¼› ä¸ŠæŠ¥è‡ªèº«å¤åˆ¶åç§»é‡ï¼Œæ£€æŸ¥å¤åˆ¶æ•°æ®æ˜¯å¦ä¸¢å¤±ï¼Œå¦‚æœä»èŠ‚ç‚¹æ•°æ®ä¸¢å¤±ï¼Œå†ä»ä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç¼“å†²åŒºä¸­æ‹‰å–ä¸¢å¤±æ•°æ®ã€‚ é—®ï¼šä¸»ä»å¤åˆ¶æ¶æ„ä¸­ï¼Œè¿‡æœŸkeyå¦‚ä½•å¤„ç†ï¼Ÿ ä¸»èŠ‚ç‚¹å¤„ç†äº†ä¸€ä¸ªkeyæˆ–è€…é€šè¿‡æ·˜æ±°ç®—æ³•æ·˜æ±°äº†ä¸€ä¸ªkeyæ—¶ï¼Œä¸»èŠ‚ç‚¹éœ€è¦æ¨¡æ‹Ÿä¸€æ¡delå‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œå°±è¿›è¡Œåˆ é™¤keyçš„æ“ä½œã€‚ é—®ï¼šRedis æ˜¯åŒæ­¥å¤åˆ¶è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Ÿ Redis ä¸»èŠ‚ç‚¹æ¯æ¬¡æ”¶åˆ°å†™å‘½ä»¤ä¹‹åï¼Œå…ˆå†™åˆ°å†…éƒ¨çš„ç¼“å†²åŒºï¼Œç„¶åå¼‚æ­¥å‘é€ç»™ä»èŠ‚ç‚¹ã€‚ é—®ï¼šä¸»ä»å¤åˆ¶ä¸­ä¸¤ä¸ª Buffer(replication buffer ã€repl backlog buffer)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ replication buffer ã€repl backlog buffer åŒºåˆ«å¦‚ä¸‹ï¼š å‡ºç°çš„é˜¶æ®µä¸ä¸€æ ·ï¼š repl backlog buffer æ˜¯åœ¨å¢é‡å¤åˆ¶é˜¶æ®µå‡ºç°ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹åªåˆ†é…ä¸€ä¸ª repl backlog bufferï¼› replication buffer æ˜¯åœ¨å…¨é‡å¤åˆ¶é˜¶æ®µå’Œå¢é‡å¤åˆ¶é˜¶æ®µéƒ½ä¼šå‡ºç°ï¼Œä¸»èŠ‚ç‚¹ä¼šç»™æ¯ä¸ªæ–°è¿æ¥çš„ä»èŠ‚ç‚¹ï¼Œåˆ†é…ä¸€ä¸ª replication bufferï¼› è¿™ä¸¤ä¸ª Buffer éƒ½æœ‰å¤§å°é™åˆ¶çš„ï¼Œå½“ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œå‘ç”Ÿçš„äº‹æƒ…ä¸ä¸€æ ·ï¼š å½“ repl backlog buffer æ»¡äº†ï¼Œå› ä¸ºæ˜¯ç¯å½¢ç»“æ„ï¼Œä¼šç›´æ¥è¦†ç›–èµ·å§‹ä½ç½®æ•°æ®; å½“ replication buffer æ»¡äº†ï¼Œä¼šå¯¼è‡´è¿æ¥æ–­å¼€ï¼Œåˆ é™¤ç¼“å­˜ï¼Œä»èŠ‚ç‚¹é‡æ–°è¿æ¥ï¼Œé‡æ–°å¼€å§‹å…¨é‡å¤åˆ¶ã€‚ é—®ï¼šå¦‚ä½•åº”å¯¹ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ ä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´çš„ç°è±¡ï¼Œæ˜¯å› ä¸ºä¸»ä»èŠ‚ç‚¹é—´çš„å‘½ä»¤å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥æ— æ³•å®ç°å¼ºä¸€è‡´æ€§ä¿è¯ï¼ˆä¸»ä»æ•°æ®æ—¶æ—¶åˆ»åˆ»ä¿æŒä¸€è‡´ï¼‰ã€‚ æœ‰ä¸¤ç§æ–¹æ³•ï¼š ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå°½é‡ä¿è¯ä¸»ä»èŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥çŠ¶å†µè‰¯å¥½ï¼Œé¿å…ä¸»ä»èŠ‚ç‚¹åœ¨ä¸åŒçš„æœºæˆ¿ã€‚ ç¬¬äºŒç§æ–¹æ³•ï¼Œå¯ä»¥å¼€å‘ä¸€ä¸ªå¤–éƒ¨ç¨‹åºæ¥ç›‘æ§ä¸»ä»èŠ‚ç‚¹é—´çš„å¤åˆ¶è¿›åº¦ã€‚å…·ä½“åšæ³•ï¼š Redis çš„ INFO replication å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸»èŠ‚ç‚¹æ¥æ”¶å†™å‘½ä»¤çš„è¿›åº¦ä¿¡æ¯ï¼ˆmaster_repl_offsetï¼‰å’Œä»èŠ‚ç‚¹å¤åˆ¶å†™å‘½ä»¤çš„è¿›åº¦ä¿¡æ¯ï¼ˆslave_repl_offsetï¼‰ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å‘ä¸€ä¸ªç›‘æ§ç¨‹åºï¼Œå…ˆç”¨ INFO replication å‘½ä»¤æŸ¥åˆ°ä¸»ã€ä»èŠ‚ç‚¹çš„è¿›åº¦ï¼Œç„¶åï¼Œæˆ‘ä»¬ç”¨ master_repl_offset å‡å» slave_repl_offsetï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°ä»èŠ‚ç‚¹å’Œä¸»èŠ‚ç‚¹é—´çš„å¤åˆ¶è¿›åº¦å·®å€¼äº†ã€‚ å¦‚æœæŸä¸ªä»èŠ‚ç‚¹çš„è¿›åº¦å·®å€¼å¤§äºæˆ‘ä»¬é¢„è®¾çš„é˜ˆå€¼ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¢æˆ·ç«¯ä¸å†å’Œè¿™ä¸ªä»èŠ‚ç‚¹è¿æ¥è¿›è¡Œæ•°æ®è¯»å–ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘è¯»åˆ°ä¸ä¸€è‡´æ•°æ®çš„æƒ…å†µã€‚ä¸è¿‡ï¼Œä¸ºäº†é¿å…å‡ºç°å®¢æˆ·ç«¯å’Œæ‰€æœ‰ä»èŠ‚ç‚¹éƒ½ä¸èƒ½è¿æ¥çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æŠŠå¤åˆ¶è¿›åº¦å·®å€¼çš„é˜ˆå€¼è®¾ç½®å¾—å¤§ä¸€äº›ã€‚ é—®ï¼šä¸»ä»åˆ‡æ¢å¦‚ä½•å‡å°‘æ•°æ®ä¸¢å¤±ï¼Ÿ ä¸»ä»åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿæ•°æ®ä¸¢å¤±çš„æƒ…å†µæœ‰ä¸¤ç§ï¼š å¼‚æ­¥å¤åˆ¶åŒæ­¥ä¸¢å¤± é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤± ä¸å¯èƒ½ä¿è¯æ•°æ®å®Œå…¨ä¸ä¸¢å¤±ï¼Œåªèƒ½åšåˆ°ä½¿å¾—å°½é‡å°‘çš„æ•°æ®ä¸¢å¤±ã€‚ å¼‚æ­¥å¤åˆ¶åŒæ­¥ä¸¢å¤±ï¼š å¯¹äº Redis ä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®å¤åˆ¶ï¼Œæ˜¯å¼‚æ­¥å¤åˆ¶çš„ï¼Œå½“å®¢æˆ·ç«¯å‘é€å†™è¯·æ±‚ç»™ä¸»èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šè¿”å› okï¼Œæ¥ç€ä¸»èŠ‚ç‚¹å°†å†™è¯·æ±‚å¼‚æ­¥åŒæ­¥ç»™å„ä¸ªä»èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹è¿˜æ²¡æ¥å¾—åŠåŒæ­¥ç»™ä»èŠ‚ç‚¹æ—¶å‘ç”Ÿäº†æ–­ç”µï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å†…å­˜ä¸­çš„æ•°æ®ä¼šä¸¢å¤±ã€‚ å‡å°‘å¼‚æ­¥å¤åˆ¶çš„æ•°æ®ä¸¢å¤±çš„æ–¹æ¡ˆï¼š Redis é…ç½®é‡Œæœ‰ä¸€ä¸ªå‚æ•° min-slaves-max-lagï¼Œè¡¨ç¤ºä¸€æ—¦æ‰€æœ‰çš„ä»èŠ‚ç‚¹æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿéƒ½è¶…è¿‡äº† min-slaves-max-lag å®šä¹‰çš„å€¼ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°±ä¼šæ‹’ç»æ¥æ”¶ä»»ä½•è¯·æ±‚ã€‚ å‡è®¾å°† min-slaves-max-lag é…ç½®ä¸º 10s åï¼Œæ ¹æ®ç›®å‰ master-\u003eslave çš„å¤åˆ¶é€Ÿåº¦ï¼Œå¦‚æœæ•°æ®åŒæ­¥å®Œæˆæ‰€éœ€è¦æ—¶é—´è¶…è¿‡10sï¼Œå°±ä¼šè®¤ä¸º ","date":"2023-04-21","objectID":"/07-redis/:9:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"8.2 å“¨å…µæœºåˆ¶ å“¨å…µæ¨¡å¼æ˜¯åœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ç»„å“¨å…µï¼ˆsentinelï¼‰èŠ‚ç‚¹æ¥ç›‘æ§ä¸»ä»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå®ç°ä¸»ä»èŠ‚ç‚¹è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚å“¨å…µçš„ç»“æ„å’Œä½œç”¨å¦‚ä¸‹ï¼š ç›‘æ§ï¼šSentinel ä¼šä¸æ–­æ£€æŸ¥ Master å’Œ Slave çš„çŠ¶æ€ï¼› è‡ªåŠ¨æ•…éšœæ¢å¤ï¼šå¦‚æœ Master æ•…éšœï¼ŒSentinel ä¼šè‡ªåŠ¨å°†ä¸€ä¸ª Slave æå‡ä¸º Masterã€‚å½“æ•…éšœèŠ‚ç‚¹æ¢å¤åä¹Ÿä¼šä»¥æ–°çš„ Master ä¸ºä¸»èŠ‚ç‚¹ï¼› é€šçŸ¥ï¼šSentinel å……å½“ Redis å®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯è‡ªåŠ¨æ¨é€åˆ° Redis å®¢æˆ·ç«¯ã€‚ é—®ï¼šå“¨å…µæœºåˆ¶æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿâ­ å¦‚æœå‘ç°ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼Œå“¨å…µä¼šè‡ªåŠ¨é€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¯¼è€…(leader)ï¼Œç„¶åç”±é¢†å¯¼è€…ä»å‰©ä½™çš„ä»èŠ‚ç‚¹ä¸­é€‰å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å…¶ä»–å“¨å…µå’Œå®¢æˆ·ç«¯ã€‚ ==å…·ä½“å·¥ä½œè¿‡ç¨‹ï¼š== å“¨å…µä¼šå®šæœŸ(æ¯éš”1s)å‘æ‰€æœ‰çš„ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…ï¼Œæ£€æµ‹å®ƒä»¬çš„è¿è¡Œæƒ…å†µï¼› å¦‚æœä¸€ä¸ªå“¨å…µå‘ç°æŸä¸ªä¸»èŠ‚ç‚¹æ²¡æœ‰å“åº”å¿ƒè·³åŒ…ï¼Œå°±ä¼šå°†å…¶æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œç„¶åè¯·æ±‚å…¶ä»–å“¨å…µèŠ‚ç‚¹è¿›è¡ŒæŠ•ç¥¨ï¼› å¦‚æœæœ‰è¶…è¿‡æŒ‡å®šå€¼çš„å“¨å…µ(é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ quorum å€¼)éƒ½å°†æŸä¸ªä¸»èŠ‚ç‚¹æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿(ä¹Ÿå°±æ˜¯èµæˆ)ï¼Œé‚£ä¹ˆè¯¥ä¸»èŠ‚ç‚¹å°±è¢«è®¤ä¸ºæ˜¯å®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¼€å§‹è¿›è¡Œæ•…éšœè½¬ç§»ï¼› æ•…éšœè½¬ç§»è¿‡ç¨‹å‰ï¼Œå“¨å…µä¼šä»è¯¥ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰å€™é€‰è€…ä¸­é€‰å‡ºä¸€ä¸ªåˆé€‚çš„å€™é€‰è€…ï¼Œå°†å…¶å‡çº§ä¸ºå“¨å…µä¸­çš„ Leaderï¼Œè´Ÿè´£è¿›è¡Œæ•…éšœè½¬ç§»ï¼› â€‹ å€™é€‰è€…ï¼šå“ªä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œè¿™ä¸ªå“¨å…µèŠ‚ç‚¹ä»¥åŠæŠ•èµæˆç¥¨çš„å“¨å…µèŠ‚ç‚¹å°±éƒ½æ˜¯å€™é€‰è€…ï¼› Leader ä¼šä»æ‰€æœ‰çš„ä»èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼› æ•…éšœè½¬ç§»å®Œæˆåï¼ŒåŸæ¥çš„ä¸»èŠ‚ç‚¹å¦‚æœæ¢å¤äº†æ­£å¸¸ï¼Œå°±ä¼šå˜æˆæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚ é—®ï¼šå“¨å…µ å¦‚ä½•æˆä¸º å“¨å…µLeaderï¼Ÿ å€™é€‰è€…ï¼šå“ªä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œè¿™ä¸ªå“¨å…µèŠ‚ç‚¹ä»¥åŠæŠ•èµæˆç¥¨çš„å“¨å…µèŠ‚ç‚¹å°±éƒ½æ˜¯å€™é€‰è€…ã€‚ å€™é€‰è€…ä¼šå‘å…¶ä»–å“¨å…µå‘é€æŠ•ç¥¨è¯·æ±‚ï¼› æ¯ä¸ªå“¨å…µåªæœ‰ä¸€æ¬¡æŠ•ç¥¨æœºä¼šï¼Œå¦‚æœç”¨å®Œåå°±ä¸èƒ½å‚ä¸æŠ•ç¥¨äº†ï¼Œå¯ä»¥æŠ•ç»™è‡ªå·±æˆ–æŠ•ç»™åˆ«äººï¼Œä½†æ˜¯åªæœ‰å€™é€‰è€…æ‰èƒ½æŠŠç¥¨æŠ•ç»™è‡ªå·±ï¼› è¦æˆä¸ºå“¨å…µ Leaderï¼Œéœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼› ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚ é—®ï¼šå“¨å…µLeaderå¦‚ä½•é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹ï¼Ÿâ­ å“¨å…µ Leader é€šè¿‡å¦‚ä¸‹è§„åˆ™é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹ï¼š é€‰æ‹© Slave ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ã€‚ä¼˜å…ˆçº§æ˜¯åœ¨ Slave é…ç½®ä¸­è®¾ç½®çš„ï¼› â­å“¨å…µ Leader ä¼šä¼˜å…ˆé€‰æ‹© offset æœ€å¤§çš„ Slaveï¼Œå› ä¸ºå®ƒè¡¨ç¤ºæ•°æ®æœ€å®Œæ•´ã€‚ å¦‚æœæœ‰å¤šä¸ªä»èŠ‚ç‚¹å¤åˆ¶åç§»é‡ç›¸åŒï¼ŒID å·å°çš„ä»èŠ‚ç‚¹èƒœå‡ºã€‚ é—®ï¼šå“¨å…µLeaderèŠ‚ç‚¹è¿›è¡Œ ä¸»ä»æ•…éšœè½¬ç§»æ“ä½œ çš„è¿‡ç¨‹ï¼Ÿâ­ æŒ‘é€‰å‡º Masterï¼› **å¹¿æ’­é€šçŸ¥æ‰€æœ‰ Slave **ä¸æ–°çš„ Master è¿›è¡ŒåŒæ­¥ï¼› å°†æ–°çš„ Master é€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼› ç»§ç»­ç›‘è§†æ—§çš„ Master ï¼Œå½“å®ƒé‡æ–°ä¸Šçº¿æ—¶ï¼Œå“¨å…µé›†ç¾¤å°±ä¼šå‘å®ƒå‘é€ SLAVEOF å‘½ä»¤ï¼Œè®©å®ƒæˆä¸ºæ–°çš„ Master çš„ Slaveã€‚ é—®ï¼šå“¨å…µé›†ç¾¤æ˜¯æ€ä¹ˆç»„æˆçš„ï¼Ÿ å“¨å…µèŠ‚ç‚¹ä¹‹é—´æ˜¯é€šè¿‡ Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶æ¥ç›¸äº’å‘ç°çš„ã€‚ åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ªåä¸º__sentinel__:helloçš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚ åœ¨ä¸‹å›¾ä¸­ï¼Œå“¨å…µ A æŠŠè‡ªå·±çš„ IP åœ°å€å’Œç«¯å£çš„ä¿¡æ¯å‘å¸ƒåˆ°__sentinel__:hello é¢‘é“ä¸Šï¼Œå“¨å…µ B å’Œ C è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ B å’Œ C å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ A çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ Bã€C å¯ä»¥å’Œå“¨å…µ A å»ºç«‹ç½‘ç»œè¿æ¥ã€‚ é—®ï¼šé›†ç¾¤è„‘è£‚ï¼Ÿ ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ ç”±äºç½‘ç»œé—®é¢˜ï¼Œå“¨å…µå’Œä»èŠ‚ç‚¹éƒ½ä¸ä¸»èŠ‚ç‚¹å¤±è”äº†ï¼Œä½†ä¸»èŠ‚ç‚¹ä¾ç„¶æ­£å¸¸è¿è¡Œï¼Œæ­¤æ—¶ç”±äºå“¨å…µä»¥ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œæ‰€ä»¥å°±ä¼šä»ä»èŠ‚ç‚¹é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ­¤æ—¶å°±æœ‰ä¸¤ä¸ªä¸»èŠ‚ç‚¹ - ==è„‘è£‚ç°è±¡==ã€‚ ç”±äºæ­¤æ—¶æ—§ä¸»èŠ‚ç‚¹ä¾ç„¶å’Œå®¢æˆ·ç«¯èƒ½æ­£å¸¸é€šä¿¡ï¼Œå®¢æˆ·ç«¯å‘æ—§ä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ï¼Œç„¶åç½‘ç»œåˆå¥½äº†ï¼æ­¤æ—¶æ—§ä¸»èŠ‚ç‚¹å‘ç°å·²ç»æœ‰æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå°±ä¼šå˜ä¸ºä»èŠ‚ç‚¹ï¼Œæ¸…æ¥šè‡ªèº«æ‰€æœ‰æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡åŒæ­¥ï¼Œæ˜¾ç„¶è¿™æ ·ä¼šå¯¼è‡´ä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚ **æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼š**ç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚ å’‹è§£å†³å‘¢ï¼Ÿ å½“ä¸»èŠ‚ç‚¹å‘ç° $ä»èŠ‚ç‚¹æ€»æ•°é‡ - ä»èŠ‚ç‚¹ä¸‹çº¿æˆ–è€…é€šä¿¡è¶…æ—¶çš„æ•°é‡ \u003c é˜ˆå€¼$ æ—¶ï¼Œé‚£ä¹ˆç¦æ­¢ä¸»èŠ‚ç‚¹è¿›è¡Œå†™æ•°æ®æ“ä½œï¼Œç›´æ¥æŠŠé”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ç­‰åˆ°æ–°ä¸»èŠ‚ç‚¹ä¸Šçº¿æ—¶ï¼Œå°±åªæœ‰æ–°ä¸»èŠ‚ç‚¹èƒ½æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ­¤æ—¶ï¼Œæ–°å†™çš„æ•°æ®ä¼šè¢«ç›´æ¥å†™åˆ°æ–°ä¸»èŠ‚ç‚¹ä¸­ã€‚è€ŒåŸä¸»èŠ‚ç‚¹ä¼šè¢«å“¨å…µé™ä¸ºä»èŠ‚ç‚¹ï¼Œå³ä½¿å®ƒçš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œä¹Ÿä¸ä¼šæœ‰æ–°æ•°æ®ä¸¢å¤±ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:9:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"8.3 åˆ†ç‰‡é›†ç¾¤ é—®ï¼šåˆ†ç‰‡é›†ç¾¤æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ é›†ç¾¤æ¨¡å¼æ˜¯å°†å¤šä¸ª Redis èŠ‚ç‚¹ç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¹¶é€šè¿‡**æ§½ï¼ˆslotï¼‰**æ¥æ˜ å°„æ•°æ®åˆ†ç‰‡ã€‚é›†ç¾¤æ¨¡å¼æ”¯æŒå¤šä¸ªä¸»èŠ‚ç‚¹å’Œå¤šä¸ªä»èŠ‚ç‚¹ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹ä½œä¸ºå¤‡ä»½ã€‚é›†ç¾¤æ¨¡å¼å¯ä»¥å®ç°æ•°æ®çš„åˆ†å¸ƒå¼å­˜å‚¨ã€è¯»å†™åˆ†ç¦»ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ç­‰åŠŸèƒ½ï¼Œæé«˜äº†æœåŠ¡å¯æ‰©å±•æ€§å’Œç¨³å®šæ€§ï¼Œä½†æ˜¯ä¹Ÿå¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬ã€‚ ==æ•£åˆ—æ’æ§½== Redis å…±æœ‰ 16384 ä¸ªå“ˆå¸Œæ§½(hash slot)ï¼Œå°†æ¯ä¸ª key é€šè¿‡å“ˆå¸Œå‡½æ•° crc16() å°† key è½¬åŒ–æˆä¸€ä¸ªé•¿æ•´å‹æ•°å­—ï¼Œå†å¯¹ 16384 å–ä½™ï¼Œæœ€ç»ˆå†³å®šè¿™ä¸ª key å­˜å‚¨çš„å“ˆå¸Œæ§½ã€‚ä¹Ÿå°±æ˜¯ä¼šæŠŠæ¯ä¸ª key æ˜ å°„åˆ°0-16383ä¸ªæ’æ§½ä¸Šï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ’æ§½(å³ä¸€éƒ¨åˆ†é”®å€¼å¯¹)ã€‚ ==å®ç°æ–¹å¼== å®¢æˆ·ç«¯åˆ†ç‰‡ å®¢æˆ·ç«¯è‡ªå·±è®¡ç®—keyéœ€è¦æ˜ å°„åˆ°å“ªä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚ ä¼˜ç‚¹ï¼šé™ä½äº†é›†ç¾¤çš„å¤æ‚åº¦ ç¼ºç‚¹ï¼šå½“æ–°å¢Rediså®ä¾‹æ—¶éœ€è¦æ”¯æŒåŠ¨æ€åˆ†ç‰‡ æœåŠ¡ç«¯åˆ†ç‰‡â­ å®¢æˆ·ç«¯è®¿é—®æŸä¸ªkeyæ—¶ï¼ŒæœåŠ¡å™¨è®¡ç®—keyåº”è¯¥æ˜ å°„åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œè‹¥ä¸æ˜¯å½“å‰èŠ‚ç‚¹ï¼Œå°±ä¼šé‡å®šå‘åˆ°æŒ‡å®šèŠ‚ç‚¹ã€‚ ä»£ç†åˆ†ç‰‡ å®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€åˆ°ä»£ç†ï¼Œä»£ç†è®¡ç®—å¾—åˆ°éœ€è¦æ˜ å°„çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œç„¶åå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘åˆ°å¯¹åº”èŠ‚ç‚¹ä¸Šï¼Œç„¶åè¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚ ==åˆ†ç‰‡æœºåˆ¶çš„ç¼ºç‚¹== åˆ†ç‰‡æ˜¯ç”±å¤šå°Rediså®ä¾‹å…±åŒè¿è½¬ï¼Œæ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªRediså®ä¾‹å®•æœºï¼Œåˆ™æ•´ä¸ªåˆ†ç‰‡éƒ½å°†æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥åˆ†ç‰‡æœºåˆ¶æ— æ³•å®ç°é«˜å¯ç”¨ã€‚ å¦‚æœæœ‰ä¸åŒçš„keyæ˜ å°„åˆ°ä¸åŒçš„Rediså®ä¾‹ï¼Œè¿™æ—¶å€™ä¸èƒ½å¯¹è¿™ä¸¤ä¸ªkeyåšäº¤é›†æˆ–è€…ä½¿ç”¨äº‹åŠ¡ã€‚ ä½¿ç”¨åˆ†ç‰‡æœºåˆ¶å› ä¸ºæ¶‰åŠå¤šå®ä¾‹ï¼Œæ•°æ®å¤„ç†æ¯”è¾ƒå¤æ‚ã€‚ åˆ†ç‰‡ä¸­å¯¹äºå®ä¾‹çš„æ·»åŠ æˆ–åˆ é™¤ä¼šå¾ˆå¤æ‚ï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨é¢„åˆ†ç‰‡æŠ€æœ¯è¿›è¡Œæ”¹å–„ã€‚ é—®ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ‰‹åŠ¨æ•…éšœè½¬ç§»ï¼Ÿ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼š é¦–å…ˆæ˜¯ Master ä¸å…¶ä»–èŠ‚ç‚¹å¤±å»è¿æ¥ï¼› å…¶ä»–èŠ‚ç‚¹æ ‡è®° Master ä¸ºç–‘ä¼¼å®•æœºï¼› Master ç¡®å®šå®•æœºï¼Œè‡ªåŠ¨æå‡ä¸€ä¸ª Slave ä¸º Masterã€‚ æ‰‹åŠ¨æ•…éšœè½¬ç§»ï¼šåˆ©ç”¨ cluster failover å‘½ä»¤å¯ä»¥æ‰‹åŠ¨è®©é›†ç¾¤ä¸­æŸä¸ª Master å®•æœºï¼Œåˆ‡æ¢åˆ°æ‰§è¡Œ cluster failover å‘½ä»¤çš„è¿™ä¸ª Slave èŠ‚ç‚¹ï¼Œå®ç°æ— æ„ŸçŸ¥çš„æ•°æ®è¿ç§»ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:9:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"ä¹ã€å¤šçº§ç¼“å­˜(æœª) å¤šçº§ç¼“å­˜å°±æ˜¯åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½» TomCat çš„å‹åŠ›ã€‚ ","date":"2023-04-21","objectID":"/07-redis/:10:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"åã€Redis å®æˆ˜(æœª) ","date":"2023-04-21","objectID":"/07-redis/:11:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"10.1 å¦‚ä½•ä¸ºç§’æ€ç³»ç»Ÿè®¾è®¡ç¼“å­˜ä½“ç³» ","date":"2023-04-21","objectID":"/07-redis/:11:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"Redis","uri":"/07-redis/"},{"categories":["é¢è¯•"],"content":"å¸¸è§é¢è¯•é¢˜ ç”¨äºè‡ªæµ‹ï¼Œç‚¹å‡» G å³å¯è·³è½¬åˆ°ç›¸åº”ç­”æ¡ˆ~~ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL ç´¢å¼•(â­â­å¿…é—®) ç´¢å¼•çš„ç±»å‹æœ‰å“ªäº›ï¼ŸG ç´¢å¼•çš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼ŸG B+æ ‘å’ŒB-æ ‘çš„åŒºåˆ«ï¼ŸG B+æ ‘å’ŒHashçš„åŒºåˆ«ï¼ŸG ç´¢å¼•åˆ›å»ºåŸåˆ™ï¼ŸG ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•å¤±æ•ˆï¼ŸG èšé›†ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿé€‰å–è§„åˆ™æ˜¯ä»€ä¹ˆï¼ŸG å‰ç¼€ç´¢å¼•ï¼ŸG uuid å’Œ è‡ªå¢idï¼Œåšç´¢å¼•æœ‰å•¥åŒºåˆ«ï¼ŸG ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢ï¼ŸGâ­ğŸš© è”åˆç´¢å¼•åº”ç”¨åœºæ™¯ï¼Ÿä¸ºä»€ä¹ˆè¦å»ºè”åˆç´¢å¼•ï¼ŸGâ­ğŸš© ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL äº‹åŠ¡(â­â­å¿…é—®) äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŸG å¯é‡å¤è¯»ä¸‹ï¼Œå¦‚ä½•é¿å…å¹»è¯»ï¼ŸG MVCC çš„å®ç°åŸç†ï¼ŸG å„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå¯é‡å¤è¯»ï¼šGï¼›è¯»å·²æäº¤ï¼šG äº‹åŠ¡å®ç°åŸç†ï¼ŸACID æ˜¯æ€ä¹ˆä¿è¯çš„ï¼Ÿæœª ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL é”(â­â­å¿…é—®) è¡Œçº§é”ï¼Œè¡¨çº§é”ï¼›æ’å®ƒé”ï¼Œå…±äº«é”ï¼›è®°å½•é”ã€é—´éš™é”ï¼Œä¸´é”®é”ï¼›ä¸¤é˜¶æ®µé”ï¼› æ­»é”çš„åŸå› ï¼ŸG å¦‚ä½•é¿å…æ­»é”ï¼ŸG ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL æ—¥å¿—(â­â­å¸¸é—®) undo log æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼ŸG redo log æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼ŸG undo log å’Œ redo log æœ‰å•¥åŒºåˆ«ï¼ŸG ä¸ºä»€ä¹ˆæœ‰ bin log äº†è¿˜è¦ redo logï¼Œä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ä»¥åŠä¸¤è€…ç”Ÿæˆçš„æ—¶æœºï¼ŸG æ‰§è¡Œ update çš„è¿‡ç¨‹ï¼Ÿâ­G äº‹åŠ¡æäº¤è¿‡ç¨‹ï¼šä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤ï¼ŸG ä¸ºå•¥è¦ä¸¤é˜¶æ®µæäº¤ï¼ŸG ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:4","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL æ¶æ„(â­å¸¸é—®) ä¸»ä»å¤åˆ¶æ˜¯å’‹å®ç°çš„ï¼ŸG ä»åº“æ˜¯è¶Šå¤šè¶Šå¥½å—ï¼ŸG ä¸»ä»å¤åˆ¶æœ‰å“ªäº›æ¨¡å‹ï¼Ÿ/å¦‚ä½•ä¿æŒä¸»ä»é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼ŸG åˆ†åº“ã€åˆ†è¡¨çš„æ–¹å¼æœ‰å“ªäº›ï¼ŸG æ°´å¹³åˆ†ç‰‡æœ‰å“ªäº›è§„åˆ™ï¼ŸG ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:5","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"MySQL æ•°æ®ç±»å‹ MySQLæœ‰å“ªäº›æ•°æ®ç±»å‹ï¼Ÿ varchar ä¸ char çš„åŒºåˆ«ï¼Ÿint å’Œ int (11) åŒºåˆ«ï¼Ÿtinyint ä¸ int åŒºåˆ«ï¼Ÿ MySQL çš„ NULL å€¼æ˜¯æ€ä¹ˆå­˜æ”¾çš„ï¼Ÿä¼šå ç”¨ç©ºé—´å—ï¼Ÿ MySQL æ€ä¹ˆçŸ¥é“ varchar(n) å®é™…å ç”¨æ•°æ®çš„å¤§å°ï¼Ÿ varchar(n) ä¸­ n æœ€å¤§å–å€¼ä¸ºå¤šå°‘ï¼Ÿ è¡Œæº¢å‡ºåï¼ŒMySQL æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:6","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"é¢è¯•é—®çš„ æ‰§è¡ŒMySQLè¯­å¥ç‰¹åˆ«æ…¢ï¼Œå¯èƒ½çš„åŸå› ï¼ŸG drop å’Œ delete æœ‰å•¥åŒºåˆ«ï¼ŸG count(1)ã€count(*)ã€count(å­—æ®µ)ï¼Œå“ªä¸ªæ•ˆç‡æœ€é«˜ï¼ŸGâ­ğŸš© ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:1:7","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€äº‹åŠ¡ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"1.1 æ¦‚å¿µåŠåŸç† é—®ï¼šä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ äº‹åŠ¡æ˜¯ä¸€ç»„æ“ä½œçš„é›†åˆï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å•ä½ï¼Œäº‹åŠ¡ä¸­åŒ…å«è‹¥å¹²æ“ä½œï¼Œè¿™äº›æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚ # å¼€å¯ä¸€ä¸ªäº‹åŠ¡ START TRANSACTION; # å¤šæ¡ SQL è¯­å¥ SQL1,SQL2... # æäº¤äº‹åŠ¡ COMMIT; é—®ï¼šäº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ŸACID æ˜¯ä»€ä¹ˆï¼Ÿ åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼› ä¸€è‡´æ€§â­ï¼ˆConsistencyï¼‰ï¼šæ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ã€‚ä¾‹å¦‚è½¬è´¦ä¸šåŠ¡ä¸­ï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œè½¬è´¦è€…å’Œæ”¶æ¬¾äººçš„æ€»é¢åº”è¯¥æ˜¯ä¸å˜çš„ï¼› éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼› æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ æ³¨ï¼šåªæœ‰ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚ä¹Ÿå°±æ˜¯è¯´ Aã€Iã€D æ˜¯æ‰‹æ®µï¼ŒC æ˜¯ç›®çš„ï¼ é—®ï¼šMySQLä¸­ï¼Œå„æœ‰ä»€ä¹ˆæœºåˆ¶ä¿è¯ä»¥ä¸Šå››ä¸ªå±æ€§ï¼Ÿ åŸå­æ€§ã€ä¸€è‡´æ€§ã€æŒä¹…æ€§ï¼šredo logã€undo logï¼› éš”ç¦»æ€§ï¼šé”ã€MVCCã€‚ é—®ï¼šæŒä¹…æ€§æ˜¯æ€ä¹ˆä¿è¯çš„ï¼Ÿ redo logã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:2:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"1.2 å¹¶å‘äº‹åŠ¡ Aã€BåŒæ—¶å¯¹æ•°æ®åº“è¿›è¡Œäº‹åŠ¡æ“ä½œæ—¶ï¼Œä¼šå‘ç”Ÿçš„é—®é¢˜ã€‚ é—®ï¼šå¹¶å‘äº‹åŠ¡ä¼šå¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» ä¸¢å¤±ä¿®æ”¹ â€¦ è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡è¿˜æœªcommitçš„æ•°æ®ï¼› ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­å…ˆåè¯»å–åŒä¸€æ¡æ•°æ®ï¼ŒæœŸé—´å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¯¥æ•°æ®ï¼Œé€ æˆç¬¬ä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚å³ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€è‡´ï¼› å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢æŸæ¡æ•°æ®æ—¶ï¼Œå‘ç°æ²¡æœ‰å¯¹åº”è¡Œï¼Œä½†ä¹‹åå¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†è¯¥æ¡æ•°æ®ï¼Œå½“ç¬¬ä¸€ä¸ªäº‹åŠ¡å‡†å¤‡æ’å…¥è¯¥æ¡æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²å­˜åœ¨ã€‚å³ï¼Œå‰åè¯»å–çš„è®°å½•æ•°é‡ä¸ä¸€è‡´ï¼Œå°±åƒå‡ºç°äº†å¹»è§‰ä¸€æ ·ï¼› ä¸¢å¤±ä¿®æ”¹ï¼šç¬¬ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†æŸæ¡æ•°æ®ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡éšååˆä¿®æ”¹äº†æŸæ¡æ•°æ®ï¼Œé€ æˆç¬¬ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ç»“æœä¸¢å¤±ã€‚ é—®ï¼šä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«ï¼Ÿ ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯å†…å®¹ä¿®æ”¹æˆ–è€…è®°å½•å‡å°‘æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°å…¶ä¸­æŸäº›è®°å½•çš„å€¼è¢«ä¿®æ”¹ï¼› å¹»è¯»çš„é‡ç‚¹åœ¨äºè®°å½•æ–°å¢æ¯”å¦‚å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼ˆDQLï¼‰æ—¶ï¼Œå‘ç°æŸ¥åˆ°çš„è®°å½•å¢åŠ äº†ã€‚ å¹»è¯»å…¶å®å¯ä»¥çœ‹ä½œæ˜¯ä¸å¯é‡å¤è¯»çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå•ç‹¬æŠŠåŒºåˆ†å¹»è¯»çš„åŸå› ä¸»è¦æ˜¯è§£å†³å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„æ–¹æ¡ˆä¸ä¸€æ ·ã€‚ **ä¸¾ä¸ªä¾‹å­ï¼š**æ‰§è¡Œ delete å’Œ update æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å¯¹è®°å½•åŠ é”ï¼Œä¿è¯äº‹åŠ¡å®‰å…¨ã€‚è€Œæ‰§è¡Œ insert æ“ä½œçš„æ—¶å€™ï¼Œç”±äºè®°å½•é”ï¼ˆRecord Lockï¼‰åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è®°å½•ï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è®°å½•ï¼Œéœ€è¦ä¾èµ–é—´éš™é”ï¼ˆGap Lockï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œ insert æ“ä½œçš„æ—¶å€™éœ€è¦ä¾èµ– Next-Key Lockï¼ˆRecord Lock+Gap Lockï¼‰ è¿›è¡ŒåŠ é”æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚ é—®ï¼šå¹¶å‘äº‹åŠ¡çš„æ§åˆ¶æ–¹å¼æœ‰å“ªäº›ï¼Ÿ MySQL ä¸­å¹¶å‘äº‹åŠ¡çš„æ§åˆ¶æ–¹å¼æ— éå°±ä¸¤ç§ï¼šé” å’Œ MVCCã€‚é”å¯ä»¥çœ‹ä½œæ˜¯æ‚²è§‚æ§åˆ¶çš„æ¨¡å¼ï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiversion concurrency controlï¼‰å¯ä»¥çœ‹ä½œæ˜¯ä¹è§‚æ§åˆ¶çš„æ¨¡å¼ã€‚ é” æ§åˆ¶æ–¹å¼ä¸‹ä¼šé€šè¿‡é”æ¥æ˜¾ç¤ºæ§åˆ¶å…±äº«èµ„æºè€Œä¸æ˜¯é€šè¿‡è°ƒåº¦æ‰‹æ®µï¼ŒMySQL ä¸­ä¸»è¦æ˜¯é€šè¿‡ è¯»å†™é” æ¥å®ç°å¹¶å‘æ§åˆ¶ã€‚ å…±äº«é”ï¼ˆS é”ï¼‰ï¼šåˆç§°è¯»é”ï¼Œäº‹åŠ¡åœ¨è¯»å–è®°å½•çš„æ—¶å€™è·å–å…±äº«é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ï¼ˆé”å…¼å®¹ï¼‰ã€‚ æ’ä»–é”ï¼ˆX é”ï¼‰ï¼šåˆç§°å†™é”/ç‹¬å é”ï¼Œäº‹åŠ¡åœ¨ä¿®æ”¹è®°å½•çš„æ—¶å€™è·å–æ’ä»–é”ï¼Œä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ã€‚å¦‚æœä¸€ä¸ªè®°å½•å·²ç»è¢«åŠ äº†æ’ä»–é”ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¸èƒ½å†å¯¹è¿™æ¡äº‹åŠ¡åŠ ä»»ä½•ç±»å‹çš„é”ï¼ˆé”ä¸å…¼å®¹ï¼‰ã€‚ è¯»å†™é”å¯ä»¥åšåˆ°è¯»è¯»å¹¶è¡Œï¼Œä½†æ˜¯æ— æ³•åšåˆ°å†™è¯»ã€å†™å†™å¹¶è¡Œã€‚å¦å¤–ï¼Œæ ¹æ®æ ¹æ®é”ç²’åº¦çš„ä¸åŒï¼Œåˆè¢«åˆ†ä¸º è¡¨çº§é”ï¼ˆtable-level lockingï¼‰ å’Œ è¡Œçº§é”ï¼ˆrow-level lockingï¼‰ ã€‚InnoDB ä¸å…‰æ”¯æŒè¡¨çº§é”ï¼Œè¿˜æ”¯æŒè¡Œçº§é”ï¼Œé»˜è®¤ä¸ºè¡Œçº§é”ã€‚è¡Œçº§é”çš„ç²’åº¦æ›´å°ï¼Œä»…å¯¹ç›¸å…³çš„è®°å½•ä¸Šé”å³å¯ï¼ˆå¯¹ä¸€è¡Œæˆ–è€…å¤šè¡Œè®°å½•åŠ é”ï¼‰ï¼Œæ‰€ä»¥å¯¹äºå¹¶å‘å†™å…¥æ“ä½œæ¥è¯´ï¼ŒInnoDB çš„æ€§èƒ½æ›´é«˜ã€‚ä¸è®ºæ˜¯è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é”ï¼Œéƒ½å­˜åœ¨å…±äº«é”ï¼ˆShare Lockï¼ŒS é”ï¼‰å’Œæ’ä»–é”ï¼ˆExclusive Lockï¼ŒX é”ï¼‰è¿™ä¸¤ç±»ã€‚ MVCC æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œå³å¯¹ä¸€ä»½æ•°æ®ä¼šå­˜å‚¨å¤šä¸ªç‰ˆæœ¬ï¼Œé€šè¿‡äº‹åŠ¡çš„å¯è§æ€§æ¥ä¿è¯äº‹åŠ¡èƒ½çœ‹åˆ°è‡ªå·±åº”è¯¥çœ‹åˆ°çš„ç‰ˆæœ¬ã€‚é€šå¸¸ä¼šæœ‰ä¸€ä¸ªå…¨å±€çš„ç‰ˆæœ¬åˆ†é…å™¨æ¥ä¸ºæ¯ä¸€è¡Œæ•°æ®è®¾ç½®ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·æ˜¯å”¯ä¸€çš„ã€‚ MVCC åœ¨ MySQL ä¸­å®ç°æ‰€ä¾èµ–çš„æ‰‹æ®µä¸»è¦æ˜¯ï¼šéšè—å­—æ®µã€read viewã€undo logã€‚ undo logï¼šundo log ç”¨äºè®°å½•æŸè¡Œæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®ã€‚ read view å’Œ éšè—å­—æ®µï¼šç”¨æ¥åˆ¤æ–­å½“å‰ç‰ˆæœ¬æ•°æ®çš„å¯è§æ€§ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:2:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"1.3 äº‹åŠ¡éš”ç¦»çº§åˆ« é—®ï¼šéƒ½æœ‰å“ªäº›äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿ SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š READ-UNCOMMITTED(è¯»å–æœªæäº¤)ï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ã€‚å¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚ READ-COMMITTED(è¯»å–å·²æäº¤)ï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ã€‚å¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ REPEATABLE-READ(å¯é‡å¤è¯»)ï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ã€‚å¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚MySQL InnoDB å¼•æ“çš„==é»˜è®¤éš”ç¦»çº§åˆ«==ï¼› SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ-UNCOMMITTED âˆš âˆš âˆš READ-COMMITTED Ã— âˆš âˆš REPEATABLE-READ Ã— Ã— âˆš SERIALIZABLE Ã— Ã— Ã— é—®ï¼šå¯é‡å¤è¯»ä¸‹ï¼Œå¦‚ä½•é¿å…å¹»è¯»ï¼Ÿ é¦–å…ˆè¦æ˜ç¡®ï¼Œä½¿ç”¨ã€Œä¸²è¡ŒåŒ–ã€éš”ç¦»çº§åˆ«æ‰èƒ½å½»åº•è§£å†³å¹»è¯»ç°è±¡ï¼Œ**==å¯é‡å¤è¯»==åªèƒ½åœ¨==å¾ˆå¤§ç¨‹åº¦ä¸Š==**é¿å…å¹»è¯»(å¹¶ä¸æ˜¯å®Œå…¨è§£å†³äº†ï¼Œè¯¦è§è¿™ç¯‡æ–‡ç« )ã€‚ å¯é‡å¤è¯»çš„è§£å†³æ–¹æ¡ˆåˆ†ä¸ºä¸¤æ–¹é¢ï¼š é’ˆå¯¹å¿«ç…§è¯»ï¼ˆæ™®é€š select è¯­å¥ï¼‰ï¼Œæ˜¯é€šè¿‡ MVCC æ–¹å¼è§£å†³äº†å¹»è¯»ã€‚å› ä¸ºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œä¸€ç›´è·Ÿè¿™ä¸ªäº‹åŠ¡å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œå³ä½¿ä¸­é€”æœ‰å…¶ä»–äº‹åŠ¡æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œæ˜¯æŸ¥è¯¢ä¸å‡ºæ¥è¿™æ¡æ•°æ®çš„ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜ã€‚ é’ˆå¯¹å½“å‰è¯»ï¼ˆselect â€¦ for update ç­‰è¯­å¥ï¼‰ï¼Œæ˜¯é€šè¿‡ next-key lockï¼ˆè®°å½•é”+é—´éš™é”ï¼‰æ–¹å¼è§£å†³äº†å¹»è¯»ã€‚å› ä¸ºå½“æ‰§è¡Œ select â€¦ for update è¯­å¥çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Š next-key lockï¼Œå¦‚æœæœ‰å…¶ä»–äº‹åŠ¡åœ¨ next-key lock é”èŒƒå›´å†…æ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’å…¥è¯­å¥å°±ä¼šè¢«é˜»å¡ï¼Œæ— æ³•æˆåŠŸæ’å…¥ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜ã€‚ ä»¥ä¸‹è¯´æ˜ï¼šä¸ºå•¥å¯é‡å¤è¯»æ²¡å®Œå…¨è§£å†³å¹»è¯»ï¼Ÿ ç¤ºä¾‹åœºæ™¯1ï¼š äº‹åŠ¡ A æ‰§è¡ŒæŸ¥è¯¢ id = 5 çš„è®°å½•ï¼Œæ­¤æ—¶è¡¨ä¸­æ˜¯æ²¡æœ‰è¯¥è®°å½•çš„ï¼Œæ‰€ä»¥æŸ¥è¯¢ä¸å‡ºæ¥ã€‚æ³¨æ„ï¼Œæ­¤æ—¶å¹¶æœªæäº¤äº‹åŠ¡ï¼ # äº‹åŠ¡ A mysql\u003e begin; Query OK, 0 rows affected (0.00 sec) mysql\u003e select * from t_stu where id = 5; Empty set (0.01 sec) ç„¶åäº‹åŠ¡ B æ’å…¥ä¸€æ¡ id = 5 çš„è®°å½•ï¼Œå¹¶ä¸”æäº¤äº†äº‹åŠ¡ã€‚ # äº‹åŠ¡ B mysql\u003e begin; Query OK, 0 rows affected (0.00 sec) mysql\u003e insert into t_stu values(5, 'å°ç¾', 18); Query OK, 1 row affected (0.00 sec) mysql\u003e commit; Query OK, 0 rows affected (0.00 sec) æ­¤æ—¶ï¼Œäº‹åŠ¡ A æ›´æ–° id = 5 è¿™æ¡è®°å½•ï¼› # äº‹åŠ¡ A mysql\u003e update t_stu set name = 'å°æ—coding' where id = 5; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u003e select * from t_stu where id = 5; +----+--------------+------+ | id | name | age | +----+--------------+------+ | 5 | å°æ—coding | 18 | +----+--------------+------+ 1 row in set (0.00 sec) ç„¶åå†æ¬¡æŸ¥è¯¢ id = 5 çš„è®°å½•ï¼Œäº‹åŠ¡ A å°±èƒ½çœ‹åˆ°äº‹åŠ¡ B æ’å…¥çš„è®°å½•äº†ï¼Œä¸”è¢«è‡ªå·±æ›´æ–°è¿‡ã€‚è¿™å°±äº§ç”Ÿäº†å¹»è¯»ã€‚ æ•´ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾ï¼š äº‹åŠ¡ A å¼€å§‹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª Read Viewï¼› ç„¶åï¼Œäº‹åŠ¡ B æ–°æ’å…¥äº†ä¸€æ¡è®°å½•ï¼› æ¥ç€ï¼Œäº‹åŠ¡ A é€šè¿‡ update æ“ä½œå¯¹è¯¥è®°å½•è¿›è¡Œæ›´æ–°ï¼Œæ­¤æ—¶è¿™æ¡æ–°è®°å½•çš„**trx_idå°±å˜æˆäº†äº‹åŠ¡ A çš„äº‹åŠ¡ id**ï¼› ä¹‹åäº‹åŠ¡ A å†ä½¿ç”¨æ™®é€š select è¯­å¥å»æŸ¥è¯¢è¿™æ¡è®°å½•æ—¶å°±å¯ä»¥çœ‹åˆ°è¿™æ¡è®°å½•äº†ï¼Œäºæ˜¯å°±å‘ç”Ÿäº†å¹»è¯»ã€‚ ç¤ºä¾‹åœºæ™¯2ï¼š T1 æ—¶åˆ»ï¼šäº‹åŠ¡ A å…ˆæ‰§è¡Œã€Œå¿«ç…§è¯»è¯­å¥ã€ï¼šselect * from t_test where id \u003e 100 å¾—åˆ°äº† 3 æ¡è®°å½•ã€‚ T2 æ—¶åˆ»ï¼šäº‹åŠ¡ B å¾€æ’å…¥ä¸€ä¸ª id= 200 çš„è®°å½•å¹¶æäº¤ï¼› T3 æ—¶åˆ»ï¼šäº‹åŠ¡ A å†æ‰§è¡Œã€Œå½“å‰è¯»è¯­å¥ã€ select * from t_test where id \u003e 100 for update å°±ä¼šå¾—åˆ° 4 æ¡è®°å½•ï¼Œæ­¤æ—¶ä¹Ÿå‘ç”Ÿäº†å¹»è¯»ç°è±¡ã€‚ åœºæ™¯2å¯ä»¥é€šè¿‡åœ¨å¼€å¯äº‹åŠ¡ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œ select â€¦ for update è¿™ç±»å½“å‰è¯»çš„è¯­å¥æ¥é¿å…ï¼Œå› ä¸ºå®ƒä¼šå¯¹è®°å½•åŠ  next-key lockï¼Œä»è€Œé¿å…å…¶ä»–äº‹åŠ¡æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚ é—®ï¼šå¯é‡å¤è¯»çš„å®ç°åŸç†ï¼Ÿâ­ å¯é‡å¤è¯»éš”ç¦»çº§åˆ«æ˜¯==å¯åŠ¨äº‹åŠ¡æ—¶==ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewã€‚ ä¾‹ï¼Œå‡è®¾äº‹åŠ¡ A ï¼ˆäº‹åŠ¡ id ä¸º51ï¼‰å¯åŠ¨åï¼Œç´§æ¥ç€äº‹åŠ¡ B ï¼ˆäº‹åŠ¡ id ä¸º52ï¼‰ä¹Ÿå¯åŠ¨äº†ï¼Œé‚£è¿™ä¸¤ä¸ªäº‹åŠ¡åˆ›å»ºçš„ Read View å¦‚ä¸‹ï¼š æ¥ç€ï¼Œåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ A å’Œäº‹åŠ¡ B æŒ‰é¡ºåºæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š äº‹åŠ¡ B è¯»å–å°æ—çš„è´¦æˆ·ä½™é¢è®°å½•ï¼Œè¯»åˆ°ä½™é¢æ˜¯ 100 ä¸‡ï¼› äº‹åŠ¡ A å°†å°æ—çš„è´¦æˆ·ä½™é¢è®°å½•ä¿®æ”¹æˆ 200 ä¸‡ï¼Œå¹¶æ²¡æœ‰æäº¤äº‹åŠ¡ï¼› äº‹åŠ¡ B è¯»å–å°æ—çš„è´¦æˆ·ä½™é¢è®°å½•ï¼Œè¯»åˆ°ä½™é¢è¿˜æ˜¯ 100 ä¸‡ï¼› äº‹åŠ¡ A æäº¤äº‹åŠ¡ï¼› äº‹åŠ¡ B è¯»å–å°æ—çš„è´¦æˆ·ä½™é¢è®°å½•ï¼Œè¯»åˆ°ä½™é¢ä¾ç„¶è¿˜æ˜¯ 100 ä¸‡ï¼› å…·ä½“åˆ†æä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š äº‹åŠ¡ B ç¬¬ä¸€æ¬¡è¯»å–æ—¶ï¼Œå‘ç°è¯¥è®°å½•çš„trx_id \u003c äº‹åŠ¡ B çš„ Read View ä¸­çš„min_trx_idï¼Œæ‰€ä»¥è¯¥è®°å½•çš„è¯¥ç‰ˆæœ¬å¯è§ï¼› æ¥ç€ï¼Œäº‹åŠ¡ A ä¿®æ”¹è¯¥è®°å½•(ä½†è¿˜æ²¡æäº¤äº‹åŠ¡)ï¼Œæ­¤æ—¶ MySQL ä¼šè®°å½• undo logï¼Œä»¥é“¾è¡¨æ–¹å¼ä¸²è”èµ·æ¥ï¼Œå½¢æˆç‰ˆæœ¬é“¾ï¼› ç„¶åï¼Œäº‹åŠ¡ B ç¬¬äºŒæ¬¡è¯»å–ï¼Œå‘ç°è¯¥è®°å½•çš„trx_id åœ¨min_trx_idå’Œmax_trx_idä¹‹é—´ï¼Œä¸”åœ¨m_idsä¸­å­˜åœ¨è¯¥è®°å½•çš„trx_idï¼Œè¯´æ˜è¯¥è®°å½•æ˜¯è¢«è¿˜æœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹çš„ï¼Œå› æ­¤è¯¥ç‰ˆæœ¬ä¸å¯è§ï¼Œå°±ä¼šé¡ºç€ undo log é“¾å‘æ—§ç‰ˆæœ¬å¯»æ‰¾ï¼Œç›´åˆ°æŸä¸ªç‰ˆæœ¬çš„trx_id \u003c min_trx_id æˆ– trx_id \u003e min_trx_id ä¸”ä¸å­˜åœ¨m_idsä¸­ã€‚æ­¤å¤„è¡¨ç°ä¸ºè¯»åˆ°äº†æ—§æ•°æ®ï¼› æ¥ç€ï¼Œäº‹åŠ¡ A æäº¤è¯¥äº‹åŠ¡ï¼› ä½†ç”±äº**ã€Œå¯é‡å¤è¯»ã€ï¼Œäº‹åŠ¡ B ç¬¬ä¸‰æ¬¡è¯»å–è¯¥è®°å½•æ—¶ï¼Œè¿˜æ˜¯åŸºäºå¯åŠ¨äº‹åŠ¡æ—¶åˆ›å»ºçš„Read Viewæ¥åˆ¤æ–­å½“å‰ç‰ˆæœ¬**çš„è®°å½•æ˜¯å¦å¯è§ï¼Œå› æ­¤ä¾ç„¶åˆ¤å®šè¯¥è®°å½•ä¸ºæœªæäº¤ï¼Œå› æ­¤è¯»åˆ°çš„ä¾ç„¶æ˜¯æ—§æ•°æ®ã€‚ é—®ï¼šè¯»å·²æäº¤çš„å®ç°åŸç†ï¼Ÿ è¯»æäº¤éš”ç¦»çº§åˆ«æ˜¯åœ¨**==æ¯æ¬¡è¯»å–æ•°æ®æ—¶==ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Read View**ã€‚ è¿˜æ˜¯ä¹‹å‰é‚£ä¸ªä¾‹å­ï¼Œå‡è®¾äº‹åŠ¡ A ï¼ˆäº‹åŠ¡ id ä¸º51ï¼‰å¯åŠ¨åï¼Œç´§æ¥ç€äº‹åŠ¡ B ï¼ˆäº‹åŠ¡ id ä¸º52ï¼‰ä¹Ÿå¯åŠ¨äº†ï¼Œæ¥ç€æŒ‰é¡ºåºæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š äº‹åŠ¡ B è¯»å–æ•°æ®ï¼ˆåˆ›å»º Read Viewï¼‰ï¼Œå°æ—çš„è´¦æˆ·ä½™é¢ä¸º 100 ä¸‡ï¼› äº‹åŠ¡ A ä¿®æ”¹æ•°æ®ï¼ˆè¿˜æ²¡æäº¤äº‹åŠ¡ï¼‰ï¼Œå°†å°æ—çš„è´¦æˆ·ä½™é¢ä» 100 ä¸‡ä¿®æ”¹æˆäº† 200 ä¸‡ï¼› äº‹åŠ¡ B è¯»å–æ•°æ®ï¼ˆåˆ›å»º Read Viewï¼‰ï¼Œå°æ—çš„è´¦æˆ·ä½™é¢ä¸º 100 ä¸‡ï¼› äº‹åŠ¡ A æäº¤äº‹åŠ¡ï¼› äº‹åŠ¡ B è¯»å–æ•°æ®ï¼ˆåˆ›å»º Read Viewï¼‰ï¼Œå°æ—çš„è´¦æˆ·ä½™é¢ä¸º 200 ä¸‡ï¼› åŒºåˆ«å°±åœ¨äºäº‹åŠ¡ B ç¬¬ä¸‰æ¬¡è¯»å–æ•°æ®æ—¶ï¼Œä¼šæ–°å»º Read Viewï¼š æ³¨æ„ï¼Œæ­¤æ—¶m_idsä¸­åªæœ‰52äº†ï¼Œäº‹åŠ¡ B æŸ¥è¯¢è¯¥è®°å½•æ—¶ï¼Œtrx_id=51ï¼Œå°äºmin_trx_idï¼Œæ‰€ä»¥è¯¥è®°å½•çš„è¯¥ç‰ˆæœ¬å¯¹äº‹åŠ¡ B å¯è§ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:2:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"äºŒã€å­˜å‚¨å¼•æ“ 5.5.5 ç‰ˆæœ¬ä¹‹åï¼ŒInnoDB æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œä¸”æ‰€æœ‰çš„å­˜å‚¨å¼•æ“ä¸­åªæœ‰ InnoDB æ˜¯äº‹åŠ¡æ€§å­˜å‚¨å¼•æ“ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ InnoDB æ”¯æŒäº‹åŠ¡ã€‚ -- æŸ¥è¯¢å½“å‰æ•°æ®åº“æ”¯æŒçš„æ•°æ®åº“å¼•æ“ show engines; é—®ï¼šMySQLå­˜å‚¨å¼•æ“æ¶æ„ï¼Ÿ MySQL å­˜å‚¨å¼•æ“é‡‡ç”¨çš„æ˜¯ æ’ä»¶å¼æ¶æ„ ï¼Œæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä¸ºä¸åŒçš„æ•°æ®åº“è¡¨è®¾ç½®ä¸åŒçš„å­˜å‚¨å¼•æ“ä»¥é€‚åº”ä¸åŒåœºæ™¯çš„éœ€è¦ã€‚å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ã€‚ è¿˜å¯ä»¥æ ¹æ® MySQL å®šä¹‰çš„å­˜å‚¨å¼•æ“å®ç°æ ‡å‡†æ¥å£æ¥ç¼–å†™ä¸€ä¸ªå±äºè‡ªå·±çš„å­˜å‚¨å¼•æ“ã€‚(åƒç›®å‰æœ€å¸¸ç”¨çš„ InnoDB å…¶å®åˆšå¼€å§‹å°±æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å­˜å‚¨å¼•æ“ï¼Œåé¢ç”±äºè¿‡äºä¼˜ç§€ï¼Œå…¶è¢« Oracle ç›´æ¥æ”¶è´­äº†ã€‚) é—®ï¼šMyISAM å’Œ InnoDB æœ‰ä½•åŒºåˆ«ï¼Ÿ æ˜¯å¦æ”¯æŒè¡Œçº§é” MyISAM åªæœ‰è¡¨çº§é”(table-level locking)ï¼Œè€Œ InnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”,é»˜è®¤ä¸ºè¡Œçº§é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒMyISAM ä¸€é”å°±æ˜¯é”ä½äº†æ•´å¼ è¡¨ï¼Œå¹¶å‘æ—¶æ€§èƒ½è¿œä¸å¦‚ InnoDBã€‚ æ˜¯å¦æ”¯æŒäº‹åŠ¡ MyISAM ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚ InnoDB æä¾›äº‹åŠ¡æ”¯æŒï¼Œå®ç°äº† SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼Œå…·æœ‰æäº¤(commit)å’Œå›æ»š(rollback)äº‹åŠ¡çš„èƒ½åŠ›ã€‚å¹¶ä¸”ï¼ŒInnoDB é»˜è®¤ä½¿ç”¨çš„ REPEATABLE-READï¼ˆå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å‘ç”Ÿçš„ï¼ˆåŸºäº MVCC å’Œ Next-Key Lockï¼‰ã€‚ æ˜¯å¦æ”¯æŒå¤–é”® MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚ å¤–é”®å¯¹äºç»´æŠ¤æ•°æ®ä¸€è‡´æ€§éå¸¸æœ‰å¸®åŠ©ï¼Œä½†æ˜¯å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„æŸè€—ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯ä¸å»ºè®®åœ¨å®é™…ç”Ÿäº§é¡¹ç›®ä¸­ä½¿ç”¨å¤–é”®çš„ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­è¿›è¡Œçº¦æŸå³å¯ï¼ æ˜¯å¦æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„å®‰å…¨æ¢å¤ MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚ ä½¿ç”¨ InnoDB çš„æ•°æ®åº“åœ¨å¼‚å¸¸å´©æºƒåï¼Œæ•°æ®åº“é‡æ–°å¯åŠ¨çš„æ—¶å€™ä¼šä¿è¯æ•°æ®åº“æ¢å¤åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ä¾èµ–äº redo log ã€‚ æ˜¯å¦æ”¯æŒ MVCC MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚ MyISAM è¿è¡Œçº§é”éƒ½ä¸æ”¯æŒï¼Œè€Œ MVCC å¯ä»¥çœ‹ä½œæ˜¯è¡Œçº§é”çš„ä¸€ä¸ªå‡çº§ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘åŠ é”æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚ ç´¢å¼•çš„å®ç°ä¸åŒ äºŒè€…å‡é‡‡ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†æ˜¯ä¸¤è€…çš„å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚ InnoDB å¼•æ“ä¸­ï¼Œå…¶æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ï¼Œæ”¯æŒèšç°‡ç´¢å¼•ã€‚ è€Œ MyISAMï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå…¶è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰B+Treeç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œæ ‘çš„å¶èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ï¼Œåœ¨ç´¢å¼•æ£€ç´¢çš„æ—¶å€™ï¼Œé¦–å…ˆæŒ‰ç…§ B+Tree æœç´¢ç®—æ³•æœç´¢ç´¢å¼•ï¼Œå¦‚æœæŒ‡å®šçš„ Key å­˜åœ¨ï¼Œåˆ™å–å‡ºå…¶ data åŸŸçš„å€¼ï¼Œç„¶åä»¥ data åŸŸçš„å€¼ä¸ºåœ°å€è¯»å–ç›¸åº”çš„æ•°æ®è®°å½•ã€‚è¿™è¢«ç§°ä¸ºâ€œéèšç°‡ç´¢å¼•ï¼ˆéèšé›†ç´¢å¼•ï¼‰â€ã€‚ è¯¦ç»†éœ€è¦çœ‹ç´¢å¼•ã€‚ æ€§èƒ½å·®åˆ« InnoDB çš„æ€§èƒ½æ¯” MyISAM æ›´å¼ºå¤§ï¼Œä¸ç®¡æ˜¯åœ¨è¯»å†™æ··åˆæ¨¡å¼ä¸‹è¿˜æ˜¯åªè¯»æ¨¡å¼ä¸‹ï¼Œéšç€ CPU æ ¸æ•°çš„å¢åŠ ï¼ŒInnoDB çš„è¯»å†™èƒ½åŠ›å‘ˆçº¿æ€§å¢é•¿ã€‚MyISAM å› ä¸ºè¯»å†™ä¸èƒ½å¹¶å‘ï¼Œå®ƒçš„å¤„ç†èƒ½åŠ›è·Ÿæ ¸æ•°æ²¡å…³ç³»ã€‚ é—®ï¼šå¦‚ä½•é€‰æ‹© MyISAM å’Œ InnoDBã€MEMORYï¼Ÿ InnoDBâ­ï¼šå¦‚æœåº”ç”¨å¯¹äº‹åŠ¡çš„å®Œæ•´æ€§æœ‰è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘æ¡ä»¶ä¸‹è¦æ±‚æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ•°æ®æ“ä½œé™¤äº†æ’å…¥å’ŒæŸ¥è¯¢å¤–ï¼Œè¿˜åŒ…å«å¾ˆå¤šæ›´æ–°ã€åˆ é™¤çš„æ“ä½œï¼Œé‚£ä¹ˆé€‰æ‹© InnoDBã€‚ MyISAMï¼šå¦‚æœåº”ç”¨ä»¥æ’å…¥å’ŒæŸ¥è¯¢æ“ä½œä¸ºä¸»ï¼Œå¾ˆå°‘æ›´æ–°å’Œåˆ é™¤ï¼Œå¹¶ä¸”å¯¹äº‹åŠ¡çš„å®Œæ•´æ€§ã€å¹¶å‘æ€§è¦æ±‚ä¸é«˜ï¼Œä¹Ÿä¸éœ€è¦å´©æºƒåå®‰å…¨æ¢å¤çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå‡‘åˆèƒ½ç”¨ã€‚(ç°åœ¨è¢« MongoDB æ›¿ä»£äº†) MEMORYï¼šé€šå¸¸ç”¨äºä¸´æ—¶è¡¨åŠç¼“å­˜ï¼Œå°†æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨å†…å­˜ï¼Œè®¿é—®é€Ÿåº¦å¿«ã€‚ç¼ºç‚¹å°±æ˜¯å¯¹è¡¨çš„å¤§å°æœ‰é™åˆ¶ï¼Œä¸”å®‰å…¨æ€§æ— æ³•ä¿éšœã€‚(ç°åœ¨è¢« Redis æ›¿ä»£äº†) ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹é€‰æ‹© InnoDB éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€ç´¢å¼•â­ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:4:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"3.1 ç´¢å¼•ç»“æ„ ç´¢å¼•æ˜¯å¸®åŠ© MySQL é«˜æ•ˆè·å–æ•°æ®(å¿«é€ŸæŸ¥è¯¢å’Œæ£€ç´¢æ•°æ®)çš„æ•°æ®ç»“æ„(æœ‰åº)ã€‚ å¸¸è§çš„ç´¢å¼•ç»“æ„æœ‰: B æ ‘(ä¹Ÿç§° B- æ ‘)ï¼ŒB+ æ ‘ å’Œ Hashã€çº¢é»‘æ ‘ã€‚åœ¨ MySQL ä¸­ï¼Œæ— è®ºæ˜¯ Innodb è¿˜æ˜¯ MyIsamï¼Œéƒ½ä½¿ç”¨äº† B+ æ ‘ ä½œä¸ºç´¢å¼•ç»“æ„ã€‚å¤§éƒ¨åˆ†éƒ½æ”¯æŒ B+ æ ‘ ç´¢å¼•ã€‚ InnoDB çš„æ•°æ®æ˜¯æŒ‰==ã€Œæ•°æ®é¡µã€(16KB)==ä¸ºå•ä½æ¥è¯»å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†è¿™ä¸ªè®°å½•æœ¬èº«ä»ç£ç›˜è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†å…¶æ•´ä½“è¯»å…¥å†…å­˜ã€‚ é—®ï¼šB-æ ‘ å’Œ B+æ ‘ æœ‰ä½•å¼‚åŒï¼Ÿ B-æ ‘ çš„æ‰€æœ‰èŠ‚ç‚¹æ—¢å­˜æ”¾é”®(key)ä¹Ÿå­˜æ”¾æ•°æ®(data)ï¼Œè€Œ B+æ ‘ åªæœ‰å¶å­èŠ‚ç‚¹å­˜æ”¾ key å’Œ dataï¼Œå…¶ä»–èŠ‚ç‚¹åªå­˜æ”¾ keyï¼› B-æ ‘ çš„å¶å­èŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼›B+æ ‘ çš„å¶å­èŠ‚ç‚¹ä¹‹é—´æ„æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼› B+æ ‘ çš„éå¶å­èŠ‚ç‚¹çš„ç´¢å¼•ä¹Ÿä¼šåŒæ—¶å­˜åœ¨åœ¨å­èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­èŠ‚ç‚¹ä¸­æ‰€æœ‰ç´¢å¼•çš„æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰ï¼Œè¿™æ ·è™½ç„¶æœ‰å¤§é‡çš„å†—ä½™èŠ‚ç‚¹ï¼Œè¿™æ ·ä½¿å¾—åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä»å¶å­èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç”šè‡³å¯ä»¥ä¸åŠ¨éå¶å­èŠ‚ç‚¹ã€‚ B-æ ‘ çš„æ£€ç´¢å¯èƒ½è¿˜æ²¡æœ‰åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œæ£€ç´¢å°±ç»“æŸäº†ï¼ŒæŸ¥è¯¢æ³¢åŠ¨æ¯”è¾ƒå¤§ï¼›è€Œ B+æ ‘ çš„æ£€ç´¢æ•ˆç‡å°±å¾ˆç¨³å®šäº†ï¼Œä»»ä½•æŸ¥æ‰¾éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚ é—®ï¼šB+ Tree ç›¸æ¯”äº B- Tree çš„ä¼˜ç‚¹ï¼Ÿ **èŒƒå›´æŸ¥è¯¢æ•ˆç‡æ›´é«˜ã€‚**å› ä¸º B+ æ ‘æ‰€æœ‰å¶å­èŠ‚ç‚¹é—´æœ‰ä¸€ä¸ªé“¾è¡¨è¿›è¡Œè¿æ¥ï¼Œåªéœ€è¦æŸ¥åˆ°å¤´èŠ‚ç‚¹ï¼Œç„¶åå¾€åéå†å³å¯ã€‚ä½† B- æ ‘å°±åªèƒ½é€šè¿‡ä¸€ä¸ªä¸€ä¸ªæŸ¥æ‰¾å®Œæˆã€‚ **æ’å…¥å’Œåˆ é™¤æ•ˆç‡æ›´é«˜ã€‚**å› ä¸º B+ æ ‘æœ‰å†—ä½™èŠ‚ç‚¹ï¼Œæ’å…¥å’Œåˆ é™¤æ—¶ï¼Œæ ‘çš„ç»“æ„ä¸ç”¨æ€ä¹ˆå˜åŒ–ã€‚ æŸ¥è¯¢æ•ˆç‡ä¹Ÿæ›´é«˜ä¸€ç‚¹ã€‚å› ä¸ºI/Oæ“ä½œä¼šå°‘ä¸€ç‚¹å˜›ã€‚ é—®ï¼šHash ç´¢å¼•ç›¸æ¯”äº B+ æ ‘çš„ä¼˜ç¼ºç‚¹ï¼Ÿ Hashç´¢å¼•è‡ªèº«åªéœ€è¦å­˜å‚¨å¯¹åº”çš„å“ˆå¸Œå€¼ï¼Œæ‰€ä»¥ç´¢å¼•å†…å­˜ç»“æ„éå¸¸ç´§å‡‘ï¼ŒæŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ï¼› ä½†ç”±äºæ˜¯é€šè¿‡å“ˆå¸Œæ˜ å°„è¿›è¡Œç´¢å¼•ï¼Œå› æ­¤æ— æ³•æ’åºæˆ–è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ã€‚ é—®ï¼šB+ Tree çš„ç‰¹ç‚¹ï¼Ÿ åªæœ‰å¶å­èŠ‚ç‚¹ï¼ˆæœ€åº•å±‚çš„èŠ‚ç‚¹ï¼‰æ‰å­˜æ”¾äº†æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆå…¶ä»–ä¸Šå±‚èŠ‚ï¼‰ä»…ç”¨æ¥å­˜æ”¾ç›®å½•é¡¹ä½œä¸ºç´¢å¼•ã€‚ éå¶å­èŠ‚ç‚¹åˆ†ä¸ºä¸åŒå±‚æ¬¡ï¼Œé€šè¿‡åˆ†å±‚æ¥é™ä½æ¯ä¸€å±‚çš„æœç´¢é‡ï¼› æ‰€æœ‰èŠ‚ç‚¹æŒ‰ç…§ç´¢å¼•é”®å¤§å°æ’åºï¼Œæ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä¾¿äºèŒƒå›´æŸ¥è¯¢ï¼› é—®ï¼šB+ Tree ç´¢å¼•ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹ï¼Ÿ B+ æ ‘å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾ä¸»é”®ä¸º 6 çš„è®°å½•ï¼š ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œå› ä¸ºæŸ¥è¯¢çš„ä¸»é”®å€¼ä¸º 6ï¼Œåœ¨[1, 7)èŒƒå›´ä¹‹é—´ï¼Œæ‰€ä»¥åˆ°é¡µ 30 ä¸­æŸ¥æ‰¾æ›´è¯¦ç»†çš„ç›®å½•é¡¹ï¼› åœ¨éå¶å­èŠ‚ç‚¹ï¼ˆé¡µ30ï¼‰ä¸­ï¼Œç»§ç»­é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œä¸»é”®å€¼å¤§äº 5ï¼Œæ‰€ä»¥å°±åˆ°å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰æŸ¥æ‰¾è®°å½•ï¼› æ¥ç€ï¼Œåœ¨å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰ä¸­ï¼Œé€šè¿‡æ§½æŸ¥æ‰¾è®°å½•æ—¶ï¼Œä½¿ç”¨äºŒåˆ†æ³•å¿«é€Ÿå®šä½è¦æŸ¥è¯¢çš„è®°å½•åœ¨å“ªä¸ªæ§½ï¼ˆå“ªä¸ªè®°å½•åˆ†ç»„ï¼‰ï¼Œå®šä½åˆ°æ§½åï¼Œå†éå†æ§½å†…çš„æ‰€æœ‰è®°å½•ï¼Œæ‰¾åˆ°ä¸»é”®ä¸º 6 çš„è®°å½•ã€‚ é—®ï¼šä¸ºä»€ä¹ˆ InnoDB å­˜å‚¨å¼•æ“é€‰ç”¨ B+Tree ç´¢å¼•ç»“æ„ï¼Ÿ ç›¸æ¯”äºçº¢é»‘æ ‘ç­‰äºŒå‰æ ‘ç»“æ„ï¼ŒB+Tree å±‚çº§æ›´å°‘ï¼Œå› æ­¤æœç´¢æ•ˆç‡æ›´é«˜(å› ä¸ºç£ç›˜I/Oæ“ä½œæ›´å°‘)ï¼› ç›¸æ¯”äº B-Tree ï¼Œå› ä¸º B-Tree æ— è®ºå¶å­èŠ‚ç‚¹è¿˜æ˜¯éå¶å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šä¿å­˜æ•°æ®ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸€é¡µä¸­å­˜å‚¨çš„é”®å€¼å‡å°‘ï¼ŒæŒ‡é’ˆä¹Ÿè·Ÿç€å‡å°‘ï¼Œè¦ä¿å­˜åŒæ ·çš„æ•°æ®ï¼Œåªèƒ½å¢åŠ æ ‘çš„é«˜åº¦ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼›å…¶å®æˆ‘è§‰å¾—ï¼Œä¸»è¦æ˜¯**==å‡å°‘äº†è°ƒé¡µçš„I/Oæ“ä½œæ¬¡æ•°==**ã€‚ ç›¸æ¯”äº Hashç´¢å¼• ï¼ŒB+Tree æ”¯æŒèŒƒå›´åŒ¹é…åŠæ’åºæ“ä½œï¼Œæ¯”å¦‚SELECT * FROM tb1 WHERE id \u003c 500;ï¼Œå¦‚æœç”¨ Hashç´¢å¼•ï¼Œéš¾é“è¦æŠŠ1-499éƒ½æŒ¨ä¸ªhashå®šä½å—ï¼Ÿ æ³¨ï¼š å…¶å®ä¸€å¼€å§‹æˆ‘å¾ˆä¸ç†è§£ä¸ºå•¥ ==â€œ1. å±‚çº§å‡å°‘ï¼Œæœç´¢æ•ˆç‡ä¼šå˜é«˜â€==ï¼Œå› ä¸ºä½ å°±ç®—å±‚çº§å˜å°‘äº†ï¼Œä½†æ˜¯èŠ‚ç‚¹å†…çš„é”®å€¼å¯¹å˜å¤šäº†å•Šï¼Œæœç´¢çš„æ—¶å€™è¿˜æ˜¯ç”¨äºŒåˆ†ï¼Œæ•ˆç‡å¹¶æ²¡æœ‰å‡å°‘å•Šï¼ åæ¥ï¼Œæˆ‘çŸ¥é“äº†æ¯æ¬¡è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯éœ€è¦ä¸€æ¬¡è°ƒé¡µæ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡ç£ç›˜I/Oï¼Œè€Œå•ä¸ªèŠ‚ç‚¹å†…çš„é”®å€¼å¯¹å˜å¤šï¼Œæ˜¾ç„¶ä¼šå‡å°‘è°ƒé¡µæ¬¡æ•°ï¼Œä¹Ÿå°±æé«˜äº†æ•ˆç‡ã€‚ é—®ï¼šB+ æ ‘ä¸åŒé«˜åº¦çš„æ•°æ®å­˜å‚¨ï¼Ÿ å‡è®¾ B+ æ ‘çš„é«˜åº¦ä¸º 2 çš„è¯ï¼Œå³æœ‰ä¸€ä¸ªæ ¹ç»“ç‚¹å’Œè‹¥å¹²ä¸ªå¶å­ç»“ç‚¹ã€‚è¿™æ£µ B+ æ ‘çš„å­˜æ”¾æ€»è®°å½•æ•°ä¸º = æ ¹ç»“ç‚¹æŒ‡é’ˆæ•° * å•ä¸ªå¶å­èŠ‚ç‚¹è®°å½•è¡Œæ•°ã€‚ å¦‚æœä¸€è¡Œè®°å½•çš„æ•°æ®å¤§å°ä¸º 1kï¼Œé‚£ä¹ˆå•ä¸ªå¶å­èŠ‚ç‚¹å¯ä»¥å­˜çš„è®°å½•æ•° = 16k/1k = 16. éå¶å­èŠ‚ç‚¹å†…å­˜æ”¾å¤šå°‘æŒ‡é’ˆå‘¢ï¼Ÿæˆ‘ä»¬å‡è®¾ä¸»é”®IDä¸º bigint ç±»å‹ï¼Œé•¿åº¦ä¸º8å­—èŠ‚(é¢è¯•å®˜é—®ä½ intç±»å‹ï¼Œä¸€ä¸ªintå°±æ˜¯32ä½ï¼Œ4å­—èŠ‚)ï¼Œè€ŒæŒ‡é’ˆå¤§å°åœ¨InnoDBæºç ä¸­è®¾ç½®ä¸º6å­—èŠ‚ï¼Œæ‰€ä»¥å°±æ˜¯ 8+6 = 14 å­—èŠ‚ï¼Œ16KB/14B = 16*1024B/14B = 1170 å› æ­¤ï¼Œä¸€æ£µé«˜åº¦ä¸º2çš„B+æ ‘ï¼Œèƒ½å­˜æ”¾1170 * 16=18720æ¡è¿™æ ·çš„æ•°æ®è®°å½•ã€‚åŒç†ä¸€æ£µé«˜åº¦ä¸º 3 çš„ B+ æ ‘ï¼Œèƒ½å­˜æ”¾ 1170 *1170 * 16 = 21902400ï¼Œå¤§æ¦‚å¯ä»¥å­˜æ”¾ä¸¤åƒä¸‡å·¦å³çš„è®°å½•ã€‚B+ æ ‘é«˜åº¦ä¸€èˆ¬ä¸º 1-3 å±‚ï¼Œå¦‚æœ B+ åˆ°äº† 4 å±‚ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ä¼šå¤šæŸ¥ç£ç›˜çš„æ¬¡æ•°ï¼ŒSQL å°±ä¼šå˜æ…¢ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:4:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"3.2 ç´¢å¼•ç±»å‹ åˆ†ç±» å«ä¹‰ ç‰¹ç‚¹ å…³é”®å­— ä¸»é”®ç´¢å¼• é’ˆå¯¹è¡¨ä¸­ä¸»é”®åˆ›å»ºçš„ç´¢å¼• é»˜è®¤è‡ªåŠ¨åˆ›å»ºï¼Œåªèƒ½æœ‰ä¸€ä¸ª PRIMARY å”¯ä¸€ç´¢å¼• é¿å…åŒä¸€ä¸ªè¡¨ä¸­æŸæ•°æ®åˆ—ä¸­çš„å€¼é‡å¤ å¯ä»¥æœ‰å¤šä¸ª UNIQUE å¸¸è§„ç´¢å¼• å¿«é€Ÿå®šä½ç‰¹å®šæ•°æ® å¯ä»¥æœ‰å¤šä¸ª å…¨æ–‡ç´¢å¼• å…¨æ–‡ç´¢å¼•æŸ¥æ‰¾çš„æ˜¯æ–‡æœ¬ä¸­çš„å…³é”®è¯ï¼Œè€Œä¸æ˜¯æ¯”è¾ƒç´¢å¼•ä¸­çš„å€¼ å¯ä»¥æœ‰å¤šä¸ª FULLTEXT åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œæ ¹æ®ç´¢å¼•çš„å­˜å‚¨å½¢å¼ï¼Œåˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š åˆ†ç±» å«ä¹‰ ç‰¹ç‚¹ èšé›†ç´¢å¼•(Clustered Index) å°†ç´¢å¼•ä¸æ•°æ®å­˜å‚¨æ”¾åˆ°ä¸€èµ·ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹ä¸­ä¿å­˜äº†è¡Œæ•°æ® æœ‰ä¸”åªæœ‰ä¸€ä¸ª äºŒçº§ç´¢å¼•(Secondary Index) å°†æ•°æ®ä¸ç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹ä¸­ä¿å­˜äº†å¯¹åº”çš„ä¸»é”® å¯ä»¥æœ‰å¤šä¸ª æ¯”å¦‚ï¼šselect * from user where name='Tom'ï¼Œä¼šå…ˆå»æŸ¥æ‰¾äºŒçº§ç´¢å¼•nameï¼Œæ‰¾åˆ°å¯¹åº”çš„ä¸»é”®idå€¼ï¼Œç„¶åå›è¡¨æŸ¥è¯¢é€šè¿‡èšé›†ç´¢å¼•æ‹¿åˆ°å¯¹åº”çš„è¡Œæ•°æ®ã€‚ æ€è€ƒï¼šä»¥ä¸‹ SQLè¯­å¥ï¼Œå“ªä¸ªæ‰§è¡Œæ•ˆç‡é«˜ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ select * from user where id = 10; select * from user where name = 'Arm'; -- å¤‡æ³¨ï¼šidä¸ºä¸»é”®ï¼Œnameå­—æ®µåˆ›å»ºçš„æœ‰ç´¢å¼•ã€‚ 1æ˜¾ç„¶æ•ˆç‡æ›´é«˜ã€‚ é—®ï¼šç´¢å¼•ç±»å‹ï¼Ÿ ç´¢å¼•ä»æ•°æ®ç»“æ„è¿›è¡Œåˆ’åˆ†çš„åˆ†ä¸ºï¼šB+æ ‘ç´¢å¼•ã€B-æ ‘ç´¢å¼•ã€Hashç´¢å¼•ã€äºŒå‰æ ‘ç´¢å¼•ã€‚ ç´¢å¼•ä»ç‰©ç†å­˜å‚¨çš„è§’åº¦åˆ’åˆ†ä¸ºï¼šèšæ—ç´¢å¼•å’Œéèšæ—ç´¢å¼•ã€‚ ä»é€»è¾‘çš„è§’åº¦åˆ†ä¸ºï¼šä¸»é”®ç´¢å¼•ã€æ™®é€šç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€è”åˆç´¢å¼•ã€‚ é—®ï¼šInnoDB ä¸»é”®ç´¢å¼•çš„ B+Tree é«˜åº¦æœ‰å¤šé«˜ï¼Ÿ é»‘é©¬è§†é¢‘ã€‚ é—®ï¼šèšé›†ç´¢å¼•é€‰å–è§„åˆ™ï¼Ÿ èšé›†ç´¢å¼•æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªï¼Œå®ƒå°†ç´¢å¼•ä¸æ•°æ®å­˜å‚¨æ”¾åˆ°ä¸€èµ·ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹ä¸­ä¿å­˜äº†è¡Œæ•°æ®ã€‚ å¦‚æœå­˜åœ¨ä¸»é”®ï¼Œä¸»é”®ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ï¼› å¦‚æœä¸å­˜åœ¨ä¸»é”®ï¼Œç¬¬ä¸€ä¸ªå”¯ä¸€ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ï¼› å¦‚æœäºŒè€…éƒ½æ— ï¼Œåˆ™ InnoDB ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª éšå¼è‡ªå¢çš„id ä½œä¸ºéšè—çš„èšé›†ç´¢å¼•ã€‚ é—®ï¼šSQLæ€§èƒ½åˆ†ææ–¹æ³•ï¼Ÿ SQL æ‰§è¡Œé¢‘æ¬¡ æ…¢æŸ¥è¯¢æ—¥å¿— profilesè¯¦æƒ… explainæ€§èƒ½åˆ†æï¼Œå¯ä»¥æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:4:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"3.3 ç´¢å¼•ä½¿ç”¨ ç´¢å¼•æ³•åˆ™ **å•åˆ—ç´¢å¼•ï¼š**ä¸€ä¸ªç´¢å¼•å€¼åŒ…å«å•ä¸ªåˆ— **è”åˆç´¢å¼•ï¼š**ä¸€ä¸ªç´¢å¼•åŒ…å«äº†å¤šä¸ªåˆ— é—®ï¼šç´¢å¼•å¤±æ•ˆçš„æƒ…å†µï¼Ÿå³ï¼Œä½¿ç”¨ç´¢å¼•æ—¶éœ€è¦çš„æ³¨æ„äº‹é¡¹ï¼Ÿâ­â­ğŸš© æœ€å·¦å‰ç¼€æ³•åˆ™ å¦‚æœç´¢å¼•äº†å¤šåˆ—(è”åˆç´¢å¼•)ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æœ€å·¦å‰ç¼€æ³•åˆ™æŒ‡çš„æ˜¯æŸ¥è¯¢æ¡ä»¶ä»ç´¢å¼•çš„æœ€å·¦åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚å¦‚æœè·³è¿‡æŸä¸€åˆ—ï¼Œç´¢å¼•å°†éƒ¨åˆ†å¤±æ•ˆ(åé¢çš„å­—æ®µç´¢å¼•å¤±æ•ˆ)ã€‚ å¦‚æœåˆ›å»ºäº†ä¸€ä¸ª (a, b, c) è”åˆç´¢å¼•ï¼š # ä¸ä¼šå¤±æ•ˆ where a=1ï¼› where a=1 and b=2 and c=3ï¼› where b=2 and a=1 and c=3; # æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è¿›è¡Œæ’åº where a=1 and b=2ï¼› # éƒ¨åˆ†ç”Ÿæ•ˆ where a=1 and c=3 # ä¼šå¤±æ•ˆ where b=2ï¼› where c=3ï¼› where b=2 and c=3ï¼› å…¶å®è”åˆç´¢å¼•(a, b, c)ï¼Œæ˜¯å…ˆæŒ‰ a æ’åºï¼Œåœ¨ a ç›¸åŒçš„æƒ…å†µå†æŒ‰ b æ’åºï¼Œåœ¨ b ç›¸åŒçš„æƒ…å†µå†æŒ‰ c æ’åºã€‚æ‰€ä»¥ï¼Œb å’Œ c æ˜¯å…¨å±€æ— åºï¼Œå±€éƒ¨ç›¸å¯¹æœ‰åºçš„ã€‚ æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æŸ¥è¯¢æ¡ä»¶ï¼šwhere a = 1 and c = 3 ï¼Œç¬¦åˆæœ€å·¦åŒ¹é…å—ï¼Ÿ ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´æ˜¯å±äºç´¢å¼•æˆªæ–­ï¼Œä¸åŒç‰ˆæœ¬å¤„ç†æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼š MySQL 5.5 çš„è¯ï¼Œå‰é¢ a ä¼šèµ°ç´¢å¼•ï¼Œåœ¨è”åˆç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼åï¼Œå¼€å§‹å›è¡¨ï¼Œåˆ°ä¸»é”®ç´¢å¼•è¯»å–æ•°æ®è¡Œï¼ŒServer å±‚ä»å­˜å‚¨å¼•æ“å±‚è·å–åˆ°æ•°æ®è¡Œåï¼Œç„¶ååœ¨ Server å±‚å†æ¯”å¯¹ c å­—æ®µçš„å€¼ï¼› ä» MySQL 5.6 ä¹‹åï¼Œæœ‰ä¸€ä¸ªç´¢å¼•ä¸‹æ¨åŠŸèƒ½ï¼Œå¯ä»¥åœ¨å­˜å‚¨å¼•æ“å±‚è¿›è¡Œç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå†è¿”è¿˜ç»™ Server å±‚ï¼Œä»è€Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚ ç´¢å¼•ä¸‹æ¨çš„åŸºæœ¬åŸç†ï¼šæˆªæ–­çš„å­—æ®µä¸ä¼šåœ¨ Server å±‚è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œè€Œæ˜¯ä¼šè¢«ä¸‹æ¨åˆ°ã€Œå­˜å‚¨å¼•æ“å±‚ã€è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼ˆå› ä¸º c å­—æ®µçš„å€¼æ˜¯åœ¨ (a, b, c) è”åˆç´¢å¼•é‡Œçš„ï¼‰ï¼Œç„¶åè¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„æ•°æ®åå†è¿”å›ç»™ Server å±‚ã€‚ç”±äºåœ¨å¼•æ“å±‚å°±è¿‡æ»¤æ‰å¤§é‡çš„æ•°æ®ï¼Œæ— éœ€å†å›è¡¨è¯»å–æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ï¼Œä»è€Œæå‡äº†æ€§èƒ½ã€‚ å› æ­¤ï¼Œwhere a = 1 and c = 3 ä¼šéƒ¨åˆ†ç”¨åˆ°ç´¢å¼•ï¼Œå¹¶ä¸”åœ¨ MySQL 5.6 åï¼Œè¿˜ä¼šç”¨åˆ°ç´¢å¼•ä¸‹æ¨ã€‚ è¯¦ç»† èŒƒå›´æŸ¥è¯¢ è”åˆç´¢å¼•ä¸­ï¼Œå‡ºç°èŒƒå›´æŸ¥è¯¢(\u003e, \u003c)ï¼ŒèŒƒå›´æŸ¥è¯¢å³ä¾§çš„åˆ—ç´¢å¼•å¤±æ•ˆã€‚æ³¨æ„ï¼šè‹¥ä½¿ç”¨ (\u003e=, \u003c=)ï¼Œåˆ™ä¸ä¼šå¤±æ•ˆï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ (\u003e=, \u003c=)ã€‚ **å­—ç¬¦ä¸²ä¸åŠ å¼•å·ï¼š**å­—ç¬¦ä¸²ç±»å‹å­—æ®µä½¿ç”¨æ—¶ï¼Œè‹¥ç´¢å¼•å€¼ä¸åŠ å¼•å·ï¼Œç´¢å¼•å°†å¤±æ•ˆã€‚ explain select * from user where phone = '17799990015'; -- ä¸å¤±æ•ˆ explain select * from user where phone = 17799990015; -- å¤±æ•ˆ æ¨¡ç³ŠæŸ¥è¯¢ï¼šå¦‚æœä»…ä»…æ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆï¼›å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å¤±æ•ˆã€‚å› ä¸ºæ’åºæ—¶æ˜¯æŒ‰å­—å…¸åºã€‚ explain select * from user where prefession like 'è½¯ä»¶%' -- ä¸å¤±æ•ˆ explain select * from user where prefession like '%å·¥ç¨‹' -- å¤±æ•ˆ **orè¿æ¥çš„æ¡ä»¶ï¼š**ç”¨oråˆ†å‰²å¼€çš„æ¡ä»¶ï¼Œå¦‚æœorå‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•ï¼Œè€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ¶‰åŠçš„ç´¢å¼•éƒ½ä¸ä¼šè¢«ç”¨åˆ°ã€‚å³ï¼Œåªæœ‰orä¸¤è¾¹çš„æ¡ä»¶å‡æœ‰ç´¢å¼•ï¼Œæ•´ä½“æ‰ä¼šç”Ÿæ•ˆï¼Œå¦åˆ™ï¼Œå‡ä¸ç”Ÿæ•ˆã€‚ **æ•°æ®åˆ†å¸ƒå½±å“ï¼š**å¦‚æœ MySQL è¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æŸ¥è¯¢æ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚ -- æ•°æ®èŒƒå›´ï¼š00-20 explain select * from user where phone = '17799990005'; -- å…¨è¡¨æŸ¥è¯¢ explain select * from user where phone = '17799990015'; -- ç´¢å¼•æŸ¥è¯¢ å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼šå› ä¸ºç´¢å¼•ä¿å­˜çš„æ˜¯ç´¢å¼•å­—æ®µçš„åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ id + 1 è¡¨è¾¾å¼è®¡ç®—åçš„å€¼ï¼Œæ‰€ä»¥æ— æ³•èµ°ç´¢å¼•ï¼Œåªèƒ½é€šè¿‡æŠŠç´¢å¼•å­—æ®µçš„å–å€¼éƒ½å–å‡ºæ¥ï¼Œç„¶åä¾æ¬¡è¿›è¡Œè¡¨è¾¾å¼çš„è®¡ç®—æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå› æ­¤é‡‡ç”¨çš„å°±æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼ã€‚ explain select * from t_user where id + 1 = 10; # ç´¢å¼•å¤±æ•ˆ where id = 10 - 1; # ç´¢å¼•ä¸å¤±æ•ˆ å»ºè®®å‚è€ƒï¼šç´¢å¼•å¤±æ•ˆæœ‰å“ªäº›ï¼Ÿ é—®ï¼šå¦‚ä½•æŸ¥çœ‹ MySQL æ˜¯å¦ç”¨åˆ°äº†ç´¢å¼•ï¼ŸğŸš© åœ¨æŸ¥è¯¢è¯­å¥å‰åŠ ä¸Š explain å…³é”®å­—ã€‚ é—®ï¼šä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„åšæ³•ï¼Ÿå³ ä¼˜åŒ–ç´¢å¼•çš„æ–¹æ³•ï¼Ÿ å‰ç¼€ç´¢å¼•ä¼˜åŒ–ï¼› è¦†ç›–ç´¢å¼•ä¼˜åŒ–ï¼› ä¸»é”®ç´¢å¼•æœ€å¥½æ˜¯è‡ªå¢çš„ï¼› é˜²æ­¢ç´¢å¼•å¤±æ•ˆ ä½¿ç”¨å‰ç¼€ç´¢å¼•æ˜¯ä¸ºäº†å‡å°ç´¢å¼•å­—æ®µå¤§å°ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªç´¢å¼•é¡µä¸­å­˜å‚¨çš„ç´¢å¼•å€¼æ•°ç›®ï¼› å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé¿å…ä½¿ç”¨select *ï¼Œä¼šå¤§é‡é€ æˆå›è¡¨æŸ¥è¯¢ï¼ŒåŸå› è§ä¸‹ã€‚ ä¸»é”®ç´¢å¼•æœ€å¥½æ˜¯è‡ªå¢çš„ï¼Œè¿™æ ·çš„è¯ï¼Œæ¯æ¬¡æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼Œéƒ½æ˜¯è¿½åŠ æ“ä½œï¼Œä¸éœ€è¦é‡æ–°ç§»åŠ¨æ•°æ®ï¼› ç´¢å¼•æ—¶ï¼Œè¦é¿å…ç´¢å¼•å¤±æ•ˆã€‚ è¦†ç›–ç´¢å¼•ã€å›è¡¨æŸ¥è¯¢â­ğŸš© å¦‚æœä¸€ä¸ªç´¢å¼•è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œå°±ç§°ä¹‹ä¸º**è¦†ç›–ç´¢å¼•**ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œå¦‚æœä¸æ˜¯ä¸»é”®ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®+åˆ—å€¼ã€‚æœ€ç»ˆè¿˜æ˜¯è¦â€œå›è¡¨â€ï¼Œä¹Ÿå°±æ˜¯è¦é€šè¿‡ä¸»é”®å†æŸ¥æ‰¾ä¸€æ¬¡ï¼Œè¿™æ ·å°±ä¼šæ¯”è¾ƒæ…¢ã€‚ **è¦†ç›–ç´¢å¼•ï¼Œå³éœ€è¦æŸ¥è¯¢çš„å­—æ®µæ­£å¥½æ˜¯ç´¢å¼•ä¸­çš„å­—æ®µï¼Œé‚£ä¹ˆç›´æ¥æ ¹æ®è¯¥ç´¢å¼•ï¼Œå°±å¯ä»¥æŸ¥åˆ°æ•°æ®äº†ï¼Œè€Œæ— éœ€å›è¡¨æŸ¥è¯¢ã€‚**å› æ­¤ï¼Œå°½é‡é¿å…ä½¿ç”¨select *ï¼Œé™¤éä½ è”åˆç´¢å¼•çš„æ¡ä»¶å¾ˆå¤šå¾ˆå¤šã€‚ é—®ï¼šä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢ï¼Ÿ å›è¡¨æŸ¥è¯¢æ˜¯æŒ‡åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœéœ€è¦è·å–çš„æ•°æ®ä¸åœ¨æŸ¥è¯¢è¯­å¥çš„ç´¢å¼•åˆ—ä¸­ï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡å›è¡¨æ“ä½œæ¥è·å–é¢å¤–çš„æ•°æ®ã€‚å›è¡¨æ“ä½œä¼šæ ¹æ®æŸ¥è¯¢è¯­å¥ä¸­çš„ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å®šä½è¡Œæ•°æ®ï¼Œç„¶åå†æ ¹æ®è¡Œæ•°æ®ä¸­çš„å…¶ä»–åˆ—è·å–éœ€è¦çš„æ•°æ®ã€‚ ä¾‹ï¼šã€Šé»‘é©¬ã€‹P84 è®²çš„å¾ˆå¥½ï¼ å¦‚ä¸»é”®ç´¢å¼•ï¼Œå¦‚æœä¸€æ¡ SQL éœ€è¦æŸ¥è¯¢ä¸»é”®ï¼Œé‚£ä¹ˆæ­£å¥½æ ¹æ®ä¸»é”®ç´¢å¼•å°±å¯ä»¥æŸ¥åˆ°ä¸»é”®ã€‚ å†å¦‚æ™®é€šç´¢å¼•ï¼Œå¦‚æœä¸€æ¡ SQL éœ€è¦æŸ¥è¯¢ nameï¼Œname å­—æ®µæ­£å¥½æœ‰ç´¢å¼•ï¼Œ é‚£ä¹ˆç›´æ¥æ ¹æ®è¿™ä¸ªç´¢å¼•å°±å¯ä»¥æŸ¥åˆ°æ•°æ®ï¼Œä¹Ÿæ— éœ€å›è¡¨ã€‚ é—®ï¼šè”åˆç´¢å¼•åº”ç”¨åœºæ™¯ï¼Ÿä¸ºä»€ä¹ˆè¦å»ºè”åˆç´¢å¼•ï¼Ÿâ­ğŸš© å¤šæ¡ä»¶è”åˆæŸ¥è¯¢ï¼šå½“æŸ¥è¯¢è¯­å¥ä¸­éœ€è¦åŒæ—¶ä½¿ç”¨å¤šä¸ªåˆ—è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è”åˆç´¢å¼•æ¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ å‡å°‘å¼€é”€ï¼šå»ºä¸€ä¸ªè”åˆç´¢å¼•(a, b, c)ï¼Œå®é™…ç›¸å½“äºå»ºäº†(a)ï¼Œ(a, b)ï¼Œ(a, b, c)ä¸‰ä¸ªç´¢å¼•ã€‚æ¯å¤šä¸€ä¸ªç´¢å¼•ï¼Œéƒ½ä¼šå¢åŠ å†™æ“ä½œçš„å¼€é”€å’Œç£ç›˜ç©ºé—´çš„å¼€é”€ã€‚å¯¹äºå¤§é‡æ•°æ®çš„è¡¨ï¼Œä½¿ç”¨è”åˆç´¢å¼•ä¼šå¤§å¤§çš„å‡å°‘å¼€é”€ï¼ è¦†ç›–ç´¢å¼•ï¼šå½“æŸ¥è¯¢è¯­å¥åªéœ€è¦æŸ¥è¯¢ç´¢å¼•åˆ—å’Œè”åˆç´¢å¼•ä¸­çš„åˆ—æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è”åˆç´¢å¼•æ¥é¿å…å›è¡¨æ“ä½œï¼Œä»è€Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ æ’åºæ“ä½œï¼šå½“æŸ¥è¯¢è¯­å¥éœ€è¦å¯¹å¤šä¸ªåˆ—è¿›è¡Œé¢‘ç¹æ’åºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è”åˆç´¢å¼•æ¥æé«˜æ’åºæ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå­¦ç”Ÿè¡¨åŒ…å«äº†å­¦ç”ŸIDã€å§“åã€å¹´é¾„ã€æˆç»©ç­‰åˆ—ï¼Œå¦‚æœéœ€è¦æŒ‰ç…§æˆç»©å’Œå¹´é¾„è¿›è¡Œæ’åºï¼Œå¯ä»¥ä½¿ç”¨è”åˆç´¢å¼•ï¼ˆæˆç»©ï¼Œå¹´é¾„ï¼‰æ¥æé«˜æ’åºæ•ˆç‡ã€‚ é—®ï¼šä¸€å¼ è¡¨ï¼Œæœ‰å››ä¸ªå­—æ®µ(id, username, password, status)ï¼Œç”±äºæ•°æ®é‡å¤§ï¼Œéœ€è¦å¯¹ä»¥ä¸‹ SQL è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ‰æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼Ÿ select id, username, password from user where username='itcast'; **éœ€è¦å»ºç«‹ç´¢å¼•ï¼š**é’ˆå¯¹ username å’Œ password å»ºç«‹è”åˆç´¢å¼•ï¼Œè¿™æ ·çš„è¯ï¼ŒæŸ¥åˆ°username=â€˜itcastâ€™æ—¶ï¼Œvalå€¼ä¸ºidï¼Œusernameå’Œpasswordä¹ŸçŸ¥é“ï¼Œç›´æ¥è¿”å›å³å¯ï¼Œæ— éœ€å›è¡¨æŸ¥è¯¢ã€‚ å‰ç¼€ç´¢å¼• é—®ï¼šå‰ç¼€ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿ å­—æ®µç±»å‹ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œç´¢å¼•å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œä¼šè®©ç´¢å¼•å˜å¾—å¾ˆå¤§ï¼Œå¯¼è‡´ä¸€ä¸ªç´¢å¼•é¡µä¸­çš„ç´¢å¼•æ•°é‡å˜å°‘ï¼Œå±‚çº§å°±ä¼šå˜é«˜ï¼Œå¯¼è‡´æŸ¥è¯¢æ—¶ï¼Œæµªè´¹å¤§é‡çš„ç£ç›˜IOï¼Œå½±å“æŸ¥è¯¢æ•ˆç‡ã€‚ å‰ç¼€ç´¢å¼•å°±æ˜¯åªå¯¹å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å‰ç¼€ï¼Œå»ºç«‹ç´¢å¼•ï¼Œå¯ä»¥å‡å°ç´¢å¼•å­—æ®µå¤§å°ï¼Œå¢åŠ ä¸€ä¸ªç´¢å¼•é¡µä¸­å­˜å‚¨çš„ç´¢å¼•æ•°é‡ï¼Œæœ‰æ•ˆæé«˜ç´¢å¼•çš„æŸ¥è¯¢é€Ÿåº¦ã€‚ create index idx_xxx on table_name(column(n)) # column(n)è¡¨ç¤ºåˆ—columnåªå–å‰nä¸ªå­—ç¬¦æ„å»ºç´¢å¼• ä¸è¿‡ï¼Œå‰ç¼€ç´¢å¼•æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œä¾‹å¦‚ï¼š order byã€group by æ— æ³•ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼› ç”±äºåªå­˜å‚¨äº†éƒ¨åˆ†å‰ç¼€ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•æŠŠå‰ç¼€ç´¢å¼•ç”¨ä½œè¦†ç›–ç´¢å¼•(è¦†ç›–ç´¢å¼•éœ€è¦å…¨éƒ¨çš„æ•°æ®)ã€‚ ç´¢å¼•ä¸‹æ¨ é—®ï¼šä»€ä¹ˆæ˜¯ç´¢å¼•ä¸‹æ¨ï¼Ÿ ç´¢å¼•ä¸‹æ¨ï¼ˆIndex Condition Pushdownï¼‰ æ˜¯ MySQL 5.6 ç‰ˆæœ¬ä¸­æä¾›çš„ä¸€é¡¹ç´¢å¼•ä¼˜åŒ–åŠŸèƒ½ï¼Œå¯ä»¥åœ¨éèšç°‡ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µåœ¨å¼•æ“å±‚å…ˆåšåˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚ ç´¢å¼•ä¸‹æ¨å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰æŸ¥è¯¢ï¼Œåªæœ‰åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«ç´¢å¼•å­—æ®µå’Œéç´¢å¼•å­—æ®µçš„æƒ…å†µä¸‹æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚ æ ¸å¿ƒæ€æƒ³å°±æ˜¯å¼•æ“å±‚åˆ©ç”¨ç´¢å¼•å­—æ®µå…ˆè¿‡æ»¤ä¸€æ¬¡ï¼Œç„¶ååˆ¤æ–­éç´¢å¼•å­—æ®µæ˜¯å¦åŒ¹é…ï¼Œç„¶åå†è¿”å›ç»™serverå±‚è¿›è¡Œå›è¡¨æŸ¥è¯¢æ‹¿åˆ°æ•´è¡Œæ•°æ®ã€‚ ç´¢å¼•è®¾è®¡åŸåˆ™ é—®ï¼šç´¢å¼•è®¾è®¡åŸåˆ™æœ‰å“ªäº›ï¼Ÿ é’ˆå¯¹æ•°æ®é‡å¤§ã€æŸ¥è¯¢é¢‘ç¹çš„è¡¨å»ºç«‹ç´¢å¼•ï¼› é’ˆå¯¹å¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶(where)ã€æ’åº(order by)ã€åˆ†ç»„(group by)æ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼•ï¼› å°½é‡å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼› é’ˆå¯¹å­—æ®µè¾ƒé•¿çš„å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µï¼Œå»ºç«‹å‰ç¼€ç´¢å¼•ï¼› å°½é‡ä½¿ç”¨è”åˆç´¢å¼•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´(ä¸€ä¸ªè”åˆç´¢å¼•æ¯”å¤šä¸ªå•åˆ—ç´¢å¼•è¦çœç©ºé—´ã€‚å› ä¸ºå¦‚æœæ˜¯è”åˆç´¢å¼•ï¼Œå¤šä¸ªå­—æ®µåœ¨ä¸€ä¸ªç´¢å¼•ä¸Šï¼Œé‚£ä¹ˆå°†ä¼šèŠ‚çº¦å¾ˆå¤§ç£ç›˜ç©ºé—´ï¼Œä¸”ä¿®æ”¹æ•°æ®çš„æ“ä½œæ•ˆç‡ä¹Ÿä¼šæå‡ã€‚)ï¼ŒæŸ¥è¯¢æ—¶å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡(é¿å…å›è¡¨)ï¼› ç´¢å¼•å­—æ®µå°½é‡é¿å…ä¸ºnullï¼Œå¯æ”¹ç”¨0ã€1ã€trueã€falseä»£æ›¿ï¼› é™åˆ¶æ¯å¼ è¡¨çš„ç´¢å¼•æ•°é‡ã€‚ç´¢å¼•å¤ªå¤šä¸ä»…ä¼šé™ä½æ’å…¥å’Œæ›´æ–°çš„æ•ˆç‡ï¼Œè¿˜æœ‰å¯èƒ½é™ä½æŸ¥è¯¢æ€§èƒ½ï¼è¿™æ˜¯å› ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:4:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"å››ã€SQLä¼˜åŒ– å…¶å®2-7éƒ½æ˜¯è·Ÿç´¢å¼•ç›¸å…³ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.1 æ’å…¥æ•°æ® insertä¼˜åŒ–ï¼š æ‰¹é‡æ’å…¥ï¼Œè‹¥ç‰¹åˆ«å¤§é‡(ç™¾ä¸‡çº§)ï¼Œå»ºè®®ä½¿ç”¨loadæŒ‡ä»¤è€Œéinsertï¼› æ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼› ä¸»é”®é¡ºåºæ’å…¥ï¼Œå› ä¸ºä¹±åºæ’å…¥å¯èƒ½ä¼šå‘ç”Ÿé¡µåˆ†è£‚å’Œé¡µåˆå¹¶ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.2 ä¸»é”®ä¼˜åŒ– å°½é‡é™ä½ä¸»é”®çš„é•¿åº¦ï¼› æ’å…¥æ•°æ®æ—¶ï¼Œå°½é‡é€‰æ‹©é¡ºåºæ’å…¥ï¼Œé€‰æ‹©ä½¿ç”¨auto_incrementè‡ªå¢ä¸»é”®ï¼› å°½é‡ä¸è¦ä½¿ç”¨UUIDåšä¸»é”®æˆ–æ˜¯å…¶ä»–è‡ªç„¶ä¸»é”®ï¼Œå¦‚èº«ä»½è¯å·ï¼Œå› ä¸ºè¿™äº›ä¸»é”®ä¸æ˜¯é¡ºåºçš„ï¼Œæ’å…¥æ—¶ç›¸å½“äºä¹±åºï¼Œä¸”è¿™äº›ä¸»é”®è¾ƒé•¿ï¼› å°½é‡é¿å…å¯¹ä¸»é”®çš„ä¿®æ”¹ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.3 order by ä¼˜åŒ– using indexï¼šç›´æ¥é€šè¿‡ç´¢å¼•è¿”å›æ•°æ®ï¼Œæ€§èƒ½é«˜ï¼› using filesortï¼šéœ€è¦å°†è¿”å›çš„ç»“æœåœ¨æ’åºç¼“å†²åŒºé‡æ–°æ’åºã€‚ å¯¹order byå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤æ˜¯å‡åºæ’åˆ—ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦æŒ‰ç…§å»ºç«‹ç´¢å¼•æ—¶æŒ‡å®šçš„æ’åˆ—é¡ºåºï¼Œå¦åˆ™è¿˜æ˜¯ä¼šé¢å¤–çš„æ’åº(filesort)ï¼› ä¹Ÿè¦éµå¾ªæœ€å·¦å‰ç¼€æ³•åˆ™ï¼Œå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼› ä¸å¯é¿å…å‡ºç°filesortæ—¶ï¼Œå¤§æ•°æ®æ’åºæ—¶ï¼Œå¯ä»¥é€‚å½“å¢å¤§æ’åºç¼“å†²åŒºå¤§å°ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.4 group by ä¼˜åŒ– å¯¹group byå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œé¿å…using temporaryï¼› ä¹Ÿè¦éµå¾ªæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:4","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.5 limit ä¼˜åŒ– è¦†ç›–ç´¢å¼•+å­æŸ¥è¯¢ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:5","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.6 count ä¼˜åŒ– MyISAM æ˜¯æŠŠcountç»“æœè®°å½•åœ¨ç£ç›˜ä¸Šï¼Œéœ€è¦çš„æ—¶å€™ç›´æ¥è¯»å–ã€‚ InnoDB éœ€è¦ä¸€æ¡ä¸€æ¡è¯»å–æ•°æ®ï¼Œå†ç´¯è®¡è®¡æ•°ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½çš„ä¼˜åŒ–æ–¹æ³•ã€‚ ç”¨æ³•ï¼š count(ä¸»é”®)ï¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„ä¸»é”®id(ä¸å¯èƒ½ä¸ºnull)çš„å€¼éƒ½å–å‡ºï¼Œç„¶åè¿›è¡Œç´¯åŠ ï¼› count(å­—æ®µ)ï¼š æ²¡æœ‰not nullçº¦æŸï¼šéå†æ•´å¼ è¡¨ï¼Œå–å‡ºæ¯è¡Œçš„å€¼ï¼ŒæœåŠ¡å±‚åˆ¤æ–­æ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullçš„ç´¯åŠ ï¼› æœ‰not nullçº¦æŸï¼šéå†æ•´å¼ è¡¨ï¼Œå–å‡ºæ¯è¡Œçš„å€¼ï¼Œç›´æ¥ç´¯åŠ ã€‚ **count(1)ï¼š**InnoDB éå†æ•´å¼ è¡¨ï¼Œä¸å–å€¼ï¼Œå¯¹æ¯ä¸€è¡Œæ”¾ä¸€ä¸ª1ï¼Œç›´æ¥æŒ‰è¡Œç´¯åŠ ã€‚ **count(*)ï¼š**ç­‰ä»·äº count(0)ï¼ŒInnoDB å¹¶ä¸æŠŠæ‰€æœ‰å­—æ®µå–å‡ºï¼Œä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ï¼Œç›´æ¥æŒ‰è¡Œç´¯åŠ ã€‚(ä½¿ç”¨ count(*) æ—¶ï¼ŒMySQL ä¼šå°† * å‚æ•°è½¬åŒ–ä¸ºå‚æ•° 0 æ¥å¤„ç†)ã€‚ é—®ï¼šcount() æ˜¯ä»€ä¹ˆï¼Ÿ count() æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°ä¸ä»…å¯ä»¥æ˜¯å­—æ®µåï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»æ„è¡¨è¾¾å¼ï¼Œè¯¥å‡½æ•°ä½œç”¨æ˜¯ç»Ÿè®¡ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ä¸­ï¼Œå‡½æ•°æŒ‡å®šçš„å‚æ•°ä¸ä¸º NULL çš„è®°å½•æœ‰å¤šå°‘ä¸ªã€‚ å‡è®¾ count() å‡½æ•°çš„å‚æ•°æ˜¯å­—æ®µåï¼Œå¦‚ä¸‹ï¼š select count(name) from t_order; è¿™æ¡è¯­å¥æ˜¯ç»Ÿè®¡ã€Œt_order è¡¨ä¸­ï¼Œname å­—æ®µä¸ä¸º NULL çš„è®°å½•ã€æœ‰å¤šå°‘ä¸ªã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŸä¸€æ¡è®°å½•ä¸­çš„ name å­—æ®µçš„å€¼ä¸º NULLï¼Œåˆ™å°±ä¸ä¼šè¢«ç»Ÿè®¡è¿›å»ã€‚ å†æ¥å‡è®¾ count() å‡½æ•°çš„å‚æ•°æ˜¯æ•°å­— 1 è¿™ä¸ªè¡¨è¾¾å¼ï¼Œå¦‚ä¸‹ï¼š select count(1) from t_order; è¿™æ¡è¯­å¥æ˜¯ç»Ÿè®¡ã€Œ t_order è¡¨ä¸­ï¼Œ1 è¿™ä¸ªè¡¨è¾¾å¼ä¸ä¸º NULL çš„è®°å½•ã€æœ‰å¤šå°‘ä¸ªã€‚ 1 è¿™ä¸ªè¡¨è¾¾å¼å°±æ˜¯å•çº¯æ•°å­—ï¼Œå®ƒæ°¸è¿œéƒ½ä¸æ˜¯ NULLï¼Œæ‰€ä»¥ä¸Šé¢è¿™æ¡è¯­å¥ï¼Œå…¶å®æ˜¯åœ¨ç»Ÿè®¡ t_order è¡¨ä¸­æœ‰å¤šå°‘ä¸ªè®°å½•ã€‚ é—®ï¼šcount(1)ã€count(*)ã€count(å­—æ®µ)ï¼Œå“ªä¸ªæ•ˆç‡æœ€é«˜ï¼Ÿâ­ğŸš© **==æ•ˆç‡æ’åºï¼š==**count(å­—æ®µ) \u003c counts(ç´¢å¼•å­—æ®µ) \u003c count(1) â‰ˆ count(*)ï¼Œæ‰€ä»¥å°½é‡é€‰æ‹©count(*)ã€‚ å…¶å®ï¼Œå°½é‡ä¸è¦ä½¿ç”¨countæ¥ç»Ÿè®¡ï¼Œå¯ä»¥ä½¿ç”¨ï¼š show table status ä¼°ç®—ï¼› å•ç‹¬å»ºä¸ªè¡¨ï¼Œç”¨æ¥è®¡æ•° ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:6","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"4.7 update ä¼˜åŒ– update æ›´æ–°æ—¶ï¼Œæ›´æ–°æ¡ä»¶è¦æŒ‰ç…§ç´¢å¼•ï¼Œè¿™æ ·åŠ çš„æ‰æ˜¯è¡Œé”ï¼Œå¦åˆ™æ˜¯è¡¨é”ï¼Œä¼šé™ä½æ•°æ®åº“çš„å¹¶è¡Œæ€§èƒ½ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:5:7","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"äº”ã€è§†å›¾ \u0026 å­˜å‚¨è¿‡ç¨‹ \u0026 è§¦å‘å™¨ï¼ˆæœªï¼‰ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:6:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"5.1 è§†å›¾ è§†å›¾æ˜¯ä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„è¡¨ã€‚è§†å›¾åªä¿å­˜äº†æŸ¥è¯¢çš„ SQL é€»è¾‘ï¼Œä¸ä¿å­˜æŸ¥è¯¢ç»“æœã€‚æ‰€ä»¥åœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±è½åœ¨åˆ›å»ºè¿™æ¡ SQL æŸ¥è¯¢è¯­å¥ä¸Šã€‚ # åˆ›å»ºè§†å›¾ create or replace view stu_v_1 as select id, name from student where id \u003c= 10; # æŸ¥è¯¢è§†å›¾ï¼Œæ­¤æ—¶å°±ä¼šè¾“å‡ºid, name ä¸¤åˆ—çš„æ•°æ®ï¼Œå³ç®€åŒ–äº†SQLæŸ¥è¯¢è¯­å¥ select * from stu_v_1; # å¸¦æ£€æŸ¥é€‰é¡¹çš„åˆ›å»ºï¼Œæ­¤æ—¶å‘è§†å›¾æ’å…¥ id\u003e10çš„å°±ä¼šæŠ¥é”™ create or replace view stu_v_1 as select id, name from student where id \u003c= 10 with local check option; è§†å›¾çš„ä½œç”¨ **ç®€åŒ–æ“ä½œã€‚**æ— éœ€æ¯æ¬¡éƒ½æŒ‡å®šå…¨éƒ¨æ¡ä»¶ã€‚ **å®‰å…¨ã€‚**é€šè¿‡è§†å›¾ï¼Œç”¨æˆ·åªèƒ½æŸ¥è¯¢å’Œä¿®æ”¹ä»–ä»¬æ‰€è§åˆ°çš„æ•°æ®ã€‚ **æ•°æ®ç‹¬ç«‹ã€‚**å±è”½åŸºè¡¨å˜åŒ–å¯¹ä¸šåŠ¡çš„å½±å“ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:6:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"5.2 å­˜å‚¨è¿‡ç¨‹ è¯­æ³• # åˆ›å»º æ— è¿”å›å€¼ create procedure è¿‡ç¨‹å begin sqlè¯­å¥; end; # è°ƒç”¨ call è¿‡ç¨‹å; # æŸ¥çœ‹ select * from information_schema.ROUTINES where ROUTINE_SCHEMA = 'itcast'; show create procedure è¿‡ç¨‹å; # åˆ é™¤ drop procedure if exists è¿‡ç¨‹å; ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:6:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"5.3 å­˜å‚¨å‡½æ•° å°±æ˜¯æœ‰è¿”å›å€¼çš„å­˜å‚¨è¿‡ç¨‹ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:6:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"å…­ã€é” é”æ˜¯åè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚ **å…¨å±€é”ï¼š**é”å®šæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ï¼›ï¼ˆç²’åº¦æœ€å¤§çš„é”ï¼‰ **è¡¨çº§é”ï¼š**æ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ï¼›é’ˆå¯¹éç´¢å¼•å­—æ®µï¼› **è¡Œçº§é”ï¼š**æ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®ï¼›é’ˆå¯¹ç´¢å¼•å­—æ®µï¼›ï¼ˆç²’åº¦æœ€å°çš„é”ï¼‰ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:7:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"6.1 å…¨å±€é” é—®ï¼šå…¨å±€é”çš„åº”ç”¨åœºæ™¯ï¼Ÿ å…¨å±€é”æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ï¼ŒåŠ é”åæ•°æ®åº“å˜æˆåªè¯»çŠ¶æ€(DQLå¯æ‰§è¡Œ)ï¼ŒDMLã€DDLè¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯åšå…¨åº“çš„é€»è¾‘å¤‡ä»½ï¼Œå¯¹æ‰€æœ‰çš„è¡¨è¿›è¡Œé”å®šï¼Œä»è€Œè·å¾—ä¸€è‡´æ€§è§†å›¾ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚ flush tables with read lock; unlock tables; ä½†æ˜¯åŠ å…¨å±€é”æ˜¯ä¸ªéå¸¸é‡çš„æ“ä½œï¼š è‹¥åœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆä¸šåŠ¡å°±å¾—åœæ‘†ï¼› è‹¥åœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆå¤‡ä»½æœŸé—´ä»åº“ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥ï¼Œä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚ åœ¨ InnoDB ä¸Šå¤‡ä»½æ—¶ï¼ŒåŠ ä¸Šå‚æ•°â€“single-transactionå‚æ•°å¯ä»¥å®Œæˆä¸åŠ é”çš„ä¸€è‡´æ€§æ•°æ®å¤‡ä»½ã€‚è¿™ç§æ–¹å¼å®é™…ä¸Šæ˜¯é€šè¿‡å¿«ç…§å®ç°çš„ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:7:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"6.2 è¡¨çº§é” **è¡¨å…±äº«é”(read lock)ï¼š**å¤§å®¶(åŒ…æ‹¬è‡ªå·±)éƒ½å¯ä»¥è¯»ï¼Œä½†éƒ½ä¸å¯ä»¥å†™ **è¡¨æ’ä»–é”(write lock)ï¼š**è‡ªå·±å¯ä»¥è¯»å†™ï¼Œåˆ«äººä¸å¯ä»¥è¯»å†™ # åŠ é” lock tables è¡¨å... read/write # é‡Šæ”¾é” unlock tables /å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ å…ƒæ•°æ®é”(meta data lockï¼ŒMDL)ï¼šMDLåŠ é”è¿‡ç¨‹æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ§åˆ¶ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€å¼ è¡¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ ä¸Šã€‚MDLé”ä¸»è¦ä½œç”¨æ˜¯ç»´æŠ¤è¡¨å…ƒæ•°æ®çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåœ¨è¡¨ä¸Šæœ‰æ´»åŠ¨äº‹åŠ¡æ—¶ï¼Œä¸å¯ä»¥å¯¹å…ƒæ•°æ®è¿›è¡Œå†™å…¥æ“ä½œã€‚ å¯¹è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥æ—¶ï¼ŒåŠ MDLè¯»é”(å…±äº«é”)ï¼›å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´æ“ä½œæ—¶ï¼ŒåŠ MDLå†™é”(æ’ä»–é”)ã€‚ æ„å‘é”â­ï¼šä¸ºäº†é¿å…DMLåœ¨æ‰§è¡Œæ—¶ï¼ŒåŠ çš„è¡Œé”ä¸è¡¨é”çš„å†²çªï¼Œåœ¨InnoDBä¸­å¼•å…¥äº†æ„å‘é”ï¼Œä½¿è¡¨é”ä¸ç”¨æ£€æŸ¥æ¯è¡Œæ•°æ®æ˜¯å¦å·²è¢«åŠ é”ï¼Œ==ä½¿ç”¨æ„å‘é”æ¥å‡å°‘è¡¨é”å¯¹è¡Œé”çš„æ£€æŸ¥==ã€‚ **æ„å‘å…±äº«é”(IS)ï¼š**ä¸è¡¨å…±äº«é”(read)å…¼å®¹ï¼Œä¸è¡¨æ’ä»–é”(write)äº’æ–¥ï¼› **æ„å‘æ’ä»–é”(IX)ï¼š**ä¸è¡¨å…±äº«é”(read)åŠè¡¨æ’ä»–é”(write)éƒ½äº’æ–¥ã€‚ æ„å‘é”æ˜¯æœ‰æ•°æ®å¼•æ“è‡ªå·±ç»´æŠ¤çš„ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œæ„å‘é”ï¼Œåœ¨ä¸ºæ•°æ®è¡ŒåŠ å…±äº«/æ’ä»–é”ä¹‹å‰ï¼ŒInnoDB ä¼šå…ˆè·å–è¯¥æ•°æ®è¡Œæ‰€åœ¨åœ¨æ•°æ®è¡¨çš„å¯¹åº”æ„å‘é”ã€‚ ==æ„å‘é”ä¹‹é—´ä¸ä¼šäº’æ–¥ã€‚== IS é” IX é” IS é” å…¼å®¹ å…¼å®¹ IX é” å…¼å®¹ å…¼å®¹ æ„å‘é”å’Œå…±äº«é”å’Œæ’å®ƒé”äº’æ–¥ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯è¡¨çº§åˆ«çš„å…±äº«é”å’Œæ’ä»–é”ï¼Œæ„å‘é”ä¸ä¼šä¸è¡Œçº§çš„å…±äº«é”å’Œæ’ä»–é”äº’æ–¥ï¼‰ã€‚ IS é” IX é” S é” å…¼å®¹ äº’æ–¥ X é” äº’æ–¥ äº’æ–¥ é—®ï¼šæ„å‘é”æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ ä½¿ç”¨è¡¨é”ä¹‹å‰ï¼Œå¦‚æœå·²ç»æœ‰è¡Œé”å­˜åœ¨ï¼Œå°±ä¼šå†²çªï¼Œå› æ­¤éœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”ï¼Œä½†æ˜¯ä¸€è¡Œä¸€è¡Œæ‰«æçš„æ•ˆç‡å¤ªä½ï¼Œæ­¤æ—¶å°±ä¼šç”¨åˆ°æ„å‘é”ã€‚ åœ¨åŠ è¡Œé”ä¹‹åï¼Œä¼šå¯¹è¡¨åŠ ä¸€ä¸ªæ„å‘é”ï¼Œä¹‹åå†åŠ è¡¨é”æ—¶ï¼Œåªéœ€æ£€æŸ¥æ˜¯å¦æœ‰æ„å‘é”å³å¯ã€‚å½“æ£€æŸ¥æ„å‘é”å’Œè¦åŠ çš„è¡¨é”æ˜¯å…¼å®¹çš„ï¼Œé‚£ç›´æ¥åŠ ï¼Œå¦‚æœå†²çªï¼Œå°±ä¼šé˜»å¡ï¼Œç›´åˆ°æ„å‘é”é‡Šæ”¾ã€‚ ä¾‹ï¼šäº‹åŠ¡Aå¯¹è¡¨ä¸­æŸè¡Œè¿›è¡Œä¿®æ”¹ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨åŠ ä¸Šè¡Œé”ï¼ŒåŒæ—¶è¿˜ä¼šå¯¹è¡¨åŠ ä¸Šæ„å‘æ’ä»–é”ï¼Œæ­¤æ—¶è‹¥äº‹åŠ¡Bå‘è¡¨åŠ é”(å…±äº«é”/æ’ä»–é”)ï¼Œéƒ½ä¸èƒ½æˆåŠŸï¼Œå› ä¸ºæœ‰æ„å‘æ’ä»–é”ã€‚ é—®ï¼šå…±äº«é”å’Œæ’ä»–é”ï¼Ÿ å…±äº«é”ï¼ˆS é”ï¼‰ï¼šäº‹åŠ¡åœ¨è¯»å–æ—¶è·å¾—ï¼›å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ï¼ˆé”å…¼å®¹ï¼‰ã€‚ æ’ä»–é”ï¼ˆX é”ï¼‰ï¼šäº‹åŠ¡åœ¨ä¿®æ”¹çš„æ—¶è·å¾—ï¼›ä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ã€‚å¦‚æœä¸€ä¸ªè®°å½•å·²ç»è¢«åŠ äº†æ’ä»–é”ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¸èƒ½å†å¯¹è¿™æ¡äº‹åŠ¡åŠ ä»»ä½•ç±»å‹çš„é”ï¼ˆé”ä¸å…¼å®¹ï¼‰ã€‚åªå…è®¸è·å¾—è¯¥é”çš„äº‹åŠ¡è¯»å†™ï¼Œä¸å…è®¸å…¶ä»–äº‹åŠ¡æ“ä½œã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:7:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"6.3 è¡Œçº§é” åˆ†ç±»ï¼š **è®°å½•é”ï¼š**é”å®šå•è¡Œè®°å½•çš„é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¯¥è¡Œè¿›è¡Œupdateå’Œdeleteã€‚åœ¨RCã€RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒã€‚ **é—´éš™é”ï¼š**é”å®šç´¢å¼•è®°å½•é—´éš™ï¼ˆä¸å«è¯¥è®°å½•ï¼‰ï¼Œç¡®ä¿ç´¢å¼•è®°å½•é—´éš™ä¸å˜ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™è¿›è¡Œinsertï¼Œäº§ç”Ÿå¹»è¯»ã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹æ”¯æŒã€‚ **ä¸´é”®é”â­ï¼š**è¡Œé”å’Œé—´éš™é”çš„ç»„åˆï¼Œé”ä½è¯¥è¡Œæ•°æ®ï¼ŒåŠè¯¥è¡Œå‰çš„é—´éš™ã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹æ”¯æŒã€‚ æ’å…¥æ„å‘é”â­ï¼šå¦‚æœæŸä¸ªé—´éš™è¢«é—´éš™é”é”å®šï¼Œå…¶ä»–äº‹åŠ¡è¿›è¡Œæ’å…¥æ—¶å°±ä¼šé˜»å¡ï¼Œç›´åˆ°é—´éš™é”é‡Šæ”¾ï¼Œåœ¨æ­¤æœŸé—´ä¼šç”Ÿæˆä¸€ä¸ªæ’å…¥æ„å‘é”ï¼Œè¡¨æ˜æœ‰äº‹åŠ¡æƒ³åœ¨æŸä¸ªåŒºé—´æ’å…¥æ–°è®°å½•ï¼Œä½†æ˜¯ç°åœ¨å¤„äºç­‰å¾…çŠ¶æ€ã€‚æ’å…¥æ„å‘é”æ˜¯ç‰¹æ®Šçš„é—´éš™é”ï¼Œä¸äº’æ–¥ã€‚ é—´éš™é”çš„å”¯ä¸€ç›®çš„æ˜¯ï¼šé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥è¯¥é—´éš™ï¼Œè§£å†³å¹»è¯»ã€‚é—´éš™é”æ˜¯å…±äº«é”ï¼Œå³å…è®¸å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€é—´éš™ä¸Šé‡‡ç”¨é—´éš™é”ã€‚ é—®ï¼šä¸´é”®é”çš„èŒƒå›´ï¼Ÿ å”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ï¼Œæ•°æ®å­˜åœ¨æ—¶ï¼Œä¼šåŠ è¡Œé”ï¼› å”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ï¼Œæ•°æ®ä¸å­˜åœ¨ï¼Œä¼šå¯¹æŸ¥è¯¢æ¡ä»¶ä¸»é”®æ‰€åœ¨çš„é—´éš™åŠ é—´éš™é”ï¼› æ™®é€šç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ï¼Œæ•°æ®å­˜åœ¨æ—¶ï¼Œä¼šå¯¹è¯¥æ•°æ®å‰åç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„ä¸¤ç«¯ä¹‹é—´çš„æ‰€æœ‰é—´éš™åŠ é—´éš™é”ï¼Œç›¸åŒæ•°æ®çš„è¡Œéƒ½åŠ è¡Œé”ï¼Œè¿™æ˜¯å› ä¸ºæ™®é€šç´¢å¼•å¯èƒ½ä¼šæ’å…¥ç›¸åŒçš„æ•°æ®ï¼Œæ‰€ä»¥è¿™äº›é—´éš™éƒ½å¾—åŠ é”ï¼›å¦‚æœæ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œé‚£ä¹ˆè¯¥èŒƒå›´å†…å­˜åœ¨çš„æ•°æ®çš„è¡Œéƒ½åŠ è¡Œé”ï¼Œå…¶ä½™åŒºé—´éƒ½åŠ é—´éš™é”ã€‚ é—®ï¼šä¸ºä»€ä¹ˆä¼šäº§ç”Ÿæ­»é”ï¼Ÿ å…³é”®ç‚¹ï¼š Innodb å¼•æ“ä¸ºäº†è§£å†³**ã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«ä¸‹çš„å¹»è¯»é—®é¢˜ï¼Œå¼•å‡ºäº†next-key é”**ï¼Œå®ƒæ˜¯è®°å½•é”å’Œé—´éš™é”çš„ç»„åˆã€‚ è¡Œé”çš„é‡Šæ”¾æ—¶æœºæ˜¯åœ¨äº‹åŠ¡æäº¤ï¼ˆcommitï¼‰åï¼Œé”æ‰ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸æ˜¯ä¸€æ¡è¯­å¥æ‰§è¡Œå®Œå°±é‡Šæ”¾è¡Œé”ã€‚ ä¾‹ï¼Œè¡¨ä¸­æ•°æ®èŒƒå›´[1001-1006]ï¼Œä¸€ä¸ªäº‹åŠ¡è¦æ’å…¥è®¢å• 1007 ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¦æ’å…¥è®¢å• 1008ï¼Œè¦å…ˆæŸ¥è¯¢è¯¥è®¢å•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨æ‰æ’å…¥è®°å½•ï¼š ä¸ºäº†é˜²æ­¢å¹»è¯»å˜›ï¼ŒæŸ¥è¯¢æ—¶(æ³¨æ„è¿™ä¸æ˜¯æ™®é€šçš„å¿«ç…§è¯»ï¼)ï¼Œselect ... for update è¯­å¥ä¼šåŠ ä¸´é”®é”ï¼Œæ­¤æ—¶é€€åŒ–æˆé—´éš™é”ï¼Œé—´éš™é”ä¸é—´éš™é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œå› æ­¤æ­¤æ—¶Aã€Béƒ½è·å¾—äº†é—´éš™é”ï¼› æ’å…¥æ—¶ï¼Œinsertè¯­å¥ä¼šåœ¨æ’å…¥é—´éš™ä¸Šè·å–æ’å…¥æ„å‘é”ï¼Œè€Œ==æ’å…¥æ„å‘é”ä¸é—´éš™é”æ˜¯å†²çªçš„==ï¼Œè·å¾—æ’å…¥æ„å‘é”åï¼Œéœ€è¦ç­‰å¾…é—´éš™é”é‡Šæ”¾ï¼Œæ­¤æ—¶Aã€Béƒ½è·å¾—äº†æ’å…¥æ„å‘é”ï¼Œä½†éƒ½ç­‰å¾…å½¼æ­¤çš„é—´éš™é”é‡Šæ”¾ï¼Œé€ æˆæ­»é”ã€‚ æ»¡è¶³äº†æ­»é”çš„å››ä¸ªæ¡ä»¶ï¼šäº’æ–¥ã€ä¿æŒä¸è¯·æ±‚ã€ä¸å¯è¢«æŠ¢å ã€å¾ªç¯ç­‰å¾…ï¼Œå› æ­¤å‘ç”Ÿäº†æ­»é”ã€‚ **æ³¨ï¼š**ä¸ºä»€ä¹ˆé—´éš™é”ä¸é—´éš™é”æ˜¯å…¼å®¹çš„ï¼Ÿ é—´éš™é”çš„æ„ä¹‰åªåœ¨äºé˜»æ­¢åŒºé—´è¢«æ’å…¥ï¼Œå› æ­¤æ˜¯å¯ä»¥å…±å­˜çš„ã€‚å…±äº«å’Œæ’ä»–çš„é—´éš™é”æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œä»–ä»¬ç›¸äº’ä¸å†²çªï¼Œä¸”åŠŸèƒ½ç›¸åŒï¼Œå³ä¸¤ä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰åŒ…å«å…±åŒé—´éš™çš„é—´éš™é”ã€‚ ==å¦å¤–ï¼Œ==è™½ç„¶ç›¸åŒèŒƒå›´çš„é—´éš™é”æ˜¯å¤šä¸ªäº‹åŠ¡ç›¸äº’å…¼å®¹çš„ï¼Œä½†å¯¹äº==è®°å½•é”==ï¼Œè¿˜æ˜¯è¦è€ƒè™‘ X å‹ä¸ S å‹å…³ç³»ï¼ŒX å‹çš„è®°å½•é”ä¸ X å‹çš„è®°å½•é”æ˜¯å†²çªçš„ï¼ï¼ï¼ é—®ï¼šå¦‚ä½•é¿å…æ­»é”ï¼Ÿ æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼šäº’æ–¥ã€ä¿æŒä¸è¯·æ±‚ã€ä¸å¯è¢«æŠ¢å ã€å¾ªç¯ç­‰å¾…ã€‚åªè¦ç³»ç»Ÿå‘ç”Ÿæ­»é”ï¼Œè¿™äº›æ¡ä»¶å¿…ç„¶æˆç«‹ï¼Œä½†æ˜¯åªè¦ç ´åä»»æ„ä¸€ä¸ªæ¡ä»¶å°±æ­»é”å°±ä¸ä¼šæˆç«‹ã€‚ åœ¨æ•°æ®åº“å±‚é¢ï¼Œæœ‰ä¸¤ç§ç­–ç•¥é€šè¿‡**ã€Œæ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶ã€**æ¥è§£é™¤æ­»é”çŠ¶æ€ï¼š è®¾ç½®äº‹åŠ¡ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´ã€‚å½“ä¸€ä¸ªäº‹åŠ¡çš„ç­‰å¾…æ—¶é—´è¶…æ—¶ï¼Œå°±å¯¹è¿™ä¸ªäº‹åŠ¡è¿›è¡Œå›æ»šï¼Œäºæ˜¯é”å°±é‡Šæ”¾äº†ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚ å¼€å¯ä¸»åŠ¨æ­»é”æ£€æµ‹ã€‚ä¸»åŠ¨æ­»é”æ£€æµ‹åœ¨å‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:7:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¸ƒã€MVCC ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:8:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"7.1 æ¦‚å¿µ é—®ï¼šå½“å‰è¯»å’Œå¿«ç…§è¯»æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ **å¿«ç…§è¯»ï¼š**ä¸€è‡´æ€§éé”å®šè¯»ï¼Œå°±æ˜¯æ™®é€šçš„selectè¯­å¥ï¼› **å½“å‰è¯»ï¼š**ä¸€è‡´æ€§é”å®šè¯»ï¼Œä¼šç»™è¡ŒåŠ Xé”æˆ–Sé”ã€‚ # å¯¹è¯»çš„è®°å½•åŠ ä¸€ä¸ªXé” SELECT...FOR UPDATE # å¯¹è¯»çš„è®°å½•åŠ ä¸€ä¸ªSé” SELECT...LOCK IN SHARE MODE # å¯¹ä¿®æ”¹çš„è®°å½•åŠ ä¸€ä¸ªXé” INSERT... UPDATE... DELETE... å¿«ç…§è¯»æ—¶ï¼Œè‹¥è¯»å–çš„è®°å½•æ­£åœ¨è¿›è¡Œupdate/deleteæ“ä½œï¼Œå¿«ç…§è¯»ä¸ä¼šç­‰å¾…å…¶Xé”çš„é‡Šæ”¾ï¼Œè€Œæ˜¯ä¼šå»è¯»å–å¿«ç…§ã€‚åªæœ‰åœ¨äº‹åŠ¡éš”ç¦»çº§åˆ« RC(è¯»å–å·²æäº¤) å’Œ RRï¼ˆå¯é‡è¯»ï¼‰ä¸‹ï¼ŒInnoDB æ‰ä¼šä½¿ç”¨å¿«ç…§è¯»ï¼š åœ¨ RC çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œä¸€è‡´æ€§éé”å®šè¯»æ€»æ˜¯è¯»å–è¢«é”å®šè¡Œçš„æœ€æ–°ä¸€ä»½å¿«ç…§æ•°æ®ã€‚ åœ¨ RR çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œä¸€è‡´æ€§éé”å®šè¯»æ€»æ˜¯è¯»å–æœ¬äº‹åŠ¡å¼€å§‹æ—¶çš„è¡Œæ•°æ®ç‰ˆæœ¬ã€‚ å¿«ç…§è¯»æ¯”è¾ƒé€‚åˆå¯¹äºæ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ä¸”è¿½æ±‚æè‡´æ€§èƒ½çš„ä¸šåŠ¡åœºæ™¯ã€‚ å½“å‰è¯»æ—¶ï¼Œè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰äº‹åŠ¡ï¼Œæ‰€ä»¥ä¼šåŠ é”ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯MVCCï¼Ÿ **å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚**æŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå¿«ç…§è¯»ä¸ºå®ç°MVCCæä¾›äº†ä¸€ä¸ªéé˜»å¡è¯»åŠŸèƒ½ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:8:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"7.2 MVCCå®ç° MVCCçš„å®ç°ä¾èµ–äºæ•°æ®åº“ä¸­ï¼šä¸‰ä¸ªéšè—å­—æ®µã€undo logæ—¥å¿—ã€readViewã€‚ 7.2.1 éšè—å­—æ®µ DB_TRX_IDï¼šæœ€åä¸€æ¬¡æ’å…¥æˆ–æ›´æ–°æ”¹è¡Œçš„äº‹åŠ¡IDã€‚ DR_ROLL_PTRï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸Šä¸ªç‰ˆæœ¬ï¼Œå³undo logã€‚ DB_ROW_IDï¼šéšè—ä¸»é”®ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ä¸»é”®ä¸”æ²¡æœ‰å”¯ä¸€éç©ºç´¢å¼•æ—¶ï¼Œä¼šä½¿ç”¨è¯¥IDç”Ÿæˆèšé›†ç´¢å¼•ã€‚ 7.2.2 undo log å›æ»šæ—¥å¿—ã€‚åœ¨ insertã€updateã€deleteçš„æ—¶å€™äº§ç”Ÿçš„ä¾¿äºæ•°æ®å›æ»šçš„æ—¥å¿—ã€‚ insert undo logï¼šinsertæ—¶äº§ç”Ÿçš„undo logã€‚åªåœ¨å›æ»šæ—¶éœ€è¦ï¼Œäº‹åŠ¡æäº¤åï¼Œå¯ç«‹å³è¢«åˆ é™¤ã€‚ update undo logï¼šupdate/deleteæ—¶äº§ç”Ÿçš„undo logã€‚ä¸ä»…åœ¨å›æ»šæ—¶éœ€è¦ï¼Œåœ¨å¿«ç…§è¯»æ—¶ä¹Ÿéœ€è¦ï¼Œå› æ­¤ä¸ä¼šè¢«ç«‹å³åˆ é™¤ã€‚ 7.2.3 readview ReadView(è¯»è§†å›¾)æ˜¯å¿«ç…§è¯» SQL æ‰§è¡Œæ—¶ MVCC æå–æ•°æ®çš„ä¾æ®ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒçš„äº‹åŠ¡(æœªæäº¤çš„)IDã€‚ åŒ…å«ä»¥ä¸‹å­—æ®µï¼š **m_low_limit_idï¼š**ç›®å‰å‡ºç°è¿‡çš„æœ€å¤§çš„äº‹åŠ¡ ID+1ï¼Œå³ä¸‹ä¸€ä¸ªå°†è¢«åˆ†é…çš„äº‹åŠ¡ IDã€‚å¤§äºç­‰äºè¿™ä¸ª ID çš„æ•°æ®ç‰ˆæœ¬å‡ä¸å¯è§ **m_up_limit_idï¼š**æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ m_ids ä¸­æœ€å°çš„äº‹åŠ¡ IDï¼Œå¦‚æœ m_ids ä¸ºç©ºï¼Œåˆ™ m_up_limit_id ä¸º m_low_limit_idã€‚å°äºè¿™ä¸ª ID çš„æ•°æ®ç‰ˆæœ¬å‡å¯è§ m_idsï¼šRead View åˆ›å»ºæ—¶å…¶ä»–æœªæäº¤çš„æ´»è·ƒäº‹åŠ¡ ID åˆ—è¡¨ã€‚åˆ›å»º Read View æ—¶ï¼Œå°†å½“å‰æœªæäº¤äº‹åŠ¡ ID è®°å½•ä¸‹æ¥ï¼Œåç»­å³ä½¿å®ƒä»¬ä¿®æ”¹äº†è®°å½•è¡Œçš„å€¼ï¼Œå¯¹äºå½“å‰äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚m_ids ä¸åŒ…æ‹¬å½“å‰äº‹åŠ¡è‡ªå·±å’Œå·²æäº¤çš„äº‹åŠ¡ï¼ˆæ­£åœ¨å†…å­˜ä¸­ï¼‰ **m_creator_trx_idï¼š**åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡ ID é—®ï¼šMVCCçš„å®ç°åŸç†ï¼Ÿâ­â­ MVCC çš„å®ç°ä¸»è¦ä¾èµ–ï¼š Read Viewï¼› èšç°‡ç´¢å¼•ä¸­çš„è·Ÿäº‹åŠ¡ç›¸å…³çš„ä¸¤ä¸ªéšè—åˆ—[trx_id, undo_log]ã€‚ ==Read View çš„ç»“æ„ï¼š== creator_trx_idï¼šæŒ‡çš„æ˜¯åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡çš„äº‹åŠ¡ idï¼› m_idsï¼šæŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€çš„äº‹åŠ¡ id åˆ—è¡¨ã€‚æ³¨æ„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œâ€œæ´»è·ƒäº‹åŠ¡â€æŒ‡çš„å°±æ˜¯ï¼Œå¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤çš„äº‹åŠ¡ï¼› **min_trx_idï¼š**æŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€ä¸­äº‹åŠ¡ id æœ€å°çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ m_ids çš„æœ€å°å€¼ï¼› max_trx_idï¼šè¿™ä¸ªå¹¶ä¸æ˜¯ m_ids çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯åˆ›å»º Read View æ—¶å½“å‰æ•°æ®åº“ä¸­åº”è¯¥ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼ï¼Œä¹Ÿå°±æ˜¯å…¨å±€äº‹åŠ¡ä¸­æœ€å¤§çš„äº‹åŠ¡ id å€¼ + 1ã€‚ ==èšç°‡ç´¢å¼•çš„ä¸¤ä¸ªéšè—åˆ—ï¼š== trx_idï¼šå½“ä¸€ä¸ªäº‹åŠ¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œå°±ä¼šæŠŠè¯¥äº‹åŠ¡çš„äº‹åŠ¡ id è®°å½•åœ¨ trx_id éšè—åˆ—é‡Œï¼› roll_pointerï¼šæ¯æ¬¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§ç‰ˆæœ¬çš„è®°å½•å†™å…¥åˆ° undo æ—¥å¿—ä¸­ï¼Œç„¶åroll_pointer æŒ‡å‘æ—§ç‰ˆæœ¬è®°å½•ï¼Œé€šè¿‡å®ƒæ‰¾åˆ°ä¿®æ”¹å‰çš„è®°å½•ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œèšç°‡ç´¢å¼•ä¸­æ¯è¡Œè®°å½•éƒ½ä¼šæœ‰ä¸ªtrx_idï¼Œå¯ä»¥å°†**æ‰€æœ‰è®°å½•çš„trx_id**åˆ’åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š ä¸€ä¸ªäº‹åŠ¡å»è®¿é—®è®°å½•æ—¶ï¼Œè‡ªå·±çš„æ›´æ–°æ€»æ˜¯å¯è§çš„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼š è‹¥å½“å‰è®°å½•çš„trx_id \u003c Read View ä¸­çš„min_trx_idï¼Œè¯´æ˜æ˜¯åˆ›å»ºRead Viewä¹‹å‰å·²ç»æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¯¥è®°å½•å¯¹å½“å‰äº‹åŠ¡å¯è§ï¼› è‹¥å½“å‰è®°å½•çš„trx_id \u003e= Read View ä¸­çš„max_trx_idï¼Œè¯´æ˜æ˜¯åˆ›å»ºRead Viewä¹‹åæ‰å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¯¥è®°å½•å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ï¼› è‹¥å½“å‰è®°å½•çš„trx_id åœ¨min_trx_idå’Œmax_trx_idä¹‹é—´ï¼Œéœ€è¦åˆ¤æ–­trx_idæ˜¯å¦å­˜åœ¨m_idsåˆ—è¡¨ä¸­ï¼š è‹¥å­˜åœ¨ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡ä¾ç„¶æ´»è·ƒ(ä¹Ÿå°±æ˜¯è¿˜æ²¡æäº¤å‘¢)ï¼Œæ‰€ä»¥è¯¥è®°å½•å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ï¼Œå°±ä¼šé¡ºç€ undo log é“¾å¯»æ‰¾æ—§ç‰ˆæœ¬æ•°æ®ï¼› è‹¥ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºRead Viewä¹‹å‰å·²ç»æäº¤äº†ï¼Œæ‰€ä»¥è¯¥è®°å½•å¯¹å½“å‰äº‹åŠ¡å¯è§ã€‚ è¿™ç§é€šè¿‡ã€Œç‰ˆæœ¬é“¾ã€æ¥æ§åˆ¶å¹¶å‘äº‹åŠ¡è®¿é—®åŒä¸€ä¸ªè®°å½•æ—¶çš„è¡Œä¸ºå°±å« MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ã€‚ é—®ï¼šRCå’ŒRRéš”ç¦»çº§åˆ«ä¸‹MVCCçš„å·®å¼‚ï¼Ÿ åœ¨ RC éš”ç¦»çº§åˆ«ä¸‹çš„ æ¯æ¬¡select æŸ¥è¯¢å‰éƒ½ç”Ÿæˆä¸€ä¸ªRead View (m_ids åˆ—è¡¨) åœ¨ RR éš”ç¦»çº§åˆ«ä¸‹åªåœ¨äº‹åŠ¡å¼€å§‹å ç¬¬ä¸€æ¬¡select æ•°æ®å‰ç”Ÿæˆä¸€ä¸ªRead Viewï¼ˆm_ids åˆ—è¡¨ï¼‰ é—®ï¼šMVCC+ä¸´é”®é” é˜²æ­¢å¹»è¯»ï¼Ÿ 1ã€æ‰§è¡Œæ™®é€š selectï¼Œæ­¤æ—¶ä¼šä»¥ MVCC å¿«ç…§è¯»çš„æ–¹å¼è¯»å–æ•°æ® åœ¨å¿«ç…§è¯»çš„æƒ…å†µä¸‹ï¼ŒRR éš”ç¦»çº§åˆ«åªä¼šåœ¨äº‹åŠ¡å¼€å¯åçš„ç¬¬ä¸€æ¬¡æŸ¥è¯¢ç”Ÿæˆ Read View ï¼Œå¹¶ä½¿ç”¨è‡³äº‹åŠ¡æäº¤ã€‚æ‰€ä»¥åœ¨ç”Ÿæˆ Read View ä¹‹åå…¶å®ƒäº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€æ’å…¥è®°å½•ç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡å¹¶ä¸å¯è§ï¼Œå®ç°äº†å¯é‡å¤è¯»å’Œé˜²æ­¢å¿«ç…§è¯»ä¸‹çš„ â€œå¹»è¯»â€ 2ã€æ‰§è¡Œ selectâ€¦for update/lock in share modeã€insertã€updateã€delete ç­‰å½“å‰è¯» åœ¨å½“å‰è¯»ä¸‹ï¼Œè¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œå¦‚æœå…¶å®ƒäº‹åŠ¡æœ‰æ’å…¥æ–°çš„è®°å½•ï¼Œå¹¶ä¸”åˆšå¥½åœ¨å½“å‰äº‹åŠ¡æŸ¥è¯¢èŒƒå›´å†…ï¼Œå°±ä¼šäº§ç”Ÿå¹»è¯»ï¼InnoDB ä½¿ç”¨ Next-key Lockopen in new window æ¥é˜²æ­¢è¿™ç§æƒ…å†µã€‚**å½“æ‰§è¡Œå½“å‰è¯»æ—¶ï¼Œä¼šé”å®šè¯»å–åˆ°çš„è®°å½•çš„åŒæ—¶ï¼Œé”å®šå®ƒä»¬çš„é—´éš™ï¼Œé˜²æ­¢å…¶å®ƒäº‹åŠ¡åœ¨æŸ¥è¯¢èŒƒå›´å†…æ’å…¥æ•°æ®ã€‚**åªè¦æˆ‘ä¸è®©ä½ æ’å…¥ï¼Œå°±ä¸ä¼šå‘ç”Ÿå¹»è¯»ã€‚ å…¶å®å°±æ˜¯ï¼š å¿«ç…§è¯»æ—¶ï¼Œé€šè¿‡åªåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ç”ŸæˆRead Viewï¼Œæ¥é˜²æ­¢å¹»è¯»ï¼› å½“å‰è¯»æ—¶ï¼Œé€šè¿‡åŠ ä¸´é”®é”ï¼Œæ‹’ç»æ•°æ®æ’å…¥ï¼Œæ¥é˜²æ­¢å¹»è¯»ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:8:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"å…«ã€æ•°æ®ç±»å‹ è¿™ç‚¹ä¹‹å‰æ²¡è®°ï¼Œç°åœ¨è¡¥å……ä¸€ä¸‹~ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:9:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"8.1 è¡¨ç©ºé—´çš„æ–‡ä»¶ç»“æ„ è¡Œ æ•°æ®åº“è¡¨ä¸­çš„è®°å½•éƒ½æ˜¯æŒ‰è¡Œï¼ˆrowï¼‰è¿›è¡Œå­˜æ”¾çš„ï¼Œæ¯è¡Œè®°å½•æ ¹æ®ä¸åŒçš„è¡Œæ ¼å¼ï¼Œæœ‰ä¸åŒçš„å­˜å‚¨ç»“æ„ã€‚ é¡µ InnoDB çš„æ•°æ®æ˜¯æŒ‰**ã€Œé¡µã€ä¸ºå•ä½æ¥è¯»å†™**ï¼Œä¸€æ¬¡I/Oæ“ä½œè¯»å–ä¸€é¡µï¼Œé»˜è®¤æ¯ä¸ªé¡µçš„å¤§å°ä¸º 16KBï¼Œä¹Ÿå°±æ˜¯æœ€å¤šèƒ½ä¿è¯ 16KB çš„è¿ç»­å­˜å‚¨ç©ºé—´ã€‚é¡µæ˜¯ InnoDB å­˜å‚¨å¼•æ“ç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ„å‘³ç€æ•°æ®åº“æ¯æ¬¡è¯»å†™éƒ½æ˜¯ä»¥ 16KB ä¸ºå•ä½çš„ï¼Œä¸€æ¬¡æœ€å°‘ä»ç£ç›˜ä¸­è¯»å– 16K çš„å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œä¸€æ¬¡æœ€å°‘æŠŠå†…å­˜ä¸­çš„ 16K å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ åŒº æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œä¸ºæŸä¸ªç´¢å¼•åˆ†é…ç©ºé—´çš„æ—¶å€™å°±ä¸å†æŒ‰ç…§é¡µä¸ºå•ä½åˆ†é…äº†ï¼Œè€Œæ˜¯æŒ‰ç…§åŒºï¼ˆextentï¼‰ä¸ºå•ä½åˆ†é…ã€‚æ¯ä¸ªåŒºçš„å¤§å°ä¸º 1MBï¼Œå¯¹äº 16KB çš„é¡µæ¥è¯´ï¼Œè¿ç»­çš„ 64 ä¸ªé¡µä¼šè¢«åˆ’ä¸ºä¸€ä¸ªåŒºï¼Œè¿™æ ·å°±ä½¿å¾—é“¾è¡¨ä¸­ç›¸é‚»çš„é¡µçš„ç‰©ç†ä½ç½®ä¹Ÿç›¸é‚»ï¼Œå°±èƒ½ä½¿ç”¨**é¡ºåº I/O **äº†ã€‚ æ®µ è¡¨ç©ºé—´æ˜¯ç”±å„ä¸ªæ®µï¼ˆsegmentï¼‰ç»„æˆçš„ï¼Œæ®µæ˜¯ç”±å¤šä¸ªåŒºï¼ˆextentï¼‰ç»„æˆçš„ã€‚æ®µä¸€èˆ¬åˆ†ä¸ºæ•°æ®æ®µã€ç´¢å¼•æ®µå’Œå›æ»šæ®µç­‰ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:9:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"8.2 è¡Œæ ¼å¼ ç°åœ¨ç”¨çš„éƒ½æ˜¯ Compact è¡Œæ ¼å¼ï¼Œä¸€æ¡å®Œæ•´çš„è®°å½•åˆ†ä¸ºã€Œè®°å½•çš„é¢å¤–ä¿¡æ¯ã€å’Œã€Œè®°å½•çš„çœŸå®æ•°æ®ã€ä¸¤ä¸ªéƒ¨åˆ†ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:9:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¹ã€æ—¥å¿— æ›´æ–°è¯­å¥çš„æµç¨‹ä¼šæ¶‰åŠåˆ° undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ã€redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ ã€bin logï¼ˆå½’æ¡£æ—¥å¿—ï¼‰è¿™ä¸‰ç§æ—¥å¿—ã€‚ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼šæ˜¯ Innodb å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„åŸå­æ€§ï¼Œä¸»è¦ç”¨äºäº‹åŠ¡å›æ»šå’Œ MVCCï¼› redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼šæ˜¯ Innodb å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„æŒä¹…æ€§ï¼Œä¸»è¦ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤ï¼› bin logï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ï¼šæ˜¯ Server å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œä¸»è¦ç”¨äºæ•°æ®å¤‡ä»½å’Œä¸»ä»å¤åˆ¶ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:10:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"undo log å’Œ redo log é—®ï¼šundo log æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ undo log æ˜¯ä¸€ç§ç”¨äºå›é€€æ’¤é”€çš„æ—¥å¿—ã€‚åœ¨äº‹åŠ¡æ²¡æäº¤ä¹‹å‰ï¼ŒMySQL ä¼šå…ˆæŠŠæ›´æ–°å‰çš„æ•°æ®è®°å½•åˆ° undo log æ—¥å¿—æ–‡ä»¶é‡Œé¢ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œå¯ä»¥åˆ©ç”¨ undo log æ¥è¿›è¡Œå›æ»šã€‚ æ¯å½“ InnoDB å¼•æ“å¯¹ä¸€æ¡è®°å½•è¿›è¡Œæ›´æ–°(ä¿®æ”¹ã€åˆ é™¤ã€æ–°å¢)æ—¶ï¼Œè¦æŠŠå›æ»šæ—¶éœ€è¦çš„ä¿¡æ¯éƒ½è®°å½•åˆ° undo log é‡Œã€‚ å¦å¤–ï¼Œundo log è¿˜å¯ä»¥ä¸²æˆé“¾è¡¨ï¼Œç§°ä¸ºç‰ˆæœ¬é“¾ï¼Œç”¨æ¥å®ç° MVCCã€‚ å› æ­¤ï¼Œundo log å…±ä¸¤å¤§ä½œç”¨ï¼š å®ç°äº‹åŠ¡å›æ»šï¼Œä¿éšœäº‹åŠ¡çš„åŸå­æ€§ã€‚äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯æˆ–è€…ç”¨æˆ·æ‰§ è¡Œäº† ROLLBACK è¯­å¥ï¼ŒMySQL å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„å†å²æ•°æ®å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ã€‚ å®ç° MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰çš„å…³é”®å› ç´ ä¹‹ä¸€ã€‚MVCC æ˜¯é€šè¿‡ ReadView + undo log å®ç°çš„ã€‚undo log ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ï¼ŒMySQL åœ¨æ‰§è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š select è¯­å¥ï¼‰çš„æ—¶å€™ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ Read View é‡Œçš„ä¿¡æ¯ï¼Œé¡ºç€ undo log çš„ç‰ˆæœ¬é“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚ é—®ï¼šWAL æŠ€æœ¯ï¼Ÿ è¯´æ˜ redo log æœ‰å•¥ç”¨ä¹‹å‰ï¼Œéœ€è¦å…ˆä»‹ç» Buffer pool å’Œ WAL æŠ€æœ¯ã€‚ Buffer pool ç›¸å½“äºæ•°æ®åº“ä¸­çš„ç¼“å­˜ï¼Œä»¥é¡µä¸ºå•ä½ï¼Œè¯»å–æ•°æ®æ—¶ä¹Ÿå…ˆä»è¿™é‡Œè¯»ï¼Œæ›´æ–°æ•°æ®æ—¶ï¼Œä¹Ÿå…ˆå°è¯•æ›´æ–° Buffer pool ä¸­çš„æ•°æ®é¡µã€‚è‹¥ Buffer pool ä¸­çš„é¡µç›¸æ¯”åŸæ•°æ®åº“ä¸­çš„é¡µåšäº†ä¿®æ”¹ï¼Œå°±ç§°ä¸ºè„é¡µã€‚ å†…å­˜ä¸­çš„æ•°æ®è‹¥ä¸åˆ·ç›˜ï¼Œæ–­ç”µäº†å°±æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢æ–­ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œåœ¨ä¿®æ”¹ Buffer pool ä¸­çš„é¡µä¹‹åï¼Œä¼šå°†æœ¬æ¬¡å¯¹è¿™ä¸ªé¡µçš„ä¿®æ”¹ä»¥ redo log çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œç„¶åå®šæ—¶ç”±åå°çº¿ç¨‹å°†ç¼“å­˜åœ¨ Buffer Pool çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜é‡Œï¼Œè¿™ç§°ä¸º WAL(Write-Ahead Logging)æŠ€æœ¯ã€‚ WAL æŠ€æœ¯æŒ‡çš„æ˜¯ï¼ŒMySQL çš„å†™æ“ä½œå¹¶ä¸æ˜¯ç«‹åˆ»å†™åˆ°ç£ç›˜ä¸Šï¼Œè€Œæ˜¯å…ˆå†™æ—¥å¿—ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´å†å†™åˆ°ç£ç›˜ä¸Šã€‚ é—®ï¼šredo logæ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ redo log æ˜¯é‡åšæ—¥å¿—ï¼Œè®°å½•äº‹åŠ¡æäº¤æ—¶æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ã€‚è®°å½•äº†æŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œæ¯”å¦‚å¯¹ XXX è¡¨ç©ºé—´ä¸­çš„ YYY æ•°æ®é¡µ ZZZ åç§»é‡çš„åœ°æ–¹åšäº†AAA æ›´æ–°ï¼Œæ¯å½“æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡å°±ä¼šäº§ç”Ÿè¿™æ ·çš„ä¸€æ¡æˆ–è€…å¤šæ¡ç‰©ç†æ—¥å¿—ã€‚ åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œåªè¦å…ˆå°† redo log æŒä¹…åŒ–åˆ°ç£ç›˜å³å¯ï¼Œä¸éœ€è¦ç­‰åˆ°å°†ç¼“å­˜åœ¨ Buffer Pool é‡Œçš„è„é¡µæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œè™½ç„¶è„é¡µæ•°æ®æ²¡æœ‰æŒä¹…åŒ–ï¼Œä½†æ˜¯ redo log å·²ç»æŒä¹…åŒ–ï¼Œæ¥ç€ MySQL é‡å¯åï¼Œå¯ä»¥æ ¹æ® redo log çš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ•°æ®æ¢å¤åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚ é—®ï¼šundo log å’Œ redo log æœ‰å•¥åŒºåˆ«ï¼Ÿâ­â­ redo log è®°å½•äº†æ­¤æ¬¡äº‹åŠ¡ã€Œæäº¤åã€çš„æ•°æ®çŠ¶æ€ï¼Œè®°å½•çš„æ˜¯æ›´æ–°ä¹‹åçš„å€¼ï¼› undo log è®°å½•äº†æ­¤æ¬¡äº‹åŠ¡ã€Œå¼€å§‹å‰ã€çš„æ•°æ®çŠ¶æ€ï¼Œè®°å½•çš„æ˜¯æ›´æ–°ä¹‹å‰çš„å€¼ï¼› äº‹åŠ¡æäº¤ä¹‹å‰å‘ç”Ÿäº†å´©æºƒï¼Œé‡å¯åä¼šé€šè¿‡ undo log å›æ»šäº‹åŠ¡ï¼› äº‹åŠ¡æäº¤ä¹‹åå‘ç”Ÿäº†å´©æºƒï¼Œé‡å¯åä¼šé€šè¿‡ redo log æ¢å¤äº‹åŠ¡ã€‚ æ‰€ä»¥ï¼Œundo log ä¿è¯äº†åŸå­æ€§ï¼Œredo log ä¿è¯äº†æŒä¹…æ€§ã€‚ é—®ï¼šredo log ä¼šæ»¡å—ï¼Ÿ ä¼šã€‚redo log ç±»ä¼¼ Redis çš„ repl_backlogï¼Œä¹Ÿæ˜¯ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œå½“å†™æ»¡äº†ä¹‹åï¼Œå°±ä¼šè§¦å‘ buffer pool çš„åˆ·ç›˜æ“ä½œï¼Œç„¶åæ“¦é™¤æ—§çš„ redo logï¼Œå°±å¯ä»¥ç»§ç»­å†™å…¥äº†~ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:10:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"bin log é—®ï¼šä»€ä¹ˆæ˜¯ bin logï¼Ÿ bin log æ˜¯ç”± MySQL çš„ Server å±‚ç”Ÿæˆçš„ã€‚ bin log æ–‡ä»¶è®°å½•äº†æ‰€æœ‰æ•°æ®åº“è¡¨ç»“æ„å˜æ›´å’Œè¡¨æ•°æ®ä¿®æ”¹çš„æ—¥å¿—ï¼Œä¸ä¼šè®°å½•æŸ¥è¯¢ç±»çš„æ“ä½œï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚ é—®ï¼šä¸ºä»€ä¹ˆæœ‰äº† bin log è¿˜è¦æœ‰ redo logï¼Ÿè¿™ä¿©æœ‰å•¥åŒºåˆ«ï¼Ÿ è¿™è·Ÿ MySQL çš„æ—¶é—´çº¿æœ‰å…³ç³»ã€‚ æœ€å¼€å§‹ MySQL é‡Œå¹¶æ²¡æœ‰ InnoDB å¼•æ“ï¼ŒMySQL è‡ªå¸¦çš„å¼•æ“æ˜¯ MyISAMï¼Œä½†æ˜¯ MyISAM æ²¡æœ‰ crash-safe çš„èƒ½åŠ›ï¼Œbin log æ—¥å¿—åªèƒ½ç”¨äºå½’æ¡£ã€‚ è€Œ InnoDB æ˜¯å¦ä¸€ä¸ªå…¬å¸ä»¥æ’ä»¶å½¢å¼å¼•å…¥ MySQL çš„ï¼Œæ—¢ç„¶åªä¾é  bin log æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ï¼Œæ‰€ä»¥ InnoDB ä½¿ç”¨ redo log æ¥å®ç° crash-safe èƒ½åŠ›ã€‚ åŒºåˆ«ï¼š é€‚ç”¨å¯¹è±¡ä¸åŒ bin log æ˜¯ MySQL çš„ Server å±‚å®ç°çš„ï¼Œæ‰€æœ‰çš„å­˜å‚¨å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ï¼› redo log æ˜¯ Innodb å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ç‹¬æœ‰çš„ã€‚ æ–‡ä»¶æ ¼å¼ä¸åŒ bin log æœ‰ 3 ç§æ ¼å¼ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ STATEMENTï¼ˆé»˜è®¤æ ¼å¼ï¼‰ã€ROWã€ MIXEDã€‚åŒºåˆ«å¦‚ä¸‹ï¼š STATEMENTï¼šæ¯ä¸€æ¡ä¿®æ”¹æ•°æ®çš„ SQL éƒ½ä¼šè¢«è®°å½•åˆ° binlog ä¸­ï¼ˆç›¸å½“äºè®°å½•äº†é€»è¾‘æ“ä½œï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ç§æ ¼å¼ï¼Œ binlog å¯ä»¥ç§°ä¸ºé€»è¾‘æ—¥å¿—ï¼‰ï¼Œä¸»ä»å¤åˆ¶ä¸­ slave ç«¯å†æ ¹æ® SQL è¯­å¥é‡ç°ã€‚ä½† STATEMENT æœ‰åŠ¨æ€å‡½æ•°çš„é—®é¢˜ï¼Œæ¯”å¦‚ä½ ç”¨äº† uuid æˆ–è€… now è¿™äº›å‡½æ•°ï¼Œä½ åœ¨ä¸»åº“ä¸Šæ‰§è¡Œçš„ç»“æœå¹¶ä¸æ˜¯ä½ åœ¨ä»åº“æ‰§è¡Œçš„ç»“æœï¼Œè¿™ç§éšæ—¶åœ¨å˜çš„å‡½æ•°ä¼šå¯¼è‡´å¤åˆ¶çš„æ•°æ®ä¸ä¸€è‡´ï¼› ROWï¼šè®°å½•æ¯è¡Œæ•°æ®æœ€ç»ˆè¢«ä¿®æ”¹æˆä»€ä¹ˆæ ·äº†ï¼ˆè¿™ç§æ ¼å¼çš„æ—¥å¿—ï¼Œå°±ä¸èƒ½ç§°ä¸ºé€»è¾‘æ—¥å¿—äº†ï¼‰ï¼Œä¸ä¼šå‡ºç° STATEMENT ä¸‹åŠ¨æ€å‡½æ•°çš„é—®é¢˜ã€‚ä½† ROW çš„ç¼ºç‚¹æ˜¯æ¯è¡Œæ•°æ®çš„å˜åŒ–ç»“æœéƒ½ä¼šè¢«è®°å½•ï¼Œæ¯”å¦‚æ‰§è¡Œæ‰¹é‡ update è¯­å¥ï¼Œæ›´æ–°å¤šå°‘è¡Œæ•°æ®å°±ä¼šäº§ç”Ÿå¤šå°‘æ¡è®°å½•ï¼Œä½¿ binlog æ–‡ä»¶è¿‡å¤§ï¼Œè€Œåœ¨ STATEMENT æ ¼å¼ä¸‹åªä¼šè®°å½•ä¸€ä¸ª update è¯­å¥è€Œå·²ï¼› MIXEDï¼šåŒ…å«äº† STATEMENT å’Œ ROW æ¨¡å¼ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒçš„æƒ…å†µè‡ªåŠ¨ä½¿ç”¨ ROW æ¨¡å¼å’Œ STATEMENT æ¨¡å¼ï¼› redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯åœ¨æŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œæ¯”å¦‚å¯¹ XXX è¡¨ç©ºé—´ä¸­çš„ YYY æ•°æ®é¡µ ZZZ åç§»é‡çš„åœ°æ–¹åšäº†AAA æ›´æ–°ï¼› å†™å…¥æ–¹å¼ä¸åŒ bin log æ˜¯è¿½åŠ å†™ï¼Œå†™æ»¡ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç»§ç»­å†™ï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ï¼Œä¿å­˜çš„æ˜¯å…¨é‡çš„æ—¥å¿—ã€‚ redo log æ˜¯å¾ªç¯å†™ï¼Œæ—¥å¿—ç©ºé—´å¤§å°æ˜¯å›ºå®šï¼Œå…¨éƒ¨å†™æ»¡å°±ä»å¤´å¼€å§‹ï¼Œä¿å­˜æœªè¢«åˆ·å…¥ç£ç›˜çš„è„é¡µæ—¥å¿—ã€‚ ç”¨é€”ä¸åŒ bin log ç”¨äºå¤‡ä»½æ¢å¤ã€ä¸»ä»å¤åˆ¶ï¼› redo log ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤ã€‚ é—®ï¼šå¦‚æœä¸å°å¿ƒæ•´ä¸ªæ•°æ®åº“çš„æ•°æ®è¢«åˆ é™¤äº†ï¼Œèƒ½ä½¿ç”¨ redo log æ–‡ä»¶æ¢å¤æ•°æ®å—ï¼Ÿ ä¸å¯ä»¥ä½¿ç”¨ redo log æ–‡ä»¶æ¢å¤ï¼Œåªèƒ½ä½¿ç”¨ bin log æ–‡ä»¶æ¢å¤ã€‚ å› ä¸º redo log æ–‡ä»¶æ˜¯å¾ªç¯å†™ï¼Œæ˜¯ä¼šè¾¹å†™è¾¹æ“¦é™¤æ—¥å¿—çš„ï¼Œåªè®°å½•æœªè¢«åˆ·å…¥ç£ç›˜çš„æ•°æ®çš„ç‰©ç†æ—¥å¿—ï¼Œå·²ç»åˆ·å…¥ç£ç›˜çš„æ•°æ®éƒ½ä¼šä» redo log æ–‡ä»¶é‡Œæ“¦é™¤ã€‚ bin log æ–‡ä»¶ä¿å­˜çš„æ˜¯å…¨é‡çš„æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜äº†æ‰€æœ‰æ•°æ®å˜æ›´çš„æƒ…å†µï¼Œç†è®ºä¸Šåªè¦è®°å½•åœ¨ bin log ä¸Šçš„æ•°æ®ï¼Œéƒ½å¯ä»¥æ¢å¤ï¼Œæ‰€ä»¥å¦‚æœä¸å°å¿ƒæ•´ä¸ªæ•°æ®åº“çš„æ•°æ®è¢«åˆ é™¤äº†ï¼Œå¾—ç”¨ bin log æ–‡ä»¶æ¢å¤æ•°æ®ã€‚ é—®ï¼šæ‰§è¡Œ update çš„è¿‡ç¨‹ï¼Ÿ æ‰§è¡Œå™¨è´Ÿè´£å…·ä½“æ‰§è¡Œï¼Œä¼šè°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ï¼Œé€šè¿‡ä¸»é”®ç´¢å¼•æ ‘æœç´¢è·å– id = 1 è¿™ä¸€è¡Œè®°å½•ï¼š å¦‚æœ id=1 è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨ buffer pool ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨æ›´æ–°ï¼› å¦‚æœè®°å½•ä¸åœ¨ buffer poolï¼Œå°†æ•°æ®é¡µä»ç£ç›˜è¯»å…¥åˆ° buffer poolï¼Œè¿”å›è®°å½•ç»™æ‰§è¡Œå™¨ã€‚ æ‰§è¡Œå™¨å¾—åˆ°èšç°‡ç´¢å¼•è®°å½•åï¼Œä¼šçœ‹ä¸€ä¸‹æ›´æ–°å‰çš„è®°å½•å’Œæ›´æ–°åçš„è®°å½•æ˜¯å¦ä¸€æ ·ï¼š å¦‚æœä¸€æ ·çš„è¯å°±ä¸è¿›è¡Œåç»­æ›´æ–°æµç¨‹ï¼› å¦‚æœä¸ä¸€æ ·çš„è¯å°±æŠŠæ›´æ–°å‰çš„è®°å½•å’Œæ›´æ–°åçš„è®°å½•éƒ½å½“ä½œå‚æ•°ä¼ ç»™ InnoDB å±‚ï¼Œè®© InnoDB çœŸæ­£çš„æ‰§è¡Œæ›´æ–°è®°å½•çš„æ“ä½œï¼› å¼€å¯äº‹åŠ¡ï¼ŒInnoDB å±‚æ›´æ–°è®°å½•å‰ï¼Œé¦–å…ˆè¦è®°å½•ç›¸åº”çš„ undo logï¼Œå› ä¸ºè¿™æ˜¯æ›´æ–°æ“ä½œï¼Œéœ€è¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ã€‚ InnoDB å±‚å¼€å§‹æ›´æ–°è®°å½•ï¼Œä¼šå…ˆæ›´æ–°å†…å­˜ï¼ˆåŒæ—¶æ ‡è®°ä¸ºè„é¡µï¼‰ï¼Œç„¶åå°†è®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚ä¸ºäº†å‡å°‘ç£ç›˜I/Oï¼Œä¸ä¼šç«‹å³å°†è„é¡µå†™å…¥ç£ç›˜ï¼Œåç»­ç”±åå°çº¿ç¨‹é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ—¶æœºå°†è„é¡µå†™å…¥åˆ°ç£ç›˜ã€‚è¿™å°±æ˜¯ WAL æŠ€æœ¯ã€‚ è‡³æ­¤ï¼Œä¸€æ¡è®°å½•æ›´æ–°å®Œäº†ã€‚ åœ¨ä¸€æ¡æ›´æ–°è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œç„¶åå¼€å§‹è®°å½•è¯¥è¯­å¥å¯¹åº”çš„ bin logï¼Œæ­¤æ—¶è®°å½•çš„ bin log ä¼šè¢«ä¿å­˜åˆ° bin log cacheï¼Œå¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç¡¬ç›˜ä¸Šçš„ bin log æ–‡ä»¶ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šç»Ÿä¸€å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ bin log åˆ·æ–°åˆ°ç¡¬ç›˜ã€‚ äº‹åŠ¡è¿›è¡Œä¸¤é˜¶æ®µæäº¤ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤ï¼Ÿ ä¸¤é˜¶æ®µæäº¤æŠŠå•ä¸ªäº‹åŠ¡çš„æäº¤æ‹†åˆ†æˆäº† 2 ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯**ã€Œå‡†å¤‡ï¼ˆPrepareï¼‰é˜¶æ®µã€å’Œã€Œæäº¤ï¼ˆCommitï¼‰é˜¶æ®µã€**ã€‚ MySQL ä½¿ç”¨äº†å†…éƒ¨ XA äº‹åŠ¡ï¼Œç”± bin log ä½œä¸ºåè°ƒè€…ï¼Œå­˜å‚¨å¼•æ“æ˜¯å‚ä¸è€…ã€‚ prepare é˜¶æ®µï¼šå°† XID(å†…éƒ¨ XA äº‹åŠ¡çš„ ID) å†™å…¥åˆ° redo logï¼ŒåŒæ—¶å°† redo log å¯¹åº”çš„äº‹åŠ¡çŠ¶æ€è®¾ç½®ä¸º prepareï¼Œç„¶åå°† redo log æŒä¹…åŒ–åˆ°ç£ç›˜ï¼› commit é˜¶æ®µï¼šæŠŠ XID å†™å…¥åˆ° bin logï¼Œç„¶åå°† bin log æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ¥ç€è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå°† redo log çŠ¶æ€è®¾ç½®ä¸º commitã€‚ è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‡ºç°å¼‚å¸¸æ— éå°±ä¿©æ—¶åˆ»ï¼Œæ—¶åˆ» A å’Œ æ—¶åˆ» Bï¼Œä¸ç®¡æ˜¯å“ªä¸ªï¼Œredo log éƒ½å¤„äº prepare çŠ¶æ€ã€‚ åœ¨ MySQL é‡å¯åä¼šæŒ‰é¡ºåºæ‰«æ redo log æ–‡ä»¶ï¼Œç¢°åˆ°å¤„äº prepare çŠ¶æ€çš„ redo logï¼Œå°±æ‹¿ç€ redo log ä¸­çš„ XID å» bin log æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ­¤ XIDï¼š è‹¥ bin log ä¸­æ²¡æœ‰æ­¤ XIDï¼Œè¯´æ˜å¼‚å¸¸å‘ç”Ÿæ—¶ redo log å®Œæˆäº†åˆ·ç›˜ï¼Œä½† bin log è¿˜æ²¡ï¼Œå› æ­¤å›æ»šäº‹åŠ¡ã€‚å¯¹åº”äº† æ—¶åˆ» Aï¼› è‹¥ bin log ä¸­æœ‰æ­¤ XIDï¼Œè¯´æ˜å¼‚å¸¸å‘ç”Ÿæ—¶éƒ½å®Œæˆäº†åˆ·ç›˜ï¼Œåˆ™æäº¤è¯¥äº‹åŠ¡ã€‚å¯¹åº”æ—¶åˆ» Bã€‚ å¯ä»¥çœ‹å‡ºï¼šä¸¤é˜¶æ®µæäº¤æ˜¯ä»¥ bin log å†™æˆåŠŸä¸ºäº‹åŠ¡æäº¤æˆåŠŸçš„æ ‡è¯†çš„ã€‚ é—®ï¼šä¸ºå•¥è¦ä¸¤é˜¶æ®µæäº¤ï¼Ÿ äº‹åŠ¡æäº¤åï¼Œredo log å’Œ bin log éƒ½è¦æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ˜¯ç‹¬ç«‹çš„é€»è¾‘ï¼Œå¯èƒ½å‡ºç°åŠæˆåŠŸçš„çŠ¶æ€ï¼Œè¿™æ ·å°±é€ æˆä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸ä¸€è‡´ï¼š å¦‚æœåœ¨å°† redo log åˆ·å…¥åˆ°ç£ç›˜ä¹‹åï¼ŒMySQL çªç„¶å®•æœºäº†ï¼Œè€Œ bin log è¿˜æ²¡æœ‰æ¥å¾—åŠå†™å…¥ã€‚é‡å¯åï¼Œä¸»åº“æŒ‰ç…§ redo log æ¢å¤ï¼Œä»åº“æŒ‰ç…§ bin log æ¢å¤ï¼Œä¸»ä»åº“å°±ä¸ä¸€è‡´äº†ï¼› å¦‚æœåœ¨å°† bin log åˆ·å…¥åˆ°ç£ç›˜ä¹‹åï¼ŒMySQL çªç„¶å®•æœºäº†ï¼Œè€Œ redo log è¿˜æ²¡æœ‰æ¥å¾—åŠå†™å…¥ã€‚é‡å¯åï¼Œä¸»åº“æŒ‰ç…§ redo log æ¢å¤ï¼Œä»åº“æŒ‰ç…§ bin log æ¢å¤ï¼Œä¸»ä»åº“å°±ä¸ä¸€è‡´äº†ã€‚ ä¸ºé¿å…ä¸¤ä»½æ—¥å¿—å‡ºç°ä¸ä¸€è‡´ï¼Œå› æ­¤é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ã€‚ é—®ï¼šä¸¤é˜¶æ®µæäº¤æœ‰å•¥ç¼ºç‚¹ï¼Ÿ I/O æ“ä½œæ¬¡æ•°å¤šã€‚è¿™æ˜¯å› ä¸ºæ¯æ¬¡äº‹åŠ¡æäº¤éƒ½è‡³å°‘éœ€è¦ä¸¤æ¬¡åˆ·ç›˜ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:10:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åã€å†…å­˜ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:11:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åŸºç¡€ é—®ï¼šä¸ºå•¥è¦æœ‰ Buffer Poolï¼Ÿ MySQL çš„æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œè‹¥æ¯æ¬¡æ“ä½œéƒ½ç›´æ¥æ“ä½œç£ç›˜ï¼Œæ•ˆç‡å°±ä¼šå¾ˆä½ã€‚ å› æ­¤ï¼ŒåŠ ä¸€å±‚ç¼“å­˜ï¼Œå°†è¯»å‡ºçš„æ•°æ®é¡µç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œä¸‹æ¬¡ç”¨åˆ°çš„è¯ç›´æ¥è®¿é—®å†…å­˜å³å¯ã€‚Innodb é€šè¿‡**ç¼“å†²æ± (Buffer Pool)**æœºåˆ¶å®ç°ï¼š å½“è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœæ•°æ®å­˜åœ¨äº Buffer Pool ä¸­ï¼Œå®¢æˆ·ç«¯å°±ä¼šç›´æ¥è¯»å– Buffer Pool ä¸­çš„æ•°æ®ï¼Œå¦åˆ™å†å»ç£ç›˜ä¸­è¯»å–ï¼› å½“ä¿®æ”¹æ•°æ®æ—¶ï¼Œé¦–å…ˆæ˜¯ä¿®æ”¹ Buffer Pool ä¸­æ•°æ®æ‰€åœ¨çš„é¡µï¼Œç„¶åå°†å…¶é¡µè®¾ç½®ä¸ºè„é¡µï¼Œæœ€åç”±åå°çº¿ç¨‹å°†è„é¡µå†™å…¥åˆ°ç£ç›˜ã€‚ é—®ï¼šBuffer Pool ç¼“å­˜äº†ä»€ä¹ˆï¼Ÿ Innodb æŒ‰é¡µå­˜å‚¨æ•°æ®ï¼Œä»¥é¡µä½œä¸ºç£ç›˜å’Œå†…å­˜äº¤äº’çš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ªé¡µçš„é»˜è®¤å¤§å°ä¸º 16KBã€‚å› æ­¤ï¼ŒBuffer Pool åŒæ ·éœ€è¦æŒ‰ã€Œé¡µã€æ¥åˆ’åˆ†ã€‚ InnoDB ä¼šä¸º Buffer Pool ç”³è¯·ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç„¶åæŒ‰ç…§é»˜è®¤çš„16KBçš„å¤§å°åˆ’åˆ†å‡ºä¸€ä¸ªä¸ªçš„é¡µï¼ŒBuffer Pool ä¸­çš„é¡µå°±å«åšç¼“å­˜é¡µã€‚æ­¤æ—¶è¿™äº›ç¼“å­˜é¡µéƒ½æ˜¯ç©ºé—²çš„ï¼Œä¹‹åéšç€ç¨‹åºçš„è¿è¡Œï¼Œæ‰ä¼šæœ‰ç£ç›˜ä¸Šçš„é¡µè¢«ç¼“å­˜åˆ° Buffer Pool ä¸­ã€‚ Buffer Pool é™¤äº†ç¼“å­˜**ã€Œç´¢å¼•é¡µã€å’Œã€Œæ•°æ®é¡µã€**ï¼Œè¿˜åŒ…æ‹¬äº† undo é¡µï¼Œæ’å…¥ç¼“å­˜ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€é”ä¿¡æ¯ç­‰ç­‰ã€‚ é—®ï¼šæŸ¥è¯¢ä¸€æ¡æ•°æ®ï¼Œåªéœ€è¦ç¼“å­˜ä¸€æ¡æ•°æ®å—ï¼Ÿ Noï¼æŸ¥è¯¢è®°å½•æ—¶ï¼Œé€šè¿‡ç´¢å¼•æ‰¾åˆ°ç£ç›˜ä¸Šçš„é¡µï¼Œç„¶åä¼šæŠŠæ•´é¡µåŠ è½½ï¼Œå¹¶å­˜å…¥ Buffer Poolã€‚ ä¸€æ–¹é¢æ˜¯å› ä¸ºï¼Œç´¢å¼•åªèƒ½å®šä½åˆ°é¡µï¼›å¦ä¸€æ–¹é¢ï¼Œè‹¥æ¯æ¬¡IOè¯»å…¥äº†æ•´é¡µï¼Œå´åªä¿ç•™ä¸€æ¡æ•°æ®ï¼Œä¹ŸæŒºæµªè´¹çš„ã€‚ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:11:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ç®¡ç† é—®ï¼šå¦‚ä½•ç®¡ç†ç©ºé—²é¡µï¼Ÿ å› ä¸ºæœ‰çš„é¡µé¢è¢«ä½¿ç”¨ï¼Œæœ‰çš„é¡µé¢æ²¡è¢«ä½¿ç”¨ï¼Œæ€»ä¸èƒ½æ¯æ¬¡è¦æ‰¾åˆ°ä¸ªç©ºé—²é¡µå°±éå†ä¸€éå§ï¼Ÿ è§£å†³æ–¹æ¡ˆç±»ä¼¼Goçš„å†…å­˜ç®¡ç†ã€‚ é€šè¿‡ä¸€ä¸ªå¸¦å¤´åŒå‘é“¾è¡¨ Freeï¼Œå°†ç©ºé—²ç¼“å­˜é¡µçš„æ§åˆ¶å—å­˜èµ·æ¥ï¼š Free é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼šåŒ…å«é“¾è¡¨çš„å¤´èŠ‚ç‚¹åœ°å€ï¼Œå°¾èŠ‚ç‚¹åœ°å€ï¼Œä»¥åŠå½“å‰é“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ç­‰ä¿¡æ¯ï¼› Free é“¾è¡¨çš„èŠ‚ç‚¹ï¼šä¸€ä¸ªä¸ªæ§åˆ¶å—ã€‚ é—®ï¼šå¦‚ä½•ç®¡ç†è„é¡µï¼Ÿ ç±»ä¼¼ Free é“¾è¡¨ï¼Œè®¾è®¡äº† Flush é“¾è¡¨å­˜å‚¨è„é¡µï¼Œåå°çº¿ç¨‹å¯ä»¥éå† Flush é“¾è¡¨ï¼Œå°†è„é¡µå†™å…¥åˆ°ç£ç›˜ã€‚ é—®ï¼šç¼“å­˜æ›´æ–°ç­–ç•¥ï¼Ÿ ç±»ä¼¼ LRUã€‚ é—®ï¼šè„é¡µä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ·ç›˜ï¼Ÿâ­â­ InnoDB çš„æ›´æ–°æ“ä½œé‡‡ç”¨çš„æ˜¯ WAL(Write Ahead Log) ç­–ç•¥ï¼Œå³å…ˆå†™æ—¥å¿—ï¼Œå†å†™å…¥ç£ç›˜ï¼Œé€šè¿‡ redo log æ—¥å¿—è®© MySQL æ‹¥æœ‰äº†å´©æºƒæ¢å¤èƒ½åŠ›ã€‚ ä¸‹é¢å‡ ç§æƒ…å†µä¼šè§¦å‘è„é¡µçš„åˆ·æ–°ï¼š å½“ redo log æ—¥å¿—æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œä¼šä¸»åŠ¨è§¦å‘è„é¡µåˆ·æ–°åˆ°ç£ç›˜ï¼› Buffer Pool ç©ºé—´ä¸è¶³æ—¶ï¼Œéœ€è¦å°†ä¸€éƒ¨åˆ†æ•°æ®é¡µæ·˜æ±°æ‰ï¼Œå¦‚æœæ·˜æ±°çš„æ˜¯è„é¡µï¼Œéœ€è¦å…ˆå°†è„é¡µåŒæ­¥åˆ°ç£ç›˜ï¼› MySQL è®¤ä¸ºç©ºé—²æ—¶ï¼Œåå°çº¿ç¨‹ä¼šå®šæœŸå°†é€‚é‡çš„è„é¡µåˆ·å…¥åˆ°ç£ç›˜ï¼› MySQL æ­£å¸¸å…³é—­ä¹‹å‰ï¼Œä¼šæŠŠæ‰€æœ‰çš„è„é¡µåˆ·å…¥åˆ°ç£ç›˜ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:11:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åä¸€ã€é›†ç¾¤æ¶æ„ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:12:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¸»ä»å¤åˆ¶ é—®ï¼šä¸ºä»€ä¹ˆè¦é›†ç¾¤ï¼Ÿ æ•°æ®å¤‡ä»½ï¼› æ•…éšœè½¬ç§»ï¼› è¯»å†™åˆ†ç¦»ï¼Œå‡è½»ä¸»åº“è¯»å†™å‹åŠ›ã€‚ é—®ï¼šä¸»ä»å¤åˆ¶æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ MySQL çš„ä¸»ä»å¤åˆ¶ä¾èµ–äº bin logï¼Œå¤åˆ¶è¿‡ç¨‹ï¼š å†™å…¥ bin logï¼šä¸»åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šæŠŠ**æ•°æ®å˜æ›´(å¢åˆ æ”¹)**è®°å½•åœ¨ bin log ä¸­ï¼› åŒæ­¥ bin logï¼šä»åº“åˆ›å»º I/O çº¿ç¨‹ï¼Œè¯·æ±‚è·å–ä¸»åº“ bin logï¼› å‘é€ bin logï¼šä¸»åº“åˆ›å»ºä¸€ä¸ª log dump çº¿ç¨‹ï¼Œå°† bin log å‘é€ç»™ä»åº“ï¼› é‡æ”¾ bin logï¼šä»åº“å°†è·å–çš„ bin log å†™å…¥ä»åº“çš„ä¸­ç»§æ—¥å¿—(relay log)ï¼ŒåŒæ—¶åˆ›å»ºçº¿ç¨‹ï¼Œè¯»å–å¹¶é‡æ”¾ relay logï¼Œæ›´æ–°ä»åº“ä¸­çš„æ•°æ®ã€‚ é—®ï¼šä»åº“æ˜¯è¶Šå¤šè¶Šå¥½å—ï¼Ÿ å½“ç„¶ä¸æ˜¯ã€‚ å› ä¸ºä»åº“æ•°é‡å¢åŠ ï¼Œä»åº“è¿æ¥ä¸Šæ¥çš„ I/O çº¿ç¨‹ä¹Ÿæ¯”è¾ƒå¤šï¼Œä¸»åº“ä¹Ÿè¦åˆ›å»ºåŒæ ·å¤šçš„ log dump çº¿ç¨‹æ¥å¤„ç†å¤åˆ¶çš„è¯·æ±‚ï¼Œå¯¹ä¸»åº“èµ„æºæ¶ˆè€—æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶è¿˜å—é™äºä¸»åº“çš„ç½‘ç»œå¸¦å®½ã€‚ æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œ1 ä¸ªä¸»åº“ä¸€èˆ¬è·Ÿ 2ï½3 ä¸ªä»åº“ï¼ˆ1 å¥—æ•°æ®åº“ï¼Œ1 ä¸» 2 ä» 1 å¤‡ä¸»ï¼‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸»å¤šä»çš„ MySQL é›†ç¾¤ç»“æ„ã€‚ é—®ï¼šä¸»ä»å¤åˆ¶æœ‰å“ªäº›æ¨¡å‹ï¼Ÿ/å¦‚ä½•ä¿æŒä¸»ä»é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ åŒæ­¥å¤åˆ¶ï¼šMySQL ä¸»åº“æäº¤äº‹åŠ¡çš„çº¿ç¨‹è¦ç­‰å¾…æ‰€æœ‰ä»åº“çš„å¤åˆ¶æˆåŠŸå“åº”ï¼Œæ‰è¿”å›å®¢æˆ·ç«¯ç»“æœã€‚å®é™…æ²¡æ³•ç”¨ï¼› **å¼‚æ­¥å¤åˆ¶(é»˜è®¤)ï¼š**ä¸»åº“ä¸ç”¨ç­‰ bin log åŒæ­¥åˆ°ä»åº“å°±è¿”å›ç»“æœã€‚ç¼ºç‚¹å°±æ˜¯ï¼Œä¸»åº“å®•æœºå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®ï¼› **åŠåŒæ­¥å¤åˆ¶ï¼š**ä¸»åº“ç­‰ bin log å¤åˆ¶åˆ°ä¸€éƒ¨åˆ†ä»åº“å†è¿”å›ç»“æœã€‚å…¼é¡¾ä¸Šè¿°æ–¹æ¡ˆï¼Œå°±ç®—ä¸»åº“å®•æœºäº†ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:12:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åˆ†åº“åˆ†è¡¨ é—®ï¼šä¸ºä»€ä¹ˆè¦åˆ†åº“ï¼Ÿä¸ºä»€ä¹ˆè¦åˆ†è¡¨ï¼Ÿ ä¸ºä»€ä¹ˆè¦åˆ†åº“ï¼Ÿ å¦‚æœä¸šåŠ¡é‡å‰§å¢ï¼Œæ•°æ®åº“å¯èƒ½ä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘æ‹†åˆ†æ•°æ®åº“ã€‚ä»è¿™ä¸¤æ–¹é¢æ¥çœ‹ï¼š ç£ç›˜å­˜å‚¨ ä¸šåŠ¡é‡å‰§å¢ï¼ŒMySQLå•æœºç£ç›˜å®¹é‡ä¼šæ’‘çˆ†ï¼Œå› æ­¤å¯ä»¥æ‹†æˆå¤šä¸ªæ•°æ®åº“ï¼› å¹¶å‘è¿æ¥æ”¯æ’‘ æ•°æ®åº“è¿æ¥æ•°æ˜¯æœ‰é™çš„ã€‚åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå¤§é‡è¯·æ±‚è®¿é—®æ•°æ®åº“ï¼ŒMySQLå•æœºæ˜¯æ‰›ä¸ä½çš„ï¼é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šå‡ºç°too many connectionsæŠ¥é”™ã€‚ ä¸ºä»€ä¹ˆè¦åˆ†è¡¨ï¼Ÿ å‡å¦‚ä½ çš„å•è¡¨æ•°æ®é‡éå¸¸å¤§ï¼Œå­˜å‚¨å’ŒæŸ¥è¯¢çš„æ€§èƒ½å°±ä¼šé‡åˆ°ç“¶é¢ˆäº†(ç”±äºB+æ ‘)ï¼Œå¦‚æœä½ åšäº†å¾ˆå¤šä¼˜åŒ–ä¹‹åè¿˜æ˜¯æ— æ³•æå‡æ•ˆç‡çš„æ—¶å€™ï¼Œå°±éœ€è¦è€ƒè™‘åšåˆ†è¡¨äº†ã€‚ä¸€èˆ¬åƒä¸‡çº§åˆ«æ•°æ®é‡ï¼Œå°±éœ€è¦åˆ†è¡¨ã€‚ é—®ï¼šä»€ä¹ˆæ—¶å€™å°±è¦è¿›è¡Œåˆ†åº“åˆ†è¡¨äº†ï¼Ÿ å¯¹äºMySQLï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„è¯ï¼Œå•è¡¨æœ€å¤šå¯ä»¥å­˜å‚¨10äº¿çº§æ•°æ®ã€‚ ä½†æ˜¯çš„è¯ï¼Œå¦‚æœçœŸçš„å­˜å‚¨è¿™ä¹ˆå¤šï¼Œæ€§èƒ½å°±ä¼šéå¸¸å·®ã€‚ä¸€èˆ¬æ•°æ®é‡åƒä¸‡çº§åˆ«ï¼ŒB+æ ‘ç´¢å¼•é«˜åº¦å°±ä¼šåˆ°3å±‚ä»¥ä¸Šäº†ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ä¼šå¤šæŸ¥ç£ç›˜çš„æ¬¡æ•°ï¼ŒSQLå°±ä¼šå˜æ…¢ã€‚ é˜¿é‡Œå·´å·´çš„ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹æå‡ºï¼š å•è¡¨è¡Œæ•°è¶…è¿‡500ä¸‡è¡Œæˆ–è€…å•è¡¨å®¹é‡è¶…è¿‡2GBï¼Œæ‰æ¨èè¿›è¡Œåˆ†åº“åˆ†è¡¨ã€‚ é‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ç­‰åˆ°æ•°æ®é‡åˆ°è¾¾äº”ç™¾ä¸‡ï¼Œæ‰å¼€å§‹åˆ†åº“åˆ†è¡¨å‘¢ï¼Ÿ ä¸æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬åº”è¯¥æå‰è§„åˆ’åˆ†åº“åˆ†è¡¨ï¼Œå¦‚æœä¼°ç®—3å¹´åï¼Œä½ çš„è¡¨éƒ½ä¸ä¼šåˆ°è¾¾è¿™ä¸ªäº”ç™¾ä¸‡ï¼Œåˆ™ä¸éœ€è¦åˆ†åº“åˆ†è¡¨ã€‚ MySQLæœåŠ¡å™¨å¦‚æœé…ç½®æ›´å¥½ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è¶…è¿‡è¿™ä¸ª500ä¸‡è¿™ä¸ªé‡çº§ï¼Œæ‰è€ƒè™‘åˆ†åº“åˆ†è¡¨ï¼Ÿ è™½ç„¶é…ç½®æ›´å¥½ï¼Œå¯èƒ½æ•°æ®é‡å¤§ä¹‹åï¼Œæ€§èƒ½è¿˜æ˜¯ä¸é”™ï¼Œä½†æ˜¯å¦‚æœæŒç»­å‘å±•çš„è¯ï¼Œè¿˜æ˜¯è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨ ä¸€èˆ¬ä»€ä¹ˆç±»å‹ä¸šåŠ¡è¡¨éœ€è¦æ‰åˆ†åº“åˆ†è¡¨ï¼Ÿ é€šç”¨æ˜¯ä¸€äº›æµæ°´è¡¨ã€ç”¨æˆ·è¡¨ç­‰æ‰è€ƒè™‘åˆ†åº“åˆ†è¡¨ï¼Œå¦‚æœæ˜¯ä¸€äº›é…ç½®ç±»çš„è¡¨ï¼Œåˆ™å®Œå…¨ä¸ç”¨è€ƒè™‘ï¼Œå› ä¸ºä¸å¤ªå¯èƒ½åˆ°è¾¾è¿™ä¸ªé‡çº§ã€‚ é—®ï¼šæœ‰å“ªäº›åˆ†åº“ã€åˆ†è¡¨æ–¹å¼ï¼Ÿ å‚ç›´åˆ†åº“ï¼šä»¥è¡¨ä¸ºä¾æ®ï¼Œæ ¹æ®ä¸šåŠ¡ï¼Œå°†ä¸åŒçš„è¡¨æ‹†åˆ†åˆ°ä¸åŒçš„åº“ä¸­ã€‚ æ¯ä¸ªåº“çš„è¡¨ç»“æ„éƒ½ä¸ä¸€æ ·ï¼› æ¯ä¸ªåº“çš„æ•°æ®ä¹Ÿä¸ä¸€æ ·ï¼› æ‰€æœ‰åº“çš„å¹¶é›†æ˜¯å…¨é‡æ•°æ®ã€‚ å‚ç›´åˆ†è¡¨ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼Œæ ¹æ®å­—æ®µå±æ€§ï¼Œå°†ä¸åŒå­—æ®µæ‹†åˆ†åˆ°ä¸åŒè¡¨ä¸­ã€‚ æ¯ä¸ªè¡¨çš„ç»“æ„éƒ½ä¸ä¸€æ ·ï¼› æ¯ä¸ªè¡¨çš„æ•°æ®ä¹Ÿä¸ä¸€æ ·ï¼Œä¸€èˆ¬é€šè¿‡ä¸€åˆ—(ä¸»é”®/å¤–é”®)å…³è”ï¼› æ‰€æœ‰è¡¨çš„å¹¶é›†æ˜¯å…¨é‡æ•°æ®ã€‚ æ°´å¹³åˆ†åº“â­ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼ŒæŒ‰ç…§ä¸€å®šç­–ç•¥ï¼Œå°†ä¸€ä¸ªåº“çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªåº“ä¸­ã€‚ æ¯ä¸ªåº“çš„è¡¨ç»“æ„éƒ½ä¸€æ ·ï¼› æ¯ä¸ªåº“çš„æ•°æ®éƒ½ä¸ä¸€æ ·ï¼› æ‰€æœ‰åº“çš„å¹¶é›†æ˜¯å…¨é‡æ•°æ®ã€‚ æ°´å¹³åˆ†è¡¨â­ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼ŒæŒ‰ç…§ä¸€å®šç­–ç•¥ï¼Œå°†ä¸€ä¸ªè¡¨çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ä¸­ã€‚ æ¯ä¸ªè¡¨çš„è¡¨ç»“æ„éƒ½ä¸€æ ·ï¼› æ¯ä¸ªè¡¨çš„æ•°æ®éƒ½ä¸ä¸€æ ·ï¼› æ‰€æœ‰è¡¨çš„å¹¶é›†æ˜¯å…¨é‡æ•°æ®ã€‚ æ€»ç»“ï¼š å‚ç›´æ‹†åˆ†çš„å…³æ³¨ç‚¹åœ¨äº ä¸šåŠ¡ç›¸å…³æ€§ï¼› æ°´å¹³æ‹†åˆ†æŒ‡çš„æ˜¯å°†å•ä¸€æ•°æ®è¡¨æŒ‰ç…§æŸä¸€ç§è§„åˆ™æ‹†åˆ†åˆ°å¤šä¸ªæ•°æ®åº“å’Œå¤šä¸ªæ•°æ®è¡¨ä¸­ï¼Œå…³æ³¨ç‚¹åœ¨ æ•°æ®çš„ç‰¹ç‚¹ã€‚ é—®ï¼šæ°´å¹³åˆ†ç‰‡çš„è§„åˆ™æœ‰å“ªäº›ï¼Ÿ èŒƒå›´åˆ†ç‰‡ï¼šåˆ’åˆ†å¤šä¸ªèŒƒå›´åŒºé—´ï¼Œè½åœ¨ç›¸åº”åŒºé—´çš„æ•°æ®å­˜å…¥ç›¸åº”çš„åº“æˆ–è¡¨ï¼› å–æ¨¡åˆ†ç‰‡ï¼šæŒ‡å®šçš„å­—æ®µå€¼ % èŠ‚ç‚¹æ•°é‡ï¼Œè½åˆ°å“ªä¸ªèŠ‚ç‚¹å°±å­˜åˆ°å“ªä¸ªï¼› ä¸€è‡´æ€§hashï¼šå¢åŠ èŠ‚ç‚¹æˆ–åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œå–æ¨¡åˆ†ç‰‡ä¼šå¯¼è‡´å¤§é‡æ•°æ®è¿ç§»ï¼›ä¸€è‡´æ€§hashä¸­ï¼Œåªä¼šå½±å“ä¸€å°éƒ¨åˆ†æ•°æ®çš„è¿ç§»ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:12:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"è¯»å†™åˆ†ç¦» å°±æ˜¯ï¼Œåªæœ‰ä¸»èŠ‚ç‚¹è´Ÿè´£å†™è¯·æ±‚ï¼Œå…¶ä»–èŠ‚ç‚¹è´Ÿè´£è¯»è¯·æ±‚ï¼Œå¯ä»¥é™ä½å•å°æœåŠ¡å™¨çš„å‹åŠ›ã€‚ ä¸€ä¸»ä¸€ä»ï¼šä¸€ä¸»è´Ÿè´£å†™ï¼Œä¸€ä»è´Ÿè´£è¯»ï¼› åŒä¸»åŒä»ï¼šä¸€ä¸»è´Ÿè´£å†™ï¼Œä¸€ä¸»ä¸¤ä»è´Ÿè´£è¯»ã€‚å¹¶ä¸”ï¼Œæ¯ç»„ä¸»ä»é—´äº’ä¸ºä¸»å¤‡ï¼Œä¸€ç»„æŒ‚äº†ï¼Œå¦ä¸€ç»„å°±ä¼šé¡¶ä¸Šï¼Œå®ç°é«˜å¯ç”¨ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:12:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åˆ†å¸ƒå¼ ID å½“åˆ†åº“åˆ†è¡¨ä¹‹åï¼ŒåŒä¸€ä¸ªé€»è¾‘è¡¨çš„æ•°æ®è¢«åˆ†å¸ƒåˆ°å¤šä¸ªåº“ä¸­ï¼Œè¿™æ—¶å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢å­—æ®µä½œä¸ºä¸»é”®ï¼Œé‚£ä¹ˆåªèƒ½ä¿è¯åœ¨è¿™ä¸ªåº“ä¸­æ˜¯å”¯ä¸€çš„ï¼Œæ— æ³•ä¿è¯å…¨å±€çš„å”¯ä¸€æ€§ã€‚é‚£ä¹ˆå‡å¦‚è®¾è®¡ç”¨æˆ·ç³»ç»Ÿçš„æ—¶å€™ï¼Œä½¿ç”¨è‡ªå¢ ID ä½œä¸ºç”¨æˆ· IDï¼Œå°±å¯èƒ½å‡ºç°ä¸¤ä¸ªç”¨æˆ·æœ‰ä¸¤ä¸ªç›¸åŒçš„ IDï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ IDã€‚ UUID ä¸å»ºè®®ä½¿ç”¨ UUID ä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œå› ä¸ºï¼š ID æœ‰åºæ›´åˆ©äºç´¢å¼•æ•°æ®çš„æ’å…¥ï¼Œè€Œ UUID æ˜¯æ— åºçš„ï¼Œé€ æˆäº†å¤šä½™çš„æ•°æ®ç§»åŠ¨çš„å¼€é”€ï¼› UUID ä¸å…·å¤‡ä¸šåŠ¡å«ä¹‰ï¼› UUID æ˜¯ç”± 32 ä¸ª 16 è¿›åˆ¶æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²(128ä½)ï¼Œå¦‚æœä½œä¸ºæ•°æ®åº“ä¸»é”®ä½¿ç”¨æ¯”è¾ƒè€—è´¹ç©ºé—´ã€‚ ==é›ªèŠ±ç®—æ³•(Snowflake)== Snowflake çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°† 64 ä½çš„äºŒè¿›åˆ¶æ•°å­—åˆ†æˆè‹¥å¹²éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†éƒ½å­˜å‚¨æœ‰ç‰¹å®šå«ä¹‰çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´æ—¶é—´æˆ³ã€æœºå™¨ IDã€åºåˆ—å·ç­‰ç­‰ï¼Œæœ€ç»ˆç”Ÿæˆå…¨å±€å”¯ä¸€çš„æœ‰åº IDã€‚å¯ä»¥è‡ªå®šä¹‰å„å­—æ®µä»£è¡¨çš„å«ä¹‰å’Œä½æ•°ã€‚ åŸç†çŸ¥é“äº†ï¼Œé‚£å·¥ç¨‹ä¸Šæ˜¯æ€ä¹ˆå®ç°å‘¢ï¼Ÿ ä¸€ç§æ˜¯åµŒå…¥åˆ°ä¸šåŠ¡ä»£ç é‡Œï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒåœ¨ä¸šåŠ¡æœåŠ¡å™¨ä¸­ã€‚ ä¸€ç§æ˜¯ä½œä¸ºç‹¬ç«‹çš„æœåŠ¡éƒ¨ç½²ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å‘å·å™¨æœåŠ¡ã€‚ Snowflake ç®—æ³•è®¾è®¡çš„éå¸¸ç®€å•ä¸”å·§å¦™ï¼Œæ€§èƒ½ä¸Šä¹Ÿè¶³å¤Ÿé«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿç”Ÿæˆå…·æœ‰å…¨å±€å”¯ä¸€æ€§ã€å•è°ƒé€’å¢æ€§å’Œæœ‰ä¸šåŠ¡å«ä¹‰çš„ IDï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š å…¶ä¸­æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯å®ƒä¾èµ–äºç³»ç»Ÿçš„æ—¶é—´æˆ³ï¼Œä¸€æ—¦ç³»ç»Ÿæ—¶é—´ä¸å‡†ï¼Œå°±æœ‰å¯èƒ½ç”Ÿæˆé‡å¤çš„ IDã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å‘ç°ç³»ç»Ÿæ—¶é’Ÿä¸å‡†ï¼Œå°±å¯ä»¥è®©å‘å·å™¨æš‚æ—¶æ‹’ç»å‘å·ï¼Œç›´åˆ°æ—¶é’Ÿå‡†ç¡®ä¸ºæ­¢ï¼› å¦å¤–ï¼Œå¦‚æœè¯·æ±‚å‘å·å™¨çš„ QPS ä¸é«˜ï¼Œæ¯”å¦‚è¯´å‘å·å™¨æ¯æ¯«ç§’åªå‘ä¸€ä¸ª IDï¼Œå°±ä¼šé€ æˆç”Ÿæˆ ID çš„æœ«ä½æ°¸è¿œæ˜¯ 1ï¼Œé‚£ä¹ˆåœ¨åˆ†åº“åˆ†è¡¨æ—¶å¦‚æœä½¿ç”¨ ID ä½œä¸ºåˆ†åŒºé”®å°±ä¼šé€ æˆåº“è¡¨åˆ†é…çš„ä¸å‡åŒ€ã€‚ è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è¸©è¿‡çš„å‘ï¼Œè€Œè§£å†³åŠæ³•ä¸»è¦æœ‰ä¸¤ä¸ªï¼š æ—¶é—´æˆ³ä¸è®°å½•æ¯«ç§’è€Œæ˜¯è®°å½•ç§’ï¼Œè¿™æ ·åœ¨ä¸€ä¸ªæ—¶é—´åŒºé—´é‡Œå¯ä»¥å¤šå‘å‡ºå‡ ä¸ªå·ï¼Œé¿å…å‡ºç°åˆ†åº“åˆ†è¡¨æ—¶æ•°æ®åˆ†é…ä¸å‡ï¼› ç”Ÿæˆçš„åºåˆ—å·çš„èµ·å§‹å·å¯ä»¥åšä¸€ä¸‹éšæœºï¼Œè¿™ä¸€ç§’æ˜¯ 21ï¼Œä¸‹ä¸€ç§’æ˜¯ 30ï¼Œè¿™æ ·å°±ä¼šå°½é‡çš„å‡è¡¡äº†ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:12:4","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"åäºŒã€é¢è¯•é¢˜ é—®ï¼šæ‰§è¡Œä¸€æ¡MySQLè¯­å¥ï¼Œéå¸¸æ…¢ï¼Œå¯èƒ½çš„åŸå› ï¼Ÿ åˆ†ä¸¤ç§æƒ…å†µï¼š å¤§å¤šæ•°æƒ…å†µæ­£å¸¸ï¼Œå¶å°”å¾ˆæ…¢ æ•°æ®åº“åœ¨åˆ·ç›˜ï¼Œä¾‹å¦‚å°† redo logã€buffer åˆ·æ–°åˆ°ç£ç›˜ã€‚å› ä¸ºé‡‡ç”¨äº† WAL æŠ€æœ¯ï¼šä¹Ÿå°±æ˜¯æ›´æ–°æ•°æ®æ—¶å…ˆå†™å…¥ redo logï¼Œç­‰ç©ºé—²æ—¶å†å°† redo log å†™å…¥ç£ç›˜ã€‚åˆ·è„é¡µæœ‰ä»¥ä¸‹åœºæ™¯ï¼š redo log å†™æ»¡äº†ï¼Œéœ€è¦åˆ·ç›˜ï¼› buffer ä¸å¤Ÿäº†ï¼Œéœ€è¦æ·˜æ±°ä¸€äº›é¡µï¼Œè€Œå¦‚æœè¦æ·˜æ±°çš„é¡µåˆšå¥½æ˜¯è„é¡µï¼Œå°±ä¼šåˆ·ç›˜ï¼› ç©ºé—²æ—¶ï¼› é‡åˆ°é”ï¼Œæ‹¿ä¸åˆ°é”ï¼Œå¾—é˜»å¡ç­‰å¾…ã€‚å¯ä»¥ç”¨ show processlist è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹å½“å‰çš„çŠ¶æ€ã€‚ ä¸€ç›´æ‰§è¡Œå¾—å¾ˆæ…¢ æ²¡ç”¨ä¸Šç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æŸ¥è¯¢ï¼Œè¿˜å¾—å›è¡¨ï¼Œå°±å¾ˆæ…¢ï¼› è¡¨ä¸­æ•°æ®å¤ªå¤šäº†ï¼Œç´¢å¼•å±‚æ•°è¿‡é«˜ï¼Œå»ºè®®åˆ†è¡¨ï¼› åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼› æ•°æ®åº“èµ°é”™ç´¢å¼•äº†ï¼Œæ­¤æ—¶å¯ä»¥å¼ºåˆ¶æ•°æ®åº“èµ°æŸä¸ªç´¢å¼•ã€‚ é—®ï¼šé€šè¿‡ select from limit æŸ¥è¯¢æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢ 0-10 å’Œ 990-1000 çš„æ•ˆç‡ä¸€æ ·å—ï¼Ÿ limit æŸ¥è¯¢æ–¹å¼å¯¹åº” limit offset, sizeï¼Œå³ä» offset å¤„å¼€å§‹æŸ¥æ‰¾ size æ¡æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡è¯­å¥æ—¶ï¼š select * from page order by id limit 0, 10; select * from page order by id limit 6000000, 10; ç¬¬ä¸€æ¡ä¼šè·å–åˆ°ç¬¬0åˆ°10æ¡å®Œæ•´è¡Œæ•°æ®ï¼› ç¬¬äºŒæ¡åˆ™è¦å…ˆè·å¾—ç¬¬0åˆ°(6000000 + 10)æ¡å®Œæ•´è¡Œæ•°æ®ï¼Œè¿”å›ç»™serverå±‚ä¹‹åæ ¹æ®offsetçš„å€¼æŒ¨ä¸ªæŠ›å¼ƒï¼Œæœ€ååªç•™ä¸‹æœ€åé¢çš„sizeæ¡ï¼Œä¹Ÿå°±æ˜¯10æ¡æ•°æ®ã€‚ ç”±äºè·å–åˆ°å¾ˆå¤šæ— ç”¨çš„æ•°æ®ï¼Œæ•ˆç‡æ˜¯ä¸ä¸€æ ·çš„ã€‚ å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ï¼šå½“selectåé¢æ˜¯*å·æ—¶ï¼Œéœ€è¦æ‹·è´å®Œæ•´çš„è¡Œä¿¡æ¯ï¼Œæ‹·è´å®Œæ•´æ•°æ®è·Ÿåªæ‹·è´è¡Œæ•°æ®é‡Œçš„å…¶ä¸­ä¸€ä¸¤ä¸ªåˆ—å­—æ®µè€—æ—¶æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ä¸ºï¼š select * from page where id \u003e=(select id from page order by id limit 6000000, 1) order by id limit 10; ä½†è¿™ç§æ–¹æ³•ä¹Ÿåªæ˜¯ç¼“è§£ï¼Œå½“ Offset å¢é•¿åˆ°ç™¾ä¸‡åƒä¸‡çº§åˆ«ï¼Œå°±ä¹Ÿä¸å¤ªè¡Œäº†ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†æ·±åº¦åˆ†é¡µé—®é¢˜ã€‚ æ·±åº¦åˆ†é¡µ è¿™éœ€è¦ä»èƒŒåçš„éœ€æ±‚å‡ºå‘ï¼Œä¸åŒçš„éœ€æ±‚æœ‰ä¸åŒçš„è§£å†³æ–¹æ¡ˆã€‚ å–å‡ºå…¨è¡¨æ•°æ® select * from page; å› ä¸ºæ•°æ®é‡è¾ƒå¤§ï¼Œmysqlæ ¹æœ¬æ²¡åŠæ³•ä¸€æ¬¡æ€§è·å–åˆ°å…¨éƒ¨æ•°æ®ï¼Œè‚¯å®šè¶…æ—¶æŠ¥é”™ã€‚ è§£å†³æ–¹æ³•ï¼šå¯ä»¥å°†æ‰€æœ‰çš„æ•°æ®æ ¹æ®idä¸»é”®è¿›è¡Œæ’åºï¼Œç„¶ååˆ†æ‰¹æ¬¡å–ï¼Œå°†å½“å‰æ‰¹æ¬¡çš„æœ€å¤§ id ä½œä¸ºä¸‹æ¬¡ç­›é€‰çš„æ¡ä»¶è¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚ä¸‹ä¼ªä»£ç ï¼š è¿™ä¸ªæ“ä½œï¼Œå¯ä»¥é€šè¿‡ä¸»é”®ç´¢å¼•ï¼Œæ¯æ¬¡å®šä½åˆ°idåœ¨å“ªï¼Œç„¶åå¾€åéå†100ä¸ªæ•°æ®ï¼Œè¿™æ ·ä¸ç®¡æ˜¯å¤šå°‘ä¸‡çš„æ•°æ®ï¼ŒæŸ¥è¯¢æ€§èƒ½éƒ½å¾ˆç¨³å®šã€‚ åšåˆ†é¡µå±•ç¤º å•¥æ ·çš„åˆ†é¡µå±•ç¤ºèƒ½åˆ°ç™¾ä¸‡åƒä¸‡å±•ç¤ºé‡å•Šï¼Ÿæƒ³æƒ³è°·æ­Œæ‰æä¾›å¤šå°‘é¡µï¼Ÿå»è·Ÿäº§å“ç»ç†battleå§è¿˜æ˜¯ã€‚ã€‚ é—®ï¼šæ‰§è¡Œä¸€æ¡MySQLè¯­å¥ï¼Œè¿‡ç¨‹ï¼Ÿ è¿æ¥å™¨ï¼šå»ºç«‹è¿æ¥ï¼Œç®¡ç†è¿æ¥ã€æ ¡éªŒç”¨æˆ·èº«ä»½ï¼› æŸ¥è¯¢ç¼“å­˜ï¼šæŸ¥è¯¢è¯­å¥å¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚MySQL 8.0 å·²åˆ é™¤è¯¥æ¨¡å—ï¼› è§£æ SQLï¼šé€šè¿‡è§£æå™¨å¯¹ SQL æŸ¥è¯¢è¯­å¥è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œç„¶åæ„å»ºè¯­æ³•æ ‘ï¼Œæ–¹ä¾¿åç»­æ¨¡å—è¯»å–è¡¨åã€å­—æ®µã€è¯­å¥ç±»å‹ï¼› æ‰§è¡Œ SQLï¼šæ‰§è¡Œ SQL å…±æœ‰ä¸‰ä¸ªé˜¶æ®µï¼š é¢„å¤„ç†é˜¶æ®µï¼šæ£€æŸ¥è¡¨æˆ–å­—æ®µæ˜¯å¦å­˜åœ¨ï¼›å°† select * ä¸­çš„ * ç¬¦å·æ‰©å±•ä¸ºè¡¨ä¸Šçš„æ‰€æœ‰åˆ—ã€‚ ä¼˜åŒ–é˜¶æ®µï¼šåŸºäºæŸ¥è¯¢æˆæœ¬çš„è€ƒè™‘ï¼Œé€‰æ‹©æŸ¥è¯¢æˆæœ¬æœ€å°çš„æ‰§è¡Œè®¡åˆ’(é€‰æ‹©ç´¢å¼•ç­‰)ï¼› æ‰§è¡Œé˜¶æ®µï¼šæ ¹æ®æ‰§è¡Œè®¡åˆ’æ‰§è¡Œ SQL æŸ¥è¯¢è¯­å¥ï¼Œä»å­˜å‚¨å¼•æ“è¯»å–è®°å½•ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ","date":"2023-04-20","objectID":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/:13:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ•°æ®åº“","uri":"/06-%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ é—®ï¼šä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Ÿ è¿›ç¨‹çš„è¿è¡Œåˆ†ä¸ºä¸¤ä¸ªçº§åˆ«ï¼š ç”¨æˆ·æ€(user mode)ï¼šç”¨æˆ·æ€è¿è¡Œçš„è¿›ç¨‹å¯ä»¥ç›´æ¥è¯»å–ç”¨æˆ·ç¨‹åºçš„æ•°æ®ã€‚ ç³»ç»Ÿæ€(kernel mode)ï¼šç³»ç»Ÿæ€è¿è¡Œçš„è¿›ç¨‹å‡ ä¹å¯ä»¥è®¿é—®è®¡ç®—æœºçš„ä»»ä½•èµ„æºï¼Œä¸å—é™åˆ¶ã€‚ ç”¨æˆ·å†™çš„ç¨‹åºåŸºæœ¬ä¸Šéƒ½è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œè‹¥æƒ³è°ƒç”¨ä¸ç³»ç»Ÿçº§èµ„æºæœ‰å…³çš„æ“ä½œï¼Œåˆ™å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿè¯·æ±‚ã€‚ è¿™äº›ç³»ç»Ÿè°ƒç”¨æŒ‰åŠŸèƒ½å¤§è‡´å¯åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼š è®¾å¤‡ç®¡ç†ï¼šå®Œæˆè®¾å¤‡çš„è¯·æ±‚æˆ–é‡Šæ”¾ï¼Œä»¥åŠè®¾å¤‡å¯åŠ¨ç­‰åŠŸèƒ½ã€‚ æ–‡ä»¶ç®¡ç†ï¼šå®Œæˆæ–‡ä»¶çš„è¯»ã€å†™ã€åˆ›å»ºåŠåˆ é™¤ç­‰åŠŸèƒ½ã€‚ è¿›ç¨‹æ§åˆ¶ï¼šå®Œæˆè¿›ç¨‹çš„åˆ›å»ºã€æ’¤é”€ã€é˜»å¡åŠå”¤é†’ç­‰åŠŸèƒ½ã€‚ è¿›ç¨‹é€šä¿¡ï¼šå®Œæˆè¿›ç¨‹ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’æˆ–ä¿¡å·ä¼ é€’ç­‰åŠŸèƒ½ã€‚ å†…å­˜ç®¡ç†ï¼šå®Œæˆå†…å­˜çš„åˆ†é…ã€å›æ”¶ä»¥åŠè·å–ä½œä¸šå ç”¨å†…å­˜åŒºå¤§å°åŠåœ°å€ç­‰åŠŸèƒ½ã€‚ é—®ï¼šè¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„åŒºåˆ«ï¼Ÿâ­â­â­ è¿›ç¨‹ çº¿ç¨‹ åç¨‹ å®šä¹‰ æ‹¥æœ‰èµ„æºçš„åŸºæœ¬å•ä½ ç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œçº¿ç¨‹å†…éƒ¨è°ƒåº¦çš„åŸºæœ¬å•ä½ åˆ‡æ¢æƒ…å†µ è¿›ç¨‹CPUç¯å¢ƒï¼ˆæ ˆã€å¯„å­˜å™¨ã€é¡µè¡¨å’Œæ–‡ä»¶å¥æŸ„ç­‰ï¼‰çš„ä¿å­˜ä»¥åŠæ–°è°ƒåº¦çš„è¿›ç¨‹CPUç¯å¢ƒçš„è®¾ç½® ä¿å­˜å’Œè®¾ç½®ç¨‹åºè®¡æ•°å™¨ã€å°‘é‡å¯„å­˜å™¨å’Œæ ˆçš„å†…å®¹ å…ˆå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜ï¼Œç­‰åˆ‡æ¢å›æ¥çš„æ—¶å€™å†è¿›è¡Œæ¢å¤ åˆ‡æ¢è€… æ“ä½œç³»ç»Ÿ æ“ä½œç³»ç»Ÿ ç”¨æˆ· åˆ‡æ¢è¿‡ç¨‹ ç”¨æˆ·æ€-\u003eå†…æ ¸æ€-\u003eç”¨æˆ·æ€ ç”¨æˆ·æ€-\u003eå†…æ ¸æ€-\u003eç”¨æˆ·æ€ ç”¨æˆ·æ€ï¼ˆæ²¡æœ‰é™·å…¥å†…æ ¸ï¼‰ è°ƒç”¨æ ˆ å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆ å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆ ç”¨æˆ·æ ˆ æ‹¥æœ‰èµ„æº CPUèµ„æºã€å†…å­˜èµ„æºã€æ–‡ä»¶èµ„æºå’Œå¥æŸ„ç­‰ ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨ã€æ ˆå’ŒçŠ¶æ€å­— æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆ å¹¶å‘æ€§ ä¸åŒè¿›ç¨‹ä¹‹é—´åˆ‡æ¢å®ç°å¹¶å‘ï¼Œå„è‡ªå æœ‰CPUå®ç°å¹¶è¡Œ ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨çš„å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªåç¨‹ï¼Œè€Œå…¶ä»–åç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œé€‚åˆå¯¹ä»»åŠ¡è¿›è¡Œåˆ†æ—¶å¤„ç† ç³»ç»Ÿå¼€é”€ åˆ‡æ¢è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œåˆ‡æ¢å†…æ ¸æ ˆå’Œç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼ŒCPUé«˜é€Ÿç¼“å­˜å¤±æ•ˆã€é¡µè¡¨åˆ‡æ¢ï¼Œå¼€é”€å¾ˆå¤§ åˆ‡æ¢æ—¶åªéœ€ä¿å­˜å’Œè®¾ç½®å°‘é‡å¯„å­˜å™¨å†…å®¹ï¼Œå› æ­¤å¼€é”€å¾ˆå° ç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿« é€šä¿¡æ–¹é¢ è¿›ç¨‹é—´é€šä¿¡éœ€è¦å€ŸåŠ©æ“ä½œç³»ç»Ÿ çº¿ç¨‹é—´å¯ä»¥ç›´æ¥è¯»å†™è¿›ç¨‹æ•°æ®æ®µï¼ˆå¦‚å…¨å±€å˜é‡ï¼‰æ¥è¿›è¡Œé€šä¿¡ å…±äº«å†…å­˜ã€æ¶ˆæ¯é˜Ÿåˆ— è¿›ç¨‹çš„æ‰§è¡Œä½“-\u003eçº¿ç¨‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œä½“-\u003eåç¨‹ã€‚ æ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯æœ‰ç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤åˆ›å»ºå¤§é‡è¿›ç¨‹æ—¶ä¼šé€ æˆå†…å­˜å¼€é”€æ˜¾è‘—ï¼›æ“ä½œç³»ç»Ÿè¿›è¡Œè¿›ç¨‹è°ƒåº¦æ—¶ï¼Œéœ€è¦åˆ‡æ¢è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå°±ä¼šåˆ‡æ¢é¡µè¡¨ã€‚CPU é€šè¿‡ MMU å°†é€»è¾‘åœ°å€è½¬åˆ°ç‰©ç†åœ°å€ï¼Œä¸ºäº†å‡å°‘è®¿å­˜æ¬¡æ•°è®¾ç½®äº† TLBï¼Œè€Œåªæœ‰ä¸€ä¸ª TLBï¼Œå› æ­¤è¿›ç¨‹åˆ‡æ¢ä¼šé€ æˆ TLB å¤±æ•ˆï¼Œè¿›è€Œåœ°å€è½¬æ¢æ•ˆç‡é™ä½ã€‚è€Œçº¿ç¨‹åˆ‡æ¢ä¸éœ€è¦åˆ‡æ¢è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå› æ­¤å‡ºç°çº¿ç¨‹ã€‚ å¤šçº¿ç¨‹ä¸‹ï¼Œè¿›ç¨‹æ‹¥æœ‰çš„èµ„æºæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ï¼Œä½†æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„å†…æ ¸æ•°æ®ç»“æ„ã€å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆã€‚ä¸ºä»€ä¹ˆè¦åˆ†åˆ«æ‹¥æœ‰ä¸¤ä¸ªæ ˆå‘¢ï¼Ÿå¯¹äºå†…æ ¸æ¥è®²ï¼Œæ‰€æœ‰ç”¨æˆ·ä»£ç éƒ½è¢«è§†ä¸ºä¸å®‰å…¨çš„ï¼Œæ“ä½œç³»ç»Ÿä¸å…è®¸ç”¨æˆ·æ€ä»£ç è®¿é—®å†…æ ¸æ•°æ®ï¼Œçº¿ç¨‹è¿›å…¥å†…æ ¸æ€åæ‰§è¡Œçš„æ˜¯å†…æ ¸æä¾›çš„ä»£ç ï¼Œè‹¥è·Ÿç”¨æˆ·æ€å…±ç”¨ä¸€ä¸ªæ ˆå°±ä¼šç•™ä¸‹å®‰å…¨æ¼æ´(æ ˆä¸Šæ•°æ®å¯èƒ½ä¼šè¢«ç”¨æˆ·ç¨‹åºéæ³•è¯»å–)ï¼Œå› æ­¤è¦ç»™å†…æ ¸æ€å•ç‹¬åˆ†é…æ ˆã€‚ çº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œæ— éœ€åˆ‡æ¢è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ— éœ€åˆ‡æ¢é¡µè¡¨ï¼ŒTLB ç¼“å­˜ä¹Ÿå°±ä¸ä¼šå¤±æ•ˆï¼Œåªéœ€è¦åˆ‡æ¢è‡ªå·±æ‹¥æœ‰çš„å¯„å­˜å™¨å’Œæ ˆï¼Œå› æ­¤æ€§èƒ½æ˜¾è‘—æå‡ã€‚ ==ä¸ºä»€ä¹ˆè¦æœ‰åç¨‹å‘¢ï¼Ÿ== çº¿ç¨‹çš„åˆ‡æ¢ï¼Œæ˜¯æŠ¢å å¼çš„ï¼Œä¾ç„¶éœ€è¦æ“ä½œç³»ç»Ÿå‚ä¸ï¼Œå‡å¦‚å¹¶å‘é‡ä¸æ–­å¢å¤§ï¼Œçº¿ç¨‹æ•°é‡è¾¾åˆ°ç™¾ä¸‡çº§åˆ«æ—¶éœ€è¦å¤§é‡çº¿ç¨‹ï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹åªéœ€æ‰§è¡Œå¾ˆçŸ­çš„æ—¶é—´ç‰‡ï¼Œè¿™æ ·çš„åˆ‡æ¢å°±æ˜¾å¾—å¾ˆç¬¨é‡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ–¹é¢ï¼Œçº¿ç¨‹çš„å†…æ ¸æ•°æ®ç»“æ„ã€å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆä¼šå ç”¨å¤§é‡å†…å­˜ï¼›å¦ä¸€æ–¹é¢ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»ŸåŸºäºæ—¶é—´ç‰‡ç­–ç•¥è¿›è¡Œè°ƒåº¦çš„ï¼Œåœ¨å¦‚æ­¤åºå¤§çš„çº¿ç¨‹æ•°é‡ä¸‹ï¼Œä¸ºäº†å°½é‡é™ä½å»¶è¿Ÿï¼Œçº¿ç¨‹æ¯æ¬¡å¾—ä»¥è¿è¡Œçš„æ—¶é—´ç‰‡ä¼šè¢«å‹ç¼©ï¼Œé€ æˆçº¿ç¨‹åˆ‡æ¢é¢‘ç‡çš„å¤§å¹…æé«˜ã€‚çº¿ç¨‹åˆ‡æ¢è¿‡äºé¢‘ç¹æ—¶ï¼Œè°ƒåº¦ä¼šå ç”¨å¤§é‡CPUèµ„æºï¼Œé€ æˆæ€§èƒ½ä¸‹é™ã€‚ é—®é¢˜æ˜äº†ï¼š è¦èŠ‚çœå†…å­˜ç©ºé—´ï¼Œè®©ä¸»æµæœåŠ¡å™¨èƒ½è½»æ¾è£…è½½ç™¾ä¸‡çº§çš„è½»é‡çº¿ç¨‹ï¼› è¦é™ä½è°ƒåº¦ä»£ä»·ï¼Œåˆ‡æ¢èµ·æ¥æ›´åŠ è½»å¿«ã€‚ åç¨‹æ˜¯é€šè¿‡ä¸»åŠ¨è®©å‡ºçš„ï¼Œè°ƒåº¦æ— éœ€é€šè¿‡æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯ç”±ç”¨æˆ·ç¨‹åºç®¡ç†ï¼Œè¿™å°±é™ä½äº†è°ƒåº¦ä»£ä»·ã€‚å¹¶ä¸”åç¨‹åªæœ‰ä¸€ä¸ªç”¨æˆ·æ ˆï¼Œä¸€ä¸ªçº¿ç¨‹çš„å†…å­˜åœ¨MBçº§åˆ«ï¼Œè€Œåç¨‹åªéœ€è¦KBçº§åˆ«ï¼Œè¿™å°±èŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚ ä»»åŠ¡æŠ½è±¡ ä¸Šä¸‹æ–‡ è¿›ç¨‹ PCB çº¿ç¨‹ TCB åç¨‹ use-defined ==å‡½æ•°å’Œåç¨‹çš„åŒºåˆ«ï¼Ÿ== å‡½æ•°å¯ä»¥çœ‹æˆä¸€ä¸ªç‰¹æ®Šçš„åç¨‹ã€‚å‡½æ•°çš„è°ƒç”¨å…¶å®å°±æ˜¯ï¼š è°ƒç”¨è€…ä¸»åŠ¨è®©å‡ºCPUï¼Œåˆ›å»ºå‡½æ•°æ ˆå¸§ï¼Œè½¬è€Œæ‰§è¡Œè°ƒç”¨å‡½æ•°ï¼› returnæ—¶å†é”€æ¯è¢«è°ƒå‡½æ•°æ ˆå¸§ï¼Œè¢«è°ƒå‡½æ•°ä¸»åŠ¨è®©å‡ºCPUï¼› è¿”å›ç»§ç»­æ‰§è¡Œè°ƒç”¨è€…å‡½æ•°ã€‚ è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªæœ‰å‡½æ•°è°ƒç”¨æ—¶ï¼Œè¢«è°ƒå‡½æ•°æ‰æ‹¥æœ‰CPUï¼›åªæœ‰å‡½æ•°ç»“æŸæ—¶ï¼Œè¢«è°ƒå‡½æ•°æ‰ä¼šä¸»åŠ¨è®©å‡ºã€‚ä½†æ˜¯ï¼Œåç¨‹å¯ä»¥å¤šæ¬¡æ‹¥æœ‰CPUã€å¤šæ¬¡ä¸»åŠ¨è®©å‡ºCPUã€‚è¿™å°±æ˜¯æœ€å¤§çš„åŒºåˆ«ã€‚ é—®ï¼šçº¿ç¨‹ä¹‹é—´å…±äº«çš„èµ„æºæœ‰å“ªäº›ï¼Ÿ å¯ä»¥å…ˆåˆ†æä¸€ä¸‹ï¼Œå“ªäº›èµ„æºæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼š æ ˆ ç¨‹åºè®¡æ•°å™¨ å‡½æ•°è¿è¡Œä½¿ç”¨çš„å¯„å­˜å™¨ æ ˆæŒ‡é’ˆ ä»¥ä¸Šå¯ä»¥ç»Ÿç§°ä¸ºçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚ é‚£é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä½™çš„å°±åº”è¯¥æ˜¯å…±äº«çš„äº†ï¼š ä»£ç åŒº çº¿ç¨‹ä¹‹é—´å…±äº«ä»£ç åŒºï¼Œè¿™å°±æ„å‘³ç€ç¨‹åºä¸­çš„ä»»ä½•ä¸€ä¸ªå‡½æ•°éƒ½å¯ä»¥æ”¾åˆ°çº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œä¸å­˜åœ¨æŸä¸ªå‡½æ•°åªèƒ½è¢«ç‰¹å®šçº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µã€‚ æ•°æ®åŒº ç”¨æ¥å­˜å‚¨å…¨å±€å˜é‡ã€‚æ•°æ®åŒºä¸­çš„å…¨å±€å˜é‡æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°è¯¥å…¨å±€å˜é‡ã€‚ å †åŒº åªè¦çŸ¥é“å˜é‡çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ï¼Œå› æ­¤å †åŒºä¹Ÿæ˜¯çº¿ç¨‹å…±äº«çš„å±äºè¿›ç¨‹çš„èµ„æºã€‚ æ ˆåŒº ä¸Šè¾¹è¯´äº†ï¼Œæ ˆåŒºæ˜¯ç§æœ‰çš„ã€‚ä½†æ˜¯ï¼ï¼ï¼å°½ç®¡æ˜¯ç§æœ‰çš„ï¼Œä½†å¦‚æœä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°äº†å¦ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨å˜é‡çš„åœ°å€ï¼Œé‚£ä¹ˆç…§æ ·æ˜¯å¯ä»¥ä¿®æ”¹å®ƒçš„ï¼ï¼ï¼ç†åº”æ˜¯ç§æœ‰çš„ï¼Œä½†æ²¡æœ‰ä»€ä¹ˆä¿æŠ¤æªæ–½ï¼Œå¯¼è‡´è¿˜ç®—æ˜¯å…±æœ‰çš„ã€‚ åŠ¨æ€é“¾æ¥åº“ é—®ï¼šä¸ºä»€ä¹ˆçº¿ç¨‹åˆ‡æ¢æ¯”è¿›ç¨‹åˆ‡æ¢å¿«å‘¢ï¼Ÿ æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ç‹¬ç«‹äºå…¶ä»–è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚è€Œè¿›ç¨‹åˆ‡æ¢ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ‡æ¢ è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼šCPU ä¸Šçš„ MMU å’Œ å†…å­˜ä¸­çš„é¡µè¡¨ï¼Œä¸ºäº†å‡å°‘è®¿é—®å†…å­˜çš„æ¬¡æ•°ï¼Œè®¾è®¡äº†å¿«è¡¨(é¡µè¡¨ç¼“å­˜)ã€‚ ç”±äºè¿›ç¨‹åˆ‡æ¢ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ‡æ¢ï¼Œè¿™å°±å¯¼è‡´å†…å­˜ä¸­çš„é¡µè¡¨ä¹Ÿéœ€è¦è¿›è¡Œåˆ‡æ¢ï¼Œä¸€ä¸ªè¿›ç¨‹å¯¹åº”ä¸€ä¸ªé¡µè¡¨æ˜¯ä¸å‡ï¼Œä½†æ˜¯ CPU ä¸­çš„ TLB åªæœ‰ä¸€ä¸ªå•Šï¼é¡µè¡¨åˆ‡æ¢åè¿™ä¸ª TLB å°±å¤±æ•ˆäº†ã€‚è¿™æ ·ï¼ŒTLB åœ¨ä¸€æ®µæ—¶é—´å†…è‚¯å®šæ˜¯æ— æ³•è¢«å‘½ä¸­çš„ï¼Œæ“ä½œç³»ç»Ÿå°±å¿…é¡»å»è®¿é—®å†…å­˜ï¼Œé‚£ä¹ˆè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€å°±ä¼šå˜æ…¢ï¼Œè¡¨ç°å‡ºæ¥çš„å°±æ˜¯ç¨‹åºè¿è¡Œä¼šå˜æ…¢ã€‚ è€Œçº¿ç¨‹åˆ‡æ¢ä¸éœ€è¦åˆ‡æ¢è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜äº†ã€‚ é—®ï¼šè¿›ç¨‹æœ‰å“ªäº›çŠ¶æ€ï¼Ÿ åˆ›å»ºçŠ¶æ€(new)ï¼šè¿›ç¨‹æ­£åœ¨è¢«åˆ›å»ºï¼Œå°šæœªåˆ°å°±ç»ªçŠ¶æ€ã€‚ å°±ç»ªçŠ¶æ€(ready)ï¼šè¿›ç¨‹å·²å¤„äºå‡†å¤‡è¿è¡ŒçŠ¶æ€ï¼Œå³è¿›ç¨‹è·å¾—äº†é™¤äº†å¤„ç†å™¨ä¹‹å¤–çš„ä¸€åˆ‡æ‰€éœ€èµ„æºï¼Œä¸€æ—¦å¾—åˆ°å¤„ç†å™¨èµ„æº(å¤„ç†å™¨åˆ†é…çš„æ—¶é—´ç‰‡)å³å¯è¿è¡Œã€‚ è¿è¡ŒçŠ¶æ€(running)ï¼šè¿›ç¨‹æ­£åœ¨å¤„ç†å™¨ä¸Šä¸Šè¿è¡Œ(å•æ ¸ CPU ä¸‹ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€)ã€‚ é˜»å¡çŠ¶æ€(waiting)ï¼šåˆç§°ä¸ºç­‰å¾…çŠ¶æ€ï¼Œè¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€äº‹ä»¶è€Œæš‚åœè¿è¡Œå¦‚ç­‰å¾…æŸèµ„æºä¸ºå¯ç”¨æˆ–ç­‰å¾… IO æ“ä½œå®Œæˆã€‚å³ä½¿å¤„ç†å™¨ç©ºé—²ï¼Œè¯¥è¿›ç¨‹ä¹Ÿä¸èƒ½è¿è¡Œã€‚ ç»“æŸçŠ¶æ€(terminated)ï¼šè¿›ç¨‹æ­£åœ¨ä»ç³»ç»Ÿä¸­æ¶ˆå¤±ã€‚å¯èƒ½æ˜¯è¿›ç¨‹æ­£å¸¸ç»“æŸæˆ–å…¶ä»–åŸå› ä¸­æ–­é€€å‡ºè¿è¡Œã€‚ ä»¥ä¸Šä¸ºåŸºç¡€çŠ¶æ€ï¼Œä½†æ˜¯å¤§é‡è¿›ç¨‹é˜»å¡æ—¶ï¼Œä¹Ÿä¼šå ç”¨å†…å­˜ï¼Œåœ¨è™šæ‹Ÿå†…å­˜ç®¡ç†çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šæŠŠé˜»å¡çŠ¶æ€çš„è¿›ç¨‹çš„ç‰©ç†å†…å­˜ç©ºé—´æ¢å‡ºåˆ°ç¡¬ç›˜ï¼Œç­‰éœ€è¦å†æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œå†ä»ç¡¬ç›˜æ¢å…¥åˆ°ç‰©ç†å†…å­˜ã€‚ æ‰€ä»¥éœ€è¦æ–°çš„çŠ¶æ€-æŒ‚èµ·æ€ï¼Œæ¥æè¿°è¿›ç¨‹æ²¡æœ‰å ç”¨å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´çš„æƒ…å†µã€‚ æŒ‚èµ·çŠ¶æ€å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼šè¿›ç¨‹åœ¨å¤–å­˜ï¼ˆç¡¬ç›˜ï¼‰å¹¶ç­‰å¾…æŸä¸ªäº‹ä»¶çš„å‡ºç°ï¼› å°±ç»ªæŒ‚èµ·çŠ¶æ€ï¼šè¿›ç¨‹åœ¨å¤–å­˜ï¼ˆç¡¬ç›˜ï¼‰ï¼Œä½†åªè¦è¿›å…¥å†…å­˜ï¼Œå³åˆ»ç«‹åˆ»è¿è¡Œï¼› é—®ï¼šè¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼ï¼Ÿ ç®¡é“ï¼šç®¡é“çš„å®è´¨æ˜¯ä¸€ä¸ªå†…æ ¸ç¼“å†²åŒºï¼Œè¿›ç¨‹ä»¥å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼ä»ç¼“å†²åŒºå­˜å–æ•°æ®ï¼Œç®¡é“ä¸€ç«¯çš„è¿›ç¨‹æŒ‰åºå°†æ•°æ®å†™å…¥ç¼“å†²åŒºï¼Œå¦ä¸€ç«¯çš„è¿›ç¨‹åˆ™æŒ‰åºè¯»å‡ºæ•°æ®ã€‚ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ï¼› æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå…·æœ‰ç‰¹å®šçš„æ ¼å¼ï¼Œå­˜æ”¾åœ¨å†…å­˜ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—ä¸é€‚åˆæ¯”è¾ƒå¤§æ•°æ®çš„ä¼ è¾“ï¼Œå› ä¸ºåœ¨å†…æ ¸ä¸­æ¯ä¸ªæ¶ˆæ¯ä½“éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ï¼Œå¹¶ä¸”å­˜åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„æ•°æ®æ‹·è´å¼€é”€å› ä¸ºè¿›ç¨‹å†™å…¥æ•°æ®åˆ°å†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ç”Ÿä»ç”¨æˆ·æ€æ‹·è´æ•°æ®åˆ°å†…æ ¸æ€çš„è¿‡ç¨‹ï¼ŒåŒç†å¦ä¸€è¿›ç¨‹è¯»å–å†…æ ¸ä¸­çš„æ¶ˆæ¯æ•°æ®æ—¶ï¼Œä¼šå‘ç”Ÿä»å†…æ ¸æ€æ‹·è´æ•°æ®åˆ°ç”¨æˆ·æ€çš„è¿‡ç¨‹ï¼› å…±äº«å†…å­˜ï¼šä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹å¯ä»¥åŠæ—¶çœ‹åˆ°å¯¹æ–¹è¿›ç¨‹ä¸­å¯¹å…±äº«å†…å­˜ä¸­æ•°æ®çš„æ›´æ–°ã€‚è¿™ç§æ–¹å¼éœ€è¦ä¾é æŸç§åŒæ­¥æ“ä½œï¼Œå¦‚äº’æ–¥é”å’Œä¿¡å·é‡ç­‰ã€‚å¯ä»¥è¯´è¿™æ˜¯æœ€æœ‰ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚ ä¿¡å·é‡ï¼šä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œä¿¡å·é‡çš„æ„å›¾åœ¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼Œè€Œä¸æ˜¯ç”¨äºç¼“å­˜è¿›ç¨‹é—´é€šä¿¡çš„æ•°æ®ã€‚ ä¸€ä¸ªæ˜¯ P æ“ä½œï¼Œè¿™ä¸ªæ“ä½œä¼šæŠŠä¿¡å·é‡å‡å» 1ï¼Œç›¸å‡åå¦‚æœä¿¡å·é‡ \u003c 0ï¼Œåˆ™è¡¨æ˜èµ„æºå·²è¢«å ç”¨ï¼Œè¿›ç¨‹éœ€é˜»å¡ç­‰å¾…ï¼›ç›¸å‡åå¦‚æœä¿¡å·é‡ \u003e= 0ï¼Œåˆ™è¡¨æ˜è¿˜æœ‰èµ„æºå¯ä½¿ç”¨ï¼Œè¿›ç¨‹å¯æ­£å¸¸ç»§ç»­æ‰§è¡Œã€‚ å¦ä¸€ä¸ªæ˜¯ V æ“ä½œï¼Œè¿™ä¸ªæ“ä½œä¼šæŠŠä¿¡å·é‡åŠ ä¸Š 1ï¼Œç›¸åŠ åå¦‚æœä¿¡å·é‡ \u003c= 0ï¼Œåˆ™è¡¨æ˜å½“å‰æœ‰é˜»å¡ä¸­çš„è¿›ç¨‹ï¼Œäºæ˜¯ä¼šå°†è¯¥è¿›ç¨‹å”¤é†’è¿è¡Œï¼›ç›¸åŠ åå¦‚æœä¿¡å·é‡ \u003e 0ï¼Œåˆ™è¡¨æ˜å½“å‰æ²¡æœ‰é˜»å¡ä¸­çš„è¿›ç¨‹ã€‚ ä¿¡å·ï¼šä¿¡å·æ˜¯Linuxç³»ç»Ÿä¸­ç”¨äºè¿›ç¨‹é—´äº’ç›¸é€šä¿¡æˆ–è€…æ“ä½œçš„ä¸€ç§å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œä¿¡å·å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å‘ç»™æŸä¸€è¿›ç¨‹ï¼Œè€Œæ— éœ€çŸ¥é“è¯¥è¿›ç¨‹çš„çŠ¶æ€ã€‚(å’Œä¿¡å·é‡å®Œå…¨æ²¡å…³ç³»ï¼ï¼)ã€‚æ¯”å¦‚ï¼š Ctrl+Cäº§ç”ŸSigintä¿¡å·ï¼Œè¡¨ç¤ºç»ˆæ­¢è¿›ç¨‹ï¼› kill pidç»ˆæ­¢è¿›ç¨‹ã€‚ å¥—æ¥å­—ï¼šä¸»è¦ç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚ é—®ï¼šè¿›ç¨‹è°ƒåº¦ç®—æ³•æœ‰å“ªäº›ï¼Ÿ å…ˆåˆ°å…ˆæœåŠ¡(FCFS)è°ƒåº¦ç®—æ³•ï¼šä»å°±ç»ªé˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºå¯¹çº¿ç¨‹åˆ†é…èµ„æºï¼Œä½¿å®ƒç«‹å³æ‰§è¡Œå¹¶ä¸€ç›´æ‰§è¡Œåˆ°å®Œæˆæˆ–å‘ç”ŸæŸäº‹ä»¶è€Œè¢«é˜»å¡æ”¾å¼ƒå ç”¨ CPU æ—¶å†é‡æ–°è°ƒåº¦ã€‚ çŸ­ä½œä¸šä¼˜å…ˆ(SJF)çš„è°ƒåº¦ç®—æ³•ï¼šä»å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œé€‰å‡ºä¸€ä¸ªä¼°è®¡è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"äºŒã€åŒæ­¥ã€é” é—®ï¼šçº¿ç¨‹é—´çš„åŒæ­¥æ–¹å¼ï¼Ÿ äº’æ–¥é”(Mutex)ï¼šé‡‡ç”¨äº’æ–¥å¯¹è±¡æœºåˆ¶ï¼Œåªæœ‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰æœ‰è®¿é—®å…¬å…±èµ„æºçš„æƒé™ã€‚ ä¿¡å·é‡(Semaphore)ï¼šå®ƒå…è®¸åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºï¼Œä½†æ˜¯éœ€è¦æ§åˆ¶åŒä¸€æ—¶åˆ»è®¿é—®æ­¤èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚ äº‹ä»¶(Event)ï¼šWait/Notifyï¼šé€šè¿‡é€šçŸ¥çš„æ–¹å¼æ¥ä¿æŒå¤šçº¿ç¨‹åŒæ­¥ï¼Œè¿˜å¯ä»¥æ–¹ä¾¿çš„å®ç°å¤šçº¿ç¨‹ä¼˜å…ˆçº§çš„æ¯”è¾ƒæ“ä½œã€‚ é—®ï¼šéƒ½æœ‰å“ªäº›é”ï¼Ÿ **äº’æ–¥é”ï¼š**ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰äº’æ–¥é”ï¼Œå…¶ä»–çº¿ç¨‹åªæœ‰ç­‰å¾…ï¼ŒåŠ é”å¤±è´¥å°±è®©å‡ºCPUï¼› è‡ªæ—‹é”ï¼šå¦‚æœè¿›/çº¿ç¨‹æ— æ³•å–å¾—é”ï¼Œè¿›/çº¿ç¨‹ä¸ä¼šç«‹åˆ»æ”¾å¼ƒCPUæ—¶é—´ç‰‡ï¼Œè€Œæ˜¯ä¸€ç›´å¾ªç¯å°è¯•è·å–é”(å¿™ç­‰å¾…)ï¼Œç›´åˆ°è·å–ä¸ºæ­¢ï¼› **è¯»å†™é”ï¼š**å¤šä¸ªè¯»è€…å¯åŒæ—¶è·å¾—ï¼Œä½†å†™è€…äº’æ–¥ï¼Œè‹¥æœ‰å†™è€…ï¼Œåˆ™è¯»è€…å¿…é¡»ç­‰å¾…ï¼› **å¦‚æœä½ èƒ½ç¡®å®šè¢«é”ä½çš„ä»£ç æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œå°±ä¸åº”è¯¥ç”¨äº’æ–¥é”ï¼Œè€Œåº”è¯¥é€‰ç”¨è‡ªæ—‹é”ï¼Œå¦åˆ™ä½¿ç”¨äº’æ–¥é”ã€‚**å› ä¸ºçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ä»·ç›¸æ¯”è‡ªæ—‹é”æ¥è¯´ä¹Ÿå¾ˆå¤§ã€‚ é—®ï¼šä¹è§‚é”ä¸æ‚²è§‚é”æ˜¯å•¥ï¼Ÿ æ‚²è§‚é”ï¼šäº’æ–¥é”ã€è‡ªæ—‹é”ã€è¯»å†™é”éƒ½å±äºæ‚²è§‚é”ã€‚æ‚²è§‚é”åšäº‹æ¯”è¾ƒæ‚²è§‚ï¼Œå®ƒè®¤ä¸ºå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºçš„æ¦‚ç‡æ¯”è¾ƒé«˜ï¼Œäºæ˜¯å¾ˆå®¹æ˜“å‡ºç°å†²çªï¼Œæ‰€ä»¥è®¿é—®å…±äº«èµ„æºå‰ï¼Œå…ˆè¦ä¸Šé”ã€‚ **ä¹è§‚é”ï¼š**ä¹è§‚é”åšäº‹æ¯”è¾ƒä¹è§‚ï¼Œå®ƒå‡å®šå†²çªçš„æ¦‚ç‡å¾ˆä½ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼æ˜¯ï¼šå…ˆä¿®æ”¹å®Œå…±äº«èµ„æºï¼Œå†éªŒè¯è¿™æ®µæ—¶é—´å†…æœ‰æ²¡æœ‰å‘ç”Ÿå†²çªï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨ä¿®æ”¹èµ„æºï¼Œé‚£ä¹ˆæ“ä½œå®Œæˆï¼Œå¦‚æœå‘ç°æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹è¿‡è¿™ä¸ªèµ„æºï¼Œå°±æ”¾å¼ƒæœ¬æ¬¡æ“ä½œã€‚ ä¹è§‚é”è™½ç„¶å»é™¤äº†åŠ é”è§£é”çš„æ“ä½œï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†²çªï¼Œé‡è¯•çš„æˆæœ¬éå¸¸é«˜ï¼Œæ‰€ä»¥**åªæœ‰åœ¨å†²çªæ¦‚ç‡éå¸¸ä½ï¼Œä¸”åŠ é”æˆæœ¬éå¸¸é«˜çš„åœºæ™¯æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ä¹è§‚é”ã€‚**æ¯”å¦‚åœ¨çº¿æ–‡æ¡£ã€Gitç­‰ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ æ­»é”ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç”±äºç›¸äº’ç­‰å¾…å¯¹æ–¹å æœ‰çš„èµ„æºè€Œæ°¸è¿œè¢«é˜»å¡çš„æƒ…å†µã€‚ é—®ï¼šäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Ÿ **äº’æ–¥æ¡ä»¶ï¼š**ä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚ **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼š**ä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚ **ä¸å‰¥å¤ºæ¡ä»¶ï¼š**è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å¼ºè¡Œå‰¥å¤ºã€‚ **å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼š**è‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚ é—®ï¼šè§£å†³æ­»é”çš„æ–¹æ³•ï¼Ÿ **é¢„é˜²ï¼š**é‡‡ç”¨æŸç§ç­–ç•¥ï¼Œé™åˆ¶å¹¶å‘è¿›ç¨‹å¯¹èµ„æºçš„è¯·æ±‚ï¼› ç ´åè¯·æ±‚ä¸ä¿æŒï¼šè¿›ç¨‹å¿…é¡»åœ¨æ‰§è¡Œå‰å°±ç”³è¯·åˆ°å®ƒæ‰€éœ€è¦çš„å…¨éƒ¨èµ„æºï¼Œå¹¶ä¸”ç›´åˆ°å®ƒæ‰€è¦çš„èµ„æºéƒ½å¾—åˆ°æ»¡è¶³ä¹‹åæ‰å¼€å§‹æ‰§è¡Œï¼› ç ´åå¾ªç¯ç­‰å¾…ï¼šæ‰€æœ‰çš„èµ„æºè¢«åˆ†æˆäº†å¤šä¸ªå±‚æ¬¡ï¼Œä¸€ä¸ªè¿›ç¨‹å¾—åˆ°æŸä¸€å±‚æ¬¡çš„èµ„æºåï¼Œå®ƒåªèƒ½å†ç”³è¯·è¾ƒé«˜ä¸€å±‚çš„èµ„æºï¼›å½“ä¸€ä¸ªè¿›ç¨‹è¦é‡Šæ”¾æŸå±‚çš„ä¸€ä¸ªèµ„æºæ—¶ï¼Œå¿…é¡»å…ˆé‡Šæ”¾æ‰€å ç”¨çš„è¾ƒé«˜å±‚çš„èµ„æºï¼› é¿å…ï¼šç³»ç»Ÿåœ¨åˆ†é…èµ„æºæ—¶ï¼Œæ ¹æ®èµ„æºçš„ä½¿ç”¨æƒ…å†µæå‰åšå‡ºé¢„æµ‹ï¼Œä»è€Œé¿å…æ­»é”çš„å‘ç”Ÿï¼šé“¶è¡Œå®¶ç®—æ³•ã€‚ **æ£€æµ‹ï¼š**å½“æ­»é”å‘ç”Ÿæ—¶ï¼Œèƒ½å¤Ÿæ£€æµ‹æ­»é”çš„å‘ç”Ÿï¼Œå¹¶ç²¾ç¡®åœ°ç¡®å®šä¸æ­»é”æœ‰å…³çš„è¿›ç¨‹å’Œèµ„æºï¼› **è§£é™¤ï¼š**æ£€æµ‹åˆ°æ­»é”çš„è¿›ç¨‹ï¼Œé‡Šæ”¾å…¶æŒæœ‰çš„èµ„æºã€‚ ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€å†…å­˜ç®¡ç† æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ä¸»è¦è´Ÿè´£å†…å­˜çš„åˆ†é…ä¸å›æ”¶ã€‚ é—®ï¼šå†…å­˜ç®¡ç†æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ ç®€å•åˆ†ä¸ºè¿ç»­åˆ†é…ç®¡ç†æ–¹å¼å’Œéè¿ç»­åˆ†é…ç®¡ç†æ–¹å¼è¿™ä¸¤ç§ã€‚ è¿ç»­åˆ†é…ç®¡ç†æ˜¯æŒ‡ä¸ºä¸€ä¸ªç”¨æˆ·ç¨‹åºåˆ†é…ä¸€ä¸ªè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå¸¸è§çš„å¦‚åˆ†åŒºç®¡ç†æ–¹å¼(å—å¼ç®¡ç†)ã€‚ éè¿ç»­åˆ†é…ç®¡ç†å…è®¸ä¸€ä¸ªç¨‹åºä½¿ç”¨çš„å†…å­˜åˆ†å¸ƒåœ¨ç¦»æ•£æˆ–è€…è¯´ä¸ç›¸é‚»çš„å†…å­˜ä¸­ï¼Œå¸¸è§çš„å¦‚é¡µå¼ç®¡ç† å’Œ æ®µå¼ç®¡ç†ã€‚ å—å¼ç®¡ç†ï¼šå›ºå®šåˆ†åŒºå’ŒåŠ¨æ€åˆ†åŒºã€‚å‰è€…å®¹æ˜“æœ‰å†…éƒ¨ç¢ç‰‡ï¼Œåè€…æœ‰å¤–éƒ¨ç¢ç‰‡ã€‚è¿‡ç¨‹ï¼šå‰è€…å°†å†…å­˜åˆ†ä¸ºå‡ ä¸ªå›ºå®šå¤§å°çš„å—ï¼Œæ¯ä¸ªå—ä¸­åªåŒ…å«ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœç¨‹åºè¿è¡Œéœ€è¦å†…å­˜çš„è¯ï¼Œæ“ä½œç³»ç»Ÿå°±åˆ†é…ç»™å®ƒä¸€å—ã€‚åè€…æŒ‰ç…§è¿›ç¨‹å¤§å°åˆ’åˆ†å—ï¼ŒæŒ‰ç…§é¦–æ¬¡é€‚åº”ç®—æ³•åˆ†é…ã€‚ é¡µå¼ç®¡ç†ï¼šæŠŠå†…å­˜åˆ†ä¸ºå¤§å°ç›¸ç­‰ä¸”å›ºå®šçš„ä¸€é¡µä¸€é¡µçš„å½¢å¼ï¼Œé¡µè¾ƒå°ï¼Œç›¸æ¯”äºå—å¼ç®¡ç†çš„åˆ’åˆ†ç²’åº¦æ›´å°ï¼Œæé«˜äº†å†…å­˜åˆ©ç”¨ç‡ï¼Œå‡å°‘äº†ç¢ç‰‡ã€‚é¡µå¼ç®¡ç†é€šè¿‡é¡µè¡¨å¯¹åº”é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€ã€‚ æ®µå¼ç®¡ç†ï¼šé¡µå¼ç®¡ç†æ˜¯ä»è®¡ç®—æœºè§’åº¦å‡ºå‘è®¾è®¡çš„ï¼Œå¯¹ç”¨æˆ·å®Œå…¨é€æ˜ï¼Œè€Œæ®µå¼ç®¡ç†åˆ™æ˜¯ä»ç”¨æˆ·è§’åº¦å‡ºå‘è®¾è®¡çš„ã€‚å°†è¿›ç¨‹çš„é€»è¾‘ç©ºé—´åˆ’åˆ†ä¸ºä»£ç æ®µã€æ•°æ®æ®µã€æ ˆæ®µã€å †æ®µç­‰ï¼Œæ®µå†…çš„å†…å­˜ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œæ®µå¤–çš„å†…å­˜ç©ºé—´æ˜¯ä¸è¿ç»­çš„ã€‚é€šè¿‡æ®µè¡¨å¯¹åº”é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€ã€‚ æ®µé¡µå¼ç®¡ç†ï¼šæ®µé¡µå¼ç®¡ç†æœºåˆ¶ç»“åˆäº†æ®µå¼ç®¡ç†å’Œé¡µå¼ç®¡ç†çš„ä¼˜ç‚¹ã€‚ç®€å•æ¥è¯´**æ®µé¡µå¼ç®¡ç†æœºåˆ¶å°±æ˜¯æŠŠä¸»å­˜å…ˆåˆ†æˆè‹¥å¹²æ®µï¼Œæ¯ä¸ªæ®µåˆåˆ†æˆè‹¥å¹²é¡µã€‚**æ¯ä¸€ä¸ªç¨‹åºä¸€å¼ æ®µè¡¨ï¼Œæ¯ä¸ªæ®µåˆå»ºç«‹ä¸€å¼ é¡µè¡¨ï¼Œæ®µè¡¨ä¸­çš„åœ°å€æ˜¯é¡µè¡¨çš„èµ·å§‹åœ°å€ï¼Œè€Œé¡µè¡¨ä¸­çš„åœ°å€åˆ™ä¸ºæŸé¡µçš„ç‰©ç†é¡µå·ã€‚ é—®ï¼šé¡µå¼ç®¡ç†ä¸­ï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ€ä¹ˆè½¬æ¢ï¼Ÿ é¡µå·å’Œé¡µå†…åç§»ã€‚ é¡µå·ä½œä¸ºé¡µè¡¨çš„ç´¢å¼•ï¼Œé¡µè¡¨åŒ…å«ç‰©ç†é¡µæ¯é¡µæ‰€åœ¨ç‰©ç†å†…å­˜çš„åŸºåœ°å€ã€‚åŸºåœ°å€ä¸é¡µå†…åç§»çš„ç»„åˆå°±å½¢æˆäº†ç‰©ç†å†…å­˜åœ°å€ã€‚ é—®ï¼šå¤šçº§é¡µè¡¨æœ‰å•¥ç”¨ï¼Ÿ æŠŠå­˜å‚¨å¤§é‡é¡µè¡¨é¡¹çš„é¡µè¡¨ï¼Œå†æ¬¡åˆ†é¡µã€‚ å¼•å…¥å¤šçº§é¡µè¡¨çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é¿å…æŠŠå…¨éƒ¨é¡µè¡¨é¡¹ä¸€ç›´æ”¾åœ¨å†…å­˜ä¸­å ç”¨è¿‡å¤šç©ºé—´ï¼Œç‰¹åˆ«æ˜¯é‚£äº›æ ¹æœ¬å°±ä¸éœ€è¦çš„é¡µè¡¨å°±ä¸éœ€è¦ä¿ç•™åœ¨å†…å­˜ä¸­ã€‚å¤šçº§é¡µè¡¨å±äºæ—¶é—´æ¢ç©ºé—´çš„å…¸å‹åœºæ™¯ã€‚ æ¯”å¦‚ï¼Œ32ä½ç³»ç»Ÿï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´å…±æœ‰ 4GBï¼Œå‡è®¾ä¸€ä¸ªé¡µçš„å¤§å°æ˜¯ 4KB(2^12)ï¼Œé‚£ä¹ˆå°±æœ‰å¤§çº¦ 1024 * 1024 (2^20) ä¸ªé¡µï¼Œæ¯ä¸ªã€Œé¡µè¡¨é¡¹ã€éœ€è¦ 4 ä¸ªå­—èŠ‚å¤§å°æ¥å­˜å‚¨ï¼Œé‚£ä¹ˆæ•´ä¸ª 4GB ç©ºé—´çš„æ˜ å°„å°±éœ€è¦æœ‰ 4MB çš„å†…å­˜æ¥å­˜å‚¨é¡µè¡¨ã€‚å¯ä»¥åˆ’åˆ†æˆäºŒçº§é¡µè¡¨ï¼Œç¬¬ä¸€çº§æ˜¯1024ä¸ªé¡µè¡¨é¡¹ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹å¯¹åº”ä¸€ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ä¸­åˆæœ‰1024ä¸ªé¡µè¡¨é¡¹ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼šå½“æŸ¥æ‰¾æ—¶ï¼Œé¦–å…ˆé€šè¿‡ä¸€çº§é¡µè¡¨æ‰¾åˆ°äºŒçº§é¡µé¢ï¼Œç„¶åå°†æŒ‡å‘çš„é¡µé¢è°ƒå…¥å†…å­˜ï¼Œç„¶åæ‰¾åˆ°é¡µè¡¨é¡¹ã€‚ä¹Ÿå°±æ˜¯è¯´å†…å­˜ä¸­åªéœ€è¦å­˜å‚¨ç”¨åˆ°çš„é¡µé¢å³å¯ã€‚è¿™å°†å¤§å¤§å‡å°‘éœ€è¦è°ƒå…¥å†…å­˜çš„é¡µè¡¨é¡¹æ€»æ•°ã€‚ å¦‚æœä½¿ç”¨äº†äºŒçº§åˆ†é¡µï¼Œä¸€çº§é¡µè¡¨å°±å¯ä»¥è¦†ç›–æ•´ä¸ª 4GB è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¦‚æœæŸä¸ªä¸€çº§é¡µè¡¨çš„é¡µè¡¨é¡¹æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œä¹Ÿå°±ä¸éœ€è¦åˆ›å»ºè¿™ä¸ªé¡µè¡¨é¡¹å¯¹åº”çš„äºŒçº§é¡µè¡¨äº†ï¼Œå³å¯ä»¥åœ¨éœ€è¦æ—¶æ‰åˆ›å»ºäºŒçº§é¡µè¡¨ã€‚åšä¸ªç®€å•çš„è®¡ç®—ï¼Œå‡è®¾åªæœ‰ 20% çš„ä¸€çº§é¡µè¡¨é¡¹è¢«ç”¨åˆ°äº†ï¼Œé‚£ä¹ˆé¡µè¡¨å ç”¨çš„å†…å­˜ç©ºé—´å°±åªæœ‰ 4KBï¼ˆä¸€çº§é¡µè¡¨ï¼‰ + 20% * 4MBï¼ˆäºŒçº§é¡µè¡¨ï¼‰= 0.804MBï¼Œè¿™å¯¹æ¯”å•çº§é¡µè¡¨çš„ 4MB æ˜¯ä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„èŠ‚çº¦ï¼Ÿ å¯¹äº 64ä½ç³»ç»Ÿï¼Œé€šå¸¸é‡‡ç”¨å››çº§é¡µè¡¨ã€‚ é—®ï¼šå¿«è¡¨(TLB) æ˜¯å•¥ï¼Ÿ å¿«è¡¨(TLB)ï¼šå°†æœ€å¸¸è®¿é—®çš„é¡µè¡¨é¡¹å­˜å‚¨åˆ°è®¿é—®é€Ÿåº¦æ›´å¿«çš„Cacheä¸­ã€‚ å› ä¸ºè‹¥æŠŠé¡µè¡¨å…¨éƒ¨æ”¾å…¥å†…å­˜ï¼Œå­˜å–ä¸€æ¡æ•°æ®è‡³å°‘è¦è®¿é—®ä¸¤æ¬¡å†…å­˜ï¼Œç¬¬ä¸€æ¬¡å…ˆè®¿é—®é¡µè¡¨æ‰¾åˆ°æ•°æ®å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œç¬¬äºŒæ¬¡å†ä»è¯¥åœ°å€å­˜å–æ•°æ®ã€‚å¯¹äºå¤šçº§é¡µè¡¨ï¼Œéœ€è¦è®¿é—®å†…å­˜çš„æ¬¡æ•°ä¼šæ›´å¤šã€‚ è€Œè‹¥å‘½ä¸­å¿«è¡¨ï¼Œåˆ™åªéœ€è¦ä¸€æ¬¡è®¿å­˜ã€‚ é—®ï¼šæ®µé¡µå¼å†…å­˜ç®¡ç†çš„å®ç°ï¼Ÿ å…ˆå°†ç¨‹åºåˆ’åˆ†ä¸ºå¤šä¸ªæœ‰é€»è¾‘æ„ä¹‰çš„æ®µï¼šæ ˆæ®µã€å †æ®µã€BSSæ®µã€æ•°æ®æ®µã€ä»£ç æ®µï¼Œä¹Ÿå°±æ˜¯åˆ†æ®µæœºåˆ¶ï¼› æ¥ç€å†æŠŠæ¯ä¸ªæ®µåˆ’åˆ†ä¸ºå¤šä¸ªé¡µï¼Œä¹Ÿå°±æ˜¯å¯¹åˆ†æ®µåˆ’åˆ†å‡ºæ¥çš„è¿ç»­ç©ºé—´ï¼Œå†åˆ’åˆ†å›ºå®šå¤§å°çš„é¡µï¼› åœ°å€ç»“æ„å°±ç”±æ®µå·ã€æ®µå†…é¡µå·å’Œé¡µå†…ä½ç§»ä¸‰éƒ¨åˆ†ç»„æˆï¼š æ®µé¡µå¼åœ°å€å˜æ¢ä¸­è¦å¾—åˆ°ç‰©ç†åœ°å€é¡»ç»è¿‡ä¸‰æ¬¡å†…å­˜è®¿é—®ï¼š ç¬¬ä¸€æ¬¡è®¿é—®æ®µè¡¨ï¼Œå¾—åˆ°é¡µè¡¨èµ·å§‹åœ°å€ï¼› ç¬¬äºŒæ¬¡è®¿é—®é¡µè¡¨ï¼Œå¾—åˆ°ç‰©ç†é¡µå·ï¼› ç¬¬ä¸‰æ¬¡å°†ç‰©ç†é¡µå·ä¸é¡µå†…ä½ç§»ç»„åˆï¼Œå¾—åˆ°ç‰©ç†åœ°å€ã€‚ é—®ï¼šè™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ç¨‹åºä¸­ä½¿ç”¨çš„å†…å­˜åœ°å€ï¼Œå®é™…è®¿é—®æ—¶é€šè¿‡ å†…å­˜ç®¡ç†å•å…ƒ(MMU) å’Œ å†…å­˜ä¸­çš„é¡µè¡¨ è½¬åŒ–ä¸ºç‰©ç†åœ°å€ã€‚==å®é™…ä¸Šå¹¶ä¸å­˜åœ¨ã€‚== æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ç‹¬ç«‹äºå…¶ä»–è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´å°†ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œä¸åŒå†…å­˜çš„ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ã€‚ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸»è¦æ˜¯ä¸ºäº†ï¼š é¿å…ç›´æ¥æ“ä½œç‰©ç†åœ°å€ã€‚å¯èƒ½ä¼šå¯¹æ“ä½œç³»ç»Ÿé€ æˆå½±å“ï¼› ä¸åŒè¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€å½¼æ­¤éš”ç¦»ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä»£ç æ— æ³•æ›´æ”¹æ­£åœ¨ç”±å¦ä¸€è¿›ç¨‹æˆ–æ“ä½œç³»ç»Ÿä½¿ç”¨çš„ç‰©ç†å†…å­˜ï¼› æ˜“ç§»æ¤æ€§ã€‚å¯ä»¥å±è”½æ“ä½œç³»ç»Ÿç‰©ç†åœ°å€çš„å·®åˆ«ã€‚ å¯ä»¥ä½¿ç”¨ä¸€ç³»åˆ—ç›¸é‚»çš„è™šæ‹Ÿåœ°å€æ¥è®¿é—®ç‰©ç†å†…å­˜ä¸­ä¸ç›¸é‚»çš„å¤§å†…å­˜ç¼“å†²åŒºã€‚ é—®ï¼šè™šæ‹Ÿå†…å­˜æ˜¯å•¥ï¼Ÿè™šæ‹Ÿå†…å­˜ç®¡ç†æœ‰å•¥ç”¨ï¼Ÿ è™šæ‹Ÿå†…å­˜æ˜¯ä¸€ç§é€»è¾‘ä¸Šæ‰©å……ç‰©ç†å†…å­˜çš„æŠ€æœ¯ï¼Œå°±æ˜¯å°†ç¡¬ç›˜çš„ä¸€éƒ¨åˆ†ä½œä¸ºå†…å­˜æ¥ä½¿ç”¨ã€‚==æ˜¯å®é™…å­˜åœ¨çš„ã€‚== è™šæ‹Ÿå†…å­˜æŠ€æœ¯åŸºäºä¸€ä¸ªéå¸¸é‡è¦çš„åŸç†ï¼Œå±€éƒ¨æ€§åŸç†ï¼š 1ï¼‰æ—¶é—´å±€éƒ¨æ€§ï¼šå¦‚æœæ‰§è¡Œäº†ç¨‹åºä¸­çš„æŸæ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆä¸ä¹…åè¿™æ¡æŒ‡ä»¤å¾ˆæœ‰å¯èƒ½å†æ¬¡æ‰§è¡Œï¼›å¦‚æœæŸä¸ªæ•°æ®è¢«è®¿é—®è¿‡ï¼Œä¸ä¹…ä¹‹åè¯¥æ•°æ®å¾ˆå¯èƒ½å†æ¬¡è¢«è®¿é—®ã€‚ï¼ˆå› ä¸ºç¨‹åºä¸­å­˜åœ¨å¤§é‡çš„å¾ªç¯ï¼‰ 2ï¼‰ç©ºé—´å±€éƒ¨æ€§ï¼šä¸€æ—¦ç¨‹åºè®¿é—®äº†æŸä¸ªå­˜å‚¨å•å…ƒï¼Œåœ¨ä¸ä¹…ä¹‹åï¼Œå…¶é™„è¿‘çš„å­˜å‚¨å•å…ƒä¹Ÿå¾ˆæœ‰å¯èƒ½è¢«è®¿é—®ï¼ˆå› ä¸ºå¾ˆå¤šæ•°æ®åœ¨å†…å­˜ä¸­éƒ½æ˜¯è¿ç»­å­˜æ”¾çš„ï¼Œå¹¶ä¸”ç¨‹åºçš„æŒ‡ä»¤ä¹Ÿæ˜¯é¡ºåºåœ°åœ¨å†…å­˜ä¸­å­˜æ”¾çš„ï¼‰ åŸºäºè¿™ä¸ªå±€éƒ¨æ€§åŸç†ï¼š åœ¨ä¸€ä¸ªç¨‹åºè£…å…¥å†…å­˜çš„æ—¶å€™ï¼Œå¯ä»¥åªå°†è¿™ä¸ªç¨‹åºä¸­å¾ˆå¿«ä¼šç”¨åˆ°çš„éƒ¨åˆ†è£…å…¥å†…å­˜ï¼Œæš‚æ—¶ç”¨ä¸åˆ°çš„éƒ¨åˆ†ä»ç„¶ç•™åœ¨å¤–å­˜ï¼ˆç£ç›˜ï¼‰ï¼Œå¹¶ä¸”ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼› è€Œåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“ CPU æ‰€éœ€è¦çš„ä¿¡æ¯ä¸åœ¨å†…å­˜ä¸­çš„æ—¶å€™ï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£å°†æ‰€éœ€ä¿¡æ¯ä»å¤–å­˜ï¼ˆç£ç›˜ï¼‰è°ƒå…¥å†…å­˜ï¼Œç„¶åç»§ç»­æ‰§è¡Œç¨‹åºï¼› å¦‚æœè°ƒå…¥å†…å­˜çš„æ—¶å€™å†…å­˜ç©ºé—´ä¸å¤Ÿï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£å°†å†…å­˜ä¸­æš‚æ—¶ç”¨ä¸åˆ°çš„ä¿¡æ¯æ¢å‡ºåˆ°å¤–å­˜ã€‚ è™šæ‹Ÿå†…å­˜ç®¡ç†ä¸»è¦æ˜¯ä¸ºäº†ï¼š é€»è¾‘ä¸Šæ‰©å¤§å®é™…çš„ç‰©ç†å†…å­˜ã€‚(å°±è¿™ä¸€ä¸ª) é—®ï¼šè™šæ‹Ÿå†…å­˜çš„æŠ€æœ¯å®ç°ï¼Ÿé¡µé¢ç½®æ¢ç®—æ³•æœ‰å“ªäº›ï¼Ÿ è¯·æ±‚åˆ†é¡µç®¡ç†ï¼ˆé¡µå¼è™šå­˜ç³»ç»Ÿï¼‰ è¯·æ±‚åˆ†æ®µç®¡ç†ï¼ˆæ®µå¼è™šå­˜ç³»ç»Ÿï¼‰ è¯·æ±‚æ®µé¡µå¼ç®¡ç†ï¼ˆæ®µé¡µå¼è™šå­˜ç³»ç»Ÿï¼‰ ä»¥è¯·æ±‚åˆ†é¡µç®¡ç†ä¸ºä¾‹ï¼šè¯·æ±‚æ‰é¡µã€ç¼ºé¡µä¸­æ–­ã€é¡µé¢ç½®æ¢ã€‚ åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“æ‰€è®¿é—®çš„é¡µä¸åœ¨å†…å­˜æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç¼ºé¡µä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿå°†å†…å­˜ä¸­ç¼ºå¤±çš„é¡µé¢ä»ç£ç›˜è°ƒå…¥å†…å­˜ï¼› è‹¥æ­¤æ—¶æœ‰ç©ºé—²çš„å—ï¼Œå°±è°ƒå…¥ç©ºé—²çš„å—ï¼› è‹¥æ— ç©ºé—²çš„å—ï¼Œå°±éœ€è¦å…ˆæ·˜æ±°æ‰æŸé¡µã€‚ è‹¥å†…å­˜ç©ºé—´ä¸å¤Ÿï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£å°†å†…å­˜ä¸­æš‚æ—¶ç”¨ä¸åˆ°çš„ä¿¡æ¯æ¢å‡ºåˆ°ç£ç›˜ï¼ˆæ“ä½œç³»ç»Ÿè¦æä¾›é¡µé¢ç½®æ¢çš„åŠŸèƒ½ï¼Œ å°†æš‚æ—¶ç”¨ä¸åˆ°çš„é¡µé¢æ¢å‡ºç£ç›˜ï¼‰ã€‚ FIFO ç®—æ³•ï¼Œå…ˆå…¥å…ˆæ·˜æ±°ï¼› LRU ç®—æ³•ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†å®ç°å¤æ‚ï¼› Clock ç®—æ³•ï¼Œæ•ˆç‡è¿‘ä¼¼ LRUï¼Œä½†å®ç°ç®€å•ç‚¹ æ”¹è¿›å‹çš„ CLOCK ç®—æ³•æ­¥éª¤å¦‚ä¸‹ï¼š **ä¸¤ä¸ªæ ‡å¿—ä½ï¼š**è®¿é—®ä½å’Œä¿®æ”¹ä½ ä»æŒ‡é’ˆçš„å½“å‰ä½ç½®å¼€å§‹ï¼Œæ‰«æå¾ªç¯é˜Ÿåˆ—ã€‚åœ¨è¿™æ¬¡æ‰«æè¿‡ç¨‹ä¸­ï¼Œå¯¹è®¿é—®ä½ä¸åšä»»ä½•ä¿®æ”¹ã€‚é€‰æ‹©é‡åˆ°çš„ç¬¬ä¸€ä¸ªæ˜¯ç¬¬ 0 ç±» â€œæœªè¢«è®¿é—®ï¼Œæœªè¢«ä¿®æ”¹ (Referenced bit = 0ï¼ŒModified bit = 0)â€ çš„é¡µé¢ç”¨äºæ›¿æ¢ å¦‚æœç¬¬ 1 æ­¥å¤±è´¥ï¼Œåˆ™é‡æ–°æ‰«æï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ˜¯ â€œæœªè¢«è®¿é—®ï¼Œè¢«ä¿®æ”¹ (Referenced bit = 0ï¼ŒModified bit = 1)â€ çš„é¡µé¢ç”¨äºæ›¿æ¢ã€‚åœ¨è¿™æ¬¡æ‰«æè¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸ªè·³è¿‡çš„é¡µé¢ï¼Œå’Œç®€å•çš„ CLOCK ç®—æ³•ä¸€æ ·ï¼ŒæŠŠå®ƒçš„è®¿é—®ä½è®¾ç½®æˆ 0 å¦‚æœç¬¬ 2 æ­¥å¤±è´¥ï¼ŒæŒ‡é’ˆå°†å›åˆ°å®ƒçš„æœ€åˆä½ç½®ï¼Œå¹¶ä¸”é›†åˆä¸­æ‰€æœ‰é¡µé¢çš„è®¿é—®ä½éƒ½å·²ç»è¢«è®¾ç½®ä¸º 0 äº†ã€‚é‡å¤ç¬¬ 1 æ­¥ï¼Œå¹¶ä¸”å¦‚æœæœ‰å¿…è¦ï¼Œé‡å¤ç¬¬ 2 æ­¥ã€‚è¿™æ ·ä¸€å®šå¯ä»¥æ‰¾åˆ°ä¾›æ›¿æ¢çš„é¡µé¢ã€‚ ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"å››ã€æ–‡ä»¶ç³»ç»Ÿï¼ˆæœªï¼‰ ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:4:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"äº”ã€ç½‘ç»œç³»ç»Ÿ ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:5:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"ç½‘ç»œè¯·æ±‚å¤„ç† é»‘é©¬è§†é¢‘ redis æœ€åã€‚ é˜»å¡IO (Bloking IO) å…ˆè®²è®²é˜»å¡ IO çš„æ•°æ®æ¥æ”¶æµç¨‹ï¼š æœåŠ¡ç«¯è¿›ç¨‹ A é€šè¿‡ socket() å‡½æ•°é™·å…¥å†…æ ¸æ€è¿›è¡Œ socket ç³»ç»Ÿè°ƒç”¨ï¼Œè¯¥å†…æ ¸å‡½æ•°ä¼šåˆ›å»º socket å†…æ ¸å¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªé‡è¦æ•°æ®ç»“æ„ï¼šç­‰å¾…é˜Ÿåˆ—å’Œæ¥æ”¶é˜Ÿåˆ—ã€‚ ç­‰å¾…é˜Ÿåˆ—ï¼šå­˜æ”¾æœåŠ¡ç«¯è¿›ç¨‹Açš„è¿›ç¨‹æè¿°ç¬¦å’Œå›è°ƒå‡½æ•°ï¼› æ¥æ”¶é˜Ÿåˆ—ï¼šå­˜æ”¾ç½‘å¡æ¥æ”¶åˆ°çš„è¯¥ socket è¦å¤„ç†çš„æ•°æ®ã€‚ è¿›ç¨‹ A è°ƒç”¨ recv() å‡½æ•°æ¥æ”¶æ•°æ®ï¼Œä¼šè¿›å…¥åˆ° recvfrom() ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå‘ç° socket çš„æ¥æ”¶é˜Ÿåˆ—æ²¡æœ‰å®ƒè¦æ¥æ”¶çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œè¿›ç¨‹ A ä¼šè®©å‡º CPUï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿›ç¨‹ A çš„è¿›ç¨‹æè¿°ç¬¦å’Œå®ƒè¢«å”¤é†’ç”¨åˆ°çš„å›è°ƒå‡½æ•° callback func ä¼šç»„æˆä¸€ä¸ªç»“æ„ä½“ï¼Œç§°ä¸ºç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œæ”¾å…¥ socket çš„ç­‰å¾…é˜Ÿåˆ—ï¼› å®¢æˆ·ç«¯çš„å‘é€æ•°æ®åˆ°è¾¾æœåŠ¡ç«¯çš„ç½‘å¡ï¼› ç½‘å¡é¦–å…ˆä¼šå°†ç½‘ç»œä¼ è¾“è¿‡æ¥çš„æ•°æ®é€šè¿‡ DMA æ§åˆ¶ç¨‹åºå¤åˆ¶åˆ°å†…å­˜ç¯å½¢ç¼“å†²åŒº RingBuffer ä¸­ï¼› ç½‘å¡å‘ CPU å‘å‡ºç¡¬ä¸­æ–­ï¼› CPU æ”¶åˆ°äº†ç¡¬ä¸­æ–­åï¼Œä¸ºäº†é¿å…è¿‡åº¦å ç”¨ CPU å¤„ç†ç½‘ç»œè®¾å¤‡è¯·æ±‚å¯¼è‡´å…¶ä»–è®¾å¤‡å¦‚é¼ æ ‡å’Œé”®ç›˜çš„æ¶ˆæ¯æ— æ³•è¢«å¤„ç†ï¼Œä¼šè°ƒç”¨ç½‘ç»œé©±åŠ¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œè¿›è¡Œç®€å•å¿«é€Ÿå¤„ç†åå‘å†…æ ¸ä¸­æ–­è¿›ç¨‹ ksoftirqd å‘å‡ºè½¯ä¸­æ–­ï¼Œå°±é‡Šæ”¾ CPUï¼Œç”±è½¯ä¸­æ–­è¿›ç¨‹å¤„ç†å¤æ‚è€—æ—¶çš„ç½‘ç»œè®¾å¤‡è¯·æ±‚é€»è¾‘ï¼› å†…æ ¸ä¸­æ–­è¿›ç¨‹ ksoftirqd æ”¶åˆ°è½¯ä¸­æ–­ä¿¡å·åï¼Œä¼šå°†ç½‘å¡å¤åˆ¶åˆ°å†…å­˜çš„æ•°æ®ï¼Œæ ¹æ®æ•°æ®æŠ¥æ–‡çš„ IP å’Œç«¯å£å·ï¼Œå°†å…¶æ‹·è´åˆ°å¯¹åº” socket çš„æ¥æ”¶é˜Ÿåˆ—ï¼› å¹¶é€šè¿‡è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°ï¼Œå”¤é†’è¦å¤„ç†è¯¥æ•°æ®çš„è¿›ç¨‹ Aï¼Œè¿›ç¨‹ A ä¼šè¿›å…¥ CPU çš„è¿è¡Œé˜Ÿåˆ—ï¼Œç­‰å¾…è·å– CPU æ‰§è¡Œæ•°æ®å¤„ç†é€»è¾‘ï¼› è¿›ç¨‹ A è·å– CPU åï¼Œä¼šå›åˆ°ä¹‹å‰è°ƒç”¨ recvfrom() å‡½æ•°æ—¶é˜»å¡çš„ä½ç½®ç»§ç»­æ‰§è¡Œï¼Œè¿™æ—¶å‘ç° socket å†…æ ¸ç©ºé—´çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šæœ‰æ•°æ®ï¼Œä¼šåœ¨å†…æ ¸æ€å°†å†…æ ¸ç©ºé—´çš„ socket ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åæ‰ä¼šå›åˆ°ç”¨æˆ·æ€æ‰§è¡Œè¿›ç¨‹çš„ç”¨æˆ·ç¨‹åºï¼Œä»è€ŒçœŸçš„è§£é™¤é˜»å¡ã€‚ **==é˜»å¡ IO æ¨¡å‹==**å¦‚ä¸‹ï¼š ä¼šå‡ºç°çš„é—®é¢˜ï¼š è¿›ç¨‹åœ¨ recv çš„æ—¶å€™å¤§æ¦‚ç‡ä¼šè¢«é˜»å¡æ‰ï¼Œå¯¼è‡´ç¬¬ä¸€æ¬¡è¿›ç¨‹åˆ‡æ¢ï¼› å½“æ•°æ®åˆ°è¾¾æœåŠ¡ç«¯çš„ç½‘å¡ã€å¹¶ä»ç½‘å¡å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´ socket çš„æ•°æ®æ¥æ”¶é˜Ÿåˆ—æ—¶ï¼Œè¿›ç¨‹ä¼šè¢«å”¤é†’ï¼Œç¬¬äºŒæ¬¡è¿›ç¨‹åˆ‡æ¢ã€‚æ­¤æ—¶è¿˜éœ€è¦å°†æ•°æ®ä»å†…æ ¸æ€å¤åˆ¶åˆ°ç”¨æˆ·æ€ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å¤åˆ¶ä¼šå‡ºç°ä¸¤æ¬¡ï¼› ä¸€ä¸ªè¿›ç¨‹åŒæ—¶åªèƒ½ç­‰å¾…ä¸€æ¡è¿æ¥ï¼Œå¦‚æœæœ‰å¾ˆå¤šå¹¶å‘ï¼Œåˆ™éœ€è¦å¾ˆå¤šè¿›ç¨‹ã€‚ æ€»ç»“ï¼šä¸€æ¬¡æ•°æ®åˆ°è¾¾ä¼šè¿›è¡Œä¸¤æ¬¡è¿›ç¨‹åˆ‡æ¢ï¼Œä¸€æ¬¡æ•°æ®è¯»å–æœ‰ä¸¤æ¬¡é˜»å¡(å‡ºç°åœ¨ä¸¤æ¬¡ç­‰å¾…æ•°æ®æ‹·è´æ—¶)ï¼Œå•è¿›ç¨‹åªèƒ½å¯¹å•è¿æ¥ã€‚ éé˜»å¡IO (Nonbloking IO) éé˜»å¡çš„ Recv() çš„æ•ˆæœæ˜¯ï¼šå¦‚æœæ²¡æœ‰æ•°æ®ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ socket çš„ç­‰å¾…é˜Ÿåˆ—æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨ä¼šç›´æ¥è¿”å›ï¼Œè€Œä¸æ˜¯é˜»å¡çš„ç­‰å¾…ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œéé˜»å¡ IOï¼Œåªæ˜¯å°†ç­‰å¾…æ•°æ®ä»ç½‘å¡åˆ°è¾¾ socket å†…æ ¸ç©ºé—´è¿™ä¸€éƒ¨åˆ†å˜æˆäº†éé˜»å¡çš„ï¼š ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ recvfrom() ä¼šé‡å¤å‘é€è¯·æ±‚æ£€æŸ¥æ•°æ®æ˜¯å¦åˆ°è¾¾å†…æ ¸ç©ºé—´(CPUå¿™ç­‰å¾…)ï¼Œå¦‚æœæ²¡æœ‰åˆ°ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸ä¼šé˜»å¡ã€‚ å½“æ•°æ®å·²ç»åˆ°è¾¾å†…æ ¸ç©ºé—´çš„ socket çš„ç­‰å¾…é˜Ÿåˆ—åï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶è¦ç­‰å¾… recvfrom() å‡½æ•°å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰ä¼šä» recvfrom() ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¸­è¿”å›ã€‚ **æ€»ç»“ï¼š**éé˜»å¡ IO æ¨¡å‹å°†â€œä¸¤å¤„é˜»å¡â€å˜æˆäº†â€œä¸€å¤„é˜»å¡â€ï¼Œä½†ä¾ç„¶å­˜åœ¨â€œä¸¤æ¬¡è¿›ç¨‹åˆ‡æ¢ï¼Œä¸€å¤„é˜»å¡ï¼Œå•è¿›ç¨‹å¯¹å•è¿æ¥â€çš„é—®é¢˜ã€‚ ==èŠ±é‡Œèƒ¡å“¨çš„ï¼Œæ²¡ä»€ä¹ˆç”¨ï¼Œæ•°æ®æ²¡æ¥è¿˜ä¸åœçš„é—®ï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Ÿ== maybe ç±»ä¼¼è‡ªæ—‹é”çš„ä½œç”¨ï¼Ÿ IOå¤šè·¯å¤ç”¨ (IO Multiplexing) IO å¤šè·¯å¤ç”¨å¯ä»¥è§£å†³â€œä¸¤æ¬¡è¿›ç¨‹åˆ‡æ¢ï¼Œå•è¿›ç¨‹å¯¹å•è¿æ¥â€çš„é—®é¢˜ã€‚ é€šè¿‡ä¸€ä¸ªè¿›ç¨‹å¤„ç†å¤šä¸ª TCP è¿æ¥ï¼Œåªå¤„ç†æœ‰æ•°æ®åˆ°è¾¾çš„è¿æ¥ã€‚å½“ç„¶ï¼Œå¦‚æœè¦ç›‘å¬çš„æ‰€æœ‰è¿æ¥éƒ½æ²¡æœ‰æ•°æ®åˆ°è¾¾ï¼Œè¿›ç¨‹è¿˜æ˜¯ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°æŸä¸ªè¿æ¥æœ‰æ•°æ®åˆ°è¾¾æ—¶è¢«å›è°ƒå‡½æ•°å”¤é†’ã€‚ ==é—®é¢˜å°±åœ¨äºå¦‚ä½•å‘ç°å“ªä¸ªè¿æ¥çš„æ•°æ®åˆ°è¾¾äº†ï¼Ÿ== ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:5:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"è¯¦è§£selectã€pollã€epoll å…ˆè¯´æ˜å‡ ä¸ªé‡è¦çš„æ¦‚å¿µï¼š æ–‡ä»¶æè¿°ç¬¦ fdï¼šæ˜¯ä¸€ä¸ªä» 0 å¼€å§‹çš„éè´Ÿæ•´æ•°ï¼Œè¿›ç¨‹ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥æ ‡è¯†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ã€‚Linux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶ã€‚ç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ï¼Œæ–‡ä»¶æè¿°ç¬¦å®é™…å°±æ˜¯è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ã€‚ **æ–‡ä»¶æè¿°ç¬¦é›† fd_setï¼š**select å‡½æ•°å‚æ•°ä¸­çš„ fd_set ç±»å‹è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦çš„é›†åˆï¼Œfd_set çš„æ¯ä¸€ä½æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ¯”å¦‚ï¼Œå½“ select è¿”å› fd_set = 00010011 æ—¶ï¼Œè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ 1ã€2ã€5 å·²ç»å°±ç»ªã€‚ Socketï¼šç”¨äºä¸åŒè¿›ç¨‹é—´çš„é€šä¿¡ã€‚æ“ä½œç³»ç»Ÿå°† Socket æ˜ å°„åˆ°è¿›ç¨‹çš„ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šï¼Œè¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¯»å†™è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡ Socket é€šä¿¡ï¼Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ fd è¯»å†™æ–‡ä»¶ã€‚ IO å¤šè·¯å¤ç”¨ï¼šåˆ©ç”¨å•ä¸ªè¿›ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ª fdï¼Œå¹¶åœ¨æŸä¸ª fd å¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ã€‚ select select å®ç°å¤šè·¯å¤ç”¨çš„æ–¹å¼ï¼šå°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œç„¶åè°ƒç”¨ select å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸é‡Œï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿï¼Œæ£€æŸ¥çš„æ–¹å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„æ–¹å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§ç”Ÿåï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œæ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡éå†çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚ æ‰€ä»¥ï¼Œå¯¹äº select è¿™ç§æ–¹å¼ï¼Œéœ€è¦è¿›è¡Œ 2 æ¬¡ã€Œéå†ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä¸€æ¬¡æ˜¯åœ¨å†…æ ¸æ€é‡Œï¼Œä¸€ä¸ªæ¬¡æ˜¯åœ¨ç”¨æˆ·æ€é‡Œï¼Œè€Œä¸”è¿˜ä¼šå‘ç”Ÿ 2 æ¬¡ã€Œæ‹·è´ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå…ˆä»ç”¨æˆ·ç©ºé—´ä¼ å…¥å†…æ ¸ç©ºé—´ï¼Œç”±å†…æ ¸ä¿®æ”¹åï¼Œå†ä¼ å‡ºåˆ°ç”¨æˆ·ç©ºé—´ä¸­ã€‚ çœ‹ä¸ªä¾‹å­ï¼š æœåŠ¡å™¨è¿›ç¨‹ A å¯åŠ¨çš„æ—¶å€™ï¼Œè¦ç›‘å¬çš„è¿æ¥çš„ socket æ–‡ä»¶æè¿°ç¬¦æ˜¯ 3ã€4ã€5ï¼› å¦‚æœè¿™ä¸‰ä¸ªè¿æ¥å‡æ²¡æœ‰æ•°æ®åˆ°è¾¾ç½‘å¡ï¼Œåˆ™è¿›ç¨‹ A ä¼šè®©å‡º CPUï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼›åŒæ—¶ä¼šå°†è¿›ç¨‹ A çš„è¿›ç¨‹æè¿°ç¬¦å’Œè¢«å”¤é†’æ—¶ç”¨åˆ°çš„å›è°ƒå‡½æ•°ç»„æˆç­‰å¾…é˜Ÿåˆ—é¡¹åŠ å…¥åˆ° socket å¯¹è±¡ 3ã€4ã€5 çš„è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚æ³¨æ„ï¼Œselect è°ƒç”¨æ—¶ï¼Œfdsr æ–‡ä»¶æè¿°ç¬¦é›†ä¼šä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼› å½“ç½‘å¡æ¥æ”¶åˆ°æ•°æ®ï¼Œç„¶åç½‘å¡é€šè¿‡ä¸­æ–­ä¿¡å·é€šçŸ¥ CPU æœ‰æ•°æ®åˆ°è¾¾ï¼Œæ‰§è¡Œä¸­æ–­ç¨‹åºï¼Œä¸­æ–­ç¨‹åºä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š å°†ç½‘ç»œæ•°æ®å†™å…¥åˆ°å¯¹åº” socket çš„æ•°æ®æ¥æ”¶é˜Ÿåˆ—é‡Œé¢ï¼› å”¤é†’é˜Ÿåˆ—ä¸­çš„ç­‰å¾…è¿›ç¨‹ Aï¼Œé‡æ–°å°†è¿›ç¨‹ A æ”¾å…¥ CPU çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼› å‡è®¾è¿æ¥ 3ã€5 æœ‰æ•°æ®åˆ°è¾¾ç½‘å¡ï¼Œæ³¨æ„ï¼Œè¿™æ—¶ select è°ƒç”¨ç»“æŸæ—¶ï¼Œfdsr æ–‡ä»¶æè¿°ç¬¦é›†ä¼šä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼š è¿›ç¨‹ A éœ€è¦éå† fd_setï¼Œè·å–å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ select çš„ç¼ºç‚¹ï¼š æ€§èƒ½å¼€é”€å¤§ è°ƒç”¨ select æ—¶ä¼šé™·å…¥å†…æ ¸ï¼Œè¿™æ—¶éœ€è¦å°†å‚æ•°ä¸­çš„ fd_set ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼›select æ‰§è¡Œå®Œåï¼Œè¿˜éœ€è¦å°† fd_set ä»å†…æ ¸ç©ºé—´æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹è¿™æ ·çš„æ‹·è´ä¼šæ¶ˆè€—æå¤§èµ„æºï¼›ï¼ˆepoll ä¼˜åŒ–ä¸ºä¸æ‹·è´ï¼‰ è¿›ç¨‹è¢«å”¤é†’åï¼Œä¸çŸ¥é“å“ªäº›è¿æ¥å·²å°±ç»ªï¼Œéœ€è¦éå†æ‹·è´è¿‡æ¥çš„ fd_set çš„æ¯ä¸€ä½ï¼›ï¼ˆepoll ä¼˜åŒ–ä¸ºå¼‚æ­¥äº‹ä»¶é€šçŸ¥ï¼‰ åŒæ—¶èƒ½ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å¤ªå°‘ å—é™äº sizeof(fd_set) çš„å¤§å°ï¼Œåœ¨ç¼–è¯‘å†…æ ¸æ—¶å°±ç¡®å®šäº†ä¸”æ— æ³•æ›´æ”¹ã€‚ä¸€èˆ¬æ˜¯ 32 ä½æ“ä½œç³»ç»Ÿæ˜¯ 1024ï¼Œ64 ä½æ˜¯ 2048ã€‚ï¼ˆpollã€epoll ä¼˜åŒ–ä¸ºé€‚åº”é“¾è¡¨æ–¹å¼ï¼‰ poll å’Œ select ç±»ä¼¼ï¼Œåªæ˜¯æè¿° fd é›†åˆçš„æ–¹å¼ä¸åŒï¼špoll ä½¿ç”¨ pollfd ç»“æ„è€Œé select çš„ fd_set ç»“æ„ã€‚ åŸºäºé“¾è¡¨å­˜å‚¨ï¼Œæ— æœ€å¤§æ•°é‡é™åˆ¶ï¼Œå› æ­¤è§£å†³äº† select çš„ç¬¬äºŒä¸ªç¼ºç‚¹ã€‚ epoll epoll æ˜¯å¯¹ select å’Œ poll çš„å·¨å¤§æ”¹è¿›ï¼š è§£å†³äº† select ä¸­ fd_set ä¸æ–­é‡å¤æ‹·è´åˆ°å†…æ ¸çš„é—®é¢˜ï¼šä½¿ç”¨çº¢é»‘æ ‘åœ¨å†…æ ¸ä¸­å­˜å‚¨ä¸€ä»½æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦åªéœ€åœ¨æ·»åŠ æ—¶ä¼ å…¥å†…æ ¸ä¸€æ¬¡ï¼Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°ä¼ å…¥ï¼› é€šè¿‡äº‹ä»¶çš„å‘ç”Ÿè§¦å‘å›è°ƒå‡½æ•°ï¼Œå­˜å‚¨å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œè€Œä¸æ˜¯é€šè¿‡è½®è¯¢çš„æ–¹å¼ï¼› ä½¿ç”¨é˜Ÿåˆ—å­˜å‚¨å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸”ä¼šæŒ‰éœ€è¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— é¡»å†æ¬¡éå†ã€‚ ä¸»è¦æ¶‰åŠ3ä¸ªå‡½æ•°ï¼š // åˆ›å»ºä¸€ä¸ª eventpoll å†…æ ¸å¯¹è±¡ int epoll_create(int size); // å°†è¿æ¥çš„socketå¯¹è±¡æ·»åŠ åˆ° eventpoll å¯¹è±¡ä¸­ï¼Œepoll_eventæ˜¯è¦ç›‘å¬çš„äº‹ä»¶ int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); // ç­‰å¾…è¿æ¥ socket çš„æ•°æ®æ˜¯å¦åˆ°è¾¾ int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout); epoll_create epoll_create å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªå†…æ ¸å¯¹è±¡ eventpollï¼ŒæŠŠå®ƒå…³è”åˆ°å½“å‰è¿›ç¨‹çš„å·²æ‰“å¼€æ–‡ä»¶åˆ—è¡¨ä¸­ã€‚ä¸»è¦åŒ…å«3ä¸ªæˆå‘˜ï¼š struct eventpoll { struct rb_root rbr; // çº¢é»‘æ ‘ï¼Œç®¡ç†ç”¨æˆ·è¿›ç¨‹ä¸‹æ·»åŠ è¿›æ¥çš„æ‰€æœ‰ socket è¿æ¥ struct list_head rdllist; // æ•°æ®å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦éƒ½ä¼šæ”¾åˆ°è¿™é‡Œ wait_queue_head_t wq; // ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨ï¼Œå­˜æ”¾é˜»å¡çš„è¿›ç¨‹ ...... } rbrï¼šä¸€æ£µçº¢é»‘æ ‘ï¼Œç®¡ç†æ‰€æœ‰è¦ç›‘å¬çš„ socket è¿æ¥ï¼Œå¢åˆ æ”¹çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)ï¼› rdllistï¼šå°±ç»ªçš„æè¿°ç¬¦çš„é“¾è¡¨ã€‚å½“æŸä¸ª socket æ³¨å†Œäº‹ä»¶è§¦å‘æ—¶ï¼Œé€šè¿‡æ³¨å†Œçš„å›è°ƒå‡½æ•°å°†å°±ç»ªçš„ socket æ”¾åˆ° rdllist é“¾è¡¨é‡Œï¼› wqï¼šç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚å½“å‰è¿›ç¨‹è¦ç­‰å¾…æ•°æ®ï¼Œå°±ä¼šæŠŠå½“å‰è¿›ç¨‹æè¿°ç¬¦å’Œå›è°ƒå‡½æ•°æ„é€ æˆä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œæ”¾å…¥å½“å‰ wq ç­‰å¾…é˜Ÿåˆ—ã€‚ epoll_ctl epoll_ctl å‡½æ•°æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼šå¢ã€åˆ ã€æ”¹ã€‚ä¸»è¦è´Ÿè´£æŠŠ socket è¿æ¥æ³¨å†Œåˆ° eventpoll å¯¹è±¡é‡Œï¼Œä¼šåšä¸‰ä»¶äº‹ï¼š åˆ›å»ºä¸€ä¸ª epitem å¯¹è±¡ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªå­—æ®µï¼šsocket çš„æ–‡ä»¶æè¿°ç¬¦ã€æ‰€å±çš„ eventpoll å¯¹è±¡çš„æŒ‡é’ˆï¼› å°†ä¸€ä¸ªæ•°æ®åˆ°è¾¾æ—¶ç”¨åˆ°çš„å›è°ƒå‡½æ•°æ·»åŠ åˆ° socket çš„è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼› å°†ç¬¬ 1 æ­¥åˆ›å»ºçš„ epitem å¯¹è±¡æ’å…¥çº¢é»‘æ ‘ã€‚ epoll_wait å½“ eventpoll ç›‘æ§çš„ socket å¯¹è±¡æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¼šé€šè¿‡ socket è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°å”¤é†’çº¢é»‘æ ‘ä¸­çš„èŠ‚ç‚¹ epitemï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ— rdllist ä¸­ï¼› æ£€æŸ¥ eventpoll å¯¹è±¡çš„è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸Šæ˜¯å¦æœ‰ç­‰å¾…é¡¹ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å”¤é†’è¿™ä¸ªè¿›ç¨‹ï¼Œè¿›è¡Œæ•°æ®çš„å¤„ç†ï¼› è¿›ç¨‹å”¤é†’åï¼ŒæŠŠ rdllist ä¸­å°±ç»ªçš„äº‹ä»¶åˆ—è¡¨æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚ é—®ï¼šI/O å¤šè·¯å¤ç”¨æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿå®ç°åŸç†ï¼Ÿâ­ IOå¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åŒæ­¥çš„IOæ¨¡å‹ã€‚è¿™é‡Œçš„I/Oé€šå¸¸æŒ‡ç½‘ç»œI/Oï¼Œä¹ŸæŒ‡Socketé€šä¿¡ã€‚ å¯ä»¥å®ç°å¤šä¸ªè¯·æ±‚å¤ç”¨ä¸€ä¸ªè¿›ç¨‹ã€‚åˆ©ç”¨IOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªçº¿ç¨‹ç›‘è§†å¤šä¸ªæ–‡ä»¶å¥æŸ„ï¼›ä¸€æ—¦æŸä¸ªæ–‡ä»¶å¥æŸ„å°±ç»ªï¼Œå°±èƒ½å¤Ÿé€šçŸ¥åˆ°å¯¹åº”åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œï¼›æ²¡æœ‰æ–‡ä»¶å¥æŸ„å°±ç»ªæ—¶å°±ä¼šé˜»å¡åº”ç”¨ç¨‹åºï¼Œä»è€Œé‡Šæ”¾å‡ºCPUèµ„æºã€‚ æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š selectï¼šé¦–å…ˆå°†æ‰€æœ‰çš„socketéƒ½æ”¾åˆ°ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œç„¶åè°ƒå…¥å†…æ ¸ï¼Œå†…æ ¸é€šè¿‡è½®è¯¢æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶å‘ç”Ÿã€‚ è‹¥æ£€æŸ¥åˆ°äº‹ä»¶å‘ç”Ÿï¼Œå°±å°†æ•´ç»„æ–‡ä»¶æè¿°ç¬¦è°ƒå…¥ç”¨æˆ·æ€ï¼Œç„¶åç”¨æˆ·ç¨‹åºå†æ¬¡è½®è¯¢ï¼Œå¯¹æœ‰äº‹ä»¶å‘ç”Ÿçš„è¿›è¡Œå¤„ç†ã€‚ è¿™ç§æ–¹å¼ï¼Œä¸€å…±è½®è¯¢ä¸¤æ¬¡ï¼Œå¹¶ä¸”éœ€è¦ä¸¤æ¬¡æ‹·è´æ–‡ä»¶æè¿°ç¬¦ã€‚å¹¶ä¸”æœ‰æ•°é‡é™åˆ¶ï¼Œ1024ä¸ªï¼› pollï¼šå’Œselectæ²¡å•¥åŒºåˆ«ï¼Œåªä¸è¿‡æ²¡æœ‰æ•°é‡é™åˆ¶ï¼Œå› ä¸ºæ”¹æˆäº†ç”¨é“¾è¡¨å­˜å‚¨ã€‚ ==epollï¼š== epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨**ã€Œçº¢é»‘æ ‘ã€æ¥å…³æ³¨è¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„äº‹ä»¶**ã€‚çº¢é»‘æ ‘æ˜¯ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹ä¸€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)ã€‚epoll å› ä¸ºåœ¨å†…æ ¸ç»´æŠ¤äº†çº¢é»‘æ ‘ï¼Œå¯ä»¥ä¿å­˜æ‰€æœ‰å¾…æ£€æµ‹çš„äº‹ä»¶ï¼Œä¸éœ€è¦åƒ select/poll åœ¨æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ å…¥æ•´ä¸ªäº‹ä»¶é›†åˆï¼Œåªéœ€è¦ä¼ å…¥ä¸€ä¸ªå¾…æ£€æµ‹çš„äº‹ä»¶ï¼Œå‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å¤§é‡çš„æ•°æ®æ‹·è´å’Œå†…å­˜åˆ†é…ã€‚ epoll ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œå½“è°ƒç”¨ epoll_wait() å‡½æ•°æ—¶ï¼Œåªä¼šè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œmä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ªäº‹ä»¶é›†åˆï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹çš„æ•ˆç‡ã€‚ epoll æœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼š é¿å…äº†è½®è¯¢æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé‡‡ç”¨å›è°ƒå‡½æ•°å®šå‘é€šçŸ¥ç¨‹åºè¦å¤„ç†çš„äº‹ä»¶ï¼Œå¤§å¤§æé«˜äº†CPUæ‰§è¡Œæ•ˆç‡ã€‚ åœ¨å†…æ ¸ä¸­ç»´æŠ¤çº¢é»‘æ ‘ï¼Œé¿å…æ–‡ä»¶æè¿°ç¬¦é›†çš„æ‹·è´è¿‡ç¨‹ã€‚ äº‹ä»¶é€šçŸ¥æœºåˆ¶ é—®ï¼šepoll æ”¯æŒå“ªå‡ ç§äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Ÿ epoll æ”¯æŒä¸¤ç§äº‹ä»¶è§¦å‘æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯è¾¹ç¼˜è§¦å‘(ET)å’Œæ°´å¹³è§¦å‘(LT)ã€‚ LTï¼šå½“è¢«ç›‘æ§çš„ FD æœ‰æ•°æ®å¯è¯»æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä» epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢« read å‡½æ•°è¯»å®Œæ‰ç»“æŸï¼Œç›´è‡³æ•°æ®å¤„ç†å®Œæˆã€‚Epoll çš„é»˜è®¤æ¨¡å¼ã€‚ ETï¼šå½“è¢«ç›‘æ§çš„ FD æœ‰æ•°æ®å¯è¯»æ—¶ï¼ŒæœåŠ¡å™¨ç«¯åªä¼šä» epoll_wait ä¸­è‹é†’ä¸€æ¬¡ï¼Œä¸ç®¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆï¼Œå› æ­¤è¦ä¿è¯ä¸€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œï¼› ET çš„æ•ˆç‡è¦æ¯” LT é«˜ï¼Œä½†æ˜¯å®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºè¦ä¿è¯ä¸€æ¬¡è¯»å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œè¦æ³¨æ„é‡‡ç”¨éé˜»å¡çš„è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯»ä¸åˆ°æ•°æ®äº†ä¹Ÿè¿”å›ï¼Œä¸ç„¶ä¼šä¸€ç›´é˜»å¡åœ¨è¿™é‡Œç­‰å¾…æ•°æ®ã€‚ LT å¯èƒ½ä¼šæœ‰æƒŠç¾¤ç°è±¡ã€‚ åŸºäº epoll çš„æœåŠ¡ç«¯æ¨¡å‹ Redis å°±è·Ÿè¿™ä¸ªç±»ä¼¼ã€‚ ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:5:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"å…­ã€Linux æŸ¥çœ‹è¿›ç¨‹ ps aux | grep è¿›ç¨‹å ps -ef | grep è¿›ç¨‹å ps aux å’Œ ps -ef å‘½ä»¤éƒ½å¯ä»¥ç”¨äºæ˜¾ç¤ºå½“å‰ç³»ç»Ÿä¸­è¿è¡Œçš„è¿›ç¨‹åˆ—è¡¨ï¼Œä½†å®ƒä»¬çš„è¾“å‡ºæ ¼å¼ç•¥æœ‰ä¸åŒã€‚ ps aux å‘½ä»¤çš„è¾“å‡ºæ ¼å¼æ˜¯ä»¥ç”¨æˆ·ä¸ºä¸»å¯¼çš„ï¼Œå®ƒæ˜¾ç¤ºäº†æ‰€æœ‰è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„ç”¨æˆ·ã€è¿›ç¨‹ IDã€CPU å ç”¨ç‡ã€å†…å­˜å ç”¨ç‡ç­‰ã€‚å…¶ä¸­ï¼Œa é€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹ï¼Œu é€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œx é€‰é¡¹è¡¨ç¤ºåŒæ—¶æ˜¾ç¤ºæ²¡æœ‰æ§åˆ¶ç»ˆç«¯çš„è¿›ç¨‹ã€‚ ps -ef å‘½ä»¤çš„è¾“å‡ºæ ¼å¼æ˜¯ä»¥è¿›ç¨‹ä¸ºä¸»å¯¼çš„ï¼Œå®ƒæ˜¾ç¤ºäº†æ‰€æœ‰è¿›ç¨‹çš„ç®€è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„ç”¨æˆ·ã€è¿›ç¨‹ IDã€çˆ¶è¿›ç¨‹ IDã€å¯åŠ¨æ—¶é—´ã€å‘½ä»¤ç­‰ã€‚å…¶ä¸­ï¼Œe é€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹ï¼Œf é€‰é¡¹è¡¨ç¤ºæ˜¾ç¤ºè¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬çˆ¶è¿›ç¨‹ IDã€è¿›ç¨‹çŠ¶æ€ç­‰ã€‚ å› æ­¤ï¼Œps aux è¾“å‡ºçš„ä¿¡æ¯æ¯” ps -ef æ›´è¯¦ç»†ï¼Œä½†ä¹Ÿæ›´å¤æ‚ï¼Œè€Œ ps -ef è¾“å‡ºçš„ä¿¡æ¯åˆ™æ›´ä¸ºç®€æ´ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©ä½¿ç”¨å“ªä¸ªå‘½ä»¤ã€‚ æŸ¥çœ‹ socket $ netstat $ ss # æ¨è è¾“å‡ºçš„å†…å®¹éƒ½å·®ä¸å¤šï¼Œéƒ½åŒ…å«äº† socket çš„çŠ¶æ€ï¼ˆStateï¼‰ã€æ¥æ”¶é˜Ÿåˆ—ï¼ˆRecv-Qï¼‰ã€å‘é€é˜Ÿåˆ—ï¼ˆSend-Qï¼‰ã€æœ¬åœ°åœ°å€ï¼ˆLocal Addressï¼‰ã€è¿œç«¯åœ°å€ï¼ˆForeign Addressï¼‰ã€è¿›ç¨‹ PID å’Œè¿›ç¨‹åç§°ï¼ˆPID/Program nameï¼‰ç­‰ã€‚ **æ¥æ”¶é˜Ÿåˆ—ï¼ˆRecv-Qï¼‰å’Œå‘é€é˜Ÿåˆ—ï¼ˆSend-Qï¼‰**æ¯”è¾ƒç‰¹æ®Šï¼Œåœ¨ä¸åŒçš„ socket çŠ¶æ€ã€‚å®ƒä»¬è¡¨ç¤ºçš„å«ä¹‰æ˜¯ä¸åŒçš„ã€‚ å½“ socket çŠ¶æ€å¤„äº Establishedæ—¶ï¼š Recv-Q è¡¨ç¤º socket æ¥æ”¶ç¼“å†²åŒºä¸­è¿˜æ²¡æœ‰è¢«åº”ç”¨ç¨‹åºè¯»å–çš„å­—èŠ‚æ•°ï¼› Send-Q è¡¨ç¤º socket å‘é€ç¼“å†²åŒºä¸­è¿˜æ²¡æœ‰è¢«è¿œç«¯ä¸»æœºç¡®è®¤çš„å­—èŠ‚æ•°ï¼› è€Œå½“ socket çŠ¶æ€å¤„äº Listen æ—¶ï¼š Recv-Q è¡¨ç¤ºå…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼› Send-Q è¡¨ç¤ºå…¨è¿æ¥é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼› æ—¥å¿—åˆ†æ ç”¨ä¸€ä¸ªå¤§æ¦‚å‡ ä¸‡æ¡è®°å½•çš„ nginx æ—¥å¿—æ–‡ä»¶ access.log ä½œä¸ºæ¡ˆä¾‹ï¼Œçœ‹çœ‹å¦‚ä½•åˆ†æå‡ºã€Œç”¨æˆ·ä¿¡æ¯ã€ã€‚ å‡†å¤‡å·¥ä½œ æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼š $ ls -lh æ—¥å¿—å å¦‚æœæ—¥å¿—æ–‡ä»¶å¤§å°éå¸¸å¤§ï¼Œæœ€å¥½ä¸è¦åœ¨çº¿ä¸Šç¯å¢ƒåšï¼Œä¸‹é¢çš„ access.logå°±åªæœ‰ 6.5 MBï¼š å¦‚æœæ—¥å¿—é‡å¤ªå¤§ï¼Œcatå‘½ä»¤ä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œå¯¼è‡´æ€§èƒ½æŠ–åŠ¨ï¼›æœ€å¥½å…ˆç”¨scpå‘½ä»¤å°†æ—¥å¿—æ–‡ä»¶ä¼ è¾“åˆ°é—²ç½®çš„æœåŠ¡å™¨å†åˆ†æã€‚ æ…ç”¨cat catè¯»å–æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸­æœ‰å¤šå°‘æ•°æ®ï¼Œå®ƒå°±è¯»å¤šå°‘ï¼Œä¸é€‚ç”¨äºå¤§æ–‡ä»¶ã€‚åº”ä½¿ç”¨lesså‘½ä»¤è¯»å–å¤§æ–‡ä»¶çš„å†…å®¹ï¼Œå› ä¸º less å¹¶ä¸ä¼šåŠ è½½æ•´ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯æŒ‰éœ€åŠ è½½ï¼šå…ˆæ˜¯è¾“å‡ºä¸€å°é¡µçš„å†…å®¹ï¼Œå½“è¦å¾€ä¸‹çœ‹çš„æ—¶å€™ï¼Œæ‰ä¼šç»§ç»­åŠ è½½ã€‚ è‹¥è¦çœ‹æ—¥å¿—æœ€æ–°çš„å†…å®¹ï¼Œåº”ä½¿ç”¨tailå‘½ä»¤ï¼š $ tail -n 5 access.log # æŸ¥çœ‹ access.log æœ€æ–°çš„ 5 æ¡æ•°æ® $ tail -f # å®æ—¶æŸ¥çœ‹æ—¥å¿— PV åˆ†æ PV(Page View)ï¼šæŒ‡é¡µé¢çš„è®¿é—®é‡(ç‚¹å‡»æ¬¡æ•°)ã€‚æ¯”å¦‚å¤§å¤šæ•°åšå®¢å¹³å°ï¼Œç‚¹å‡»ä¸€æ¬¡é¡µé¢ï¼Œé˜…è¯»é‡å°±åŠ  1ï¼Œæ‰€ä»¥è¯´ PV çš„æ•°é‡å¹¶ä¸ä»£è¡¨çœŸå®çš„ç”¨æˆ·æ•°é‡ï¼Œåªæ˜¯ç‚¹å‡»é‡ã€‚ åˆ†æ PV æ¯”è¾ƒå®¹æ˜“ï¼Œå› ä¸ºæœ‰å¤šå°‘è¡Œæ—¥å¿—è®°å½•å°±æœ‰å¤šå°‘ PVï¼Œå¯ä»¥ä½¿ç”¨ï¼š $ wc -l access.log # è¾“å‡º access.log æœ‰å¤šå°‘è¡Œ 49903 access.log PV åˆ†ç»„ æ ¹æ®è®¿é—®æ—¶é—´è¿›è¡Œåˆ†ç»„ï¼Œæ¯”å¦‚æŒ‰å¤©åˆ†ç»„ï¼Œå¾—åˆ°æ¯å¤©çš„è®¿é—®é‡ã€‚æ ¹æ®æ—¥å¿—è®°å½•çš„æ ¼å¼ï¼Œæ—¶é—´åœ¨ç¬¬ 4 åˆ—ï¼Œå¯ä»¥åˆ©ç”¨awkæ„é€ è¿‡æ»¤è¯­å¥ï¼š $ awk '{print $4}' access.log ä½†åŒ…å«äº†æ—¶åˆ†ç§’ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤å‡ºå¹´æœˆæ—¥ï¼Œä½¿ç”¨awkçš„substrï¼Œä»ç¬¬ 2 ä¸ªå­—ç¬¦å¼€å§‹ï¼Œæˆªå– 11 ä¸ªå­—ç¬¦ï¼š $ awk '{print substr($4, 2, 11)}' access.log ä½†æ²¡æ’åºï¼Œè¿›ä¸€æ­¥æ’åºï¼Œä½¿ç”¨sortï¼Œç„¶åä½¿ç”¨uniq -cè¿›è¡Œç»Ÿè®¡ï¼š $ awk '{print substr($4, 2, 11)}' access.log | sort | uniq -c æ³¨æ„ï¼Œä½¿ç”¨ uniq -c å‘½ä»¤å‰ï¼Œå…ˆè¦è¿›è¡Œ sort æ’åºï¼Œå› ä¸º uniq å»é‡çš„åŸç†æ˜¯æ¯”è¾ƒç›¸é‚»çš„è¡Œï¼Œç„¶åé™¤å»ç¬¬äºŒè¡Œå’Œè¯¥è¡Œçš„åç»­å‰¯æœ¬ã€‚ UV åˆ†æ UV(Uniq Visitor)ï¼šæŒ‡è®¿é—®äººæ•°ã€‚æ¯”å¦‚å…¬ä¼—å·çš„é˜…è¯»é‡å°±æ˜¯ä»¥ UV ç»Ÿè®¡çš„ï¼Œä¸ç®¡å•ä¸ªç”¨æˆ·ç‚¹å‡»äº†å¤šå°‘æ¬¡ï¼Œæœ€ç»ˆåªç®— 1 æ¬¡é˜…è¯»é‡ã€‚ access.logä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ç”¨ IPåœ°å€ è¿‘ä¼¼ç»Ÿè®¡ï¼š $ awk '{print $1}' access.log | sort | uniq | wc -l è¯¥å‘½ä»¤çš„è¾“å‡ºç»“æœæ˜¯ 2589ï¼Œä¹Ÿå°±è¯´æ˜ UV çš„é‡ä¸º 2589ã€‚ awk '{print $1}' access.logï¼Œå–æ—¥å¿—çš„ç¬¬ 1 åˆ—å†…å®¹ï¼Œå®¢æˆ·ç«¯çš„ IP åœ°å€æ­£æ˜¯ç¬¬ 1 åˆ—ï¼› sortï¼Œå¯¹ä¿¡æ¯æ’åºï¼› uniqï¼Œå»é™¤é‡å¤çš„è®°å½•ï¼› wc -lï¼ŒæŸ¥çœ‹è®°å½•æ¡æ•°ï¼› UV åˆ†ç»„ æŒ‰å¤©åˆ†ç»„åˆ†ææ¯å¤©çš„ UV æ•°é‡ã€‚å‘½ä»¤è¾ƒå¤šï¼Œåˆ†å¼€æ¥çœ‹ï¼š è¿‡æ»¤å‡º ã€Œæ—¥æœŸ + IPåœ°å€ã€ $ awk '{print substr($4, 2, 11) \" \" $1}' access.log | sort | uniq awk å°†ç¬¬ 4 åˆ—çš„æ—¥æœŸå’Œç¬¬ 1 åˆ—çš„å®¢æˆ·ç«¯ IP åœ°å€è¿‡æ»¤å‡ºæ¥ï¼Œå¹¶ç”¨ç©ºæ ¼æ‹¼æ¥èµ·æ¥ï¼› sort å¯¹ awk è¾“å‡ºçš„å†…å®¹è¿›è¡Œæ’åºï¼› æ¥ç€ç”¨ uniq å»é™¤é‡å¤çš„è®°å½•ï¼Œä¹Ÿå°±è¯´ æ—¥æœŸ IP ç›¸åŒçš„è¡Œå°±åªä¿ç•™ä¸€ä¸ªï¼› ç»Ÿè®¡æ¬¡æ•°ï¼Œåœ¨ä¸Šè¿°å‘½ä»¤åæ‹¼æ¥ï¼šawk '{uv[$1]++;next}END{for (day in uv) print day, uv[day]}' $ awk '{print substr($4, 2, 11) \" \" $1}' access.log | sort | uniq | awk '{uv[$1]++;next}END{for (day in uv) print day, uv[day]}' awk æœ¬èº«æ˜¯ã€Œé€è¡Œã€è¿›è¡Œå¤„ç†çš„ï¼Œå½“æ‰§è¡Œå®Œä¸€è¡Œåï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ next å…³é”®å­—æ¥å‘Šè¯‰ awk è·³è½¬åˆ°ä¸‹ä¸€è¡Œï¼ŒæŠŠä¸‹ä¸€è¡Œä½œä¸ºè¾“å…¥ï¼› å¯¹æ¯ä¸€è¡Œè¾“å…¥ï¼Œawk ä¼šæ ¹æ®ç¬¬ 1 åˆ—çš„å­—ç¬¦ä¸²(ä¹Ÿå°±æ˜¯æ—¥æœŸ)è¿›è¡Œç´¯åŠ ï¼Œè¿™æ ·ç›¸åŒæ—¥æœŸçš„ ip åœ°å€ï¼Œå°±ä¼šç´¯åŠ èµ·æ¥ï¼Œä½œä¸ºå½“å¤©çš„ uv æ•°é‡ï¼› ä¹‹åçš„ END å…³é”®å­—ä»£è¡¨ä¸€ä¸ªè§¦å‘å™¨ï¼Œå°±æ˜¯å½“å‰é¢çš„è¾“å…¥å…¨éƒ¨å®Œæˆåï¼Œæ‰ä¼šæ‰§è¡Œ END {} ä¸­çš„è¯­å¥ï¼Œé€šè¿‡ for éå† uv ä¸­æ‰€æœ‰çš„ keyï¼Œæ‰“å°å‡ºæŒ‰å¤©åˆ†ç»„çš„ uv æ•°é‡ã€‚ ç»ˆç«¯ç±»å‹åˆ†æ access.log æ—¥å¿—æœ€æœ«å°¾å…³äº User Agent çš„ä¿¡æ¯ï¼Œä¸»è¦æ˜¯å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ä½¿ç”¨çš„å·¥å…·ï¼šæ‰‹æœºã€æµè§ˆå™¨ç­‰ã€‚ å¯åˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œåˆ†æä¸åŒç»ˆç«¯ç±»å‹åˆ†åˆ«æœ‰å¤šå°‘ã€‚ User Agent çš„ä¿¡æ¯åœ¨æ—¥å¿—é‡Œçš„ç¬¬ 12 åˆ— $ awk '{print $12}' access.log | sort | uniq -c | sort -rn awk è¿‡æ»¤å‡ºç¬¬ 12 åˆ—çš„å†…å®¹ï¼› sort æ’åºï¼› uniq -c å»é‡å¹¶ç»Ÿè®¡ï¼› sort -rn(r è¡¨ç¤ºé€†å‘æ’åºï¼Œ n è¡¨ç¤ºæŒ‰æ•°å€¼æ’åº)ï¼Œå¯¹ç»Ÿè®¡çš„ç»“æœæ’åº åˆ†æ TOP3 è¯·æ±‚ è·å–åˆ°è®¿é—®è·¯å¾„æœ€é¢‘ç¹çš„ TOP3ã€‚ $ awk '{print $7}' access.log | sort | uniq -c | sort -rn | head -n 3 ","date":"2023-04-19","objectID":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/:6:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"æ“ä½œç³»ç»Ÿ","uri":"/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"categories":["é¢è¯•"],"content":"ä¸€ã€TCP ä¸ UDP é—®ï¼šTCP ä¸ UDP çš„åŒºåˆ«â­ æ˜¯å¦é¢å‘è¿æ¥ï¼šUDP åœ¨ä¼ é€æ•°æ®ä¹‹å‰ä¸éœ€è¦å…ˆå»ºç«‹è¿æ¥ï¼›è€Œ TCP æä¾›é¢å‘è¿æ¥çš„æœåŠ¡ï¼Œåœ¨ä¼ é€æ•°æ®ä¹‹å‰å¿…é¡»å…ˆå»ºç«‹è¿æ¥ï¼Œæ•°æ®ä¼ é€ç»“æŸåè¦é‡Šæ”¾è¿æ¥ã€‚ æ˜¯å¦æ˜¯å¯é ä¼ è¾“ï¼šUDP æä¾›ä¸å¯é çš„ä¼ è¾“æœåŠ¡ï¼Œæ”¶åˆ°æŠ¥æ–‡æ— éœ€ç¡®è®¤ï¼Œä¸ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸ä¿è¯æŒ‰åºåˆ°è¾¾ï¼›TCP æä¾›å¯é çš„ä¼ è¾“æœåŠ¡ï¼ŒTCP é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹æ¥å»ºç«‹å’Œé‡Šæ”¾è¿æ¥ï¼Œæ•°æ®ä¼ é€’æ—¶ï¼Œæœ‰ç¡®è®¤ã€çª—å£ã€é‡ä¼ ã€æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿ä¼ è¾“çš„æ•°æ®ï¼Œæ— å·®é”™ã€ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€å¹¶ä¸”æŒ‰åºåˆ°è¾¾ã€‚ ä¼ è¾“å½¢å¼ï¼šTCP æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼ŒUDP æ˜¯é¢å‘æŠ¥æ–‡çš„ã€‚ æ˜¯å¦æä¾›å¹¿æ’­æˆ–å¤šæ’­æœåŠ¡ï¼šTCP åªæ”¯æŒç‚¹å¯¹ç‚¹é€šä¿¡ï¼ŒUDP æ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šã€‚ é¦–éƒ¨å¼€é”€ï¼šTCP é¦–éƒ¨å¼€é”€ï¼ˆ20 ï½ 60 å­—èŠ‚ï¼‰æ¯” UDP é¦–éƒ¨å¼€é”€ï¼ˆ8 å­—èŠ‚ï¼‰è¦å¤§ã€‚ ä¼ è¾“æ•ˆç‡ï¼šç”±äºä½¿ç”¨ TCP è¿›è¡Œä¼ è¾“çš„æ—¶å€™å¤šäº†è¿æ¥ã€ç¡®è®¤ã€é‡ä¼ ç­‰æœºåˆ¶ï¼Œæ‰€ä»¥ TCP çš„ä¼ è¾“æ•ˆç‡è¦æ¯” UDP ä½å¾ˆå¤šã€‚ é—®ï¼šä»€ä¹ˆæ—¶å€™é€‰æ‹© TCPï¼Œä»€ä¹ˆæ—¶å€™é€‰ UDP? UDP ä¸€èˆ¬ç”¨äºå³æ—¶é€šä¿¡ï¼Œæ¯”å¦‚ï¼šè¯­éŸ³ã€è§†é¢‘ã€ç›´æ’­ç­‰ç­‰ã€‚è¿™äº›åœºæ™¯å¯¹ä¼ è¾“æ•°æ®çš„å‡†ç¡®æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œæ¯”å¦‚ä½ çœ‹è§†é¢‘å³ä½¿å°‘ä¸ªä¸€ä¸¤å¸§ï¼Œå®é™…ç»™äººçš„æ„Ÿè§‰åŒºåˆ«ä¹Ÿä¸å¤§ã€‚ TCP ç”¨äºå¯¹ä¼ è¾“å‡†ç¡®æ€§è¦æ±‚ç‰¹åˆ«é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚æ–‡ä»¶ä¼ è¾“ã€å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€è¿œç¨‹ç™»å½•ç­‰ç­‰ã€‚ é—®ï¼šHTTP åŸºäº TCP è¿˜æ˜¯ UDPï¼Ÿ HTTP 3.0 ä¹‹å‰æ˜¯åŸºäº TCP åè®®çš„ï¼Œè€Œ HTTP3.0 å°†å¼ƒç”¨ TCPï¼Œæ”¹ç”¨ åŸºäº UDP çš„ QUIC åè®® ã€‚æ­¤å˜åŒ–ä¸»è¦ä¸ºäº†è§£å†³ HTTP/2 ä¸­å­˜åœ¨çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚ç”±äº HTTP/2 åœ¨å•ä¸ª TCP è¿æ¥ä¸Šä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼Œå—åˆ° TCP æ‹¥å¡æ§åˆ¶çš„å½±å“ï¼Œå°‘é‡çš„ä¸¢åŒ…å°±å¯èƒ½å¯¼è‡´æ•´ä¸ª TCP è¿æ¥ä¸Šçš„æ‰€æœ‰æµè¢«é˜»å¡ã€‚ é—®ï¼šåŸºäº TCPã€UDP çš„åè®®ï¼Ÿ ==åŸºäº TCP çš„åè®®== HTTP åè®®ï¼šè¶…æ–‡æœ¬ä¼ è¾“åè®®(HTTPï¼ŒHyperText Transfer Protocol)ä¸»è¦æ˜¯ä¸º Web æµè§ˆå™¨ä¸ Web æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡è€Œè®¾è®¡çš„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æµè§ˆç½‘é¡µçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç½‘é¡µå°±æ˜¯é€šè¿‡ HTTP è¯·æ±‚è¿›è¡ŒåŠ è½½çš„ã€‚ HTTPS åè®®ï¼šæ›´å®‰å…¨çš„è¶…æ–‡æœ¬ä¼ è¾“åè®®(HTTPSï¼ŒHypertext Transfer Protocol Secure)ï¼Œèº«æŠ« SSL å¤–è¡£çš„ HTTP åè®® FTP åè®®ï¼šæ–‡ä»¶ä¼ è¾“åè®® FTP(File Transfer Protocol)ï¼Œæä¾›æ–‡ä»¶ä¼ è¾“æœåŠ¡ï¼ŒåŸºäº TCP å®ç°å¯é çš„ä¼ è¾“ã€‚ä½¿ç”¨ FTP ä¼ è¾“æ–‡ä»¶çš„å¥½å¤„æ˜¯å¯ä»¥å±è”½æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶å­˜å‚¨æ–¹å¼ã€‚ SMTP åè®®ï¼šç®€å•é‚®ä»¶ä¼ è¾“åè®®(SMTPï¼ŒSimple Mail Transfer Protocol)çš„ç¼©å†™ï¼ŒåŸºäº TCP åè®®ï¼Œç”¨æ¥å‘é€ç”µå­é‚®ä»¶ã€‚æ³¨æ„âš ï¸ï¼šæ¥å—é‚®ä»¶çš„åè®®ä¸æ˜¯ SMTP è€Œæ˜¯ POP3 åè®®ã€‚ POP3/IMAP åè®®ï¼šPOP3 å’Œ IMAP ä¸¤è€…éƒ½æ˜¯è´Ÿè´£é‚®ä»¶æ¥æ”¶çš„åè®®ã€‚ Telnet åè®®ï¼šè¿œç¨‹ç™»é™†åè®®ï¼Œé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»é™†åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚è¢«ä¸€ç§ç§°ä¸º SSH çš„éå¸¸å®‰å…¨çš„åè®®æ‰€å–ä»£ã€‚ SSH åè®®ï¼šSSH(Secure Shell)æ˜¯ç›®å‰è¾ƒå¯é ï¼Œä¸“ä¸ºè¿œç¨‹ç™»å½•ä¼šè¯å’Œå…¶ä»–ç½‘ç»œæœåŠ¡æä¾›å®‰å…¨æ€§çš„åè®®ã€‚åˆ©ç”¨ SSH åè®®å¯ä»¥æœ‰æ•ˆé˜²æ­¢è¿œç¨‹ç®¡ç†è¿‡ç¨‹ä¸­çš„ä¿¡æ¯æ³„éœ²é—®é¢˜ã€‚SSH å»ºç«‹åœ¨å¯é çš„ä¼ è¾“åè®® TCP ä¹‹ä¸Šã€‚ ==åŸºäº UDP çš„åè®®== DHCP åè®®ï¼šåŠ¨æ€ä¸»æœºé…ç½®åè®®ï¼ŒåŠ¨æ€é…ç½® IP åœ°å€ï¼› DNSï¼šåŸŸåç³»ç»Ÿ(DNSï¼ŒDomain Name System)å°†äººç±»å¯è¯»çš„åŸŸå (ä¾‹å¦‚ï¼Œwww.baidu.com) è½¬æ¢ä¸ºæœºå™¨å¯è¯»çš„ IP åœ°å€ (ä¾‹å¦‚ï¼Œ220.181.38.148)ã€‚ æˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸“ä¸ºäº’è”ç½‘è®¾è®¡çš„ç”µè¯è–„ã€‚å®é™…ä¸Š DNS åŒæ—¶æ”¯æŒ UDP å’Œ TCP åè®®ã€‚ é—®ï¼šå¦‚ä½•ç†è§£ TCP æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Ÿ ä¹‹æ‰€ä»¥ä¼šè¯´ TCP æ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ï¼ŒUDP æ˜¯é¢å‘æŠ¥æ–‡çš„åè®®ï¼Œæ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå¯¹ TCP å’Œ UDP åè®®çš„å‘é€æ–¹çš„æœºåˆ¶ä¸åŒã€‚ ä¸ºä»€ä¹ˆ UDP æ˜¯é¢å‘æŠ¥æ–‡çš„ï¼Ÿ å½“ç”¨æˆ·æ¶ˆæ¯é€šè¿‡ UDP åè®®ä¼ è¾“æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¸ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œæ‹†åˆ†ï¼Œåœ¨ç»„è£…å¥½ UDP å¤´éƒ¨åå°±äº¤ç»™ç½‘ç»œå±‚æ¥å¤„ç†ï¼Œæ‰€ä»¥å‘å‡ºå»çš„ UDP æŠ¥æ–‡ä¸­çš„æ•°æ®éƒ¨åˆ†å°±æ˜¯å®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª UDP æŠ¥æ–‡å°±æ˜¯ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯çš„è¾¹ç•Œï¼Œè¿™æ ·æ¥æ”¶æ–¹åœ¨æ¥æ”¶åˆ° UDP æŠ¥æ–‡åï¼Œè¯»ä¸€ä¸ª UDP æŠ¥æ–‡å°±èƒ½è¯»å–åˆ°å®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯ã€‚ ä¸ºä»€ä¹ˆ TCP æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Ÿ å½“ç”¨æˆ·æ¶ˆæ¯é€šè¿‡ TCP åè®®ä¼ è¾“æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†ç»„æˆå¤šä¸ª TCP æŠ¥æ–‡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯è¢«æ‹†åˆ†æˆå¤šä¸ª TCP æŠ¥æ–‡è¿›è¡Œä¼ è¾“ã€‚ è¿™æ—¶ï¼Œæ¥æ”¶æ–¹çš„ç¨‹åºå¦‚æœä¸çŸ¥é“å‘é€æ–¹å‘é€çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ä¸çŸ¥é“æ¶ˆæ¯çš„è¾¹ç•Œæ—¶ï¼Œæ˜¯æ— æ³•è¯»å‡ºä¸€ä¸ªæœ‰æ•ˆçš„ç”¨æˆ·æ¶ˆæ¯çš„ï¼Œå› ä¸ºç”¨æˆ·æ¶ˆæ¯è¢«æ‹†åˆ†æˆå¤šä¸ª TCP æŠ¥æ–‡åï¼Œå¹¶ä¸èƒ½åƒ UDP é‚£æ ·ï¼Œä¸€ä¸ª UDP æŠ¥æ–‡å°±èƒ½ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼Œå‘é€æ–¹å‡†å¤‡å‘é€ ã€ŒHi.ã€å’Œã€ŒI am Xiaolinã€è¿™ä¸¤ä¸ªæ¶ˆæ¯ã€‚ åœ¨å‘é€ç«¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ send å‡½æ•°å®Œæˆæ•°æ®â€œå‘é€â€ä»¥åï¼Œæ•°æ®å¹¶æ²¡æœ‰è¢«çœŸæ­£ä»ç½‘ç»œä¸Šå‘é€å‡ºå»ï¼Œåªæ˜¯ä»åº”ç”¨ç¨‹åºæ‹·è´åˆ°äº†æ“ä½œç³»ç»Ÿå†…æ ¸åè®®æ ˆä¸­ã€‚è‡³äºä»€ä¹ˆæ—¶å€™çœŸæ­£è¢«å‘é€ï¼Œå–å†³äºå‘é€çª—å£ã€æ‹¥å¡çª—å£ä»¥åŠå½“å‰å‘é€ç¼“å†²åŒºçš„å¤§å°ç­‰æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸èƒ½è®¤ä¸ºæ¯æ¬¡ send è°ƒç”¨å‘é€çš„æ•°æ®ï¼Œéƒ½ä¼šä½œä¸ºä¸€ä¸ªæ•´ä½“å®Œæ•´åœ°æ¶ˆæ¯è¢«å‘é€å‡ºå»ã€‚ å®é™…å‘é€æœ‰å¦‚ä¸‹å¯èƒ½çš„æƒ…å†µï¼š å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½è®¤ä¸ºä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯å¯¹åº”ä¸€ä¸ª TCP æŠ¥æ–‡ï¼Œæ­£å› ä¸ºè¿™æ ·ï¼Œæ‰€ä»¥ TCP æ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ã€‚ å½“ä¸¤ä¸ªæ¶ˆæ¯çš„æŸä¸ªéƒ¨åˆ†å†…å®¹è¢«åˆ†åˆ°åŒä¸€ä¸ª TCP æŠ¥æ–‡æ—¶ï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ TCP ç²˜åŒ…é—®é¢˜ï¼Œè¿™æ—¶æ¥æ”¶æ–¹ä¸çŸ¥é“æ¶ˆæ¯çš„è¾¹ç•Œçš„è¯ï¼Œæ˜¯æ— æ³•è¯»å‡ºæœ‰æ•ˆçš„æ¶ˆæ¯ã€‚ è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¦äº¤ç»™åº”ç”¨ç¨‹åºã€‚ é—®ï¼šTCP çš„ç²˜åŒ…é—®é¢˜æ˜¯å•¥ï¼Ÿå’‹è§£å†³å‘¢ï¼ŸUDP æœ‰å—ï¼Ÿ TCP ç²˜åŒ…æ˜¯æŒ‡å‘é€æ–¹å‘é€çš„è‹¥å¹²åŒ…æ•°æ®åˆ°æ¥æ”¶æ–¹æ¥æ”¶æ—¶ç²˜æˆä¸€åŒ…ï¼Œä»æ¥æ”¶ç¼“å†²åŒºçœ‹ï¼Œåä¸€åŒ…æ•°æ®çš„å¤´ç´§æ¥ç€å‰ä¸€åŒ…æ•°æ®çš„å°¾ã€‚å…¶å®å°±æ˜¯æ¶ˆæ¯è¾¹ç•Œæ¨¡ç³Šé€ æˆçš„ã€‚ äº§ç”ŸåŸå› ï¼š ç”±TCPè¿æ¥å¤ç”¨é€ æˆçš„ç²˜åŒ…é—®é¢˜ã€‚ å› ä¸ºTCPé»˜è®¤ä¼šä½¿ç”¨ Nagle ç®—æ³•ï¼Œæ­¤ç®—æ³•ä¼šå¯¼è‡´ç²˜åŒ…é—®é¢˜ï¼šåˆå¹¶ç›¸è¿çš„å°æ•°æ®åŒ…ï¼Œå†ä¸€æ¬¡æ€§å‘é€ï¼Œä»¥è¾¾åˆ°æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡çš„ç›®çš„ã€‚ä½†æ¥æ”¶æ–¹åˆä¸çŸ¥é“ä½ åˆå¹¶äº†ã€‚ æ¥æ”¶æ–¹æ¥ä¸åŠæ¥æ”¶ç¼“å†²åŒºçš„åŒ…ï¼Œå¯¼è‡´ç¼“å†²åŒºæœ‰å¤šä¸ªåŒ…ï¼Œè€Œä¸€æ¬¡æ€§è¯»å–æ—¶ï¼Œå°±å‘ç”Ÿäº†ç²˜åŒ… è§£å†³é—®é¢˜ï¼štcp åè®®çš„åŒ…å¤´æœ‰ 20 å­—èŠ‚ï¼Œip åè®®çš„åŒ…å¤´ä¹Ÿæœ‰ 20 å­—èŠ‚ï¼Œå¦‚æœä»…ä»…ä¼ è¾“ 1 å­—èŠ‚çš„æ•°æ®ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å°±æœ‰ 20 + 20 + 1 = 41 å­—èŠ‚ï¼Œå…¶ä¸­çœŸæ­£æœ‰ç”¨çš„æ•°æ®åªæœ‰ 1 ä¸ªå­—èŠ‚ï¼Œè¿™å¯¹æ•ˆç‡å’Œå¸¦å®½æ˜¯æå¤§çš„æµªè´¹ã€‚ Nagle ç®—æ³•ï¼šå¦‚æœæ˜¯è¿ç»­çš„å°æ•°æ®åŒ…ï¼Œå¤§å°æ²¡æœ‰ä¸€ä¸ª MSSï¼ˆMaximum Segment Sizeï¼Œæœ€å¤§åˆ†æ®µå¤§å°ï¼‰ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æ”¶åˆ°ä¹‹å‰å‘é€çš„æ•°æ®åŒ…çš„ Ack ä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™äº›å°æ•°æ®åŒ…å°±ä¼šåœ¨å‘é€ç«¯æš‚å­˜èµ·æ¥ï¼Œç›´åˆ°å°æ•°æ®åŒ…ç´¯ç§¯åˆ°ä¸€ä¸ª MSSï¼Œæˆ–è€…æ”¶åˆ°ä¸€ä¸ª Ack ä¸ºæ­¢ã€‚ è¿™ä¸ªç®—æ³•è™½ç„¶å‡å°‘äº†ä¸å¿…è¦çš„ç½‘ç»œä¼ è¾“ï¼Œä½†æ—¢å¯¼è‡´äº†å»¶è¿Ÿï¼Œä¹Ÿå¯¼è‡´äº†ç²˜åŒ…ã€‚ è§£å†³æ–¹æ³•ï¼š ä»¥æŒ‡å®šå­—ç¬¦ä¸²ä¸ºåŒ…ç»“æŸæ ‡å¿—ï¼Œæ¯”å¦‚\\nç­‰ï¼Œæ¯”å¦‚HTTPï¼› æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„åŒ…å¤´ï¼Œè®°å½•æœ¬åŒ…çš„æ•°æ®é•¿åº¦ï¼Œç„¶åè‡ªå·±å†™ä¸ªbufferç¼“å†²ä¸€ä¸‹ï¼Œç­‰æ”¶åˆ°æŒ‡å®šé•¿åº¦äº†å†äº¤ä»˜å¤„ç†ï¼›(ä½ ä¸å°±æ˜¯ç”¨çš„è¿™ä¸ªå—ï¼Ÿhhh) æ¯”å¦‚ï¼Œå›ºå®šå‰ 8 ä¸ªå­—èŠ‚ï¼Œå®šä¹‰ä¸ºæ•°æ®é•¿åº¦ï¼ŒçœŸæ­£çš„æ•°æ®åœ¨åé¢ã€‚ å›ºå®šæ¯ä¸ªåŒ…çš„é•¿åº¦(å¤ªä¸çµæ´»äº†)ã€‚ UDP æ˜¯é¢å‘æŠ¥æ–‡çš„(å…·æœ‰é•¿åº¦å­—æ®µ)ï¼Œå…·æœ‰æ¶ˆæ¯è¾¹ç•Œï¼Œæ¯ä¸ªåŒ…éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå› æ­¤ä¸ä¼šã€‚è€ŒTCPé¦–éƒ¨é‡Œæ˜¯æ²¡æœ‰é•¿åº¦è¿™ä¸ªä¿¡æ¯çš„ï¼ŒTCP å‘é€ç«¯åœ¨å‘çš„æ—¶å€™å°±ä¸ä¿è¯å‘çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®æŠ¥ï¼Œä»…ä»…çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµï¼Œè¿™ä¸²å­—èŠ‚æµåœ¨æ¥æ”¶ç«¯æ”¶åˆ°æ—¶å“ªæ€•çŸ¥é“é•¿åº¦ä¹Ÿæ²¡ç”¨ï¼Œå› ä¸ºå®ƒå¾ˆå¯èƒ½åªæ˜¯æŸä¸ªå®Œæ•´æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:1:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"äºŒã€TCP ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ é—®ï¼šTCP ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹â­â­â­ğŸš© ==ä¸‰æŠ¥æ–‡æ¡æ‰‹ï¼š== é¦–å…ˆï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¤„äº CLOSE çŠ¶æ€ã€‚å…ˆæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨ç›‘å¬æŸä¸ªç«¯å£ï¼Œå¤„äº LISTEN çŠ¶æ€ï¼› å®¢æˆ·ç«¯ä¼šéšæœºåˆå§‹åŒ–åºå·(client_isn)ï¼Œå°†æ­¤åºå·ç½®äº TCP é¦–éƒ¨çš„ã€Œåºå·ã€å­—æ®µä¸­ï¼ŒåŒæ—¶æŠŠ SYN æ ‡å¿—ä½ç½®ä¸º 1ï¼Œè¡¨ç¤º SYN æŠ¥æ–‡ã€‚æ¥ç€æŠŠç¬¬ä¸€ä¸ª SYN æŠ¥æ–‡å‘é€ç»™æœåŠ¡ç«¯ï¼Œè¡¨ç¤ºå‘æœåŠ¡ç«¯å‘èµ·è¿æ¥ï¼Œè¯¥æŠ¥æ–‡ä¸åŒ…å«åº”ç”¨å±‚æ•°æ®ï¼Œä¹‹åå®¢æˆ·ç«¯å¤„äº SYN-SENT çŠ¶æ€ï¼› æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ SYN æŠ¥æ–‡åï¼Œé¦–å…ˆæœåŠ¡ç«¯ä¹Ÿéšæœºåˆå§‹åŒ–è‡ªå·±çš„åºå·(server_isn)ï¼Œå°†æ­¤åºå·å¡«å…¥ TCP é¦–éƒ¨çš„ã€Œåºå·ã€å­—æ®µä¸­ï¼Œå…¶æ¬¡æŠŠ TCP é¦–éƒ¨çš„ã€Œç¡®è®¤åº”ç­”å·ã€å­—æ®µå¡«å…¥ client_isn + 1, æ¥ç€æŠŠ SYN å’Œ ACK æ ‡å¿—ä½ç½®ä¸º 1ã€‚æœ€åæŠŠè¯¥æŠ¥æ–‡å‘ç»™å®¢æˆ·ç«¯ï¼Œè¯¥æŠ¥æ–‡ä¹Ÿä¸åŒ…å«åº”ç”¨å±‚æ•°æ®ï¼Œä¹‹åæœåŠ¡ç«¯å¤„äº SYN-RCVD çŠ¶æ€ã€‚ å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯æŠ¥æ–‡åï¼Œè¿˜è¦å‘æœåŠ¡ç«¯å›åº”æœ€åä¸€ä¸ªåº”ç­”æŠ¥æ–‡ï¼Œé¦–å…ˆè¯¥åº”ç­”æŠ¥æ–‡ TCP é¦–éƒ¨ ACK æ ‡å¿—ä½ç½®ä¸º 1ï¼Œå…¶æ¬¡ã€Œç¡®è®¤åº”ç­”å·ã€å­—æ®µå¡«å…¥ server_isn + 1 ï¼Œæœ€åæŠŠæŠ¥æ–‡å‘é€ç»™æœåŠ¡ç«¯ï¼Œè¿™æ¬¡æŠ¥æ–‡å¯ä»¥æºå¸¦å®¢æˆ·åˆ°æœåŠ¡ç«¯çš„æ•°æ®ï¼Œä¹‹åå®¢æˆ·ç«¯å¤„äº ESTABLISHED çŠ¶æ€ã€‚ æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„åº”ç­”æŠ¥æ–‡åï¼Œä¹Ÿè¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚ æ³¨æ„ï¼š TCP è§„å®šæºå¸¦ SYN çš„ç¡®è®¤æŠ¥æ–‡æ®µä¸æºå¸¦æ•°æ®ï¼Œä½†ä¹Ÿè¦æ¶ˆè€—åºå·ï¼› TCP è§„å®šæ™®é€š TCP ç¡®è®¤æŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œè‹¥ä¸æºå¸¦æ•°æ®ï¼Œåˆ™ä¸æ¶ˆè€—åºå·ã€‚å³ä¸Šå›¾ä¼ è¾“çš„ç¬¬ä¸€ä¸ªæ•°æ®æŠ¥æ–‡æ®µåºå·seq=x+1ã€‚å³ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ˜¯å¯ä»¥æºå¸¦æ•°æ®çš„ï¼Œå‰ä¸¤æ¬¡æ¡æ‰‹æ˜¯ä¸å¯ä»¥æºå¸¦æ•°æ®çš„ã€‚ ==å››æŠ¥æ–‡æŒ¥æ‰‹ï¼š== é—®ï¼šç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ç®¡ç†åŠè¿æ¥é˜Ÿåˆ—å’Œå…¨è¿æ¥é˜Ÿåˆ—ï¼Ÿ é—®ï¼šå…¨è¿æ¥é˜Ÿåˆ—å’ŒåŠè¿æ¥é˜Ÿåˆ—æ»¡äº†åˆ†åˆ«ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ å…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œå†æ”¶åˆ°æ–°çš„è¿æ¥ï¼Œå°±ä¼šä¸¢å¼ƒï¼› åŠè¿æ¥é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œå†æ”¶åˆ°æ–°çš„è¿æ¥ï¼Œä¹Ÿä¼šä¸¢å¼ƒã€‚ ä½†åŠè¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œä¸æ„å‘³ç€æ— æ³•å»ºç«‹è¿æ¥äº†ã€‚é€šè¿‡å¼€å¯syncookiesï¼Œå°±å¯ä»¥åœ¨ä¸ä½¿ç”¨ SYN åŠè¿æ¥é˜Ÿåˆ—çš„æƒ…å†µä¸‹æˆåŠŸå»ºç«‹è¿æ¥ã€‚ syncookies æ˜¯è¿™ä¹ˆåšçš„ï¼šæœåŠ¡å™¨æ ¹æ®å½“å‰çŠ¶æ€è®¡ç®—å‡ºä¸€ä¸ªå€¼ï¼Œæ”¾åœ¨å·±æ–¹å‘å‡ºçš„ SYN+ACK æŠ¥æ–‡ä¸­å‘å‡ºï¼Œå½“å®¢æˆ·ç«¯è¿”å› ACK æŠ¥æ–‡æ—¶ï¼Œå–å‡ºè¯¥å€¼éªŒè¯ï¼Œå¦‚æœåˆæ³•ï¼Œå°±è®¤ä¸ºè¿æ¥å»ºç«‹æˆåŠŸï¼š é—®ï¼šTCP è¿æ¥å»ºç«‹è§£å†³çš„é—®é¢˜ï¼Ÿ è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š ä½¿ TCP åŒæ–¹èƒ½å¤Ÿç¡®è®¤å¯¹æ–¹çš„å­˜åœ¨ï¼› ä½¿ TCP åŒæ–¹èƒ½å¤Ÿåå•†ä¸€äº›å‚æ•°(å¦‚ï¼šæœ€å¤§çª—å£å€¼ã€æ˜¯å¦ä½¿ç”¨çª—å£æ‰©å¤§é€‰é¡¹å’Œæ—¶é—´æˆ³é€‰é¡¹ä»¥åŠæœåŠ¡è´¨é‡ç­‰)ï¼› ä½¿ TCP åŒæ–¹èƒ½å¤Ÿå¯¹è¿è¾“å®ä½“èµ„æº(å¦‚ï¼šç¼“å­˜å¤§å°ã€è¿æ¥è¡¨ä¸­çš„é¡¹ç›®ç­‰)è¿›è¡Œåˆ†é…ã€‚ é—®ï¼šä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿâ­ğŸš© ä»ä¸‰ä¸ªæ–¹é¢è®²ï¼š ä¸‰æ¬¡æ¡æ‰‹æ‰å¯ä»¥é˜»æ­¢é‡å¤å†å²è¿æ¥çš„åˆå§‹åŒ–ï¼ˆä¸»è¦åŸå› ï¼‰ï¼› ä¸‰æ¬¡æ¡æ‰‹æ‰å¯ä»¥åŒæ­¥åŒæ–¹çš„åˆå§‹åºåˆ—å·ï¼› ä¸‰æ¬¡æ¡æ‰‹æ‰å¯ä»¥é¿å…èµ„æºæµªè´¹ã€‚ ä¸‰æ¬¡æ¡æ‰‹çš„é¦–è¦åŸå› æ˜¯ä¸ºäº†é˜²æ­¢æ—§çš„é‡å¤è¿æ¥åˆå§‹åŒ–é€ æˆæ··ä¹±ã€‚ å¦‚æœæ˜¯ä¸¤æ¬¡æ¡æ‰‹è¿æ¥ï¼Œå°±æ— æ³•é˜»æ­¢å†å²è¿æ¥ï¼š **é¿å…è¿‡æœŸè¿æ¥çš„å»ºç«‹ã€‚**è‹¥ä¸ºä¸¤æ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯å…ˆç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œç„¶è€Œé˜»å¡äº†ï¼Œç„¶åé‡æ–°å‘èµ·ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œæ­¤æ—¶ç¬¬ä¸€æ¬¡æ¡æ‰‹æ•°æ®æŠ¥å·²ç»åˆ°äº†ï¼Œç„¶åæœåŠ¡ç«¯ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œè¿æ¥å°±å»ºç«‹äº†ï¼Œå°±å¯ä»¥å‘æ•°æ®äº†ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¼šé€šé€šä¸¢å¼ƒï¼ï¼ï¼é€ æˆèµ„æºæµªè´¹ï¼ï¼ï¼ ä¸‰æ¬¡æ¡æ‰‹ç¬¬äºŒä¸»è¦çš„ç›®çš„å°±æ˜¯åŒæ–¹ç¡®è®¤è‡ªå·±ä¸å¯¹æ–¹çš„å‘é€ä¸æ¥æ”¶æ˜¯æ­£å¸¸çš„ï¼Œå¹¶åŒæ­¥åŒæ–¹çš„åˆå§‹åºåˆ—å·ã€‚è‹¥ä¸ºä¸¤æ¬¡ï¼Œåˆ™åªæœ‰ä¸€æ–¹èƒ½ç¡®å®šå¯¹æ–¹çš„åºåˆ—å·ï¼š ç¬¬ä¸€æ¬¡æ¡æ‰‹ ï¼šClient ä»€ä¹ˆéƒ½ä¸èƒ½ç¡®è®¤ï¼›Server ç¡®è®¤äº†å¯¹æ–¹å‘é€æ­£å¸¸ï¼Œè‡ªå·±æ¥æ”¶æ­£å¸¸ ç¬¬äºŒæ¬¡æ¡æ‰‹ ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šå¯¹æ–¹å‘é€æ­£å¸¸ï¼Œè‡ªå·±æ¥æ”¶æ­£å¸¸ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ é—®ï¼šæ¯æ¬¡å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œåˆå§‹åŒ–çš„åºåˆ—å·æœ‰å•¥è®²ç©¶ï¼Ÿâ­ğŸš© æ¯æ¬¡åˆå§‹åŒ–çš„åºåˆ—å·éƒ½è¦æ±‚ä¸ä¸€æ ·ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŸå› ï¼š ä¸ºäº†é˜²æ­¢å†å²æŠ¥æ–‡è¢«ä¸‹ä¸€ä¸ªç›¸åŒå››å…ƒç»„çš„è¿æ¥æ¥æ”¶ï¼ˆä¸»è¦æ–¹é¢ï¼‰ï¼› ä¸ºäº†å®‰å…¨æ€§ï¼Œé˜²æ­¢é»‘å®¢ä¼ªé€ çš„ç›¸åŒåºåˆ—å·çš„ TCP æŠ¥æ–‡è¢«å¯¹æ–¹æ¥æ”¶ã€‚ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ï¼Œåœ¨å®¢æˆ·ç«¯å‘é€æ•°æ®åŒ…è¢«ç½‘ç»œé˜»å¡äº†ï¼Œç„¶åè¶…æ—¶é‡ä¼ äº†è¿™ä¸ªæ•°æ®åŒ…ï¼Œè€Œæ­¤æ—¶æœåŠ¡ç«¯è®¾å¤‡æ–­ç”µé‡å¯äº†ï¼Œä¹‹å‰ä¸å®¢æˆ·ç«¯å»ºç«‹çš„è¿æ¥å°±æ¶ˆå¤±äº†ï¼Œäºæ˜¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®åŒ…çš„æ—¶å€™å°±ä¼šå‘é€ RST æŠ¥æ–‡ã€‚ ç´§æ¥ç€ï¼Œå®¢æˆ·ç«¯åˆä¸æœåŠ¡ç«¯å»ºç«‹äº†ä¸ä¸Šä¸€ä¸ªè¿æ¥ç›¸åŒå››å…ƒç»„çš„è¿æ¥ï¼› åœ¨æ–°è¿æ¥å»ºç«‹å®Œæˆåï¼Œä¸Šä¸€ä¸ªè¿æ¥ä¸­è¢«ç½‘ç»œé˜»å¡çš„æ•°æ®åŒ…æ­£å¥½æŠµè¾¾äº†æœåŠ¡ç«¯ï¼Œåˆšå¥½è¯¥æ•°æ®åŒ…çš„åºåˆ—å·æ­£å¥½æ˜¯åœ¨æœåŠ¡ç«¯çš„æ¥æ”¶çª—å£å†…ï¼Œæ‰€ä»¥è¯¥æ•°æ®åŒ…ä¼šè¢«æœåŠ¡ç«¯æ­£å¸¸æ¥æ”¶ï¼Œå°±ä¼šé€ æˆæ•°æ®é”™ä¹±ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ¯æ¬¡å»ºç«‹è¿æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åˆå§‹åŒ–åºåˆ—å·éƒ½æ˜¯ä¸€æ ·çš„è¯ï¼Œå¾ˆå®¹æ˜“å‡ºç°å†å²æŠ¥æ–‡è¢«ä¸‹ä¸€ä¸ªç›¸åŒå››å…ƒç»„çš„è¿æ¥æ¥æ”¶çš„é—®é¢˜ã€‚å¦‚æœæ¯æ¬¡å»ºç«‹è¿æ¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åˆå§‹åŒ–åºåˆ—å·éƒ½**ã€Œä¸ä¸€æ ·ã€**ï¼Œå°±æœ‰å¤§æ¦‚ç‡å› ä¸ºå†å²æŠ¥æ–‡çš„åºåˆ—å·ã€Œä¸åœ¨ã€å¯¹æ–¹æ¥æ”¶çª—å£ï¼Œä»è€Œå¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…äº†å†å²æŠ¥æ–‡ã€‚ é—®ï¼šåˆå§‹åºåˆ—å·æ˜¯å¦‚ä½•éšæœºäº§ç”Ÿçš„ï¼Ÿâ­ èµ·å§‹ ISN æ˜¯åŸºäºæ—¶é’Ÿçš„ï¼Œæ¯ 4 å¾®ç§’ + 1ï¼Œè½¬ä¸€åœˆè¦ 4.55 ä¸ªå°æ—¶ã€‚ RFC793 æåˆ°åˆå§‹åŒ–åºåˆ—å· ISN éšæœºç”Ÿæˆç®—æ³•ï¼šISN = M + F(localhost, localport, remotehost, remoteport)ã€‚ M æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œè¿™ä¸ªè®¡æ—¶å™¨æ¯éš” 4 å¾®ç§’åŠ  1ã€‚ F æ˜¯ä¸€ä¸ª Hash ç®—æ³•ï¼Œæ ¹æ®æº IPã€ç›®çš„ IPã€æºç«¯å£ã€ç›®çš„ç«¯å£ç”Ÿæˆä¸€ä¸ªéšæœºæ•°å€¼ã€‚è¦ä¿è¯ Hash ç®—æ³•ä¸èƒ½è¢«å¤–éƒ¨è½»æ˜“æ¨ç®—å¾—å‡ºï¼Œç”¨ MD5 ç®—æ³•æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œéšæœºæ•°æ˜¯ä¼šåŸºäºæ—¶é’Ÿè®¡æ—¶å™¨é€’å¢çš„ï¼ŒåŸºæœ¬ä¸å¯èƒ½ä¼šéšæœºæˆä¸€æ ·çš„åˆå§‹åŒ–åºåˆ—å·ã€‚ é—®ï¼šä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿ å› ä¸º TCP æ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå¯ä»¥åŒå‘ä¼ è¾“æ•°æ®ã€‚ä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥åœ¨æ•°æ®ä¼ é€ç»“æŸåå‘å‡ºè¿æ¥é‡Šæ”¾çš„é€šçŸ¥ï¼Œå¾…å¯¹æ–¹ç¡®è®¤åè¿›å…¥åŠå…³é—­çŠ¶æ€ã€‚å½“å¦ä¸€æ–¹ä¹Ÿæ²¡æœ‰æ•°æ®å†å‘é€çš„æ—¶å€™ï¼Œåˆ™å‘å‡ºè¿æ¥é‡Šæ”¾é€šçŸ¥ï¼Œå¯¹æ–¹ç¡®è®¤åå°±å®Œå…¨å…³é—­äº† TCP è¿æ¥ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šA å’Œ B æ‰“ç”µè¯ï¼Œé€šè¯å³å°†ç»“æŸåã€‚ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ ï¼šA è¯´â€œæˆ‘æ²¡å•¥è¦è¯´çš„äº†â€ ç¬¬äºŒæ¬¡æŒ¥æ‰‹ ï¼šB å›ç­”â€œæˆ‘çŸ¥é“äº†â€ï¼Œä½†æ˜¯ B å¯èƒ½è¿˜ä¼šæœ‰è¦è¯´çš„è¯ï¼ŒA ä¸èƒ½è¦æ±‚ B è·Ÿç€è‡ªå·±çš„èŠ‚å¥ç»“æŸé€šè¯ ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ ï¼šäºæ˜¯ B å¯èƒ½åˆå·´æ‹‰å·´æ‹‰è¯´äº†ä¸€é€šï¼Œæœ€å B è¯´â€œæˆ‘è¯´å®Œäº†â€ ç¬¬å››æ¬¡æŒ¥æ‰‹ ï¼šA å›ç­”â€œçŸ¥é“äº†â€ï¼Œè¿™æ ·é€šè¯æ‰ç®—ç»“æŸã€‚ é—®ï¼šå››æ¬¡æŒ¥æ‰‹ä¸­ï¼Œæœ€åå®¢æˆ·ç«¯è¦ç­‰å¾…2MSLï¼Œæœ‰å¿…è¦å—ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥å…³é—­å‘¢ï¼Ÿ MSLï¼šæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´ã€‚ MSL ä¸ TTL çš„åŒºåˆ«ï¼š MSL çš„å•ä½æ˜¯æ—¶é—´ï¼Œè€Œ TTL æ˜¯ç»è¿‡è·¯ç”±è·³æ•°ã€‚æ‰€ä»¥ MSL åº”è¯¥è¦å¤§äºç­‰äº TTL æ¶ˆè€—ä¸º 0 çš„æ—¶é—´ï¼Œä»¥ç¡®ä¿æŠ¥æ–‡å·²è¢«è‡ªç„¶æ¶ˆäº¡ã€‚2MSL å°±ç›¸å½“äºä¸€æ¥ä¸€å›çš„æœ€å¤§æ—¶é—´ã€‚ ==å›ç­”ï¼š== æœ‰å¿…è¦ã€‚å¦‚æœå®¢æˆ·ç«¯æœ€åä¸€æ¬¡ACKæŠ¥æ–‡æ®µä¸¢å¤±äº†ï¼ŒæœåŠ¡ç«¯å°±ä¼šé‡å‘ FINï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨ 2MSL çš„æ—¶é—´å†…æ”¶åˆ°äº† FINï¼Œå°±ä¼šé‡æ–°å‘é€ ACK å¹¶å†æ¬¡ç­‰å¾… 2MSLï¼Œé˜²æ­¢ Server æ²¡æœ‰æ”¶åˆ° ACK è€Œä¸æ–­é‡å‘ FINã€‚ ç­‰å¾… 2MSL æ˜¯ä¸ºäº†ä¿è¯æœ¬æ¬¡è¿æ¥ä¸­äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œé¿å…å½±å“ä¹‹åçš„ TCP è¿æ¥ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:2:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"ä¸‰ã€TCP ä¼ è¾“å¯é æ€§ é—®ï¼šTCP å¦‚ä½•ä¿è¯æ•°æ®ä¼ è¾“å¯é æ€§ï¼Ÿâ­ TCP åŸºäºä»¥å­—èŠ‚ä¸ºå•ä½çš„æ»‘åŠ¨çª—å£æ¥å®ç°å¯é ä¼ è¾“ï¼› TCP æ‹¥æœ‰æ ¡éªŒå’Œæœºåˆ¶ã€‚å¦‚æœæ”¶åˆ°æŠ¥æ–‡æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCP å°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µï¼› TCP é€šè¿‡åºå·æœºåˆ¶ä¿è¯æ•°æ®çš„æŒ‰åºäº¤ä»˜ã€‚ä¼šå°†ä¸æŒ‰åºåˆ°è¾¾çš„æ•°æ®æ”¾åœ¨æ¥æ”¶çª—å£ï¼Œå¾…æ¥æ”¶å®Œæ¯•å†æŒ‰åºäº¤ä»˜ç»™åº”ç”¨å±‚ï¼› TCP è¦æ±‚æ¥æ”¶æ–¹å¿…é¡»æœ‰ç´¯è®¡ç¡®è®¤å’Œæå¸¦ç¡®è®¤æœºåˆ¶ï¼› TCP æ‹¥æœ‰è¶…æ—¶é‡ä¼ æœºåˆ¶ã€‚ä¼šå¯¹å‘é€çš„æŠ¥æ–‡æ®µå¯åŠ¨å®šæ—¶å™¨ï¼Œæœªæ¥æ”¶åˆ°æ¥æ”¶ç«¯å‘æ¥çš„ç¡®è®¤æŠ¥æ–‡ä¼šå¯¼è‡´å®šæ—¶å™¨è¶…æ—¶ï¼Œä»è€Œé‡æ–°å‘é€è¯¥æŠ¥æ–‡æ®µï¼› æµé‡æ§åˆ¶ã€‚æ¥æ”¶ç«¯æ ¹æ®è‡ªèº«æƒ…å†µï¼Œå½“æ¥ä¸åŠå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®æ—¶ï¼Œé™ä½å‘é€ç«¯çš„å‘é€é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚ æ‹¥å¡æ§åˆ¶ã€‚ç½‘ç»œæ‹¥å¡æ—¶ï¼Œç¼©å‡å‘é€ç«¯çš„æ‹¥å¡çª—å£ï¼Œé™ä½æ•°æ®å‘é€é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚ é—®ï¼šTCP å¦‚ä½•å®ç°æµé‡æ§åˆ¶ï¼Ÿâ­ æ¥æ”¶æ–¹é€šè¿‡ TCP å¤´çª—å£å­—æ®µå‘ŠçŸ¥å‘é€æ–¹æœ¬æ–¹å¯æ¥æ”¶çš„æœ€å¤§æ•°æ®é‡ï¼Œç”¨ä»¥è§£å†³å‘é€é€Ÿç‡è¿‡å¿«å¯¼è‡´æ¥æ”¶æ–¹ä¸èƒ½æ¥æ”¶çš„é—®é¢˜ï¼Œæ‰€ä»¥æµé‡æ§åˆ¶æ˜¯ç‚¹å¯¹ç‚¹æ§åˆ¶ã€‚ è¿‡ç¨‹è‡ªå·±æƒ³æƒ³è¯´å­ã€‚ é—®ï¼šæµé‡æ§åˆ¶ä¸­ï¼Œæ­»é”çš„å±€é¢ï¼Ÿ é—®ï¼šTCP æ‹¥å¡æ§åˆ¶å¦‚ä½•å®ç°ï¼Ÿâ­ğŸš© ä¸ºäº†è¿›è¡Œæ‹¥å¡æ§åˆ¶ï¼ŒTCP å‘é€æ–¹è¦ç»´æŒä¸€ä¸ª æ‹¥å¡çª—å£(cwnd) çš„çŠ¶æ€å˜é‡ã€‚æ‹¥å¡æ§åˆ¶çª—å£çš„å¤§å°å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ï¼Œå¹¶ä¸”åŠ¨æ€å˜åŒ–ã€‚å‘é€çª—å£ = min(æ‹¥å¡çª—å£, æ¥æ”¶çª—å£) TCP çš„æ‹¥å¡æ§åˆ¶é‡‡ç”¨äº†å››ç§ç®—æ³•ï¼Œå³æ…¢å¼€å§‹ã€æ‹¥å¡é¿å…ã€å¿«é‡ä¼ å’Œå¿«æ¢å¤ã€‚ æ…¢å¼€å§‹ï¼šcwnd åˆå§‹å€¼ä¸º 1ï¼Œè¿˜æœªåˆ°æ…¢å¼€å§‹é—¨é™æ—¶ï¼Œæ¯ç»è¿‡ä¸€ä¸ªä¼ æ’­è½®æ¬¡ï¼Œcwnd åŠ å€ï¼› æ‹¥å¡é¿å…ï¼šåˆ°è¾¾æ…¢å¼€å§‹é—¨é™æ—¶ï¼Œcwnd ç¼“æ…¢å¢å¤§ï¼Œå³æ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´ RTT å°±æŠŠå‘é€æ–¹çš„cwndåŠ  1ã€‚å½“é‡ä¼ è®¡æ—¶å™¨è¶…æ—¶ï¼Œå¾ˆå¤§æ¦‚ç‡å‘ç”Ÿæ‹¥å¡ï¼š æ…¢å¼€å§‹é—¨é™ = æ‹¥å¡æ—¶çš„cwnd / 2ï¼› cwnd = 1ï¼Œé‡æ–°å¼€å§‹æ…¢å¼€å§‹ç®—æ³•ã€‚ ä½†æ˜¯ï¼Œä¸ªåˆ«æŠ¥æ–‡æ®µçš„ä¸¢å¤±ä¹Ÿä¼šå¼•èµ·è®¡æ—¶å™¨è¶…æ—¶ï¼Œä½†æ˜¯æ­¤æ—¶ç½‘ç»œå¯èƒ½å¹¶æ²¡æœ‰æ‹¥å¡ï¼Œå¦‚æœä»æ…¢å¼€å§‹å†æ¬¡å¼€å§‹ï¼Œå°±é™ä½äº†ç½‘ç»œæ•ˆç‡ã€‚==é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæ–°äº§ç”Ÿäº†å¿«é‡ä¼ å’Œå¿«æ¢å¤ã€‚== å¿«é‡ä¼ ï¼šæ¥æ”¶æ–¹ä¸è¦ç­‰åˆ°è‡ªå·±æœ‰æ•°æ®å‘é€æ—¶æ‰è¿›è¡Œæå¸¦ç¡®è®¤ï¼Œè€Œæ˜¯è¦ç«‹å³å‘é€ç¡®è®¤ï¼›å‘é€æ–¹ä¸€æ—¦æ”¶åˆ°3ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±å¯¹ç›¸åº”æŠ¥æ–‡æ®µç«‹å³é‡ä¼ ï¼Œä¸è¦ç­‰è¶…æ—¶è®¡æ—¶å™¨è¶…æ—¶ã€‚ å¿«æ¢å¤ï¼šä¸€æ—¦æ”¶åˆ°3ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±çŸ¥é“åªæ˜¯ä¸¢å¤±äº†ä¸ªåˆ«çš„æŠ¥æ–‡æ®µï¼Œäºæ˜¯æ‰§è¡Œå¿«æ¢å¤ç®—æ³•ï¼šå°†cwnd = æ‹¥å¡æ—¶çš„cwnd / 2ï¼Œæ…¢å¼€å§‹é—¨é™ = æ‹¥å¡æ—¶çš„cwnd / 2ã€‚ é—®ï¼šæµé‡æ§åˆ¶ä¸æ‹¥å¡æ§åˆ¶çš„åŒºåˆ«ï¼Ÿ æ‹¥å¡æ§åˆ¶æ˜¯ä¸€ä¸ªå…¨å±€æ€§çš„è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°æ‰€æœ‰çš„ä¸»æœºï¼Œæ‰€æœ‰çš„è·¯ç”±å™¨ï¼Œä»¥åŠä¸é™ä½ç½‘ç»œä¼ è¾“æ€§èƒ½æœ‰å…³çš„æ‰€æœ‰å› ç´ ã€‚ ç›¸åï¼Œæµé‡æ§åˆ¶å¾€å¾€æ˜¯ç‚¹å¯¹ç‚¹é€šä¿¡é‡çš„æ§åˆ¶ï¼Œæ˜¯ä¸ªç«¯åˆ°ç«¯çš„é—®é¢˜ã€‚æµé‡æ§åˆ¶æ‰€è¦åšåˆ°çš„å°±æ˜¯æŠ‘åˆ¶å‘é€ç«¯å‘é€æ•°æ®çš„é€Ÿç‡ï¼Œç¡®ä¿æ¥æ”¶ç«¯æ¥å¾—åŠæ¥æ”¶ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:3:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"å››ã€HTTP å’Œ HTTPS ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:4:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"4.1 åŸºç¡€æ¦‚å¿µ HTTP åè®®ï¼Œå…¨ç§°è¶…æ–‡æœ¬ä¼ è¾“åè®®(Hypertext Transfer Protocol)ï¼Œä¹Ÿå°±æ˜¯ä¼ è¾“ç½‘ç»œä¸Šçš„åŒ…æ‹¬æ–‡æœ¬åœ¨å†…çš„å„å¼å„æ ·çš„æ¶ˆæ¯ã€‚HTTP æ˜¯ä¸€ä¸ªæ— çŠ¶æ€(stateless)åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´æœåŠ¡å™¨ä¸ç»´æŠ¤ä»»ä½•æœ‰å…³å®¢æˆ·ç«¯è¿‡å»æ‰€å‘è¯·æ±‚çš„æ¶ˆæ¯ã€‚HTTP æ˜¯åº”ç”¨å±‚åè®®ï¼Œå®ƒä»¥ TCPï¼ˆä¼ è¾“å±‚ï¼‰ä½œä¸ºåº•å±‚åè®®ã€‚é»˜è®¤ç«¯å£ä¸º 80ã€‚ HTTPS åè®®(Hyper Text Transfer Protocol Secure)ï¼Œæ˜¯ HTTP çš„åŠ å¼ºå®‰å…¨ç‰ˆæœ¬ã€‚HTTPS æ˜¯åŸºäº HTTP çš„ï¼Œä¹Ÿæ˜¯ç”¨ TCP ä½œä¸ºåº•å±‚åè®®ï¼Œå¹¶é¢å¤–ä½¿ç”¨ SSL/TLS åè®®ç”¨ä½œåŠ å¯†å’Œå®‰å…¨è®¤è¯ã€‚é»˜è®¤ç«¯å£å·æ˜¯ 443ã€‚ HTTPS åè®®ä¸­ï¼ŒSSL é€šé“é€šå¸¸ä½¿ç”¨åŸºäºå¯†é’¥çš„åŠ å¯†ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦é€šå¸¸æ˜¯ 40 æ¯”ç‰¹æˆ– 128 æ¯”ç‰¹ã€‚ é—®ï¼šHTTP çš„æŠ¥æ–‡æ ¼å¼ï¼Ÿ HTTP æœ‰ä¸¤ç±»æŠ¥æ–‡ï¼šè¯·æ±‚æŠ¥æ–‡ å’Œ å“åº”æŠ¥æ–‡ã€‚ HTTP è¯·æ±‚/å“åº”æŠ¥æ–‡ç”±ä»¥ä¸‹å†…å®¹ç»„æˆï¼š è¯·æ±‚å¤´ HTTP å¤´éƒ¨å­—æ®µ ç©ºè¡Œ å¯é€‰çš„ HTTP æŠ¥æ–‡ä¸»ä½“æ•°æ® è¯·æ±‚æŠ¥æ–‡ HTTP çš„è¯·æ±‚æŠ¥æ–‡åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š è¯·æ±‚è¡Œ è¯·æ±‚æ–¹æ³• è¯·æ±‚åœ°å€ URL HTTP åè®®ç‰ˆæœ¬ GET /index.html HTTP/1.1 è¯·æ±‚å¤´(é¦–éƒ¨è¡Œ) Accept: */* Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.9,en;q=0.8 Connection: keep-alive Content-Length: 21429 Content-Type: application/json Host: api.github.com Origin: https://github.com Referer: https://github.com/ User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36 è¯·æ±‚å¤´ è¯´æ˜ Accept è¡¨ç¤ºæµè§ˆå™¨æ¥å—çš„æ•°æ®ç±»å‹ Accept-Encoding è¡¨ç¤ºæµè§ˆå™¨æ¥å—çš„æ•°æ®å‹ç¼©æ ¼å¼ Host è¡¨ç¤ºå½“å‰è¯·æ±‚è®¿é—®çš„ç›®æ ‡åœ°å€ Authorization è¡¨ç¤ºç”¨æˆ·èº«ä»½è®¤è¯ä¿¡æ¯ User-Agent è¡¨ç¤ºæµè§ˆå™¨ç±»å‹ If-Modified-Since è¡¨ç¤ºå½“å‰è¯·æ±‚èµ„æºæœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ If-None-Match è¡¨ç¤ºå½“å‰è¯·æ±‚èµ„æºæœ€è¿‘ä¸€æ¬¡æ ‡è¯†çš„ ETag å€¼ Cookie è¡¨ç¤ºæµè§ˆå™¨ä¿å­˜çš„ Cookie ä¿¡æ¯ Referer è¡¨ç¤ºæ ‡è¯†è¯·æ±‚å¼•ç”¨è‡ªå“ªä¸ªåœ°å€ æ¶ˆæ¯ä½“ è¯·æ±‚ä½“æ˜¯ POST è¯·æ±‚æ–¹å¼ä¸­çš„è¯·æ±‚å‚æ•°ï¼Œä»¥ key = value å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¤šä¸ªè¯·æ±‚å‚æ•°ä¹‹é—´ç”¨ \u0026 è¿æ¥ï¼Œå¦‚æœè¯·æ±‚å½“ä¸­è¯·æ±‚ä½“ï¼Œé‚£ä¹ˆåœ¨è¯·æ±‚å¤´å½“ä¸­çš„ Content-Length å±æ€§è®°å½•çš„å°±æ˜¯è¯¥è¯·æ±‚ä½“çš„é•¿åº¦ã€‚ pageNo=0\u0026pageSize=10\u0026orderNum=306735659327926273\u0026customerMobile=15626000000\u0026startTime=2019-02-01%2000:00:00\u0026endTime=2019-02-25%2014:54:20\u0026status=SUCCESS\u0026source=WECHAT_SHOPPING\u0026canteenId=104\u0026refundStatus=REFUNDED\u0026startPayTime=2019-02-01%2000:00:00\u0026endPayTime=2019-02-25%2014:54:47 å“åº”æŠ¥æ–‡ ä¸€ä¸ª http å“åº”æŠ¥æ–‡ä¹Ÿç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š çŠ¶æ€è¡Œ http åè®®ç‰ˆæœ¬ çŠ¶æ€ç  çŠ¶æ€ç çš„æ–‡æœ¬æè¿° æ ‡è®°å“åº”çŠ¶æ€ã€‚ HTTP/1.1 200 OK å“åº”å¤´ å’Œè¯·æ±‚å¤´éƒ¨ç±»ä¼¼ï¼Œå°±æ˜¯ä¸¤è€…ä¹‹é—´æœ‰ä¸€äº›ä¸åŒçš„å¤´éƒ¨å­—æ®µã€‚ HTTP/1.0 200 ok content-type: application/javascript;charset=utf-8 date: Tue, 07 Mar 2017 03:06:14 GMT sever: Domain Reliability Searver content-length: 0 x-xss-protection: 1, mode=bloack x-frame-options: SAMEORIGIN alt-svc: quic=\":443\";ma=2592000;v=\"36,35,34\" åç§° ä½œç”¨ Date è¡¨ç¤ºå½“å‰ç›¸åº”èµ„æºå‘é€çš„æœåŠ¡å™¨æ—¥æœŸå’Œæ—¶é—´ Last-Modified è¡¨ç¤ºå½“å‰å“åº”èµ„æºæœ€åè¢«ä¿®æ”¹çš„æœåŠ¡å™¨æ—¶é—´ï¼Œç”¨äºåå•†ç¼“å­˜ Transfer-Encoding è¡¨ç¤ºå½“å‰å“åº”èµ„æºä¼ è¾“å®ä½“çš„ç¼–ç æ ¼å¼ Set-Cookie è¡¨ç¤ºè®¾ç½® Cookie ä¿¡æ¯ Location åœ¨é‡å®šå‘ä¸­æˆ–è€…åˆ›å»ºæ–°èµ„æºæ—¶ä½¿ç”¨ Server è¡¨ç¤ºæœåŠ¡å™¨åç§° æ¶ˆæ¯ä½“ æ­£æ–‡å†…å®¹ï¼Œä¸€èˆ¬åœ¨å“åº”å¤´ä¸­ä¼šç”¨ Content-Length æ¥æ˜ç¡®å“åº”ä½“çš„é•¿åº¦ã€‚ é—®ï¼šè§£é‡Šä¸‹è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Ÿ HTTP çš„åå­—ã€Œè¶…æ–‡æœ¬åè®®ä¼ è¾“ã€ï¼Œå®ƒå¯ä»¥æ‹†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š è¶…æ–‡æœ¬ ä¼ è¾“åè®® ä¼ è¾“åè®®ï¼šå°±æ˜¯è®¡ç®—æœºä¹‹é—´ä¼ è¾“æ•°æ®çš„ä¸€ç§è¡Œä¸ºè§„èŒƒå’Œçº¦å®šï¼› è¶…æ–‡æœ¬ï¼šæ–‡æœ¬æ˜¯æ–‡å­—ï¼Œä½†è¶…æ–‡æœ¬æ¶µç›–äº†æ–‡å­—ã€å›¾ç‰‡ã€è§†é¢‘ã€é“¾æ¥ç­‰ï¼Œæ˜¯è¿™äº›çš„æ··åˆä½“ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼ŒHTTP æ˜¯ä¸€ä¸ªåœ¨è®¡ç®—æœºä¸–ç•Œé‡Œä¸“é—¨åœ¨ã€Œä¸¤ç‚¹ã€ä¹‹é—´ã€Œä¼ è¾“ã€æ–‡å­—ã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ã€Œè¶…æ–‡æœ¬ã€æ•°æ®çš„ã€Œçº¦å®šå’Œè§„èŒƒã€ã€‚ é—®ï¼šHTTP åè®®çš„é€šä¿¡è¿‡ç¨‹ï¼Ÿ é€šä¿¡è¿‡ç¨‹ä¸»è¦å¦‚ä¸‹ï¼š æœåŠ¡å™¨åœ¨ 80 ç«¯å£ç­‰å¾…å®¢æˆ·çš„è¯·æ±‚ã€‚ æµè§ˆå™¨å‘èµ·åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥ï¼ˆåˆ›å»ºå¥—æ¥å­— Socketï¼‰ã€‚ æœåŠ¡å™¨æ¥æ”¶æ¥è‡ªæµè§ˆå™¨çš„ TCP è¿æ¥ã€‚ æµè§ˆå™¨ï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰ä¸ Web æœåŠ¡å™¨ï¼ˆHTTP æœåŠ¡å™¨ï¼‰äº¤æ¢ HTTP æ¶ˆæ¯ã€‚ å…³é—­ TCP è¿æ¥ã€‚ é—®ï¼šHTTP å¸¸è§çš„çŠ¶æ€ç ï¼Ÿâ­ 2xx ç±»çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡å™¨æˆåŠŸå¤„ç†äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ€æ„¿æ„çœ‹åˆ°çš„çŠ¶æ€ã€‚ ã€Œ200 OKã€æ˜¯æœ€å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œè¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ã€‚å¦‚æœæ˜¯é HEAD è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”å¤´éƒ½ä¼šæœ‰ body æ•°æ®ã€‚ ã€Œ204 No Contentã€ä¹Ÿæ˜¯å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œä¸ 200 OK åŸºæœ¬ç›¸åŒï¼Œä½†å“åº”å¤´æ²¡æœ‰ body æ•°æ®ã€‚ ã€Œ206 Partial Contentã€æ˜¯åº”ç”¨äº HTTP åˆ†å—ä¸‹è½½æˆ–æ–­ç‚¹ç»­ä¼ ï¼Œè¡¨ç¤ºå“åº”è¿”å›çš„ body æ•°æ®å¹¶ä¸æ˜¯èµ„æºçš„å…¨éƒ¨ï¼Œè€Œæ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœåŠ¡å™¨å¤„ç†æˆåŠŸçš„çŠ¶æ€ã€‚ 3xx ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºå‘ç”Ÿäº†å˜åŠ¨ï¼Œéœ€è¦å®¢æˆ·ç«¯ç”¨æ–°çš„ URL é‡æ–°å‘é€è¯·æ±‚è·å–èµ„æºï¼Œä¹Ÿå°±æ˜¯é‡å®šå‘ã€‚ ã€Œ301 Moved Permanentlyã€è¡¨ç¤ºæ°¸ä¹…é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºå·²ç»ä¸å­˜åœ¨äº†ï¼Œéœ€æ”¹ç”¨æ–°çš„ URL å†æ¬¡è®¿é—®ã€‚ ã€Œ302 Foundã€è¡¨ç¤ºä¸´æ—¶é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºè¿˜åœ¨ï¼Œä½†æš‚æ—¶éœ€è¦ç”¨å¦ä¸€ä¸ª URL æ¥è®¿é—®ã€‚ 301 å’Œ 302 éƒ½ä¼šåœ¨å“åº”å¤´é‡Œä½¿ç”¨å­—æ®µ Locationï¼ŒæŒ‡æ˜åç»­è¦è·³è½¬çš„ URLï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡å®šå‘æ–°çš„ URLã€‚ ã€Œ304 Not Modifiedã€ä¸å…·æœ‰è·³è½¬çš„å«ä¹‰ï¼Œè¡¨ç¤ºèµ„æºæœªä¿®æ”¹ï¼Œé‡å®šå‘å·²å­˜åœ¨çš„ç¼“å†²æ–‡ä»¶ï¼Œä¹Ÿç§°ç¼“å­˜é‡å®šå‘ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜èµ„æºï¼Œç”¨äºç¼“å­˜æ§åˆ¶ã€‚ 4xx ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯å‘é€çš„æŠ¥æ–‡æœ‰è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†ï¼Œä¹Ÿå°±æ˜¯é”™è¯¯ç çš„å«ä¹‰ã€‚ ã€Œ400 Bad Requestã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æŠ¥æ–‡æœ‰é”™è¯¯ï¼Œä½†åªæ˜¯ä¸ªç¬¼ç»Ÿçš„é”™è¯¯ã€‚ ã€Œ403 Forbiddenã€è¡¨ç¤ºæœåŠ¡å™¨ç¦æ­¢è®¿é—®èµ„æºï¼Œå¹¶ä¸æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å‡ºé”™ã€‚ ã€Œ404 Not Foundã€è¡¨ç¤ºè¯·æ±‚çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æˆ–æœªæ‰¾åˆ°ï¼Œæ‰€ä»¥æ— æ³•æä¾›ç»™å®¢æˆ·ç«¯ã€‚ 5xx ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡æ­£ç¡®ï¼Œä½†æ˜¯æœåŠ¡å™¨å¤„ç†æ—¶å†…éƒ¨å‘ç”Ÿäº†é”™è¯¯ï¼Œå±äºæœåŠ¡å™¨ç«¯çš„é”™è¯¯ç ã€‚ ã€Œ500 Internal Server Errorã€ä¸ 400 ç±»å‹ï¼Œæ˜¯ä¸ªç¬¼ç»Ÿé€šç”¨çš„é”™è¯¯ç ï¼ŒæœåŠ¡å™¨å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ã€‚ ã€Œ501 Not Implementedã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„åŠŸèƒ½è¿˜ä¸æ”¯æŒï¼Œç±»ä¼¼â€œå³å°†å¼€ä¸šï¼Œæ•¬è¯·æœŸå¾…â€çš„æ„æ€ã€‚ ã€Œ502 Bad Gatewayã€é€šå¸¸æ˜¯æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†æ—¶è¿”å›çš„é”™è¯¯ç ï¼Œè¡¨ç¤ºæœåŠ¡å™¨è‡ªèº«å·¥ä½œæ­£å¸¸ï¼Œè®¿é—®åç«¯æœåŠ¡å™¨å‘ç”Ÿäº†é”™è¯¯ã€‚ ã€Œ503 Service Unavailableã€è¡¨ç¤ºæœåŠ¡å™¨å½“å‰å¾ˆå¿™ï¼Œæš‚æ—¶æ— æ³•å“åº”å®¢æˆ·ç«¯ï¼Œç±»ä¼¼â€œç½‘ç»œæœåŠ¡æ­£å¿™ï¼Œè¯·ç¨åé‡è¯•â€çš„æ„æ€ã€‚ é—®ï¼šæ‰“å¼€ä¸€ä¸ªç½‘é¡µï¼Œè¿‡ç¨‹ï¼Ÿâ­ æµè§ˆå™¨è§£æ URLï¼šæµè§ˆå™¨ä¼šè§£æ URL ç¡®å®šè¦è¯·æ±‚çš„èµ„æºæ‰€åœ¨ Web æœåŠ¡å™¨åŠæ–‡ä»¶åï¼Œæ„å»º HTTP è¯·æ±‚æŠ¥æ–‡ï¼› åŸŸåè§£æï¼šå‘é€ HTTP è¯·æ±‚æŠ¥æ–‡ä¹‹å‰ï¼Œä¼šé€šè¿‡ DNS å°†åŸŸåè½¬æ¢ä¸ºå¯¹åº”çš„ IP åœ°å€ï¼šé¦–å…ˆä¼šæ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­åˆ™ä¼šå‘ æœ¬åœ° DNS æœåŠ¡å™¨å‘é€æŸ¥è¯¢è¯·æ±‚ï¼Œç„¶åé€’å½’çš„æŸ¥è¯¢ï¼› å»ºç«‹ TCP è¿æ¥ï¼šæµè§ˆå™¨æ ¹æ® IP åœ°å€å’Œç«¯å£å·ï¼Œä¸ç›®æ ‡æœåŠ¡å™¨å»ºç«‹ TCP è¿æ¥(ä¸‰æ¬¡æ¡æ‰‹)ï¼Œç„¶åå¯¹ HTTP è¯·æ±‚æŠ¥æ–‡è¿›è¡Œå°è£…ï¼Œä¹Ÿå°±æ˜¯åŠ ä¸€å±‚ TCP æŠ¥å¤´ï¼ŒTCP æŠ¥æ–‡çš„æ•°æ®éƒ¨åˆ†å°±æ˜¯ HTTP è¯·æ±‚æŠ¥æ–‡äº†ï¼› å°è£… IPï¼šTCP æŠ¥æ–‡è¿˜éœ€è¦é€šè¿‡ IP ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¦åœ¨ TCP æŠ¥æ–‡å‰åŠ ä¸€å±‚ IP å¤´ï¼ŒæŒ‡æ˜ç›®çš„åœ°å€å’Œæºåœ°å€ï¼Œç”Ÿæˆ IP æŠ¥æ–‡ï¼› å°è£… MACï¼šç”Ÿæˆ IP æŠ¥æ–‡åï¼Œè¿˜éœ€è¦å°è£…æˆ MAC å¸§ã€‚é€šè¿‡ ARP åè®®æŸ¥è¯¢è¦åˆ°è¾¾ç›®çš„ IP çš„ä¸‹ä¸€è·³çš„ MAC åœ°å€ï¼ŒMAC å¤´éƒ¨æºå¸¦å‘é€æ–¹ MAC åœ°å€å’Œæ¥æ”¶æ–¹ç›®æ ‡ MAC åœ°å€ï¼Œç”¨äºä¸¤ç‚¹é—´ä¼ è¾“ï¼› é€šè¿‡ä¸æ–­åˆ°è¾¾æ–°çš„è·¯ç”±å™¨ï¼Œè¿›è€Œæ›´æ–°ç›®çš„ MAC åœ°å€ï¼Œæœ€ç»ˆè¾¾åˆ°ç›®çš„ IP åœ°å€ï¼› æœåŠ¡å™¨å¤„ç† HTTP è¯·æ±‚ï¼šæœåŠ¡å™¨å°†æ•°æ®åŒ…","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:4:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"4.2 ç¼“å­˜ é—®ï¼šHTTP ç¼“å­˜æŠ€æœ¯ï¼Ÿ å¯¹äºä¸€äº›å…·æœ‰é‡å¤æ€§çš„ HTTP è¯·æ±‚ï¼Œæ¯”å¦‚æ¯æ¬¡è¯·æ±‚å¾—åˆ°çš„æ•°æ®éƒ½ä¸€æ ·çš„ï¼Œå¯ä»¥æŠŠè¿™å¯¹ã€Œè¯·æ±‚-å“åº”ã€çš„æ•°æ®éƒ½ç¼“å­˜åœ¨æœ¬åœ°ï¼Œé‚£ä¹ˆä¸‹æ¬¡å°±ç›´æ¥è¯»å–æœ¬åœ°çš„æ•°æ®ï¼Œä¸å¿…åœ¨é€šè¿‡ç½‘ç»œè·å–æœåŠ¡å™¨çš„å“åº”äº†ï¼ŒHTTP æœ‰ä»¥ä¸‹å®ç°æ–¹æ³•ï¼š å¼ºåˆ¶ç¼“å­˜ï¼šæŒ‡çš„æ˜¯åªè¦æµè§ˆå™¨åˆ¤æ–­ç¼“å­˜æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„ä¸»åŠ¨æ€§åœ¨æµè§ˆå™¨è¿™è¾¹ã€‚ å¼ºåˆ¶ç¼“å­˜åˆ©ç”¨ HTTP å“åº”å¤´éƒ¨ä¸­çš„ä¸¤ä¸ªå­—æ®µå®ç°ï¼Œç”¨æ¥è¡¨ç¤ºèµ„æºåœ¨å®¢æˆ·ç«¯ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼š Cache-Controlï¼Œæ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼› Expiresï¼Œæ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼› å¦‚æœ HTTP å“åº”å¤´éƒ¨åŒæ—¶æœ‰ Cache-Control å’Œ Expires å­—æ®µçš„è¯ï¼ŒCache-Control çš„ä¼˜å…ˆçº§é«˜äº Expiresï¼Œå»ºè®®ä½¿ç”¨ Cache-Control(é€‰é¡¹æ›´å¤š)ï¼š å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨ Response å¤´éƒ¨åŠ ä¸Š Cache-Controlï¼ŒCache-Control ä¸­è®¾ç½®äº†è¿‡æœŸæ—¶é—´å¤§å°ï¼› æµè§ˆå™¨å†æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨ä¸­çš„è¯¥èµ„æºæ—¶ï¼Œä¼šå…ˆé€šè¿‡è¯·æ±‚èµ„æºçš„æ—¶é—´ä¸ Cache-Control ä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´å¤§å°ï¼Œæ¥è®¡ç®—å‡ºè¯¥èµ„æºæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œå¦åˆ™é‡æ–°è¯·æ±‚æœåŠ¡å™¨ï¼› æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå†æ¬¡æ›´æ–° Response å¤´éƒ¨çš„ Cache-Controlã€‚ åå•†ç¼“å­˜ï¼šé€šè¿‡æœåŠ¡ç«¯å‘ŠçŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚æ¯”å¦‚æŸäº›è¯·æ±‚çš„å“åº”ç æ˜¯ 304ï¼Œè¿™ä¸ªæ˜¯å‘Šè¯‰æµè§ˆå™¨å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„èµ„æºã€‚ å½“ç¬¬ä¸€æ¬¡è¯·æ±‚é™æ€çš„èµ„æºæ—¶ï¼Œæ¯”å¦‚ä¸€å¼ å›¾ç‰‡ï¼ŒæœåŠ¡ç«¯é™¤äº†è¿”å›å›¾ç‰‡ä¿¡æ¯ï¼Œåœ¨å“åº”å¤´é‡Œé¢è¿˜æœ‰ä¸€ä¸ª Etag çš„å­—æ®µï¼› æµè§ˆå™¨ä¼šç¼“å­˜å›¾ç‰‡ä¿¡æ¯ä»¥åŠè¿™ä¸ªå­—æ®µçš„å€¼ï¼› å½“ä¸‹ä¸€æ¬¡å†è¯·æ±‚è¿™ä¸ªå›¾ç‰‡çš„æ—¶å€™ï¼Œæµè§ˆå™¨å‘èµ·çš„è¯·æ±‚å¤´é‡Œé¢ä¼šæœ‰ä¸€ä¸ª If-None-Match çš„å­—æ®µï¼Œå¹¶ä¸”æŠŠç¼“å­˜çš„ Etag çš„å€¼å†™è¿›å»å‘ç»™æœåŠ¡ç«¯ï¼› æœåŠ¡ç«¯æ¯”å¯¹å›¾ç‰‡ä¿¡æ¯æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›æµè§ˆå™¨ä¸€ä¸ª 304 çš„çŠ¶æ€ç ï¼Œæµè§ˆå™¨ä¼šç»§ç»­ä½¿ç”¨ç¼“å­˜çš„å›¾ç‰‡ä¿¡æ¯ã€‚ é€šè¿‡æµè§ˆå™¨ç¼“å­˜çš„æ–¹å¼ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®å¤§å°ï¼Œä»è€Œæå‡é¡µé¢å±•ç¤ºçš„æ€§èƒ½ã€‚ é—®ï¼šå¼ºåˆ¶ç¼“å­˜å’Œåå•†ç¼“å­˜æ˜¯ä»€ä¹ˆï¼Ÿ å¼ºåˆ¶ç¼“å­˜ï¼šæŒ‡çš„æ˜¯åªè¦æµè§ˆå™¨åˆ¤æ–­ç¼“å­˜æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ã€‚å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„ä¸»åŠ¨æ€§åœ¨äºæµè§ˆå™¨ï¼› å®ç°ï¼šä¸»è¦åˆ©ç”¨ä¸¤ä¸ª HTTP å“åº”å¤´éƒ¨å­—æ®µå®ç°ï¼Œå®ƒä»¬éƒ½ç”¨æ¥è¡¨ç¤ºèµ„æºåœ¨å®¢æˆ·ç«¯ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼š Cache-Controlï¼Œæ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼› Expiresï¼Œæ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼› å¦‚æœ HTTP å“åº”å¤´éƒ¨åŒæ—¶æœ‰ Cache-Control å’Œ Expires å­—æ®µçš„è¯ï¼ŒCache-Control çš„ä¼˜å…ˆçº§é«˜äº Expires ã€‚å»ºè®®ä½¿ç”¨ Cache-Controlï¼Œå…·ä½“çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨ Response å¤´éƒ¨åŠ ä¸Š Cache-Controlï¼ŒCache-Control ä¸­è®¾ç½®äº†è¿‡æœŸæ—¶é—´å¤§å°ï¼› æµè§ˆå™¨å†æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨ä¸­çš„è¯¥èµ„æºæ—¶ï¼Œä¼šå…ˆé€šè¿‡è¯·æ±‚èµ„æºçš„æ—¶é—´ä¸ Cache-Control ä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´å¤§å°ï¼Œæ¥è®¡ç®—å‡ºè¯¥èµ„æºæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œå¦åˆ™é‡æ–°è¯·æ±‚æœåŠ¡å™¨ï¼› æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå†æ¬¡æ›´æ–° Response å¤´éƒ¨çš„ Cache-Controlã€‚ åå•†ç¼“å­˜ï¼šæœåŠ¡ç«¯å‘ŠçŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜çš„æ–¹å¼è¢«ç§°ä¸ºåå•†ç¼“å­˜ã€‚ å®ç°ï¼šå¯ä»¥åŸºäºä¸¤ç§å¤´éƒ¨æ¥å®ç°ã€‚ ç¬¬ä¸€ç§ï¼šåˆ©ç”¨è¯·æ±‚å¤´éƒ¨ä¸­çš„ If-Modified-Since å­—æ®µä¸å“åº”å¤´éƒ¨ä¸­çš„ Last-Modified å­—æ®µå®ç°ï¼Œè¿™ä¸¤ä¸ªå­—æ®µçš„æ„æ€æ˜¯ï¼š å“åº”å¤´éƒ¨ä¸­çš„ Last-Modifiedï¼šæ ‡ç¤ºè¿™ä¸ªå“åº”èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ï¼› è¯·æ±‚å¤´éƒ¨ä¸­çš„ If-Modified-Sinceï¼šå½“èµ„æºè¿‡æœŸäº†ï¼Œå‘ç°å“åº”å¤´ä¸­å…·æœ‰ Last-Modified å£°æ˜ï¼Œåˆ™å†æ¬¡å‘èµ·è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Š Last-Modified çš„æ—¶é—´ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åå‘ç°æœ‰ If-Modified-Since åˆ™ä¸è¢«è¯·æ±‚èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´è¿›è¡Œå¯¹æ¯”ï¼ˆLast-Modifiedï¼‰ï¼Œå¦‚æœæœ€åä¿®æ”¹æ—¶é—´è¾ƒæ–°ï¼ˆå¤§ï¼‰ï¼Œè¯´æ˜èµ„æºåˆè¢«æ”¹è¿‡ï¼Œåˆ™è¿”å›æœ€æ–°èµ„æºï¼ŒHTTP 200 OKï¼›å¦‚æœæœ€åä¿®æ”¹æ—¶é—´è¾ƒæ—§ï¼ˆå°ï¼‰ï¼Œè¯´æ˜èµ„æºæ— æ–°ä¿®æ”¹ï¼Œå“åº” HTTP 304 èµ°ç¼“å­˜ã€‚ ç¬¬äºŒç§ï¼šè¯·æ±‚å¤´éƒ¨ä¸­çš„ If-None-Match å­—æ®µä¸å“åº”å¤´éƒ¨ä¸­çš„ ETag å­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µçš„æ„æ€æ˜¯ï¼š å“åº”å¤´éƒ¨ä¸­ Etagï¼šå”¯ä¸€æ ‡è¯†å“åº”èµ„æºï¼› è¯·æ±‚å¤´éƒ¨ä¸­çš„ If-None-Matchï¼šå½“èµ„æºè¿‡æœŸæ—¶ï¼Œæµè§ˆå™¨å‘ç°å“åº”å¤´é‡Œæœ‰ Etagï¼Œåˆ™å†æ¬¡å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚å¤´ If-None-Match å€¼è®¾ç½®ä¸º Etag çš„å€¼ã€‚æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœèµ„æºæ²¡æœ‰å˜åŒ–è¿”å› 304ï¼Œå¦‚æœèµ„æºå˜åŒ–äº†è¿”å› 200ã€‚ ç¬¬ä¸€ç§å®ç°æ–¹å¼æ˜¯åŸºäºæ—¶é—´å®ç°çš„ï¼Œç¬¬äºŒç§å®ç°æ–¹å¼æ˜¯åŸºäºä¸€ä¸ªå”¯ä¸€æ ‡è¯†å®ç°çš„ï¼Œç›¸å¯¹æ¥è¯´åè€…å¯ä»¥æ›´åŠ å‡†ç¡®åœ°åˆ¤æ–­æ–‡ä»¶å†…å®¹æ˜¯å¦è¢«ä¿®æ”¹ï¼Œé¿å…ç”±äºæ—¶é—´ç¯¡æ”¹å¯¼è‡´çš„ä¸å¯é é—®é¢˜ã€‚ æ³¨æ„ï¼Œåå•†ç¼“å­˜è¿™ä¸¤ä¸ªå­—æ®µéƒ½éœ€è¦é…åˆå¼ºåˆ¶ç¼“å­˜ä¸­ Cache-Control å­—æ®µæ¥ä½¿ç”¨ï¼Œåªæœ‰åœ¨æœªèƒ½å‘½ä¸­å¼ºåˆ¶ç¼“å­˜çš„æ—¶å€™ï¼Œæ‰èƒ½å‘èµ·å¸¦æœ‰åå•†ç¼“å­˜å­—æ®µçš„è¯·æ±‚ã€‚ å½“ä½¿ç”¨ ETag å­—æ®µå®ç°çš„åå•†ç¼“å­˜çš„æ€»è¿‡ç¨‹ï¼š å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨ Response å¤´éƒ¨åŠ ä¸Š ETag å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡è¯†çš„å€¼æ˜¯æ ¹æ®å½“å‰è¯·æ±‚çš„èµ„æºç”Ÿæˆçš„ï¼› å½“æµè§ˆå™¨å†æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨ä¸­çš„è¯¥èµ„æºæ—¶ï¼Œé¦–å…ˆä¼šå…ˆæ£€æŸ¥å¼ºåˆ¶ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼š å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼› å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œä¼šåœ¨ Request å¤´éƒ¨åŠ ä¸Š If-None-Match å­—æ®µï¼Œè¯¥å­—æ®µçš„å€¼å°±æ˜¯ ETag å”¯ä¸€æ ‡è¯†ï¼› æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ®è¯·æ±‚ä¸­çš„ If-None-Match å€¼ä¸å½“å‰è¯·æ±‚çš„èµ„æºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†è¿›è¡Œæ¯”è¾ƒï¼š å¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™è¿”å› 304 Not Modifiedï¼Œä¸ä¼šè¿”å›èµ„æºï¼› å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› 200 çŠ¶æ€ç å’Œè¿”å›èµ„æºï¼Œå¹¶åœ¨ Response å¤´éƒ¨åŠ ä¸Šæ–°çš„ ETag å”¯ä¸€æ ‡è¯†ï¼› å¦‚æœæµè§ˆå™¨æ”¶åˆ° 304 çš„è¯·æ±‚å“åº”çŠ¶æ€ç ï¼Œåˆ™ä¼šä»æœ¬åœ°ç¼“å­˜ä¸­åŠ è½½èµ„æºï¼Œå¦åˆ™æ›´æ–°èµ„æºã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:4:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"4.3 HTTPS é—®ï¼šHTTPS åè®®çš„é€šä¿¡è¿‡ç¨‹ï¼Ÿ å®¢æˆ·ç«¯å‘é€httpsè¯·æ±‚ï¼ŒæŠŠè‡ªèº«æ”¯æŒçš„ç§˜é’¥ç®—æ³•å¥—ä»¶ï¼ˆSSLæŒ‡å®šç‰ˆæœ¬ã€åŠ å¯†ç»„ä»¶åˆ—è¡¨ï¼‰å‘é€ç»™æœåŠ¡å™¨ï¼› æœåŠ¡å™¨åˆ¤æ–­è‡ªèº«æ˜¯å¦æ”¯æŒè¯¥ç®—æ³•å¥—ä»¶ï¼Œå¦‚æœæ”¯æŒåˆ™è¿”å›è¯ä¹¦ä¿¡æ¯ï¼Œå¦åˆ™æ–­å¼€è¿æ¥ï¼› å®¢æˆ·ç«¯è§£æè¯ä¹¦(é€šè¿‡TLSåè®®æ¥å®Œæˆ)ï¼ŒéªŒè¯è¯ä¹¦æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœå¼‚å¸¸ï¼Œåˆ™ä¼šæç¤ºæ˜¯å¦å®‰è£…è¯ä¹¦ï¼Œå¸¸è§çš„å°±æ˜¯æµè§ˆå™¨æœç´¢æ å·¦ä¾§å‡ºç°â€œXâ€å‘Šè­¦æŒ‰é’®ç­‰ã€‚ å¦‚æœè¯ä¹¦æœ‰æ•ˆã€æˆ–è€…æ˜¯æˆä¿¡å®‰è£…è¯ä¹¦åï¼Œå¼€å§‹ä¼ é€ç”¨æœåŠ¡ç«¯å…¬é’¥åŠ å¯†åçš„ç§é’¥ï¼› æœåŠ¡ç«¯é€šè¿‡ç§é’¥è§£å¯†åŠ å¯†ä¿¡æ¯ï¼Œå¾—åˆ°å®¢æˆ·ç«¯å‘é€æ¥çš„ä¼šè¯ç§é’¥ï¼› è¿›è¡Œä¼šè¯ã€‚ é—®ï¼šSSL/TLS å·¥ä½œåŸç†ï¼Ÿ SSL/TLS çš„æ ¸å¿ƒè¦ç´ æ˜¯å…¬é’¥åŠ å¯†å’Œå¯¹ç§°åŠ å¯†ã€‚åˆ©ç”¨å…¬é’¥åŠ å¯†åå•†å¯†é’¥ï¼Œåˆ©ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•å¿«é€ŸåŠ è§£å¯†æ•°æ®ã€‚ å…¶ä¸­ï¼Œä¸ºé˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼Œå…¬é’¥ç”±CAé¢å‘ã€‚å½“å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å‘æœåŠ¡å™¨å‘é€ HTTPS è¯·æ±‚æ—¶ï¼Œä¸€å®šè¦å…ˆè·å–ç›®æ ‡æœåŠ¡å™¨çš„è¯ä¹¦ï¼Œå¹¶æ ¹æ®è¯ä¹¦ä¸Šçš„ä¿¡æ¯ï¼Œæ£€éªŒè¯ä¹¦çš„åˆæ³•æ€§ã€‚ä¸€æ—¦å®¢æˆ·ç«¯æ£€æµ‹åˆ°è¯ä¹¦éæ³•ï¼Œå°±ä¼šå‘ç”Ÿé”™è¯¯ã€‚ é—®ï¼šCA è¯ä¹¦ç­¾å‘è¿‡ç¨‹ï¼Ÿ æœåŠ¡æ–¹ S ç”Ÿæˆå…¬ç§é’¥ï¼Œç„¶åå‘ç¬¬ä¸‰æ–¹æœºæ„CAæäº¤å…¬é’¥ã€ç»„ç»‡ä¿¡æ¯ã€ä¸ªäººä¿¡æ¯(åŸŸå)ç­‰ä¿¡æ¯å¹¶ç”³è¯·è®¤è¯ï¼› CA é€šè¿‡çº¿ä¸Šã€çº¿ä¸‹ç­‰å¤šç§æ‰‹æ®µéªŒè¯ç”³è¯·è€…æä¾›ä¿¡æ¯çš„çœŸå®æ€§ï¼Œå¦‚ç»„ç»‡æ˜¯å¦å­˜åœ¨ã€ä¼ä¸šæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦æ‹¥æœ‰åŸŸåçš„æ‰€æœ‰æƒç­‰ï¼›å¦‚ä¿¡æ¯å®¡æ ¸é€šè¿‡ï¼ŒCA ä¼šå‘ç”³è¯·è€…ç­¾å‘è®¤è¯æ–‡ä»¶-è¯ä¹¦ã€‚è¯ä¹¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼šç”³è¯·è€…å…¬é’¥ã€ç”³è¯·è€…çš„ç»„ç»‡ä¿¡æ¯å’Œä¸ªäººä¿¡æ¯ã€ç­¾å‘æœºæ„ CAçš„ä¿¡æ¯ã€æœ‰æ•ˆæ—¶é—´ã€è¯ä¹¦åºåˆ—å·ç­‰ä¿¡æ¯çš„æ˜æ–‡ï¼ŒåŒæ—¶åŒ…å«ä¸€ä¸ªCAçš„ç­¾åï¼›ç­¾åçš„äº§ç”Ÿç®—æ³•ï¼šé¦–å…ˆï¼Œä½¿ç”¨æ•£åˆ—å‡½æ•°è®¡ç®—å…¬å¼€çš„æ˜æ–‡ä¿¡æ¯çš„ä¿¡æ¯æ‘˜è¦ï¼Œç„¶åï¼Œé‡‡ç”¨ CA çš„ç§é’¥å¯¹ä¿¡æ¯æ‘˜è¦è¿›è¡ŒåŠ å¯†ï¼Œå¯†æ–‡å³ç­¾åï¼› å®¢æˆ·ç«¯ C å‘æœåŠ¡å™¨ S å‘å‡ºè¯·æ±‚æ—¶ï¼ŒS è¿”å›è¯ä¹¦æ–‡ä»¶ï¼› å®¢æˆ·ç«¯ C å¯¹è¯ä¹¦è¿›è¡ŒéªŒç­¾ï¼šè¯»å–è¯ä¹¦ä¸­çš„ç›¸å…³çš„æ˜æ–‡ä¿¡æ¯ï¼Œé‡‡ç”¨ç›¸åŒçš„æ•£åˆ—å‡½æ•°è®¡ç®—å¾—åˆ°ä¿¡æ¯æ‘˜è¦ï¼Œç„¶åï¼Œåˆ©ç”¨å¯¹åº” CA çš„å…¬é’¥è§£å¯†ç­¾åæ•°æ®ï¼Œå¯¹æ¯”è¯ä¹¦çš„ä¿¡æ¯æ‘˜è¦ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™å¯ä»¥ç¡®è®¤è¯ä¹¦çš„åˆæ³•æ€§ï¼Œå³å…¬é’¥åˆæ³•ï¼› å®¢æˆ·ç«¯ç„¶åéªŒè¯è¯ä¹¦ç›¸å…³çš„åŸŸåä¿¡æ¯ã€æœ‰æ•ˆæ—¶é—´ç­‰ä¿¡æ¯ï¼› å®¢æˆ·ç«¯ä¼šå†…ç½®ä¿¡ä»» CA çš„è¯ä¹¦ä¿¡æ¯(åŒ…å«å…¬é’¥)ï¼Œå¦‚æœCAä¸è¢«ä¿¡ä»»ï¼Œåˆ™æ‰¾ä¸åˆ°å¯¹åº” CA çš„è¯ä¹¦ï¼Œè¯ä¹¦ä¹Ÿä¼šè¢«åˆ¤å®šéæ³•ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:4:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"äº”ã€HTTP å„ç‰ˆæœ¬ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:5:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"åŸºç¡€ é—®ï¼šHTTP 1.0 å’Œ HTTP 1.1 åŒºåˆ«ï¼Ÿ è¿æ¥æ–¹å¼ï¼šHTTP 1.0 ä¸ºéæŒç»­è¿æ¥ï¼Œæ¯æ¬¡æµè§ˆå™¨è¦è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶éƒ½è¦ä¸æœåŠ¡å™¨å»ºç«‹TCPé“¾æ¥ï¼Œå½“æ”¶åˆ°å“åº”åå°±ç«‹å³å…³é—­è¿æ¥ï¼›HTTP 1.1 æ”¯æŒæŒç»­è¿æ¥ï¼Œæµè§ˆå™¨æ”¶åˆ°å“åº”åï¼Œä»å¯ä»¥ä¿æŒè¯¥è¿æ¥ä¼ è¾“åç»­çš„è¯·æ±‚å’Œå“åº”æŠ¥æ–‡ã€‚ è¯·æ±‚æ–¹å¼ï¼šHTTP 1.1 æ”¯æŒè¯·æ±‚çš„æµæ°´çº¿å¤„ç†æ–¹å¼ã€‚ çŠ¶æ€å“åº”ç ï¼šHTTP/1.1ä¸­æ–°åŠ å…¥äº†å¤§é‡çš„çŠ¶æ€ç ï¼Œå…‰æ˜¯é”™è¯¯å“åº”çŠ¶æ€ç å°±æ–°å¢äº†24ç§ã€‚æ¯”å¦‚è¯´ï¼Œ100 (Continue)â€”â€”åœ¨è¯·æ±‚å¤§èµ„æºå‰çš„é¢„çƒ­è¯·æ±‚ï¼Œ206 (Partial Content)â€”â€”èŒƒå›´è¯·æ±‚çš„æ ‡è¯†ç ï¼Œ409 (Conflict)â€”â€”è¯·æ±‚ä¸å½“å‰èµ„æºçš„è§„å®šå†²çªï¼Œ410 (Gone)â€”â€”èµ„æºå·²è¢«æ°¸ä¹…è½¬ç§»ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å·²çŸ¥çš„è½¬å‘åœ°å€ã€‚ ç¼“å­˜å¤„ç†ï¼šåœ¨ HTTP1.0 ä¸­ä¸»è¦ä½¿ç”¨ header é‡Œçš„ If-Modified-Sinceï¼ŒExpires æ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP1.1 åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¾‹å¦‚ Entity tagï¼ŒIf-Unmodified-Sinceï¼ŒIf-Matchï¼ŒIf-None-Match ç­‰æ›´å¤šå¯ä¾›é€‰æ‹©çš„ç¼“å­˜å¤´æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚ å¸¦å®½ä¼˜åŒ–åŠç½‘ç»œè¿æ¥çš„ä½¿ç”¨ï¼šHTTP1.0 ä¸­ï¼Œå­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªæ˜¯éœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œå¹¶ä¸”ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼ŒHTTP1.1 åˆ™åœ¨è¯·æ±‚å¤´å¼•å…¥äº† range å¤´åŸŸï¼Œå®ƒå…è®¸åªè¯·æ±‚èµ„æºçš„æŸä¸ªéƒ¨åˆ†ï¼Œå³è¿”å›ç æ˜¯ 206ï¼ˆPartial Contentï¼‰ï¼Œè¿™æ ·å°±æ–¹ä¾¿äº†å¼€å‘è€…è‡ªç”±çš„é€‰æ‹©ä»¥ä¾¿äºå……åˆ†åˆ©ç”¨å¸¦å®½å’Œè¿æ¥ã€‚ Hostå¤´å¤„ç†ï¼šHTTP/1.1åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥äº†Hostå­—æ®µã€‚ é—®ï¼šHTTP 1.1 çš„æ€§èƒ½é—®é¢˜ï¼Ÿâ­ é˜Ÿå¤´é˜»å¡ï¼šHTTP 1.1 å¯ä»¥é€šè¿‡æµæ°´çº¿çš„æ–¹å¼è¯·æ±‚ï¼Œå³åç»­è¯·æ±‚ä¸éœ€è¦ç­‰å‰è¾¹çš„è¯·æ±‚è¢«å“åº”å°±å¯ä»¥å‘å‡ºï¼Œè¿™è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ã€‚ä½†æ˜¯ï¼ŒæœåŠ¡å™¨å¿…é¡»æŒ‰ç…§æ¥æ”¶è¯·æ±‚çš„é¡ºåºå‘é€å“åº”ï¼Œå¦‚æœæŸä¸ªè¯·æ±‚å¤„ç†æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆåç»­çš„å°±åªèƒ½é˜»å¡ï¼Œå¯¼è‡´å“åº”çš„é˜Ÿå¤´é˜»å¡ã€‚ ä¸æ”¯æŒæœåŠ¡å™¨æ¨é€ï¼šå½“å®¢æˆ·ç«¯éœ€è¦è·å–é€šçŸ¥æ—¶ï¼Œåªèƒ½é€šè¿‡å®šæ—¶å™¨ä¸æ–­åœ°æ‹‰å–æ¶ˆæ¯ï¼Œè¿™æ— ç–‘æµªè´¹å¤§é‡äº†å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æºï¼› HTTP å¤´éƒ¨å·¨å¤§ä¸”é‡å¤ï¼šç”±äº HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¾—æºå¸¦ HTTP å¤´éƒ¨ï¼Œç‰¹åˆ«æ˜¯å¯¹äºæœ‰æºå¸¦ Cookie çš„å¤´éƒ¨ï¼Œè€Œ Cookie çš„å¤§å°é€šå¸¸å¾ˆå¤§ï¼› å¹¶å‘æ•°é‡æœ‰é™ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:5:1","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"HTTP 2.0 é—®ï¼šHTTP 1.1 å’Œ HTTP 2.0 æœ‰å•¥åŒºåˆ«ï¼Ÿ HTTP/2 ç›¸æ¯” HTTP/1.1 æ€§èƒ½ä¸Šçš„æ”¹è¿›ï¼š å¤´éƒ¨å‹ç¼© äºŒè¿›åˆ¶æ ¼å¼ å¹¶å‘ä¼ è¾“ æœåŠ¡å™¨ä¸»åŠ¨æ¨é€èµ„æº å¤´éƒ¨å‹ç¼© HTTP/2 ä¼šå‹ç¼©å¤´(Header)ï¼Œå¦‚æœä½ åŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚ï¼Œä»–ä»¬çš„å¤´æ˜¯ä¸€æ ·çš„æˆ–æ˜¯ç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆå°±ä¼šæ¶ˆé™¤é‡å¤çš„éƒ¨åˆ†ã€‚ è¿™å°±æ˜¯æ‰€è°“çš„ HPACK ç®—æ³•ï¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ—¶ç»´æŠ¤ä¸€å¼ å¤´ä¿¡æ¯è¡¨ï¼Œæ‰€æœ‰å­—æ®µéƒ½ä¼šå­˜å…¥è¿™ä¸ªè¡¨ï¼Œç”Ÿæˆä¸€ä¸ªç´¢å¼•å·ï¼Œä»¥åå°±ä¸å‘é€åŒæ ·å­—æ®µäº†ï¼Œåªå‘é€ç´¢å¼•å·ï¼Œè¿™æ ·å°±æé«˜é€Ÿåº¦äº†ã€‚ äºŒè¿›åˆ¶å¸§ èŠ‚çœç©ºé—´ï¼šHTTP/2 ä¸å†åƒ HTTP/1.1 é‡Œçš„çº¯æ–‡æœ¬å½¢å¼çš„æŠ¥æ–‡ï¼Œè€Œæ˜¯å…¨é¢é‡‡ç”¨äº†äºŒè¿›åˆ¶æ ¼å¼ï¼Œè¿™ä¼šèŠ‚çœå¾ˆå¤šå­—èŠ‚ï¼Œæ¯”å¦‚ä¹‹å‰çŠ¶æ€ç 200ï¼Œä¹‹å‰æ˜¯ç”¨ â€˜2â€™â€˜0â€™â€˜0â€™ 3 ä¸ªå­—ç¬¦æ¥è¡¨ç¤º(00110010 00110000 00110000)ï¼Œå…±ç”¨äº† 3 ä¸ªå­—èŠ‚ï¼›ç°åœ¨å°±åªéœ€ 1 ä¸ªå­—èŠ‚(10001000)ã€‚ èŠ‚çœæ—¶é—´ï¼šHeader å’Œ Body éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”ç»Ÿç§°ä¸ºå¸§(frame)ï¼šå¤´ä¿¡æ¯å¸§(Headers Frame)å’Œæ•°æ®å¸§(Data Frame)ã€‚å¸§å¤´ä¸€å…±å°± 9 å­—èŠ‚ã€‚ç”±äºæ”¶åˆ°æŠ¥æ–‡åï¼Œæ— éœ€è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œå°±å¢åŠ äº†æ•°æ®ä¼ è¾“çš„æ•ˆç‡ã€‚ å¸§é•¿åº¦ï¼šå¸§æ•°æ®çš„é•¿åº¦ï¼› å¸§ç±»å‹ï¼šä¸»è¦åˆ†ä¸ºæ•°æ®å¸§ã€æ§åˆ¶å¸§ã€‚æ•°æ®å¸§ä¸»è¦æ˜¯ä¼ é€’HTTPåŒ…å¤´å’ŒåŒ…ä½“ï¼› å¸§æ•°æ®ï¼šHPACK ç®—æ³•å‹ç¼©è¿‡çš„HTTPåŒ…å¤´å’ŒåŒ…ä½“ã€‚ å¹¶å‘ä¼ è¾“â­ HTTP/2 æ”¯æŒå¤šä¸ª Stream å¤ç”¨åœ¨ä¸€æ¡ TCP è¿æ¥ã€‚ é’ˆå¯¹ä¸åŒçš„ HTTP è¯·æ±‚ç”¨ç‹¬ä¸€æ— äºŒçš„ Stream ID æ¥åŒºåˆ†ï¼Œæ¥æ”¶ç«¯å¯ä»¥é€šè¿‡ Stream ID æœ‰åºç»„è£…æˆ HTTP æ¶ˆæ¯ï¼Œä¸åŒ Stream çš„å¸§æ˜¯å¯ä»¥ä¹±åºå‘é€çš„ï¼Œå› æ­¤å¯ä»¥å¹¶å‘ä¸åŒçš„ Stream ï¼Œä¹Ÿå°±æ˜¯ HTTP/2 å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€è¯·æ±‚å’Œå“åº”ã€‚ æœåŠ¡å™¨æ¨é€â­ HTTP/2 è¿˜åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ”¹å–„äº†ä¼ ç»Ÿçš„ã€Œè¯·æ±‚ - åº”ç­”ã€å·¥ä½œæ¨¡å¼ï¼ŒæœåŠ¡ç«¯ä¸å†æ˜¯è¢«åŠ¨åœ°å“åº”ï¼Œå¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ–¹éƒ½å¯ä»¥å»ºç«‹ Streamã€‚ä½† Stream ID æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå®¢æˆ·ç«¯å»ºç«‹çš„ Stream å¿…é¡»æ˜¯å¥‡æ•°å·ï¼Œè€ŒæœåŠ¡å™¨å»ºç«‹çš„ Stream å¿…é¡»æ˜¯å¶æ•°å·ã€‚ å¦‚ä¸‹å›¾ï¼ŒStream 2 å’Œ 4 éƒ½æ˜¯æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€çš„èµ„æºï¼Œå±äºæœåŠ¡ç«¯å»ºç«‹çš„ Streamã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:5:2","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"HTTP 3.0(æœª) é—®ï¼šHTTP 3.0 åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿï¼ˆæœªï¼‰ HTTP 3.0 å°†ä¸‹å±‚ TCP åè®®æ”¹æˆäº† UDP åè®®ã€‚ åŸºäº UDP çš„ QUIC åè®® å¯ä»¥å®ç°ç±»ä¼¼ TCP çš„å¯é æ€§ä¼ è¾“ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:5:3","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"å…­ã€RPC åŸºç¡€ é—®ï¼šä»€ä¹ˆæ˜¯ RPC åè®®ï¼Ÿ RPC(Remote Procedure Call)ï¼Œåˆå«åšè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ŒæŒ‡çš„æ˜¯åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹çš„æ–¹æ³•ï¼Œæ¯”è¾ƒæœ‰åçš„å°±æ˜¯ gRPCã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¹³æ—¶è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•å°±åƒä¸‹é¢è¿™æ ·ã€‚ res = localFunc(req) å¦‚æœç°åœ¨è¿™ä¸æ˜¯ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè€Œæ˜¯ä¸ªè¿œç«¯æœåŠ¡å™¨æš´éœ²å‡ºæ¥çš„ä¸€ä¸ªæ–¹æ³• remoteFuncï¼Œå¦‚æœæˆ‘ä»¬è¿˜èƒ½åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•é‚£æ ·å»è°ƒç”¨å®ƒï¼Œè¿™æ ·å°±å¯ä»¥å±è”½æ‰ä¸€äº›ç½‘ç»œç»†èŠ‚ï¼Œç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼Œå²‚ä¸ç¾å“‰ï¼Ÿ res = remoteFunc(req) RPC å’Œ HTTP çš„åŒºåˆ« é—®ï¼šä¸ºä»€ä¹ˆæœ‰äº† HTTP åè®®ï¼Œè¿˜è¦æœ‰ RPC åè®®ï¼Ÿâ­ ä»ä»¥ä¸‹å‡ ç‚¹è®¨è®ºã€‚ æœåŠ¡å‘ç° è¦å‘æŸä¸ªæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œé¦–å…ˆå¾—å»ºç«‹è¿æ¥ï¼Œå»ºç«‹è¿æ¥å°±å¾—å…ˆçŸ¥é“æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å§ï¼š HTTPï¼šé€šè¿‡ DNS è§£æåŸŸåï¼Œå¾—åˆ°æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£ï¼› RPCï¼šæŠŠæœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£ï¼Œæå‰æ³¨å†Œåˆ° ETCD ç­‰ä¸­é—´ä»¶ï¼Œæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œå°±å»è¿™äº›ä¸­é—´ä»¶è·å¾— IP å’Œç«¯å£ä¿¡æ¯ã€‚ å…¶å®å·®ä¸å¤šï¼Œéƒ½æ˜¯é€šè¿‡ä¸­é—´æœåŠ¡è·å¾—ã€‚ åº•å±‚è¿æ¥å½¢å¼ HTTPï¼šé»˜è®¤åœ¨å»ºç«‹åº•å±‚ TCP è¿æ¥ä¹‹åä¼šä¸€ç›´ä¿æŒè¿™ä¸ªè¿æ¥(Keep Alive)ï¼Œä¹‹åçš„è¯·æ±‚å’Œå“åº”éƒ½ä¼šå¤ç”¨è¿™æ¡è¿æ¥ï¼› RPCï¼šå»ºä¸ªè¿æ¥æ± ï¼Œè¯·æ±‚é‡å¤§çš„æ—¶å€™ï¼Œå»ºç«‹å¤šæ¡è¿æ¥æ”¾åœ¨æ± å†…ï¼Œè¦å‘æ•°æ®çš„æ—¶å€™å°±ä»æ± é‡Œå–ä¸€æ¡è¿æ¥å‡ºæ¥ï¼Œç”¨å®Œæ”¾å›å»ï¼Œä¸‹æ¬¡å†å¤ç”¨ï¼Œéå¸¸ç¯ä¿ã€‚ ä½†å®é™…ä¸Šï¼ŒHTTP åº”ç”¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šåŠ ä¸ªè¿æ¥æ± ï¼Œæ‰€ä»¥è¯´ï¼Œä¹Ÿå·®ä¸å¤ªå¤šã€‚ ä¼ è¾“å†…å®¹â­ åŸºäº TCPï¼Œheaderæ²¡ä»€ä¹ˆä¸åŒï¼Œä¸»è¦æ˜¯è¦å¯¹bodyä¸­çš„å†…å®¹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š HTTPï¼šä¸»è¦æ˜¯é€šè¿‡ JSONï¼› RPCï¼šä¸»è¦æ˜¯é€šè¿‡ Protobufã€‚ HTTP ç¤ºä¾‹ï¼š äºŒè€…å¯¹æ¯”ï¼š HTTP çš„ Header å’Œ Body éƒ½æ˜¯ key-value å½¢å¼ï¼Œä½†æ˜¯keyå…¶å®å¾ˆå¤šä½™ã€‚æœ€æ˜æ˜¾çš„ï¼Œåƒ Header é‡Œçš„é‚£äº›ä¿¡æ¯ï¼Œå…¶å®å¦‚æœæˆ‘ä»¬çº¦å®šå¥½å¤´éƒ¨çš„ç¬¬å‡ ä½æ˜¯ Content-Typeï¼Œå°±ä¸éœ€è¦æ¯æ¬¡éƒ½çœŸçš„æŠŠ\"Content-Type\"è¿™ä¸ªå­—æ®µéƒ½ä¼ è¿‡æ¥ï¼Œç±»ä¼¼çš„æƒ…å†µå…¶å®åœ¨ body çš„ JSON ç»“æ„é‡Œä¹Ÿç‰¹åˆ«æ˜æ˜¾ã€‚ è€Œ RPCï¼Œå¯ä»¥é‡‡ç”¨ä½“ç§¯æ›´å°çš„Protobufç­‰å®šåˆ¶åŒ–åºåˆ—åŒ–åè®®(è¯¦è§protobufçš„md)ï¼Œè¿™å°±æ˜¯å…¬å¸çš„å¾®æœåŠ¡ä¸­ä½¿ç”¨ RPC çš„==ä¸»è¦åŸå› ==ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:6:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"ä¸ƒã€Cookie å’Œ Session é—®ï¼šä»€ä¹ˆæ˜¯ Cookieï¼Ÿä¸ºå•¥è¦æœ‰ Cookieï¼Ÿ HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®© HTTP åè®®å°½å¯èƒ½ç®€å•ï¼Œä½¿å¾—å®ƒèƒ½å¤Ÿå¤„ç†å¤§é‡äº‹åŠ¡ï¼ŒHTTP/1.1 å¼•å…¥ Cookie æ¥ä¿å­˜çŠ¶æ€ä¿¡æ¯ã€‚ Cookie æ˜¯æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶==ä¿å­˜åœ¨æœ¬åœ°==çš„ä¸€å°å—æ•°æ®ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨ä¹‹åå‘åŒä¸€æœåŠ¡å™¨å†æ¬¡å‘èµ·è¯·æ±‚æ—¶è¢«æºå¸¦ä¸Šï¼Œç”¨äºå‘ŠçŸ¥æœåŠ¡ç«¯ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€æµè§ˆå™¨ã€‚ Cookie çš„å‡ºç°æ˜¯å› ä¸º HTTP æ˜¯æ— çŠ¶æ€çš„ä¸€ç§åè®®ï¼Œæ¢å¥è¯è¯´ï¼ŒæœåŠ¡å™¨è®°ä¸ä½ä½ ï¼Œå¯èƒ½ä½ æ¯åˆ·æ–°ä¸€æ¬¡ç½‘é¡µï¼Œå°±è¦é‡æ–°è¾“å…¥ä¸€æ¬¡è´¦å·å¯†ç è¿›è¡Œç™»å½•ã€‚è¿™æ˜¾ç„¶æ˜¯è®©äººæ— æ³•æ¥å—çš„ï¼ŒCookie çš„ä½œç”¨å°±å¥½æ¯”æœåŠ¡å™¨ç»™ä½ è´´ä¸ªæ ‡ç­¾ï¼Œç„¶åä½ æ¯æ¬¡å‘æœåŠ¡å™¨å†å‘è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨å°±èƒ½å¤Ÿ Cookie è®¤å‡ºä½ ã€‚ é—®ï¼šCookie åº”ç”¨åœºæ™¯ï¼Ÿ ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€æ¸¸æˆåˆ†æ•°æˆ–å…¶å®ƒéœ€è¦è®°å½•çš„ä¿¡æ¯ï¼‰ ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜ç­‰ï¼‰ æµè§ˆå™¨è¡Œä¸ºè·Ÿè¸ªï¼ˆå¦‚è·Ÿè¸ªåˆ†æç”¨æˆ·è¡Œä¸ºç­‰ï¼‰ é—®ï¼šSession æ˜¯å•¥ï¼Ÿä¸ºå•¥è¦æœ‰ Sessionï¼Ÿ Session å¯ä»¥å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥å°† Session å­˜å‚¨åœ¨ Redis è¿™ç§å†…å­˜å‹æ•°æ®åº“ä¸­ï¼Œæ•ˆç‡ä¼šæ›´é«˜ã€‚ ä½¿ç”¨ Session ç»´æŠ¤ç”¨æˆ·ç™»å½•çŠ¶æ€çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·æäº¤åŒ…å«ç”¨æˆ·åå’Œå¯†ç çš„è¡¨å•ï¼Œæ”¾å…¥ HTTP è¯·æ±‚æŠ¥æ–‡ä¸­ï¼› æœåŠ¡å™¨éªŒè¯è¯¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚æœæ­£ç¡®åˆ™æŠŠç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° Redis ä¸­ï¼Œå®ƒåœ¨ Redis ä¸­çš„ Key ç§°ä¸º Session IDï¼› æœåŠ¡å™¨è¿”å›çš„å“åº”æŠ¥æ–‡çš„ Set-Cookie é¦–éƒ¨å­—æ®µåŒ…å«äº†è¿™ä¸ª Session IDï¼Œå®¢æˆ·ç«¯æ”¶åˆ°å“åº”æŠ¥æ–‡ä¹‹åå°†è¯¥ Cookie å€¼å­˜å…¥æµè§ˆå™¨ä¸­ï¼› å®¢æˆ·ç«¯ä¹‹åå¯¹åŒä¸€ä¸ªæœåŠ¡å™¨è¿›è¡Œè¯·æ±‚æ—¶ä¼šåŒ…å«è¯¥ Cookie å€¼ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ä¹‹åæå–å‡º Session IDï¼Œä» Redis ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œç»§ç»­ä¹‹å‰çš„ä¸šåŠ¡æ“ä½œã€‚ é—®ï¼šSession å’Œ Cookie çš„åŒºåˆ«ï¼Ÿâ­ Cookie Cookieæ˜¯å®¢æˆ·ç«¯ä¿æŒçŠ¶æ€çš„æ–¹æ³•ã€‚ **Cookieç®€å•çš„ç†è§£å°±æ˜¯å­˜å‚¨ç”±æœåŠ¡å™¨å‘è‡³å®¢æˆ·ç«¯å¹¶ç”±å®¢æˆ·ç«¯ä¿å­˜çš„ä¸€æ®µå­—ç¬¦ä¸²ã€‚**ä¸ºäº†ä¿æŒä¼šè¯ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶å°†Cookieå­—ç¬¦ä¸²æ”¾åœ¨Set-Cookieä¸‹ï¼Œå®¢æˆ·æœºæ”¶åˆ°Cookieä¹‹åä¿å­˜è¿™æ®µå­—ç¬¦ä¸²ï¼Œä¹‹åå†è¯·æ±‚æ—¶å€™å¸¦ä¸ŠCookieå°±å¯ä»¥è¢«è¯†åˆ«ã€‚ é™¤äº†ä¸Šé¢æåˆ°çš„è¿™äº›ï¼ŒCookieåœ¨å®¢æˆ·ç«¯çš„ä¿å­˜å½¢å¼å¯ä»¥æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä¼šè¯Cookieï¼Œä¸€ç§æ˜¯æŒä¹…Cookieã€‚ä¼šè¯Cookieå°±æ˜¯å°†æœåŠ¡å™¨è¿”å›çš„Cookieå­—ç¬¦ä¸²ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå…³é—­æµè§ˆå™¨ä¹‹åè‡ªåŠ¨é”€æ¯ï¼ŒæŒä¹…Cookieåˆ™æ˜¯å­˜å‚¨åœ¨å®¢æˆ·ç«¯ç£ç›˜ä¸Šï¼Œå…¶æœ‰æ•ˆæ—¶é—´åœ¨æœåŠ¡å™¨å“åº”å¤´ä¸­è¢«æŒ‡å®šï¼Œåœ¨æœ‰æ•ˆæœŸå†…ï¼Œå®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚æœåŠ¡å™¨æ—¶éƒ½å¯ä»¥ç›´æ¥ä»æœ¬åœ°å–å‡ºã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå­˜å‚¨åœ¨ç£ç›˜ä¸­çš„Cookieæ˜¯å¯ä»¥è¢«å¤šä¸ªæµè§ˆå™¨ä»£ç†æ‰€å…±äº«çš„ã€‚ Session Sessionæ˜¯æœåŠ¡å™¨ä¿æŒçŠ¶æ€çš„æ–¹æ³•ã€‚ é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒSessionä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥ä¿å­˜åœ¨æ•°æ®åº“ã€æ–‡ä»¶æˆ–å†…å­˜ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„Sessionç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä¸Šè®°å½•ç”¨æˆ·çš„æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºæ¯ä¸ªç”¨æˆ·æœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„Session IDä½œä¸ºSessionæ–‡ä»¶çš„Hashé”®ï¼Œé€šè¿‡è¿™ä¸ªå€¼å¯ä»¥é”å®šå…·ä½“çš„Sessionç»“æ„çš„æ•°æ®ï¼Œè¿™ä¸ªSessionç»“æ„ä¸­å­˜å‚¨äº†ç”¨æˆ·æ“ä½œè¡Œä¸ºã€‚ ==ä¸¤è€…ç»“åˆï¼Œå®ŒæˆæœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯ä¼šè¯çŠ¶æ€çš„ä¿æŒã€‚==æ¯æ¬¡HTTPè¯·æ±‚çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šå‘é€ç›¸åº”çš„Cookieä¿¡æ¯åˆ°æœåŠ¡ç«¯ï¼Œç„¶åæ‰¾åˆ°ç›¸åº”çš„Sessionæ¥ä¿æŒä¼šè¯çŠ¶æ€ã€‚ å®é™…ä¸Šå¤§å¤šæ•°çš„åº”ç”¨éƒ½æ˜¯ç”¨Cookieæ¥å®ç°Sessionè·Ÿè¸ªçš„ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºSessionçš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šåœ¨HTTPåè®®ä¸­å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œéœ€è¦åœ¨Cookieé‡Œé¢è®°å½•ä¸€ä¸ªSession IDï¼Œä»¥åæ¯æ¬¡è¯·æ±‚æŠŠè¿™ä¸ªä¼šè¯IDå‘é€åˆ°æœåŠ¡å™¨ï¼Œæˆ‘å°±çŸ¥é“ä½ æ˜¯è°äº†ã€‚å¦‚æœå®¢æˆ·ç«¯çš„æµè§ˆå™¨ç¦ç”¨äº†Cookieï¼Œä¼šä½¿ç”¨ä¸€ç§å«åšURLé‡å†™çš„æŠ€æœ¯æ¥è¿›è¡Œä¼šè¯è·Ÿè¸ªï¼Œå³æ¯æ¬¡HTTPäº¤äº’ï¼ŒURLåé¢éƒ½ä¼šè¢«é™„åŠ ä¸Šä¸€ä¸ªè¯¸å¦‚sid=xxxxxè¿™æ ·çš„å‚æ•°ï¼ŒæœåŠ¡ç«¯æ®æ­¤æ¥è¯†åˆ«ç”¨æˆ·ï¼Œè¿™æ ·å°±å¯ä»¥å¸®ç”¨æˆ·å®Œæˆè¯¸å¦‚ç”¨æˆ·åç­‰ä¿¡æ¯è‡ªåŠ¨å¡«å…¥çš„æ“ä½œäº†ã€‚ é—®ï¼šå¦‚æœæ²¡æœ‰ Cookie ï¼Œè¿˜èƒ½ç”¨ Session å˜›ï¼Ÿ ä¸€èˆ¬æ˜¯é€šè¿‡ Cookie æ¥ä¿å­˜ SessionIDï¼Œå‡å¦‚ä½ ä½¿ç”¨äº† Cookie ä¿å­˜ SessionID çš„æ–¹æ¡ˆçš„è¯ï¼Œ å¦‚æœå®¢æˆ·ç«¯ç¦ç”¨äº† Cookieï¼Œé‚£ä¹ˆ Session å°±æ— æ³•æ­£å¸¸å·¥ä½œã€‚ ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ²¡æœ‰ Cookie ä¹‹åå°±ä¸èƒ½ç”¨ Session äº†ï¼Œæ¯”å¦‚ä½ å¯ä»¥å°† SessionID æ”¾åœ¨è¯·æ±‚çš„ url é‡Œé¢https://javaguide.cn/?Session_id=xxx ã€‚è¿™ç§æ–¹æ¡ˆçš„è¯å¯è¡Œï¼Œä½†æ˜¯å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒæ„Ÿé™ä½ã€‚å½“ç„¶ï¼Œä¸ºäº†ä½ ä¹Ÿå¯ä»¥å¯¹ SessionID è¿›è¡Œä¸€æ¬¡åŠ å¯†ä¹‹åå†ä¼ å…¥åç«¯ã€‚ é—®ï¼šå¤šæœåŠ¡å™¨èŠ‚ç‚¹ä¸‹ Session-Cookie æ–¹æ¡ˆå¦‚ä½•åšï¼Ÿ ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬éƒ¨ç½²äº†ä¸¤ä»½ç›¸åŒçš„æœåŠ¡ Aï¼ŒBï¼Œç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»é™†çš„æ—¶å€™ ï¼ŒNginx é€šè¿‡è´Ÿè½½å‡è¡¡æœºåˆ¶å°†ç”¨æˆ·è¯·æ±‚è½¬å‘åˆ° A æœåŠ¡å™¨ï¼Œæ­¤æ—¶ç”¨æˆ·çš„ Session ä¿¡æ¯ä¿å­˜åœ¨ A æœåŠ¡å™¨ã€‚ç»“æœï¼Œç”¨æˆ·ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ Nginx å°†è¯·æ±‚è·¯ç”±åˆ° B æœåŠ¡å™¨ï¼Œç”±äº B æœåŠ¡å™¨æ²¡æœ‰ä¿å­˜ ç”¨æˆ·çš„ Session ä¿¡æ¯ï¼Œå¯¼è‡´ç”¨æˆ·éœ€è¦é‡æ–°è¿›è¡Œç™»é™†ã€‚ æœ‰ä¸‰ç§æ–¹æ³•ï¼š æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œç­–ç•¥åˆ†é…ç»™åŒä¸€ä¸ªæœåŠ¡å™¨å¤„ç†ã€‚è¿™æ ·çš„è¯ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜äº†ä¸€éƒ¨åˆ†ç”¨æˆ·çš„ Session ä¿¡æ¯ã€‚æœåŠ¡å™¨å®•æœºï¼Œå…¶ä¿å­˜çš„æ‰€æœ‰ Session ä¿¡æ¯å°±å®Œå…¨ä¸¢å¤±äº†ã€‚ å•ç‹¬ä½¿ç”¨ä¸€ä¸ªæ‰€æœ‰æœåŠ¡å™¨éƒ½èƒ½è®¿é—®åˆ°çš„æ•°æ®èŠ‚ç‚¹ï¼ˆæ¯”å¦‚ç¼“å­˜ï¼‰æ¥å­˜æ”¾ Session ä¿¡æ¯ã€‚ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œæ•°æ®èŠ‚ç‚¹å°½é‡è¦é¿å…æ˜¯å•ç‚¹ã€‚ æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¿å­˜çš„ Session ä¿¡æ¯éƒ½æ˜¯äº’ç›¸åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜äº†å…¨é‡çš„ Session ä¿¡æ¯ã€‚æ¯å½“ä¸€ä¸ªæœåŠ¡å™¨çš„ Session ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å°±å°†å…¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚è¿™ç§æ–¹æ¡ˆæˆæœ¬å¤ªå¤§ï¼Œå¹¶ä¸”ï¼ŒèŠ‚ç‚¹è¶Šå¤šæ—¶ï¼ŒåŒæ­¥æˆæœ¬ä¹Ÿè¶Šé«˜ã€‚ é—®ï¼šCookie-Session å’Œ Token çš„åŒºåˆ«ï¼Ÿ Cookie-Sessioon æ–¹æ¡ˆä¸­ï¼ŒæœåŠ¡å™¨å¿…é¡»ä¿å­˜sessionIDä»¥åŠè¯¥IDæ‰€ä»£è¡¨çš„å®¢æˆ·ç«¯ä¿¡æ¯ã€‚è¿™äº›å†…å®¹å¯ä»¥ä¿å­˜åœ¨å†…å­˜ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åˆ°æ•°æ®åº“(é€šå¸¸æ˜¯å†…å­˜æ•°æ®åº“)ï¼›è€Œtokenåˆ™å¯ä»¥æœåŠ¡å™¨å®Œå…¨ä¸ç”¨ä¿å­˜ä»»ä½•ç™»å½•ä¿¡æ¯ï¼Œå‡è½»äº†æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚ tokençš„æµç¨‹æ˜¯è¿™æ ·çš„ã€‚å®¢æˆ·ç«¯ç™»å½•é€šè¿‡åï¼ŒæœåŠ¡å™¨ç”Ÿæˆä¸€å †å®¢æˆ·ç«¯èº«ä»½ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·åã€ç”¨æˆ·ç»„ã€æœ‰é‚£äº›æƒé™ã€è¿‡æœŸæ—¶é—´ç­‰ç­‰ã€‚å¦å¤–å†å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œç­¾åã€‚ä¹‹åæŠŠèº«ä»½ä¿¡æ¯å’Œç­¾åä½œä¸ºä¸€ä¸ªæ•´ä½“ä¼ ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ªæ•´ä½“å°±å«åštokenã€‚ä¹‹åï¼Œå®¢æˆ·ç«¯è´Ÿè´£ä¿å­˜è¯¥tokenï¼Œè€ŒæœåŠ¡å™¨ä¸å†ä¿å­˜ã€‚å®¢æˆ·ç«¯æ¯æ¬¡è®¿é—®è¯¥ç½‘ç«™éƒ½è¦å¸¦ä¸Šè¿™ä¸ªtokenã€‚æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼ŒæŠŠå®ƒåˆ†å‰²æˆèº«ä»½ä¿¡æ¯å’Œç­¾åï¼Œç„¶åéªŒè¯ç­¾åï¼Œè‹¥éªŒè¯æˆåŠŸï¼Œå°±ç›´æ¥ä½¿ç”¨èº«ä»½ä¿¡æ¯(ç”¨æˆ·åã€ç”¨æˆ·ç»„ã€æœ‰å“ªäº›æƒé™ç­‰ç­‰)ã€‚ tokenç›¸å¯¹cookieçš„ä¼˜åŠ¿ï¼š æ— çŠ¶æ€ åŸºäºtokençš„éªŒè¯æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™ä¹Ÿè®¸æ˜¯å®ƒç›¸å¯¹cookieæ¥è¯´æœ€å¤§çš„ä¼˜ç‚¹ã€‚åç«¯æœåŠ¡ä¸éœ€è¦è®°å½•tokenã€‚æ¯ä¸ªä»¤ç‰Œéƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒåŒ…æ‹¬æ£€æŸ¥å…¶æœ‰æ•ˆæ€§æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶é€šè¿‡å£°æ˜ä¼ è¾¾ç”¨æˆ·ä¿¡æ¯ã€‚æ¯•ç«Ÿï¼ŒæŸ¥è¯¢sessionåœ¨è¿›è¡Œå¯¹æ¯”å¯èƒ½ä¼šæ¶‰åŠåˆ°ç½‘ç»œé€šä¿¡ã€æ•°æ®åº“è¯»å–ç­‰ï¼Œè‚¯å®šæ˜¯æ¯”åšä¸€æ¬¡hashç”¨æ—¶è¦å¤šçš„ã€‚ æœåŠ¡å™¨å”¯ä¸€çš„å·¥ä½œå°±æ˜¯åœ¨æˆåŠŸçš„ç™»é™†è¯·æ±‚ä¸Šç­¾ç½²tokenï¼Œå¹¶éªŒè¯ä¼ å…¥çš„tokenæ˜¯å¦æœ‰æ•ˆã€‚ é˜²è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰ï¼Œé™„å¸¦åŠŸèƒ½ã€‚ å¤šç«™ç‚¹ä½¿ç”¨ cookieç»‘å®šåˆ°å•ä¸ªåŸŸã€‚foo.comåŸŸäº§ç”Ÿçš„cookieæ— æ³•è¢«bar.comåŸŸè¯»å–ã€‚ä½¿ç”¨tokenå°±æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ã€‚è¿™å¯¹äºéœ€è¦å‘å¤šä¸ªæœåŠ¡è·å–æˆæƒçš„å•é¡µé¢åº”ç”¨ç¨‹åºå°¤å…¶æœ‰ç”¨ã€‚ ä½¿ç”¨tokenï¼Œä½¿å¾—ç”¨ä»myapp.comè·å–çš„æˆæƒå‘myservice1.comå’Œmyservice2.comè·å–æœåŠ¡æˆä¸ºå¯èƒ½ã€‚ æ”¯æŒç§»åŠ¨å¹³å° å¥½çš„APIå¯ä»¥åŒæ—¶æ”¯æŒæµè§ˆå™¨ï¼ŒiOSå’ŒAndroidç­‰ç§»åŠ¨å¹³å°ã€‚ç„¶è€Œï¼Œåœ¨ç§»åŠ¨å¹³å°ä¸Šï¼Œcookieæ˜¯ä¸è¢«æ”¯æŒçš„ã€‚ æ€§èƒ½ ä¸€æ¬¡ç½‘ç»œå¾€è¿”æ—¶é—´ï¼ˆé€šè¿‡æ•°æ®åº“æŸ¥è¯¢sessionä¿¡æ¯ï¼‰æ€»æ¯”åšä¸€æ¬¡HMACSHA256è®¡ç®—çš„TokenéªŒè¯å’Œè§£æè¦è´¹æ—¶å¾—å¤šã€‚ é—®ï¼šToken çš„å­˜å‚¨ä½ç½®ï¼Ÿ JWT çš„ä¿å­˜ä½ç½®ï¼Œå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å››ç§ï¼š ä¿å­˜åœ¨ localStorage ä¿å­˜åœ¨ sessionStorage ä¿å­˜åœ¨ cookie ä¿å­˜åœ¨ cookie å¹¶è®¾ç½® HttpOnly ç¬¬ä¸€ç§å’Œç¬¬äºŒç§å…¶å®å¯ä»¥å½’ä¸ºä¸€ç±»ï¼Œè¿™ä¸€ç±»æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯è¯¥åŸŸå†…çš„ js è„šæœ¬éƒ½å¯ä»¥è¯»å–ï¼Œè¿™ç§æƒ…å†µä¸‹ JWT é€šè¿‡ js è„šæœ¬æ”¾å…¥ Header é‡Œçš„ Authorization å­—æ®µï¼Œä¼šå­˜åœ¨ XSS æ”»å‡»é£é™©ã€‚ ç¬¬ä¸‰ç§ï¼Œä¸ç¬¬å››ç§ç›¸æ¯”ï¼ŒåŒºåˆ«åœ¨äº cookie æœ‰æ²¡æœ‰æ ‡è®° HttpOnlyï¼Œæ²¡æœ‰æ ‡è®° HttpOnly çš„ cookie ï¼Œå®¢æˆ·ç«¯å¯ä»¥å°† JWT é€šè¿‡ js è„šæœ¬æ”¾å…¥ Header é‡Œçš„ Authorization å­—æ®µã€‚è¿™ä¹ˆçœ‹å¥½åƒåŒæ—¶å­˜åœ¨CSRF æ”»å‡»é£é™©å’Œ XSS æ”»å‡»é£é™©ï¼Œå®åˆ™ä¸ç„¶ï¼Œæˆ‘ä»¬è™½ç„¶å°† JWT å­˜å‚¨åœ¨ cookie é‡Œï¼Œä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡ç«¯å¹¶æ²¡æœ‰åˆ©ç”¨ cookie é‡Œçš„ JWT ç›´æ¥å»é‰´æƒï¼Œè€Œæ˜¯é€šè¿‡ header é‡Œçš„ Authorization å»é‰´æƒï¼Œå› æ­¤è¿™ç§æ–¹æ³•åªæœ‰ XSS æ”»å‡»é£é™©ï¼Œè€Œæ²¡æœ‰ CSRF æ”»å‡»é£é™©ã€‚ è€Œç¬¬å››ç§ï¼ŒåŠ äº† HttpOnly æ ‡è®°ï¼Œæ„å‘³ç€è¿™ä¸ª cookie æ— æ³•é€šè¿‡jsè„šæœ¬è¿›è¡Œè¯»å–å’Œä¿®æ”¹ï¼Œæœç»äº† XSS æ”»å‡»çš„å‘ç”Ÿã€‚ä¸æ­¤åŒæ—¶ï¼Œç½‘ç«™è‡ªèº«çš„ js è„šæœ¬ä¹Ÿæ— æ³•åˆ©ç”¨ cookie è®¾ç½® header çš„Authorization å­—æ®µï¼Œå› æ­¤åªèƒ½é€šè¿‡ cookie é‡Œçš„ JWT å»é‰´æƒï¼Œæ‰€ä»¥ä¸å¯é¿å…","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:7:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"å…«ã€ARP é—®ï¼šARP åè®®æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ ARP åè®®ï¼Œå…¨ç§° åœ°å€è§£æåè®®ï¼ˆAddress Resolution Protocolï¼‰ï¼Œå®ƒè§£å†³çš„æ˜¯ç½‘ç»œå±‚åœ°å€å’Œé“¾è·¯å±‚åœ°å€ä¹‹é—´çš„è½¬æ¢é—®é¢˜ã€‚ é—®ï¼šå¯»å€åŸç†ï¼Ÿ è®°ä½å‡ ä¸ªå…³é”®è¯ï¼šARP è¡¨ã€å¹¿æ’­é—®è¯¢ã€å•æ’­å“åº”ã€‚ ARP çš„å·¥ä½œåŸç†åº”åˆ†ä¸¤ç§åœºæ™¯è®¨è®ºï¼š åŒä¸€å±€åŸŸç½‘å†…çš„ MAC å¯»å€ï¼› ä»ä¸€ä¸ªå±€åŸŸç½‘åˆ°å¦ä¸€ä¸ªå±€åŸŸç½‘ä¸­çš„ç½‘ç»œè®¾å¤‡çš„å¯»å€ã€‚ å¾ˆç®€å•ï¼Œçœ‹ä¸‹å°±ä¼šäº† å¦‚æœARPåè®®æ— æ³•è·å–MACåœ°å€ï¼Œé€šå¸¸ä¼šå‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š ç›®æ ‡ä¸»æœºä¸å¯è¾¾ï¼šå¦‚æœARPåè®®æ— æ³•è·å–ç›®æ ‡ä¸»æœºçš„MACåœ°å€ï¼Œé€šå¸¸è¯´æ˜ç›®æ ‡ä¸»æœºä¸å¯è¾¾ï¼Œå¯èƒ½æ˜¯å› ä¸ºç›®æ ‡ä¸»æœºå·²ç»å…³æœºã€ç½‘ç»œæ•…éšœã€ç½‘ç»œæ‹¥å µç­‰åŸå› å¯¼è‡´æ•°æ®æ— æ³•åˆ°è¾¾ç›®æ ‡ä¸»æœºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸éœ€è¦å¯¹ç½‘ç»œè¿›è¡Œæ•…éšœæ’é™¤ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨å¹¶è¿›è¡Œä¿®å¤ã€‚ ç›®æ ‡ä¸»æœºåœ¨ä¸åŒçš„ç½‘ç»œä¸­ï¼šå¦‚æœARPåè®®æ— æ³•è·å–ç›®æ ‡ä¸»æœºçš„MACåœ°å€ï¼Œä½†æ˜¯ç›®æ ‡ä¸»æœºç¡®å®å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å› ä¸ºç›®æ ‡ä¸»æœºå’Œå‘é€æ•°æ®çš„ä¸»æœºåœ¨ä¸åŒçš„ç½‘ç»œä¸­ï¼Œéœ€è¦é€šè¿‡è·¯ç”±å™¨è¿›è¡Œé€šä¿¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸éœ€è¦è¿›è¡Œè·¯ç”±å™¨é…ç½®ï¼Œä½¿å¾—æ•°æ®å¯ä»¥ä»æºä¸»æœºåˆ°è¾¾ç›®æ ‡ä¸»æœºæ‰€åœ¨çš„ç½‘ç»œï¼Œå¹¶å°†ç›®æ ‡ä¸»æœºçš„MACåœ°å€æ˜ å°„åˆ°æ­£ç¡®çš„IPåœ°å€ä¸Šã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:8:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"ä¹ã€ç½‘ç»œå®‰å…¨ é—®ï¼šä¸ºä»€ä¹ˆ Cookie æ— æ³•é˜²æ­¢ CSRF æ”»å‡»ï¼Œè€Œ Token å¯ä»¥ï¼Ÿ CSRF(Cross Site Request Forgery) ä¸€èˆ¬è¢«ç¿»è¯‘ä¸º è·¨ç«™è¯·æ±‚ä¼ªé€  ã€‚ å½“è¿›è¡Œ Session è®¤è¯åï¼Œæ¯æ¬¡ç™»å½•æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šé»˜è®¤æºå¸¦ Cookieï¼ŒæœåŠ¡ç«¯é€šè¿‡ Cookie ä¸­çš„ SessionId æ ‡è¯†è¯¥ç”¨æˆ·çš„å¯¹è¯ã€‚å½“ç”¨æˆ·æµè§ˆæ”»å‡»è€…çš„é¡µé¢æ—¶ï¼Œè‹¥ç‚¹å‡»åˆ°æ„é€ çš„è¯·æ±‚é“¾æ¥ï¼Œå°±ä¼šè·³è½¬åˆ°ç›¸åº”é¡µé¢ï¼Œæµè§ˆå™¨ä¼šæŠŠ Cookie å‘é€ç»™æœåŠ¡ç«¯ï¼Œä¹Ÿå°±ç›¸å½“äºæ”»å‡»è€…ä»¥ç”¨æˆ·çš„èº«ä»½å®Œæˆäº†ä¸€æ¬¡è¯·æ±‚ã€‚ CSRFæ”»å‡»ä¹‹æ‰€ä»¥èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºæœåŠ¡å™¨è¯¯æŠŠæ”»å‡»è€…å‘é€çš„è¯·æ±‚å½“æˆäº†ç”¨æˆ·è‡ªå·±çš„è¯·æ±‚ã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨ Token å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚ åœ¨æˆ‘ä»¬ç™»å½•æˆåŠŸè·å¾— Token ä¹‹åï¼Œä¸€èˆ¬ä¼šé€‰æ‹©å­˜æ”¾åœ¨ localStorage ï¼ˆæµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼‰ä¸­ã€‚ç„¶åæˆ‘ä»¬åœ¨å‰ç«¯(js)é€šè¿‡æŸäº›æ–¹å¼ä¼šç»™æ¯ä¸ªå‘åˆ°åç«¯è¯·æ±‚çš„Authorizationä¸­åŠ ä¸Šè¿™ä¸ª Tokenï¼Œå³ä½¿æœ‰ä¸ªä½ ç‚¹å‡»äº†éæ³•é“¾æ¥å‘é€äº†è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼Œè¿™ä¸ªéæ³•è¯·æ±‚æ˜¯ä¸ä¼šæºå¸¦ Token çš„ï¼Œæ‰€ä»¥è¿™ä¸ªè¯·æ±‚å°†æ˜¯éæ³•çš„ã€‚ é—®ï¼šä»€ä¹ˆæ˜¯ SYN æ”»å‡»ï¼Ÿå¦‚ä½•é¿å… SYN æ”»å‡»ï¼Ÿ æ”»å‡»è€…ä¼ªé€ å¤§é‡çš„ SYN æŠ¥æ–‡ï¼Œå æ»¡æœåŠ¡ç«¯çš„åŠè¿æ¥é˜Ÿåˆ—ï¼Œé€ æˆæ‹’ç»æœåŠ¡ã€‚å› ä¸ºå½“ TCP åŠè¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œåç»­å†åœ¨æ”¶åˆ° SYN æŠ¥æ–‡å°±ä¼šä¸¢å¼ƒï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ— æ³•å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚ å¦‚ä½•é˜²å¾¡ï¼Ÿ è®¾ç½®æ›´å¤§çš„åŠè¿æ¥é˜Ÿåˆ—ï¼› å‡å°‘ SYN+ACK çš„é‡ä¼ æ¬¡æ•°ï¼Œä»¥åŠ å¿«å¤„äº SYN_RECV çŠ¶æ€çš„ TCP è¿æ¥æ–­å¼€ï¼›è¿™æ˜¯å› ä¸ºå¤„äº SYN_RECV çŠ¶æ€çš„ TCP è¿æ¥ä¼šé‡ä¼  SYN+ACK ï¼Œå½“é‡ä¼ è¶…è¿‡æ¬¡æ•°è¾¾åˆ°ä¸Šé™åï¼Œå°±ä¼šæ–­å¼€è¿æ¥ï¼› **å¼€å¯ syncookies åŠŸèƒ½ã€‚**å¯ä»¥åœ¨ä¸ä½¿ç”¨ SYN åŠè¿æ¥é˜Ÿåˆ—çš„æƒ…å†µä¸‹æˆåŠŸå»ºç«‹è¿æ¥ï¼Œç›¸å½“äºç»•è¿‡äº† SYN åŠè¿æ¥æ¥å»ºç«‹è¿æ¥ï¼› éƒ¨ç½²å…¥ä¾µæ£€æµ‹ç³»ç»ŸIDSï¼Œè¯†åˆ«å¹¶è¿‡æ»¤è™šå‡IPåœ°å€ã€‚ ","date":"2023-04-18","objectID":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/:9:0","tags":["è®¡ç®—æœºåŸºç¡€"],"title":"è®¡ç®—æœºç½‘ç»œ","uri":"/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"},{"categories":["é¢è¯•"],"content":"==yzbå­¦é•¿==ï¼š è…¾è®¯IEG-å…‰å­å·¥ä½œå®¤ç¾¤-åŒºå—é“¾ç ”å‘å·¥ç¨‹å¸ˆ ä¸€é¢é¢ç» 1ã€è‡ªæˆ‘ä»‹ç» 2ã€20åˆ†é’Ÿé¡¹ç›®é¢ï¼Œæ¯”å¦‚FISCO BCOSä¸­çš„äº¤æ˜“æœ‰å“ªäº›å­—æ®µã€æ•´ä¸ªäº¤æ˜“éœ€è¦ç­¾åï¼Œé‚£ä¹ˆç­¾åç”¨çš„æ˜¯ä»€ä¹ˆåŠ å¯†ç®—æ³•ï¼Œ æ•´ä½“æµç¨‹æ˜¯æ€æ ·ç­¾åçš„ï¼Œå±æ€§åŠ å¯†çš„åŸç†æ˜¯ä»€ä¹ˆï¼ŒåŒæ€åŠ å¯†åŸç†å‘¢ï¼Œé›¶çŸ¥è¯†è¯æ˜å‘¢ï¼Ÿ(è¿™é‡Œå¯„äº†ï¼ŒåªçŸ¥é“ç”¨æ³•ï¼Œä½†æ˜¯å…·ä½“åŸç†è¿˜çœŸä¸å¤ªæ¸…æ¥š) 3ã€FISCOç”¨çš„æ˜¯PBFTï¼Œé‚£ä¹ˆPBFTç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼ˆO(nÂ²)) 4ã€PBFTæ•´ä½“æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ 5ã€ä¸ºä»€ä¹ˆPBFTçš„å®¹é”™ç‡æ˜¯3f+1ï¼Ÿï¼ˆç°åœºå£è¿°æ¨å¯¼ï¼‰ 6ã€ä½ æ˜¯æ€æ ·å­¦ä¹ åŒºå—é“¾çŸ¥è¯†çš„å‘¢ï¼Ÿï¼ˆæœ€å¼€å§‹çœ‹ç»¼è¿°æ–‡ç« ï¼Œåé¢çœ‹ä¸€äº›å…³äºBitcoinã€Ethã€Fabricçš„å®˜æ–¹æ–‡æ¡£å³ç™½çš®ä¹¦é»„çš®ä¹¦ï¼Œç„¶åæ˜¯githubï¼Œå†å°±æ˜¯å„ç§å„æ ·çš„åšæ–‡) 7ã€æ¥ç€ä¸Šè¿°é—®é¢˜ï¼šä½ æœ‰çœ‹è¿‡å“ªäº›ç™½é»„çš®ä¹¦ï¼Œæœ‰å¯¹å“ªä¸€éƒ¨åˆ†å¾ˆæ·±å…¥çš„ç ”ç©¶å—ï¼Ÿ(æœ€å¼€å§‹çœ‹çš„æ˜¯e-moneyçš„é‚£ç¯‡æ–‡ç« ï¼Œç„¶åæ˜¯bitcoinç™½çš®ä¹¦ï¼Œç„¶åæ˜¯ethé»„çš®ä¹¦ï¼Œæåˆ°äº†UTXOçš„æ„é€ åŸç†) 8ã€ä»¥å¤ªåŠç›¸æ¯”äºæ¯”ç‰¹å¸UTXOæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿï¼ˆä»¥å¤ªåŠæœ‰ä¸‰æ£µæ ‘æ¥ç»´æŠ¤çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯äº¤æ˜“æ ‘ã€æ”¶æ®æ ‘å’ŒçŠ¶æ€æ ‘ï¼Œç„¶åæ¯æ£µæ ‘çš„æ•°æ®ç»“æ„å’Œå†…å®¹åˆ†åˆ«æ˜¯ä»€ä¹ˆ) 9ã€æ•°æ®åº“çŸ¥è¯†äº†è§£å—ï¼Ÿèƒ½è¯´ä¸€ä¸‹æ•°æ®åº“ç´¢å¼•çš„ç›¸å…³çŸ¥è¯†å—(ä¸ºä»€ä¹ˆMySQLçš„InnoDBç”¨çš„B+æ ‘ï¼Œæœ‰ä»€ä¹ˆä¼˜ç‚¹) 10ã€å¯¹æ±‡ç¼–åŸç†æœ‰äº†è§£å—ï¼Ÿ(è¿™ä¸ªé—®çš„æ¯”è¾ƒçº³é—·ï¼Œç­”äº†ä¸‹æœ¬ç§‘å­¦çš„æ˜¯å¾®æœºåŸç†ï¼Œæ˜¯ä»¥8086ä½œä¸ºè“æœ¬ç ”ç©¶çš„ï¼Œå®ƒçš„æŒ‡ä»¤é›†ç›¸å¯¹X86ã€ARMã€RISE-VæŒ‡ä»¤é›†ç®€æ´å¾ˆå¤šï¼Œå› ä¸ºå—é™äºCPUå’Œå¯„å­˜å™¨ç­‰å¤§å°å’Œæ€§èƒ½) 11ã€ä½ çš„ç¼–ç¨‹è¯­è¨€æ€æ ·ï¼Ÿï¼ˆjavaå’ŒC++åŒä¿®ï¼‰ 12ã€æ‰‹æ’•ä»£ç ï¼šâ‘ å¿«é€Ÿæ’åº(6minï¼Œé—®äº†ä¸‹å®ƒçš„æœ€ä¼˜/åæ—¶é—´å¤æ‚åº¦ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹æœ€ä¼˜/åï¼Œæ€ä¹ˆæ ·é¿å…æœ€åï¼šå…ˆå¾ªç¯åˆ¤æ–­ä¸€éæ˜¯å¦æ˜¯æœ‰åºçš„)ï¼›â‘¡é“¾è¡¨kä¸ªä¸€ç»„åè½¬(15min,è¿™ä¸ªç¡®å®ä¸å¤ªå¥½å†™ï¼Œæ€è·¯æ¯”è¾ƒç®€å•ä½†æ˜¯ä»£ç ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œç”¨çš„æ»‘åŠ¨çª—å£+åŒæŒ‡é’ˆ); 13ã€åé—®ï¼šå¯¹æˆ‘æœ‰ä»€ä¹ˆå­¦ä¹ ä¸Šçš„å»ºè®®å—ï¼Ÿ(å¯ä»¥å¤šçœ‹çœ‹ç™½çš®ä¹¦ï¼Œæ·±ç©¶ä¸€ä¸‹æºç ï¼Œè¿™æ ·å¯¹åŒºå—é“¾å„ä¸ªè¿‡ç¨‹éƒ½ä¼šæœ‰æ›´åŠ æ·±å…¥çš„ç†è§£)ï¼›ç„¶åä¸¤ä¸ªäººå°±å­¦æœ¯ç•Œå’Œå·¥ä¸šå±ŠåŒºå—é“¾çš„å‘å±•å½¢å¼å‘è¡¨ä¸€ä¸‹çœ‹æ³•ï¼Œéƒ½è§‰å¾—è¦æƒ³ç ”ç©¶åŒºå—é“¾åº”è¯¥æ˜¯å»çœ‹å…¬é“¾çš„çŸ¥è¯†ï¼Œè€Œå›½å†…çš„è”ç›Ÿé“¾ç ”ç©¶èµ°åäº†ï¼Œå¾ˆå¤šç ”ç©¶éƒ½æ˜¯æŠ„çš„fabricã€‚ è…¾è®¯-äºŒé¢ å¤‡æ³¨ï¼šå¦‚æœæœ‰é¡¹ç›®ï¼Œä¸€å®šè¦æå‰å‡†å¤‡å¥½é¡¹ç›®çš„å„ä¸ªæ–¹é¢ï¼Œä¸ä»…ä»…å±€é™äºè‡ªå·±åšçš„æ–¹å‘ï¼Œæ¯”å¦‚ï¼šé¡¹ç›®çš„æ ¸å¿ƒç«äº‰åŠ›ï¼Œæ•´ä¸ªé¡¹ç›®åšäº†å“ªäº›ä¸œè¥¿ï¼Œä¸ºä»€ä¹ˆè¦åšè¿™äº›ä¸œè¥¿ï¼Œè‡ªå·±åœ¨é¡¹ç›®é‡Œé¢è´Ÿè´£å“ªä¸€éƒ¨åˆ†ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšç­‰ç­‰ã€‚åŒæ—¶ä¸Šä¸€é¢æ²¡æœ‰ç­”çš„æ¯”è¾ƒå¥½çš„éƒ¨åˆ†åç»­ä¸€å®šè¦å»çœ‹ä¸€çœ‹ç†Ÿæ‚‰ä¸€ä¸‹ï¼Œé¢è¯•å®˜ä¼šå†™é¢è¯„ï¼Œåé¢çš„é¢è¯•å®˜å¯èƒ½ä¼šåŸºäºé¢è¯„è¿›è¡Œæ‹“å±•æé—®ã€‚ æ·±æŒ–é¡¹ç›®(15min)ï¼šé¡¹ç›®ä¸€å®šä¸€å®šè¦éå¸¸ç†Ÿæ‚‰ï¼ŒåŒæ—¶æ²¡åšçš„éƒ¨åˆ†ä¸è¦å†™ä¸Šå»ï¼Œé™¤éæ˜¯å¾ˆç†Ÿæ‚‰è¿‡ç¨‹å’Œåšäº†å“ªäº›ä¸œè¥¿ã€‚é€»è¾‘è¦è¿è´¯ï¼Œä¸ºä»€ä¹ˆï¼Œæ€ä¹ˆåšã€‚ï¼ˆæ¯”å¦‚ä¹‹å‰ç´«é‡‘å±±å®éªŒå®¤è½¦è”ç½‘é‚£ä¸ªé¡¹ç›®ï¼Œæˆ‘æåˆ°é¡¹ç›®ç”¨åŒºå—é“¾åšåˆ†å¸ƒå¼èº«ä»½è®¤è¯ï¼Œé¢è¯•å®˜é—®æˆ‘ä¸ºä»€ä¹ˆè¦ç”¨åŒºå—é“¾åšï¼Œä¸ç”¨åŒºå—é“¾çš„è¯åŸæ¥çš„æŠ€æœ¯æ˜¯æ€æ ·å®ç°èº«ä»½è®¤è¯çš„ï¼Œæ•ˆæœå¦‚ä½•ï¼Œç”¨äº†åŒºå—é“¾æœ‰æ²¡æœ‰æ”¹å–„å‘¢ï¼‰ã€‚ solidityä¼šå¯¼è‡´å“ªäº›å®‰å…¨é—®é¢˜ï¼Ÿï¼ˆæ¯”å¦‚ç²¾åº¦é—®é¢˜ã€æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨ã€å¾ªç¯æ”»å‡»ã€å †æ ˆæº¢å‡ºç­‰ï¼‰ å¦‚ä½•ä½¿ç”¨æ™ºèƒ½åˆçº¦äº§ç”Ÿéšæœºæ•°ï¼Ÿï¼ˆè¿™é‡Œå…¶å®æœ‰ä¸ªæ–¹æ³•å«VRFæ˜¯å¯ä»¥è§£å†³çš„ï¼Œä¸€èˆ¬æ¥è¯´æ­£å¸¸äº§ç”Ÿéšæœºæ•°æ˜¯æ ¹æ®ä¸€ä¸ªéšæœºæºseedï¼Œç„¶åæ ¹æ®ä¼ªéšæœºä»£ç äº§ç”Ÿéšæœºæ•°ï¼›ä½†æ˜¯ç”±äºæ™ºèƒ½åˆçº¦æ˜¯å…¬å¼€å¯è§çš„ï¼Œä¹Ÿå°±å¯¼è‡´äº†æ”»å‡»è€…å¯ä»¥çœ‹åˆ°ä¼ªéšæœºå‡½æ•°å…·ä½“ç”¨çš„æ˜¯å“ªä¸ªï¼Œå†æ ¹æ®éšæœºæºå°±å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªéšæœºæ•°æ˜¯ä»€ä¹ˆã€‚å› æ­¤éœ€è¦ä¿è¯éšæœºæºæ˜¯éšæœºè·å–çš„ï¼Œæ¯”å¦‚è¯´é€šè¿‡ä¸€ä¸ªå¤–éƒ¨é“¾æ¥è¿æ¥åˆ°ä¸€ä¸ªéšæœºæ•°äº§ç”Ÿç½‘ç«™ï¼Œä»¥æ­¤æ¥è·å¾—éšæœºæºï¼Œè¿™æ ·æ¯æ¬¡è°ƒç”¨åˆçº¦äº§ç”Ÿçš„éšæœºæ•°éƒ½ä¸ä¸€æ ·ï¼‰ã€‚ äº†è§£ERC20ã€ERC721ã€ERC1155å—ï¼Ÿï¼ˆERC721å®é™…ä¸Šå°±æ˜¯NFTï¼ˆæ„Ÿè°¢ç‘ä¼Ÿå­¦é•¿çš„æŒ‡å¯¼ï¼Œå‰ä¸¤å¤©æ°ä¼¦çš„NFTåˆšè¢«ç›—ï¼Œè¿™ä¸ªçœŸçš„æ˜¯é—®åˆ°è„¸ä¸Šäº†ï¼‰ï¼Œè¯´äº†ä¸‹ERC20å’ŒERC721çš„åŒºåˆ«ï¼ˆæœ€å¤§çš„åŒºåˆ«æ˜¯Tokenæ•°é‡ä¸åŒï¼‰ï¼‰ ã€æ‰¿æ¥ä¸Šä¸ªé—®é¢˜ã€‘æ°ä¼¦çš„NFTè¢«ç›—ä½ çŸ¥é“æ˜¯å› ä¸ºæ™ºèƒ½åˆçº¦çš„ä»€ä¹ˆæ¼æ´é—®é¢˜å¯¼è‡´çš„å—ï¼Ÿï¼ˆä¿ºæœ¨æ™“å¾—å‘€ï¼‰ æœ‰æœ¨æœ‰å…³æ³¨ä»¥å¤ªåŠæ¯”è¾ƒæœ‰åçš„å‡ ä¸ªé¡¹ç›®ï¼Ÿï¼ˆå¼€æ”¾ï¼‰ ä»¥å¤ªåŠäº¤æ˜“æ± ä¸­ï¼Œäº¤æ˜“æ˜¯æ ¹æ®ä»€ä¹ˆæ¥è¿›è¡Œæ’åºçš„ï¼Ÿï¼ˆæ ¹æ®äº¤æ˜“å‘èµ·è€…é¢„å…ˆä¼°è®¡çš„gasPriceæ¥è¿›è¡Œä¸€å®šè§„åˆ™çš„æ’åºï¼‰ é‚£ä¹ˆäº¤æ˜“è´¹ç”¨æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„ï¼ŒåŒ…å«äº†å“ªä¸¤ä¸ªéƒ¨åˆ†ï¼Ÿï¼ˆäº¤æ˜“è´¹ç”¨=Gas*Gas Priceï¼Œä¸€ä¸ªGas Priceå°±æ˜¯å•ä»·ï¼Œä»¥å¤ªåŠé»˜è®¤çš„Gas Priceæ˜¯1weiï¼‰ ä»¥å¤ªåŠäº¤æ˜“æµç¨‹æ˜¯å’‹æ ·çš„ï¼Ÿï¼ˆä¸Šé“¾å‰ä¸šåŠ¡æ•°æ®å¤„ç†+ä¸šåŠ¡æ‰“åŒ…ä¸Šé“¾+è°ƒç”¨åˆçº¦ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆé‡ç‚¹ï¼Œéœ€è¦ä»”ç»†ç¢ç£¨äº†è§£æ•´ä¸ªè¿‡ç¨‹ï¼Œåœ¨è¿™å°±ä¸å±•å¼€äº†ï¼‰ ä»¥å¤ªåŠè™šæ‹Ÿæœºå·¥ä½œæµç¨‹ï¼Ÿï¼ˆå¦‚æœåªæ™®é€šçš„è½¬è´¦äº¤æ˜“ï¼Œæ ¸å®åç›´æ¥å»ä¿®æ”¹ä¸–ç•ŒçŠ¶æ€æ ‘ä¸­çš„è´¦æˆ·çŠ¶æ€å³å¯ï¼›å¦‚æœæ˜¯åˆçº¦ï¼Œåˆ™è¿›è¡Œè§£é‡Šå™¨ç­‰ä¸€ç³»åˆ—æ“ä½œï¼‰ ä½ äº†è§£å…¶ä»–çš„å…±è¯†ç®—æ³•å—ï¼ˆPOS,POA,DPOSç­‰å¸¸è§çš„ï¼‰ POAåŸºæœ¬åŸç†è¯´ä¸€ä¸‹å‘—ï¼ˆPOAæ˜¯ä»¥å¤ªåŠå¯é€‰çš„å…±è¯†ï¼Œå¯æƒœè‡ªå·±åªçŸ¥é“å¤§æ¦‚çš„è¿‡ç¨‹ï¼Œå°±è¯´äº†ä¸€ä¸‹ï¼‰ ä½ å¹³æ—¶æœ‰ç”¨åˆ°å…¶ä»–çš„åŠ å¯†ç®—æ³•å—ï¼ˆä¸“åˆ©+æ¯•è®¾ç”¨äº†ï¼‰ ä½ æœ¬ç§‘æ¯•è®¾ä¸­å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯å¦‚ä½•è¿›è¡Œå®‰å…¨é€šä¿¡çš„ï¼Ÿï¼ˆå› ä¸ºé¢è¯•å®˜é—®æˆ‘æœ¬ç§‘æ¯•è®¾åšçš„å•¥ï¼Œæœ¬ç§‘æ¯•è®¾è‡ªå·±å†™äº†ä¸ªå¤šå¹¶å‘çš„ç‰©è”ç½‘è®¾å¤‡é€šä¿¡ï¼Œè¿™é‡Œç›´æ¥è¯´å’ŒTLSçš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼ŒåŒæ–¹éªŒè¯å¥½èº«ä»½ï¼Œåå•†åŠ å¯†ç®—æ³•å¥½åï¼Œå®¢æˆ·ç«¯ç”Ÿæˆå¯¹ç§°å¯†é’¥åï¼Œç”¨æœåŠ¡å™¨çš„å…¬é’¥åŠ å¯†å¯¹ç§°å¯†é’¥ä¼ ç»™æœåŠ¡å™¨ï¼Œä¹‹ååŒæ–¹ä¾æ®è¿™ä¸ªå¯¹ç§°å¯†é’¥è¿›è¡Œé€šä¿¡ï¼‰ å®¢æˆ·ç«¯æ€ä¹ˆç”Ÿæˆå…¬é’¥çš„ï¼ˆç”¨çš„AES å¯†é’¥ï¼Œå®¢æˆ·ç«¯ç”Ÿæˆäº†ä¸€ä¸ª256bitçš„å¯†é’¥ï¼Œæ ¹æ®ä¸€äº›åŠ©è®°è¯ç”Ÿæˆçš„ï¼‰ åé—®ï¼šéƒ¨åˆ†ä¸šåŠ¡æ˜¯å•¥ï¼ˆæœºå¯†ï¼‰ï¼Œä½ è§‰å¾—æˆ‘çš„è¡¨ç°å¦‚ä½•ï¼ˆå…¬å¸æœ‰è§„å®šï¼Œæœºå¯†ï¼‰ ç‰›å®¢ç½‘ï¼Œæå‰æ‰¹ 2023/03/17 æ¨è€å¸ˆ é˜¿é‡Œä¸€é¢ ==2023/04/27 ç™¾åº¦ä¸€é¢ (60 min)== è‡ªæˆ‘ä»‹ç» é¡¹ç›®ä»‹ç» é¡¹ç›®ä¸­é‡åˆ°çš„éš¾ç‚¹ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿ é¡¹ç›®ä¸­ç”¨åˆ°äº†å“ªäº›ä¸­é—´ä»¶ï¼Ÿå¯¹ä¸­é—´ä»¶çš„ç†è§£ï¼Ÿ èŒä¸šè§„åˆ’ï¼Ÿä»¥åæƒ³åšå“ªä¸ªæ–¹å‘ï¼Ÿ Go åŸºç¡€ Go æœ‰å“ªäº›å¼•ç”¨ç±»å‹ï¼Ÿ GMP æ¨¡å‹åº•å±‚åŸç†ï¼Œè°ƒåº¦åŸç†ï¼Ÿ defer æ‰§è¡Œé¡ºåºï¼Ÿreturn func() å’Œ defer ä¸‰è€…æ‰§è¡Œé¡ºåºï¼Ÿ return func() çš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆç»Ÿè®¡è¯¥å‡½æ•°çš„æ‰§è¡Œç”¨æ—¶ï¼Ÿ return è¿”å›å€¼ä¹‹åï¼Œæ˜¯å¦è¿˜å¯ä»¥è¢«ä¿®æ”¹ï¼Ÿ å¸¸è§å…«è‚¡(å¼€å§‹åŸå”±â€¦) urlè¾“å…¥åˆ°è¾“å‡ºçš„è¿‡ç¨‹ï¼Ÿ udpã€tcp å·®åˆ«ï¼Ÿ http æœ‰å•¥å­—æ®µï¼Ÿ getã€post æœ‰å•¥åŒºåˆ«ï¼Ÿ sessionã€cookie æœ‰å•¥åŒºåˆ«ï¼Ÿç¦æ­¢cookieè¿˜èƒ½ç”¨sessionå—ï¼Ÿæ€ä¹ˆå®ç°ï¼Ÿ MySQL æœ‰å“ªäº›ç´¢å¼•ï¼Ÿ è”åˆç´¢å¼•åº”ç”¨åœºæ™¯ï¼Ÿä¸ºä»€ä¹ˆè¦å»ºè”åˆç´¢å¼•ï¼Ÿ çŸ¥é“å›è¡¨æŸ¥è¯¢å—ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢ï¼Ÿ å¿˜äº†â€¦ dockerå’Œlinux äº†è§£dockerå—ï¼Ÿç”¨è¿‡ï¼Œä½†ä¸äº†è§£ã€‚ äº†è§£linuxå—ï¼Ÿç”¨è¿‡ï¼Œä½†ä¸äº†è§£ã€‚ ç®—æ³•(åªèƒ½ç”¨è®°äº‹æœ¬) æ‹¬å·åŒ¹é…ï¼› è‚¡ç¥¨ä¹°å…¥å–å‡º(ç¨å¾®æœ‰ç‚¹æ”¹åŠ¨ï¼Œæ²¡å®Œå…¨å†™å‡ºæ¥)ã€‚ åé—® ä¸»è¦åšå•¥ä¸šåŠ¡ï¼Ÿ å®ä¹ ç”Ÿè¿›å»ä¹‹åå¹²ç‚¹å•¥ï¼Ÿ ä¹‹åè¿˜ä¼šæœ‰é¢è¯•å˜›ï¼Ÿ åç»­ 2023/04/28 ä¸‹åˆ çº¦äºŒé¢ ==2023/05/08 ç™¾åº¦äºŒé¢ (60 min)== å·²å‡‰ã€‚ ==2022/05/18 è…¾è®¯ä¸€é¢ (70 min)== é¡¹ç›®ç»„ä»‹ç»ï¼Œåé—® æ‰‹æ’•ï¼šå¤§æ•°ä¹˜æ³•ã€‚ã€‚ã€‚æ²¡å†™è¿‡ï¼Œæœ€åè®²äº†æ€è·¯ Go åŸºç¡€ çº¿ç¨‹ã€åç¨‹æœ‰å•¥åŒºåˆ«ï¼Ÿ GMP æ¨¡å‹ï¼Ÿ Goroutine ä¹‹é—´æ€ä¹ˆé€šä¿¡ï¼Ÿ ä¸€èˆ¬ç”¨ Channelï¼Œè®²äº† Channel çš„åº•å±‚åŸç† Channel å¯ä»¥ä¸å…³é—­å—ï¼Ÿä¸å…³é—­ä¼šå‘ç”Ÿå•¥ï¼Ÿ Goruotine ä¼šæ³„éœ²å—ï¼Ÿæ¯”å¦‚ Goroutine å æ»¡äº†ï¼Ÿ string å’Œ []byte{}ï¼Œæ€ä¹ˆè½¬æ¢ï¼Ÿ è®²äº†ä¸¤ç§ï¼Œä¸€ç§ä¼šè§¦å‘æ‹·è´ï¼Œä¸€ç§æ˜¯ç”¨ unsafe unsafe å…·ä½“å¾—æ€ä¹ˆæ“ä½œï¼Ÿ å¿˜äº†ã€‚ã€‚ã€‚ ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½ï¼Ÿ ç»“æ„ä½“æ˜¯æ€ä¹ˆè¿›è¡Œå†…å­˜å¯¹é½çš„ï¼Ÿç»“æ„ä½“æˆå‘˜é¡ºåºä¸åŒï¼Œç»“æ„ä½“çš„å¤§å°ä¼šä¸åŒå—ï¼Ÿ è®¡ç®—æœºç½‘ç»œ ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿä¸ºå•¥è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿèƒ½ä¸¤æ¬¡å—ï¼Ÿä¼šå‡ºç°å•¥é—®é¢˜ï¼Ÿ seq çš„é€‰å–æœ‰å•¥è®²ç©¶å—ï¼Ÿ æ“ä½œç³»ç»Ÿ epoll äº†è§£å—ï¼Ÿ å’Œ selectã€poll æœ‰å•¥åŒºåˆ«ï¼Ÿé‚£æœ‰å•¥æ”¹è¿›ï¼Ÿ ET å’Œ LTï¼Ÿ(è¿™ä¸ªåªå¤§æ¦‚è®²äº†ä¸‹) RAFT RAFT æ˜¯å¼ºä¸€è‡´æ€§çš„å—ï¼Ÿ RAFT æ€ä¹ˆä¿è¯çš„å¼ºä¸€è‡´æ€§ï¼Ÿ è®²äº†é€‰ä¸»ã€æ—¥å¿—å¤åˆ¶ RAFT é€‰ä¸»æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰å‡ ç¥¨ï¼Ÿ è¿™ä¸ªè®°ä¸æ¸…äº†ï¼ŒåŸæœ¬ç­”çš„åªæœ‰ä¸€ç¥¨ï¼Œåæ¥æƒ³äº†æƒ³ZABæ˜¯ä¸€ç¥¨ï¼Œåˆæ”¹æˆèƒ½æŠ•å¤šç¥¨äº†ã€‚ã€‚ã€‚æ— è¯­ï¼ RAFT å‡ºç°å¤šä¸ªä¸»èŠ‚ç‚¹å’‹åŠï¼Ÿå¹³ç¥¨å’‹åŠï¼Ÿ é‚£è¿™ä¸ªå€’è®¡æ—¶æ˜¯å’‹ç”Ÿæˆçš„ï¼Ÿå’‹éšæœºçš„ï¼Ÿéƒ½æœ‰å“ªäº›èŠ‚ç‚¹è¦éšæœºç”Ÿæˆï¼Ÿ è¿™ä¸ªéº»äº†ï¼Œæˆ‘å¿˜äº† Redis Redis æ˜¯å’‹ä¿è¯é›†ç¾¤çš„ä¸€è‡´æ€§çš„ï¼Ÿ è®²äº†ä¸»ä»å¤åˆ¶ï¼šå…¨é‡å¤åˆ¶å’Œå¢é‡å¤åˆ¶ Redis ä¼šä¸¢å¤±æ•°æ®å—ï¼Ÿ è¿™ä¸ªè®²äº†æŒä¹…åŒ–ï¼ŒçœŸå¯æ¶ï¼Œåº”è¯¥æ˜¯è®²é›†ç¾¤é—´çš„æ•°æ®ä¸¢å¤±çš„ã€‚ã€‚ã€‚ Mysql MySQL éƒ½æœ‰å“ªäº›äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿ é»˜è®¤ç”¨å“ªä¸ªï¼Ÿ è¿™ä¸ªç­”çš„å¯é‡å¤è¯»ã€‚ ä¼šå‡ºç°å•¥é—®é¢˜ï¼Ÿå¹»è¯»æ˜¯å•¥ï¼Ÿ MySQL ç´¢å¼•ç”¨è¿‡å—ï¼Ÿè”åˆç´¢å¼•æ€ä¹ˆç”¨ï¼Ÿ è¿™ä¸ªç­”äº†ç´¢å¼•å¤±æ•ˆçš„é—®é¢˜ ä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œå­—æ®µèƒ½è·³è¿‡å—ï¼Ÿéœ€è¦æŒ‰åºå—ï¼Ÿ æ€ä¹ˆçœ‹MySQLè¯­å¥ç”¨æ²¡ç”¨åˆ°ç´¢å¼•ï¼Ÿ ç­”äº†explain explain çœŸçš„ä¼šå»æ•°æ®åº“xxxæŸ¥çœ‹å—ï¼Ÿ ä¸çŸ¥é“ã€‚ Linux éƒ½ç”¨è¿‡å•¥å‘½ä»¤ ssã€netstatã€psã€‚ã€‚ æ€ä¹ˆæŸ¥è¯¢è§£æurlçš„è¿‡ç¨‹ï¼Ÿ è¿™ä¸ªä¸é€ ã€‚ å¼€æºé¡¹ç›® æœ‰çœ‹è¿‡å¼€æºçš„é¡¹ç›®ä»£ç å—ï¼Ÿæœ‰åšè¿‡å¼€æºè´¡çŒ®å—ï¼Ÿ çœ‹è¿‡groupcacheã€ginã€ormï¼Œéº»æ²¹è´¡çŒ® ç»“æŸå’¯ ~ å‡‰ï¼ï¼ï¼ ","date":"2023-03-25","objectID":"/%E9%9D%A2%E8%AF%95%E9%A2%98/:0:0","tags":["é¢è¯•é¢˜ç›®"],"title":"é¢è¯•è®°å½•","uri":"/%E9%9D%A2%E8%AF%95%E9%A2%98/"},{"categories":["Go"],"content":"[toc] ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:0:0","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"ä¸€ã€æ¦‚è¿° åœ¨ Go è¯­è¨€ä¸­ï¼Œä¸»è¦å…³æ³¨çš„ç¨‹åºè¿è¡Œæƒ…å†µåŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š CPU profileï¼šæŠ¥å‘Šç¨‹åºçš„ CPU ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰ç…§ä¸€å®šé¢‘ç‡å»é‡‡é›†åº”ç”¨ç¨‹åºåœ¨ CPU å’Œå¯„å­˜å™¨ä¸Šé¢çš„æ•°æ®ï¼› Memory Profile(Heap Profile)ï¼šæŠ¥å‘Šç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼› Block Profileï¼šæŠ¥å‘Šå¯¼è‡´é˜»å¡çš„åŒæ­¥åŸè¯­çš„æƒ…å†µï¼Œå¯ä»¥ç”¨æ¥åˆ†æå’ŒæŸ¥æ‰¾é”çš„æ€§èƒ½ç“¶é¢ˆï¼› Goroutine Profileï¼šæŠ¥å‘Š goroutines çš„ä½¿ç”¨æƒ…å†µï¼Œæœ‰å“ªäº› goroutineï¼Œå®ƒä»¬çš„è°ƒç”¨å…³ç³»æ˜¯æ€æ ·çš„ã€‚ benchmark(åŸºå‡†æµ‹è¯•) å¯ä»¥åº¦é‡æŸä¸ªå‡½æ•°æˆ–æ–¹æ³•çš„æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“æ€§èƒ½çš„ç“¶é¢ˆç‚¹åœ¨å“ªé‡Œï¼Œbenchmark æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹å¼ã€‚ä½†æ˜¯é¢å¯¹ä¸€ä¸ªæœªçŸ¥çš„ç¨‹åºï¼Œå¦‚ä½•å»åˆ†æè¿™ä¸ªç¨‹åºçš„æ€§èƒ½ï¼Œå¹¶æ‰¾åˆ°ç“¶é¢ˆç‚¹å‘¢ï¼Ÿ pprof å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚pprof åŒ…å«ä¸¤éƒ¨åˆ†ï¼š ç¼–è¯‘åˆ°ç¨‹åºä¸­çš„ runtime/pprof åŒ… æ€§èƒ½å‰–æå·¥å…· go tool pprof é’ˆå¯¹ä¸åŒåœºæ™¯ï¼Œåº”é‡‡ç”¨ä¸åŒçš„åˆ†ææ–¹æ³•ï¼š å·¥å…·ç±»åº”ç”¨ï¼šæ‰§è¡Œå®Œä»»åŠ¡å°±ç»“æŸé€€å‡ºã€‚å¯ä»¥ä½¿ç”¨ runtime/pprof åº“ï¼› æœåŠ¡å‹åº”ç”¨ï¼šåº”ç”¨éœ€è¦ä¸€ç›´è¿è¡Œï¼Œæ¯”å¦‚ web åº”ç”¨æˆ–è€…gRPCæœåŠ¡ã€‚å¯ä»¥ä½¿ç”¨ net/http/pprof åº“ï¼Œèƒ½å¤Ÿåœ¨åº”ç”¨æä¾› HTTP æœåŠ¡æ—¶è¿›è¡Œåˆ†æã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:1:0","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"äºŒã€æ€§èƒ½åˆ†æç±»å‹ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:2:0","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"2.1 CPU æ€§èƒ½åˆ†æ CPU æ€§èƒ½åˆ†æ(CPU profiling) æ˜¯æœ€å¸¸è§çš„æ€§èƒ½åˆ†æç±»å‹ã€‚ ä¸»è¦æ€æƒ³ï¼šä¸€ä¸ªå‡½æ•°åœ¨æ€§èƒ½åˆ†ææ•°æ®ä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œè¯´æ˜æ‰§è¡Œè¯¥å‡½æ•°çš„ä»£ç è·¯å¾„(code path)èŠ±è´¹çš„æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”é‡è¶Šå¤§ã€‚ ä¸»è¦åŸç†ï¼šå¯åŠ¨ CPU åˆ†ææ—¶ï¼Œè¿è¡Œæ—¶(runtime) å°†æ¯éš” 10ms ä¸­æ–­ä¸€æ¬¡ï¼Œè®°å½•æ­¤æ—¶æ­£åœ¨è¿è¡Œçš„åç¨‹(goroutines) çš„å †æ ˆä¿¡æ¯ã€‚ç¨‹åºè¿è¡Œç»“æŸåï¼Œå¯ä»¥åˆ†æè®°å½•çš„æ•°æ®æ‰¾åˆ°æœ€çƒ­ä»£ç è·¯å¾„(hottest code paths)ã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:2:1","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"2.2 å†…å­˜æ€§èƒ½åˆ†æ å†…å­˜æ€§èƒ½åˆ†æ(Memory profiling) è®°å½•å †å†…å­˜åˆ†é…æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œå¿½ç•¥æ ˆå†…å­˜åˆ†é…ä¿¡æ¯ã€‚ å†…å­˜æ€§èƒ½åˆ†æå¯ç”¨æ—¶ï¼Œé»˜è®¤æ¯1000æ¬¡é‡‡æ ·1æ¬¡ï¼Œè¿™ä¸ªæ¯”ä¾‹æ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚å› ä¸ºå†…å­˜æ€§èƒ½åˆ†ææ˜¯åŸºäºé‡‡æ ·çš„ï¼Œå› æ­¤åŸºäºå†…å­˜åˆ†ææ•°æ®æ¥åˆ¤æ–­ç¨‹åºæ‰€æœ‰çš„å†…å­˜ä½¿ç”¨æƒ…å†µæ˜¯å¾ˆå›°éš¾çš„ã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:2:2","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"2.3 é˜»å¡æ€§èƒ½åˆ†æ é˜»å¡æ€§èƒ½åˆ†æ(block profiling) æ˜¯ Go ç‰¹æœ‰çš„ã€‚ é˜»å¡æ€§èƒ½åˆ†æç”¨æ¥è®°å½•ä¸€ä¸ªåç¨‹ç­‰å¾…ä¸€ä¸ªå…±äº«èµ„æºèŠ±è´¹çš„æ—¶é—´ã€‚åœ¨åˆ¤æ–­ç¨‹åºçš„å¹¶å‘ç“¶é¢ˆæ—¶ä¼šå¾ˆæœ‰ç”¨ã€‚é˜»å¡çš„åœºæ™¯åŒ…æ‹¬ï¼š åœ¨æ²¡æœ‰ç¼“å†²åŒºçš„ä¿¡é“ä¸Šå‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚ ä»ç©ºçš„ä¿¡é“ä¸Šæ¥æ”¶æ•°æ®ï¼Œæˆ–å‘é€æ•°æ®åˆ°æ»¡çš„ä¿¡é“ä¸Šã€‚ å°è¯•è·å¾—ä¸€ä¸ªå·²ç»è¢«å…¶ä»–åç¨‹é”ä½çš„æ’å®ƒé”ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“æ‰€æœ‰çš„ CPU å’Œå†…å­˜ç“¶é¢ˆè§£å†³åï¼Œæ‰ä¼šè€ƒè™‘è¿™ä¸€ç±»åˆ†æã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:2:3","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"2.4 é”æ€§èƒ½åˆ†æ é”æ€§èƒ½åˆ†æ(mutex profiling) ä¸é˜»å¡åˆ†æç±»ä¼¼ï¼Œä½†ä¸“æ³¨äºå› ä¸ºé”ç«äº‰å¯¼è‡´çš„ç­‰å¾…æˆ–å»¶æ—¶ã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:2:4","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"ä¸‰ã€CPU æ€§èƒ½åˆ†æ è®°å½•æ€§èƒ½æ•°æ®ä¼šå¯¹ç¨‹åºçš„æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œå»ºè®®ä¸€æ¬¡åªè®°å½•ä¸€ç±»æ•°æ®ã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:3:0","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"3.1 ç”Ÿæˆ profile Go çš„è¿è¡Œæ—¶æ€§èƒ½åˆ†ææ¥å£éƒ½ä½äº runtime/pprof åŒ…ä¸­ã€‚åªéœ€è¦è°ƒç”¨ runtime/pprof åº“å³å¯å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚ å‡è®¾æˆ‘ä»¬å®ç°äº†è¿™ä¹ˆä¸€ä¸ªç¨‹åºï¼Œéšæœºç”Ÿæˆäº† 5 ç»„æ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨å†’æ³¡æ’åºæ³•æ’åºã€‚ func generate(n int) []int { rand.Seed(time.Now().UnixNano()) nums := make([]int, n) for i := 0; i \u003c len(nums); i++ { nums[i] = rand.Int() % 1000 } return nums } func bubbleSort(nums []int) { for i := 0; i \u003c len(nums); i++ { for j := i + 1; j \u003c len(nums); j++ { if nums[i] \u003e nums[j] { nums[i], nums[j] = nums[j], nums[i] } } } } å¦‚æœæˆ‘ä»¬æƒ³åº¦é‡è¿™ä¸ªåº”ç”¨ç¨‹åºçš„ CPU æ€§èƒ½æ•°æ®ï¼Œåªéœ€è¦åœ¨ main å‡½æ•°ä¸­æ·»åŠ å‡ è¡Œä»£ç å³å¯ï¼š func main() { f, _ := os.OpenFile(\"cpu.pprof\", os.O_CREATE|os.O_RDWR, 0644) defer f.Close() pprof.StartCPUProfile(f) defer pprof.StopCPUProfile() n := 10 for i := 0; i \u003c 5; i++ { nums := generate(n) bubbleSort(nums) n *= 10 } } ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:3:1","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"3.2 æ•°æ®åˆ†æ go run 01-cpu.go # ç”¨ web çš„æ–¹å¼æŸ¥çœ‹ go tool pprof -http=:9999 cpu.pprof ç„¶åè®¿é—®ï¼šlocalhost/:9999 å³å¯ã€‚ # åœ¨å‘½ä»¤è¡Œä¸­æŸ¥çœ‹ go tool pprof cpu.pprof â¯ go tool pprof cpu.pprof Type: cpu Time: May 23, 2023 at 2:36pm (CST) Duration: 2.30s, Total samples = 1.33s (57.87%) Entering interactive mode (type \"help\" for commands, \"o\" for options) (pprof) top Showing nodes accounting for 1.33s, 100% of 1.33s total flat flat% sum% cum cum% 1.33s 100% 100% 1.33s 100% main.bubbleSort (inline) 0 0% 100% 1.33s 100% main.main 0 0% 100% 1.33s 100% runtime.main (pprof) å¯ä»¥çœ‹åˆ° main.bubbleSort æ˜¯æ¶ˆè€— CPU æœ€å¤šçš„å‡½æ•°ã€‚ è¿˜å¯ä»¥æŒ‰ç…§ cum (ç´¯è®¡æ¶ˆè€—)æ’åºã€‚é€šè¿‡ help æŸ¥çœ‹æ‰€æœ‰çš„å‘½ä»¤ã€‚ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:3:2","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"å››ã€å†…å­˜æ€§èƒ½åˆ†æ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:4:0","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"4.1 ç”Ÿæˆ profile å‡è®¾æˆ‘ä»¬å®ç°äº†è¿™ä¹ˆä¸€ä¸ªç¨‹åºï¼Œç”Ÿæˆé•¿åº¦ä¸º N çš„éšæœºå­—ç¬¦ä¸²ï¼Œæ‹¼æ¥åœ¨ä¸€èµ·ã€‚ ä½¿ç”¨ä¸€ä¸ªæ˜“ç”¨æ€§æ›´å¼ºçš„åº“ pkg/profile æ¥é‡‡é›†æ€§èƒ½æ•°æ®ï¼Œpkg/profile å°è£…äº† runtime/pprof çš„æ¥å£ï¼Œä½¿ç”¨èµ·æ¥æ›´ç®€å•ã€‚ package main import ( \"github.com/pkg/profile\" \"math/rand\" ) const letterBytes = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\" func randomString(n int) string { b := make([]byte, n) for i := range b { b[i] = letterBytes[rand.Intn(len(letterBytes))] } return string(b) } func concat(n int) string { s := \"\" for i := 0; i \u003c n; i++ { s += randomString(n) } return s } func main() { // ä¸å¤ªå¥½ç”¨å•Šï¼ŒWindowsä¸Šç”Ÿæˆçš„è·¯å¾„å¾ˆçƒ¦ã€‚ã€‚ã€‚å»ºè®®è¿˜æ˜¯ä¸åœ¨ Windows ä¸Šç”¨ã€‚ã€‚ã€‚ // defer profile.Start(profile.MemProfile, profile.MemProfileRate(1)).Stop() concat(100) } å‚è€ƒæ–‡ç« ï¼š Goç¨‹åºæ€§èƒ½åˆ†æ ","date":"2023-03-06","objectID":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/:4:1","tags":["Go","æ€§èƒ½åˆ†æ"],"title":"Goæµ…æ-æ€§èƒ½åˆ†æ","uri":"/go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"[toc] ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:0:0","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"ä¸€ã€æ¦‚è¿° Go ç¼–è¯‘å™¨ä¼šå°½å¯èƒ½å°†å˜é‡åˆ†é…åˆ°åˆ°æ ˆä¸Šã€‚ä½†æ˜¯ï¼Œ å½“ç¼–è¯‘å™¨æ— æ³•è¯æ˜å‡½æ•°è¿”å›åï¼Œè¯¥å˜é‡æ²¡æœ‰è¢«å¼•ç”¨ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±å¿…é¡»åœ¨å †ä¸Šåˆ†é…è¯¥å˜é‡ï¼Œä»¥æ­¤é¿å…æ‚¬æŒ‚æŒ‡é’ˆ(dangling pointer)ï¼› å¦å¤–ï¼Œå¦‚æœå±€éƒ¨å˜é‡éå¸¸å¤§ï¼Œä¹Ÿä¼šå°†å…¶åˆ†é…åœ¨å †ä¸Šã€‚ æœ‰å¦‚ä¸‹è§„åˆ™å¯ä»¥å‚è€ƒï¼š é€ƒé€¸åˆ†ææ˜¯åœ¨ç¼–è¯‘å™¨å®Œæˆçš„ï¼Œè¿™æ˜¯ä¸åŒäºjvmçš„è¿è¡Œæ—¶é€ƒé€¸åˆ†æ; å¦‚æœå˜é‡åœ¨å‡½æ•°å¤–éƒ¨æ²¡æœ‰å¼•ç”¨ï¼Œåˆ™ä¼˜å…ˆæ”¾åˆ°æ ˆä¸­ï¼› å¦‚æœå˜é‡åœ¨å‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ï¼Œåˆ™å¿…å®šæ”¾åœ¨å †ä¸­ã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:1:0","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"äºŒã€æ¡ˆä¾‹ ç»™å‡ºä¸€äº›å¸¸è§çš„å†…å­˜é€ƒé€¸æƒ…å†µã€‚ å¯é€šè¿‡go build -gcflags '-m -l'å‘½ä»¤æ¥æŸ¥çœ‹é€ƒé€¸åˆ†æç»“æœï¼Œå…¶ä¸­ï¼Œ-m æ‰“å°é€ƒé€¸åˆ†æä¿¡æ¯ï¼Œ-l ç¦æ­¢å†…è”ä¼˜åŒ–ï¼š go build -gcflags '-m -l' 01-type.go go build -gcflags '-m -m -l' 01-type.go // æ›´è¯¦ç»† ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:0","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"å˜é‡ç±»å‹ä¸ç¡®å®š // å˜é‡ç±»å‹ä¸ç¡®å®š func main() { a := 123 fmt.Println(a) } åˆ†æç»“æœï¼š â¯ go build -gcflags '-m -l' 01-type.go # command-line-arguments .\\01-type.go:11:13: ... argument does not escape .\\01-type.go:11:13: a escapes to heap â¯ go build -gcflags '-m -m -l' 01-type.go # command-line-arguments .\\01-type.go:11:13: a escapes to heap: .\\01-type.go:11:13: flow: {storage for ... argument} = \u0026{storage for a}: .\\01-type.go:11:13: from a (spill) at .\\01-type.go:11:13 .\\01-type.go:11:13: from ... argument (slice-literal-element) at .\\01-type.go:11:13 .\\01-type.go:11:13: flow: {heap} = {storage for ... argument}: .\\01-type.go:11:13: from ... argument (spill) at .\\01-type.go:11:13 .\\01-type.go:11:13: from fmt.Println(... argument...) (call parameter) at .\\01-type.go:11:13 .\\01-type.go:11:13: ... argument does not escape .\\01-type.go:11:13: a escapes to heap åˆ†æç»“æœå‘Šè¯‰æˆ‘ä»¬å˜é‡aé€ƒé€¸åˆ°äº†å †ä¸Šï¼Œaé€ƒé€¸æ˜¯å› ä¸ºå®ƒè¢«ä¼ å…¥äº†fmt.Printlnçš„å‚æ•°ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å‚æ•°è‡ªå·±å‘ç”Ÿäº†é€ƒé€¸ã€‚ func Println(a ...any) (n int, err error) å› ä¸ºfmt.Printlnçš„å‡½æ•°å‚æ•°ä¸ºinterfaceç±»å‹ï¼Œç¼–è¯‘æœŸä¸èƒ½ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œä¹Ÿå°±ä¸ç¡®å®šå¼€è¾Ÿå¤šå¤§çš„ç©ºé—´ç»™å®ƒï¼Œæ‰€ä»¥å°†å…¶åˆ†é…äºå †ä¸Šã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:1","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"æš´éœ²ç»™å¤–éƒ¨æŒ‡é’ˆ func foo() *int { a := 123 return \u0026a } func main() { _ = foo() } åˆ†æç»“æœï¼š â¯ go build -gcflags '-m -l' 02-expose.go # command-line-arguments .\\02-expose.go:4:2: moved to heap: a â¯ go build -gcflags '-m -m -l' 02-expose.go # command-line-arguments .\\02-expose.go:4:2: a escapes to heap: .\\02-expose.go:4:2: flow: ~r0 = \u0026a: .\\02-expose.go:4:2: from \u0026a (address-of) at .\\02-expose.go:5:9 .\\02-expose.go:4:2: from return \u0026a (return) at .\\02-expose.go:5:2 .\\02-expose.go:4:2: moved to heap: a ç›´æ¥æ»¡è¶³ï¼šå˜é‡åœ¨å‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ã€‚è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå¯¹åº”çš„æ ˆå¸§å°±è¢«é”€æ¯ï¼Œä½†æ˜¯å¼•ç”¨å·²ç»è¢«è¿”å›åˆ°å‡½æ•°ä¹‹å¤–ã€‚å¦‚æœè¿™æ—¶å¤–éƒ¨ä»å¼•ç”¨åœ°å€å–å€¼ï¼Œè™½ç„¶åœ°å€è¿˜åœ¨ï¼Œä½†æ˜¯è¿™å—å†…å­˜å·²ç»è¢«é‡Šæ”¾å›æ”¶äº†ï¼Œè¿™å°±æ˜¯éæ³•å†…å­˜ï¼Œé—®é¢˜å¯å°±å¤§äº†ã€‚æ‰€ä»¥ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™ç§æƒ…å†µå¿…é¡»åˆ†é…åˆ°å †ä¸Šã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:2","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"å˜é‡æ‰€å å†…å­˜è¾ƒå¤§ // []int å¤ªå¤§, å¯¼è‡´é€ƒé€¸ func foo() { s := make([]int, 8193, 8193) // \u003e 8192 å°±æ˜¯å¤§å¯¹è±¡äº† for i := 0; i \u003c len(s); i++ { s[i] = i } } // å¤–éƒ¨å¼•ç”¨, å¯¼è‡´é€ƒé€¸ //func foo() []int { // s := make([]int, 100, 100) // for i := 0; i \u003c len(s); i++ { // s[i] = i // } // return s //} func main() { foo() } åˆ†æç»“æœï¼š â¯ go build -gcflags '-m -l' 03-big.go # command-line-arguments .\\03-big.go:5:11: make([]int, 10000, 10000) escapes to heap â¯ go build -gcflags '-m -m -l' 03-big.go # command-line-arguments .\\03-big.go:5:11: make([]int, 10000, 10000) escapes to heap: .\\03-big.go:5:11: flow: {heap} = \u0026{storage for make([]int, 10000, 10000)}: .\\03-big.go:5:11: from make([]int, 10000, 10000) (too large for stack) at .\\03-big.go:5:11 .\\03-big.go:5:11: make([]int, 10000, 10000) escapes to heap é€ƒé€¸ä¿¡æ¯ï¼štoo large for stackã€‚å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®¹é‡ä¸º8193çš„intç±»å‹çš„åº•å±‚æ•°ç»„å¯¹è±¡æ—¶ï¼Œç”±äºå¯¹è±¡è¿‡å¤§ï¼Œå®ƒä¹Ÿä¼šè¢«åˆ†é…åˆ°å †ä¸Šã€‚ é‚£ä¸ºå•¥å¤§å¯¹è±¡éœ€è¦åˆ†é…åˆ°å †ä¸Šï¼Ÿ goroutine åˆå§‹å¤§å°ä¸º2KBï¼Œå…¶å®è¯´çš„æ˜¯ç”¨æˆ·æ ˆï¼Œå®ƒçš„æœ€å°å’Œæœ€å¤§å¯ä»¥åœ¨runtime/stack.goä¸­æ‰¾åˆ°ï¼Œåˆ†åˆ«æ˜¯2KBå’Œ1GBï¼Œè€Œå †å†…å­˜ä¼šå¤§å¾ˆå¤šã€‚å› æ­¤ï¼Œä¸ºäº†ä¸é€ æˆæ ˆæº¢å‡ºå’Œé¢‘ç¹çš„æ‰©ç¼©å®¹ï¼Œå¤§å¯¹è±¡åˆ†é…åœ¨å †ä¸Šæ›´åŠ åˆç†(å¤§å¯¹è±¡çš„èŒƒå›´ï¼š\u003e 32KB)ï¼Œæ‰€ä»¥s :=make([]int, n, n)ä¸­ï¼Œä¸€æ—¦n \u003e 8192ï¼Œå°±ä¸€å®šä¼šé€ƒé€¸ã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:3","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"å˜é‡å¤§å°ä¸ç¡®å®š func foo() { n := 1 s := make([]int, n) for i := 0; i \u003c len(s); i++ { s[i] = i } } func main() { foo() } åˆ†æç»“æœï¼š â¯ go build -gcflags '-m -l' 04-uncertain.go # command-line-arguments .\\04-uncertain.go:5:11: make([]int, n) escapes to heap â¯ go build -gcflags '-m -m -l' 04-uncertain.go # command-line-arguments .\\04-uncertain.go:5:11: make([]int, n) escapes to heap: .\\04-uncertain.go:5:11: flow: {heap} = \u0026{storage for make([]int, n)}: .\\04-uncertain.go:5:11: from make([]int, n) (non-constant size) at .\\04-uncertain.go:5:11 .\\04-uncertain.go:5:11: make([]int, n) escapes to heap é€ƒé€¸ä¿¡æ¯ï¼šnon-constant sizeã€‚åœ¨makeæ–¹æ³•ä¸­ï¼Œæ²¡æœ‰ç›´æ¥æŒ‡å®šå¤§å°ï¼Œè€Œæ˜¯å¡«å…¥äº†å˜é‡nï¼Œè¿™æ—¶ä¹Ÿä¼šå°†å…¶åˆ†é…åˆ°å †åŒºå»ã€‚ å¯è§ï¼Œä¸ºäº†ä¿è¯å†…å­˜çš„ç»å¯¹å®‰å…¨ï¼ŒGoçš„ç¼–è¯‘å™¨å¯èƒ½ä¼šå°†ä¸€äº›å˜é‡ä¸åˆæ—¶å®œåœ°åˆ†é…åˆ°å †ä¸Šï¼Œä½†æ˜¯å› ä¸ºè¿™äº›å¯¹è±¡æœ€ç»ˆä¹Ÿä¼šè¢«åƒåœ¾æ”¶é›†å™¨å¤„ç†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ¥å—ã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:4","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"é—­åŒ… func foo() func() int { i := 0 return func() int { i++ return i } } func main() { foo()() } åˆ†æç»“æœï¼š â¯ go build -gcflags '-m -l' 05-close.go # command-line-arguments .\\05-close.go:4:2: moved to heap: i .\\05-close.go:5:9: func literal escapes to heap â¯ go build -gcflags '-m -m -l' 05-close.go # command-line-arguments .\\05-close.go:4:2: foo capturing by ref: i (addr=false assign=true width=8) .\\05-close.go:5:9: func literal escapes to heap: .\\05-close.go:5:9: flow: ~r0 = \u0026{storage for func literal}: .\\05-close.go:5:9: from func literal (spill) at .\\05-close.go:5:9 .\\05-close.go:5:9: from return func literal (return) at .\\05-close.go:5:2 .\\05-close.go:4:2: i escapes to heap: .\\05-close.go:4:2: flow: {storage for func literal} = \u0026i: .\\05-close.go:4:2: from i (captured by a closure) at .\\05-close.go:6:3 .\\05-close.go:4:2: from i (reference) at .\\05-close.go:6:3 .\\05-close.go:4:2: moved to heap: i .\\05-close.go:5:9: func literal escapes to heap åŸæœ¬åœ¨å‡½æ•°è¿è¡Œæ ˆç©ºé—´ä¸Šåˆ†é…çš„å†…å­˜ï¼Œç”±äºé—­åŒ…çš„å…³ç³»ï¼Œå˜é‡åœ¨å‡½æ•°çš„ä½œç”¨åŸŸä¹‹å¤–ä½¿ç”¨ã€‚ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:2:5","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"ä¸‰ã€æ€»ç»“ é—®ï¼šè¿›è¡Œé€ƒé€¸åˆ†ææœ‰å•¥ç”¨ï¼Ÿ ç†è§£é€ƒé€¸åˆ†æä¸€å®šèƒ½å¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´å¥½çš„ç¨‹åºã€‚ çŸ¥é“å˜é‡åˆ†é…åœ¨æ ˆå †ä¹‹ä¸Šçš„å·®åˆ«ï¼Œé‚£ä¹ˆå°±è¦å°½é‡å†™å‡ºåˆ†é…åœ¨æ ˆä¸Šçš„ä»£ç ï¼Œå †ä¸Šçš„å˜é‡å˜å°‘äº†ï¼Œå¯ä»¥å‡è½»å†…å­˜åˆ†é…çš„å¼€é”€ï¼Œå‡å°gcçš„å‹åŠ›ï¼Œæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ã€‚ æ‰€ä»¥ï¼Œæœ‰äº›Goçš„é¡¹ç›®ï¼Œå®ƒä»¬åœ¨å‡½æ•°ä¼ å‚çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥ä¼ é€’çš„ç»“æ„ä½“ã€‚è¿™ä¸ªåšæ³•ï¼Œè™½ç„¶å®ƒéœ€è¦å€¼æ‹·è´ï¼Œä½†è¿™æ˜¯åœ¨æ ˆä¸Šå®Œæˆçš„æ“ä½œï¼Œå¼€é”€è¿œæ¯”å˜é‡é€ƒé€¸ååŠ¨æ€åœ°åœ¨å †ä¸Šåˆ†é…å†…å­˜å°‘çš„å¤šã€‚å½“ç„¶è¯¥åšæ³•ä¸æ˜¯ç»å¯¹çš„ï¼Œå¦‚æœç»“æ„ä½“è¾ƒå¤§ï¼Œä¼ é€’æŒ‡é’ˆå°†æ›´åˆé€‚ã€‚ å› æ­¤ï¼Œä»GCçš„è§’åº¦æ¥çœ‹ï¼ŒæŒ‡é’ˆä¼ é€’æ˜¯ä¸ªåŒåˆƒå‰‘ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨ï¼Œå¦åˆ™çº¿ä¸Šè°ƒä¼˜è§£å†³GCå»¶æ—¶å¯èƒ½ä¼šè®©ä½ å´©æºƒã€‚ å‚è€ƒæ–‡ç« ï¼š è¯¦è§£é€ƒé€¸åˆ†æ ","date":"2023-03-05","objectID":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/:3:0","tags":["Go","å†…å­˜é€ƒé€¸"],"title":"Goæµ…æ-å†…å­˜é€ƒé€¸","uri":"/go%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"},{"categories":["Go"],"content":"ä½¿ç”¨æ–¹æ³•åå­—ç¬¦ä¸²ï¼Œè°ƒç”¨æ–¹æ³• æ€è·¯ï¼šé€šè¿‡ reflectã€‚ type animal struct { name string } func (a *animal) Eat() { println(\"animal eat\") } func main() { a := animal{\"cat\"} reflect.ValueOf(\u0026a).MethodByName(\"Eat\").Call([]reflect.Value{}) } ","date":"2023-02-25","objectID":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/:1:0","tags":["Go","åŸºç¡€ç¼–ç¨‹"],"title":"Goæµ…æ-å¸¸è§ç¼–ç¨‹æ“ä½œ","uri":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"3ä¸ª goroutine æŒ‰ç…§é¡ºåºåˆ†åˆ«æ‰“å°10æ¬¡\"cat\"ï¼Œâ€œfishâ€ï¼Œâ€œdog æ€è·¯ï¼šè‹¥é™åˆ¶åªç”¨ 3 ä¸ª goroutineï¼Œå¦‚ä¸‹ var ( catChan = make(chan int) fishChan = make(chan int) dogChan = make(chan int) allChan = make(chan struct{}) ) func cat(ch chan int) { for v := range ch { fmt.Printf(\"%v cat\\n\", v) fishChan \u003c- v if v == 10 { break } } } func fish(ch chan int) { for v := range ch { fmt.Printf(\"%v fish\\n\", v) dogChan \u003c- v if v == 10 { break } } } func dog(ch chan int) { for v := range ch { fmt.Printf(\"%v dog\\n\", v) if v == 10 { allChan \u003c- struct{}{} break } catChan \u003c- v + 1 } } func main() { go cat(catChan) go fish(fishChan) go dog(dogChan) catChan \u003c- 1 \u003c-allChan } æ€è·¯ï¼šè‹¥ä¸é™åˆ¶ goroutine æ•°ç›® var ( catChan = make(chan int) fishChan = make(chan int) dogChan = make(chan int) allChan = make(chan struct{}) ) func cat() { v := \u003c-catChan fmt.Printf(\"%v cat\\n\", v) fishChan \u003c- v } func fish() { v := \u003c-fishChan fmt.Printf(\"%v fish\\n\", v) dogChan \u003c- v } func dog() { v := \u003c-dogChan fmt.Printf(\"%v dog\\n\", v) if v == 10 { allChan \u003c- struct{}{} return } catChan \u003c- v + 1 // æ³¨æ„æ˜¯æ— ç¼“å†²çš„ chanï¼Œè‹¥æ”¾åˆ° if å‰ï¼Œå°±ä¼šæ­»é”ï¼ } func main() { for i := 0; i \u003c 10; i++ { go cat() go fish() go dog() } catChan \u003c- 1 \u003c-allChan } ","date":"2023-02-25","objectID":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/:2:0","tags":["Go","åŸºç¡€ç¼–ç¨‹"],"title":"Goæµ…æ-å¸¸è§ç¼–ç¨‹æ“ä½œ","uri":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"å¯åŠ¨ 2 ä¸ª goroutine 2 ç§’åå–æ¶ˆï¼Œç¬¬ä¸€ä¸ª 1 ç§’æ‰§è¡Œå®Œï¼Œç¬¬äºŒä¸ª 3 ç§’æ‰§è¡Œå®Œ func f1(ch chan struct{}) { time.Sleep(time.Second * 1) ch \u003c- struct{}{} } func f2(ch chan struct{}) { time.Sleep(time.Second * 3) ch \u003c- struct{}{} } func main() { ctx, _ := context.WithTimeout(context.Background(), time.Second*2) ch := make(chan struct{}, 1) go func() { go f1(ch) select { case \u003c-ctx.Done(): println(\"f1 timeout\") case \u003c-ch: println(\"f1 done\") } }() go func() { go f2(ch) select { case \u003c-ctx.Done(): println(\"f2 timeout\") case \u003c-ch: println(\"f2 done\") } }() time.Sleep(time.Second * 5) } ","date":"2023-02-25","objectID":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/:3:0","tags":["Go","åŸºç¡€ç¼–ç¨‹"],"title":"Goæµ…æ-å¸¸è§ç¼–ç¨‹æ“ä½œ","uri":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"2 ä¸ª goroutine äº¤æ›¿æ‰“å° 10 ä¸ªå­—æ¯å’Œæ•°å­— var ( ch1 = make(chan byte) ch2 = make(chan int) ) func letter() { for i := 0; i \u003c 10; i++ { v := \u003c-ch1 fmt.Println(string(v)) ch2 \u003c- int(v - 'a' + 1) } } func number() { for i := 0; i \u003c 10; i++ { v := \u003c-ch2 fmt.Println(v) if v == 10 { return } ch1 \u003c- byte(v + 'a') } } func main() { go letter() go number() ch1 \u003c- 'a' time.Sleep(time.Second * 2) } ","date":"2023-02-25","objectID":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/:4:0","tags":["Go","åŸºç¡€ç¼–ç¨‹"],"title":"Goæµ…æ-å¸¸è§ç¼–ç¨‹æ“ä½œ","uri":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"å½“ select ç›‘æ§å¤šä¸ª chan åŒæ—¶åˆ°è¾¾å°±ç»ªæ€æ—¶ï¼Œå¦‚ä½•å…ˆæ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Ÿ å¯é€šè¿‡æ·»åŠ æ ‡ç­¾ func prioritySelect(ch1, ch2 \u003c-chan string) { for { select { case val := \u003c-ch1: fmt.Println(val) case val2 := \u003c-ch2: priority: // æ ‡ç­¾ for { select { // è‹¥ ch1 æœ‰å€¼ï¼Œå…ˆæ‰“å° ch1 çš„å€¼ï¼Œå†æ‰“å° ch2 çš„å€¼ case val1 := \u003c-ch1: fmt.Println(val1) default: break priority } } fmt.Println(val2) } } } ","date":"2023-02-25","objectID":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/:5:0","tags":["Go","åŸºç¡€ç¼–ç¨‹"],"title":"Goæµ…æ-å¸¸è§ç¼–ç¨‹æ“ä½œ","uri":"/go%E5%B8%B8%E8%A7%81%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"[toc] å‚è€ƒæ–‡ç« ï¼š Goè¯­è¨€è®¾è®¡ä¸å®ç° æ·±å…¥äº†è§£ Go è¯­è¨€ä¸å¹¶å‘ç¼–ç¨‹ ä» bug ä¸­å­¦ä¹ ï¼šå…­å¤§å¼€æºé¡¹ç›®å‘Šè¯‰ä½  go å¹¶å‘ç¼–ç¨‹çš„é‚£äº›å‘ ","date":"2023-02-22","objectID":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/:0:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥","GMP"],"title":"Goæµ…æ-GMP","uri":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"ä¸€ã€Go å¹¶å‘æœºåˆ¶ Go çš„è°ƒåº¦å™¨ä½¿ç”¨ Gã€Mã€P ä¸‰ä¸ªç»“æ„ä½“æ¥å®ç° Goroutine çš„è°ƒåº¦ï¼Œä¹Ÿç§°ä¹‹ä¸º GMP æ¨¡å‹ã€‚ ","date":"2023-02-22","objectID":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/:1:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥","GMP"],"title":"Goæµ…æ-GMP","uri":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"GMP æ¨¡å‹ Gï¼šè¡¨ç¤º Goroutineã€‚æ¯ä¸ª Goroutine å¯¹åº”ä¸€ä¸ª G ç»“æ„ä½“ï¼ŒG å­˜å‚¨ Goroutine çš„è¿è¡Œå †æ ˆã€çŠ¶æ€ä»¥åŠä»»åŠ¡å‡½æ•°ï¼Œå¯é‡ç”¨ã€‚å½“ Goroutine è¢«è°ƒç¦» CPU æ—¶ï¼Œè°ƒåº¦å™¨ä»£ç è´Ÿè´£æŠŠ CPU å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨ G å¯¹è±¡çš„æˆå‘˜å˜é‡ä¹‹ä¸­ï¼Œå½“ Goroutine è¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ï¼Œè°ƒåº¦å™¨ä»£ç åˆè´Ÿè´£æŠŠ G å¯¹è±¡çš„æˆå‘˜å˜é‡æ‰€ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ° CPU çš„å¯„å­˜å™¨ï¼› Mï¼šOS åº•å±‚çº¿ç¨‹çš„æŠ½è±¡ï¼Œå®ƒæœ¬èº«å°±ä¸ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ª M ç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»£è¡¨ç€çœŸæ­£æ‰§è¡Œè®¡ç®—çš„èµ„æºï¼Œç”±æ“ä½œç³»ç»Ÿçš„è°ƒåº¦å™¨è°ƒåº¦å’Œç®¡ç†ã€‚M ç»“æ„ä½“å¯¹è±¡é™¤äº†è®°å½•ç€å·¥ä½œçº¿ç¨‹çš„è¯¸å¦‚æ ˆçš„èµ·æ­¢ä½ç½®ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„ Goroutine ä»¥åŠæ˜¯å¦ç©ºé—²ç­‰ç­‰çŠ¶æ€ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜é€šè¿‡æŒ‡é’ˆç»´æŒç€ä¸ P ç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼› Pï¼šè¡¨ç¤ºé€»è¾‘å¤„ç†å™¨ã€‚å¯¹ G æ¥è¯´ï¼ŒP ç›¸å½“äº CPU æ ¸ï¼ŒG åªæœ‰ç»‘å®šåˆ° P(åœ¨ P çš„ local runq ä¸­)æ‰èƒ½è¢«è°ƒåº¦ã€‚å¯¹ M æ¥è¯´ï¼ŒP æä¾›äº†ç›¸å…³çš„æ‰§è¡Œç¯å¢ƒ(Context)ï¼Œå¦‚å†…å­˜åˆ†é…çŠ¶æ€(mcache)ï¼Œä»»åŠ¡é˜Ÿåˆ—(G)ç­‰ã€‚å®ƒç»´æŠ¤ä¸€ä¸ªå±€éƒ¨ Goroutine å¯è¿è¡Œ G é˜Ÿåˆ—ï¼Œå·¥ä½œçº¿ç¨‹ä¼˜å…ˆä½¿ç”¨è‡ªå·±çš„å±€éƒ¨è¿è¡Œé˜Ÿåˆ—ï¼Œåªæœ‰å¿…è¦æ—¶æ‰ä¼šå»è®¿é—®å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œè¿™å¯ä»¥å¤§å¤§å‡å°‘é”å†²çªï¼Œæé«˜å·¥ä½œçº¿ç¨‹çš„å¹¶å‘æ€§ï¼Œå¹¶ä¸”å¯ä»¥è‰¯å¥½çš„è¿ç”¨ç¨‹åºçš„å±€éƒ¨æ€§åŸç†ã€‚ ä¸€ä¸ª G çš„æ‰§è¡Œéœ€è¦ P å’Œ M çš„æ”¯æŒã€‚ä¸€ä¸ª M åœ¨ä¸ä¸€ä¸ª P å…³è”ä¹‹åï¼Œå°±å½¢æˆäº†ä¸€ä¸ªæœ‰æ•ˆçš„ G è¿è¡Œç¯å¢ƒï¼ˆå†…æ ¸çº¿ç¨‹+ä¸Šä¸‹æ–‡ï¼‰ã€‚æ¯ä¸ª P éƒ½åŒ…å«ä¸€ä¸ªå¯è¿è¡Œçš„ G çš„é˜Ÿåˆ—ï¼ˆrunqï¼‰ã€‚è¯¥é˜Ÿåˆ—ä¸­çš„ G ä¼šè¢«ä¾æ¬¡ä¼ é€’ç»™ä¸æœ¬åœ° P å…³è”çš„ Mï¼Œå¹¶è·å¾—è¿è¡Œæ—¶æœºã€‚ M ä¸ KSE ä¹‹é—´æ€»æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œä¸€ä¸ª M ä»…èƒ½ä»£è¡¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚M ä¸ KSE ä¹‹é—´çš„å…³è”éå¸¸ç¨³å›ºï¼Œä¸€ä¸ª M åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ï¼Œä¼šä¸”ä»…ä¼šä¸ä¸€ä¸ª KSE äº§ç”Ÿå…³è”ï¼Œè€Œ M ä¸ Pã€P ä¸ G ä¹‹é—´çš„å…³è”éƒ½æ˜¯å¯å˜çš„ï¼ŒM ä¸ P ä¹Ÿæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼ŒP ä¸ G åˆ™æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚ G è¿è¡Œæ—¶ï¼ŒG åœ¨è°ƒåº¦å™¨ä¸­çš„åœ°ä½ä¸çº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­å·®ä¸å¤šï¼Œä½†æ˜¯å®ƒå ç”¨äº†æ›´å°çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿé™ä½äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚å®ƒæ˜¯ Go è¯­è¨€åœ¨ç”¨æˆ·æ€æä¾›çš„çº¿ç¨‹ï¼Œä½œä¸ºä¸€ç§ç²’åº¦æ›´ç»†çš„èµ„æºè°ƒåº¦å•å…ƒã€‚ g ç»“æ„ä½“éƒ¨åˆ†æºç (src/runtime/runtime2.go)ï¼š type g struct { stack stack // Goroutineçš„æ ˆå†…å­˜èŒƒå›´[stack.lo, stack.hi) stackguard0 uintptr // ç”¨äºè°ƒåº¦å™¨æŠ¢å å¼è°ƒåº¦ m *m // Goroutineå ç”¨çš„çº¿ç¨‹ sched gobuf // Goroutineçš„è°ƒåº¦ç›¸å…³æ•°æ® atomicstatus uint32 // Goroutineçš„çŠ¶æ€ ... } type gobuf struct { sp uintptr // æ ˆæŒ‡é’ˆ pc uintptr // ç¨‹åºè®¡æ•°å™¨ g guintptr // gobufå¯¹åº”çš„Goroutine ret sys.Uintewg // ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ ... } gobuf ä¸­ä¿å­˜çš„å†…å®¹ä¼šåœ¨è°ƒåº¦å™¨ä¿å­˜æˆ–æ¢å¤ä¸Šä¸‹æ–‡æ—¶ä½¿ç”¨ï¼Œå…¶ä¸­æ ˆæŒ‡é’ˆå’Œç¨‹åºè®¡æ•°å™¨ä¼šç”¨æ¥å­˜å‚¨æˆ–æ¢å¤å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œæ”¹å˜ç¨‹åºå³å°†æ‰§è¡Œçš„ä»£ç ã€‚ atomicstatus å­—æ®µå­˜å‚¨äº†å½“å‰ Goroutine çš„çŠ¶æ€ï¼ŒGoroutine ä¸»è¦å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š ç­‰å¾…ä¸­ï¼šGoroutine æ­£åœ¨ç­‰å¾…æŸäº›æ¡ä»¶æ»¡è¶³ï¼Œä¾‹å¦‚ï¼šç³»ç»Ÿè°ƒç”¨ç»“æŸç­‰ï¼ŒåŒ…æ‹¬_Gwaitingã€_Gsyscall å’Œ_Gpreempted å‡ ä¸ªçŠ¶æ€ å¯è¿è¡Œï¼šGoroutine å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥åœ¨çº¿ç¨‹è¿è¡Œï¼Œå¦‚æœå½“å‰ç¨‹åºä¸­æœ‰éå¸¸å¤šçš„ Goroutineï¼Œæ¯ä¸ª Goroutine å°±å¯èƒ½ä¼šç­‰å¾…æ›´å¤šçš„æ—¶é—´ï¼Œå³_Grunnable è¿è¡Œä¸­ï¼šGoroutine æ­£åœ¨æŸä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œå³_Grunning G å¸¸è§çŠ¶æ€è½¬æ¢å›¾ï¼š M Go è¯­è¨€å¹¶å‘æ¨¡å‹ä¸­çš„ M æ˜¯æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚è°ƒåº¦å™¨æœ€å¤šå¯ä»¥åˆ›å»º 10000 ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯æœ€å¤šåªä¼šæœ‰ GOMAXPROCS(P çš„æ•°é‡)ä¸ªæ´»è·ƒçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¼šå°† GOMAXPROCS è®¾ç½®æˆå½“å‰æœºå™¨çš„æ ¸æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨ runtime.GOMAXPROCS æ¥æ”¹å˜æœ€å¤§çš„æ´»è·ƒçº¿ç¨‹æ•°ã€‚ m ç»“æ„ä½“æºç (éƒ¨åˆ†)ï¼š type m struct { g0 *g // ä¸€ä¸ªç‰¹æ®Šçš„goroutineï¼Œæ‰§è¡Œä¸€äº›è¿è¡Œæ—¶ä»»åŠ¡ gsignal *g // å¤„ç†signalçš„G curg *g // å½“å‰Mæ­£åœ¨è¿è¡Œçš„Gçš„æŒ‡é’ˆ p puintptr // æ­£åœ¨ä¸å½“å‰Må…³è”çš„P nextp puintptr // ä¸å½“å‰Mæ½œåœ¨å…³è”çš„P oldp puintptr // æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹å‰ä½¿ç”¨çº¿ç¨‹çš„P spinning bool // å½“å‰Mæ˜¯å¦æ­£åœ¨å¯»æ‰¾å¯è¿è¡Œçš„G lockedg *g // ä¸å½“å‰Mé”å®šçš„G } P è°ƒåº¦å™¨ä¸­çš„å¤„ç†å™¨ P æ˜¯çº¿ç¨‹å’Œ Goroutine çš„ä¸­é—´å±‚ï¼Œå®ƒèƒ½æä¾›çº¿ç¨‹éœ€è¦çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿä¼šè´Ÿè´£è°ƒåº¦çº¿ç¨‹ä¸Šçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡å¤„ç†å™¨ P çš„è°ƒåº¦ï¼Œæ¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹éƒ½èƒ½å¤Ÿæ‰§è¡Œå¤šä¸ª Goroutineï¼Œå®ƒèƒ½åœ¨ Goroutine è¿›è¡Œä¸€äº› I/O æ“ä½œæ—¶åŠæ—¶è®©å‡ºè®¡ç®—èµ„æºï¼Œæé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚ P çš„æ•°é‡ç­‰äº GOMAXPROCSï¼Œè®¾ç½® GOMAXPROCS çš„å€¼åªèƒ½é™åˆ¶ P çš„æœ€å¤§æ•°é‡ï¼Œå¯¹ M å’Œ G çš„æ•°é‡æ²¡æœ‰ä»»ä½•çº¦æŸã€‚å½“ M ä¸Šè¿è¡Œçš„ G è¿›å…¥ç³»ç»Ÿè°ƒç”¨å¯¼è‡´ M è¢«é˜»å¡æ—¶ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæŠŠè¯¥ M å’Œä¸ä¹‹å…³è”çš„ P åˆ†ç¦»å¼€æ¥ï¼Œè¿™æ—¶ï¼Œå¦‚æœè¯¥ P çš„å¯è¿è¡Œ G é˜Ÿåˆ—ä¸Šè¿˜æœ‰æœªè¢«è¿è¡Œçš„ Gï¼Œé‚£ä¹ˆè¿è¡Œæ—¶ç³»ç»Ÿå°±ä¼šæ‰¾ä¸€ä¸ªç©ºé—²çš„ Mï¼Œæˆ–è€…æ–°å»ºä¸€ä¸ª M ä¸è¯¥ P å…³è”ï¼Œæ»¡è¶³è¿™äº› G çš„è¿è¡Œéœ€è¦ã€‚å› æ­¤ï¼ŒM çš„æ•°é‡å¾ˆå¤šæ—¶å€™éƒ½ä¼šæ¯” P å¤šã€‚ p ç»“æ„ä½“æºç ï¼ˆéƒ¨åˆ†ï¼‰ï¼š type p struct { status uint32 // p çš„çŠ¶æ€ m muintptr // å¯¹åº”å…³è”çš„ M runqhead uint32 // å¯è¿è¡Œçš„Goroutineé˜Ÿåˆ—ï¼Œå¯æ— é”è®¿é—® runqtail uint32 runq [256]guintptr runnext guintptr // ç¼“å­˜å¯ç«‹å³æ‰§è¡Œçš„G gFree struct { // å¯ç”¨çš„Gåˆ—è¡¨ï¼ŒGçŠ¶æ€ç­‰äºGdead gList n int32 } ... } P å¯èƒ½å¤„äºçš„çŠ¶æ€å¦‚ä¸‹ï¼š è°ƒåº¦å™¨ è°ƒåº¦çš„ä¸»è¦å¯¹è±¡å°±æ˜¯ Gã€M å’Œ P çš„å®ä¾‹ã€‚æ¯ä¸ª M(å³æ¯ä¸ªå†…æ ¸çº¿ç¨‹)åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šæ‰§è¡Œä¸€äº›è°ƒåº¦ä»»åŠ¡ï¼Œä»–ä»¬å…±åŒå®ç°äº† Go è°ƒåº¦å™¨çš„è°ƒåº¦åŠŸèƒ½ã€‚ g0 å’Œ m0 è¿è¡Œæ—¶ç³»ç»Ÿä¸­çš„æ¯ä¸ª M éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ Gï¼Œä¸€èˆ¬ç§°ä¸º M çš„ g0ã€‚M çš„ g0 ä¸æ˜¯ç”± Go ç¨‹åºä¸­çš„ä»£ç é—´æ¥ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”± Go è¿è¡Œæ—¶ç³»ç»Ÿåœ¨åˆå§‹åŒ– M æ—¶åˆ›å»ºå¹¶åˆ†é…ç»™è¯¥ M çš„ã€‚M çš„ g0 ä¸€èˆ¬ç”¨äºæ‰§è¡Œè°ƒåº¦ã€åƒåœ¾å›æ”¶ã€æ ˆç®¡ç†ç­‰æ–¹é¢çš„ä»»åŠ¡ã€‚M è¿˜ä¼šæ‹¥æœ‰ä¸€ä¸ªä¸“ç”¨äºå¤„ç†ä¿¡å·çš„ Gï¼Œç§°ä¸º gsignalã€‚ é™¤äº† g0 å’Œ gsignal ä¹‹å¤–ï¼Œå…¶ä»–ç”± M è¿è¡Œçš„ G éƒ½å¯ä»¥è§†ä¸ºç”¨æˆ·çº§åˆ«çš„ Gï¼Œç®€ç§°ç”¨æˆ· Gï¼Œg0 å’Œ gsignal å¯ç§°ä¸ºç³»ç»Ÿ Gã€‚Go è¿è¡Œæ—¶ç³»ç»Ÿä¼šè¿›è¡Œåˆ‡æ¢ï¼Œä»¥ä½¿æ¯ä¸ª M éƒ½å¯ä»¥äº¤æ›¿è¿è¡Œç”¨æˆ· G å’Œå®ƒçš„ g0ã€‚è¿™å°±æ˜¯å‰é¢æ‰€è¯´çš„â€œæ¯ä¸ª M éƒ½ä¼šè¿è¡Œè°ƒåº¦ç¨‹åºâ€çš„åŸå› ã€‚ é™¤äº†æ¯ä¸ª M éƒ½æ‹¥æœ‰å±äºå®ƒè‡ªå·±çš„ g0 å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª runtime.g0ã€‚runtime.g0 ç”¨äºæ‰§è¡Œå¼•å¯¼ç¨‹åºï¼Œå®ƒè¿è¡Œåœ¨ Go ç¨‹åºæ‹¥æœ‰çš„ç¬¬ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¹‹ä¸­ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿç§°ä¸º runtime.m0ï¼Œruntime.m0 çš„ g0 å°±æ˜¯ runtime.g0ã€‚ æ ¸å¿ƒå…ƒç´ çš„å®¹å™¨ ä¸Šé¢è®²äº† Go çš„çº¿ç¨‹å®ç°æ¨¡å‹ä¸­çš„ 3 ä¸ªæ ¸å¿ƒå…ƒç´ â€”â€”Gã€M å’Œ Pï¼Œä¸‹é¢çœ‹çœ‹æ‰¿è½½è¿™äº›å…ƒç´ å®ä¾‹çš„å®¹å™¨ï¼š è°ƒåº¦å¾ªç¯ è°ƒç”¨ runtime.schedule è¿›å…¥è°ƒåº¦å¾ªç¯ï¼š ä¸ºäº†ä¿è¯å…¬å¹³ï¼Œå½“å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æœ‰å¾…æ‰§è¡Œçš„ Goroutine æ—¶ï¼Œé€šè¿‡ schedtick ä¿è¯æœ‰ä¸€å®šå‡ ç‡ä¼šä»å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¯¹åº”çš„ Goroutineï¼› ä»å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ Goroutineï¼› å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰æ‰¾åˆ° Goroutineï¼Œä¼šé€šè¿‡ runtime.findrunnable è¿›è¡Œé˜»å¡åœ°æŸ¥æ‰¾ Goroutineï¼› runtime.findrunnable çš„å®ç°éå¸¸å¤æ‚ï¼Œè¿™ä¸ª 300 å¤šè¡Œçš„å‡½æ•°é€šè¿‡ä»¥ä¸‹çš„è¿‡ç¨‹è·å–å¯è¿è¡Œçš„ Goroutineï¼š ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾ï¼› ä»ç½‘ç»œè½®è¯¢å™¨ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ Goroutine ç­‰å¾…è¿è¡Œï¼› é€šè¿‡ runtime.runqsteal å°è¯•ä»å…¶ä»–éšæœºçš„å¤„ç†å™¨ä¸­çªƒå–å¾…è¿è¡Œçš„ Goroutineï¼Œè¯¥å‡½æ•°è¿˜å¯èƒ½çªƒå–å¤„ç†å™¨çš„è®¡æ—¶å™¨ï¼› å› ä¸ºå‡½æ•°çš„å®ç°è¿‡äºå¤æ‚ï¼Œä¸Šè¿°çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ç»è¿‡ç®€åŒ–çš„ï¼Œæ€»è€Œè¨€ä¹‹ï¼Œå½“å‰å‡½æ•°ä¸€å®šä¼šè¿”å›ä¸€ä¸ªå¯æ‰§è¡Œçš„ Goroutineï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨å°±ä¼šé˜»å¡ç­‰å¾…ã€‚ æ¥ä¸‹æ¥ç”± runtime.execute æ‰§è¡Œè·å–åˆ°çš„ Goroutineï¼Œåšå¥½å‡†å¤‡å·¥ä½œåï¼Œå®ƒä¼šé€šè¿‡ runtime.gogo å°† Goroutine è°ƒåº¦åˆ°å½“å‰çº¿ç¨‹ä¸Šï¼› æœ€ç»ˆåœ¨å½“å‰çº¿ç¨‹çš„ g0 çš„æ ˆä¸Šè°ƒç”¨ runtime.goexit0 å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°† Goroutine è½¬æ¢ä¼š _Gdead çŠ¶æ€ï¼› åœ¨æœ€å runtime.goexit0 ä¼šé‡æ–°è°ƒç”¨ runtime.schedule è§¦å‘æ–°ä¸€è½®çš„ Goroutine è°ƒåº¦ï¼ŒGo è¯­è¨€ä¸­çš„è¿è¡Œæ—¶è°ƒåº¦å¾ªç¯ä¼šä» runtime.schedule å¼€å§‹ï¼Œæœ€ç»ˆåˆå›åˆ° runtime.scheduleï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè°ƒåº¦å¾ªç¯","date":"2023-02-22","objectID":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/:1:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥","GMP"],"title":"Goæµ…æ-GMP","uri":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"äºŒã€ä» Bug ä¸­å­¦ä¹  æ— ç¼“å†² channelï¼Œç”±äº receiver é€€å‡ºå¯¼è‡´ sender ä¾§é˜»å¡ ä¸¾ä¾‹ï¼š func finishReq(timeout time.Duration) ob { ch := make(chan ob) go func() { result := fn() ch \u003c- result // block }() select { case result = \u003c-ch: return result case \u003c-time.After(timeout): return nil } } æœ¬æ„æ˜¯æƒ³åœ¨è°ƒç”¨ fn() æ—¶ï¼ŒåŠ ä¸Šè¶…æ—¶çš„åŠŸèƒ½ï¼Œå¦‚æœ fn()åœ¨è¶…æ—¶æ—¶é—´æ²¡æœ‰è¿”å›ï¼Œåˆ™è¿”å› nilã€‚ä½†æ˜¯å½“è¶…æ—¶å‘ç”Ÿçš„æ—¶å€™ï¼Œé’ˆå¯¹æ— ç¼“å†²çš„ ch æ¥è¯´ï¼Œç”±äºå·²ç»æ²¡æœ‰ receiver äº†ï¼Œç¬¬ 5 è¡Œå°†ä¼šè¢« block ä½ï¼Œå¯¼è‡´è¿™ä¸ª goroutine æ°¸è¿œä¸ä¼šé€€å‡ºã€‚ è¿™ä¸ª bug çš„ä¿®å¤æ–¹å¼ä¹Ÿæ˜¯éå¸¸çš„ç®€å•ï¼ŒæŠŠ unbuffered channel ä¿®æ”¹æˆ buffered channelã€‚ func finishReq(timeout time.Duration) ob { ch := make(chan ob, 1) go func() { result := fn() ch \u003c- result // block }() select { case result = \u003c-ch: return result case \u003c-time.After(timeout): return nil } } æ€è€ƒï¼šåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè™½ç„¶è¿™æ ·ä¸ä¼š block äº†ï¼Œä½†æ˜¯ channel ä¸€ç›´æ²¡æœ‰è¢«å…³é—­ï¼Œchannel ä¿æŒä¸å…³é—­æ˜¯å¦ä¼šå¯¼è‡´èµ„æºçš„æ³„æ¼å‘¢ï¼Ÿ é—®ï¼šchannel è¢«å…³é—­å¤šæ¬¡å¼•å‘çš„ bug select { case \u003c-c.closed: default: close(c.closed) } ä¸Šé¢è¿™å—ä»£ç å¯èƒ½ä¼šè¢«å¤šä¸ª goroutine åŒæ—¶æ‰§è¡Œï¼Œè¿™æ®µä»£ç çš„é€»è¾‘æ˜¯ï¼Œcase è¿™ä¸ªåˆ†æ”¯åˆ¤æ–­ closed è¿™ä¸ª channel æ˜¯å¦è¢«å…³é—­äº†ï¼Œå¦‚æœè¢«å…³é—­çš„è¯ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åšï¼›å¦‚æœ closed æ²¡æœ‰è¢«å…³é—­çš„è¯ï¼Œå°±æ‰§è¡Œ default åˆ†æ”¯å…³é—­è¿™ä¸ª channelï¼Œå¤šä¸ª goroutine å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ª channel è¢«å…³é—­å¤šæ¬¡ã€‚ For a channel c, the built-in function close(c) records that no more values will be sent on the channel. It is an error if c is a receive-only channel. Sending to or closing a closed channel causes a run-time panic. è¿™ä¸ª bug çš„ä¿®å¤æ–¹å¼æ˜¯ï¼š Once.Do(func() { close(c.closed) }) æŠŠæ•´ä¸ª select è¯­å¥å—æ¢æˆ Once.Doï¼Œä¿è¯ channel åªå…³é—­ä¸€æ¬¡ã€‚ WaitGroup è¯¯ç”¨å¯¼è‡´é˜»å¡ var group sync.WaitGroup group.Add(len(pm.plugins)) for _, p := range pm.plugins { go func(p *plugin) { defer group.Done() }(p) group.Wait() } å½“ len(pm.plugins) \u003e= 2 æ—¶ï¼Œç¬¬ 7 è¡Œå°†ä¼šè¢«å¡ä½ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™åªå¯åŠ¨äº†ä¸€ä¸ªå¼‚æ­¥çš„ goroutineï¼Œgroup.Done()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œgroup.Wait()å°†ä¼šæ°¸ä¹…é˜»å¡ã€‚ä¿®å¤å¦‚ä¸‹ï¼š var group sync.WaitGroup group.Add(len(pm.plugins)) for _, p := range pm.plugins { go func(p *plugin) { defer group.Done() }(p) } group.Wait() context è¯¯ç”¨å¯¼è‡´èµ„æºæ³„æ¼ å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š hctx, hcancel := context.WithCancel(ctx) if timeout \u003e 0 { hctx, hcancel = context.WithTimeout(ctx, timeout) } ç¬¬ä¸€è¡Œ context.WithCancel(ctx) æœ‰å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ª goroutineï¼Œæ¥ç­‰å¾… ctx æ˜¯å¦ Doneï¼Œå¦‚æœ parent çš„ ctx.Done()çš„è¯ï¼Œcancel æ‰ child çš„ contextã€‚ä¹Ÿå°±æ˜¯è¯´ hcancel ç»‘å®šäº†ä¸€å®šçš„èµ„æºï¼Œä¸èƒ½ç›´æ¥è¦†ç›–ã€‚ Canceling this context releases resources associated with it, so code should call cancel as soon as the operations running in this Context complete. è¿™ä¸ª bug çš„ä¿®å¤æ–¹å¼æ˜¯ï¼š var hctx context.Context var hcancel context.CancelFunc if timeout \u003e 0 { hctx, hcancel = context.WithTimeout(ctx, timeout) } else { hctx, hcancel = context.WithCancel(ctx) } æˆ–è€… hctx, hcancel := context.WithCancel(ctx) if timeout \u003e 0 { hcancel.Cancel() hctx, hcancel = context.WithTimeout(ctx, timeout) } é—®ï¼šå¤šä¸ª goroutine åŒæ—¶è¯»å†™å…±äº«å˜é‡å¯¼è‡´çš„ bug for i := 17; i \u003c= 21; i++ { // write go func() { /* Create a new goroutine */ apiVersion := fmt.Sprintf(\"v1.%d\", i) // read }() } ç¬¬äºŒè¡Œä¸­çš„åŒ¿åå‡½æ•°å½¢æˆäº†ä¸€ä¸ªé—­åŒ…(closures)ï¼Œåœ¨é—­åŒ…å†…éƒ¨å¯ä»¥è®¿é—®å®šä¹‰åœ¨å¤–é¢çš„å˜é‡ï¼Œå¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç¬¬ 1 è¡Œåœ¨å†™ i è¿™ä¸ªå˜é‡ï¼Œåœ¨ç¬¬ 3 è¡Œåœ¨è¯» i è¿™ä¸ªå˜é‡ã€‚è¿™é‡Œçš„å…³é”®çš„é—®é¢˜æ˜¯å¯¹åŒä¸€ä¸ªå˜é‡çš„è¯»å†™æ˜¯åœ¨ä¸¤ä¸ª goroutine é‡Œé¢åŒæ—¶è¿›è¡Œçš„ï¼Œå› æ­¤æ˜¯ä¸å®‰å…¨çš„ã€‚ å…¶å®è¿™é‡Œä¼šæŠŠ i é€ƒé€¸åˆ°å †ä¸Šï¼Œç„¶åéƒ½æŒ‡å‘å †ä¸ŠåŒä¸€ä¸ª iã€‚å› æ­¤ï¼Œå¦‚ä¸‹ç¨‹åºä¼šè¾“å‡ºå¾ˆå¤šä¸ª 6ï¼š func main() { for i := 0; i \u003c= 5; i++ { // write go func() { time.Sleep(100 * time.Millisecond) // ç­‰ä¸€ä¸‹ fmt.Printf(\"%d\\n\", i) // read }() } time.Sleep(3 * time.Second) } Function literals are closures: they may refer to variables defined in a surrounding function. Those variables are then shared between the surrounding function and the function literal, and they survive as long as they are accessible. å¯ä»¥ä¿®æ”¹æˆï¼š for i := 17; i \u003c= 21; i++ { // write go func(i int) { /* Create a new goroutine */ apiVersion := fmt.Sprintf(\"v1.%d\", i) // read }(i) } é€šè¿‡passed by valueçš„æ–¹å¼è§„é¿äº†å¹¶å‘è¯»å†™çš„é—®é¢˜ã€‚ é—®ï¼štimer è¯¯ç”¨äº§ç”Ÿçš„ bug å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š timer := time.NewTimer(0) if dur \u003e 0 { timer = time.NewTimer(dur) } select { case \u003c-timer.C: case \u003c-ctx.Done(): return nil } åŸæ„æ˜¯æƒ³ dur å¤§äº 0 çš„æ—¶å€™ï¼Œè®¾ç½® timer è¶…æ—¶æ—¶é—´ï¼Œä½†æ˜¯ timer := time.NewTimer(0)å¯¼è‡´ timer.C ç«‹å³è§¦å‘ã€‚ä¿®å¤åï¼š var timeout \u003c-chan time.Time if dur \u003e 0 { timeout = time.NewTimer(dur).C } select { case \u003c-timeout: case \u003c-ctx.Done(): return nil } A nil channel is never ready for communication. ä¸Šé¢çš„ä»£ç ä¸­ç¬¬ä¸€ä¸ª case åˆ†æ”¯ timeout æœ‰å¯èƒ½æ˜¯ä¸ª nil çš„ channelï¼Œselect åœ¨ nil çš„ channel ä¸Šï¼Œè¿™ä¸ªåˆ†æ”¯ä¸ä¼šè¢«è§¦å‘ï¼Œå› æ­¤ä¸ä¼šæœ‰é—®é¢˜ã€‚ ","date":"2023-02-22","objectID":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/:2:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥","GMP"],"title":"Goæµ…æ-GMP","uri":"/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"categories":["Go"],"content":"ä¸€ã€ç»“æ„ WaitGroup çš„ç»“æ„å¾ˆç®€å•ï¼Œç»´æŠ¤äº†ä¸‰ä¸ªä¸åŒçš„è®¡æ•°ï¼Œåˆ†åˆ«æ˜¯ counterã€waiter å’Œ semaphoreï¼š counter è®°å½•äº†è¦ç­‰å¾…ç»“æŸçš„ goroutine ä¸ªæ•°ï¼› waiter è®°å½•äº†ç­‰å¾…åœ¨è¯¥ WaitGroup ä¸Šçš„ goroutine çš„ä¸ªæ•°ï¼› semaphore è¢«ç”¨ä½œä¿¡å·é‡ã€‚ ä½†æ˜¯åœ¨ WaitGroup çš„ç»“æ„é‡Œå¹¶æ²¡æœ‰ç›´æ¥ä»¥è¿™ä¸‰ç§å˜é‡å‘½åçš„æˆå‘˜ï¼ŒnoCopy ç”¨æ¥å‘Šè¯‰ä»£ç æç¤ºå™¨æœ¬ç»“æ„ä½“å˜é‡ä¸èƒ½è¿›è¡Œå€¼å¤åˆ¶ï¼Œè¿™ä¸ªæš‚ä¸”ç•¥è¿‡ã€‚åœ¨ç»“æ„ä½“å†…ä½¿ç”¨äº†ä¸€ä¸ª uint64 å’Œä¸€ä¸ª uint32 ä¸¤ä¸ªæ•°å­—æ¥è¡¨ç¤ºäº†è¿™ä¸‰ä¸ªå˜é‡ï¼Œå°† counter å’Œ waiter ä¸¤ä¸ªéƒ¨åˆ†å½“ä½œäº†ä¸€ä¸ª uint64 å˜é‡è¿›è¡Œæ“ä½œï¼Œsemaphore å½“ä½œä¸€ä¸ª uint32 å˜é‡è¿›è¡Œæ“ä½œã€‚ type WaitGroup struct { noCopy noCopy state1 uint64 state2 uint32 } ä»å›¾ä¸­çœ‹å‡ºï¼Œå½“ state1 æ˜¯ 32 ä½å¯¹é½å’Œ 64 ä½å¯¹é½çš„æƒ…å†µä¸‹ï¼Œstate1 ä¸­æ¯ä¸ªå…ƒç´ çš„é¡ºåºå’Œå«ä¹‰ä¹Ÿä¸ä¸€æ ·: å½“ state1 æ˜¯ 32 ä½å¯¹é½ï¼šstate1 æ•°ç»„çš„ç¬¬ä¸€ä½æ˜¯ semaï¼Œç¬¬äºŒä½æ˜¯ waiterï¼Œç¬¬ä¸‰ä½æ˜¯ counterã€‚ å½“ state1 æ˜¯ 64 ä½å¯¹é½ï¼šstate1 æ•°ç»„çš„ç¬¬ä¸€ä½æ˜¯ waiterï¼Œç¬¬äºŒä½æ˜¯ counterï¼Œç¬¬ä¸‰ä½æ˜¯ semaã€‚ ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:1:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„è®¾å®šå‘¢ï¼Ÿ è¿™é‡Œæœ‰ä¸¤ä¸ªå‰æï¼š åœ¨ WaitGroup çš„é€»è¾‘ä¸­ï¼Œcounter å’Œ waiter è¢«åˆåœ¨äº†ä¸€èµ·ï¼Œå½“æˆä¸€ä¸ª 64 ä½çš„æ•´æ•°å¯¹å¤–ä½¿ç”¨ã€‚å½“éœ€è¦å˜åŒ– counter å’Œ waiter çš„å€¼çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯é€šè¿‡ atomic æ¥åŸå­æ“ä½œè¿™ä¸ª 64 ä½æ•´æ•°ã€‚ åœ¨ 32 ä½ç³»ç»Ÿä¸‹ï¼Œå¦‚æœä½¿ç”¨ atomic å¯¹ 64 ä½å˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼Œè°ƒç”¨è€…éœ€è¦è‡ªè¡Œä¿è¯å˜é‡çš„ 64 ä½å¯¹é½ï¼Œå¦åˆ™å°†ä¼šå‡ºç°å¼‚å¸¸ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ WaitGroup æ˜¯å¦‚ä½•è·å–è¿™ä¸¤éƒ¨åˆ†çš„åœ°å€çš„ï¼Œé€šè¿‡ state()ï¼š func (wg *WaitGroup) state() (statep *uint64, semap *uint32) { // å½“ state1 çš„å¯¹é½è¾¹ç•Œæ˜¯ 8å­—èŠ‚ æˆ– åœ°å€å·²å¯¹é½åˆ° 8å­—èŠ‚ if unsafe.Alignof(wg.state1) == 8 || uintptr(unsafe.Pointer(\u0026wg.state1))%8 == 0 { return \u0026wg.state1, \u0026wg.state2 } else { state := (*[3]uint32)(unsafe.Pointer(\u0026wg.state1)) return (*uint64)(unsafe.Pointer(\u0026state[1])), \u0026state[0] } } å½“ state1 å˜é‡æ˜¯ 64 ä½å¯¹é½æ—¶ï¼Œä¹Ÿå°±æ„å‘³ç€æ•°ç»„å‰ä¸¤ä½ä½œä¸º 64 ä½æ•´æ•°æ—¶ï¼Œè‡ªç„¶ä¹Ÿå¯ä»¥ä¿è¯ 64 ä½å¯¹é½äº†ã€‚ å½“ state1 å˜é‡æ˜¯ 32 ä½å¯¹é½æ—¶ï¼Œæˆ‘ä»¬æŠŠæ•°ç»„ç¬¬ 1 ä½ä½œä¸ºå¯¹é½çš„ paddingï¼Œå› ä¸º state1 æœ¬èº«æ˜¯ uint32 çš„æ•°ç»„ï¼Œæ‰€ä»¥æ•°ç»„ç¬¬ä¸€ä½ä¹Ÿæœ‰ 32 ä½ã€‚è¿™æ ·å°±ä¿è¯äº†æŠŠæ•°ç»„åä¸¤ä½çœ‹åšç»Ÿä¸€çš„ 64 ä½æ•´æ•°æ—¶æ˜¯64ä½å¯¹é½çš„ã€‚ ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯ counter å’Œ waiter çš„é›†åˆä½“çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯ semaphore çš„æŒ‡é’ˆã€‚ æ³¨: æœ‰äº›æ–‡ç« ä¼šè®²åˆ°ï¼ŒWaitGroup ä¸¤ç§ä¸åŒçš„å†…å­˜å¸ƒå±€æ–¹å¼æ˜¯ 32 ä½ç³»ç»Ÿå’Œ 64 ä½ç³»ç»Ÿçš„åŒºåˆ«ï¼Œè¿™å…¶å®ä¸å¤ªä¸¥è°¨ã€‚å‡†ç¡®çš„è¯´æ³•æ˜¯ 32 ä½å¯¹é½å’Œ 64 ä½å¯¹é½çš„åŒºåˆ«ã€‚å› ä¸ºåœ¨ 32 ä½ç³»ç»Ÿä¸‹ï¼Œstate1 å˜é‡ä¹Ÿæœ‰å¯èƒ½æ°å¥½ç¬¦åˆ 64 ä½å¯¹é½ã€‚ ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:1:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"é‚£ä¸ºä»€ä¹ˆè¦æŠŠ counter å’Œ waiter åˆåœ¨ä¸€èµ·å‘¢ï¼Ÿ è¿™å…¶å®æ˜¯ WaitGroup çš„ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚å› ä¸º counter å’Œ waiter åœ¨æ”¹å˜æ—¶éœ€è¦ä¿è¯å¹¶å‘å®‰å…¨ã€‚ é¦–å…ˆï¼Œå¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬æœ€ç®€å•çš„åšæ³•æ˜¯ï¼Œæä¸€ä¸ª Mutex æˆ–è€… RWMutex é”, åœ¨éœ€è¦è¯»å†™ counter å’Œ waiter çš„æ—¶å€™ï¼ŒåŠ é”å°±å®Œäº‹ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“åŠ é”å¿…ç„¶ä¼šé€ æˆé¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚ WaitGroup ç›´æ¥æŠŠ counter å’Œ waiter çœ‹æˆäº†ä¸€ä¸ªç»Ÿä¸€çš„ 64 ä½å˜é‡ã€‚å…¶ä¸­ counter æ˜¯è¿™ä¸ªå˜é‡çš„é«˜ 32 ä½ï¼Œwaiter æ˜¯è¿™ä¸ªå˜é‡çš„ä½ 32 ä½ã€‚åœ¨éœ€è¦æ”¹å˜ counter æ—¶, é€šè¿‡å°†ç´¯åŠ å€¼å·¦ç§» 32 ä½çš„æ–¹å¼ï¼šatomic.AddUint64(statep, uint64(delta)\u003c\u003c32)ï¼Œå³å¯å®ç° count += delta åŒæ ·çš„æ•ˆæœã€‚ ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:1:2","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"äºŒã€Add \u0026 Done ä¹‹æ‰€ä»¥å°† Add æ–¹æ³•å’Œ Done æ–¹æ³•åˆåœ¨ä¸€ä¸ªåˆ†èŠ‚é‡Œï¼Œæ˜¯å› ä¸º Done åªæ˜¯å¯¹ Add çš„ç®€å•è°ƒç”¨è€Œå·²ã€‚æœ¬èŠ‚ä¸»è¦æ¥åˆ†æä¸€ä¸‹ Add æ–¹æ³•å³å¯ã€‚ Add æ–¹æ³•çš„ä½œç”¨æ˜¯ä¿®æ”¹å½“å‰ç­‰å¾…ç»“æŸçš„ goroutine çš„æ•°é‡ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•° deltaï¼Œè¿™ä¸ªå‚æ•°å¯æ­£å¯è´Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ Add å…¶å®ä¸ä»…å¯ä»¥å¢åŠ ä¹Ÿå¯ä»¥å‡å°‘è®¡æ•°ï¼Œåªæ˜¯ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ Add æ¥å‡å°‘è®¡æ•°ã€‚ func (wg *WaitGroup) Add(delta int) { statep, semap := wg.state() // å¾—åˆ° counterã€waiter å’Œ semaphore state := atomic.AddUint64(statep, uint64(delta)\u003c\u003c32) // ä½¿ç”¨åŸå­æ–¹æ³•ä¿®æ”¹ v := int32(state \u003e\u003e 32) // é€šè¿‡ç§»ä½å¾—åˆ° counter w := uint32(state) // é€šè¿‡ç±»å‹è½¬æ¢å¾—åˆ° waiter if v \u003c 0 { panic(\"sync: negative WaitGroup counter\") } if w != 0 \u0026\u0026 delta \u003e 0 \u0026\u0026 v == int32(delta) { panic(\"sync: WaitGroup misuse: Add called concurrently with Wait\") } if v \u003e 0 || w == 0 { return } if *statep != state { panic(\"sync: WaitGroup misuse: Add called concurrently with Wait\") } *statep = 0 for ; w != 0; w-- { runtime_Semrelease(semap, false, 0) } } ä»ä¸Šé¢çš„æºç ä¸­å¯çŸ¥ Add ä¸ä»…ä¿®æ”¹äº†è®¡æ•°å™¨ counterï¼ŒåŒæ—¶ä¹Ÿåšäº†è®¡æ•°æ£€æŸ¥ã€‚ å¦‚æœä¸Šé¢çš„ if åˆ†æ”¯éƒ½æ²¡æœ‰åŒ¹é…çš„è¯ï¼Œè¯´æ˜ counter å·²ç»ç­‰äº 0 ä¸” waiter ä¸ç­‰äº 0ï¼Œæ­¤æ—¶ä¼šå°† counter ä¸ waiter çš„é›†åˆä½“ statep é‡ç½®ä¸º 0 æ–¹ä¾¿åç»­å¤ç”¨è¯¥ WaitGroupï¼Œç„¶åæ ¹æ® waiter ä¿å­˜çš„è®¡æ•°ï¼Œä¾æ¬¡è°ƒç”¨ runtime_Semrelease è§¦å‘ä¿¡å· semapï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…ä¸­çš„ goroutineã€‚ Doneå°±æ˜¯è°ƒç”¨äº†Addï¼š func (wg *WaitGroup) Done() { wg.Add(-1) } ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:2:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"ä¸‰ã€Wait Wait çš„ä½œç”¨æ˜¯å°†è°ƒç”¨è¯¥æ–¹æ³•çš„ goroutine é˜»å¡ï¼Œç­‰ WaitGroup ä¸­çš„ counter è®¡æ•°å½’é›¶åï¼Œä¼šå°†å…¶å”¤é†’ç»§ç»­æ‰§è¡Œ Wait ä¹‹åçš„ä»£ç ã€‚ func (wg *WaitGroup) Wait() { statep, semap := wg.state() for { state := atomic.LoadUint64(statep) v := int32(state \u003e\u003e 32) w := uint32(state) if v == 0 { // Counter is 0, no need to wait. return } // Increment waiters count. if atomic.CompareAndSwapUint64(statep, state, state+1) { runtime_Semacquire(semap) if *statep != 0 { panic(\"sync: WaitGroup is reused before previous Wait has returned\") } return } } } åœ¨ for å¾ªç¯ä¸­ä½¿ç”¨ CAS åŸå­æ“ä½œï¼Œæ¯”è¾ƒå¹¶ä¿®æ”¹ statep çš„å€¼ï¼Œå°† waiter çš„è®¡æ•°è¿›è¡Œç´¯åŠ ã€‚ç„¶åæ‰§è¡Œ runtime_Semacquire å°†è‡ªå·±é˜»å¡åœ¨ä¿¡å· semap ä¸Šï¼Œç­‰å¾…å”¤é†’ã€‚ ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:3:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"å››ã€ç–‘é—® ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:4:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":"4.1 ä¸ºä»€ä¹ˆè¦å°† counter å’Œ waiter åˆå¹¶ï¼Ÿ ä¸ºä»€ä¹ˆè¦ç…è´¹è‹¦å¿ƒå°† counter å’Œ waiter è¿™ä¸¤ä¸ªè®¡æ•°åˆå¹¶æˆä¸€ä¸ª uint64 ç±»å‹çš„å€¼ï¼Ÿä¼¼ä¹å¯ä»¥ç”¨ä¸¤ä¸ª uint32 çš„å€¼æ¥åˆ†å¼€è¡¨ç¤ºï¼Œç„¶ååœ¨æ“ä½œå„è‡ªçš„æ—¶å€™éƒ½ä½¿ç”¨ uint32 çš„åŸå­æ“ä½œå³å¯ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨è€ƒè™‘å†…å­˜å¯¹é½çš„é—®é¢˜ã€‚ ä¸»è¦æ˜¯éœ€è¦ä¿è¯counterä¸waiterä¿®æ”¹æ—¶çš„å¹¶å‘å®‰å…¨ã€‚å› ä¸º counter å’Œ waiter è¿™ä¸¤ä¸ªè®¡æ•°åœ¨ä½¿ç”¨æ—¶éœ€è¦åŒ¹é…æ‰è¡Œï¼Œå¦‚æœå°†è¿™ä¸¤ä¸ªè®¡æ•°åˆ†å¼€è¡¨ç¤ºï¼Œé‚£ä¹ˆå°±è¦ç”¨ä¸¤æ¬¡åŸå­æ“ä½œè¯»å–ï¼Œåœ¨è¿™ä¸¤æ¬¡åŸå­æ“ä½œä¹‹é—´å°±å¯èƒ½äº§ç”Ÿä¸€äº›å˜åŒ–ä½¿ counter å’Œ waiter ä¸å†åŒ¹é…ï¼Œä»è€Œå¯¼è‡´ä¸€äº›éš¾ä»¥é¢„æ–™çš„é—®é¢˜ã€‚ ","date":"2023-02-20","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/:4:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-WaitGroup","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-waitgroup/"},{"categories":["Go"],"content":" å‰è¨€ï¼šåœ¨ Go httpåŒ…çš„Serverä¸­ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚åœ¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ goroutine å»å¤„ç†ã€‚è¯·æ±‚å¤„ç†å‡½æ•°é€šå¸¸ä¼šå¯åŠ¨é¢å¤–çš„ goroutine ç”¨æ¥è®¿é—®åç«¯æœåŠ¡ï¼Œæ¯”å¦‚æ•°æ®åº“å’ŒRPCæœåŠ¡ã€‚ç”¨æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„ goroutine é€šå¸¸éœ€è¦è®¿é—®ä¸€äº›ä¸è¯·æ±‚ç‰¹å®šçš„æ•°æ®ï¼Œæ¯”å¦‚ç»ˆç«¯ç”¨æˆ·çš„èº«ä»½è®¤è¯ä¿¡æ¯ã€éªŒè¯ç›¸å…³çš„tokenã€è¯·æ±‚çš„æˆªæ­¢æ—¶é—´ã€‚ å½“ä¸€ä¸ªè¯·æ±‚è¢«å–æ¶ˆæˆ–è¶…æ—¶æ—¶ï¼Œæ‰€æœ‰ç”¨æ¥å¤„ç†è¯¥è¯·æ±‚çš„ goroutine éƒ½åº”è¯¥è¿…é€Ÿé€€å‡ºï¼Œç„¶åç³»ç»Ÿæ‰èƒ½é‡Šæ”¾è¿™äº› goroutine å ç”¨çš„èµ„æºã€‚ æœ‰ç©ºçš„æ—¶å€™ï¼Œçœ‹çœ‹è¿™ç¯‡è®²Contextå®ç°çš„æ–‡ç« : https://wmf.im/p/%E5%88%86%E6%9E%90-go-%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84-context-%E5%AE%9E%E7%8E%B0/ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:0:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"ä¸€ã€Context æ¦‚è¿° Go 1.7åŠ å…¥äº†ä¸€ä¸ªæ–°çš„æ ‡å‡†åº“contextï¼Œå®ƒå®šä¹‰äº†Contextç±»å‹ï¼Œç”¨æ¥ç®€åŒ– å¤„ç†å•ä¸ªç”¨æˆ·è¯·æ±‚çš„å¤šä¸ªgoroutineä¹‹é—´ä¸å…ƒæ•°æ®ä¼ é€’ã€æˆªæ­¢æ—¶é—´ã€å–æ¶ˆä¿¡å·ç­‰ç›¸å…³æ“ä½œï¼Œè¿™äº›æ“ä½œå¯èƒ½æ¶‰åŠå¤šä¸ª API è°ƒç”¨ã€‚å½“ä¸€ä¸ªä¸Šä¸‹æ–‡è¢«å–æ¶ˆæ—¶ï¼Œå®ƒæ´¾ç”Ÿçš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¹Ÿè¢«å–æ¶ˆã€‚ ä¸»è¦å†…å®¹æ¦‚æ‹¬ä¸ºï¼š 1 ä¸ªæ¥å£ï¼šContextï¼› 4 ç§ç±»å‹å®ç°ï¼šemptyCtxã€cancelCtxã€timerCtxã€valueCtxï¼› 6 ä¸ªå‡½æ•°ï¼šBackgroundã€TODOã€WithCancelã€WithDeadlineã€WithTimeoutã€WithValueã€‚ é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼Œåˆ›å»º Goroutine å’Œ Context æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§æ ‘çš„ç»“æ„ï¼Œç”Ÿæˆçˆ¶èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹çš„è¾¹ï¼Œæœ€ç»ˆå½¢æˆä¸€ç§å¤šå‰æ ‘ç»“æ„ï¼š ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:1:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"äºŒã€Context æ¥å£ context.Contextæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†å››ä¸ªéœ€è¦å®ç°çš„æ–¹æ³•ã€‚å…·ä½“æ¥å£å¦‚ä¸‹ï¼š type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error Value(key any) any } Deadlineæ–¹æ³•éœ€è¦è¿”å›å½“å‰Contextè¢«å–æ¶ˆçš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å®Œæˆå·¥ä½œçš„æˆªæ­¢æ—¶é—´ï¼ˆdeadlineï¼‰ï¼› Doneæ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªChannelï¼Œè¿™ä¸ªChannelä¼šåœ¨å½“å‰å·¥ä½œå®Œæˆæˆ–è€…ä¸Šä¸‹æ–‡è¢«å–æ¶ˆä¹‹åå…³é—­; Erræ–¹æ³•ä¼šè¿”å›å½“å‰Contextç»“æŸçš„åŸå› ï¼Œå®ƒåªä¼šåœ¨Doneè¿”å›çš„Channelè¢«å…³é—­æ—¶æ‰ä¼šè¿”å›éç©ºçš„å€¼ï¼› å¦‚æœå½“å‰Contextè¢«å–æ¶ˆå°±ä¼šè¿”å›Canceledé”™è¯¯ï¼› å¦‚æœå½“å‰Contextè¶…æ—¶å°±ä¼šè¿”å›DeadlineExceededé”™è¯¯ï¼› Valueæ–¹æ³•ä¼šä»Contextä¸­è¿”å›é”®å¯¹åº”çš„å€¼ï¼Œå¯¹äºåŒä¸€ä¸ªä¸Šä¸‹æ–‡æ¥è¯´ï¼Œå¤šæ¬¡è°ƒç”¨Value å¹¶ä¼ å…¥ç›¸åŒçš„Keyä¼šè¿”å›ç›¸åŒçš„ç»“æœï¼Œè¯¥æ–¹æ³•ä»…ç”¨äºä¼ é€’è·¨APIå’Œè¿›ç¨‹é—´è·Ÿè¯·æ±‚åŸŸçš„æ•°æ®ï¼› ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:2:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"ä¸‰ã€ç±»å‹å®ç° ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:3:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"emptyCtx æ•°æ®ç»“æ„ type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() \u003c-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key any) any { return } emptyCtx æ˜¯ä¸€ä¸ªç©ºçš„ Contextï¼Œæœ¬è´¨ä¸Šç±»å‹ä¸ºä¸€ä¸ªæ•´å‹ï¼› Deadline æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå…¬å…ƒå…ƒå¹´æ—¶é—´ä»¥åŠ false çš„ flagï¼Œæ ‡è¯†å½“å‰ context ä¸å­˜åœ¨è¿‡æœŸæ—¶é—´ï¼› Done æ–¹æ³•è¿”å›ä¸€ä¸ª nil å€¼ï¼Œç”¨æˆ·æ— è®ºå¾€ nil ä¸­å†™å…¥æˆ–è€…è¯»å–æ•°æ®ï¼Œå‡ä¼šé™·å…¥é˜»å¡ï¼› Err æ–¹æ³•è¿”å›çš„é”™è¯¯æ°¸è¿œä¸º nilï¼› Value æ–¹æ³•è¿”å›çš„ value åŒæ ·æ°¸è¿œä¸º nil. Background() å’Œ TODO() Goå†…ç½®ä¸¤ä¸ªå‡½æ•°ï¼šBackground()å’ŒTODO()ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«è¿”å›ä¸€ä¸ªå®ç°äº†Contextæ¥å£çš„backgroundå’Œtodoã€‚æˆ‘ä»¬ä»£ç ä¸­æœ€å¼€å§‹éƒ½æ˜¯ä»¥è¿™ä¸¤ä¸ªå†…ç½®çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸ºæœ€é¡¶å±‚çš„partent contextï¼Œè¡ç”Ÿå‡ºæ›´å¤šçš„å­ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ var ( background = new(emptyCtx) todo = new(emptyCtx) ) func Background() Context { return background } func TODO() Context { return todo } Background()ä¸»è¦ç”¨äºåˆå§‹åŒ–æ—¶åˆ›å»ºä¸€ä¸ªemptyCtxï¼Œä½œä¸ºContextè¿™ä¸ªæ ‘ç»“æ„çš„æœ€é¡¶å±‚çš„Contextï¼Œä¹Ÿå°±æ˜¯æ ¹Contextã€‚ TODO()ï¼šå®˜æ–¹æ–‡æ¡£å»ºè®®åœ¨æœ¬æ¥åº”è¯¥ä½¿ç”¨å¤–å±‚ä¼ é€’çš„ctxï¼Œè€Œå¤–å±‚å´æ²¡æœ‰ä¼ é€’çš„åœ°æ–¹ä½¿ç”¨ã€‚æ­£å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œç•™ä¸‹ä¸€ä¸ª TODOã€‚ backgroundå’Œtodoæœ¬è´¨ä¸Šéƒ½æ˜¯emptyCtxç»“æ„ä½“ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªä¸å¯å–æ¶ˆï¼Œæ²¡æœ‰è®¾ç½®æˆªæ­¢æ—¶é—´ï¼Œæ²¡æœ‰æºå¸¦ä»»ä½•å€¼çš„Contextã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:3:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"cancelCtx ä¸€ç§å¯å–æ¶ˆçš„ Contextã€‚ æ•°æ®ç»“æ„ type cancelCtx struct { Context // embed çš„çˆ¶ Contextï¼Œä¸ºç©º mu sync.Mutex // ç”¨äºä¿æŠ¤ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µçš„é”ï¼Œä»¥ä¿éšœcancelCtxæ˜¯çº¿ç¨‹å®‰å…¨çš„ done atomic.Value // ç”¨äºè·å–è¯¥Contextçš„å–æ¶ˆé€šçŸ¥ children map[canceler]struct{} // ç”¨äºå­˜å‚¨ä»¥å½“å‰èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å¯å–æ¶ˆçš„Context err error // ç”¨äºå­˜å‚¨å–æ¶ˆæ—¶æŒ‡å®šçš„é”™è¯¯ä¿¡æ¯ } type canceler interface { cancel(removeFromParent bool, err error) Done() \u003c-chan struct{} } embed äº†ä¸€ä¸ª context ä½œä¸ºå…¶çˆ¶ context. å¯è§ï¼ŒcancelCtx å¿…ç„¶ä¸ºæŸä¸ª context çš„å­ contextï¼› muï¼šç”¨äºä¿æŠ¤ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µçš„é”ï¼Œä»¥ä¿éšœ cancelCtx æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼› doneï¼šç”¨äºè·å–è¯¥ Context çš„å–æ¶ˆé€šçŸ¥ï¼› childrenï¼šç”¨äºå­˜å‚¨ä»¥å½“å‰èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å¯å–æ¶ˆçš„ Contextï¼Œä»¥ä¾¿åœ¨æ ¹ Context å–æ¶ˆæ—¶ï¼ŒæŠŠå®ƒçš„å­èŠ‚ç‚¹ä¸€å¹¶å–æ¶ˆï¼› errï¼šç”¨äºå­˜å‚¨å–æ¶ˆæ—¶æŒ‡å®šçš„é”™è¯¯ä¿¡æ¯ã€‚ WithCancel func WithCancel(parent Context) (ctx Context, cancel CancelFunc) WithCancelå‡½æ•°å¯ä»¥å°†ä¸€ä¸ª Context åŒ…è£…ä¸ºcancelCtxï¼Œå¹¶æä¾›ä¸€ä¸ªå–æ¶ˆå‡½æ•°ï¼Œè°ƒç”¨è¯¥å–æ¶ˆå‡½æ•°å¯ä»¥ Cancel å¯¹åº”çš„Contextã€‚ WithCancelè¿”å›å¸¦æœ‰æ–°Doneé€šé“çš„çˆ¶èŠ‚ç‚¹çš„å‰¯æœ¬ã€‚å½“è°ƒç”¨è¿”å›çš„cancelå‡½æ•°æˆ–å½“å…³é—­çˆ¶ä¸Šä¸‹æ–‡çš„Doneé€šé“æ—¶ï¼Œå°†å…³é—­è¿”å›ä¸Šä¸‹æ–‡çš„Doneé€šé“ã€‚ Done func (c *cancelCtx) Done() \u003c-chan struct{} { d := c.done.Load() if d != nil { return d.(chan struct{}) } c.mu.Lock() defer c.mu.Unlock() d = c.done.Load() if d == nil { d = make(chan struct{}) c.done.Store(d) } return d.(chan struct{}) } åŸºäº atomic åŒ…ï¼Œè¯»å– cancelCtx ä¸­çš„ chanï¼›å€˜è‹¥å·²å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼› åŠ é”åï¼Œå†æ¬¡æ£€æŸ¥ chan æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™è¿”å›ï¼›ï¼ˆdouble checkï¼‰ åˆå§‹åŒ– chan å­˜å‚¨åˆ° aotmic.Value å½“ä¸­ï¼Œå¹¶è¿”å›ã€‚ï¼ˆæ‡’åŠ è½½æœºåˆ¶ï¼‰ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:3:2","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"timerCtx æ•°æ®ç»“æ„ type timerCtx struct { cancelCtx timer *time.Timer // ç”± cancelCtx.mu æ¥ä¿æŠ¤ï¼Œç¡®ä¿å–æ¶ˆæ“ä½œæ—¶çº¿ç¨‹å®‰å…¨çš„ deadline time.Time } åœ¨cancelCtxåŸºç¡€ä¸Šï¼Œåˆå°è£…äº†ä¸€ä¸ªå®šæ—¶å™¨timerå’Œä¸€ä¸ªæˆªæ­¢æ—¶é—´deadlineï¼Œè¿™æ ·åŠå¯ä»¥æ ¹æ®éœ€è¦ä¸»åŠ¨å–æ¶ˆï¼Œä¹Ÿå¯ä»¥åœ¨åˆ°è¾¾ deadline æ—¶é€šè¿‡timerè§¦å‘å–æ¶ˆåŠ¨ä½œã€‚ æ³¨æ„ï¼Œtimer ç”± cancelCtx.mu æ¥ä¿æŠ¤ï¼Œç¡®ä¿å–æ¶ˆæ“ä½œæ—¶çº¿ç¨‹å®‰å…¨çš„ã€‚ WithDeadline å’Œ WithTimeout WithDeadline å’Œ WithTimeout çš„å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å¯ä»¥åˆ›å»º timerCtxï¼ŒåŒºåˆ«æ˜¯ï¼š å‰è€…ä¼ å…¥ä¸€ä¸ªæ—¶é—´ç‚¹ï¼› åè€…ä¼ å…¥ä¸€ä¸ªæ—¶é—´æ®µï¼Œå‡½æ•°å†…å†è°ƒç”¨WithDeadline(parent, time.Now().Add(timeout))ã€‚ é€šå¸¸ç”¨äºæ•°æ®åº“æˆ–è€…ç½‘ç»œè¿æ¥çš„è¶…æ—¶æ§åˆ¶ã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:3:3","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"valueCtx æ•°æ®ç»“æ„ type valueCtx struct { Context key, val any } ä¸€ä¸ª valueCtx ä¸­ä»…æœ‰ä¸€ç»„ kv å¯¹ã€‚ WithValue WithValueå‡½æ•°ç­¾åå¦‚ä¸‹ï¼š func WithValue(parent Context, key, val interface{}) Context WithValueåˆ›å»ºä¸€ä¸ªvalueCtxï¼Œå…¶ä¸­ä¸keyå…³è”çš„å€¼ä¸ºvalã€‚ valueCtx.Value() func (c *valueCtx) Value(key any) any { if c.key == key { return c.val } return value(c.Context, key) } å‡å¦‚å½“å‰ valueCtx çš„ key ç­‰äºç”¨æˆ·ä¼ å…¥çš„ keyï¼Œåˆ™ç›´æ¥è¿”å›å…¶ valueï¼› å‡å¦‚ä¸ç­‰ï¼Œåˆ™ä» parent context ä¸­å‘ä¸Šéå†å¯»æ‰¾. ä¾‹å¦‚ï¼Œä¼šå‡ºç°å­Contextä¸­çš„key-valueè¦†ç›–çˆ¶èŠ‚ç‚¹çš„ï¼š é¦–å…ˆä¼šæ¯”è¾ƒå½“å‰Contextä¸­çš„keyæ˜¯å¦ç­‰äºè¦æŸ¥æ‰¾çš„keyï¼› æ­¤å¤„keyA==keyCï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å›ctxCä¸­çš„valï¼Œå› æ­¤å‡ºç°äº†å­èŠ‚ç‚¹\"è¦†ç›–\"çˆ¶èŠ‚ç‚¹æ•°æ®çš„æƒ…å†µã€‚ ä¸ºäº†è§„é¿å­èŠ‚ç‚¹\"è¦†ç›–\"çˆ¶èŠ‚ç‚¹æ•°æ®çš„æƒ…å†µï¼Œæœ€å¥½ä¸è¦ç›´æ¥ä½¿ç”¨stringã€intç­‰åŸºç¡€ç±»å‹ä½œä¸ºkeyï¼Œè€Œæ˜¯ç”¨è‡ªå®šä¹‰ç±»å‹åŒ…è£…ä¸€ä¸‹ï¼š é¦–å…ˆæ¯”è¾ƒå½“å‰Contextä¸­çš„keyæ˜¯å¦ç­‰äºè¦æŸ¥æ‰¾çš„keyï¼› æ­¤å¤„ç”±äºç±»å‹ä¸åŒï¼Œå› æ­¤æ£€æŸ¥ä¸é€šè¿‡ï¼Œäºæ˜¯å‘çˆ¶èŠ‚ç‚¹ç»§ç»­æŸ¥æ‰¾ï¼Œè¿›è€Œæ‰¾åˆ°æ­£ç¡®çš„valã€‚ ä½¿ç”¨è§„èŒƒ ä¸ºäº†è§„é¿å­èŠ‚ç‚¹\"è¦†ç›–\"çˆ¶èŠ‚ç‚¹æ•°æ®çš„æƒ…å†µï¼Œæœ€å¥½ä¸è¦ç›´æ¥ä½¿ç”¨stringã€intç­‰åŸºç¡€ç±»å‹ä½œä¸ºkeyï¼Œè€Œæ˜¯ç”¨è‡ªå®šä¹‰ç±»å‹åŒ…è£…ä¸€ä¸‹ï¼› å¯ä»¥çœ‹å‡ºï¼ŒvalueCtx ä¸é€‚åˆè§†ä¸ºå­˜å‚¨ä»‹è´¨ï¼Œå­˜æ”¾å¤§é‡çš„ kv æ•°æ®ï¼ŒåŸå› æœ‰ä¸‰ï¼š ä¸€ä¸ª valueCtx å®ä¾‹åªèƒ½å­˜ä¸€ä¸ª kv å¯¹ï¼Œå› æ­¤ n ä¸ª kv å¯¹ä¼šåµŒå¥— n ä¸ª valueCtxï¼Œé€ æˆç©ºé—´æµªè´¹ï¼› åŸºäº k å¯»æ‰¾ v çš„è¿‡ç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)ï¼› ä¸æ”¯æŒåŸºäº k çš„å»é‡ï¼Œç›¸åŒ k å¯èƒ½é‡å¤å­˜åœ¨ï¼Œå¹¶åŸºäºèµ·ç‚¹çš„ä¸åŒï¼Œè¿”å›ä¸åŒçš„ v. ç”±æ­¤å¾—çŸ¥ï¼ŒvalueContext çš„å®šä½ç±»ä¼¼äºè¯·æ±‚å¤´ï¼Œåªé€‚åˆå­˜æ”¾å°‘é‡ä½œç”¨åŸŸè¾ƒå¤§çš„å…¨å±€ meta æ•°æ®. Contextæœ¬èº«æ˜¯æœ¬ç€ä¸å¯æ”¹å˜(immutable)çš„æ¨¡å¼è®¾è®¡çš„ï¼Œæ‰€ä»¥ä¸è¦è§†å›¾ä¿®æ”¹ctxä¸­ä¿å­˜çš„å€¼ã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:3:4","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"å››ã€æ³¨æ„äº‹é¡¹ æ¨èä»¥å‚æ•°çš„æ–¹å¼æ˜¾ç¤ºä¼ é€’Context ä»¥Contextä½œä¸ºå‚æ•°çš„å‡½æ•°æ–¹æ³•ï¼Œåº”è¯¥æŠŠContextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚ ç»™ä¸€ä¸ªå‡½æ•°æ–¹æ³•ä¼ é€’Contextçš„æ—¶å€™ï¼Œä¸è¦ä¼ é€’nilï¼Œå¦‚æœä¸çŸ¥é“ä¼ é€’ä»€ä¹ˆï¼Œå°±ä½¿ç”¨context.TODO() Contextçš„Valueç›¸å…³æ–¹æ³•åº”è¯¥ä¼ é€’è¯·æ±‚åŸŸçš„å¿…è¦æ•°æ®ï¼Œä¸åº”è¯¥ç”¨äºä¼ é€’å¯é€‰å‚æ•° Contextæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ”¾å¿ƒçš„åœ¨å¤šä¸ªgoroutineä¸­ä¼ é€’ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:4:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"äº”ã€ä½¿ç”¨ç¤ºä¾‹ contextåŒ…ä¸­å®šä¹‰äº†å››ä¸ªWithç³»åˆ—å‡½æ•°ã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:5:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"WithCancel WithCancelè¿”å›å¸¦æœ‰æ–°Doneé€šé“çš„çˆ¶èŠ‚ç‚¹çš„å‰¯æœ¬ã€‚å½“è°ƒç”¨è¿”å›çš„cancelå‡½æ•°æˆ–å½“å…³é—­çˆ¶ä¸Šä¸‹æ–‡çš„Doneé€šé“æ—¶ï¼Œå°†å…³é—­è¿”å›ä¸Šä¸‹æ–‡çš„Doneé€šé“ã€‚ å–æ¶ˆæ­¤ä¸Šä¸‹æ–‡å°†é‡Šæ”¾ä¸å…¶å…³è”çš„èµ„æºï¼Œé€šå¸¸ä½¿ç”¨deferæ¥ç«‹å³è°ƒç”¨cancel()ï¼š func gen(ctx context.Context) \u003c-chan int { dst := make(chan int) cnt := 0 go func() { for { select { case \u003c-ctx.Done(): log.Println(\"gen over!\") return // returnç»“æŸè¯¥goroutineï¼Œé˜²æ­¢æ³„éœ² case dst \u003c- cnt: cnt++ } } }() return dst } func main() { ctx, cancel := context.WithCancel(context.Background()) defer cancel() // å½“æˆ‘ä»¬å–å®Œéœ€è¦çš„æ•´æ•°åè°ƒç”¨cancel for cnt := range gen(ctx) { fmt.Println(cnt) if cnt == 5 { break } } } ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œgenå‡½æ•°åœ¨å•ç‹¬çš„goroutineä¸­ç”Ÿæˆæ•´æ•°å¹¶å°†å®ƒä»¬å‘é€åˆ°è¿”å›çš„é€šé“ã€‚gençš„è°ƒç”¨è€…åœ¨ä½¿ç”¨ç”Ÿæˆçš„æ•´æ•°ä¹‹åéœ€è¦å–æ¶ˆä¸Šä¸‹æ–‡ï¼Œä»¥å…genå¯åŠ¨çš„å†…éƒ¨goroutineå‘ç”Ÿæ³„æ¼ã€‚ ä¸‹é¢æ¼”ç¤ºï¼Œå¦‚ä½•é€šè¿‡ context å…³é—­å¤šä¸ª goroutineï¼š func watchDog(ctx context.Context, name string) { for { select { case \u003c-ctx.Done(): fmt.Println(name, \"å·²æ”¶åˆ°åœæ­¢æŒ‡ä»¤, é©¬ä¸Šåœæ­¢\") return default: fmt.Println(name, \"æ­£åœ¨ç›‘æ§...\") } time.Sleep(1 * time.Second) } } func main() { ctx, cancel := context.WithCancel(context.Background()) var wg sync.WaitGroup wg.Add(2) go func() { defer wg.Done() watchDog(ctx, \"dahuang\") }() go func() { defer wg.Done() watchDog(ctx, \"dabai\") }() time.Sleep(5 * time.Second) // å…ˆè®©ç›‘æ§ç‹—ç›‘æ§5ç§’ cancel() // é€šçŸ¥å¤šä¸ª goroutine é€€å‡º wg.Wait() } ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:5:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"WithDeadline å–æ¶ˆæ­¤ä¸Šä¸‹æ–‡å°†é‡Šæ”¾ä¸å…¶å…³è”çš„èµ„æºï¼Œå› æ­¤ä»£ç åº”è¯¥åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„æ“ä½œå®Œæˆåç«‹å³è°ƒç”¨cancelã€‚ func main() { n, d := time.Now(), time.Now().Add(50*time.Millisecond) fmt.Printf(\"å½“å‰æ—¶é—´ä¸ºï¼š%v\\næˆªæ­¢æ—¶é—´ä¸ºï¼š%v\\n\", n, d) ctx, cancel := context.WithDeadline(context.Background(), d) // å°½ç®¡ctxä¼šè¿‡æœŸï¼Œä½†åœ¨ä»»ä½•æƒ…å†µä¸‹è°ƒç”¨å®ƒçš„cancelå‡½æ•°éƒ½æ˜¯å¾ˆå¥½çš„ä¹ æƒ¯ã€‚ // å¦‚æœä¸è¿™æ ·åšï¼Œå¯èƒ½ä¼šä½¿ä¸Šä¸‹æ–‡åŠå…¶çˆ¶ç±»å­˜æ´»çš„æ—¶é—´è¶…è¿‡å¿…è¦çš„æ—¶é—´ã€‚ defer cancel() select { case \u003c-time.After(1 * time.Second): fmt.Println(\"overslept\") case \u003c-ctx.Done(): fmt.Println(ctx.Err()) } } è¾“å‡ºï¼š $ go run test.go å½“å‰æ—¶é—´ä¸ºï¼š2022-09-28 16:58:04.381338 +0800 CST m=+0.001487201 æˆªæ­¢æ—¶é—´ä¸ºï¼š2022-09-28 16:58:04.431338 +0800 CST m=+0.051487201 context deadline exceeded ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ª50æ¯«ç§’ä¹‹åè¿‡æœŸçš„deadlineï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨context.WithDeadline(context.Background(), d)å¾—åˆ°ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆctxï¼‰å’Œä¸€ä¸ªå–æ¶ˆå‡½æ•°ï¼ˆcancelï¼‰ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªselectè®©ä¸»ç¨‹åºé™·å…¥ç­‰å¾…ï¼šç­‰å¾…1ç§’åæ‰“å°overslepté€€å‡ºæˆ–è€…ç­‰å¾…ctxè¿‡æœŸåé€€å‡ºã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œå› ä¸ºctx 50æ¯«ç§’åå°±ä¼šè¿‡æœŸï¼Œæ‰€ä»¥ctx.Done()ä¼šå…ˆæ¥æ”¶åˆ°contextåˆ°æœŸé€šçŸ¥ï¼Œå¹¶ä¸”ä¼šæ‰“å°ctx.Err()çš„å†…å®¹ã€‚è‹¥dåœ¨time.Afteråï¼Œé‚£ä¹ˆå°†è¾“å‡ºoversleptã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:5:2","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"WithTimeout func dbConnect(ctx context.Context) { fmt.Printf(\"db connecting...\\n\") time.Sleep(100 * time.Millisecond) // 1. è¶…æ—¶ //time.Sleep(10 * time.Millisecond) // 2. ä¸è¶…æ—¶ select { // è‹¥åœ¨ctxè§„å®šæ—¶é—´å†…æœªè¿æ¥ä¸Šï¼Œåˆ™è¶…æ—¶ï¼›å¦åˆ™è¿æ¥æˆåŠŸã€‚ case \u003c-ctx.Done(): fmt.Println(\"db connect failed, err:\", ctx.Err()) default: fmt.Println(\"db connect success!\") } wg.Done() } func main() { wg.Add(1) // è®¾ç½®æ•°æ®åº“è¶…æ—¶æœŸé™ä¸º50ms ctx, cancel := context.WithTimeout(context.Background(), 50*time.Millisecond) defer cancel() go dbConnect(ctx) wg.Wait() // ç­‰å¾…dbConnect fmt.Println(\"main is over...\") } è¾“å‡ºï¼š # è¶…æ—¶æƒ…å†µ $ go run test.go db connecting... db connect failed, err: context deadline exceeded main is over... # ä¸è¶…æ—¶æƒ…å†µ $ go run test.go db connecting... db connect success! main is over... ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:5:3","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"WithValue func worker(ctx context.Context) { key := TraceCode(\"TRACE_CODE\") if traceCode, ok := ctx.Value(key).(string); ok { log.Println(\"trade code:\", traceCode) } else { log.Println(\"invalid key\") } wg.Done() } func main() { wg.Add(1) // è®¾ç½®æ•°æ®åº“è¶…æ—¶æœŸé™ä¸º50ms ctx, cancel := context.WithTimeout(context.Background(), 50*time.Millisecond) // åœ¨ç³»ç»Ÿçš„å…¥å£ä¸­è®¾ç½®trace codeä¼ é€’ç»™åç»­å¯åŠ¨çš„goroutineå®ç°æ—¥å¿—æ•°æ®èšåˆ ctx = context.WithValue(ctx, TraceCode(\"TRACE_CODE\"), \"12512312234\") defer cancel() go worker(ctx) wg.Wait() // ç­‰å¾…worker fmt.Println(\"main is over...\") } è¾“å‡ºï¼š $ go run test.go 2022/09/28 21:06:02 trade code: 12512312234 main is over... ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:5:4","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"å…­ã€å®¢æˆ·ç«¯è¶…æ—¶å–æ¶ˆå®ä¾‹ å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯APIæ—¶ï¼Œå¦‚ä½•å®ç°è¶…æ—¶æ§åˆ¶ï¼Ÿ serverç«¯ï¼š func indexHandler(w http.ResponseWriter, r *http.Request) { number := rand.Intn(2) if number == 0 { fmt.Fprintf(w, \"slow response\") time.Sleep(time.Second * 10) // è€—æ—¶10sçš„æ…¢å“åº” return } fmt.Fprintf(w, \"quick response\") } func main() { http.HandleFunc(\"/\", indexHandler) err := http.ListenAndServe(\":8000\", nil) if err != nil { panic(err) } } clientç«¯ï¼š var wg sync.WaitGroup type respData struct { resp *http.Response err error } func doCall(ctx context.Context) { transport := http.Transport{ DisableKeepAlives: true, } client := http.Client{Transport: \u0026transport} req, err := http.NewRequest(\"GET\", \"http://127.0.0.1:8000/\", nil) if err != nil { fmt.Println(\"client create new request failed, err:\", err) return } // ä½¿ç”¨å¸¦è¶…æ—¶çš„ctxåˆ›å»ºæ–°çš„request req = req.WithContext(ctx) wg.Add(1) defer wg.Wait() // è°ƒç”¨serverç«¯api respChan := make(chan *respData, 1) go func() { resp, err := client.Do(req) // å¯èƒ½å‘ç”Ÿè¶…æ—¶é”™è¯¯ if err != nil { fmt.Println(\"client request api failed, err:\", err) wg.Done() return } respChan \u003c- \u0026respData{ resp: resp, err: err, } wg.Done() }() select { case \u003c-ctx.Done(): // ctxè¶…æ—¶æ—¶ fmt.Println(\"client call server api timeout...\") case result := \u003c-respChan: // æ­£å¸¸è°ƒç”¨æ—¶ fmt.Println(\"client call server api success!\") if result.err != nil { fmt.Println(\"client call server api failed, err:\", result.err) return } data, _ := ioutil.ReadAll(result.resp.Body) defer result.resp.Body.Close() fmt.Println(\"resp:\", string(data)) } } func main() { // å®šä¹‰ä¸€ä¸ª1sçš„è¶…æ—¶ctx, è¶…è¿‡1såˆ™è¿”å›ctx deadline exceedé”™è¯¯ ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() // è°ƒç”¨cancelé‡Šæ”¾å­goroutineèµ„æº doCall(ctx) } è¾“å‡ºï¼š # 1. æ­£å¸¸è°ƒç”¨ $ go run client.go client call server api success! resp: quick response # 2. è¶…æ—¶ $ go run client.go client call server api timeout... client request api failed, err: Get \"http://127.0.0.1:8000/\": context deadline exceeded ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:6:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"ä¸ƒã€åº•å±‚åŸç†(æœ‰ç©ºçœ‹å§, æ²¡ç©ºç®—äº†) é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼Œåˆ›å»º Goroutine å’Œ Context æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§å¦‚ä¸Šçš„ç»“æ„ï¼Œç”Ÿæˆçˆ¶èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹çš„è¾¹ï¼Œæœ€ç»ˆå½¢æˆä¸€ç§å¤šå‰æ ‘ç»“æ„ã€‚ ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"6.1 æ ¸å¿ƒæ•°æ®ç»“æ„ type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} // åªè¯»çš„ï¼Œç”¨ä½œç»“æŸä¿¡å· Err() error // åªåœ¨contextç»“æŸæ—¶ï¼Œæ‰ä¼šäº§ç”Ÿ Value(key any) any // æ•°æ®å­˜å‚¨ï¼Œç±»ä¼¼ map } Context ä¸º interfaceï¼Œå®šä¹‰äº†å››ä¸ªæ ¸å¿ƒ apiï¼š Deadlineï¼šè¿”å› context çš„è¿‡æœŸæ—¶é—´ï¼› Doneï¼šè¿”å› context ä¸­çš„ channelï¼› Errï¼šè¿”å›é”™è¯¯ï¼› Valueï¼šè¿”å› context ä¸­çš„å¯¹åº” key çš„å€¼. 6.1.1 error var Canceled = errors.New(\"context canceled\") var DeadlineExceeded error = deadlineExceededError{} type deadlineExceededError struct{} func (deadlineExceededError) Error() string { return \"context deadline exceeded\" } func (deadlineExceededError) Timeout() bool { return true } func (deadlineExceededError) Temporary() bool { return true Canceledï¼šcontext è¢« cancel æ—¶ä¼šæŠ¥æ­¤é”™è¯¯ï¼› DeadlineExceededï¼šcontext è¶…æ—¶æ—¶ä¼šæŠ¥æ­¤é”™è¯¯. ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"6.2 empty context 6.2.1 ç±»çš„å®ç° type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() \u003c-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key any) any { return } emptyCtx æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œæœ¬è´¨ä¸Šç±»å‹ä¸ºä¸€ä¸ªæ•´å‹ï¼› Deadline æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå…¬å…ƒå…ƒå¹´æ—¶é—´ä»¥åŠ false çš„ flagï¼Œæ ‡è¯†å½“å‰ context ä¸å­˜åœ¨è¿‡æœŸæ—¶é—´ï¼› Done æ–¹æ³•è¿”å›ä¸€ä¸ª nil å€¼ï¼Œç”¨æˆ·æ— è®ºå¾€ nil ä¸­å†™å…¥æˆ–è€…è¯»å–æ•°æ®ï¼Œå‡ä¼šé™·å…¥é˜»å¡ï¼› Err æ–¹æ³•è¿”å›çš„é”™è¯¯æ°¸è¿œä¸º nilï¼› Value æ–¹æ³•è¿”å›çš„ value åŒæ ·æ°¸è¿œä¸º nil. 6.2.2 context.Background() \u0026 context.TODO() var ( background = new(emptyCtx) todo = new(emptyCtx) ) func Background() Context { return background } func TODO() Context { return todo } æˆ‘ä»¬æ‰€å¸¸ç”¨çš„ context.Background() å’Œ context.TODO() æ–¹æ³•è¿”å›çš„å‡æ˜¯ emptyCtx ç±»å‹çš„ä¸€ä¸ªå®ä¾‹. ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:2","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"6.3 cancelCtx 6.3.1 æ•°æ®ç»“æ„ type cancelCtx struct { Context // embed çš„çˆ¶ Contextï¼Œä¸ºç©º mu sync.Mutex // protects following fields done atomic.Value // of chan struct{}, created lazily, closed by first cancel call children map[canceler]struct{} // set to nil by the first cancel call err error // set to non-nil by the first cancel call } type canceler interface { cancel(removeFromParent bool, err error) Done() \u003c-chan struct{} } embed äº†ä¸€ä¸ª context ä½œä¸ºå…¶çˆ¶ context. å¯è§ï¼ŒcancelCtx å¿…ç„¶ä¸ºæŸä¸ª context çš„å­ contextï¼› å†…ç½®äº†ä¸€æŠŠé”ï¼Œç”¨ä»¥åè°ƒå¹¶å‘åœºæ™¯ä¸‹çš„èµ„æºè·å–ï¼› doneï¼šå®é™…ç±»å‹ä¸º chan struct{}ï¼Œå³ç”¨ä»¥åæ˜  cancelCtx ç”Ÿå‘½å‘¨æœŸçš„é€šé“ï¼› childrenï¼šä¸€ä¸ª setï¼ŒæŒ‡å‘ cancelCtx çš„æ‰€æœ‰å­ contextï¼› errï¼šè®°å½•äº†å½“å‰ cancelCtx çš„é”™è¯¯. å¿…ç„¶ä¸ºæŸä¸ª context çš„å­ contextï¼› 6.3.2 Deadline æ–¹æ³• cancelCtx æœªå®ç°è¯¥æ–¹æ³•ï¼Œä»…æ˜¯ embed äº†ä¸€ä¸ªå¸¦æœ‰ Deadline æ–¹æ³•çš„ Context interfaceï¼Œå› æ­¤å€˜è‹¥ç›´æ¥è°ƒç”¨ä¼šæŠ¥é”™. 6.3.3 Done æ–¹æ³• func (c *cancelCtx) Done() \u003c-chan struct{} { d := c.done.Load() if d != nil { return d.(chan struct{}) } c.mu.Lock() defer c.mu.Unlock() d = c.done.Load() if d == nil { d = make(chan struct{}) c.done.Store(d) } return d.(chan struct{}) } åŸºäº atomic åŒ…ï¼Œè¯»å– cancelCtx ä¸­çš„ chanï¼›å€˜è‹¥å·²å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼› åŠ é”åï¼Œå†æ¬¡æ£€æŸ¥ chan æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™è¿”å›ï¼›ï¼ˆdouble checkï¼‰ åˆå§‹åŒ– chan å­˜å‚¨åˆ° aotmic.Value å½“ä¸­ï¼Œå¹¶è¿”å›.ï¼ˆæ‡’åŠ è½½æœºåˆ¶ï¼‰ 6.3.4 Error æ–¹æ³• func (c *cancelCtx) Err() error { c.mu.Lock() err := c.err c.mu.Unlock() return err } åŠ é”ï¼› è¯»å– cancelCtx.errï¼› è§£é”ï¼› è¿”å›ç»“æœ. 6.3.5 Value æ–¹æ³• func (c *cancelCtx) Value(key any) any { if key == \u0026cancelCtxKey { // ç³»ç»Ÿå†…éƒ¨è°ƒç”¨çš„ return c } return value(c.Context, key) // æ™®é€šç”¨æˆ·å–æ•°æ®ï¼Œå°±åƒæ˜¯ key-value } å€˜è‹¥ key ç‰¹å®šå€¼ \u0026cancelCtxKeyï¼Œåˆ™è¿”å› cancelCtx è‡ªèº«çš„æŒ‡é’ˆï¼› å¦åˆ™éµå¾ª valueCtx çš„æ€è·¯å–å€¼è¿”å›ï¼Œå…·ä½“è§ 2.1.6 å°èŠ‚. 6.3.6 context.WithCancel 6.3.6.1 context.WithCancel() func WithCancel(parent Context) (ctx Context, cancel CancelFunc) { if parent == nil { panic(\"cannot create context from nil parent\") } c := newCancelCtx(parent) propagateCancel(parent, \u0026c) return \u0026c, func() { c.cancel(true, Canceled) } } æ ¡éªŒçˆ¶ context éç©ºï¼› æ³¨å…¥çˆ¶ context æ„é€ å¥½ä¸€ä¸ªæ–°çš„ cancelCtxï¼› åœ¨ propagateCancel æ–¹æ³•å†…å¯åŠ¨ä¸€ä¸ªå®ˆæŠ¤åç¨‹ï¼Œä»¥ä¿è¯çˆ¶ context ç»ˆæ­¢æ—¶ï¼Œè¯¥ cancelCtx ä¹Ÿä¼šè¢«ç»ˆæ­¢ï¼› å°† cancelCtx è¿”å›ï¼Œè¿å¸¦è¿”å›ä¸€ä¸ªç”¨ä»¥ç»ˆæ­¢è¯¥ cancelCtx çš„é—­åŒ…å‡½æ•°. 6.3.6.2 newCancelCtx func newCancelCtx(parent Context) cancelCtx { return cancelCtx{Context: parent} } æ³¨å…¥çˆ¶ context åï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ cancelCtx. 6.3.6.3 propagateCancel func propagateCancel(parent Context, child canceler) { done := parent.Done() if done == nil { return // parent is never canceled } select { case \u003c-done: // parent is already canceled child.cancel(false, parent.Err()) return default: } if p, ok := parentCancelCtx(parent); ok { p.mu.Lock() if p.err != nil { // parent has already been canceled child.cancel(false, p.err) } else { if p.children == nil { p.children = make(map[canceler]struct{}) // æ·»åŠ åˆ° children map å³å¯ } p.children[child] = struct{}{} } p.mu.Unlock() } else { atomic.AddInt32(\u0026goroutines, +1) go func() { select { case \u003c-parent.Done(): // parent is already canceled child.cancel(false, parent.Err()) case \u003c-child.Done(): } }() } } propagateCancel æ–¹æ³•é¡¾åæ€ä¹‰ï¼Œç”¨ä»¥ä¼ é€’çˆ¶å­ context ä¹‹é—´çš„ cancel äº‹ä»¶ï¼š å€˜è‹¥ parent æ˜¯ä¸ä¼šè¢« cancel çš„ç±»å‹ï¼ˆå¦‚ emptyCtxï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›ï¼› å€˜è‹¥ parent å·²ç»è¢« cancelï¼Œåˆ™ç›´æ¥ç»ˆæ­¢å­ contextï¼Œå¹¶ä»¥ parent çš„ err ä½œä¸ºå­ context çš„ errï¼› å‡å¦‚ parent æ˜¯ cancelCtx çš„ç±»å‹ï¼Œåˆ™åŠ é”ï¼Œå¹¶å°†å­ context æ·»åŠ åˆ° parent çš„ children map å½“ä¸­ï¼› å‡å¦‚ parent ä¸æ˜¯ cancelCtx ç±»å‹ï¼Œä½†åˆå­˜åœ¨ cancel çš„èƒ½åŠ›ï¼ˆæ¯”å¦‚ç”¨æˆ·è‡ªå®šä¹‰å®ç°çš„ contextï¼‰ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œé€šè¿‡å¤šè·¯å¤ç”¨çš„æ–¹å¼ç›‘æ§ parent çŠ¶æ€ï¼Œå€˜è‹¥å…¶ç»ˆæ­¢ï¼Œåˆ™åŒæ—¶ç»ˆæ­¢å­ contextï¼Œå¹¶é€ä¼  parent çš„ err. è¿›ä¸€æ­¥è§‚å¯Ÿ parentCancelCtx æ˜¯å¦‚ä½•æ ¡éªŒ parent æ˜¯å¦ä¸º cancelCtx çš„ç±»å‹ï¼š func parentCancelCtx(parent Context) (*cancelCtx, bool) { done := parent.Done() if done == closedchan || done == nil { return nil, false } p, ok := parent.Value(\u0026cancelCtxKey).(*cancelCtx) if !ok { return nil, false } pdone, _ := p.done.Load().(chan struct{}) if pdone != done { return nil, false } return p, true } å€˜è‹¥ parent çš„ channel å·²å…³é—­æˆ–è€…æ˜¯ä¸ä¼šè¢« cancel çš„ç±»å‹ï¼Œåˆ™è¿”å› falseï¼› å€˜è‹¥ä»¥ç‰¹å®šçš„ cancelCtxKey ä» parent ä¸­å–å€¼ï¼Œå–å¾—çš„ value æ˜¯ parent æœ¬èº«ï¼Œåˆ™è¿”å› true. ï¼ˆåŸºäº cancelCtxKey ä¸º key å–å€¼æ—¶è¿”å› cancelCtx è‡ªèº«ï¼Œæ˜¯ cancelCtx ç‰¹æœ‰çš„åè®®ï¼‰. 6.3.6.4 cancelCtx.cancel func (c *cancelCtx) cancel(removeFromParent bool, err error) { if err == nil { panic(\"context: internal error: missing cancel error\") } c.mu.Lock() if c.err != nil { c.mu.Unlock() return // already canceled } c.err = err d, _ := c.done.Load(","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:3","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"6.4 timerCtx 6.4.1 æ•°æ®ç»“æ„ type timerCtx struct { cancelCtx timer *time.Timer // Under cancelCtx.mu. deadline time.Time } timerCtx åœ¨ cancelCtx åŸºç¡€ä¸Šåˆåšäº†ä¸€å±‚å°è£…ï¼Œé™¤äº†ç»§æ‰¿ cancelCtx çš„èƒ½åŠ›ä¹‹å¤–ï¼Œæ–°å¢äº†ä¸€ä¸ª time.Timer ç”¨äºå®šæ—¶ç»ˆæ­¢ contextï¼›å¦å¤–æ–°å¢äº†ä¸€ä¸ª deadline å­—æ®µç”¨äºå­—æ®µ timerCtx çš„è¿‡æœŸæ—¶é—´. 6.4.2 timerCtx.Deadline() func (c *timerCtx) Deadline() (deadline time.Time, ok bool) { return c.deadline, true } context.Context interface ä¸‹çš„ Deadline api ä»…åœ¨ timerCtx ä¸­æœ‰æ•ˆï¼Œå±•ç¤ºå…¶è¿‡æœŸæ—¶é—´. 6.4.3 timerCtx.cancel func (c *timerCtx) cancel(removeFromParent bool, err error) { c.cancelCtx.cancel(false, err) if removeFromParent { removeChild(c.cancelCtx.Context, c) } c.mu.Lock() if c.timer != nil { c.timer.Stop() c.timer = nil } c.mu.Unlock() } å¤ç”¨ç»§æ‰¿çš„ cancelCtx çš„ cancel èƒ½åŠ›ï¼Œè¿›è¡Œ cancel å¤„ç†ï¼› åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰‹åŠ¨ä» parent çš„ children set ä¸­ç§»é™¤ï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œå¤„ç† åŠ é”ï¼› åœæ­¢ time.Timer è§£é”è¿”å›. 6.4.4 context.WithTimeout \u0026 context.WithDeadline func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) { return WithDeadline(parent, time.Now().Add(timeout)) } context.WithTimeout æ–¹æ³•ç”¨äºæ„é€ ä¸€ä¸ª timerCtxï¼Œæœ¬è´¨ä¸Šä¼šè°ƒç”¨ context.WithDeadline æ–¹æ³•ï¼š func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) { if parent == nil { panic(\"cannot create context from nil parent\") } if cur, ok := parent.Deadline(); ok \u0026\u0026 cur.Before(d) { // The current deadline is already sooner than the new one. return WithCancel(parent) } c := \u0026timerCtx{ cancelCtx: newCancelCtx(parent), deadline: d, } propagateCancel(parent, c) dur := time.Until(d) if dur \u003c= 0 { c.cancel(true, DeadlineExceeded) // deadline has already passed return c, func() { c.cancel(false, Canceled) } } c.mu.Lock() defer c.mu.Unlock() if c.err == nil { c.timer = time.AfterFunc(dur, func() { c.cancel(true, DeadlineExceeded) }) } return c, func() { c.cancel(true, Canceled) } } æ ¡éªŒ parent context éç©ºï¼› æ ¡éªŒ parent çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ—©äºè‡ªå·±ï¼Œè‹¥æ˜¯ï¼Œåˆ™æ„é€ ä¸€ä¸ª cancelCtx è¿”å›å³å¯ï¼› æ„é€ å‡ºä¸€ä¸ªæ–°çš„ timerCtxï¼› å¯åŠ¨å®ˆæŠ¤æ–¹æ³•ï¼ŒåŒæ­¥ parent çš„ cancel äº‹ä»¶åˆ°å­ contextï¼› åˆ¤æ–­è¿‡æœŸæ—¶é—´æ˜¯å¦å·²åˆ°ï¼Œè‹¥æ˜¯ï¼Œç›´æ¥ cancel timerCtxï¼Œå¹¶è¿”å› DeadlineExceeded çš„é”™è¯¯ï¼› åŠ é”ï¼› å¯åŠ¨ time.Timerï¼Œè®¾å®šä¸€ä¸ªå»¶æ—¶æ—¶é—´ï¼Œå³è¾¾åˆ°è¿‡æœŸæ—¶é—´åä¼šç»ˆæ­¢è¯¥ timerCtxï¼Œå¹¶è¿”å› DeadlineExceeded çš„é”™è¯¯ï¼› è§£é”ï¼› è¿”å› timerCtxï¼Œå·²ç»ä¸€ä¸ªå°è£…äº† cancel é€»è¾‘çš„é—­åŒ… cancel å‡½æ•°. ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:4","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"6.5 valueCtx 6.5.1 æ•°æ®ç»“æ„ type valueCtx struct { Context key, val any } valueCtx åŒæ ·ç»§æ‰¿äº†ä¸€ä¸ª parent contextï¼› ä¸€ä¸ª valueCtx ä¸­ä»…æœ‰ä¸€ç»„ kv å¯¹. 6.5.2 valueCtx.Value() func (c *valueCtx) Value(key any) any { if c.key == key { return c.val } return value(c.Context, key) } å‡å¦‚å½“å‰ valueCtx çš„ key ç­‰äºç”¨æˆ·ä¼ å…¥çš„ keyï¼Œåˆ™ç›´æ¥è¿”å›å…¶ valueï¼› å‡å¦‚ä¸ç­‰ï¼Œåˆ™ä» parent context ä¸­å‘ä¸Šéå†å¯»æ‰¾. func value(c Context, key any) any { for { switch ctx := c.(type) { case *valueCtx: if key == ctx.key { return ctx.val } c = ctx.Context case *cancelCtx: if key == \u0026cancelCtxKey { return c } c = ctx.Context case *timerCtx: if key == \u0026cancelCtxKey { return \u0026ctx.cancelCtx } c = ctx.Context case *emptyCtx: return nil default: return c.Value(key) } } } å¯åŠ¨ä¸€ä¸ª for å¾ªç¯ï¼Œç”±ä¸‹è€Œä¸Šï¼Œç”±å­åŠçˆ¶ï¼Œä¾æ¬¡å¯¹ key è¿›è¡ŒåŒ¹é…ï¼› å…¶ä¸­ cancelCtxã€timerCtxã€emptyCtx ç±»å‹ä¼šæœ‰ç‰¹æ®Šçš„å¤„ç†æ–¹å¼ï¼› æ‰¾åˆ°åŒ¹é…çš„ keyï¼Œåˆ™å°†è¯¥ç»„ value è¿›è¡Œè¿”å›. 6.5.3 valueCtx ç”¨æ³•å°ç»“ å¯ä»¥çœ‹å‡ºï¼ŒvalueCtx ä¸é€‚åˆè§†ä¸ºå­˜å‚¨ä»‹è´¨ï¼Œå­˜æ”¾å¤§é‡çš„ kv æ•°æ®ï¼ŒåŸå› æœ‰ä¸‰ï¼š ä¸€ä¸ª valueCtx å®ä¾‹åªèƒ½å­˜ä¸€ä¸ª kv å¯¹ï¼Œå› æ­¤ n ä¸ª kv å¯¹ä¼šåµŒå¥— n ä¸ª valueCtxï¼Œé€ æˆç©ºé—´æµªè´¹ï¼› åŸºäº k å¯»æ‰¾ v çš„è¿‡ç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)ï¼› ä¸æ”¯æŒåŸºäº k çš„å»é‡ï¼Œç›¸åŒ k å¯èƒ½é‡å¤å­˜åœ¨ï¼Œå¹¶åŸºäºèµ·ç‚¹çš„ä¸åŒï¼Œè¿”å›ä¸åŒçš„ v. ç”±æ­¤å¾—çŸ¥ï¼ŒvalueContext çš„å®šä½ç±»ä¼¼äºè¯·æ±‚å¤´ï¼Œåªé€‚åˆå­˜æ”¾å°‘é‡ä½œç”¨åŸŸè¾ƒå¤§çš„å…¨å±€ meta æ•°æ®. 6.5.4 context.WithValue() func WithValue(parent Context, key, val any) Context { if parent == nil { panic(\"cannot create context from nil parent\") } if key == nil { panic(\"nil key\") } if !reflectlite.TypeOf(key).Comparable() { panic(\"key is not comparable\") } return \u0026valueCtx{parent, key, val} } å€˜è‹¥ parent context ä¸ºç©ºï¼Œpanicï¼› å€˜è‹¥ key ä¸ºç©º panicï¼› å€˜è‹¥ key çš„ç±»å‹ä¸å¯æ¯”è¾ƒï¼Œpanicï¼› åŒ…æ‹¬ parent context ä»¥åŠ kvå¯¹ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ valueCtx. å‚è€ƒæ–‡ç« ï¼š https://mp.weixin.qq.com/s?__biz=MzkxMjQzMjA0OQ==\u0026mid=2247483677\u0026idx=1\u0026sn=d1c0e52b1fd31932867ec9b1d00f4ec2\u0026chksm=c10c4fc3f67bc6d590141040342153004ea4e420d83f4e2b2afc068e8bb904778b02b5be3f97\u0026scene=126\u0026sessionid=1682837915#rd ","date":"2023-02-19","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/:7:5","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Context","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-context/"},{"categories":["Go"],"content":"[toc] ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:0:0","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"ä¸€ã€Atomic æ–¹æ³• å¦‚æœå»çœ‹æ–‡æ¡£ä¼šå‘ç° atomic çš„å‡½æ•°ç­¾åæœ‰å¾ˆå¤šï¼Œä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯é‡å¤çš„ä¸ºäº†ä¸åŒçš„æ•°æ®ç±»å‹åˆ›å»ºäº†ä¸åŒçš„ç­¾åï¼Œè¿™å°±æ˜¯æ²¡æœ‰æ³›å‹çš„åå¤„äº†ï¼ŒåŸºç¡€åº“ä¼šæ¯”è¾ƒéº»çƒ¦ 1ã€ç¬¬ä¸€ç±» AddXXXï¼Œå½“éœ€è¦æ·»åŠ çš„å€¼ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåšå‡æ³•ï¼Œæ­£æ•°åšåŠ æ³• func AddInt32(addr *int32, delta int32) (new int32) func AddInt64(addr *int64, delta int64) (new int64) func AddUint32(addr *uint32, delta uint32) (new uint32) func AddUint64(addr *uint64, delta uint64) (new uint64) func AddUintptr(addr *uintptr, delta uintptr) (new uintptr) 2ã€ç¬¬äºŒç±» CompareAndSwapXXXï¼Œ==CAS æ“ä½œ==ï¼Œä¼šå…ˆæ¯”è¾ƒä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦æ˜¯ oldï¼Œå¦‚æœæ˜¯çš„è¯å°±å°è¯•èµ‹æ–°å€¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ç›´æ¥è¿”å› falseï¼Œè¿”å› true æ—¶è¡¨ç¤ºèµ‹å€¼æˆåŠŸã€‚ func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool) func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool) func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool) func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool) func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool) 3ã€ç¬¬ä¸‰ç±» LoadXXXï¼Œä»æŸä¸ªåœ°å€ä¸­å–å€¼ func LoadInt32(addr *int32) (val int32) func LoadInt64(addr *int64) (val int64) func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer) func LoadUint32(addr *uint32) (val uint32) func LoadUint64(addr *uint64) (val uint64) func LoadUintptr(addr *uintptr) (val uintptr) 4ã€ç¬¬å››ç±» StoreXXX ï¼Œç»™æŸä¸ªåœ°å€èµ‹å€¼ func StoreInt32(addr *int32, val int32) func StoreInt64(addr *int64, val int64) func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer) func StoreUint32(addr *uint32, val uint32) func StoreUint64(addr *uint64, val uint64) func StoreUintptr(addr *uintptr, val uintptr) 5ã€ç¬¬äº”ç±» SwapXXX ï¼Œäº¤æ¢ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”è¿”å›è€çš„å€¼ func SwapInt32(addr *int32, new int32) (old int32) func SwapInt64(addr *int64, new int64) (old int64) func SwapPointer(addr *unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer) func SwapUint32(addr *uint32, new uint32) (old uint32) func SwapUint64(addr *uint64, new uint64) (old uint64) func SwapUintptr(addr *uintptr, new uintptr) (old uintptr) 6ã€æœ€åä¸€ç±» Value ç”¨äºä»»æ„ç±»å‹çš„å€¼çš„ Storeã€Loadï¼Œè¿™æ˜¯ 1.4 ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„ï¼Œç­¾åçš„æ–¹æ³•éƒ½åªèƒ½ä½œç”¨äºç‰¹å®šçš„ç±»å‹ï¼Œå¼•å…¥è¿™ä¸ªæ–¹æ³•ä¹‹åå°±å¯ä»¥ç”¨äºä»»æ„ç±»å‹äº†ã€‚ type Value func (v *Value) Load() (x interface{}) func (v *Value) Store(x interface{}) å‚è€ƒæ–‡ç« ï¼š Golang äº”ç§åŸå­æ€§æ“ä½œçš„ç”¨æ³•è¯¦è§£ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:1:0","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"äºŒã€CAS ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:2:0","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"æ¦‚è¿° æ¯”è¾ƒå¹¶äº¤æ¢ï¼šç®€ç§° CASï¼Œè¿™ç±»æ“ä½œçš„å‰ç¼€ä¸º CompareAndSwapï¼Œä¸ä»…æ”¯æŒå¯¹æ•°å€¼ç±»å‹è¿›è¡Œæ¯”è¾ƒäº¤æ¢ï¼Œè¿˜æ”¯æŒå¯¹æŒ‡é’ˆè¿›è¡Œæ¯”è¾ƒäº¤æ¢ï¼š func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool) è¯¥æ“ä½œåœ¨è¿›è¡Œäº¤æ¢å‰ï¼šé¦–å…ˆç¡®ä¿è¢«æ“ä½œæ•°çš„å€¼æœªè¢«æ›´æ”¹ï¼Œå³ä»ç„¶ä¿å­˜ç€å‚æ•° old æ‰€è®°å½•çš„å€¼ï¼Œæ»¡è¶³æ­¤å‰ææ¡ä»¶ä¸‹æ‰è¿›è¡Œäº¤æ¢æ“ä½œã€‚å…¶å®è¿™å°±æ˜¯ CAS æ±‡ç¼–ä»£ç ä¸­ CMPXCHGL çš„ä½œç”¨ã€‚ CASçš„åšæ³•ç±»ä¼¼æ“ä½œæ•°æ®åº“æ—¶å¸¸è§çš„ä¹è§‚é”æœºåˆ¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æœ‰å¤§é‡çš„ goroutine å¯¹å˜é‡è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå¯èƒ½å¯¼è‡´CASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨forå¾ªç¯å¤šæ¬¡å°è¯•ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:2:1","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"å®ç°åŸç† CAS çš„å®ç°æ€æƒ³å¯ç”¨å¦‚ä¸‹ä¼ªä»£ç è¯´æ˜ï¼š bool Cas(int *val, int old, int new) Atomically: if(*val == old){ *val = new; return 1; } else { return 0; } ä»¥CompareAndSwapInt32ä¸ºä¾‹ï¼Œå®ƒåœ¨sync/atomic/doc.goä¸­å®šä¹‰çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) å¯¹åº”çš„æ±‡ç¼–ä»£ç ä½äºsync/atomic/asm.sä¸­ TEXT Â·CompareAndSwapInt32(SB),NOSPLIT,$0 JMP runtimeâˆ•internalâˆ•atomicÂ·Cas(SB) é€šè¿‡æŒ‡ä»¤JMPï¼Œè·³è½¬åˆ°å®ƒçš„å®é™…å®ç°runtimeâˆ•internalâˆ•atomicÂ·Cas(SB)ã€‚åº•å±‚ç”±æ±‡ç¼–ä»£ç ç»„æˆï¼Œä¸åŒå¹³å°å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œæ­¤å¤„ç”¨arm64ä¸ºä¾‹ï¼š TEXT runtimeâˆ•internalâˆ•atomicÂ·Cas(SB),NOSPLIT,$0-17 MOVQ ptr+0(FP), BX # ç¬¬ä¸€ä¸ªå‚æ•°addrå‘½åä¸ºptrï¼Œæ”¾å…¥BX(MOVQï¼Œå®Œæˆ8ä¸ªå­—èŠ‚çš„å¤åˆ¶) MOVL old+8(FP), AX # ç¬¬äºŒä¸ªå‚æ•°oldï¼Œæ”¾å…¥AXï¼ˆMOVLï¼Œå®Œæˆ4ä¸ªå­—èŠ‚çš„å¤åˆ¶ï¼‰ MOVL new+12(FP), CX # ç¬¬ä¸‰ä¸ªå‚æ•°newï¼Œæ”¾å…¥CXï¼ˆMOVLï¼Œå®Œæˆ4ä¸ªå­—èŠ‚çš„å¤åˆ¶ï¼‰ LOCK CMPXCHGL CX, 0(BX) # é€šè¿‡å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ SETEQ ret+16(FP) RET è¿™æ®µæ±‡ç¼–ä»£ç çš„å«ä¹‰å°±æ˜¯ï¼š å…¶å®æ²¡å¿…è¦å®Œå…¨ææ‡‚ä¸Šè¿°æ±‡ç¼–æ˜¯å•¥æ„æ€ï¼Œå®ƒçš„å‡½æ•°åŸå‹ä¸ºfunc CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)ï¼Œå…¶å…¥å‚addrä¸º8ä¸ªå­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼Œoldå’Œnewåˆ†åˆ«ä¸º4ä¸ªå­—èŠ‚ï¼Œè¿”å›å‚æ•°swappedä¸º1ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥17=8+4+4+1ã€‚ æ¥ä¸‹æ¥è§£é‡Šè¿™å‡ æ¡æ±‡ç¼–æŒ‡ä»¤çš„ä½œç”¨ï¼š ptr+0(FP)ä»£è¡¨çš„æ„æ€å°±æ˜¯pträ»FPåç§»0byteå¤„å–å†…å®¹ã€‚AXï¼ŒBXï¼ŒCXåœ¨è¿™é‡Œï¼ŒçŸ¥é“å®ƒä»¬æ˜¯å­˜æ”¾æ•°æ®çš„å¯„å­˜å™¨å³å¯ã€‚MOV X Yæ‰€åšçš„æ“ä½œæ˜¯å°†Xä¸Šçš„å†…å®¹å¤åˆ¶åˆ°Yä¸Šå»ï¼ŒMOVåç¼€Lè¡¨ç¤ºâ€œé•¿å­—â€ï¼ˆ32ä½ï¼Œ4ä¸ªå­—èŠ‚ï¼‰ï¼ŒQè¡¨ç¤ºâ€œå››å­—â€ï¼ˆ64ä½ï¼Œ8ä¸ªå­—èŠ‚ï¼‰ã€‚ MOVQ ptr+0(FP), BX # ç¬¬ä¸€ä¸ªå‚æ•°addrå‘½åä¸ºptrï¼Œæ”¾å…¥BX(MOVQï¼Œå®Œæˆ8ä¸ªå­—èŠ‚çš„å¤åˆ¶) MOVL old+8(FP), AX # ç¬¬äºŒä¸ªå‚æ•°oldï¼Œæ”¾å…¥AXï¼ˆMOVLï¼Œå®Œæˆ4ä¸ªå­—èŠ‚çš„å¤åˆ¶ï¼‰ MOVL new+12(FP), CX # ç¬¬ä¸‰ä¸ªå‚æ•°newï¼Œæ”¾å…¥CXï¼ˆMOVLï¼Œå®Œæˆ4ä¸ªå­—èŠ‚çš„å¤åˆ¶ï¼‰ é‡ç‚¹æ˜¯LOCKæŒ‡ä»¤ï¼šåœ¨å¤šå¤„ç†å™¨ç¯å¢ƒä¸­ï¼ŒæŒ‡ä»¤å‰ç¼€LOCKèƒ½å¤Ÿç¡®ä¿ï¼Œåœ¨æ‰§è¡ŒLOCKéšåçš„æŒ‡ä»¤æ—¶ï¼Œå¤„ç†å™¨æ‹¥æœ‰å¯¹ä»»ä½•å…±äº«å†…å­˜çš„ç‹¬å ä½¿ç”¨ã€‚åœ¨æ±‡ç¼–ä»£ç é‡Œç»™æŒ‡ä»¤åŠ ä¸Š LOCK å‰ç¼€ï¼Œè¿™æ˜¯CPU åœ¨ç¡¬ä»¶å±‚é¢æ”¯æŒçš„åŸå­æ“ä½œã€‚ä½†è¿™æ ·çš„é”ç²’åº¦å¤ªç²—ï¼Œå…¶ä»–æ— å…³çš„å†…å­˜æ“ä½œä¹Ÿä¼šè¢«é˜»å¡ï¼Œå¤§å¹…é™ä½ç³»ç»Ÿæ€§èƒ½ï¼Œæ ¸æ•°è¶Šå¤šæ„ˆå‘æ˜¾è‘—ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒIntel ä» Pentium 486 å¼€å§‹å¼•å…¥äº†ç²’åº¦è¾ƒç»†çš„ç¼“å­˜é”ï¼šMESIåè®®ã€‚æ­¤æ—¶ï¼Œå°½ç®¡æœ‰LOCKå‰ç¼€ï¼Œä½†å¦‚æœå¯¹åº”æ•°æ®å·²ç»åœ¨ cache lineé‡Œï¼Œä¹Ÿå°±ä¸ç”¨é”å®šæ€»çº¿ï¼Œä»…é”ä½ç¼“å­˜è¡Œå³å¯ã€‚ LOCK CMPXCHGL CX, 0(BX) CMPXCHGLï¼ŒLä»£è¡¨4ä¸ªå­—èŠ‚ã€‚è¯¥æŒ‡ä»¤ä¼šæŠŠAXï¼ˆç´¯åŠ å™¨å¯„å­˜å™¨ï¼‰ä¸­çš„å†…å®¹ï¼ˆoldï¼‰å’Œç¬¬äºŒä¸ªæ“ä½œæ•°ï¼ˆ0(BX)ï¼‰ä¸­çš„å†…å®¹ï¼ˆptræ‰€æŒ‡å‘çš„æ•°æ®ï¼‰æ¯”è¾ƒã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™æŠŠç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼ˆCXï¼‰ä¸­çš„å†…å®¹ï¼ˆnewï¼‰èµ‹å€¼ç»™ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼ˆ0(BX)ï¼‰ã€‚ SETEQ ret+16(FP) RET è¿™é‡Œï¼ŒSETEQ ä¸CMPXCHGLæ˜¯é…åˆä½¿ç”¨çš„ï¼Œå¦‚æœCMPXCHGLä¸­æ¯”è¾ƒç»“æœæ˜¯ç›¸ç­‰çš„ï¼Œåˆ™è®¾ç½®retï¼ˆå³å‡½æ•°åŸå‹ä¸­çš„swappedï¼‰ä¸º1ï¼Œä¸ç­‰åˆ™è®¾ç½®ä¸º0ã€‚RETä»£è¡¨å‡½æ•°è¿”å›ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:2:2","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"Mutex å…¶å®Mutexçš„åº•å±‚å®ç°ä¹Ÿæ˜¯ä¾èµ–åŸå­æ“ä½œä¸­çš„CASå®ç°çš„ï¼ŒåŸå­æ“ä½œçš„atomicåŒ…ç›¸å½“äºæ˜¯syncåŒ…é‡Œçš„é‚£äº›åŒæ­¥åŸè¯­çš„å®ç°ä¾èµ–ã€‚ func (m *Mutex) Lock() { // Fast path: grab unlocked mutex. if atomic.CompareAndSwapInt32(\u0026m.state, 0, mutexLocked) { if race.Enabled { race.Acquire(unsafe.Pointer(m)) } return } // Slow path (outlined so that the fast path can be inlined) m.lockSlow() } func (m *Mutex) Unlock() { if race.Enabled { _ = m.state race.Release(unsafe.Pointer(m)) } // Fast path: drop lock bit. new := atomic.AddInt32(\u0026m.state, -mutexLocked) if new != 0 { // Outlined slow path to allow inlining the fast path. // To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. m.unlockSlow(new) } } å‚è€ƒæ–‡ç« ï¼š GoåŒæ­¥åŸè¯­çš„åŸºçŸ³ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:2:3","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"äºŒã€atomic.Value åœ¨ Go è¯­è¨€æ ‡å‡†åº“ä¸­ï¼Œsync/atomicåŒ…å°†åº•å±‚ç¡¬ä»¶æä¾›çš„åŸå­æ“ä½œå°è£…æˆäº† Go çš„å‡½æ•°ã€‚ä½†è¿™äº›æ“ä½œåªæ”¯æŒå‡ ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå› æ­¤ä¸ºäº†æ‰©å¤§åŸå­æ“ä½œçš„é€‚ç”¨èŒƒå›´ï¼ŒGo è¯­è¨€åœ¨ 1.4 ç‰ˆæœ¬çš„æ—¶å€™å‘sync/atomicåŒ…ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç±»å‹Valueã€‚æ­¤ç±»å‹çš„å€¼ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥è¢«ç”¨æ¥â€œåŸå­åœ°\"å­˜å‚¨(Store)å’ŒåŠ è½½(Load)ä»»æ„ç±»å‹çš„å€¼ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:3:0","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"åŸå­æ€§ ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåœ¨ CPU æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­çš„ç‰¹æ€§ï¼Œç§°ä¸ºåŸå­æ€§(atomicity)ã€‚è¿™äº›æ“ä½œå¯¹å¤–è¡¨ç°æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œä»–ä»¬è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°ä»–ä»¬åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ã€‚è€Œåœ¨ç°å®ä¸–ç•Œä¸­ï¼ŒCPU ä¸å¯èƒ½ä¸ä¸­æ–­çš„æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ï¼Œèƒ½è®©ä»–ä»¬çš„ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å®£ç§°ä»–ä»¬æ‹¥æœ‰äº†\"ä¸å¯åˆ†å‰²â€çš„åŸå­æ€§ã€‚ ç”±ä¸‹é¢çš„é—®é¢˜å¼•å…¥ atomic.Value. é—® ï¼šä¸€æ¡æ™®é€šçš„èµ‹å€¼è¯­å¥ï¼Œæ˜¯åŸå­æ“ä½œå—ï¼Ÿ æœ‰äº›æœ‹å‹å¯èƒ½ä¸çŸ¥é“ï¼Œåœ¨ Goï¼ˆç”šè‡³æ˜¯å¤§éƒ¨åˆ†è¯­è¨€ï¼‰ä¸­ï¼Œä¸€æ¡æ™®é€šçš„èµ‹å€¼è¯­å¥å…¶å®ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨32ä½æœºå™¨ä¸Šå†™int64ç±»å‹çš„å˜é‡å°±ä¼šæœ‰ä¸­é—´çŠ¶æ€ï¼Œå› ä¸ºå®ƒä¼šè¢«æ‹†æˆä¸¤æ¬¡å†™æ“ä½œï¼ˆMOVï¼‰â€”â€”å†™ä½ 32 ä½å’Œå†™é«˜ 32 ä½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚æœä¸€ä¸ªçº¿ç¨‹åˆšå†™å®Œä½32ä½ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™é«˜32ä½æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–äº†è¿™ä¸ªå˜é‡ï¼Œé‚£å®ƒå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ¯«æ— é€»è¾‘çš„ä¸­é—´å˜é‡ï¼Œè¿™å¾ˆæœ‰å¯èƒ½ä½¿æˆ‘ä»¬çš„ç¨‹åºå‡ºç°è¯¡å¼‚çš„ Bugã€‚ è¿™è¿˜åªæ˜¯ä¸€ä¸ªåŸºç¡€ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ä¸€ä¸ªç»“æ„ä½“è¿›è¡Œèµ‹å€¼ï¼Œé‚£å®ƒå‡ºç°å¹¶å‘é—®é¢˜çš„æ¦‚ç‡å°±æ›´é«˜äº†ã€‚å¾ˆå¯èƒ½å†™çº¿ç¨‹åˆšå†™å®Œä¸€å°åŠçš„å­—æ®µï¼Œè¯»çº¿ç¨‹å°±æ¥è¯»å–è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆå°±åªèƒ½è¯»åˆ°ä»…ä¿®æ”¹äº†ä¸€éƒ¨åˆ†çš„å€¼ã€‚è¿™æ˜¾ç„¶ç ´åäº†å˜é‡çš„å®Œæ•´æ€§ï¼Œè¯»å‡ºæ¥çš„å€¼ä¹Ÿæ˜¯å®Œå…¨é”™è¯¯çš„ã€‚ é¢å¯¹è¿™ç§å¤šçº¿ç¨‹ä¸‹å˜é‡çš„è¯»å†™é—®é¢˜ï¼Œæˆ‘ä»¬çš„ä¸»è§’â€”â€”atomic.Valueç™»åœºäº†ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¸ä¾èµ–äºä¸ä¿è¯å…¼å®¹æ€§çš„unsafe.Pointerç±»å‹ï¼ŒåŒæ—¶åˆèƒ½å°†ä»»æ„æ•°æ®ç±»å‹çš„è¯»å†™æ“ä½œå°è£…æˆåŸå­æ€§æ“ä½œï¼ˆè®©ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§ï¼‰ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:3:1","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"ä½¿ç”¨æ–¹æ³• atomic.Valueç±»å‹å¯¹å¤–æš´éœ²çš„æ–¹æ³•å°±ä¸¤ä¸ªï¼š v.Store(c) - å†™æ“ä½œï¼Œå°†åŸå§‹çš„å˜é‡cå­˜æ”¾åˆ°ä¸€ä¸ªatomic.Valueç±»å‹çš„vé‡Œã€‚ c = v.Load() - è¯»æ“ä½œï¼Œä»çº¿ç¨‹å®‰å…¨çš„vä¸­è¯»å–ä¸Šä¸€æ­¥å­˜æ”¾çš„å†…å®¹ã€‚ ä½¿ç”¨æ—¶ï¼Œåªéœ€**å°†éœ€è¦å¹¶å‘ä¿æŠ¤çš„å˜é‡è¯»å–å’Œèµ‹å€¼æ“ä½œç”¨Load()å’ŒStore()**ä»£æ›¿å°±è¡Œäº†ã€‚ ä¸¾ä¾‹ä¸€ä¸ªç®€å•çš„ä½¿ç”¨åœºæ™¯ï¼šåº”ç”¨ç¨‹åºå®šæœŸçš„ä»å¤–ç•Œè·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œç„¶åæ›´æ”¹è‡ªå·±å†…å­˜ä¸­ç»´æŠ¤çš„é…ç½®å˜é‡ã€‚å·¥ä½œçº¿ç¨‹æ ¹æ®æœ€æ–°çš„é…ç½®æ¥å¤„ç†è¯·æ±‚ã€‚ package main import ( \"sync/atomic\" \"time\" ) func loadConfig() map[string]string { // ä»æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–é…ç½®ä¿¡æ¯ï¼Œç„¶åä»¥mapçš„å½¢å¼å­˜æ”¾åœ¨å†…å­˜é‡Œ return make(map[string]string) } func requests() chan int { // å°†ä»å¤–ç•Œä¸­æ¥å—åˆ°çš„è¯·æ±‚æ”¾å…¥åˆ°channelé‡Œ return make(chan int) } func main() { // configå˜é‡ç”¨æ¥å­˜æ”¾è¯¥æœåŠ¡çš„é…ç½®ä¿¡æ¯ var config atomic.Value // åˆå§‹åŒ–æ—¶ä»åˆ«çš„åœ°æ–¹åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶å­˜åˆ°configå˜é‡é‡Œ config.Store(loadConfig()) go func() { // æ¯10ç§’é’Ÿå®šæ—¶æ‹‰å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”æ›´æ–°åˆ°configå˜é‡é‡Œ for { time.Sleep(10 * time.Second) // å¯¹åº”äºèµ‹å€¼æ“ä½œ config = loadConfig() config.Store(loadConfig()) } }() // åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ä¼šæ ¹æ®å®ƒæ‰€è¯»å–åˆ°çš„æœ€æ–°çš„é…ç½®ä¿¡æ¯æ¥å¤„ç†è¯·æ±‚ for i := 0; i \u003c 10; i++ { go func() { for r := range requests() { // å¯¹åº”äºå–å€¼æ“ä½œ c := config // ç”±äºLoad()è¿”å›çš„æ˜¯ä¸€ä¸ªinterface{}ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¼ºåˆ¶è½¬æ¢ä¸€ä¸‹ c := config.Load().(map[string]string) // è¿™é‡Œæ˜¯æ ¹æ®é…ç½®ä¿¡æ¯å¤„ç†è¯·æ±‚çš„é€»è¾‘... _, _ = r, c } }() } } ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:3:2","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"å®ç°åŸç† æ•°æ®ç»“æ„ atomic.Valueè¢«è®¾è®¡ç”¨æ¥å­˜å‚¨ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨çš„å­—æ®µæ˜¯ä¸€ä¸ªanyç±»å‹(ä¹Ÿå°±æ˜¯interface{})ï¼Œéå¸¸çš„ç®€å•ç²—æš´ã€‚ type Value struct { v any } é™¤äº†Valueå¤–ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œè¿˜å®šä¹‰äº†ä¸€ä¸ªifaceWordsç±»å‹ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªç©ºinterface (interface{}ï¼‰çš„å†…éƒ¨è¡¨ç¤ºæ ¼å¼ï¼ˆå‚è§runtime/runtime2.goä¸­efaceçš„å®šä¹‰ï¼‰ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†interface{}ç±»å‹åˆ†è§£ï¼Œå¾—åˆ°å…¶ä¸­çš„ä¸¤ä¸ªå­—æ®µã€‚ // ifaceWords is interface{} internal representation. type ifaceWords struct { typ unsafe.Pointer data unsafe.Pointer } unsafe.Pointer åœ¨ä»‹ç»å†™å…¥ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ Go è¯­è¨€å†…éƒ¨çš„unsafe.Pointerç±»å‹ã€‚ å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒGo è¯­è¨€å¹¶ä¸æ”¯æŒç›´æ¥æ“ä½œå†…å­˜ï¼Œä½†å®ƒçš„æ ‡å‡†åº“ä¸­åˆæä¾›ä¸€ç§*ä¸å®‰å…¨ï¼ˆä¸ä¿è¯å‘åå…¼å®¹æ€§ï¼‰*çš„æŒ‡é’ˆç±»å‹unsafe.Pointerï¼Œè®©ç¨‹åºå¯ä»¥çµæ´»çš„æ“ä½œå†…å­˜ã€‚ unsafe.Pointerçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºï¼šå®ƒå¯ä»¥ç»•è¿‡ Go è¯­è¨€ç±»å‹ç³»ç»Ÿçš„æ£€æŸ¥ï¼Œä¸ä»»æ„çš„æŒ‡é’ˆç±»å‹äº’ç›¸è½¬æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸¤ç§ç±»å‹å…·æœ‰ç›¸åŒçš„å†…å­˜ç»“æ„ï¼ˆlayoutï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†unsafe.Pointerå½“åšæ¡¥æ¢ï¼Œè®©è¿™ä¸¤ç§ç±»å‹çš„æŒ‡é’ˆç›¸äº’è½¬æ¢ï¼Œä»è€Œå®ç°åŒä¸€ä»½å†…å­˜æ‹¥æœ‰ä¸¤ç§ä¸åŒçš„è§£è¯»æ–¹å¼ã€‚ æ¯”å¦‚è¯´ï¼Œ[]byteå’Œstringå…¶å®å†…éƒ¨çš„å­˜å‚¨ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½† Go è¯­è¨€çš„ç±»å‹ç³»ç»Ÿç¦æ­¢ä»–ä¿©äº’æ¢ã€‚ä»–ä»¬åœ¨è¿è¡Œæ—¶ç±»å‹åˆ†åˆ«è¡¨ç¤ºä¸ºreflect.SliceHeaderå’Œreflect.StringHeaderï¼š type SliceHeader struct { Data uintptr Len int Cap int } type StringHeader struct { Data uintptr Len int } å¦‚æœå€ŸåŠ©unsafe.Pointerï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°åœ¨é›¶æ‹·è´çš„æƒ…å†µä¸‹ï¼Œå°†[]byteæ•°ç»„ç›´æ¥è½¬æ¢æˆstringç±»å‹ã€‚ func main() { bytes := []byte(\"hello\") fmt.Println(bytes) // è¾“å‡º [104 101 108 108 111] p := unsafe.Pointer(\u0026bytes) // å¼ºåˆ¶è½¬æ¢æˆunsafe.Pointerï¼Œç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™ str := *(*string)(p) // ç„¶åå¼ºåˆ¶è½¬æ¢æˆstringç±»å‹çš„æŒ‡é’ˆï¼Œå†å°†è¿™ä¸ªæŒ‡é’ˆçš„å€¼å½“åšstringç±»å‹å–å‡ºæ¥ fmt.Println(str) // è¾“å‡º \"hello\" } å†™å…¥(Store)æ“ä½œ çŸ¥é“äº†unsafe.Pointerçš„ä½œç”¨ï¼Œå°±å¯ä»¥æ¥çœ‹ä»£ç äº†ï¼š func (v *Value) Store(val any) { if val == nil { panic(\"sync/atomic: store of nil value into Value\") } vp := (*ifaceWords)(unsafe.Pointer(v)) vlp := (*ifaceWords)(unsafe.Pointer(\u0026val)) for { typ := LoadPointer(\u0026vp.typ) if typ == nil { // Attempt to start first store. // Disable preemption so that other goroutines can use // active spin wait to wait for completion. runtime_procPin() if !CompareAndSwapPointer(\u0026vp.typ, nil, unsafe.Pointer(\u0026firstStoreInProgress)) { runtime_procUnpin() continue } // Complete first store. StorePointer(\u0026vp.data, vlp.data) StorePointer(\u0026vp.typ, vlp.typ) runtime_procUnpin() return } if typ == unsafe.Pointer(\u0026firstStoreInProgress) { // First store in progress. Wait. // Since we disable preemption around the first store, // we can wait with active spinning. continue } // First store completed. Check type and overwrite data. if typ != vlp.typ { panic(\"sync/atomic: store of inconsistently typed value into Value\") } StorePointer(\u0026vp.data, vlp.data) return } } å¤§æ¦‚çš„é€»è¾‘ï¼š ç¬¬ 5~6 è¡Œ - é€šè¿‡unsafe.Pointerå°†ç°æœ‰çš„å’Œè¦å†™å…¥çš„å€¼åˆ†åˆ«è½¬æˆifaceWordsç±»å‹ï¼Œè¿™æ ·æˆ‘ä»¬ä¸‹ä¸€æ­¥å°±å¯ä»¥å¾—åˆ°è¿™ä¸¤ä¸ªinterface{}çš„åŸå§‹ç±»å‹ï¼ˆtypï¼‰å’ŒçœŸæ­£çš„å€¼ï¼ˆdataï¼‰ã€‚ ä»ç¬¬ 7 è¡Œå¼€å§‹å°±æ˜¯ä¸€ä¸ªæ— é™ for å¾ªç¯ã€‚é…åˆCompareAndSwapä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°ä¹è§‚é”çš„åŠŸæ•ˆã€‚ ç¬¬ 8 è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡LoadPointerè¿™ä¸ªåŸå­æ“ä½œæ‹¿åˆ°å½“å‰Valueä¸­å­˜å‚¨çš„ç±»å‹ã€‚ä¸‹é¢æ ¹æ®è¿™ä¸ªç±»å‹çš„ä¸åŒï¼Œåˆ†3ç§æƒ…å†µå¤„ç†ï¼š ç¬¬ä¸€æ¬¡å†™å…¥ï¼ˆç¬¬9~24è¡Œï¼‰ - ä¸€ä¸ªValueå®ä¾‹è¢«åˆå§‹åŒ–åï¼Œå®ƒçš„typå­—æ®µä¼šè¢«è®¾ç½®ä¸ºæŒ‡é’ˆçš„é›¶å€¼ nilï¼Œæ‰€ä»¥ç¬¬ 9 è¡Œå…ˆåˆ¤æ–­ï¼Œå¦‚æœtypæ˜¯ nilï¼Œé‚£å°±è¯æ˜è¿™ä¸ªValueè¿˜æœªè¢«å†™å…¥è¿‡æ•°æ®ã€‚é‚£ä¹‹åå°±æ˜¯ä¸€æ®µåˆå§‹å†™å…¥çš„æ“ä½œï¼š runtime_procPin()æ˜¯runtimeä¸­çš„ä¸€æ®µå‡½æ•°ï¼Œå…·ä½“çš„åŠŸèƒ½æˆ‘ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–‡æ¡£ã€‚è¿™é‡ŒçŒœæµ‹ä¸€ä¸‹ï¼Œä¸€æ–¹é¢å®ƒç¦æ­¢äº†è°ƒåº¦å™¨å¯¹å½“å‰ goroutine çš„æŠ¢å ï¼ˆpreemptionï¼‰ï¼Œä½¿å¾—å®ƒåœ¨æ‰§è¡Œå½“å‰é€»è¾‘çš„æ—¶å€™ä¸è¢«æ‰“æ–­ï¼Œä»¥ä¾¿å¯ä»¥å°½å¿«åœ°å®Œæˆå·¥ä½œï¼Œå› ä¸ºåˆ«äººä¸€ç›´åœ¨ç­‰å¾…å®ƒã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨ç¦æ­¢æŠ¢å æœŸé—´ï¼ŒGC çº¿ç¨‹ä¹Ÿæ— æ³•è¢«å¯ç”¨ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ GC çº¿ç¨‹çœ‹åˆ°ä¸€ä¸ªè«åå…¶å¦™çš„æŒ‡å‘^uintptr(0)çš„ç±»å‹ï¼ˆè¿™æ˜¯èµ‹å€¼è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€ï¼‰ã€‚ ä½¿ç”¨CASæ“ä½œï¼Œå…ˆå°è¯•å°†typè®¾ç½®ä¸º^uintptr(0)è¿™ä¸ªä¸­é—´çŠ¶æ€ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¯æ˜å·²ç»æœ‰åˆ«çš„çº¿ç¨‹æŠ¢å…ˆå®Œæˆäº†èµ‹å€¼æ“ä½œï¼Œé‚£å®ƒå°±è§£é™¤æŠ¢å é”ï¼Œç„¶åé‡æ–°å›åˆ° for å¾ªç¯ç¬¬ä¸€æ­¥ã€‚ å¦‚æœè®¾ç½®æˆåŠŸï¼Œé‚£è¯æ˜å½“å‰çº¿ç¨‹æŠ¢åˆ°äº†è¿™ä¸ª\"ä¹è§‚é”\"ï¼Œå®ƒå¯ä»¥å®‰å…¨çš„æŠŠvè®¾ä¸ºä¼ å…¥çš„æ–°å€¼äº†ï¼ˆ19~23è¡Œï¼‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯å…ˆå†™dataå­—æ®µï¼Œç„¶åå†å†™typå­—æ®µã€‚å› ä¸ºæˆ‘ä»¬æ˜¯ä»¥typå­—æ®µçš„å€¼ä½œä¸ºå†™å…¥å®Œæˆä¸å¦çš„åˆ¤æ–­ä¾æ®çš„ã€‚ ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æœªå®Œæˆï¼ˆç¬¬25~30è¡Œï¼‰- å¦‚æœçœ‹åˆ° typå­—æ®µè¿˜æ˜¯^uintptr(0)è¿™ä¸ªä¸­é—´ç±»å‹ï¼Œè¯æ˜åˆšåˆšçš„ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å®Œæˆï¼Œæ‰€ä»¥å®ƒä¼šç»§ç»­å¾ªç¯ï¼Œâ€œå¿™ç­‰\"åˆ°ç¬¬ä¸€æ¬¡å†™å…¥å®Œæˆã€‚ ç¬¬ä¸€æ¬¡å†™å…¥å·²å®Œæˆï¼ˆç¬¬31è¡ŒåŠä¹‹åï¼‰ - é¦–å…ˆæ£€æŸ¥ä¸Šä¸€æ¬¡å†™å…¥çš„ç±»å‹ä¸è¿™ä¸€æ¬¡è¦å†™å…¥çš„ç±»å‹æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚åä¹‹ï¼Œåˆ™ç›´æ¥æŠŠè¿™ä¸€æ¬¡è¦å†™å…¥çš„å€¼å†™å…¥åˆ°dataå­—æ®µã€‚ è¿™ä¸ªé€»è¾‘çš„ä¸»è¦æ€æƒ³å°±æ˜¯ï¼šä¸ºäº†å®Œæˆå¤šä¸ªå­—æ®µçš„åŸå­æ€§å†™å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠ“ä½å…¶ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œä»¥å®ƒçš„çŠ¶æ€æ¥æ ‡å¿—æ•´ä¸ªåŸå­å†™å…¥çš„çŠ¶æ€ã€‚ è¯»å–(Load)æ“ä½œ // Load returns the value set by the most recent Store. // It returns nil if there has been no call to Store for this Value. func (v *Value) Load() (val any) { vp := (*ifaceWords)(unsafe.Pointer(v)) typ := LoadPointer(\u0026vp.typ) if typ == nil || typ == unsafe.Pointer(\u0026firstStoreInProgress) { // First store not yet completed. return nil } data := LoadPointer(\u0026vp.data) vlp := (*ifaceWords)(unsafe.Pointer(\u0026val)) vlp.typ = typ vlp.data = data return } è¯»å–ç›¸å¯¹å°±ç®€å•å¾ˆå¤šäº†ï¼Œå®ƒæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š å¦‚æœå½“å‰çš„typæ˜¯ nil æˆ–è€…^uintptr(0)ï¼Œé‚£å°±è¯æ˜ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å¼€å§‹ï¼Œæˆ–è€…è¿˜æ²¡å®Œæˆï¼Œé‚£å°±ç›´æ¥è¿”å› nil ï¼ˆä¸å¯¹å¤–æš´éœ²ä¸­é—´çŠ¶æ€ï¼‰ã€‚ å¦åˆ™ï¼Œæ ¹æ®å½“å‰çœ‹åˆ°çš„typå’Œdataæ„é€ å‡ºä¸€ä¸ªæ–°çš„interface{}è¿”å›å‡ºå»ã€‚ å‚è€ƒæ–‡ç« ï¼š Go è¯­è¨€æ ‡å‡†åº“ä¸­ atomic.Value çš„å‰ä¸–ä»Šç”Ÿ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:3:3","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"é¢è¯•é¢˜ é—®ï¼šåŸå­æ“ä½œå’Œé”çš„åŒºåˆ«ï¼Ÿâ­ åŸå­æ“ä½œç”±åº•å±‚ç¡¬ä»¶æ”¯æŒï¼Œè€Œé”åˆ™ç”±æ“ä½œç³»ç»Ÿçš„è°ƒåº¦å™¨å®ç°ï¼› é”åº”å½“ç”¨æ¥ä¿æŠ¤ä¸€æ®µé€»è¾‘ï¼ŒåŸå­æ“ä½œç”¨æ¥å¯¹ä¸€ä¸ªå˜é‡çš„æ›´æ–°ä¿æŠ¤ï¼Œå¦‚æœè¦æ›´æ–°çš„æ˜¯ä¸€ä¸ªå¤åˆå¯¹è±¡ï¼Œåˆ™åº”å½“ä½¿ç”¨atomic.Valueå°è£…å¥½çš„å®ç°ã€‚ é—®ï¼šCAS åº•å±‚å®ç°åŸç†ï¼Ÿâ­ ä»æ€æƒ³æ–¹é¢ï¼Œä»æ±‡ç¼–ä»£ç æ–¹é¢å›ç­”ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/:4:0","tags":["Go","åŒæ­¥","é”","å¹¶å‘ç¼–ç¨‹"],"title":"Goæµ…æ-Atomic","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-atomic/"},{"categories":["Go"],"content":"[toc] å‚è€ƒæ–‡ç« ï¼š Golang Channel å®ç°åŸç† ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:0:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"ä¸€ã€æ ¸å¿ƒæ•°æ®ç»“æ„ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:1:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"1.1 hchan type hchan struct { qcount uint // total data in the queue dataqsiz uint // size of the circular queue buf unsafe.Pointer // points to an array of dataqsiz elements elemsize uint16 closed uint32 elemtype *_type // element type sendx uint // send index recvx uint // receive index recvq waitq // list of recv waiters sendq waitq // list of send waiters lock mutex } qcountï¼šå½“å‰ channel ä¸­å­˜åœ¨å¤šå°‘ä¸ªå…ƒç´ ï¼› dataqsize: å½“å‰ channel èƒ½å­˜æ”¾çš„å…ƒç´ å®¹é‡ï¼› bufï¼šchannel ä¸­ç”¨äºå­˜æ”¾å…ƒç´ çš„ç¯å½¢ç¼“å†²åŒºï¼› elemsizeï¼šchannel å…ƒç´ ç±»å‹çš„å¤§å°ï¼› closedï¼šæ ‡è¯† channel æ˜¯å¦å…³é—­ï¼› elemtypeï¼šchannel å…ƒç´ ç±»å‹ï¼› sendxï¼šå‘é€å…ƒç´ è¿›å…¥ç¯å½¢ç¼“å†²åŒºçš„ indexï¼› recvxï¼šæ¥æ”¶å…ƒç´ æ‰€å¤„çš„ç¯å½¢ç¼“å†²åŒºçš„ indexï¼› recvqï¼šå› æ¥æ”¶è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼› sendqï¼šå› å‘é€è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼› ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:1:1","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"1.2 waitq type waitq struct { first *sudog last *sudog } waitqï¼šé˜»å¡çš„åç¨‹é˜Ÿåˆ— firstï¼šé˜Ÿåˆ—å¤´éƒ¨ lastï¼šé˜Ÿåˆ—å°¾éƒ¨ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:1:2","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"1.3 sudog type sudog struct { g *g next *sudog prev *sudog elem unsafe.Pointer // data element (may point to stack) isSelect bool c *hchan } sudogï¼šç”¨äºåŒ…è£…åç¨‹çš„èŠ‚ç‚¹ gï¼šgoroutineï¼Œåç¨‹ï¼› nextï¼šé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼› prevï¼šé˜Ÿåˆ—ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼› elem: è¯»å–/å†™å…¥ channel çš„æ•°æ®çš„å®¹å™¨; isSelectï¼šæ ‡è¯†å½“å‰åç¨‹æ˜¯å¦å¤„åœ¨ select å¤šè·¯å¤ç”¨çš„æµç¨‹ä¸­ï¼› cï¼šæ ‡è¯†ä¸å½“å‰ sudog äº¤äº’çš„ chan. ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:1:3","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"äºŒã€ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:2:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"é¢è¯•é¢˜ é—®ï¼šè¦æ±‚å®ç°ä¸€ä¸ª mapï¼š æ”¯æŒé«˜å¹¶å‘ï¼› åªå­˜åœ¨æ’å…¥å’ŒæŸ¥è¯¢æ“ä½œ O(1)ï¼› æŸ¥è¯¢æ—¶ï¼Œè‹¥ key å­˜åœ¨ï¼Œç›´æ¥è¿”å› valï¼›è‹¥ key ä¸å­˜åœ¨ï¼Œé˜»å¡ç›´åˆ° key-val è¢«æ”¾å…¥åï¼Œè·å– val è¿”å›ï¼›ç­‰å¾…æŒ‡å®šæ—¶é•¿ä»æœªæ”¾å…¥ï¼Œå°±è¿”å›è¶…æ—¶é”™è¯¯ï¼› ä¸èƒ½æœ‰æ­»é”æˆ–è€… panic é£é™©ã€‚ ","date":"2023-02-18","objectID":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/:3:0","tags":["Go","å¹¶å‘ç¼–ç¨‹","åŒæ­¥"],"title":"Goæµ…æ-Channel","uri":"/go%E6%A0%87%E5%87%86%E5%BA%93-channel/"},{"categories":["Go"],"content":"Goå®è·µæ“ä½œ [toc] ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:0:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"äºŒã€åŸºç¡€ è®°å½•é‡åˆ°çš„é—®é¢˜ï¼š å½“ä½¿ç”¨go getå®‰è£…åŒ…ä¹‹åï¼Œåœ¨pkgä¸­ä¹Ÿå¯æ‰¾åˆ°ï¼Œä½†è¿˜æ˜¯æ— æ³•ä½¿ç”¨ï¼Œæ˜¾ç¤ºunresolvedã€‚è¿™å…¶å®æ˜¯å› ä¸ºä½ çš„é¡¹ç›®æ²¡æœ‰external librariesï¼Œæ‰€ä»¥go getæˆ–go buildçš„åŒ…æ— æ³•åœ¨å½“å‰ç›®å½•æ‰¾åˆ°ï¼Œåªéœ€è¦ï¼š ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"1. ç»“æ„ä½“ ç»“æ„ä½“å˜é‡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ï¼š ç»“æ„ä½“çš„æ‰€æœ‰å­—æ®µåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ã€‚ 2022/01/24 çœ‹åˆ«çš„è§†é¢‘ æ¥å£ä¸å¤šæ€ å¤šæ€ï¼š ä¸åŒçš„ç±»æ‹¥æœ‰åŒåçš„æ–¹æ³•ï¼Œæ–¹æ³•æœ‰æ‰€ä¸åŒã€‚åŒä¸€ä¸ªè¯­å¥ ä¸åŒç±»å‹çš„å¯¹è±¡å¯ä»¥è°ƒç”¨å„è‡ªç±»å‹çš„æ–¹æ³•è¾“å‡ºä¸åŒçš„ç»“æœ **æ¥å£ï¼š ** é¿å…ä¸å¿…è¦çš„ä¿¡æ¯æ³„éœ² åªèƒ½è°ƒç”¨æ¥å£ä¸­æœ‰çš„æ–¹æ³• ä¸èƒ½è°ƒç”¨åŸå¯¹è±¡æ‹¥æœ‰çš„æ–¹æ³• ç»™ä¸€ä¸ªæ¥å£èµ‹å€¼çš„æ—¶å€™ éœ€è¦é‡‡ç”¨æŒ‡é’ˆ // å®šä¹‰ä¸€ä¸ªæ¥å£ æ³¨æ„ç±»å‹æ˜¯ interface type IAttack interface { // æ¥å£å‡½æ•°å¯ä»¥æœ‰å¤šä¸ª ä½†æ˜¯åªèƒ½æœ‰å‡½æ•°åŸå‹ ä¸å¯ä»¥æœ‰å®ç° Attack() } // ä½¿ç”¨æ¥å£ var player IAttack // å®šä¹‰ä¸€ä¸ªåŒ…å«Attackçš„æ¥å£å˜é‡ // å¯¹playerèµ‹å€¼ä¸ºlowLevel æ¥å£éœ€è¦ä½¿ç”¨æŒ‡é’ˆç±»å‹æ¥èµ‹å€¼ æ¥å£åªèƒ½è®¿é—®æ¥å£ä¸­çš„æ–¹æ³• player = \u0026lowlevel å¸¸é‡ åŸºç¡€ä»‹ç»ï¼š å¸¸é‡ä½¿ç”¨ const ä¿®é¥° å¸¸é‡åœ¨å®šä¹‰çš„æ—¶å€™å¿…é¡»åˆå§‹åŒ– å¸¸é‡ä¸€ç»å®šä¹‰å°±ä¸èƒ½ä¿®æ”¹ å¸¸é‡åªèƒ½ä¿®é¥°boolã€æ•°å€¼ç±»å‹(int, floatç­‰)ã€stringç±»å‹ é€šè¿‡å¤§å°å†™æ§åˆ¶å¸¸é‡çš„è®¿é—®èŒƒå›´ è¯­æ³•ï¼šconst å¸¸é‡å å¸¸é‡type = value å†™æ³•ï¼š 1. æ¯”è¾ƒç®€æ´çš„å†™æ³• const ( a = 1 b = 1 ) 2. æ›´ä¸“ä¸š const ( a = iota // è¡¨ç¤ºç»™ a èµ‹å€¼ä¸º 0ï¼Œ b åœ¨ a çš„åŸºç¡€ä¸Š +1ï¼Œc åœ¨ b çš„åŸºç¡€ä¸Š +1 b c ) func main() { const ( a = iota b c ) fmt.Println(a, b, c) // 0, 1, 2 } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"2. æ¥å£ æ ¸å¿ƒä¸­çš„æ ¸å¿ƒã€‚ ç±»ä¼¼äºå¤šæ€ã€‚ åŸºæœ¬è¯­æ³•ï¼š // å®šä¹‰ä¸€ä¸ªæ¥å£ type æ¥å£å interface { method1(å‚æ•°åˆ—è¡¨) è¿”å›å€¼åˆ—è¡¨ method2(å‚æ•°åˆ—è¡¨) è¿”å›å€¼åˆ—è¡¨ } // å®ç°æ¥å£ func (t è‡ªå®šä¹‰ç±»å‹) method1(å‚æ•°åˆ—è¡¨) è¿”å›å€¼åˆ—è¡¨ { // æ–¹æ³•å®ç° } func (t è‡ªå®šä¹‰ç±»å‹) method2(å‚æ•°åˆ—è¡¨) è¿”å›å€¼åˆ—è¡¨ { // æ–¹æ³•å®ç° } æ³¨ï¼šinterfaceä¸èƒ½åŒ…æ‹¬ä»»ä½•å˜é‡ // ç¤ºä¾‹ï¼š type Usb interface { Start() Stop() } // Phone 2. Phoneå®ç°Usbæ¥å£æ–¹æ³• type Phone struct { } func (p Phone) Start() { fmt.Println(\"Phoneå¼€å§‹å·¥ä½œ...\") } func (p Phone) Stop() { fmt.Println(\"Phoneåœæ­¢å·¥ä½œ...\") } æ³¨ï¼šgolangä¸­çš„æ¥å£ä¸éœ€è¦æ˜¾å¼å®ç°ã€‚åªè¦ä¸€ä¸ªå˜é‡ï¼ˆç»“æ„ä½“ï¼‰ï¼Œå«æœ‰æ¥å£ç±»å‹ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±å®ç°äº†è¿™ä¸ªæ¥å£ã€‚ã€‚å› æ­¤ï¼Œgolangä¸­æ²¡æœ‰Javaä¸­çš„implementå…³é”®å­—ã€‚ æ‰€æœ‰ç±»å‹éƒ½å®ç°äº†ç©ºæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»»ä½•ä¸€ä¸ªå˜é‡èµ‹ç»™ç©ºæ¥å£ã€‚ æ¥å£vsç»§æ‰¿ æ¥å£å¯çœ‹ä½œæ˜¯ç»§æ‰¿çš„ä¸€ç§è¡¥å……ã€‚ç»“æ„ä½“æ˜¯ä¸ªä½“çš„æŠ½è±¡ï¼Œæ¥å£æ˜¯è¡Œä¸ºçš„æŠ½è±¡ã€‚ æ¥å£å’Œç»§æ‰¿è§£å†³çš„é—®é¢˜ä¸åŒï¼š **ç»§æ‰¿ï¼š**è§£å†³ä»£ç çš„å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ **æ¥å£ï¼š**è®¾è®¡ï¼Œè®¾è®¡å¥½å„ç§è§„èŒƒï¼ˆæ–¹æ³•ï¼‰ï¼Œè®©å…¶ä»–è‡ªå®šä¹‰ç±»å‹å»å®ç°è¿™äº›æ–¹æ³•ã€‚ æ¥å£æ¯”ç»§æ‰¿æ›´åŠ çµæ´»ï¼Œç»§æ‰¿æ˜¯æ»¡è¶³ is a çš„å…³ç³»ï¼Œè€Œæ¥å£åªéœ€æ»¡è¶³ like a çš„å…³ç³»ã€‚ æ¥å£åœ¨ä¸€å®šç¨‹åº¦å®ç°ä»£ç è§£è€¦ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"3. å¤šæ€ Goä¸­çš„å¤šæ€é€šè¿‡æ¥å£å®ç°ã€‚å¯ä»¥æŒ‰ç…§ç»Ÿä¸€çš„æ¥å£æ¥è°ƒç”¨ä¸åŒçš„å®ç°ï¼Œè¿™æ—¶æ¥å£å˜é‡å°±å‘ˆç°ä¸åŒçš„å½¢æ€ã€‚æ¯”å¦‚ï¼šä¸åŒç»“æ„ä½“çš„æ’åºã€‚ 3.1 æ¥å£ä½“ç°å¤šæ€çš„ä¸¤ç§å½¢å¼ å¤šæ€å‚æ•° æ¯”å¦‚ä¸åŒç»“æ„ä½“çš„æ’åºã€‚ å¤šæ€æ•°ç»„ ä¸€ä¸ªæ¥å£æ•°ç»„ï¼Œå¯ä»¥å­˜æ”¾ä¸åŒçš„ç»“æ„ä½“å¯¹è±¡ã€‚ 3.2 ç±»å‹æ–­è¨€ **ç±»å‹æ–­è¨€ï¼š**ç”±äºä¸€ä¸ªæ¥å£æ˜¯ä¸€èˆ¬ç±»å‹ï¼Œä¸çŸ¥é“å…·ä½“ç±»å‹ï¼Œå¦‚æœè¦è½¬æˆå…·ä½“ç±»å‹ï¼Œå°±éœ€è¦ä½¿ç”¨ç±»å‹æ–­è¨€ã€‚ type Point struct { x int y int } func main() { var a interface{} point := Point{1, 2} a = point var b Point // è¿™æ ·æ˜¯ä¸å¯ä»¥çš„ //b = a // ç±»å‹æ–­è¨€ b = a.(Point) fmt.Println(b) } b = a.(Point) å°±æ˜¯ç±»å‹æ–­è¨€ï¼Œè¡¨ç¤ºåˆ¤æ–­aæ˜¯å¦æŒ‡å‘Pointç±»å‹çš„å˜é‡ï¼Œå¦‚æœæ˜¯å°±è½¬æˆPointç±»å‹å¹¶èµ‹ç»™bå˜é‡ï¼Œå¦åˆ™æŠ¥é”™ã€‚ å¸¦æ£€æµ‹æœºåˆ¶çš„ç±»å‹æ–­è¨€ï¼š b, ok := a.(Point) if ok { fmt.Println(b) } else { fmt.Println(\"ç±»å‹æ–­è¨€å‡ºé”™ï¼\") } ç±»å‹æ–­è¨€å®è·µï¼š func typeJudge(items ...interface{}) { for index, x := range items { // ç±»å‹æ–­è¨€ switch x.(type) { case bool: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯boolç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) case float64: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯float64ç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) case float32: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯float32ç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) case int, int32, int64: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯intç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) case string: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯stringç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) default: fmt.Printf(\"ç¬¬%vä¸ªå‚æ•°æ˜¯ ä¸ç¡®å®š ç±»å‹ï¼Œå€¼æ˜¯%v\\n\", index, x) } } } func main() { var n1 float32 = 1.1 var n2 float64 = 2.2 var n3 int32 = 3 n4 := \"åŒ—äº¬\" n5 := 300 var n6 string = \"nihao\" typeJudge(n1, n2, n3, n4, n5, n6) } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"4. æ–‡ä»¶æ“ä½œ 4.1 åŸºæœ¬ä»‹ç» os.File å°è£…æ‰€æœ‰æ–‡ä»¶ç›¸å…³æ“ä½œï¼ŒFile æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚ æ‰“å¼€æ–‡ä»¶ os.Open() file, err := os.Open(\"./test.txt\") if err != nil { fmt.Println(err) } å…³é—­æ–‡ä»¶ fileå¯¹è±¡.Close() file å…¶å®æ˜¯ä¸ªæŒ‡é’ˆã€‚ err = file.Close() if err != nil { fmt.Println(err) } è¯»æ–‡ä»¶ å¸¦ç¼“å†² ä¸å¸¦ç¼“å†² ioutil.ReadFileä¸€æ¬¡æ€§è¯»å–ï¼š file := \"./test.txt\" content, err := ioutil.ReadFile(file) if err != nil { fmt.Println(\"read file err = \", err) } fmt.Println(string(content)) // è¯»å–å†…å®¹ä¸º[]byte // æ²¡æœ‰æ˜¾å¼openæ–‡ä»¶ï¼Œæ­¤å¤„ä¹Ÿä¸å¿…closeï¼Œå› ä¸ºæ–‡ä»¶çš„openå’Œcloseè¢«å°è£…åˆ°äº†ReadFileä¸­ // è¿™ç§æ–¹å¼å¾ˆç®€æ´ï¼Œä½†æ–‡ä»¶å¾ˆå¤§çš„æ—¶å€™ï¼Œå°†ä¼šæ•ˆç‡å¾ˆä½ï¼Œå› ä¸ºæ˜¯ä¸€æ¬¡è¯»å–æ‰€æœ‰å†…å®¹ å†™æ–‡ä»¶ func OpenFile(name string, flag int, perm FileMode) (file *File, err error) å…¶ä¸­ï¼ŒnameæŒ‡å®šæ–‡ä»¶ï¼Œflagä»£è¡¨æ‰“å¼€æ¨¡å¼ï¼ˆå¯ä»¥ç»„åˆï¼‰ï¼Œpermæƒé™æ§åˆ¶ï¼ˆunixï¼‰ const ( O_RDONLY int = syscall.O_RDONLY // åªè¯»æ¨¡å¼æ‰“å¼€æ–‡ä»¶ O_WRONLY int = syscall.O_WRONLY // åªå†™æ¨¡å¼æ‰“å¼€æ–‡ä»¶ O_RDWR int = syscall.O_RDWR // è¯»å†™æ¨¡å¼æ‰“å¼€æ–‡ä»¶ O_APPEND int = syscall.O_APPEND // å†™æ“ä½œæ—¶å°†æ•°æ®é™„åŠ åˆ°æ–‡ä»¶å°¾éƒ¨ O_CREATE int = syscall.O_CREAT // å¦‚æœä¸å­˜åœ¨å°†åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ O_EXCL int = syscall.O_EXCL // å’ŒO_CREATEé…åˆä½¿ç”¨ï¼Œæ–‡ä»¶å¿…é¡»ä¸å­˜åœ¨ O_SYNC int = syscall.O_SYNC // æ‰“å¼€æ–‡ä»¶ç”¨äºåŒæ­¥I/O O_TRUNC int = syscall.O_TRUNC // å¦‚æœå¯èƒ½ï¼Œæ‰“å¼€æ—¶æ¸…ç©ºæ–‡ä»¶ ) å®ä¾‹ï¼š åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå†™å…¥ 5 å¥ hello, world!. func writeNew() { // 1. æ‰“å¼€æ–‡ä»¶ filePath := \"testOpen.txt\" file, _ := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, 0666) // 2. å†™å…¥ str := \"hello, world!\\n\" // å¸¦ç¼“å­˜çš„ *Writter writer := bufio.NewWriter(file) for i := 0; i \u003c 5; i++ { writer.WriteString(str) } // å› ä¸ºwritteræ˜¯å¸¦ç¼“å­˜çš„ï¼Œå› æ­¤åœ¨è°ƒç”¨WritterStringæ—¶ï¼Œ // å…¶å®å†…å®¹æ˜¯å…ˆå†™åˆ°ç¼“å­˜çš„ ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨Flushæ–¹æ³•å°†ç¼“å­˜çš„æ•°æ®ï¼Œ // çœŸæ­£å†™åˆ°ç£ç›˜ writer.Flush() } åœ¨å·²å­˜åœ¨æ–‡ä»¶åï¼Œè¿½åŠ  hello, JY!. func writeAppend() { // 1. æ‰“å¼€æ–‡ä»¶ filePath := \"testOpen.txt\" file, _ := os.OpenFile(filePath, os.O_WRONLY|os.O_APPEND, 0666) // 2. å†™å…¥ str := \"hello, JY!\\r\\n\" // å¸¦ç¼“å­˜çš„ *Writter writer := bufio.NewWriter(file) for i := 0; i \u003c 5; i++ { writer.WriteString(str) } // å› ä¸ºwritteræ˜¯å¸¦ç¼“å­˜çš„ï¼Œå› æ­¤åœ¨è°ƒç”¨WritterStringæ—¶ï¼Œ // å…¶å®å†…å®¹æ˜¯å…ˆå†™åˆ°ç¼“å­˜çš„ ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨Flushæ–¹æ³•å°†ç¼“å­˜çš„æ•°æ®ï¼Œ // çœŸæ­£å†™åˆ°ç£ç›˜ writer.Flush() } æ³¨æ„ï¼Œåªæ˜¯æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ä¸åŒã€‚ è¾¹è¯»è¾¹è¿½åŠ  func writeAndRead() { // 1. æ‰“å¼€æ–‡ä»¶ filePath := \"testOpen.txt\" file, _ := os.OpenFile(filePath, os.O_RDWR|os.O_APPEND, 0666) defer file.Close() // 2. å…ˆè¯»å–åŸæ¥çš„å†…å®¹å¹¶æ˜¾ç¤ºåœ¨ç»ˆç«¯ reader := bufio.NewReader(file) for { str, err := reader.ReadString('\\n') if err == io.EOF { // è‹¥è¯»å–åˆ°æ–‡ä»¶æœ«å°¾ break } fmt.Print(str) // æ‰“å° } // 3. è¿½åŠ  str := \"ä½ å¥½, JY!\\r\\n\" // å¸¦ç¼“å­˜çš„ *Writter writer := bufio.NewWriter(file) for i := 0; i \u003c 5; i++ { writer.WriteString(str) } // å› ä¸ºwritteræ˜¯å¸¦ç¼“å­˜çš„ï¼Œå› æ­¤åœ¨è°ƒç”¨WritterStringæ—¶ï¼Œ // å…¶å®å†…å®¹æ˜¯å…ˆå†™åˆ°ç¼“å­˜çš„ ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨Flushæ–¹æ³•å°†ç¼“å­˜çš„æ•°æ®ï¼Œ // çœŸæ­£å†™åˆ°ç£ç›˜ writer.Flush() } åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ è‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼š func PathExists(path string) (bool, error) { _, err := os.Stat(path) if err != nil { // æ–‡ä»¶ç›®å½•å­˜åœ¨ return true, nil } if os.IsNotExist(err) { return false, err } return false, err } æ‹·è´æ–‡ä»¶ å°†ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶å†…å®¹å†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ // å°†file1çš„å†…å®¹å¤åˆ¶åˆ°file2 func readAndWrite() { file1Path := \"./test.txt\" file2Path := \"./testOpen.txt\" data, err := ioutil.ReadFile(file1Path) if err != nil { fmt.Println(\"read file err = \", err) return } err = ioutil.WriteFile(file2Path, data, 0666) if err != nil { fmt.Println(\"write file err = \", err) return } } æ‹·è´è§†é¢‘ç­‰ func Copy(dst Writer, src Reader) (written int64, err error) func copyFile(srcFileName, dstFileName string) (int64, error) { srcFile, err := os.Open(srcFileName) if err != nil { fmt.Println(\"open file err = \", err) return 0, err } defer srcFile.Close() dstFile, err := os.OpenFile(dstFileName, os.O_WRONLY|os.O_CREATE, 0666) if err != nil { fmt.Println(\"open file err = \", err) return 0, err } defer dstFile.Close() // æ‹¿åˆ°readerå’Œwriter reader := bufio.NewReader(srcFile) writer := bufio.NewWriter(dstFile) // copy return io.Copy(writer, reader) } 4.2 å®ä¾‹ ç»Ÿè®¡æ–‡ä»¶ä¸­æœ‰å¤šå°‘ä¸ªè‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼å’Œå…¶ä»–å­—ç¬¦ func fileCount(fileName string) (Record, error) { /* 1. æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ›å»ºreader 2. é€è¡Œç»Ÿè®¡ 3. è®°å½•åœ¨ç»“æ„ä½“ */ file, err := os.Open(fileName) if err != nil { fmt.Println(\"open file err = \", err) return Record{}, err } defer file.Close() record := Record{} reader := bufio.NewReader(file) for { str, err := reader.ReadString('\\n') // ä¸ºäº†å…¼å®¹ä¸­æ–‡ï¼Œå¯ä»¥å°†stringè½¬[]rune // éå†strï¼Œè¿›è¡Œç»Ÿè®¡ for _, v := range str { switch { case 'a' \u003c= v \u0026\u0026 v \u003c= 'z': fallthrough // ç©¿é€ case 'A' \u003c= v \u0026\u0026 v \u003c= 'Z': record.CharCount++ case v == ' ' || v == '\\t': record.SpaceCount++ case '0' \u003c= v \u0026\u0026 v \u003c= ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5. flag è§£æå‘½ä»¤è¡Œå‚æ•° func parseCommand() { // 1. å®šä¹‰å‡ ä¸ªå˜é‡ç”¨æ¥å­˜æ”¾å‘½ä»¤è¡Œå‚æ•° var ( user string pwd string host string port int ) // 2. è½¬æ¢ /* \u0026user: æ¥æ”¶ç”¨æˆ·å‘½ä»¤è¡Œè¾“å…¥çš„ -u åé¢çš„å‚æ•°å€¼ \"u\": -u æŒ‡å®šå‚æ•° \"\": é»˜è®¤å‚æ•° \"ç”¨æˆ·åï¼Œé»˜è®¤ä¸ºç©º\": è¯´æ˜ */ flag.StringVar(\u0026user, \"u\", \"\", \"ç”¨æˆ·åï¼Œé»˜è®¤ä¸ºç©º\") flag.StringVar(\u0026pwd, \"pwd\", \"\", \"å¯†ç ï¼Œé»˜è®¤ä¸ºç©º\") flag.StringVar(\u0026host, \"h\", \"localhost\", \"ä¸»æœºåï¼Œé»˜è®¤ä¸ºlocalhost\") flag.IntVar(\u0026port, \"port\", 3306, \"ç«¯å£å·ï¼Œé»˜è®¤ä¸º3306\") flag.Parse() // ä¸€å®šè¦è°ƒç”¨ // 3. è¾“å‡ºç»“æœ fmt.Printf(\"user=%v pwd=%v host=%v port=%v\", user, pwd, host, port) } $ go run 06-flag.go -u root -pwd 123456 -h 127.0.0.1 -port 3300 user=root pwd=123456 host=127.0.0.1 port=3300 $ go run 06-flag.go -u root -pwd 123456 user=root pwd=123456 host=localhost port=3306 ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:5","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"6. json 6.1 åŸºç¡€ä½¿ç”¨ è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œæ˜“äºæœºå™¨è§£æï¼Œå¯æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚é€šå¸¸åœ¨ç½‘ç»œä¼ è¾“æ—¶ä¼šå…ˆå°†æ•°æ®ï¼ˆæ•°æ®ç»“æ„ã€mapç­‰ï¼‰åºåˆ—åŒ–æˆjsonå­—ç¬¦ä¸²ï¼Œåˆ°æ¥æ”¶æ–¹å¾—åˆ°jsonå­—ç¬¦ä¸²æ—¶ï¼Œå†ååºåˆ—åŒ–æˆåŸæ¥çš„æ•°æ®æ ¼å¼ï¼ˆæ•°æ®ç»“æ„ã€mapç­‰ï¼‰ã€‚ åº”ç”¨åœºæ™¯ï¼š 6.2 åºåˆ—åŒ– å°†æ•°æ®ç»“æ„åºåˆ—åŒ–ä¸ºjsonæ ¼å¼ã€‚ /* 1. å°†ç»“æ„ä½“åºåˆ—åŒ– 2. å°†mapåºåˆ—åŒ– 3. å¯¹Sliceåºåˆ—åŒ– 4. å¯¹åŸºæœ¬æ•°æ®ç±»å‹è¿›è¡Œåºåˆ—åŒ–ï¼ˆæ„ä¹‰ä¸å¤§ï¼‰ */ data, err := json.Marshal() 6.3 tagçš„ä½¿ç”¨ **åŸç†ï¼š**åˆ©ç”¨reflectæœºåˆ¶ã€‚ **ç›®çš„ï¼š**å¦‚æœæˆ‘ä»¬å¸Œæœ›åºåˆ—åŒ–åkeyçš„åå­—æ˜¯æŒ‡å®šçš„åå­—ï¼Œ**åŒæ—¶ä¸å—goçš„å‘½åé™åˆ¶ï¼Œ**å¯ä»¥æŒ‡å®štagæ ‡ç­¾ã€‚ type Monster struct { Name string `json:\"name\" ` Age int `json:\"age\" ` Birthday string `json:\"birthday\"` Salary float64 `json:\"salary\"` Skill string `json:\"skill\"` } // 1. å°†ç»“æ„ä½“åºåˆ—åŒ– type Monster struct { Name string `json:\"name\" ` Age int `json:\"age\" ` Birthday string `json:\"birthday\"` Salary float64 `json:\"salary\"` Skill string `json:\"skill\"` } func testStruct() { monster := Monster{ Name: \"ç‰›é­”ç‹\", Age: 18, Birthday: \"2011-11-11\", Salary: 3000.0, Skill: \"ç‰›é­”æ‹³\", } // å°†monster åºåˆ—åŒ– data, err := json.Marshal(\u0026monster) if err != nil { fmt.Println(\"åºåˆ—åŒ–é”™è¯¯ err = \", err) } fmt.Println(\"åºåˆ—åŒ–çš„ç»“æœï¼š\", string(data)) } // 2. å°†mapåºåˆ—åŒ– func testMap() { a := make(map[string]interface{}) a[\"name\"] = \"çº¢å­©å„¿\" a[\"age\"] = 30 a[\"address\"] = \"æ´ªå´–æ´\" data, err := json.Marshal(a) if err != nil { fmt.Println(\"åºåˆ—åŒ–é”™è¯¯ err = \", err) } fmt.Println(\"a map åºåˆ—åŒ–åä¸ºï¼š\", string(data)) } // 3. å¯¹Sliceåºåˆ—åŒ– func testSlice() { slice := []map[string]interface{}{} m1 := map[string]interface{}{} m1[\"name\"] = \"jack\" m1[\"age\"] = 10 m1[\"address\"] = []string{\"å¢¨è¥¿å“¥\", \"å¤å¨å¤·\"} m2 := map[string]interface{}{} m2[\"name\"] = \"chuyu\" m2[\"age\"] = 18 m2[\"address\"] = \"å—äº¬\" slice = append(slice, m1, m2) data, err := json.Marshal(slice) if err != nil { fmt.Println(\"åºåˆ—åŒ–é”™è¯¯ err = \", err) } fmt.Println(\"slice åºåˆ—åŒ–åä¸ºï¼š\", string(data)) } // 4. å¯¹åŸºæœ¬æ•°æ®ç±»å‹è¿›è¡Œåºåˆ—åŒ–(æ„ä¹‰ä¸å¤§) func testFloat64() { num1 := 1234.5678 data, err := json.Marshal(num1) if err != nil { fmt.Println(\"åºåˆ—åŒ–é”™è¯¯ err = \", err) } fmt.Println(\"num1 åºåˆ—åŒ–ç»“æœä¸ºï¼š\", string(data)) } åºåˆ—åŒ–çš„ç»“æœï¼š {\"name\":\"ç‰›é­”ç‹\",\"age\":18,\"birthday\":\"2011-11-11\",\"salary\":3000,\"skill\":\"ç‰›é­”æ‹³\"} 6.4 ååºåˆ—åŒ– å°†jsonæ ¼å¼ååºåˆ—åŒ–æˆå¯¹åº”çš„æ•°æ®ç»“æ„ï¼ˆç»“æ„ä½“ã€mapã€Sliceï¼‰ã€‚ err := json.Unmarshal([]byte(str), \u0026monster) æ³¨æ„ç‚¹ï¼š ååºåˆ—åŒ–ä¸€ä¸ªjsonå­—ç¬¦ä¸²æ—¶ï¼Œéœ€è¦ä¿è¯ååºåˆ—åŒ–åçš„æ•°æ®ç±»å‹å’Œåºåˆ—åŒ–å‰çš„æ•°æ®ç±»å‹ä¸€è‡´**ï¼ˆç»“æ„ä½“é¡»ä¿è¯å­—æ®µå®Œå…¨ä¸€è‡´ï¼‰**ã€‚ jsonå­—ç¬¦ä¸²å¦‚æœæ˜¯ä¼ è¾“è¿‡æ¥çš„ï¼ˆæœ¬æ¥å°±æ˜¯jsonå­—ç¬¦ä¸²ï¼‰ï¼Œæ— éœ€è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚ /* 1. ååºåˆ—åŒ–ä¸ºstruct 2. ååºåˆ—åŒ–ä¸ºmap 3. ååºåˆ—åŒ–ä¸ºslice */ // 1. ååºåˆ—åŒ–ä¸º struct type Monster struct { Name string `json:\"name\" ` Age int `json:\"age\" ` Birthday string `json:\"birthday\"` Salary float64 `json:\"salary\"` Skill string `json:\"skill\"` } func unMarshalStruct() { // 1. å¾—åˆ°åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ç½‘ç»œä¼ è¾“è¿‡æ¥çš„ str := \"{\\\"name\\\":\\\"ç‰›é­”ç‹\\\",\\\"age\\\":18,\" + \"\\\"birthday\\\":\\\"2011-11-11\\\",\\\"salary\\\":3000,\\\"skill\\\":\\\"ç‰›é­”æ‹³\\\"}\" monster := Monster{} err := json.Unmarshal([]byte(str), \u0026monster) if err != nil { fmt.Println(\"ååºåˆ—åŒ–é”™è¯¯ err = \", err) } fmt.Printf(\"ååºåˆ—åŒ–çš„ç»“æœï¼š%v\\n\", monster) } // 2. ååºåˆ—åŒ–ä¸ºMap func unMarshalMap() { str := \" {\\\"address\\\":\\\"æ´ªå´–æ´\\\",\\\"age\\\":30,\\\"name\\\":\\\"çº¢å­©å„¿\\\"}\" a := map[string]interface{}{} err := json.Unmarshal([]byte(str), \u0026a) if err != nil { fmt.Println(\"ååºåˆ—åŒ–å¤±è´¥ err = \", err) } fmt.Printf(\"åºåˆ—åŒ–ç»“æœä¸ºï¼š%v\\n\", a) } // 3. ååºåˆ—åŒ–ä¸ºSlice func unMarshalSlice() { str := \"[{\\\"address\\\":[\\\"å¢¨è¥¿å“¥\\\",\\\"å¤å¨å¤·\\\"],\\\"age\\\":10,\" + \"\\\"name\\\":\\\"jack\\\"},{\\\"address\\\":\\\"å—äº¬\\\",\\\"age\\\":18,\\\"name\\\":\\\"chuyu\\\"}]\" slice := []map[string]interface{}{} err := json.Unmarshal([]byte(str), \u0026slice) if err != nil { fmt.Println(\"ååºåˆ—åŒ–å¤±è´¥ err = \", err) } fmt.Printf(\"ååºåˆ—åŒ–ç»“æœä¸ºï¼š%v\\n\", slice) } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:6","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"7. å•å…ƒæµ‹è¯• æµ‹è¯•ä¸€ä¸ªå‡½æ•°æ˜¯å¦æœ‰æ•ˆï¼Œä¼ ç»Ÿåšæ³•å°±æ˜¯è°ƒç”¨ä¸€ä¸‹ä»–ï¼Œè§‚å¯Ÿç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œä½†è¿™æ ·å…·æœ‰ç¼ºç‚¹ï¼š ä¸æ–¹ä¾¿ï¼Œè¿˜éœ€è¦è‡ªå·±ç¼–å†™å®ä¾‹å»æµ‹è¯•ï¼Œéœ€è¦åœ¨mainå‡½æ•°ä¸­è°ƒç”¨ä»£ç ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å»æ”¹åŠ¨ä»£ç ï¼Œè‹¥é¡¹ç›®æ­£åœ¨è¿è¡Œï¼Œé‚£ä¹ˆæœ‰å¯èƒ½è¿˜éœ€è¦åœä¸‹é¡¹ç›®ï¼› ä¸åˆ©äºç®¡ç†ï¼Œå½“æµ‹è¯•å¤šä¸ªå‡½æ•°æˆ–æ¨¡å—æ—¶ï¼Œéƒ½éœ€è¦å†™åœ¨mainå‡½æ•°ï¼Œä¸åˆ©äºç®¡ç†ã€‚ Goå¸¦æœ‰ä¸€ä¸ªè½»é‡çº§çš„æµ‹è¯•æ¡†æ¶testingå’Œè‡ªå¸¦çš„go testæ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œtestingæ¡†æ¶å’Œå…¶å®ƒè¯­è¨€ä¸­çš„æµ‹è¯•æ¡†æ¶ç›¸ä¼¼ã€‚ å•å…ƒæµ‹è¯•ä¸»è¦æ‰¾åˆ°é€»è¾‘æ¼æ´ï¼› æ€§èƒ½æµ‹è¯•ä¸»è¦æµ‹è¯•ç¨‹åºåœ¨é«˜å¹¶å‘é«˜å‹åŠ›ç¯å¢ƒä¸‹çš„è¿è¡ŒçŠ¶å†µã€‚ testing æä¾›å¯¹ Go åŒ…çš„è‡ªåŠ¨åŒ–æµ‹è¯•çš„æ”¯æŒã€‚é€šè¿‡ go test å‘½ä»¤ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ‰§è¡Œå¦‚ä¸‹å½¢å¼çš„ä»»ä½•å‡½æ•°ï¼š func TestXxx(*testing.T) å…¶ä¸­ Xxx å¯ä»¥æ˜¯ä»»ä½•å­—æ¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆä½†ç¬¬ä¸€ä¸ªå­—æ¯ä¸èƒ½æ˜¯ [a-z]ï¼‰ï¼Œç”¨äºè¯†åˆ«æµ‹è¯•ä¾‹ç¨‹ã€‚ è¦ç¼–å†™ä¸€ä¸ªæ–°çš„æµ‹è¯•å¥—ä»¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªåç§°ä»¥ _test.go ç»“å°¾çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å« TestXxx å‡½æ•°ã€‚ ç¤ºä¾‹ï¼š æ–‡ä»¶åæ ¼å¼ï¼šxxx_test.go package test import \"testing\" // ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ä¸­å¯å«æœ‰å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ // 1. ç¬¬ä¸€ä¸ªæµ‹è¯•å‡½æ•° func addUpper(n int) int { res := 0 for i := 1; i \u003c= n; i++ { res += i } return res } // ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ func TestGetSub(t *testing.T) { res := getSub(10, 7) // å†™åœ¨åˆ«çš„æ–‡ä»¶ä¸­ // è‹¥é”™è¯¯ if res != 5 { t.Fatalf(\"getSub(10, 7) æ‰§è¡Œé”™è¯¯ æœŸæœ›å€¼ = %v å®é™…å€¼ = %v\\n\", 5, res) } // è‹¥æ­£ç¡® t.Logf(\"getSub(10, 7) æ‰§è¡Œæ­£ç¡®...\") } // ç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹ func TestAddUpper(t *testing.T) { // è°ƒç”¨ res := addUpper(10) // è‹¥é”™è¯¯ if res != 55 { t.Fatalf(\"addUpper(10) æ‰§è¡Œé”™è¯¯ æœŸæœ›å€¼ = %v å®é™…å€¼ = %v\\n\", 55, res) } // è‹¥æ­£ç¡® t.Logf(\"addUpper(10) æ‰§è¡Œæ­£ç¡®...\") } // ä¸éœ€è¦mainå‡½æ•° $ go test -v === RUN TestGetSub 09-add_test.go:19: getSub(10, 7) æ‰§è¡Œé”™è¯¯ æœŸæœ›å€¼ = 5 å®é™…å€¼ = 3 --- FAIL: TestGetSub (0.00s) === RUN TestAddUpper 09-add_test.go:33: addUpper(10) æ‰§è¡Œæ­£ç¡®... --- PASS: TestAddUpper (0.00s) FAIL exit status 1 FAIL goLearn/test 0.157s -vï¼šæ— è®ºæ­£ç¡®ä¸å¦ï¼Œéƒ½è¾“å‡ºæ—¥å¿— æ³¨æ„ç‚¹ï¼š æµ‹è¯•æ–‡ä»¶åï¼šxxx_test.go æµ‹è¯•ç”¨ä¾‹åï¼šfunc TestXxx(*testing.T) è‹¥æœ‰å¤šä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥ç”¨go test -v æŒ‡å®šæµ‹è¯•æ–‡ä»¶å åŸæ–‡ä»¶æµ‹è¯•æŒ‡å®šçš„æ–‡ä»¶ã€‚ è‹¥ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ä¸­ï¼Œæœ‰å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥ç”¨go test -v -test.run æµ‹è¯•ç”¨ä¾‹å‡½æ•°åæŒ‡å®šæµ‹è¯•ç”¨ä¾‹ã€‚ $ go test -v -test.run TestGetSub === RUN TestGetSub 09-add_test.go:19: getSub(10, 7) æ‰§è¡Œé”™è¯¯ æœŸæœ›å€¼ = 5 å®é™…å€¼ = 3 --- FAIL: TestGetSub (0.00s) FAIL exit status 1 FAIL goLearn/test 0.155s ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:7","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8. å¹¶å‘ 8.1 å¼•å‡º **è¿›ç¨‹ï¼š**ç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­çš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚ **çº¿ç¨‹ï¼š**æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªæ‰§è¡Œå®ä¾‹ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•å…ƒï¼Œå®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½ã€‚ å…³ç³»ï¼š ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºå’Œé”€æ¯å¤šä¸ªçº¿ç¨‹ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œã€‚ ä¸€ä¸ªç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ å‡è®¾ï¼Œéœ€è¦ç»Ÿè®¡1-900000000000000000çš„æ•°å­—ä¸­ï¼Œå“ªäº›æ˜¯ç´ æ•°ï¼Ÿ è‹¥æŒ‰ä¼ ç»Ÿéå†ï¼Œéœ€è¦ä¸€ä¸ªå¾ªç¯ï¼Œä»å¤´åˆ°å°¾ è‹¥æŒ‰å¹¶å‘æˆ–å¹¶è¡Œï¼Œå¤šä¸ªroutineåŒæ—¶æ‰§è¡Œï¼Œå°†æå¤§æå‡æ•ˆç‡ 8.2 goroutine 8.2.1 åŸºç¡€çŸ¥è¯† **å¹¶å‘ï¼šå¤šçº¿ç¨‹ç¨‹åºåœ¨å•æ ¸ä¸Šè¿è¡Œï¼Œå°±æ˜¯å¹¶å‘ã€‚**ä¸€æ®µæ—¶é—´å†…äº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä½†ç›¸åŒæ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚ï¼ˆåˆ‡æ¢çš„å¾ˆå¿«ï¼Œä»¥è‡³äºè®©äººæ„Ÿè§‰æ˜¯\"åŒæ—¶\"è¿›è¡Œï¼‰ **å¹¶è¡Œï¼šå¤šçº¿ç¨‹ç¨‹åºåœ¨å¤šæ ¸ä¸Šè¿è¡Œã€‚**å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œã€‚ï¼ˆå¤šä¸ªCPUï¼ŒåŒæ—¶æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ï¼‰ Cè¯­è¨€é‡Œé¢å®ç°å¹¶å‘è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯å¤šçº¿ç¨‹ï¼ˆC++çš„æœ€å°èµ„æºå•ä½ï¼‰ï¼Œæ— æ³•å¼€å¯å¾ˆå¤šçº¿ç¨‹ã€‚ **Goä¸»çº¿ç¨‹ï¼š**ä¸€ä¸ªGoçº¿ç¨‹å¯ä»¥èµ·å¤šä¸ªgoroutineï¼Œgoroutineæ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚ ==\u003e goroutineï¼Œæ¯ä¸€ä¸ªgoroutineå ç”¨çš„ç³»ç»Ÿèµ„æºè¿œè¿œå°äºçº¿ç¨‹ï¼Œä¸€ä¸ªgoroutineå¤§çº¦éœ€è¦4k-5kçš„å†…å­˜èµ„æºã€‚ä¸€ä¸ªç¨‹åºå¯ä»¥å¯åŠ¨å¤§é‡çš„goroutineï¼š çº¿ç¨‹ ==\u003e å‡ åä¸ª goroutineå¯ä»¥è½»æ¾å¯åŠ¨æˆç™¾ä¸Šåƒä¸Šä¸‡ä¸ªï¼Œ==\u003e å¯¹äºå®ç°é«˜å¹¶å‘ï¼Œæ€§èƒ½éå¸¸å¥½ åªéœ€è¦åœ¨ç›®æ ‡å‡½æ•°å‰åŠ ä¸Šgoå…³é”®å­—å³å¯ å…³ç³»ï¼š ä¸»çº¿ç¨‹æ˜¯ä¸€ä¸ªç‰©ç†çº¿ç¨‹ï¼Œç›´æ¥ä½œç”¨åœ¨CPUä¸Šï¼Œæ˜¯é‡é‡çº§çš„ï¼Œéå¸¸æ¶ˆè€—CPUèµ„æºã€‚ goroutineæ˜¯ä»ä¸»çº¿ç¨‹å¼€å¯çš„ï¼Œæ˜¯è½»é‡çº§çš„çº¿ç¨‹ï¼Œæ˜¯é€»è¾‘æ€çš„ï¼Œå¯¹èµ„æºæ¶ˆè€—è¾ƒå°ã€‚ goroutineçš„ç‰¹ç‚¹ï¼ˆé¢è¯•ä¸€å®šè¢«é—®åˆ°ï¼‰â­â­â­ï¼š æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œæ•°æ®æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šæ‰“æ¶ï¼› å…±äº«ç¨‹åºå †ç©ºé—´ï¼› è°ƒåº¦ç”±ç”¨æˆ·æ§åˆ¶ï¼› åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚ goroutinedçš„è°ƒåº¦æ¨¡å‹MPGï¼š M:æ“ä½œç³»ç»Ÿçš„ä¸»çº¿ç¨‹ï¼ˆç‰©ç†çº¿ç¨‹ï¼‰ P:åç¨‹æ‰§è¡Œéœ€è¦çš„ä¸Šä¸‹æ–‡ G:åç¨‹ 8.2.2 demo /* 1. åœ¨ä¸»çº¿ç¨‹å¼€å¯ä¸€ä¸ªgoroutineï¼Œæ¯ä¸€ç§’è¾“å‡ºä¸€ä¸ª\"hello, world\" 2. åœ¨ä¸»çº¿ç¨‹ä¹Ÿæ¯ä¸€ç§’è¾“å‡ºä¸€ä¸ª\"hello, world\" 3. è¦æ±‚ï¼šä¸»çº¿ç¨‹å’ŒgoroutineåŒæ—¶æ‰§è¡Œ */ func test() { for i := 0; i \u003c 10; i++ { fmt.Println(\"test() hello, world\" + strconv.Itoa(i)) time.Sleep(time.Second) } } func main() { // 1. åœ¨ä¸»çº¿ç¨‹å¼€å¯ä¸€ä¸ªgoroutine go test() // 2. ä¸»çº¿ç¨‹çš„è¾“å‡º for i := 0; i \u003c 10; i++ { fmt.Println(\"main() hello, world\" + strconv.Itoa(i)) time.Sleep(time.Second) } } $ go run 01-goroutinedemo.go main() hello, world0 test() hello, world0 test() hello, world1 main() hello, world1 main() hello, world2 test() hello, world2 ..... å¯ä»¥çœ‹å‡ºï¼Œä¸»çº¿ç¨‹å’ŒgoroutineåŒæ—¶åœ¨æ‰§è¡Œï¼Œç”±æ­¤å¼•å‘é—®é¢˜ï¼š è°æ‰§è¡Œå®Œè§¦å‘ç¨‹åºé€€å‡ºï¼Ÿ ç­”ï¼šä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå³ä½¿goroutineè¿˜æœªæ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿä¾ç„¶ä¼šé€€å‡ºï¼›goroutineæ‰§è¡Œå®Œæ¯•ï¼Œä¸»çº¿ç¨‹è‹¥è¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼Œä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œã€‚å› æ­¤ï¼ŒæŒ‰ç…§ä¸»çº¿ç¨‹ä¸ºå‡†ã€‚ 8.3 è®¾ç½®è¿è¡Œçš„CPUæ•° åœ¨golangé‡Œï¼Œè®¾ç½®è¿è¡Œçš„CPUæ•°ç›®ã€‚ import \"runtime\" runtime.NumCPU() // 1. è¿”å›æœºå™¨çš„cpuä¸ªæ•° cpuNum := runtime.NumCPU() runtime.GOMAXPROCS(cpuNum) // 2. è®¾ç½®CPUæ•°ç›® runtime.GOMAXPROCS(cpuNum) go1.8åï¼Œé»˜è®¤ç¨‹åºè¿è¡Œäºå¤šæ ¸ï¼Œä¸ç”¨æ‰‹åŠ¨è®¾ç½® go1.8å‰ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½® 8.4 channel 8.4.1 å…ˆçœ‹ä¸€ä¸ªéœ€æ±‚ **éœ€æ±‚ï¼š**è¦è®¡ç®—1-200çš„å„ä¸ªæ•°çš„é˜¶ä¹˜ï¼Œå¹¶ä¸”æŠŠå„ä¸ªæ•°çš„é˜¶ä¹˜æ”¾å…¥åˆ°mapä¸­ï¼Œæœ€åæ˜¾ç¤ºå‡ºæ¥ã€‚è¦æ±‚ä½¿ç”¨goroutineã€‚ /* æ€è·¯ï¼š 1. ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—é˜¶ä¹˜ï¼Œå¹¶æ”¾å…¥map 2. å¯åŠ¨å¤šä¸ªåç¨‹ï¼Œç»Ÿè®¡ç»“æœæ”¾å…¥mapï¼ˆå…¨å±€å…±ç”¨ï¼‰ 3. æ‰€æœ‰çš„åç¨‹éƒ½å¯¹åŒä¸€ä¸ªmapè¿›è¡Œæ“ä½œï¼Œä¼šé€ æˆèµ„æºç«äº‰ï¼Œå› æ­¤éœ€è¦å¯¹å…¨å±€å˜é‡ä¸Šé” */ 8.4.2 ä¸Šé” import \"sync\" syncåŒ…æä¾›äº†åŸºæœ¬çš„åŒæ­¥åŸºå…ƒï¼Œå¦‚äº’æ–¥é”ã€‚é™¤äº†Onceå’ŒWaitGroupç±»å‹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯é€‚ç”¨äºä½æ°´å¹³ç¨‹åºçº¿ç¨‹ï¼Œé«˜æ°´å¹³çš„åŒæ­¥ä½¿ç”¨channelé€šä¿¡æ›´å¥½ä¸€äº›ã€‚ var ( myMap = map[int]int{} // 3. å…¨å±€äº’æ–¥é” lock sync.Mutex ) func calculate(n int) { res := 1 for i := 1; i \u003c= n; i++ { res *= i } // åŠ é” lock.Lock() myMap[n] = res // è§£é” lock.Unlock() } func main() { // èµ·äº†20ä¸ªåç¨‹ for i := 1; i \u003c= 20; i++ { go calculate(i) } // æ­¤å¤„ä¸èƒ½é©¬ä¸Šéå†ï¼Œå› ä¸ºä¸ä¸€å®šæ‰§è¡Œå®Œæ¯• time.Sleep(time.Second) for num, res := range myMap { fmt.Println(num, res) } } ä½æ°´å¹³çš„ï¼Œä¸‹é¢è¿›ä¸€æ­¥ ==ä½¿ç”¨æ— ç¼“å†²Channel== package main /* åŸºäºæ— ç¼“å†²çš„channelçš„mainå’Œ goroutineçš„åŒæ­¥ */ import ( \"io\" \"log\" \"net\" \"os\" ) func main() { conn, err := net.Dial(\"tcp\", \"127.0.0.1:8001\") if err != nil { log.Fatal(err) } done := make(chan string) // done := make(chan struct{}) go func() { io.Copy(os.Stdout, conn) log.Println(\"groutine: done!\") done \u003c- \"I am done\" // close(done) }() //ä»å®¢æˆ·ç«¯è¾“å…¥,å°†å®¢æˆ·ç«¯æ ‡è¾“å…¥çš„æ•°æ®å‘ç»™å®¢æˆ·ç«¯å¥—æ¥å­— io.Copy(conn, os.Stdin) conn.Close() //æ­¤æ—¶mainè¦ä¸»åŠ¨å…³é—­conn, å¦åˆ™goroutineé‡Œé¢çš„io.Copy()ä¼šä¸€ç›´é˜»å¡ç­‰å¾…conn log.Println(\"main wait goroutine...\") // è¯»é˜»å¡åœ¨æ­¤å¤„ \u003c-done log.Println(\"main: done!\") //è¿™æ ·æˆ‘ä»¬å°±ä¿è¯äº† \"main::done!\"æ‰“å°ä¹‹å‰ ä¸€å®šå…ˆæ‰“å°\"groutine:done!\" } åŸºäºchannelså‘é€æ¶ˆæ¯æœ‰ä¸¤ä¸ªé‡è¦æ–¹é¢ã€‚é¦–å…ˆæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯æœ‰æ—¶å€™é€šè®¯çš„äº‹å®å’Œå‘ç”Ÿçš„æ—¶åˆ»ä¹ŸåŒæ ·é‡è¦ã€‚å½“æˆ‘ä»¬æ›´å¸Œæœ›å¼ºè°ƒé€šè®¯å‘ç”Ÿçš„æ—¶åˆ»æ—¶ï¼Œæˆ‘ä»¬å°†å®ƒç§°ä¸ºæ¶ˆæ¯äº‹ä»¶ã€‚æœ‰äº›æ¶ˆæ¯äº‹ä»¶å¹¶ä¸æºå¸¦é¢å¤–çš„ä¿¡æ¯ï¼Œå®ƒä»…ä»…æ˜¯ç”¨ä½œä¸¤ä¸ªgoroutineä¹‹é—´çš„åŒæ­¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç”¨struct{}ç©ºç»“æ„ä½“ä½œä¸ºchannelså…ƒç´ çš„ç±»å‹ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨boolæˆ–intç±»å‹å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œdone \u003c- 1è¯­å¥ä¹Ÿæ¯”done \u003c- struct{}{}æ›´çŸ­ã€‚ 8.4.3 channelç®¡é“ ä¸ºä»€ä¹ˆéœ€è¦channelï¼Ÿ ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆçš„æ—¶é—´å¾ˆéš¾ç¡®å®šï¼Œæ¯”å¦‚ä¸Šä¾‹ä¸­è®¾ç½®äº†1sï¼Œä»…ä»…æ˜¯ä¼°ç®—ã€‚ è‹¥ä¸»çº¿ç¨‹ç­‰å¾…æ—¶é—´é•¿äº†ï¼Œåˆ™ä¼šå»¶é•¿ç¨‹åºè¿è¡Œæ—¶é—´ï¼›è‹¥ç­‰å¾…æ—¶é—´çŸ­äº†ï¼Œåˆ™æœ‰å¯èƒ½è¿˜æœ‰goroutineæœªå®Œæˆï¼Œè€Œä¸»çº¿ç¨‹çš„ç»“æŸå°†å¯¼è‡´æœªå®Œæˆçš„goroutineé”€æ¯ã€‚ é€šè¿‡åŠ å…¨å±€å˜é‡äº’æ–¥é”æ¥å®ç°é€šè®¯ï¼Œå¹¶ä¸åˆ©äºå¤šä¸ªgoroutineå¯¹å…¨å±€å˜é‡çš„è¯»å†™æ“ä½œã€‚ channelçš„ç‰¹ç‚¹ channelæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„-é˜Ÿåˆ—ï¼› æ•°æ®æ˜¯å…ˆè¿›å…ˆå‡ºçš„ï¼› æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šgoroutineè®¿é—®æ—¶ï¼Œä¸éœ€è¦åŠ é”ï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿèµ„æºç«äº‰é—®é¢˜ï¼› channelæ˜¯æœ‰ç±»å‹çš„ï¼Œä¸€ä¸ªstringçš„channelåªèƒ½å­˜æ”¾stringç±»å‹çš„æ•°æ®ã€‚ åŸºæœ¬è¯­æ³• å£°æ˜channel channeléå† channelå…³é—­ å£°æ˜channel var chanå chan æ•°æ®ç±»å‹ chanå := make(chan æ•°æ®ç±»å‹, cap) // example var intChan chan int var mapChan chan map[int]string var perChan chan Person var perChan chan *Person var allChan chan interface{} è¯´æ˜ï¼š channelæ˜¯å¼•ç”¨ç±»å‹çš„ï¼› channelå¿…é¡»åˆå§‹åŒ–æ‰èƒ½å†™å…¥æ•°æ®ï¼Œå³å¿…é¡»makeï¼› channelæ˜¯æœ‰ç±»å‹çš„ï¼Œå³intChanåªèƒ½å†™å…¥intå‹ã€‚å¦‚æœæƒ³å•¥ç±»å‹éƒ½å­˜ï¼Œå°±å£°æ˜æˆinterface{}å‹ï¼Œä½†æ˜¯å–çš„æ—¶å€™éœ€è¦ç±»å‹æ–­è¨€ï¼› å‘channelå†™å…¥æ•°æ®æ—¶ï¼Œä¸èƒ½è¶…è¿‡å…¶capï¼ˆä¸ä¼šè‡ªåŠ¨æ‰©å……ï¼‰ï¼Œå¦åˆ™ä¼šdeadlockï¼› ä»channelè¯»å–æ•°æ®æ—¶ï¼Œä¸èƒ½chan","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:8","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9. reflect 9.1 å¼•å‡º åº”ç”¨åœºæ™¯ï¼š ç»“æ„ä½“çš„tagæ ‡ç­¾ ç¼–å†™å‡½æ•°çš„é€‚é…å™¨ï¼Œæ¡¥è¿æ¥ â€¦â€¦ åŸºæœ¬ä»‹ç»ï¼š åå°„å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è·å–å˜é‡çš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚å˜é‡çš„ç±»å‹(type)ï¼Œç±»åˆ«(kind)ï¼› å¦‚æœæ˜¯ç»“æ„ä½“å˜é‡ï¼Œè¿˜å¯ä»¥è·å–åˆ°ç»“æ„ä½“æœ¬èº«çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç»“æ„ä½“çš„å­—æ®µï¼Œæ–¹æ³•ï¼‰ï¼› é€šè¿‡åå°„ï¼Œå¯ä»¥ä¿®æ”¹å˜é‡çš„å€¼ï¼Œå¯ä»¥è°ƒç”¨å…³è”çš„æ–¹æ³•ï¼› ä½¿ç”¨åå°„ï¼Œéœ€è¦ import \"reflect\" ç¤ºæ„å›¾ reflectåŒ…å®ç°äº†è¿è¡Œæ—¶åå°„ï¼Œå…è®¸ç¨‹åºæ“ä½œä»»æ„ç±»å‹çš„å¯¹è±¡ã€‚ å…¸å‹ç”¨æ³•æ˜¯ç”¨é™æ€ç±»å‹interface{}ä¿å­˜ä¸€ä¸ªå€¼ï¼Œ é€šè¿‡è°ƒç”¨TypeOfè·å–å…¶åŠ¨æ€ç±»å‹ä¿¡æ¯ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªTypeç±»å‹å€¼ï¼ˆå’Œæ™®é€šçš„Typeä¸ä¸€æ ·ï¼‰ï¼› è°ƒç”¨ValueOfå‡½æ•°è¿”å›ä¸€ä¸ªValueç±»å‹å€¼ï¼ˆå’Œæ™®é€šçš„å€¼ä¸ä¸€æ ·ï¼‰ï¼Œè¯¥å€¼ä»£è¡¨è¿è¡Œæ—¶çš„æ•°æ®ï¼Œä¸”å¯ä»¥åˆ©ç”¨å¾ˆå¤šæ–¹æ³•è·å–ä¿¡æ¯ï¼› Zeroæ¥å—ä¸€ä¸ªTypeç±»å‹å‚æ•°å¹¶è¿”å›ä¸€ä¸ªä»£è¡¨è¯¥ç±»å‹é›¶å€¼çš„Valueç±»å‹å€¼ã€‚ 9.2 å¿«é€Ÿå…¥é—¨ example1 æ¼”ç¤ºå¯¹ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ã€interface {}ã€reflect.Valueï¼‰è¿›è¡Œåå°„çš„åŸºæœ¬æ“ä½œã€‚ // 1. example1 // é€šè¿‡åå°„æ‹¿åˆ°dataçš„typeã€kindã€å€¼ func reflectDemo1(data interface{}) { // 1. è·å–reflect.Type refType := reflect.TypeOf(data) fmt.Println(\"refType:\", refType, \"refType's type:\", reflect.TypeOf(refType)) // 2. è·å–reflect.Value refValue := reflect.ValueOf(data) fmt.Println(\"refValue:\", refValue) // æ“ä½œrefValue numInt64 := int64(1) // ä¸èƒ½ç›´æ¥æ“ä½œrValç±»å‹ //num += refValue numInt64 += refValue.Int() fmt.Println(\"numInt64 =\", numInt64) // 3. å°†rValè½¬æˆinterface{} iv := refValue.Interface() // å°† interface{} é€šè¿‡ç±»å‹æ–­è¨€è½¬æˆéœ€è¦çš„ç±»å‹ numInt := 1 numInt += iv.(int) fmt.Println(\"numInt =\", numInt) } func main() { // 1. example1 reflectDemo1(12) } example2 æ¼”ç¤ºå¯¹ï¼ˆç»“æ„ä½“ã€interface{}ã€reflect.Valueï¼‰è¿›è¡Œåå°„çš„åŸºæœ¬æ“ä½œã€‚ func reflectDemo2(data interface{}) { // 1. è·å–reflect.Type refType := reflect.TypeOf(data) fmt.Println(\"refType:\", refType, \" refType's type:\", reflect.TypeOf(refType)) // 2. è·å–reflect.Value refValue := reflect.ValueOf(data) fmt.Println(\"refValue:\", refValue) // 3. è·å–å˜é‡å¯¹åº”çš„Kind fmt.Printf(\"refType kind = %v\\n\", refType.Kind()) fmt.Printf(\"refValue kind = %v\\n\", refValue.Kind()) // 4. è½¬æˆ interface{} iv := refValue.Interface() fmt.Printf(\"iv = %v, iv type = %T\\n\", iv, iv) // å³ä½¿å½“å‰è¾“å‡ºæ˜¯Studentç±»å‹ï¼Œä¹Ÿä¸èƒ½å–å‡ºæ•°æ® // 5. é€šè¿‡ç±»å‹æ–­è¨€è½¬æ¢æˆç›¸åº”ç±»å‹ stu := iv.(Student) fmt.Println(\"stu.Name =\", stu.Name, \", stu.Age =\", stu.Age) } func main() { // 2. example2 student := Student{ Name: \"Lily\", Age: 12, } reflectDemo2(student) } 9.3 é€šè¿‡åå°„ä¿®æ”¹å€¼ ä¼ å…¥æŒ‡é’ˆï¼Œåˆ©ç”¨ rVal.Elem()å¾—åˆ°æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼Œç„¶ååˆ©ç”¨ Set ç³»åˆ—å‡½æ•°æ›´æ”¹å€¼ã€‚ // é€šè¿‡åå°„ï¼Œä¿®æ”¹ num int çš„å€¼ func reflectDemo3(data interface{}) { rVal := reflect.ValueOf(data) fmt.Println(\"rVal kind =\", rVal.Kind()) // ptr // è¿™æ ·æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºrValæ˜¯æŒ‡é’ˆï¼Œéœ€è¦å…ˆå–åˆ°æŒ‡é’ˆçš„å€¼ //rVal.SetInt(20) rVal.Elem().SetInt(20) // .Elem() å¯ä»¥è·å–ptræŒ‡å‘çš„å€¼ï¼Œç„¶åå†æ”¹ } func main() { num := 10 reflectDemo3(\u0026num) fmt.Println(\"num =\", num) } func main() { str := \"tom\" rVal := reflect.ValueOf(\u0026str) // ä¼šæŠ¥é”™ //rVal.SetString(\"lily\") rVal.Elem().SetString(\"lily\") fmt.Println(str) } 9.4 å®æˆ˜ 9.4.1 example1 ä½¿ç”¨åå°„éå†ç»“æ„ä½“çš„å­—æ®µï¼Œè°ƒç”¨ç»“æ„ä½“çš„æ–¹æ³•ï¼Œå¹¶è·å–ç»“æ„ä½“æ ‡ç­¾çš„å€¼ã€‚ rTyp := reflect.TypeOf(a) rVal := reflect.ValueOf(a) rVal.NumField() // è·å–å­—æ®µæ•° rVal.Field(i) // è·å–ç¬¬iä¸ªå­—æ®µçš„å€¼ rTyp.Field(i).Tag.Get(\"json\") // è·å–ç¬¬iä¸ªå­—æ®µçš„json tag rVal.NumMethod() // è·å–æ–¹æ³•æ•° // Methodè°ƒç”¨æ–¹æ³•æ—¶ï¼ŒæŒ‰ç…§å‡½æ•°å­—æ¯(ASCIIç )è¿›è¡Œæ’åºï¼Œå’Œå®šä¹‰æ—¶å€™çš„é¡ºåºæ— å…³ã€‚ rVal.Method(1).Call(nil) // è°ƒç”¨ç¬¬2ä¸ªæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°nil params := []reflect.Value{} rVal.Method(0).Call(params) // ä¼ å…¥çš„å‚æ•°è¦æ˜¯[]reflect.Value{}æ ¼å¼ // 1. å®šä¹‰Monsterç»“æ„ä½“ type Monster struct { Name string `json:\"name,omitempty\"` Age int `json:\"age,omitempty\"` Score float64 Sex string } func (s Monster) Print() { fmt.Println(\"---start---\") fmt.Println(s) fmt.Println(\"---end---\") } func (s Monster) GetSum(n1, n2 int) int { return n1 + n2 } func (s *Monster) Set(name string, age int, score float64, sex string) { s.Name = name s.Age = age s.Score = score s.Sex = sex } // 2. åå°„ func testStruct(a interface{}) { rTyp := reflect.TypeOf(a) rVal := reflect.ValueOf(a) rKd := rVal.Kind() if rKd != reflect.Struct { fmt.Println(\"expect struct...\") return } num := rVal.NumField() fmt.Printf(\"struct has %d fields.\\n\", num) for i := 0; i \u003c num; i++ { fmt.Printf(\"Field %d: å­—æ®µå€¼ = %v.\\n\", i, rVal.Field(i)) tagVal := rTyp.Field(i).Tag.Get(\"json\") if tagVal != \"\" { fmt.Printf(\"Field %d: å­—æ®µtag = %v.\\n\", i, tagVal) } } numOfMethod := rVal.NumMethod() fmt.Printf(\"struct has %d methods.\\n\", numOfMethod) // Methodè°ƒç”¨æ–¹æ³•æ—¶ï¼ŒæŒ‰ç…§å‡½æ•°å­—æ¯(ASCIIç )è¿›è¡Œæ’åºï¼Œå’Œå®šä¹‰æ—¶å€™çš„é¡ºåºæ— å…³ã€‚ // è°ƒç”¨ Print å‡½æ•° rVal.Method(1).Call(nil) // èµ‹å€¼ params := []reflect.Value{} params = append(params, reflect.ValueOf(10)) params = append(params, reflect.ValueOf(40)) // è°ƒç”¨ GetSum å‡½æ•° res := rVal.Method(0).Call(params) fmt.Println(\"res =\", res[0","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:9","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"10.initå‡½æ•° initå‡½æ•°çš„ä¸»è¦ç‰¹ç‚¹ï¼š initå‡½æ•°å…ˆäºmainå‡½æ•°è‡ªåŠ¨æ‰§è¡Œï¼Œä¸èƒ½è¢«å…¶ä»–å‡½æ•°è°ƒç”¨ï¼› initå‡½æ•°æ²¡æœ‰è¾“å…¥å‚æ•°ã€è¿”å›å€¼ï¼› æ¯ä¸ªåŒ…å¯ä»¥æœ‰å¤šä¸ªinitå‡½æ•°ï¼› åŒ…çš„æ¯ä¸ªæºæ–‡ä»¶ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªinitå‡½æ•°ï¼Œè¿™ç‚¹æ¯”è¾ƒç‰¹æ®Šï¼› åŒä¸€ä¸ªåŒ…çš„initæ‰§è¡Œé¡ºåºï¼Œgolangæ²¡æœ‰æ˜ç¡®å®šä¹‰ï¼Œç¼–ç¨‹æ—¶è¦æ³¨æ„ç¨‹åºä¸è¦ä¾èµ–è¿™ä¸ªæ‰§è¡Œé¡ºåºã€‚ ä¸åŒåŒ…çš„initå‡½æ•°æŒ‰ç…§åŒ…å¯¼å…¥çš„ä¾èµ–å…³ç³»å†³å®šæ‰§è¡Œé¡ºåºã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:1:10","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"ä¸‰ã€å¹¶å‘ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:2:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"1. åŸºç¡€ å¹¶å‘ï¼šä¸€æ®µæ—¶é—´å†…äº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä½†ç›¸åŒæ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚ï¼ˆåˆ‡æ¢çš„å¾ˆå¿«ï¼Œä»¥è‡³äºè®©äººæ„Ÿè§‰æ˜¯\"åŒæ—¶\"è¿›è¡Œï¼‰ å¹¶è¡Œï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œã€‚ï¼ˆå¤šä¸ªCPUï¼ŒåŒæ—¶æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ï¼‰ Cè¯­è¨€é‡Œé¢å®ç°å¹¶å‘è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯å¤šçº¿ç¨‹ï¼ˆC++çš„æœ€å°èµ„æºå•ä½ï¼‰ï¼Œè¿›ç¨‹ Goè¯­è¨€é‡Œé¢ä¸æ˜¯çº¿ç¨‹ï¼Œè€Œæ˜¯goç¨‹ == \u003e goroutineï¼Œæ¯ä¸€ä¸ªgoç¨‹å ç”¨çš„ç³»ç»Ÿèµ„æºè¿œè¿œå°äºçº¿ç¨‹ï¼Œä¸€ä¸ªgoç¨‹å¤§çº¦éœ€è¦4k-5kçš„å†…å­˜èµ„æºã€‚ä¸€ä¸ªç¨‹åºå¯ä»¥å¯åŠ¨å¤§é‡çš„goç¨‹ï¼š çº¿ç¨‹ ==\u003e å‡ åä¸ª goç¨‹å¯ä»¥å¯åŠ¨æˆç™¾ä¸Šåƒä¸ªï¼Œ==\u003e å¯¹äºå®ç°é«˜å¹¶å‘ï¼Œæ€§èƒ½éå¸¸å¥½ åªéœ€è¦åœ¨ç›®æ ‡å‡½æ•°å‰åŠ ä¸Šgoå…³é”®å­—å³å¯ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:2:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"2. æå‰é€€å‡º // GOEXIT ===\u003e æå‰é€€å‡ºå½“å‰goç¨‹ // return ===\u003e è¿”å›å½“å‰å‡½æ•° // exit ===\u003e é€€å‡ºå½“å‰è¿›ç¨‹ func main() { // ä¸‰ä¸ªåŒ¿åå‡½æ•° go func() { go func() { // ä¸¤ä¸ªgoç¨‹ func() { fmt.Println(\"è¿™æ˜¯å­goç¨‹å†…éƒ¨çš„å‡½æ•°! \") //return // è¿™æ˜¯è¿”å›å½“å‰å‡½æ•° å…¶ä»–å‡½æ•°ä¾ç„¶ä¼šæ‰§è¡Œ åŒ…æ‹¬å¤–å±‚çš„å‡½æ•°ä¹Ÿä¼šç»§ç»­ å› æ­¤fmt.Println(\"å­goç¨‹ç»“æŸ! \")ä¹Ÿä¼šæ‰§è¡Œ //os.Exit(-1) // è¿™æ˜¯é€€å‡ºè¿›ç¨‹ fmt.Println(\"å­goç¨‹ç»“æŸ! \") å’Œ fmt.Println(\"Over! \")å°±ä¸ä¼šæ‰§è¡Œäº† runtime.Goexit() // åªæ˜¯é€€å‡ºå½“å‰å­goç¨‹ï¼ æ³¨æ„æ˜¯å½“å‰ï¼ï¼ åªé€€å‡ºä¸€å±‚ï¼ ä¸ä¼šæ‰§è¡Œ fmt.Println(\"å­goç¨‹ç»“æŸ! \")å’Œ fmt.Println(\"goç¨‹22222222222\") ä½†ä¼šç»§ç»­æ‰§è¡Œ fmt.Println(\"goç¨‹11111111111\")å’Œfmt.Println(\"Over! \") }() fmt.Println(\"å­goç¨‹ç»“æŸ! \") fmt.Println(\"goç¨‹22222222222\") }() time.Sleep(2 * time.Second) fmt.Println(\"goç¨‹11111111111\") }() fmt.Println(\"è¿™æ˜¯ä¸»goç¨‹! \") time.Sleep(5 * time.Second) fmt.Println(\"Over! \") } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:2:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"3. ç¼“å†²é€šé“ sync.RWMutex{} å½“Cè¯­è¨€æ¶‰åŠå¤šçº¿ç¨‹æ—¶ï¼Œä½¿ç”¨äº’æ–¥é‡ï¼Œé€šè¿‡ä¸Šé”æ¥ä¿æŒèµ„æºåŒæ­¥ï¼Œé¿å…èµ„æºç«äº‰é—®é¢˜ è€Œgoè¯­è¨€æ”¯æŒè¿™ç§æ–¹å¼ï¼Œä½†æœ‰æ›´å¥½çš„æ–¹å¼ ===\u003e é€šé“ã€ç®¡é“ï¼ˆä¸éœ€è¦è‡ªå·±è¿›è¡ŒåŠ è§£é”ï¼‰ Aå¾€é€šé“é‡Œå†™æ•°æ®ï¼ŒBä»é€šé“é‡Œè¯»æ•°æ®ã€‚goè‡ªåŠ¨å¸®æˆ‘ä»¬åšå¥½æ•°æ®åŒæ­¥ // 1. æ— ç¼“å†²çš„é€šé“ numChan := make(chan int) // è£…æ•°å­—çš„ç®¡é“ï¼Œä½¿ç”¨ç®¡é“æ—¶ä¸€å®šè¦makeï¼ŒåŒmapä¸€æ ·ï¼Œå¦åˆ™æ˜¯nil // 2. æœ‰ç¼“å†²çš„é€šé“ numChan := make(chan int, 10) æœ‰ç¼“å†²é€šé“ï¼š å½“ç¼“å†²å†™æ»¡åï¼Œå†™é˜»å¡ï¼Œå½“è¢«è¯»å–åï¼Œå†æ¢å¤å†™å…¥ å½“ç¼“å†²è¯»å–å®Œæ¯•ï¼Œè¯»é˜»å¡ å¦‚æœç®¡é“æ²¡æœ‰ä½¿ç”¨makeåˆ†é…ç©ºé—´ï¼Œé‚£ä¹ˆç®¡é“é»˜è®¤æ˜¯nilçš„ï¼Œè¯»å–ã€å†™å…¥éƒ½ä¼šé˜»å¡ å¯¹äºä¸€ä¸ªç®¡é“ï¼Œè¯»ä¸å†™çš„æ¬¡æ•°è¦å¯¹ç­‰ï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ­»é”ã€‚è‹¥ä¸ä¸€è‡´ï¼š é˜»å¡å‘ç”Ÿåœ¨ä¸»goç¨‹ï¼Œé‚£ä¹ˆç¨‹åºå°†é”æ­»å´©æºƒ é˜»å¡å‘ç”Ÿåœ¨å­goç¨‹ï¼Œé‚£ä¹ˆä¼šå‡ºç°å†…å­˜æ³„éœ²ï¼Œå­goç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œå½“è¿›ç¨‹ç»“æŸæ—¶ï¼Œå†…å­˜æ‰èƒ½é‡Šæ”¾ numsChan1 := make(chan int, 10) // å†™ go func() { for i := 0; i \u003c 50; i++ { numsChan1 \u003c- i fmt.Println(\"å†™å…¥æ•°æ®: \", i) } }() // è¯» // ä¸»ç¨‹åºçš„æ¬¡æ•°å¤š å½“ä¸»ç¨‹åºè¢«é€šé“é˜»å¡æ—¶, é‚£ä¹ˆç¨‹åºå°†é”æ­»å´©æºƒ; è‹¥æ˜¯goç¨‹ï¼Œå°†ä¸€ç›´å¡åœ¨goç¨‹ï¼Œé€ æˆå†…å­˜æ³„éœ² // ä¸€å®šè¦è¯»å†™æ¬¡æ•°ä¸€è‡´ // ä¸»goç¨‹ func() { for i := 0; i \u003c 60; i++ { fmt.Println(\"è¯»æ•°æ®: \", \u003c-numsChan1) } }() // å­goç¨‹ //go func() { // for i := 0; i \u003c 60; i++ { // fmt.Println(\"è¯»æ•°æ®: \", \u003c-numsChan1) // } //}() for { fmt.Println(\"å­goç¨‹æ­£åœ¨é˜»å¡\") time.Sleep(3 * time.Second) } ä¸ºäº†é¿å…ä¸ä¸€è‡´ï¼Œåœ¨è¯»å–æ•°æ®æ—¶å¯é‡‡ç”¨for-rangeè¯»å–ç®¡é“ã€‚ // éå†ç®¡é“æ—¶ï¼Œåªè¿”å›ä¸€ä¸ªå€¼ // é—®é¢˜æ˜¯: for-rangeä¸çŸ¥é“ç®¡é“æ˜¯å¦å·²ç»å†™å®Œï¼Œæ‰€ä»¥ä¼šä¸€ç›´ç­‰å¾…å†™å…¥ // è§£å†³: åœ¨å†™å…¥ç«¯å°†ç®¡é“å…³é—­ï¼Œfor rangeéå†å…³é—­ç®¡é“æ—¶ï¼Œä¼šé€€å‡º // éå†ç®¡é“æ—¶ï¼Œåªè¿”å›ä¸€ä¸ªå€¼ // é—®é¢˜æ˜¯: for-rangeä¸çŸ¥é“ç®¡é“æ˜¯å¦å·²ç»å†™å®Œï¼Œæ‰€ä»¥ä¼šä¸€ç›´ç­‰å¾…å†™å…¥ // è§£å†³: åœ¨å†™å…¥ç«¯å°†ç®¡é“å…³é—­ï¼Œfor rangeéå†å…³é—­ç®¡é“æ—¶ï¼Œä¼šé€€å‡º func main() { numsChan2 := make(chan int, 10) // å†™ go func() { for i := 0; i \u003c 50; i++ { numsChan2 \u003c- i fmt.Println(\"å†™å…¥æ•°æ®: \", i) } fmt.Println(\"æ•°æ®å†™å…¥å®Œæ¯•, å³å°†å…³é—­ç®¡é“! \") close(numsChan2) }() // éå†ç®¡é“æ—¶ï¼Œåªè¿”å›ä¸€ä¸ªå€¼ // é—®é¢˜æ˜¯: for-rangeä¸çŸ¥é“ç®¡é“æ˜¯å¦å·²ç»å†™å®Œï¼Œæ‰€ä»¥ä¼šä¸€ç›´ç­‰å¾…å†™å…¥ // è§£å†³: åœ¨å†™å…¥ç«¯å°†ç®¡é“å…³é—­ï¼Œfor rangeéå†å…³é—­ç®¡é“æ—¶ï¼Œä¼šé€€å‡º for v := range numsChan2 { fmt.Println(\"è¯»å–æ•°æ®: \", v) } fmt.Println(\"Over!!!\") } åˆ¤æ–­ç®¡é“æ˜¯å¦å·²ç»å…³é—­ï¼š éœ€è¦çŸ¥é“ä¸€ä¸ªç®¡é“çš„çŠ¶æ€ï¼Œå¦‚æœå·²ç»å…³é—­äº†ï¼Œå†è¿›è¡Œå†™å…¥æˆ–é‡å¤å…³é—­å°†é€ æˆå´©æºƒçš„é£é™©ã€‚ map: ==\u003e v, ok := m1[0] channel: ==\u003e v, ok := \u003c- numChan ok-idom æ¨¡å¼åˆ¤æ–­ // åˆ¤æ–­é€šé“æ˜¯å¦å·²ç»close //// è¯» //for v := range numChan{ // fmt.Println(\"v: \", v) //} for { v, ok := \u003c-numChan // ok-idom æ¨¡å¼åˆ¤æ–­ if !ok { fmt.Println(\"ç®¡é“å·²ç»å…³é—­äº†!!! å‡†å¤‡é€€å‡º!!! \") break } fmt.Println(\"v: \", v) // åŠ äº†è¯»æ“ä½œ } fmt.Println(\"Over!!! \") å•å‘é€šé“ï¼š numChan := make(chan int, 10) ==\u003e åŒå‘é€šé“ï¼Œæ—¢å¯ä»¥è¯»ï¼Œä¹Ÿå¯ä»¥å†™ å•å‘é€šé“ï¼šä¸ºäº†æ˜ç¡®è¯­ä¹‰ï¼Œä¸€èˆ¬ç”¨äºå‡½æ•°å‚æ•° å•å‘è¯»é€šé“ï¼švar numChanReadOnly \u003c- chan int å•å‘å†™é€šé“ï¼švar numChanWriteOnly \u003c- chan int func main() { // ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ // C: æ•°ç»„+é” thread1: å†™ï¼Œ thread2: è¯» // GO: goroutine + channel // 1. åœ¨ä¸»å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªåŒå‘é€šé“numChan numChan := make(chan int, 5) // 2. å°†numChan ä¼ é€’ç»™producerï¼Œè´Ÿè´£ç”Ÿäº§ go producer(numChan) // åŒå‘é€šé“å¯ä»¥èµ‹å€¼ç»™åŒç±»å‹çš„å•å‘é€šé“ï¼Œå•å‘ä¸èƒ½è½¬åŒå‘ // 3. å°†numChan ä¼ é€’ç»™consumerï¼Œè´Ÿè´£æ¶ˆè´¹ go consumer(numChan) time.Sleep(2 * time.Second) } // producerç”Ÿäº§è€… ==\u003e æä¾›ä¸€ä¸ªåªå†™é€šé“ func producer(out chan\u003c- int) { for i := 0; i \u003c 10; i++ { out \u003c- i //data := \u003c- out // ä¼šæŠ¥é”™ å†™é€šé“ä¸å…è®¸æœ‰è¯»å–æ“ä½œ fmt.Println(\"======\u003e å‘ç®¡é“ä¸­å†™å…¥æ•°æ®: \", i) } } // consunmeræ¶ˆè´¹è€… ==\u003e æä¾›ä¸€ä¸ªåªè¯»é€šé“ func consumer(in \u003c-chan int) { //in \u003c- 10 // è¯»é€šé“ä¸å…è®¸å†™æ•°æ® for v := range in { fmt.Println(\"ä»ç®¡é“ä¸­è¯»å–æ•°æ®: \", v) } } ç®¡é“æ€»ç»“ï¼š ç®¡é“å†™æ»¡ ==\u003e å†™é˜»å¡ ç®¡é“è¯»å®Œ ==\u003e è¯»é˜»å¡ å¦‚æœç®¡é“æ²¡æœ‰ä½¿ç”¨makeåˆ†é…ç©ºé—´ï¼Œåˆ™é»˜è®¤æ˜¯nil ä»nilçš„ç®¡é“ä¸­è¯»ã€å†™æ•°æ®ï¼Œéƒ½ä¼šé˜»å¡ï¼ˆ__æ³¨ï¼š__ä¸ä¼šå´©æºƒï¼‰ ä»ä¸€ä¸ªå·²ç»closeçš„ç®¡é“è¯»å–æ•°æ®æ—¶ï¼Œä¼šè¿”å›é›¶å€¼ï¼ˆ__æ³¨ï¼š__ä¸ä¼šå´©æºƒï¼›æ­¤å¤„çš„é›¶å€¼å¹¶éæ™®é€šint 0ï¼Œè€Œæ˜¯é€»è¾‘å‡ï¼Œå¯ä»¥ç»ˆæ­¢forå¾ªç¯ï¼‰ å¯¹ä¸€ä¸ªå·²ç»closeçš„ç®¡é“è¿›è¡Œå…³é—­æˆ–å†™æ•°æ®æ“ä½œæ—¶ï¼Œç¨‹åºå°†å´©æºƒ å…³é—­ç®¡é“çš„åŠ¨ä½œï¼Œä¸€å®šè¦æ”¾åœ¨å†™ç«¯ï¼Œä¸èƒ½æ”¾åœ¨è¯»ç«¯ï¼ˆè¯»ç«¯æ€ä¹ˆçŸ¥é“ä»€ä¹ˆæ—¶å€™å†™å®Œå‘¢ï¼Ÿï¼‰ è¯»å’Œå†™çš„æ¬¡æ•°ä¸€å®šè¦å¯¹ç­‰ï¼Œå¦åˆ™ï¼š å­goç¨‹ä¸­ï¼Œèµ„æºæ³„éœ² ä¸»goç¨‹ä¸­ï¼Œç¨‹åºå´©æºƒ (deadlock) ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:2:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"4. Select å½“ç¨‹åºä¸­æœ‰å¤šä¸ªchannelååŒå·¥ä½œï¼šch1ã€ch2ï¼ŒæŸæ—¶åˆ»ch1æˆ–ch2è¢«è§¦å‘ï¼Œç¨‹åºè¦åšç›¸åº”çš„å¤„ç†ã€‚ ä½¿ç”¨selectæ¥ç›‘å¬å¤šé€šé“ï¼Œå½“ç®¡é“è¢«è§¦å‘æ—¶ï¼ˆå†™å…¥æ•°æ®ã€è¯»å–æ•°æ®ã€å…³é—­é€šé“ï¼‰ selectè¯­æ³•ä¸switch caseå¾ˆåƒï¼Œä½†æ˜¯æ‰€æœ‰çš„åˆ†æ”¯æ¡ä»¶éƒ½å¿…é¡»æ˜¯é€šé“io func main() { // var chan1, chan2 chan int chan1 := make(chan int) chan2 := make(chan int) // å¯åŠ¨ä¸€ä¸ªgoç¨‹ï¼Œè´Ÿè´£ç›‘å¬ä¸¤ä¸ªchannel go func() { for { fmt.Println(\"ç›‘å¬ä¸­.........\") select { case data1 := \u003c-chan1: fmt.Println(\" ä»chan1è¯»å–æ•°æ®æˆåŠŸ, data1: \", data1) case data2 := \u003c-chan2: fmt.Println(\"------------\u003e ä»chan2è¯»å–æ•°æ®æˆåŠŸ, data2: \", data2) default: // æ²¡è§¦å‘ä¸Šè¾¹çš„å°±è§¦å‘default fmt.Println(\"select default called\") time.Sleep(time.Second) } } }() // å¯åŠ¨go1 å†™chan1 go func() { for i := 0; i \u003c 10; i++ { chan1 \u003c- i time.Sleep(1 * time.Second / 2) } }() // å¯åŠ¨go2 å†™chan2 go func() { for i := 0; i \u003c 10; i++ { chan2 \u003c- i time.Sleep(1 * time.Second) } }() for { fmt.Println(\"Over!!! \") time.Sleep(5 * time.Second) } } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:2:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"å››ã€ç½‘ç»œç¼–ç¨‹ï¼ˆéŸ©ï¼‰ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:3:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"4.1 åŸºç¡€çŸ¥è¯† ç«¯å£ï¼š åœ¨è®¡ç®—æœºï¼ˆå°¤å…¶æ˜¯åšæœåŠ¡å™¨ï¼‰ï¼Œè¦å°½å¯èƒ½å°‘å¼€ç«¯å£ ä¸€ä¸ªç«¯å£åªèƒ½è¢«ä¸€ä¸ªç¨‹åºç›‘å¬ å¯ä»¥ä½¿ç”¨ netstat -an æŸ¥çœ‹æœ¬æœºæœ‰å“ªäº›ç«¯å£åœ¨ç›‘å¬ å¯ä»¥ä½¿ç”¨ netstat -anb æŸ¥çœ‹ç›‘å¬ç«¯å£çš„pidï¼Œå†ç»“åˆä»»åŠ¡ç®¡ç†å™¨å…³é—­ä¸å®‰å…¨çš„ç«¯å£ æœåŠ¡ç«¯éœ€è¦èµ·å¤šä¸ªgoroutineå¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:3:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"4.2 å®ä¾‹ æœåŠ¡å™¨ï¼š å¯è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ï¼› å¯å¤šæ¬¡æ¥æ”¶å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼› æ¥æ”¶ exit å…³é—­è¿æ¥ã€‚ å®¢æˆ·ç«¯ï¼š å¯å¤šæ¬¡å‘é€æ¶ˆæ¯ï¼› å‘é€ exit å…³é—­è¿æ¥ã€‚ server.go func serverDemo() { fmt.Println(\"æœåŠ¡å™¨å¼€å§‹ç›‘å¬......\") // 1. å¼€å¯ä¸€ä¸ªç›‘å¬ç«¯å£ listener, err := net.Listen(\"tcp\", \"0.0.0.0:8888\") if err != nil { fmt.Println(\"listen err =\", err) return } defer listener.Close() fmt.Println(\"listener is:\", listener) // 2. ç­‰å¾…è¿æ¥ for { fmt.Println(\"ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥......\") conn, err := listener.Accept() if err != nil { fmt.Println(\"accept err =\", err) } fmt.Println(\"conn is:\", conn) fmt.Println(\"è¯¥è¿æ¥çš„å®¢æˆ·ç«¯ip =\", conn.RemoteAddr()) // è·å¾—å®¢æˆ·ç«¯çš„ipåœ°å€ // æ¥æ”¶æ•°æ® go serverProcess(conn) } } // æ¥æ”¶å®¢æˆ·ç«¯æ•°æ® func serverProcess(conn net.Conn) { // å¾ªç¯æ¥æ”¶ defer conn.Close() // ä¸€å®šè¦è®°å¾—å…³é—­ fmt.Printf(\"server ç­‰å¾… å®¢æˆ·ç«¯:%v å‘é€ä¿¡æ¯......\\n\", conn.RemoteAddr()) for { // åˆ›å»ºåˆ‡ç‰‡ï¼Œç”¨æ¥æ¥æ”¶ buf := make([]byte, 1024) // 1. ç­‰å¾…å®¢æˆ·ç«¯é€šè¿‡connå‘é€ä¿¡æ¯ // 2. å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰write[å‘é€ä¿¡æ¯]ï¼Œé‚£ä¹ˆåç¨‹å°±é˜»å¡åœ¨è¿™é‡Œ n, err := conn.Read(buf) if err != nil { fmt.Println(\"server conn.Read err =\", err) return } //fmt.Println(\"è¯»å–messageé•¿åº¦ä¸º:\", n) // æ˜¾ç¤ºmessage message := string(buf[:n]) // æ³¨æ„è¦[:n] fmt.Printf(\"ä¿¡æ¯: %v æ¥è‡ªå®¢æˆ·ç«¯:%v\\n\", message, conn.RemoteAddr()) if message == \"exit\" { break } } fmt.Printf(\"å®¢æˆ·ç«¯: %v é€€å‡º......\\n\", conn.RemoteAddr()) } func main() { serverDemo() } client.go func clientDemo() { conn, err := net.Dial(\"tcp\", \"192.168.0.108:8888\") if err != nil { fmt.Println(\"client dial err =\", err) return } fmt.Println(\"client conn is:\", conn) clientProcess(conn) } func clientProcess(conn net.Conn) { defer conn.Close() for { fmt.Print(\"è¯·è¾“å…¥è¦å‘é€çš„ä¿¡æ¯: \") // åŠŸèƒ½1ï¼šå®¢æˆ·ç«¯å‘é€å•è¡Œæ•°æ®ï¼Œç„¶åé€€å‡º reader := bufio.NewReader(os.Stdin) // os.Stdin ä»£è¡¨æ ‡å‡†è¾“å…¥ï¼ˆç»ˆç«¯ï¼‰ // ä»ç»ˆç«¯è¯»å–ä¸€è¡Œç”¨æˆ·è¾“å…¥ï¼Œå¹¶å‡†å¤‡å‘ç»™æœåŠ¡å™¨ message, err := reader.ReadString('\\n') // ä¼šå¤šè¯»ä¸€ä¸ª'\\n' if err != nil { fmt.Println(\"ReadString err =\", err) } message = strings.Trim(message, \" \\r\\n\") // åˆ æ‰ \" \\r\\n\" // å†å°†messageå‘é€ç»™æœåŠ¡å™¨ n, err := conn.Write([]byte(message)) if err != nil { fmt.Println(\"conn.Write err =\", err) } fmt.Printf(\"messageé•¿åº¦ä¸º%v å‘é€æˆåŠŸ......\\n\", n) // å½“è¾“å…¥ exit é€€å‡º if message == \"exit\" { break } } fmt.Println(\"å®¢æˆ·ç«¯é€€å‡º......\") } func main() { clientDemo() } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:3:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"äº”ã€Redis ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5.1 åŸºæœ¬ä»‹ç» Redis(REmote Dictionary Server(è¿œç¨‹å­—å…¸æœåŠ¡å™¨)) æ˜¯NoSQLæ•°æ®åº“ï¼Œä¸æ˜¯ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ï¼Œä¹Ÿè¢«ç§°ä¸ºæ•°æ®ç»“æ„æ•°æ®åº“ã€‚ æ€§èƒ½éå¸¸é«˜ï¼Œé€šå¸¸ç”¨ä½œç¼“å­˜ã€æŒä¹…åŒ–ã€‚ å¼€æºï¼Œåˆ†å¸ƒå¼ï¼ŒåŸºäºå†…å­˜è¿è¡Œå¹¶æ”¯æŒæŒä¹…åŒ–ã€‚ Redisçš„äº”å¤§æ•°æ®ç±»å‹ï¼š Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ Hashï¼ˆå“ˆå¸Œï¼‰ Listï¼ˆåˆ—è¡¨ï¼‰ Setï¼ˆé›†åˆï¼‰ zsetï¼ˆsorted set: æœ‰åºé›†åˆï¼‰ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5.2 å®‰è£…é…ç½® ä¸‹è½½åç›´æ¥è§£å‹å°±æœ‰Redisçš„æœåŠ¡ç«¯ç¨‹åº(redis-server.exe)å’Œå®¢æˆ·ç«¯ç¨‹åº(redis-cli.exe)ï¼ŒåŒå‡»ç›´æ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…ã€‚ Redisæ“ä½œåŸç†å›¾ï¼š åŒå‡»æ‰“å¼€ redis-server.exeã€‚ ç„¶åæ‰“å¼€ redis-cli.exe å³å¯è¿æ¥ä¸Šã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5.3 åŸºæœ¬ä½¿ç”¨ Redisä½¿ç”¨æ‰‹å†Œï¼šhttp://doc.redisfans.com/ è¯´æ˜ï¼š Rediså®‰è£…å¥½åï¼Œé»˜è®¤æœ‰16ä¸ªæ•°æ®åº“ï¼Œåˆå§‹é»˜è®¤ä½¿ç”¨0å·åº“ï¼Œç¼–å·æ˜¯0â€¦15. æ·»åŠ  key-value [set] æŸ¥çœ‹å½“å‰redisçš„æ‰€æœ‰ key [keys *] è·å– key å¯¹åº”çš„å€¼ åˆ‡æ¢ redis æ•°æ®åº“ [select index] å¦‚ä½•æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„ key-val æ•°é‡ [dbsize] æ¸…ç©ºå½“å‰æ•°æ®åº“çš„ key-val å’Œ æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“çš„ key-val [flushdb] [flushall] 127.0.0.1:6379\u003e set key1 hello OK 127.0.0.1:6379\u003e keys * 1) \"key1\" 127.0.0.1:6379\u003e get key1 \"hello\" 127.0.0.1:6379\u003e select 1 OK 127.0.0.1:6379[1]\u003e keys * (empty list or set) 127.0.0.1:6379[1]\u003e select 0 OK 127.0.0.1:6379\u003e dbsize (integer) 1 127.0.0.1:6379\u003e flushdb OK 127.0.0.1:6379\u003e keys * (empty list or set) ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5.4 Redisçš„Crudæ“ä½œ 5.4.1 åŸºæœ¬æ•°æ®ç±»å‹ Redisçš„äº”å¤§æ•°æ®ç±»å‹ï¼š Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ Hashï¼ˆå“ˆå¸Œï¼‰ Listï¼ˆåˆ—è¡¨ï¼‰ Setï¼ˆé›†åˆï¼‰ zsetï¼ˆsorted set: æœ‰åºé›†åˆï¼‰ 5.4.2 String 127.0.0.1:6379\u003e set address beijing OK 127.0.0.1:6379\u003e get address \"beijing\" 127.0.0.1:6379\u003e del address (integer) 1 127.0.0.1:6379\u003e get address (nil) **æ³¨æ„ï¼š**æ­¤å¤„çš„ setï¼Œå¦‚æœå­˜åœ¨å°±æ˜¯ä¿®æ”¹ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ˜¯æ·»åŠ ã€‚ å¢æ”¹ï¼šset æŸ¥ï¼šget åˆ ï¼šdel é™æ—¶çš„é”®å€¼å¯¹ï¼šsetex key seconds value 127.0.0.1:6379\u003e setex message 6 hello OK 127.0.0.1:6379\u003e get message \"hello\" # 6s å 127.0.0.1:6379\u003e get message (nil) åŒæ—¶è®¾ç½®å¤šä¸ªé”®å€¼å¯¹ï¼šmset key1 value1 key2 value2 åŒæ—¶è·å–å¤šä¸ªé”®å€¼å¯¹ï¼šmget key1 key2 127.0.0.1:6379\u003e mset key1 hello key2 world OK 127.0.0.1:6379\u003e keys * 1) \"key2\" 2) \"key1\" 127.0.0.1:6379\u003e get key1 \"hello\" 127.0.0.1:6379\u003e get key2 \"world\" 127.0.0.1:6379\u003e mget key1 key2 1) \"hello\" 2) \"world\" 5.4.3 Hashï¼ˆç±»ä¼¼mapï¼‰ Redis hash æ˜¯ä¸€ä¸ªé”®å€¼å¯¹(key-value)é›†åˆ(key ä¸èƒ½é‡å¤)ã€‚æ˜¯ä¸€ä¸ªstringç±»å‹çš„fieldå’Œvalueçš„æ˜ å°„è¡¨ï¼Œhashç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ã€‚ä¾‹å¦‚å­˜æ”¾ä¸€ä¸ªuserä¿¡æ¯ï¼š key: user1 value: name â€œsmithâ€ age 30 job â€œcoderâ€ # è¿™å°±æ˜¯ä¸‰å¯¹field-value å¢æ”¹ï¼šhset key field value æŸ¥ï¼šhget key field value åˆ ï¼šhdel key field.. åŒæ—¶è®¾ç½®å¤šä¸ªfield-valueå¯¹ï¼šhmset key field value field value.. åŒæ—¶è·å–å¤šä¸ªfield-valueå¯¹ï¼šhmget key field.. è·å–è¯¥keyçš„æ‰€æœ‰ä¿¡æ¯ï¼šhgetall key è·å–æŸkeyçš„fieldæ•°ï¼šhlen key åˆ¤æ–­æŸkeyçš„æŸfieldæ˜¯å¦å­˜åœ¨ï¼šhexists key field 127.0.0.1:6379\u003e hset user1 name \"smith\" (integer) 1 127.0.0.1:6379\u003e hset user1 age 30 (integer) 1 127.0.0.1:6379\u003e hset user1 job coder (integer) 1 127.0.0.1:6379\u003e hget user1 name \"smith\" 127.0.0.1:6379\u003e hget user1 job \"coder\" 127.0.0.1:6379\u003e hget user1 age \"30\" 127.0.0.1:6379\u003e hgetall user1 1) \"name\" 2) \"smith\" 3) \"age\" # å‰è¾¹çš„æ˜¯fieldï¼Œä¸‹è¾¹æ˜¯value 4) \"30\" 5) \"job\" 6) \"coder\" 127.0.0.1:6379\u003e hdel user1 name age job (integer) 3 127.0.0.1:6379\u003e hmset user1 name jerry age 24 job \"java coder\" OK 127.0.0.1:6379\u003e hmget user1 name age job 1) \"jerry\" 2) \"24\" 3) \"java coder\" 127.0.0.1:6379\u003e hlen user1 (integer) 3 127.0.0.1:6379\u003e hexists user1 name (integer) 1 127.0.0.1:6379\u003e hexists user1 work (integer) 0 ç”±ä¸Šè¿°è¾“å‡ºä¹Ÿå¯çœ‹å‡ºï¼Œå½“rediså­˜å‚¨çš„æ—¶å€™ï¼Œç±»å‹éƒ½æ˜¯stringã€‚ 5.4.4 List Listæ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚**å¯ä»¥å¤´æ’å’Œå°¾æ’ã€‚**Listæœ¬è´¨æ˜¯ä¸ªé“¾è¡¨ï¼ŒListçš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œä¸”å¯ä»¥é‡å¤ã€‚ å¢æ”¹ï¼šlpush key value../rpush key value..ã€‚ æŸ¥ï¼šlrange key start stopï¼Œè¿”å›åˆ—è¡¨keyä¸­æŒ‡å®šåŒºé—´çš„å…ƒç´ ï¼Œ0è¡¨ç¤ºç¬¬ä¸€ä¸ªï¼Œ-1è¡¨ç¤ºæœ€åä¸€ä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚ â€‹ lpop key/rpop keyï¼Œå¼¹å‡ºå·¦/å³æ ˆé¡¶å…ƒç´ ï¼ˆæŸ¥çœ‹å¹¶åˆ é™¤ï¼‰ã€‚ åˆ ï¼šdel key..ï¼Œåˆ é™¤å¤šä¸ªListã€‚ æŸ¥çœ‹Listçš„é•¿åº¦ï¼šllen keyï¼Œè‹¥ä¸å­˜åœ¨ï¼Œè¿”å›0ã€‚ 127.0.0.1:6379\u003e lpush city beijing shanghai tianjin (integer) 3 127.0.0.1:6379\u003e lrange city 0 -1 1) \"tianjin\" 2) \"shanghai\" 3) \"beijing\" # å‘ç°æ²¡ï¼Ÿæ˜¯å€’ç€çš„ï¼Œç›¸å½“äºæ ˆ(å³è¾¹æ˜¯åº•)ã€‚ 127.0.0.1:6379\u003e lpush heroList aaa bbb ccc (integer) 3 127.0.0.1:6379\u003e lrange heroList 0 -1 1) \"ccc\" 2) \"bbb\" 3) \"aaa\" 127.0.0.1:6379\u003e rpush heroList ddd eee (integer) 5 127.0.0.1:6379\u003e lrange heroList 0 -1 1) \"ccc\" 2) \"bbb\" 3) \"aaa\" 4) \"ddd\" 5) \"eee\" 127.0.0.1:6379\u003e lpop heroList \"ccc\" 127.0.0.1:6379\u003e rpop heroList \"eee\" 127.0.0.1:6379\u003e lrange heroList 0 -1 1) \"bbb\" 2) \"aaa\" 3) \"ddd\" 127.0.0.1:6379\u003e del heroList (integer) 1 127.0.0.1:6379\u003e lpop heroList (nil) 127.0.0.1:6379\u003e llen heroList (integer) 0 127.0.0.1:6379\u003e lpush heroList aaa bbb ccc (integer) 3 127.0.0.1:6379\u003e llen heroList (integer) 3 5.4.5 Setï¼ˆé›†åˆï¼‰ Redisçš„Setæ˜¯stringç±»å‹çš„æ— åºé›†åˆã€‚åº•å±‚æ˜¯HashTableæ•°æ®ç»“æ„ï¼ŒSetä¹Ÿæ˜¯å­˜æ”¾å¾ˆå¤šå­—ç¬¦ä¸²å…ƒç´ ï¼Œä½†å­—ç¬¦ä¸²å…ƒç´ æ˜¯æ— åºçš„ï¼Œä¸”å…ƒç´ ä¸å¯é‡å¤ã€‚ å¢æ”¹ï¼šsadd key member.. æŸ¥ï¼šsmembers key åˆ ï¼šdel key åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ªmemberï¼šsismember key member åˆ é™¤æŒ‡å®šmemberï¼šsrem key member.. 127.0.0.1:6379\u003e sadd emails tom@sohu.com jack@qq.com (integer) 2 127.0.0.1:6379\u003e smembers emails 1) \"jack@qq.com\" 2) \"tom@sohu.com\" 127.0.0.1:6379\u003e sadd emails aaa@bbb.com ccc@ddd.com (integer) 2 127.0.0.1:6379\u003e smembers emails 1) \"ccc@ddd.com\" 2) \"jack@qq.com\" 3) \"aaa@bbb.com\" 4) \"tom@sohu.com\" 127.0.0.1:6379\u003e del emails (integer) 1 127.0.0.1:6379\u003e smembers emails (empty list or set) 127.0.0.1:6379\u003e sadd emails tom@sohu.com jack@qq.com (integer) 2 127.0.0.1:6379\u003e sismember emails tom@sohu.com (integer) 1 127.0.0.1:6379\u003e srem emails tom@sohu.com (integer) 1 127.0.0.1:6379\u003e sismember emails tom@sohu.com (integer) 0 ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5.5 Golangæ“ä½œRedis 5.5.1 å®‰è£… å®‰è£…ç¬¬ä¸‰æ–¹å¼€æºçš„Redisåº“ï¼š go get github.com/gomodule/redigo/redis 5.5.2 åŸºæœ¬æ“ä½œ å…¶å®å’Œç›´æ¥ç”¨redis-cliä¸€æ ·ï¼Œåªä¸è¿‡æ˜¯æŠŠå‘½ä»¤å†™åœ¨ conn.Do(\"å‘½ä»¤\", )ï¼Œç„¶åå„å‚æ•°æœ¬æ¥æ˜¯æŒ‰ç©ºæ ¼åˆ†å¼€çš„ï¼Œç°åœ¨æ”¹æˆé€—å·éš”å¼€ã€‚ 5.5.2.1 æ·»åŠ å’Œè·å–key-value å»ºç«‹è¿æ¥ï¼š conn, err := redis.Dial(\"tcp\", \"127.0.0.1:6379\") if err != nil { fmt.Println(\"redis.Dial err =\", err) return } defer conn.Close() å†™æ•°æ®ï¼š // 2. é€šè¿‡go å‘rediså†™å…¥æ•°æ® string [key-value] _, err = conn.Do(\"set\", \"name\", \"tomjerry\") if err != nil { fmt.Println(\"set err =\", err) return } è¯»æ•°æ®ï¼š // 3. è¯»å–æ•°æ® string [key-value] r, err := redis.String(conn.Do(\"get\", \"name\")) // è½¬æ¢æˆstring if err != nil { fmt.Println(\"get err =\", err) return } fmt.Println(\"æ“ä½œokï¼Œè¿”å›æ•°æ®:\", r) 5.5.2.2 æ“ä½œhash func operateHash() { // 1. è¿æ¥åˆ°redis conn, err := redis.Dial(\"tcp\", \"127.0.0.1:6379\") if err != nil { fmt.Println(\"redis.Dial err =\", err) return } defer conn.Close() //fmt.Println(\"redis conn is\", conn) // 2. é€šè¿‡go å‘rediså†™å…¥æ•°æ® hset [key-field-value] /* // å•ä¸ªæ·»åŠ  _, err = conn.Do(\"hset\", \"user1\", \"name\", \"tomjerry\") if err != nil { fmt.Println(\"hset err =\", err) return } _, err = conn.Do(\"hset\", \"user1\", \"age\", \"20\") if err != nil { fmt.Println(\"hset err =\", err) return }*/ // æ‰¹é‡æ·»åŠ  _, err = conn.Do(\"hmset\", \"user2\", \"name\", \"john\", \"age\", \"18\") if err != nil { fmt.Println(\"hmset err =\", err) return } // 3. è¯»å–æ•°æ® string [key-value] /* // å•ä¸ªè¯»å– r1, err := redis.String(conn.Do(\"hget\", \"user1\", \"name\")) // è½¬æ¢æˆstring if err != nil { fmt.Println(\"hget err =\", err) return } r2, err := redis.Int(conn.Do(\"hget\", \"user1\", \"age\")) // è½¬æ¢æˆstring if err != nil { fmt.Println(\"hget err =\", err) return } fmt.Printf(\"æ“ä½œokï¼Œè¿”å›æ•°æ®: %v: %v\\n\", r1, r2)*/ // æ‰¹é‡è¯»å– r, err := redis.Strings(conn.Do(\"hmget\", \"user2\", \"name\", \"age\")) // è½¬æ¢æˆstring if err != nil { fmt.Println(\"hmget err =\", err) return } for i, v := range r { fmt.Printf(\"%v: %v\\n\", i, v) } } 5.5.3 è¿æ¥æ±  ä¸Šé¢çš„æ“ä½œï¼Œéœ€è¦æ¯æ¬¡éƒ½æ–°å¼€ä¸€ä¸ªconnè¿æ¥ï¼Œç„¶åç”¨å®Œå°±å…³é—­ã€‚å…¶å®è¿™æ ·å¾ˆæµªè´¹èµ„æºï¼Œå› æ­¤é‡‡ç”¨Redisè¿æ¥æ± ã€‚ è¯´æ˜ï¼š äº‹å…ˆåˆå§‹åŒ–ä¸€å®šæ•°é‡çš„è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ï¼Œå³åˆå§‹åŒ–è¿æ¥æ± ï¼› å½“Goéœ€è¦æ“ä½œRedisæ—¶ï¼Œå°±ä»è¿æ¥æ± å–å‡ºä¸€ä¸ªconnå³å¯ï¼› ç­‰åˆ°å®Œå…¨ä¸éœ€è¦äº†ï¼Œå…³é—­è¿æ¥æ± ï¼› è¿™æ ·å¯ä»¥èŠ‚çœä¸´æ—¶å»ºç«‹connçš„æ—¶é—´ï¼Œæé«˜æ•ˆç‡ã€‚ æ ¸å¿ƒä»£ç ï¼š // å®šä¹‰ä¸€ä¸ªå…¨å±€pool var pool *redis.Pool func init() { pool = \u0026redis.Pool{ Dial: func() (redis.Conn, error) { // åˆå§‹åŒ–è¿æ¥çš„ä»£ç ï¼Œè¿æ¥å“ªä¸ªipï¼Œç«¯å£ return redis.Dial(\"tcp\", \"localhost:6379\") }, TestOnBorrow: nil, MaxIdle: 8, // æœ€å¤§ç©ºé—²è¿æ¥æ•° MaxActive: 0, // è¡¨ç¤ºå’Œæ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°ï¼Œ0è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ IdleTimeout: 100, // æœ€å¤§ç©ºé—²æ—¶é—´ Wait: false, MaxConnLifetime: 0, } } func operatePool() { // å…ˆä»ä¸€ä¸ªpoolå–å‡ºä¸€ä¸ªè¿æ¥ conn := pool.Get() defer conn.Close() _, err := conn.Do(\"set\", \"name\", \"tom\") if err != nil { fmt.Println(\"set err =\", err) return } r, err := redis.String(conn.Do(\"get\", \"name\")) if err != nil { fmt.Println(\"get err =\", err) return } fmt.Println(\"get r =\", r) // å…³é—­pool pool.Close() conn = pool.Get() // æ­¤æ—¶å–ä¸å‡ºäº†ï¼Œå› ä¸ºpoolå·²å…³é—­ } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:4:5","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"å…­ã€MySQL Goè¯­è¨€ä¸­çš„database/sqlåŒ…æä¾›äº†ä¿è¯SQLæˆ–ç±»SQLæ•°æ®åº“çš„æ³›ç”¨æ¥å£ï¼Œå¹¶ä¸æä¾›å…·ä½“çš„æ•°æ®åº“é©±åŠ¨ã€‚ä½¿ç”¨database/sqlåŒ…æ—¶å¿…é¡»æ³¨å…¥ï¼ˆè‡³å°‘ï¼‰ä¸€ä¸ªæ•°æ®åº“é©±åŠ¨ã€‚ æˆ‘ä»¬å¸¸ç”¨çš„æ•°æ®åº“åŸºæœ¬ä¸Šéƒ½æœ‰å®Œæ•´çš„ç¬¬ä¸‰æ–¹å®ç°ã€‚ä¾‹å¦‚ï¼šMySQLé©±åŠ¨ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:5:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"6.1 å®‰è£…é…ç½® ä¸‹è½½MySQL https://dev.mysql.com/downloads/windows/installer/8.0.html é€‰æ‹©8.0ç‰ˆæœ¬ä¸‹è½½ã€‚ ä¸‹è½½é©±åŠ¨ go get -u github.com/go-sql-driver/mysql å¯¼å…¥é©±åŠ¨ import ( \"database/sql\" _ \"github.com/go-sql-driver/mysql\" ) ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:5:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"6.2 åŸºç¡€æ“ä½œ 6.2.1 å‡†å¤‡database create database go_db; use go_db; create table user_tb1(id integer primary key auto_increment, username varchar(20), password varchar(20)); insert into user_tb1(username, password) values(\"tom\", \"123\"); insert into user_tb1(username, password) values(\"kite\", \"456\"); select * from user_tb1; 6.2.2 åˆå§‹åŒ–è¿æ¥ Openå‡½æ•°å¯èƒ½åªæ˜¯éªŒè¯å…¶å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå®é™…ä¸Šå¹¶ä¸åˆ›å»ºä¸æ•°æ®åº“çš„è¿æ¥ã€‚å¦‚æœè¦æ£€æŸ¥æ•°æ®æºçš„åç§°æ˜¯å¦çœŸå®æœ‰æ•ˆï¼Œåº”è¯¥è°ƒç”¨Pingæ–¹æ³•ã€‚ è¿”å›çš„DBå¯¹è±¡å¯ä»¥å®‰å…¨åœ°è¢«å¤šä¸ªgoroutineå¹¶å‘ä½¿ç”¨ï¼Œå¹¶ä¸”ç»´æŠ¤å…¶è‡ªå·±çš„ç©ºé—²è¿æ¥æ± ã€‚å› æ­¤ï¼ŒOpenå‡½æ•°åº”è¯¥ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¾ˆå°‘éœ€è¦å…³é—­è¿™ä¸ªDBå¯¹è±¡ã€‚ dsn := \"user:password@tcp(127.0.0.1:3306)/dbname\" db, err := sql.Open(\"mysql\", dsn) if err != nil { panic(err) } defer db.Close() æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡dbï¼Œç”¨æ¥ä¿å­˜æ•°æ®åº“è¿æ¥å¯¹è±¡ã€‚ var db *sql.DB func initDB() (err error) { dsn := \"root:123456@tcp(127.0.0.1:3306)/go_db?charset=utf8mb4\u0026parseTime=True\" // ä¸ä¼šæ ¡éªŒè´¦å·å¯†ç æ˜¯å¦æ­£ç¡® // æ³¨æ„æ­¤å¤„ä¸ç”¨ï¼š:= db, err = sql.Open(\"mysql\", dsn) if err != nil { return err } // å°è¯•ä¸æ•°æ®åº“å»ºç«‹è¿æ¥ err = db.Ping() if err != nil { return err } return nil } func main() { err := initDB() if err != nil { fmt.Println(\"init db failed, err:\", err) return } } å…¶ä¸­ï¼Œsql.DBæ˜¯è¡¨ç¤ºè¿æ¥çš„æ•°æ®åº“å¯¹è±¡ï¼ˆç»“æ„ä½“å®ä¾‹ï¼‰ï¼Œå®ƒä¿å­˜äº†è¿æ¥æ•°æ®åº“ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ã€‚å®ƒå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªå…·æœ‰é›¶åˆ°å¤šä¸ªåº•å±‚è¿æ¥çš„è¿æ¥æ± ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°è¢«å¤šä¸ªgoroutineåŒæ—¶ä½¿ç”¨ã€‚ å…¶ä»–åˆå§‹åŒ–å‡½æ•° SetMaxOpenConns func (db *DB) SetMaxOpenConns(n int) SetMaxOpenConnsè®¾ç½®ä¸æ•°æ®åº“å»ºç«‹è¿æ¥çš„æœ€å¤§æ•°ç›®ã€‚ å¦‚æœnå¤§äº0ä¸”å°äºæœ€å¤§é—²ç½®è¿æ¥æ•°ï¼Œä¼šå°†æœ€å¤§é—²ç½®è¿æ¥æ•°å‡å°åˆ°åŒ¹é…æœ€å¤§å¼€å¯è¿æ¥æ•°çš„é™åˆ¶ã€‚ å¦‚æœn\u003c=0ï¼Œä¸ä¼šé™åˆ¶æœ€å¤§å¼€å¯è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º0ï¼ˆæ— é™åˆ¶ï¼‰ã€‚ SetMaxIdleConns func (db *DB) SetMaxIdleConns(n int) SetMaxIdleConnsè®¾ç½®è¿æ¥æ± ä¸­çš„æœ€å¤§é—²ç½®è¿æ¥æ•°ã€‚ å¦‚æœnå¤§äºæœ€å¤§å¼€å¯è¿æ¥æ•°ï¼Œåˆ™æ–°çš„æœ€å¤§é—²ç½®è¿æ¥æ•°ä¼šå‡å°åˆ°åŒ¹é…æœ€å¤§å¼€å¯è¿æ¥æ•°çš„é™åˆ¶ã€‚ å¦‚æœn\u003c=0ï¼Œä¸ä¼šä¿ç•™é—²ç½®è¿æ¥ã€‚ 6.2.3 Crud äº‹å…ˆæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ä¸€ä¸ªgo_dbç”¨äºæµ‹è¯•ã€‚ 6.2.3.1 æŸ¥è¯¢æ•°æ® åˆ†ä¸ºä¸¤ç§ï¼š å•è¡ŒæŸ¥è¯¢ å¤šè¡ŒæŸ¥è¯¢ é€šå¸¸æŸ¥è¯¢æ•°æ®å‰ï¼Œè¦å…ˆå®šä¹‰ç»“æ„ä½“æ¥æ¥æ”¶æ•°æ®ã€‚ // å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨äºæ¥æ”¶æ•°æ® type User struct { id int username string password string } å•è¡ŒæŸ¥è¯¢ å•è¡ŒæŸ¥è¯¢db.QueryRow()æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œå¹¶æœŸæœ›è¿”å›æœ€å¤šä¸€è¡Œç»“æœï¼ˆå³Rowï¼‰ã€‚QueryRowæ€»æ˜¯è¿”å›énilçš„å€¼ï¼Œç›´åˆ°è¿”å›å€¼çš„Scanæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæ‰ä¼šè¿”å›è¢«å»¶è¿Ÿçš„é”™è¯¯ã€‚ï¼ˆå¦‚ï¼šæœªæ‰¾åˆ°ç»“æœï¼‰ func (db *DB) QueryRow(query string, args ...interface{}) *Row // 1.1 æŸ¥è¯¢å•è¡Œæ•°æ® func queryOneRow() { s := \"select * from user_tb1 where id = ?\" user := User{} // éå¸¸é‡è¦ï¼šç¡®ä¿QueryRowä¹‹åè°ƒç”¨Scanæ–¹æ³•ï¼Œå¦åˆ™æŒæœ‰çš„æ•°æ®åº“é“¾æ¥ä¸ä¼šè¢«é‡Šæ”¾ err := db.QueryRow(s, 1).Scan(\u0026user.id, \u0026user.username, \u0026user.password) if err != nil { fmt.Println(\"queryOneRow failed, err:\", err) return } fmt.Println(\"query result:\", user) } å¤šè¡ŒæŸ¥è¯¢ å¤šè¡ŒæŸ¥è¯¢db.Query()æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œè¿”å›å¤šè¡Œç»“æœï¼ˆå³Rowsï¼‰ï¼Œä¸€èˆ¬ç”¨äºæ‰§è¡Œselectå‘½ä»¤ã€‚å‚æ•°argsè¡¨ç¤ºqueryä¸­çš„å ä½å‚æ•°ã€‚ func (db *DB) Query(query string, args ...interface{}) (*Rows, error) // 1.2 å¤šè¡ŒæŸ¥è¯¢ func queryRows() { s := \"select * from user_tb1 where id \u003e ?\" rows, err := db.Query(s, 0) // å–å‡º id \u003e 0 çš„ row if err != nil { fmt.Println(\"queryRows failed, err:\", err) return } defer rows.Close() // å¾ªç¯è¯»å– for rows.Next() { user := User{} err = rows.Scan(\u0026user.id, \u0026user.username, \u0026user.password) if err != nil { fmt.Println(\"scan failed, err:\", err) return } fmt.Println(\"query result:\", user) } } 6.2.3.2 æ’å…¥æ•°æ® æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œéƒ½ä½¿ç”¨Execæ–¹æ³•ã€‚ func (db *DB) Exec(query string, args ...interface{}) (Result, error) // 2. æ’å…¥æ•°æ® func insert() { s := \"insert into user_tb1 (username, password) values(?, ?)\" r, err := db.Exec(s, \"jerry\", \"789\") if err != nil { fmt.Println(\"insert failed, err:\", err) return } theId, _ := r.LastInsertId() // æ–°æ’å…¥æ•°æ®çš„id fmt.Printf(\"insert %v success...\", theId) } 6.2.3.3 æ›´æ–°æ•°æ® // 3. æ›´æ–°æ•°æ® func updateRow() { s := \"update user_tb1 set username=?, password=? where id=?\" ret, err := db.Exec(s, \"chuu\", \"0404\", 1) if err != nil { fmt.Println(\"update failed, err:\", err) return } n, err := ret.RowsAffected() // æ“ä½œå½±å“çš„è¡Œæ•° if err != nil { fmt.Println(\"get rowAffected failed, err:\", err) return } fmt.Println(\"update success, affected rows:\", n) } 6.2.3.4 åˆ é™¤æ•°æ® // 4. åˆ é™¤æ•°æ® func deleteRow() { s := \"delete from user_tb1 where id=?\" ret, err := db.Exec(s, 2) if err != nil { fmt.Println(\"delete failed, err:\", err) return } n, err := ret.RowsAffected() if err != nil { fmt.Println(\"get rowAffected failed, err:\", err) return } fmt.Println(\"delete success, affected rows:\", n) } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:5:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"ä¸ƒã€MongoDB mongoDBæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“ã€‚mongoDBä¸­å°†ä¸€æ¡æ•°æ®å­˜å‚¨ä¸ºä¸€ä¸ªæ–‡æ¡£ï¼ˆdocumentï¼‰ï¼Œæ•°æ®ç»“æ„ç”±é”®å€¼ï¼ˆkey-valueï¼‰å¯¹ç»„æˆã€‚ å…¶ä¸­æ–‡æ¡£ç±»ä¼¼äºæˆ‘ä»¬å¹³å¸¸ç¼–ç¨‹ä¸­ç”¨åˆ°çš„JSONå¯¹è±¡ã€‚ æ–‡æ¡£ä¸­çš„å­—æ®µå€¼å¯ä»¥åŒ…å«å…¶ä»–æ–‡æ¡£ï¼Œæ•°ç»„åŠæ–‡æ¡£æ•°ç»„ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:6:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"7.1 ç›¸å…³æ¦‚å¿µ MongoDBæœ¯è¯­/æ¦‚å¿µ è¯´æ˜ å¯¹æ¯”SQLæœ¯è¯­/æ¦‚å¿µ database æ•°æ®åº“ database collection é›†åˆ table document æ–‡æ¡£ row field å­—æ®µ column index index ç´¢å¼• primary key ä¸»é”® MongoDBè‡ªåŠ¨å°†_idå­—æ®µè®¾ç½®ä¸ºä¸»é”® primary key ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:6:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"7.2 å¸¸ç”¨å‘½ä»¤ 7.1 collection # 1. åˆ›å»ºæ–°collection \u003e db.createCollection(\"student\"); { \"ok\" : 1 } # 2. æŸ¥çœ‹æ‰€æœ‰collection \u003e show collections; student # 3. åˆ é™¤æŸæ¡collection \u003e db.student.drop(); true \u003e show collections; \u003e 7.2 document # 1. æ’å…¥ä¸€æ¡document \u003e db.student.insertOne({name:\"å°ç‹å­\", age:18}); { \"acknowledged\" : true, \"insertedId\" : ObjectId(\"62e251bd229c90eb53214c33\") } # 2. æ’å…¥å¤šæ¡document \u003e db.student.insertMany([ ... {name:\"å¼ ä¸‰\", age:20}, ... {name:\"æå››\", age:25}, ... ]) { \"acknowledged\" : true, \"insertedIds\" : [ ObjectId(\"62e25228229c90eb53214c34\"), ObjectId(\"62e25228229c90eb53214c35\") ] } # 3. æŸ¥æ‰¾studentçš„æ‰€æœ‰document \u003e db.student.find() { \"_id\" : ObjectId(\"62e251bd229c90eb53214c33\"), \"name\" : \"å°ç‹å­\", \"age\" : 18 } { \"_id\" : ObjectId(\"62e25228229c90eb53214c34\"), \"name\" : \"å¼ ä¸‰\", \"age\" : 20 } { \"_id\" : ObjectId(\"62e25228229c90eb53214c35\"), \"name\" : \"æå››\", \"age\" : 25 } # 4. æŸ¥æ‰¾age\u003e20çš„æ‰€æœ‰document \u003e db.student.find( ... {age:{$gt:20}} ... ) { \"_id\" : ObjectId(\"62e25228229c90eb53214c35\"), \"name\" : \"æå››\", \"age\" : 25 } # 5. æ›´æ–°document \u003e db.student.update( ... {name:\"å°ç‹å­\"}, ... {name:\"è€ç‹å­\",age:98} ... ); WriteResult({ \"nMatched\" : 1, \"nUpserted\" : 0, \"nModified\" : 1 }) \u003e db.student.find(); { \"_id\" : ObjectId(\"62e251bd229c90eb53214c33\"), \"name\" : \"è€ç‹å­\", \"age\" : 98 } { \"_id\" : ObjectId(\"62e25228229c90eb53214c34\"), \"name\" : \"å¼ ä¸‰\", \"age\" : 20 } { \"_id\" : ObjectId(\"62e25228229c90eb53214c35\"), \"name\" : \"æå››\", \"age\" : 25 } # 6. åˆ é™¤document \u003e db.student.deleteOne({name:\"æå››\"}); { \"acknowledged\" : true, \"deletedCount\" : 1 } \u003e db.student.find(); { \"_id\" : ObjectId(\"62e251bd229c90eb53214c33\"), \"name\" : \"è€ç‹å­\", \"age\" : 98 } { \"_id\" : ObjectId(\"62e25228229c90eb53214c34\"), \"name\" : \"å¼ ä¸‰\", \"age\" : 20 } æ›´å¤šå‘½ä»¤è§ï¼šå®˜æ–¹æ–‡æ¡£ï¼šshellå‘½ä»¤å’Œå®˜æ–¹æ–‡æ¡£ï¼šCRUDæ“ä½œã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:6:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"7.3 Goæ“ä½œMongoDB å®‰è£…mongoDB Goé©±åŠ¨åŒ… go get github.com/mongodb/mongo-go-driver 7.3.1 åˆå§‹åŒ– å¯åŠ¨è¿æ¥ï¼š var client *mongo.Client func initDB() error { // è®¾ç½®å®¢æˆ·ç«¯è¿æ¥ clientOptions := options.Client().ApplyURI(\"mongodb://root:123456@127.0.0.1:27017\") // è¿æ¥åˆ°db c, err := mongo.Connect(context.TODO(), clientOptions) if err != nil { log.Fatalln(err) return err } else { fmt.Printf(\"client: %v\\n\", c) } err = c.Ping(context.TODO(), nil) if err != nil { log.Fatalln(err) return err } else { fmt.Println(\"è¿æ¥æˆåŠŸ!\") } client = c return nil } å…³é—­è¿æ¥ï¼š func mongoClose() { err := client.Disconnect(context.TODO()) if err != nil { log.Fatalln(err) } fmt.Println(\"Connection to MongoDB closed.\") } è¿æ¥æ± æ¨¡å¼ï¼š func connectToDB(uri, name string, timeout time.Duration, num uint64) (*mongo.Database, error) { ctx, cancel := context.WithTimeout(context.Background(), timeout) defer cancel() o := options.Client().ApplyURI(uri) o.SetMaxPoolSize(num) client, err := mongo.Connect(ctx, o) if err != nil { return nil, err } return client.Database(name), nil } 7.3.2 BSON MongoDBä¸­çš„JSONæ–‡æ¡£å­˜å‚¨åœ¨åä¸ºBSON(äºŒè¿›åˆ¶ç¼–ç çš„JSON)çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ã€‚ä¸å…¶ä»–å°†JSONæ•°æ®å­˜å‚¨ä¸ºç®€å•å­—ç¬¦ä¸²å’Œæ•°å­—çš„æ•°æ®åº“ä¸åŒï¼ŒBSONç¼–ç æ‰©å±•äº†JSONè¡¨ç¤ºï¼Œä½¿å…¶åŒ…å«é¢å¤–çš„ç±»å‹ï¼Œå¦‚intã€longã€dateã€æµ®ç‚¹æ•°å’Œdecimal128ã€‚è¿™ä½¿å¾—åº”ç”¨ç¨‹åºæ›´å®¹æ˜“å¯é åœ°å¤„ç†ã€æ’åºå’Œæ¯”è¾ƒæ•°æ®ã€‚ è¿æ¥MongoDBçš„Goé©±åŠ¨ç¨‹åºä¸­æœ‰ä¸¤å¤§ç±»å‹è¡¨ç¤ºBSONæ•°æ®ï¼šDå’ŒRawã€‚ ç±»å‹Då®¶æ—è¢«ç”¨æ¥ç®€æ´åœ°æ„å»ºä½¿ç”¨æœ¬åœ°Goç±»å‹çš„BSONå¯¹è±¡ã€‚è¿™å¯¹äºæ„é€ ä¼ é€’ç»™MongoDBçš„å‘½ä»¤ç‰¹åˆ«æœ‰ç”¨ã€‚Då®¶æ—åŒ…æ‹¬å››ç±»: Dï¼šä¸€ä¸ªBSONæ–‡æ¡£ã€‚è¿™ç§ç±»å‹åº”è¯¥åœ¨é¡ºåºé‡è¦çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œæ¯”å¦‚MongoDBå‘½ä»¤ã€‚ Mï¼šä¸€å¼ æ— åºçš„mapã€‚å®ƒå’ŒDæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ƒä¸ä¿æŒé¡ºåºã€‚ Aï¼šä¸€ä¸ªBSONæ•°ç»„ã€‚ Eï¼šDé‡Œé¢çš„ä¸€ä¸ªå…ƒç´ ã€‚ è¦ä½¿ç”¨BSONï¼Œéœ€è¦å…ˆå¯¼å…¥ä¸‹é¢çš„åŒ…ï¼š import \"go.mongodb.org/mongo-driver/bson\" ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨Dç±»å‹æ„å»ºçš„è¿‡æ»¤å™¨æ–‡æ¡£çš„ä¾‹å­ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥æ‰¾nameå­—æ®µä¸â€™å¼ ä¸‰â€™æˆ–â€™æå››â€™åŒ¹é…çš„æ–‡æ¡£: bson.D{{ \"name\", bson.D{{ \"$in\", bson.A{\"å¼ ä¸‰\", \"æå››\"}, }}, }} Rawç±»å‹å®¶æ—ç”¨äºéªŒè¯å­—èŠ‚åˆ‡ç‰‡ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨Lookup()ä»åŸå§‹ç±»å‹æ£€ç´¢å•ä¸ªå…ƒç´ ã€‚å¦‚æœä½ ä¸æƒ³è¦å°†BSONååºåˆ—åŒ–æˆå¦ä¸€ç§ç±»å‹çš„å¼€é”€ï¼Œé‚£ä¹ˆè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚è¿™ä¸ªæ•™ç¨‹æˆ‘ä»¬å°†åªä½¿ç”¨Dç±»å‹ã€‚ 7.3.3 Crud é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªStudentç±»å‹ï¼š ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:6:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"å…«ã€Template html/templateåŒ…å®ç°äº†æ•°æ®é©±åŠ¨çš„æ¨¡æ¿ï¼Œç”¨äºç”Ÿæˆå¯é˜²æ­¢ä»£ç æ³¨å…¥çš„å®‰å…¨çš„HTMLå†…å®¹ã€‚å®ƒæä¾›äº†å’Œtext/templateåŒ…ç›¸åŒçš„æ¥å£ï¼ŒGoè¯­è¨€ä¸­è¾“å‡ºHTMLçš„åœºæ™¯éƒ½åº”ä½¿ç”¨html/templateè¿™ä¸ªåŒ…ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8.1 æ¨¡æ¿ä¸æ¸²æŸ“ åœ¨ä¸€äº›å‰åç«¯ä¸åˆ†ç¦»çš„Webæ¶æ„ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åœ¨åç«¯å°†ä¸€äº›æ•°æ®æ¸²æŸ“åˆ°HTMLæ–‡æ¡£ä¸­ï¼Œä»è€Œå®ç°åŠ¨æ€çš„ç½‘é¡µï¼ˆç½‘é¡µçš„å¸ƒå±€å’Œæ ·å¼å¤§è‡´ä¸€æ ·ï¼Œä½†å±•ç¤ºçš„å†…å®¹å¹¶ä¸ä¸€æ ·ï¼‰æ•ˆæœã€‚ æˆ‘ä»¬è¿™é‡Œè¯´çš„æ¨¡æ¿å¯ä»¥ç†è§£ä¸ºäº‹å…ˆå®šä¹‰å¥½çš„HTMLæ–‡æ¡£æ–‡ä»¶ï¼Œæ¨¡æ¿æ¸²æŸ“çš„ä½œç”¨æœºåˆ¶å¯ä»¥ç®€å•ç†è§£ä¸ºæ–‡æœ¬æ›¿æ¢æ“ä½œâ€“ä½¿ç”¨ç›¸åº”çš„æ•°æ®å»æ›¿æ¢HTMLæ–‡æ¡£ä¸­äº‹å…ˆå‡†å¤‡å¥½çš„æ ‡è®°ã€‚ å¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„Webæ¡†æ¶ä¸­éƒ½ä½¿ç”¨å„ç§æ¨¡æ¿å¼•æ“ï¼Œæ¯”å¦‚Pythonè¯­è¨€ä¸­Flaskæ¡†æ¶ä¸­ä½¿ç”¨çš„jinja2æ¨¡æ¿å¼•æ“ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8.2 Goè¯­è¨€çš„æ¨¡æ¿å¼•æ“ Goè¯­è¨€å†…ç½®äº†æ–‡æœ¬æ¨¡æ¿å¼•æ“text/templateå’Œç”¨äºHTMLæ–‡æ¡£çš„html/templateã€‚å®ƒä»¬çš„ä½œç”¨æœºåˆ¶å¯ä»¥ç®€å•å½’çº³å¦‚ä¸‹ï¼š æ¨¡æ¿æ–‡ä»¶é€šå¸¸å®šä¹‰ä¸º.tmplå’Œ.tplä¸ºåç¼€ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„åç¼€ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨UTF8ç¼–ç ã€‚ æ¨¡æ¿æ–‡ä»¶ä¸­ä½¿ç”¨{{å’Œ}}åŒ…è£¹å’Œæ ‡è¯†éœ€è¦ä¼ å…¥çš„æ•°æ®ã€‚ ä¼ ç»™æ¨¡æ¿è¿™æ ·çš„æ•°æ®å°±å¯ä»¥é€šè¿‡ç‚¹å·ï¼ˆ.ï¼‰æ¥è®¿é—®ï¼Œå¦‚æœæ•°æ®æ˜¯å¤æ‚ç±»å‹çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡{ { .FieldName }}æ¥è®¿é—®å®ƒçš„å­—æ®µã€‚ é™¤{{å’Œ}}åŒ…è£¹çš„å†…å®¹å¤–ï¼Œå…¶ä»–å†…å®¹å‡ä¸åšä¿®æ”¹åŸæ ·è¾“å‡ºã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8.3 æ¨¡æ¿å¼•æ“çš„ä½¿ç”¨ Goè¯­è¨€æ¨¡æ¿å¼•æ“çš„ä½¿ç”¨å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šå®šä¹‰æ¨¡æ¿æ–‡ä»¶ã€è§£ææ¨¡æ¿æ–‡ä»¶å’Œæ¨¡æ¿æ¸²æŸ“. 8.3.1 å®šä¹‰æ¨¡æ¿æ–‡ä»¶ å…¶ä¸­ï¼Œå®šä¹‰æ¨¡æ¿æ–‡ä»¶æ—¶éœ€è¦æˆ‘ä»¬æŒ‰ç…§ç›¸å…³è¯­æ³•è§„åˆ™å»ç¼–å†™ï¼Œåæ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚ 8.3.2 è§£ææ¨¡æ¿æ–‡ä»¶ ä¸Šé¢å®šä¹‰å¥½äº†æ¨¡æ¿æ–‡ä»¶ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å¸¸ç”¨æ–¹æ³•å»è§£ææ¨¡æ¿æ–‡ä»¶ï¼Œå¾—åˆ°æ¨¡æ¿å¯¹è±¡ï¼š func (t *Template) Parse(src string) (*Template, error) func ParseFiles(filenames ...string) (*Template, error) func ParseGlob(pattern string) (*Template, error) å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨func New(name string) *Templateå‡½æ•°åˆ›å»ºä¸€ä¸ªåä¸ºnameçš„æ¨¡æ¿ï¼Œç„¶åå¯¹å…¶è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å»è§£ææ¨¡æ¿å­—ç¬¦ä¸²æˆ–æ¨¡æ¿æ–‡ä»¶ã€‚ 8.3.3 æ¨¡æ¿æ¸²æŸ“ æ¸²æŸ“æ¨¡æ¿ç®€å•æ¥è¯´å°±æ˜¯ä½¿ç”¨æ•°æ®å»å¡«å……æ¨¡æ¿ï¼Œå½“ç„¶å®é™…ä¸Šå¯èƒ½ä¼šå¤æ‚å¾ˆå¤šã€‚ func (t *Template) Execute(wr io.Writer, data interface{}) error func (t *Template) ExecuteTemplate(wr io.Writer, name string, data interface{}) error 8.3.4 åŸºæœ¬ç¤ºä¾‹ 8.3.4.1 å®šä¹‰æ¨¡æ¿æ–‡ä»¶ æˆ‘ä»¬æŒ‰ç…§Goæ¨¡æ¿è¯­æ³•å®šä¹‰ä¸€ä¸ªhello.tmplçš„æ¨¡æ¿æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š \u003c!DOCTYPE html\u003e \u003chtml lang=\"zh-CN\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle\u003eHello\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cp\u003eHello {{.}}\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e 8.3.4.2 è§£æå’Œæ¸²æŸ“æ¨¡æ¿æ–‡ä»¶ ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªmain.goæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å†™ä¸‹HTTP serverç«¯ä»£ç å¦‚ä¸‹ï¼š // main.go func sayHello(w http.ResponseWriter, r *http.Request) { // è§£ææŒ‡å®šæ–‡ä»¶ç”Ÿæˆæ¨¡æ¿å¯¹è±¡ tmpl, err := template.ParseFiles(\"./hello.tmpl\") if err != nil { fmt.Println(\"create template failed, err:\", err) return } // åˆ©ç”¨ç»™å®šæ•°æ®æ¸²æŸ“æ¨¡æ¿ï¼Œå¹¶å°†ç»“æœå†™å…¥w tmpl.Execute(w, \"æ²™æ²³å°ç‹å­\") } func main() { http.HandleFunc(\"/\", sayHello) err := http.ListenAndServe(\":9090\", nil) if err != nil { fmt.Println(\"HTTP server failed,err:\", err) return } } å°†ä¸Šé¢çš„main.goæ–‡ä»¶ç¼–è¯‘æ‰§è¡Œï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨è®¿é—®http://127.0.0.1:9090å°±èƒ½çœ‹åˆ°é¡µé¢ä¸Šæ˜¾ç¤ºäº†â€œHello æ²™æ²³å°ç‹å­â€ã€‚ è¿™å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æ¨¡æ¿æ¸²æŸ“çš„ç¤ºä¾‹ï¼ŒGoè¯­è¨€æ¨¡æ¿å¼•æ“è¯¦ç»†ç”¨æ³•è¯·å¾€ä¸‹é˜…è¯»ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8.4 æ¨¡æ¿è¯­æ³• 8.4.1 {{.}} æ¨¡æ¿è¯­æ³•éƒ½åŒ…å«åœ¨{{å’Œ}}ä¸­é—´ï¼Œå…¶ä¸­{{.}}ä¸­çš„ç‚¹è¡¨ç¤ºå½“å‰å¯¹è±¡ã€‚ å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®.æ¥è®¿é—®ç»“æ„ä½“çš„å¯¹åº”å­—æ®µã€‚ä¾‹å¦‚ï¼š // main.go type UserInfo struct { Name string Gender string Age int } func sayHello(w http.ResponseWriter, r *http.Request) { // è§£ææŒ‡å®šæ–‡ä»¶ç”Ÿæˆæ¨¡æ¿å¯¹è±¡ tmpl, err := template.ParseFiles(\"./hello.tmpl\") if err != nil { fmt.Println(\"create template failed, err:\", err) return } // åˆ©ç”¨ç»™å®šæ•°æ®æ¸²æŸ“æ¨¡æ¿ï¼Œå¹¶å°†ç»“æœå†™å…¥w user := UserInfo{ Name: \"å°ç‹å­\", Gender: \"ç”·\", Age: 18, } tmpl.Execute(w, user) } æ¨¡æ¿æ–‡ä»¶hello.tmplå†…å®¹å¦‚ä¸‹ï¼š \u003c!DOCTYPE html\u003e \u003chtml lang=\"zh-CN\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle\u003eHello\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cp\u003eHello {{.Name}}\u003c/p\u003e \u003cp\u003eæ€§åˆ«ï¼š{{.Gender}}\u003c/p\u003e \u003cp\u003eå¹´é¾„ï¼š{{.Age}}\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e åŒç†ï¼Œå½“æˆ‘ä»¬ä¼ å…¥çš„å˜é‡æ˜¯mapæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­é€šè¿‡.æ ¹æ®keyæ¥å–å€¼ã€‚ 8.4.2 æ³¨é‡Š {{/* a comment */}} æ³¨é‡Šï¼Œæ‰§è¡Œæ—¶ä¼šå¿½ç•¥ã€‚å¯ä»¥å¤šè¡Œã€‚æ³¨é‡Šä¸èƒ½åµŒå¥—ï¼Œå¹¶ä¸”å¿…é¡»ç´§è´´åˆ†ç•Œç¬¦å§‹æ­¢ã€‚ 8.4.3 pipeline pipelineæ˜¯æŒ‡äº§ç”Ÿæ•°æ®çš„æ“ä½œã€‚æ¯”å¦‚{{.}}ã€{{.Name}}ç­‰ã€‚Goçš„æ¨¡æ¿è¯­æ³•ä¸­æ”¯æŒä½¿ç”¨ç®¡é“ç¬¦å·|é“¾æ¥å¤šä¸ªå‘½ä»¤ï¼Œç”¨æ³•å’Œunixä¸‹çš„ç®¡é“ç±»ä¼¼ï¼š|å‰é¢çš„å‘½ä»¤ä¼šå°†è¿ç®—ç»“æœ(æˆ–è¿”å›å€¼)ä¼ é€’ç»™åä¸€ä¸ªå‘½ä»¤çš„æœ€åä¸€ä¸ªä½ç½®ã€‚ **æ³¨æ„ï¼š**å¹¶ä¸æ˜¯åªæœ‰ä½¿ç”¨äº†|æ‰æ˜¯pipelineã€‚Goçš„æ¨¡æ¿è¯­æ³•ä¸­ï¼Œpipelineçš„æ¦‚å¿µæ˜¯ä¼ é€’æ•°æ®ï¼Œåªè¦èƒ½äº§ç”Ÿæ•°æ®çš„ï¼Œéƒ½æ˜¯pipelineã€‚ 8.4.4 å˜é‡ æˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ¨¡æ¿ä¸­å£°æ˜å˜é‡ï¼Œç”¨æ¥ä¿å­˜ä¼ å…¥æ¨¡æ¿çš„æ•°æ®æˆ–å…¶ä»–è¯­å¥ç”Ÿæˆçš„ç»“æœã€‚å…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š $obj := {{.}} å…¶ä¸­$objæ˜¯å˜é‡çš„åå­—ï¼Œåœ¨åç»­çš„ä»£ç ä¸­å°±å¯ä»¥ä½¿ç”¨è¯¥å˜é‡äº†ã€‚ 8.4.5 ç§»é™¤ç©ºæ ¼ æœ‰æ—¶å€™æˆ‘ä»¬åœ¨ä½¿ç”¨æ¨¡æ¿è¯­æ³•çš„æ—¶å€™ä¼šä¸å¯é¿å…çš„å¼•å…¥ä¸€ä¸‹ç©ºæ ¼æˆ–è€…æ¢è¡Œç¬¦ï¼Œè¿™æ ·æ¨¡æ¿æœ€ç»ˆæ¸²æŸ“å‡ºæ¥çš„å†…å®¹å¯èƒ½å°±å’Œæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨{{-è¯­æ³•å»é™¤æ¨¡æ¿å†…å®¹å·¦ä¾§çš„æ‰€æœ‰ç©ºç™½ç¬¦å·ï¼Œ ä½¿ç”¨-}}å»é™¤æ¨¡æ¿å†…å®¹å³ä¾§çš„æ‰€æœ‰ç©ºç™½ç¬¦å·ã€‚ ä¾‹å¦‚ï¼š {{- .Name -}} æ³¨æ„ï¼š-è¦ç´§æŒ¨{{å’Œ}}ï¼ŒåŒæ—¶ä¸æ¨¡æ¿å€¼ä¹‹é—´éœ€è¦ä½¿ç”¨ç©ºæ ¼åˆ†éš”ã€‚ 8.4.6 æ¡ä»¶åˆ¤æ–­ Goæ¨¡æ¿è¯­æ³•ä¸­çš„æ¡ä»¶åˆ¤æ–­æœ‰ä»¥ä¸‹å‡ ç§: {{if pipeline}} T1 {{end}} {{if pipeline}} T1 {{else}} T0 {{end}} {{if pipeline}} T1 {{else if pipeline}} T0 {{end}} 8.4.7 range Goçš„æ¨¡æ¿è¯­æ³•ä¸­ä½¿ç”¨rangeå…³é”®å­—è¿›è¡Œéå†ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å†™æ³•ï¼Œå…¶ä¸­pipelineçš„å€¼å¿…é¡»æ˜¯æ•°ç»„ã€åˆ‡ç‰‡ã€å­—å…¸æˆ–è€…é€šé“ã€‚ {{range pipeline}} T1 {{end}} å¦‚æœpipelineçš„å€¼å…¶é•¿åº¦ä¸º0ï¼Œä¸ä¼šæœ‰ä»»ä½•è¾“å‡º {{range pipeline}} T1 {{else}} T0 {{end}} å¦‚æœpipelineçš„å€¼å…¶é•¿åº¦ä¸º0ï¼Œåˆ™ä¼šæ‰§è¡ŒT0ã€‚ 8.4.8 with {{with pipeline}} T1 {{end}} å¦‚æœpipelineä¸ºemptyä¸äº§ç”Ÿè¾“å‡ºï¼Œå¦åˆ™å°†dotè®¾ä¸ºpipelineçš„å€¼å¹¶æ‰§è¡ŒT1ã€‚ä¸ä¿®æ”¹å¤–é¢çš„dotã€‚ {{with pipeline}} T1 {{else}} T0 {{end}} å¦‚æœpipelineä¸ºemptyï¼Œä¸æ”¹å˜dotå¹¶æ‰§è¡ŒT0ï¼Œå¦åˆ™dotè®¾ä¸ºpipelineçš„å€¼å¹¶æ‰§è¡ŒT1ã€‚ 8.4.9 é¢„å®šä¹‰å‡½æ•° æ‰§è¡Œæ¨¡æ¿æ—¶ï¼Œå‡½æ•°ä»ä¸¤ä¸ªå‡½æ•°å­—å…¸ä¸­æŸ¥æ‰¾ï¼šé¦–å…ˆæ˜¯æ¨¡æ¿å‡½æ•°å­—å…¸ï¼Œç„¶åæ˜¯å…¨å±€å‡½æ•°å­—å…¸ã€‚ä¸€èˆ¬ä¸åœ¨æ¨¡æ¿å†…å®šä¹‰å‡½æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨Funcsæ–¹æ³•æ·»åŠ å‡½æ•°åˆ°æ¨¡æ¿é‡Œã€‚ é¢„å®šä¹‰çš„å…¨å±€å‡½æ•°å¦‚ä¸‹ï¼š and å‡½æ•°è¿”å›å®ƒçš„ç¬¬ä¸€ä¸ªemptyå‚æ•°æˆ–è€…æœ€åä¸€ä¸ªå‚æ•°ï¼› å°±æ˜¯è¯´\"and x y\"ç­‰ä»·äº\"if x then y else x\"ï¼›æ‰€æœ‰å‚æ•°éƒ½ä¼šæ‰§è¡Œï¼› or è¿”å›ç¬¬ä¸€ä¸ªéemptyå‚æ•°æˆ–è€…æœ€åä¸€ä¸ªå‚æ•°ï¼› äº¦å³\"or x y\"ç­‰ä»·äº\"if x then x else y\"ï¼›æ‰€æœ‰å‚æ•°éƒ½ä¼šæ‰§è¡Œï¼› not è¿”å›å®ƒçš„å•ä¸ªå‚æ•°çš„å¸ƒå°”å€¼çš„å¦å®š len è¿”å›å®ƒçš„å‚æ•°çš„æ•´æ•°ç±»å‹é•¿åº¦ index æ‰§è¡Œç»“æœä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä»¥å‰©ä¸‹çš„å‚æ•°ä¸ºç´¢å¼•/é”®æŒ‡å‘çš„å€¼ï¼› å¦‚\"index x 1 2 3\"è¿”å›x[1][2][3]çš„å€¼ï¼›æ¯ä¸ªè¢«ç´¢å¼•çš„ä¸»ä½“å¿…é¡»æ˜¯æ•°ç»„ã€åˆ‡ç‰‡æˆ–è€…å­—å…¸ã€‚ print å³fmt.Sprint printf å³fmt.Sprintf println å³fmt.Sprintln html è¿”å›ä¸å…¶å‚æ•°çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼ç­‰æ•ˆçš„è½¬ä¹‰HTMLã€‚ è¿™ä¸ªå‡½æ•°åœ¨html/templateä¸­ä¸å¯ç”¨ã€‚ urlquery ä»¥é€‚åˆåµŒå…¥åˆ°ç½‘å€æŸ¥è¯¢ä¸­çš„å½¢å¼è¿”å›å…¶å‚æ•°çš„æ–‡æœ¬è¡¨ç¤ºçš„è½¬ä¹‰å€¼ã€‚ è¿™ä¸ªå‡½æ•°åœ¨html/templateä¸­ä¸å¯ç”¨ã€‚ js è¿”å›ä¸å…¶å‚æ•°çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼ç­‰æ•ˆçš„è½¬ä¹‰JavaScriptã€‚ call æ‰§è¡Œç»“æœæ˜¯è°ƒç”¨ç¬¬ä¸€ä¸ªå‚æ•°çš„è¿”å›å€¼ï¼Œè¯¥å‚æ•°å¿…é¡»æ˜¯å‡½æ•°ç±»å‹ï¼Œå…¶ä½™å‚æ•°ä½œä¸ºè°ƒç”¨è¯¥å‡½æ•°çš„å‚æ•°ï¼› å¦‚\"call .X.Y 1 2\"ç­‰ä»·äºgoè¯­è¨€é‡Œçš„dot.X.Y(1, 2)ï¼› å…¶ä¸­Yæ˜¯å‡½æ•°ç±»å‹çš„å­—æ®µæˆ–è€…å­—å…¸çš„å€¼ï¼Œæˆ–è€…å…¶ä»–ç±»ä¼¼æƒ…å†µï¼› callçš„ç¬¬ä¸€ä¸ªå‚æ•°çš„æ‰§è¡Œç»“æœå¿…é¡»æ˜¯å‡½æ•°ç±»å‹çš„å€¼ï¼ˆå’Œé¢„å®šä¹‰å‡½æ•°å¦‚printæ˜æ˜¾ä¸åŒï¼‰ï¼› è¯¥å‡½æ•°ç±»å‹å€¼å¿…é¡»æœ‰1åˆ°2ä¸ªè¿”å›å€¼ï¼Œå¦‚æœæœ‰2ä¸ªåˆ™åä¸€ä¸ªå¿…é¡»æ˜¯erroræ¥å£ç±»å‹ï¼› å¦‚æœæœ‰2ä¸ªè¿”å›å€¼çš„æ–¹æ³•è¿”å›çš„errorénilï¼Œæ¨¡æ¿æ‰§è¡Œä¼šä¸­æ–­å¹¶è¿”å›ç»™è°ƒç”¨æ¨¡æ¿æ‰§è¡Œè€…è¯¥é”™è¯¯ï¼› 8.4.10 æ¯”è¾ƒå‡½æ•° å¸ƒå°”å‡½æ•°ä¼šå°†ä»»ä½•ç±»å‹çš„é›¶å€¼è§†ä¸ºå‡ï¼Œå…¶ä½™è§†ä¸ºçœŸã€‚ ä¸‹é¢æ˜¯å®šä¹‰ä¸ºå‡½æ•°çš„äºŒå…ƒæ¯”è¾ƒè¿ç®—çš„é›†åˆï¼š eq å¦‚æœarg1 == arg2åˆ™è¿”å›çœŸ ne å¦‚æœarg1 != arg2åˆ™è¿”å›çœŸ lt å¦‚æœarg1 \u003c arg2åˆ™è¿”å›çœŸ le å¦‚æœarg1 \u003c= arg2åˆ™è¿”å›çœŸ gt å¦‚æœarg1 \u003e arg2åˆ™è¿”å›çœŸ ge å¦‚æœarg1 \u003e= arg2åˆ™è¿”å›çœŸ ä¸ºäº†ç®€åŒ–å¤šå‚æ•°ç›¸ç­‰æ£€æµ‹ï¼Œeqï¼ˆåªæœ‰eqï¼‰å¯ä»¥æ¥å—2ä¸ªæˆ–æ›´å¤šä¸ªå‚æ•°ï¼Œå®ƒä¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°å’Œå…¶ä½™å‚æ•°ä¾æ¬¡æ¯”è¾ƒï¼Œè¿”å›ä¸‹å¼çš„ç»“æœï¼š {{eq arg1 arg2 arg3}} æ¯”è¾ƒå‡½æ•°åªé€‚ç”¨äºåŸºæœ¬ç±»å‹ï¼ˆæˆ–é‡å®šä¹‰çš„åŸºæœ¬ç±»å‹ï¼Œå¦‚â€type Celsius float32â€ï¼‰ã€‚ä½†æ˜¯ï¼Œæ•´æ•°å’Œæµ®ç‚¹æ•°ä¸èƒ½äº’ç›¸æ¯”è¾ƒã€‚ 8.4.11 è‡ªå®šä¹‰å‡½æ•° Goçš„æ¨¡æ¿æ”¯æŒè‡ªå®šä¹‰å‡½æ•°ã€‚ func sayHello(w http.ResponseWriter, r *http.Request) { htmlByte, err := ioutil.ReadFile(\"./hello.tmpl\") if err != nil { fmt.Println(\"read html failed, err:\", err) return } // è‡ªå®šä¹‰ä¸€ä¸ªå¤¸äººçš„æ¨¡æ¿å‡½æ•° kua := func(arg string) (string, error) { return arg + \"çœŸå¸…\", nil } // é‡‡ç”¨é“¾å¼æ“ä½œåœ¨Parseä¹‹å‰è°ƒç”¨Funcsæ·»åŠ è‡ªå®šä¹‰çš„kuaå‡½æ•° tmpl, err := template.New(\"hello\").Funcs(template.FuncMap{\"kua\": kua}).Parse(string(htmlByte)) if err != nil { fmt.Println(\"create template failed, err:\", err) return } user := UserInfo{ Name: \"å°ç‹å­\", Gender: \"ç”·\", Age: 18, } // ä½¿ç”¨useræ¸²æŸ“æ¨¡æ¿ï¼Œå¹¶å°†ç»“æœå†™å…¥w tmpl.Execute(w, user) } æˆ‘ä»¬å¯ä»¥åœ¨æ¨¡æ¿æ–‡ä»¶hello.tmplä¸­æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„kuaå‡½æ•°äº†ã€‚ {{kua .Name}} 8.4.12 åµŒå¥—template æˆ‘ä»¬å¯ä»¥åœ¨templateä¸­åµŒå¥—å…¶ä»–çš„templateã€‚è¿™ä¸ªtemplateå¯ä»¥æ˜¯å•ç‹¬çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡defineå®šä¹‰çš„templateã€‚ ä¸¾ä¸ªä¾‹å­ï¼š test.tmplæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š \u003c!DOCTYPE html\u003e \u003chtml lang=\"zh-CN\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"8.5 text/templateä¸html/tempalteçš„åŒºåˆ« html/templateé’ˆå¯¹çš„æ˜¯éœ€è¦è¿”å›HTMLå†…å®¹çš„åœºæ™¯ï¼Œåœ¨æ¨¡æ¿æ¸²æŸ“è¿‡ç¨‹ä¸­ä¼šå¯¹ä¸€äº›æœ‰é£é™©çš„å†…å®¹è¿›è¡Œè½¬ä¹‰ï¼Œä»¥æ­¤æ¥é˜²èŒƒè·¨ç«™è„šæœ¬æ”»å‡»ã€‚ ä¾‹å¦‚ï¼Œæˆ‘å®šä¹‰ä¸‹é¢çš„æ¨¡æ¿æ–‡ä»¶ï¼š \u003c!DOCTYPE html\u003e \u003chtml lang=\"zh-CN\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle\u003eHello\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e {{.}} \u003c/body\u003e \u003c/html\u003e è¿™ä¸ªæ—¶å€™ä¼ å…¥ä¸€æ®µJSä»£ç å¹¶ä½¿ç”¨html/templateå»æ¸²æŸ“è¯¥æ–‡ä»¶ï¼Œä¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‡ºè½¬ä¹‰åçš„JSå†…å®¹ã€‚ \u003cscript\u003ealert('å˜¿å˜¿å˜¿')\u003c/script\u003e è¿™å°±æ˜¯html/templateä¸ºæˆ‘ä»¬åšçš„äº‹ã€‚ ä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¦‚æœç›¸ä¿¡ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œä¸æƒ³è½¬ä¹‰çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œç¼–å†™ä¸€ä¸ªsafeå‡½æ•°ï¼Œæ‰‹åŠ¨è¿”å›ä¸€ä¸ªtemplate.HTMLç±»å‹çš„å†…å®¹ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š func xss(w http.ResponseWriter, r *http.Request){ tmpl, err := template.New(\"xss.tmpl\").Funcs(template.FuncMap{ \"safe\": func(s string)template.HTML { return template.HTML(s) }, }).ParseFiles(\"./xss.tmpl\") if err != nil { fmt.Println(\"create template failed, err:\", err) return } jsStr := `\u003cscript\u003ealert('å˜¿å˜¿å˜¿')\u003c/script\u003e` err = tmpl.Execute(w, jsStr) if err != nil { fmt.Println(err) } } è¿™æ ·æˆ‘ä»¬åªéœ€è¦åœ¨æ¨¡æ¿æ–‡ä»¶ä¸éœ€è¦è½¬ä¹‰çš„å†…å®¹åé¢ä½¿ç”¨æˆ‘ä»¬å®šä¹‰å¥½çš„safeå‡½æ•°å°±å¯ä»¥äº†ã€‚ {{ . | safe }} å³ï¼Œä¿¡ä»»çš„ç”¨safeï¼Œä¸ä¿¡ä»»çš„ç”¨. ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:7:5","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"ä¹ã€Gin Ginæ˜¯ä¸€ä¸ªç”¨Goè¯­è¨€ç¼–å†™çš„webæ¡†æ¶ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äºmartiniä½†æ‹¥æœ‰æ›´å¥½æ€§èƒ½çš„APIæ¡†æ¶, ç”±äºä½¿ç”¨äº†httprouterï¼Œé€Ÿåº¦æé«˜äº†è¿‘40å€ã€‚ å¦‚æœä½ æ˜¯æ€§èƒ½å’Œé«˜æ•ˆçš„è¿½æ±‚è€…, ä½ ä¼šçˆ±ä¸ŠGinã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.1 Ginæ¡†æ¶ä»‹ç» Goä¸–ç•Œé‡Œæœ€æµè¡Œçš„Webæ¡†æ¶ï¼ŒGithubä¸Šæœ‰32K+starã€‚ åŸºäºhttprouterå¼€å‘çš„Webæ¡†æ¶ã€‚ ä¸­æ–‡æ–‡æ¡£é½å…¨ï¼Œç®€å•æ˜“ç”¨çš„è½»é‡çº§æ¡†æ¶ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.2 Ginæ¡†æ¶å®‰è£…ä¸ä½¿ç”¨ 9.2.1 å®‰è£… ä¸‹è½½å¹¶å®‰è£…Gin: go get -u github.com/gin-gonic/gin 9.2.2 ç¬¬ä¸€ä¸ªGinç¤ºä¾‹ï¼š package main import ( \"github.com/gin-gonic/gin\" ) func main() { // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å¼•æ“ r := gin.Default() // GETï¼šè¯·æ±‚æ–¹å¼ï¼›/helloï¼šè¯·æ±‚çš„è·¯å¾„ // å½“å®¢æˆ·ç«¯ä»¥GETæ–¹æ³•è¯·æ±‚/helloè·¯å¾„æ—¶ï¼Œä¼šæ‰§è¡Œåé¢çš„åŒ¿åå‡½æ•° r.GET(\"/hello\", func(c *gin.Context) { // c.JSONï¼šè¿”å›JSONæ ¼å¼çš„æ•°æ® c.JSON(200, gin.H{ \"message\": \"Hello world!\", }) }) // å¯åŠ¨HTTPæœåŠ¡ï¼Œé»˜è®¤åœ¨0.0.0.0:8080å¯åŠ¨æœåŠ¡ r.Run() } å°†ä¸Šé¢çš„ä»£ç ä¿å­˜å¹¶ç¼–è¯‘æ‰§è¡Œï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨æ‰“å¼€127.0.0.1:8080/helloå°±èƒ½çœ‹åˆ°ä¸€ä¸²JSONå­—ç¬¦ä¸²ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.3 RESTful API RESTä¸æŠ€æœ¯æ— å…³ï¼Œä»£è¡¨çš„æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼ŒRESTæ˜¯Representational State Transferçš„ç®€ç§°ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºâ€œè¡¨å¾çŠ¶æ€è½¬ç§»â€æˆ–â€œè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚ æ¨èé˜…è¯»é˜®ä¸€å³° ç†è§£RESTfulæ¶æ„ ç®€å•æ¥è¯´ï¼ŒRESTçš„å«ä¹‰å°±æ˜¯å®¢æˆ·ç«¯ä¸WebæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œäº¤äº’çš„æ—¶å€™ï¼Œä½¿ç”¨HTTPåè®®ä¸­çš„4ä¸ªè¯·æ±‚æ–¹æ³•ä»£è¡¨ä¸åŒçš„åŠ¨ä½œã€‚ GETç”¨æ¥è·å–èµ„æº POSTç”¨æ¥æ–°å»ºèµ„æº PUTç”¨æ¥æ›´æ–°èµ„æº DELETEç”¨æ¥åˆ é™¤èµ„æºã€‚ åªè¦APIç¨‹åºéµå¾ªäº†RESTé£æ ¼ï¼Œé‚£å°±å¯ä»¥ç§°å…¶ä¸ºRESTful APIã€‚ç›®å‰åœ¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„ä¸­ï¼Œå‰åç«¯åŸºæœ¬éƒ½æ˜¯é€šè¿‡RESTful APIæ¥è¿›è¡Œäº¤äº’ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨è¦ç¼–å†™ä¸€ä¸ªç®¡ç†ä¹¦ç±çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢å¯¹ä¸€æœ¬ä¹¦è¿›è¡ŒæŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ç­‰æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™å°±è¦è®¾è®¡å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æˆ‘ä»¬WebæœåŠ¡ç«¯äº¤äº’çš„æ–¹å¼å’Œè·¯å¾„ã€‚æŒ‰ç…§ç»éªŒæˆ‘ä»¬é€šå¸¸ä¼šè®¾è®¡æˆå¦‚ä¸‹æ¨¡å¼ï¼š è¯·æ±‚æ–¹æ³• URL å«ä¹‰ GET /book æŸ¥è¯¢ä¹¦ç±ä¿¡æ¯ POST /create_book åˆ›å»ºä¹¦ç±è®°å½• POST /update_book æ›´æ–°ä¹¦ç±ä¿¡æ¯ POST /delete_book åˆ é™¤ä¹¦ç±ä¿¡æ¯ åŒæ ·çš„éœ€æ±‚æˆ‘ä»¬æŒ‰ç…§RESTful APIè®¾è®¡å¦‚ä¸‹ï¼š è¯·æ±‚æ–¹æ³• URL å«ä¹‰ GET /book æŸ¥è¯¢ä¹¦ç±ä¿¡æ¯ POST /book åˆ›å»ºä¹¦ç±è®°å½• PUT /book æ›´æ–°ä¹¦ç±ä¿¡æ¯ DELETE /book åˆ é™¤ä¹¦ç±ä¿¡æ¯ Ginæ¡†æ¶æ”¯æŒå¼€å‘RESTful APIçš„å¼€å‘ã€‚ func main() { r := gin.Default() r.GET(\"/book\", func(c *gin.Context) { c.JSON(200, gin.H{ \"message\": \"GET\", }) }) r.POST(\"/book\", func(c *gin.Context) { c.JSON(200, gin.H{ \"message\": \"POST\", }) }) r.PUT(\"/book\", func(c *gin.Context) { c.JSON(200, gin.H{ \"message\": \"PUT\", }) }) r.DELETE(\"/book\", func(c *gin.Context) { c.JSON(200, gin.H{ \"message\": \"DELETE\", }) }) } å¼€å‘RESTful APIçš„æ—¶å€™æˆ‘ä»¬é€šå¸¸ä½¿ç”¨Postmanæ¥ä½œä¸ºå®¢æˆ·ç«¯çš„æµ‹è¯•å·¥å…·ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.4 Ginæ¸²æŸ“ 9.4.1 HTMLæ¸²æŸ“ æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªå­˜æ”¾æ¨¡æ¿æ–‡ä»¶çš„templatesæ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨å…¶å†…éƒ¨æŒ‰ç…§ä¸šåŠ¡åˆ†åˆ«å®šä¹‰ä¸€ä¸ªpostsæ–‡ä»¶å¤¹å’Œä¸€ä¸ªusersæ–‡ä»¶å¤¹ã€‚ posts/index.htmlæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š {{define \"posts/index.html\"}} \u003c!DOCTYPE html\u003e \u003chtml lang=\"en\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle\u003eposts/index\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e {{.title}} \u003c/body\u003e \u003c/html\u003e {{end}} users/index.htmlæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š {{define \"users/index.html\"}} \u003c!DOCTYPE html\u003e \u003chtml lang=\"en\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003cmeta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"\u003e \u003ctitle\u003eusers/index\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e {{.title}} \u003c/body\u003e \u003c/html\u003e {{end}} Ginæ¡†æ¶ä¸­ä½¿ç”¨LoadHTMLGlob()æˆ–è€…LoadHTMLFiles()æ–¹æ³•è¿›è¡ŒHTMLæ¨¡æ¿æ¸²æŸ“ã€‚ func main() { r := gin.Default() r.LoadHTMLGlob(\"templates/**/*\") //r.LoadHTMLFiles(\"templates/posts/index.html\", \"templates/users/index.html\") r.GET(\"/posts/index\", func(c *gin.Context) { c.HTML(http.StatusOK, \"posts/index.html\", gin.H{ \"title\": \"posts/index\", }) }) r.GET(\"users/index\", func(c *gin.Context) { c.HTML(http.StatusOK, \"users/index.html\", gin.H{ \"title\": \"users/index\", }) }) r.Run(\":8080\") } 9.4.2 è‡ªå®šä¹‰æ¨¡æ¿å‡½æ•° å®šä¹‰ä¸€ä¸ªä¸è½¬ä¹‰ç›¸åº”å†…å®¹çš„safeæ¨¡æ¿å‡½æ•°å¦‚ä¸‹ï¼š func main() { router := gin.Default() router.SetFuncMap(template.FuncMap{ \"safe\": func(str string) template.HTML{ return template.HTML(str) }, }) router.LoadHTMLFiles(\"./index.tmpl\") router.GET(\"/index\", func(c *gin.Context) { c.HTML(http.StatusOK, \"index.tmpl\", \"\u003ca href='https://liwenzhou.com'\u003eææ–‡å‘¨çš„åšå®¢\u003c/a\u003e\") }) router.Run(\":8080\") } åœ¨index.tmplä¸­ä½¿ç”¨å®šä¹‰å¥½çš„safeæ¨¡æ¿å‡½æ•°ï¼š \u003c!DOCTYPE html\u003e \u003chtml lang=\"zh-CN\"\u003e \u003chead\u003e \u003ctitle\u003eä¿®æ”¹æ¨¡æ¿å¼•æ“çš„æ ‡è¯†ç¬¦\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cdiv\u003e{{ . | safe }}\u003c/div\u003e \u003c/body\u003e \u003c/html\u003e 9.4.3 é™æ€æ–‡ä»¶å¤„ç† å½“æˆ‘ä»¬æ¸²æŸ“çš„HTMLæ–‡ä»¶ä¸­å¼•ç”¨äº†é™æ€æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰ç…§ä»¥ä¸‹æ–¹å¼åœ¨æ¸²æŸ“é¡µé¢å‰è°ƒç”¨gin.Staticæ–¹æ³•å³å¯ã€‚ func main() { r := gin.Default() r.Static(\"/static\", \"./static\") r.LoadHTMLGlob(\"templates/**/*\") // ... r.Run(\":8080\") } 9.4.4 ä½¿ç”¨æ¨¡æ¿ç»§æ‰¿ Ginæ¡†æ¶é»˜è®¤éƒ½æ˜¯ä½¿ç”¨å•æ¨¡æ¿ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨block templateåŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡\"github.com/gin-contrib/multitemplate\"åº“å®ç°ï¼Œå…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š é¦–å…ˆï¼Œå‡è®¾æˆ‘ä»¬é¡¹ç›®ç›®å½•ä¸‹çš„templatesæ–‡ä»¶å¤¹ä¸‹æœ‰ä»¥ä¸‹æ¨¡æ¿æ–‡ä»¶ï¼Œå…¶ä¸­home.tmplå’Œindex.tmplç»§æ‰¿äº†base.tmplï¼š templates â”œâ”€â”€ includes â”‚ â”œâ”€â”€ home.tmpl â”‚ â””â”€â”€ index.tmpl â”œâ”€â”€ layouts â”‚ â””â”€â”€ base.tmpl â””â”€â”€ scripts.tmpl ç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªloadTemplateså‡½æ•°å¦‚ä¸‹ï¼š func loadTemplates(templatesDir string) multitemplate.Renderer { r := multitemplate.NewRenderer() layouts, err := filepath.Glob(templatesDir + \"/layouts/*.tmpl\") if err != nil { panic(err.Error()) } includes, err := filepath.Glob(templatesDir + \"/includes/*.tmpl\") if err != nil { panic(err.Error()) } // ä¸ºlayouts/å’Œincludes/ç›®å½•ç”Ÿæˆ templates map for _, include := range includes { layoutCopy := make([]string, len(layouts)) copy(layoutCopy, layouts) files := append(layoutCopy, include) r.AddFromFiles(filepath.Base(include), files...) } return r } æˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­ func indexFunc(c *gin.Context){ c.HTML(http.StatusOK, \"index.tmpl\", nil) } func homeFunc(c *gin.Context){ c.HTML(http.StatusOK, \"home.tmpl\", nil) } func main(){ r := gin.Default() r.HTMLRender = loadTemplates(\"./templates\") r.GET(\"/index\", indexFunc) r.GET(\"/home\", homeFunc) r.Run() } 9.4.5 è¡¥å……æ–‡ä»¶è·¯å¾„å¤„ç† å…³äºæ¨¡æ¿æ–‡ä»¶å’Œé™æ€æ–‡ä»¶çš„è·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…¬å¸/é¡¹ç›®çš„è¦æ±‚è¿›è¡Œè®¾ç½®ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°è·å–å½“å‰æ‰§è¡Œç¨‹åºçš„è·¯å¾„ã€‚ func getCurrentPath() string { if ex, err := os.Executable(); err == nil { return filepath.Dir(ex) } return \"./\" } 9.4.6 JSONæ¸²æŸ“ func main() { r := gin.Default() // gin.H æ˜¯map[string]interface{}çš„ç¼©å†™ r.GET(\"/someJSON\", func(c *gin.Context) { // æ–¹å¼ä¸€ï¼šè‡ªå·±æ‹¼æ¥JSON c.JSON(http.StatusOK, gin.H{\"message\": \"Hello world!\"}) }) r.GET(\"/moreJSON\", func(c *gin.Context) { // æ–¹æ³•äºŒï¼šä½¿ç”¨ç»“æ„ä½“ var msg struct { Name string `json:\"user\"` Message string Age int } msg.Name = \"å°ç‹å­\" msg.Message = \"Hello world!\" msg.Age = 18 c.JSON(http.StatusOK, msg) }) r.Run(\":8080\") } 9.4.7 XMLæ¸²æŸ“ æ³¨æ„éœ€è¦ä½¿ç”¨å…·åçš„ç»“æ„ä½“ç±»å‹ã€‚ func main() { r := gin.Default() // gin.H æ˜¯map[string]interface{}çš„ç¼©å†™ r.GET(\"/someXML\", func(c *gin.Context) { // æ–¹å¼ä¸€ï¼šè‡ªå·±æ‹¼æ¥JSON c.XML(http.StatusOK, gin.H{\"message\": \"Hello world!\"}) }) r.GET(\"/moreXML\", func(c *gin.Context) { // æ–¹æ³•äºŒï¼šä½¿ç”¨ç»“æ„ä½“ type MessageRecord struct { Name string Message string Age int } va","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.5 è·å–å‚æ•° 9.5.1 è·å–querystringå‚æ•° querystringæŒ‡çš„æ˜¯URLä¸­?åé¢æºå¸¦çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š/user/search?username=å°ç‹å­\u0026address=æ²™æ²³ã€‚ è·å–è¯·æ±‚çš„querystringå‚æ•°çš„æ–¹æ³•å¦‚ä¸‹ï¼š func main() { //Defaultè¿”å›ä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å¼•æ“ r := gin.Default() r.GET(\"/user/search\", func(c *gin.Context) { username := c.DefaultQuery(\"username\", \"å°ç‹å­\") //username := c.Query(\"username\") address := c.Query(\"address\") //è¾“å‡ºjsonç»“æœç»™è°ƒç”¨æ–¹ c.JSON(http.StatusOK, gin.H{ \"message\": \"ok\", \"username\": username, \"address\": address, }) }) r.Run() } 9.5.2 è·å–formå‚æ•° å½“å‰ç«¯è¯·æ±‚çš„æ•°æ®é€šè¿‡formè¡¨å•æäº¤æ—¶ï¼Œä¾‹å¦‚å‘/user/searchå‘é€ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œè·å–è¯·æ±‚æ•°æ®çš„æ–¹å¼å¦‚ä¸‹ï¼š func main() { //Defaultè¿”å›ä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å¼•æ“ r := gin.Default() r.POST(\"/user/search\", func(c *gin.Context) { // DefaultPostFormå–ä¸åˆ°å€¼æ—¶ä¼šè¿”å›æŒ‡å®šçš„é»˜è®¤å€¼ //username := c.DefaultPostForm(\"username\", \"å°ç‹å­\") username := c.PostForm(\"username\") address := c.PostForm(\"address\") //è¾“å‡ºjsonç»“æœç»™è°ƒç”¨æ–¹ c.JSON(http.StatusOK, gin.H{ \"message\": \"ok\", \"username\": username, \"address\": address, }) }) r.Run(\":8080\") } 9.5.3 è·å–jsonå‚æ•° å½“å‰ç«¯è¯·æ±‚çš„æ•°æ®é€šè¿‡JSONæäº¤æ—¶ï¼Œä¾‹å¦‚å‘/jsonå‘é€ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œåˆ™è·å–è¯·æ±‚å‚æ•°çš„æ–¹å¼å¦‚ä¸‹ï¼š r.POST(\"/json\", func(c *gin.Context) { // æ³¨æ„ï¼šä¸‹é¢ä¸ºäº†ä¸¾ä¾‹å­æ–¹ä¾¿ï¼Œæš‚æ—¶å¿½ç•¥äº†é”™è¯¯å¤„ç† b, _ := c.GetRawData() // ä»c.Request.Bodyè¯»å–è¯·æ±‚æ•°æ® // å®šä¹‰mapæˆ–ç»“æ„ä½“ var m map[string]interface{} // ååºåˆ—åŒ– _ = json.Unmarshal(b, \u0026m) c.JSON(http.StatusOK, m) }) æ›´ä¾¿åˆ©çš„è·å–è¯·æ±‚å‚æ•°çš„æ–¹å¼ï¼Œå‚è§ä¸‹é¢çš„ å‚æ•°ç»‘å®š å°èŠ‚ã€‚ 9.5.4 è·å–pathå‚æ•° è¯·æ±‚çš„å‚æ•°é€šè¿‡URLè·¯å¾„ä¼ é€’ï¼Œä¾‹å¦‚ï¼š/user/search/å°ç‹å­/æ²™æ²³ã€‚ è·å–è¯·æ±‚URLè·¯å¾„ä¸­çš„å‚æ•°çš„æ–¹å¼å¦‚ä¸‹ã€‚ func main() { //Defaultè¿”å›ä¸€ä¸ªé»˜è®¤çš„è·¯ç”±å¼•æ“ r := gin.Default() r.GET(\"/user/search/:username/:address\", func(c *gin.Context) { username := c.Param(\"username\") address := c.Param(\"address\") //è¾“å‡ºjsonç»“æœç»™è°ƒç”¨æ–¹ c.JSON(http.StatusOK, gin.H{ \"message\": \"ok\", \"username\": username, \"address\": address, }) }) r.Run(\":8080\") } 9.5.5 å‚æ•°ç»‘å®š ä¸ºäº†èƒ½å¤Ÿæ›´æ–¹ä¾¿çš„è·å–è¯·æ±‚ç›¸å…³å‚æ•°ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºè¯·æ±‚çš„Content-Typeè¯†åˆ«è¯·æ±‚æ•°æ®ç±»å‹å¹¶åˆ©ç”¨åå°„æœºåˆ¶è‡ªåŠ¨æå–è¯·æ±‚ä¸­QueryStringã€formè¡¨å•ã€JSONã€XMLç­‰å‚æ•°åˆ°ç»“æ„ä½“ä¸­ã€‚ ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ¼”ç¤ºäº†.ShouldBind()å¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒèƒ½å¤ŸåŸºäºè¯·æ±‚è‡ªåŠ¨æå–JSONã€formè¡¨å•å’ŒQueryStringç±»å‹çš„æ•°æ®ï¼Œå¹¶æŠŠå€¼ç»‘å®šåˆ°æŒ‡å®šçš„ç»“æ„ä½“å¯¹è±¡ã€‚ // Binding from JSON type Login struct { User string `form:\"user\" json:\"user\" binding:\"required\"` Password string `form:\"password\" json:\"password\" binding:\"required\"` } func main() { router := gin.Default() // ç»‘å®šJSONçš„ç¤ºä¾‹ ({\"user\": \"q1mi\", \"password\": \"123456\"}) router.POST(\"/loginJSON\", func(c *gin.Context) { var login Login if err := c.ShouldBind(\u0026login); err == nil { fmt.Printf(\"login info:%#v\\n\", login) c.JSON(http.StatusOK, gin.H{ \"user\": login.User, \"password\": login.Password, }) } else { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) } }) // ç»‘å®šformè¡¨å•ç¤ºä¾‹ (user=q1mi\u0026password=123456) router.POST(\"/loginForm\", func(c *gin.Context) { var login Login // ShouldBind()ä¼šæ ¹æ®è¯·æ±‚çš„Content-Typeè‡ªè¡Œé€‰æ‹©ç»‘å®šå™¨ if err := c.ShouldBind(\u0026login); err == nil { c.JSON(http.StatusOK, gin.H{ \"user\": login.User, \"password\": login.Password, }) } else { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) } }) // ç»‘å®šQueryStringç¤ºä¾‹ (/loginQuery?user=q1mi\u0026password=123456) router.GET(\"/loginForm\", func(c *gin.Context) { var login Login // ShouldBind()ä¼šæ ¹æ®è¯·æ±‚çš„Content-Typeè‡ªè¡Œé€‰æ‹©ç»‘å®šå™¨ if err := c.ShouldBind(\u0026login); err == nil { c.JSON(http.StatusOK, gin.H{ \"user\": login.User, \"password\": login.Password, }) } else { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) } }) // Listen and serve on 0.0.0.0:8080 router.Run(\":8080\") } ShouldBindä¼šæŒ‰ç…§ä¸‹é¢çš„é¡ºåºè§£æè¯·æ±‚ä¸­çš„æ•°æ®å®Œæˆç»‘å®šï¼š å¦‚æœæ˜¯ GET è¯·æ±‚ï¼Œåªä½¿ç”¨ Form ç»‘å®šå¼•æ“ï¼ˆqueryï¼‰ã€‚ å¦‚æœæ˜¯ POST è¯·æ±‚ï¼Œé¦–å…ˆæ£€æŸ¥ content-type æ˜¯å¦ä¸º JSON æˆ– XMLï¼Œç„¶åå†ä½¿ç”¨ Formï¼ˆform-dataï¼‰ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:5","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.6 æ–‡ä»¶ä¸Šä¼  9.6.1 å•ä¸ªæ–‡ä»¶ä¸Šä¼  æ–‡ä»¶ä¸Šä¼ å‰ç«¯é¡µé¢ä»£ç ï¼š {{define \"upload_files.html\"}} \u003c!DOCTYPE html\u003e \u003chtml lang=\"zn-CN\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003ctitle\u003eä¸Šä¼ æ–‡ä»¶\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cform action=\"/uploadSingle\" method=\"post\" enctype=\"multipart/form-data\"\u003e ä¸Šä¼ å•ä¸ªæ–‡ä»¶ï¼š \u003cinput type=\"file\" name=\"file\"\u003e \u003cinput type=\"submit\" value=\"ä¸Šä¼ \"\u003e \u003c/form\u003e \u003cform action=\"/uploadMulti\" method=\"post\" enctype=\"multipart/form-data\"\u003e ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼š \u003cinput type=\"file\" name=\"files[]\" multiple\u003e \u003cinput type=\"submit\" value=\"ä¸Šä¼ \"\u003e \u003c/form\u003e \u003c/body\u003e \u003c/html\u003e {{end}} åç«¯ginæ¡†æ¶éƒ¨åˆ†ä»£ç ï¼š func uploadSingleFile(r *gin.Engine) { r.POST(\"/uploadSingle\", func(context *gin.Context) { // å•ä¸ªæ–‡ä»¶ file, err := context.FormFile(\"file\") if err != nil { context.JSON(http.StatusInternalServerError, gin.H{\"message\": err.Error()}) return } log.Println(file.Filename) dst := fmt.Sprintf(\"./upload_files/%s\", file.Filename) // ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ err = context.SaveUploadedFile(file, dst) if err != nil { context.JSON(http.StatusInternalServerError, gin.H{\"message\": \"upload failed.\"}) } context.JSON(http.StatusOK, gin.H{\"message\": fmt.Sprintf(\"%s upload success.\", file.Filename)}) }) //r.Run() } 9.6.2 å¤šä¸ªæ–‡ä»¶ä¸Šä¼  func uploadMultiFiles(r *gin.Engine) { r.POST(\"/uploadMulti\", func(context *gin.Context) { form, _ := context.MultipartForm() files := form.File[\"files[]\"] for index, file := range files { log.Println(file.Filename) dst := fmt.Sprintf(\"./upload_files/%d_%s\", index, file.Filename) // ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šç›®å½• context.SaveUploadedFile(file, dst) } context.JSON(http.StatusOK, gin.H{\"message\": fmt.Sprintf(\"%d files upload success.\", len(files))}) }) //r.Run() } func main() { r := gin.Default() // 1. é™æ€é¡µé¢ é»˜è®¤æ˜¾ç¤º./uploadä¸‹çš„index.htmlé¡µé¢ã€‚æ³¨æ„ï¼Œå¿…é¡»æ˜¯indexå‘½å //r.Static(\"/\", \"./upload_files\") // 2. åŠ¨æ€æ˜¾ç¤º r.LoadHTMLFiles(\"./upload_files/upload_files.html\") r.GET(\"/\", func(context *gin.Context) { context.HTML(http.StatusOK, \"upload_files.html\", gin.H{ \"title\": \"upload_files\", }) }) // å¤„ç†multipart formsæäº¤æ–‡ä»¶æ—¶é»˜è®¤çš„å†…å­˜é™åˆ¶æ˜¯32 MiB // å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ä¿®æ”¹ r.MaxMultipartMemory = 8 \u003c\u003c 20 // 8 MiB uploadSingleFile(r) uploadMultiFiles(r) r.Run() } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:6","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.7 é‡å®šå‘ 9.7.1 HTTPé‡å®šå‘ HTTP é‡å®šå‘å¾ˆå®¹æ˜“ã€‚ å†…éƒ¨ã€å¤–éƒ¨é‡å®šå‘å‡æ”¯æŒã€‚ r.GET(\"/test\", func(c *gin.Context) { c.Redirect(http.StatusMovedPermanently, \"http://www.sogo.com/\") }) 9.7.2 è·¯ç”±é‡å®šå‘ è·¯ç”±é‡å®šå‘ï¼Œä½¿ç”¨HandleContextï¼š r.GET(\"/test\", func(c *gin.Context) { // æŒ‡å®šé‡å®šå‘çš„URL c.Request.URL.Path = \"/test2\" r.HandleContext(c) }) r.GET(\"/test2\", func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{\"hello\": \"world\"}) }) ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:7","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.8 Ginè·¯ç”± 9.8.1 æ™®é€šè·¯ç”± r.GET(\"/index\", func(c *gin.Context) {...}) r.GET(\"/login\", func(c *gin.Context) {...}) r.POST(\"/login\", func(c *gin.Context) {...}) æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯ä»¥åŒ¹é…æ‰€æœ‰è¯·æ±‚æ–¹æ³•çš„Anyæ–¹æ³•å¦‚ä¸‹ï¼š r.Any(\"/test\", func(c *gin.Context) {...}) ä¸ºæ²¡æœ‰é…ç½®å¤„ç†å‡½æ•°çš„è·¯ç”±æ·»åŠ å¤„ç†ç¨‹åºï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè¿”å›404ä»£ç ï¼Œä¸‹é¢çš„ä»£ç ä¸ºæ²¡æœ‰åŒ¹é…åˆ°è·¯ç”±çš„è¯·æ±‚éƒ½è¿”å›views/404.htmlé¡µé¢ã€‚ r.NoRoute(func(c *gin.Context) { c.HTML(http.StatusNotFound, \"views/404.html\", nil) }) 9.8.2 è·¯ç”±ç»„ æˆ‘ä»¬å¯ä»¥å°†æ‹¥æœ‰å…±åŒURLå‰ç¼€çš„è·¯ç”±åˆ’åˆ†ä¸ºä¸€ä¸ªè·¯ç”±ç»„ã€‚ä¹ æƒ¯æ€§ä¸€å¯¹{}åŒ…è£¹åŒç»„çš„è·¯ç”±ï¼Œè¿™åªæ˜¯ä¸ºäº†çœ‹ç€æ¸…æ™°ï¼Œä½ ç”¨ä¸ç”¨{}åŒ…è£¹åŠŸèƒ½ä¸Šæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ func main() { r := gin.Default() userGroup := r.Group(\"/user\") { userGroup.GET(\"/index\", func(c *gin.Context) {...}) userGroup.GET(\"/login\", func(c *gin.Context) {...}) userGroup.POST(\"/login\", func(c *gin.Context) {...}) } shopGroup := r.Group(\"/shop\") { shopGroup.GET(\"/index\", func(c *gin.Context) {...}) shopGroup.GET(\"/cart\", func(c *gin.Context) {...}) shopGroup.POST(\"/checkout\", func(c *gin.Context) {...}) } r.Run() } è·¯ç”±ç»„ä¹Ÿæ˜¯æ”¯æŒåµŒå¥—çš„ï¼Œä¾‹å¦‚ï¼š shopGroup := r.Group(\"/shop\") { shopGroup.GET(\"/index\", func(c *gin.Context) {...}) shopGroup.GET(\"/cart\", func(c *gin.Context) {...}) shopGroup.POST(\"/checkout\", func(c *gin.Context) {...}) // åµŒå¥—è·¯ç”±ç»„ xx := shopGroup.Group(\"xx\") xx.GET(\"/oo\", func(c *gin.Context) {...}) } é€šå¸¸æˆ‘ä»¬å°†è·¯ç”±åˆ†ç»„ç”¨åœ¨åˆ’åˆ†ä¸šåŠ¡é€»è¾‘æˆ–åˆ’åˆ†APIç‰ˆæœ¬æ—¶ã€‚ 9.8.3 è·¯ç”±åŸç† Ginæ¡†æ¶ä¸­çš„è·¯ç”±ä½¿ç”¨çš„æ˜¯httprouterè¿™ä¸ªåº“ã€‚ å…¶åŸºæœ¬åŸç†å°±æ˜¯æ„é€ ä¸€ä¸ªè·¯ç”±åœ°å€çš„å‰ç¼€æ ‘ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:8","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.9 Ginä¸­é—´ä»¶ Ginæ¡†æ¶å…è®¸å¼€å‘è€…åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼ŒåŠ å…¥ç”¨æˆ·è‡ªå·±çš„é’©å­ï¼ˆHookï¼‰å‡½æ•°ã€‚è¿™ä¸ªé’©å­å‡½æ•°å°±å«ä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶é€‚åˆå¤„ç†ä¸€äº›å…¬å…±çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ç™»å½•è®¤è¯ã€æƒé™æ ¡éªŒã€æ•°æ®åˆ†é¡µã€è®°å½•æ—¥å¿—ã€è€—æ—¶ç»Ÿè®¡ç­‰ã€‚ 9.9.1 å®šä¹‰ä¸­é—´ä»¶ Ginä¸­çš„ä¸­é—´ä»¶å¿…é¡»æ˜¯ä¸€ä¸ªgin.HandlerFuncç±»å‹ã€‚ 9.9.1.1 è®°å½•æ¥å£è€—æ—¶çš„ä¸­é—´ä»¶ ä¾‹å¦‚æˆ‘ä»¬åƒä¸‹é¢çš„ä»£ç ä¸€æ ·å®šä¹‰ä¸€ä¸ªç»Ÿè®¡è¯·æ±‚è€—æ—¶çš„ä¸­é—´ä»¶ã€‚ // StatCost æ˜¯ä¸€ä¸ªç»Ÿè®¡è€—æ—¶è¯·æ±‚è€—æ—¶çš„ä¸­é—´ä»¶ func StatCost() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() c.Set(\"name\", \"å°ç‹å­\") // å¯ä»¥é€šè¿‡c.Setåœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å€¼ï¼Œåç»­çš„å¤„ç†å‡½æ•°èƒ½å¤Ÿå–åˆ°è¯¥å€¼ // è°ƒç”¨è¯¥è¯·æ±‚çš„å‰©ä½™å¤„ç†ç¨‹åº c.Next() // ä¸è°ƒç”¨è¯¥è¯·æ±‚çš„å‰©ä½™å¤„ç†ç¨‹åº // c.Abort() // è®¡ç®—è€—æ—¶ cost := time.Since(start) log.Println(cost) } } 9.9.1.2 è®°å½•å“åº”ä½“çš„ä¸­é—´ä»¶ æˆ‘ä»¬æœ‰æ—¶å€™å¯èƒ½ä¼šæƒ³è¦è®°å½•ä¸‹æŸäº›æƒ…å†µä¸‹è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç¼–å†™ä¸€ä¸ªä¸­é—´ä»¶æ¥æå®šã€‚ type bodyLogWriter struct { gin.ResponseWriter // åµŒå…¥ginæ¡†æ¶ResponseWriter body *bytes.Buffer // æˆ‘ä»¬è®°å½•ç”¨çš„response } // Write å†™å…¥å“åº”ä½“æ•°æ® func (w bodyLogWriter) Write(b []byte) (int, error) { w.body.Write(b) // æˆ‘ä»¬è®°å½•ä¸€ä»½ return w.ResponseWriter.Write(b) // çœŸæ­£å†™å…¥å“åº” } // ginBodyLogMiddleware ä¸€ä¸ªè®°å½•è¿”å›ç»™å®¢æˆ·ç«¯å“åº”ä½“çš„ä¸­é—´ä»¶ // https://stackoverflow.com/questions/38501325/how-to-log-response-body-in-gin func ginBodyLogMiddleware(c *gin.Context) { blw := \u0026bodyLogWriter{body: bytes.NewBuffer([]byte{}), ResponseWriter: c.Writer} c.Writer = blw // ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹æ›¿æ¢é»˜è®¤çš„ c.Next() // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ fmt.Println(\"Response body: \" + blw.body.String()) // äº‹åæŒ‰éœ€è®°å½•è¿”å›çš„å“åº” } 9.9.1.3 è·¨åŸŸä¸­é—´ä»¶cors æ¨èä½¿ç”¨ç¤¾åŒºçš„https://github.com/gin-contrib/cors åº“ï¼Œä¸€è¡Œä»£ç è§£å†³å‰åç«¯åˆ†ç¦»æ¶æ„ä¸‹çš„è·¨åŸŸé—®é¢˜ã€‚ æ³¨æ„ï¼š è¯¥ä¸­é—´ä»¶éœ€è¦æ³¨å†Œåœ¨ä¸šåŠ¡å¤„ç†å‡½æ•°å‰é¢ã€‚ è¿™ä¸ªåº“æ”¯æŒå„ç§å¸¸ç”¨çš„é…ç½®é¡¹ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ã€‚ package main import ( \"time\" \"github.com/gin-contrib/cors\" \"github.com/gin-gonic/gin\" ) func main() { router := gin.Default() // CORS for https://foo.com and https://github.com origins, allowing: // - PUT and PATCH methods // - Origin header // - Credentials share // - Preflight requests cached for 12 hours router.Use(cors.New(cors.Config{ AllowOrigins: []string{\"https://foo.com\"}, // å…è®¸è·¨åŸŸå‘æ¥è¯·æ±‚çš„ç½‘ç«™ AllowMethods: []string{\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"}, // å…è®¸çš„è¯·æ±‚æ–¹æ³• AllowHeaders: []string{\"Origin\", \"Authorization\", \"Content-Type\"}, ExposeHeaders: []string{\"Content-Length\"}, AllowCredentials: true, AllowOriginFunc: func(origin string) bool { // è‡ªå®šä¹‰è¿‡æ»¤æºç«™çš„æ–¹æ³• return origin == \"https://github.com\" }, MaxAge: 12 * time.Hour, })) router.Run() } å½“ç„¶ä½ å¯ä»¥ç®€å•çš„åƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç é‚£æ ·ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œå…è®¸æ‰€æœ‰çš„è·¨åŸŸè¯·æ±‚ã€‚ func main() { router := gin.Default() // same as // config := cors.DefaultConfig() // config.AllowAllOrigins = true // router.Use(cors.New(config)) router.Use(cors.Default()) router.Run() } 9.9.2 æ³¨å†Œä¸­é—´ä»¶ åœ¨ginæ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè·¯ç”±æ·»åŠ ä»»æ„æ•°é‡çš„ä¸­é—´ä»¶ã€‚ 9.9.2.1 ä¸ºå…¨å±€è·¯ç”±æ³¨å†Œ func main() { // æ–°å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•é»˜è®¤ä¸­é—´ä»¶çš„è·¯ç”± r := gin.New() // æ³¨å†Œä¸€ä¸ªå…¨å±€ä¸­é—´ä»¶ r.Use(StatCost()) r.GET(\"/test\", func(c *gin.Context) { name := c.MustGet(\"name\").(string) // ä»ä¸Šä¸‹æ–‡å–å€¼ log.Println(name) c.JSON(http.StatusOK, gin.H{ \"message\": \"Hello world!\", }) }) r.Run() } 9.9.2.2 ä¸ºæŸä¸ªè·¯ç”±å•ç‹¬æ³¨å†Œ // ç»™/test2è·¯ç”±å•ç‹¬æ³¨å†Œä¸­é—´ä»¶ï¼ˆå¯æ³¨å†Œå¤šä¸ªï¼‰ r.GET(\"/test2\", StatCost(), func(c *gin.Context) { name := c.MustGet(\"name\").(string) // ä»ä¸Šä¸‹æ–‡å–å€¼ log.Println(name) c.JSON(http.StatusOK, gin.H{ \"message\": \"Hello world!\", }) }) 9.9.2.3 ä¸ºè·¯ç”±ç»„æ³¨å†Œä¸­é—´ä»¶ ä¸ºè·¯ç”±ç»„æ³¨å†Œä¸­é—´ä»¶æœ‰ä»¥ä¸‹ä¸¤ç§å†™æ³•ã€‚ å†™æ³•1ï¼š shopGroup := r.Group(\"/shop\", StatCost()) { shopGroup.GET(\"/index\", func(c *gin.Context) {...}) ... } å†™æ³•2ï¼š shopGroup := r.Group(\"/shop\") shopGroup.Use(StatCost()) { shopGroup.GET(\"/index\", func(c *gin.Context) {...}) ... } 9.9.3 ä¸­é—´ä»¶æ³¨æ„äº‹é¡¹ 9.9.3.1 giné»˜è®¤ä¸­é—´ä»¶ gin.Default()é»˜è®¤ä½¿ç”¨äº†Loggerå’ŒRecoveryä¸­é—´ä»¶ï¼Œå…¶ä¸­ï¼š Loggerä¸­é—´ä»¶å°†æ—¥å¿—å†™å…¥gin.DefaultWriterï¼Œå³ä½¿é…ç½®äº†GIN_MODE=releaseã€‚ Recoveryä¸­é—´ä»¶ä¼šrecoverä»»ä½•panicã€‚å¦‚æœæœ‰panicçš„è¯ï¼Œä¼šå†™å…¥500å“åº”ç ã€‚ å¦‚æœä¸æƒ³ä½¿ç”¨ä¸Šé¢ä¸¤ä¸ªé»˜è®¤çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨gin.New()æ–°å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•é»˜è®¤ä¸­é—´ä»¶çš„è·¯ç”±ã€‚ 9.9.3.2 ginä¸­é—´ä»¶ä¸­ä½¿ç”¨goroutine å½“åœ¨ä¸­é—´ä»¶æˆ–handlerä¸­å¯åŠ¨æ–°çš„goroutineæ—¶ï¼Œä¸èƒ½ä½¿ç”¨åŸå§‹çš„ä¸Šä¸‹æ–‡ï¼ˆc *gin.Contextï¼‰ï¼Œå¿…é¡»ä½¿ç”¨å…¶åªè¯»å‰¯æœ¬ï¼ˆc.Copy()ï¼‰ã€‚ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:9","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"9.10 è¿è¡Œå¤šä¸ªæœåŠ¡ æˆ‘ä»¬å¯ä»¥åœ¨å¤šä¸ªç«¯å£å¯åŠ¨æœåŠ¡ï¼Œä¾‹å¦‚ï¼š package main import ( \"log\" \"net/http\" \"time\" \"github.com/gin-gonic/gin\" \"golang.org/x/sync/errgroup\" ) var ( g errgroup.Group ) func router01() http.Handler { e := gin.New() e.Use(gin.Recovery()) e.GET(\"/\", func(c *gin.Context) { c.JSON( http.StatusOK, gin.H{ \"code\": http.StatusOK, \"error\": \"Welcome server 01\", }, ) }) return e } func router02() http.Handler { e := gin.New() e.Use(gin.Recovery()) e.GET(\"/\", func(c *gin.Context) { c.JSON( http.StatusOK, gin.H{ \"code\": http.StatusOK, \"error\": \"Welcome server 02\", }, ) }) return e } func main() { server01 := \u0026http.Server{ Addr: \":8080\", Handler: router01(), ReadTimeout: 5 * time.Second, WriteTimeout: 10 * time.Second, } server02 := \u0026http.Server{ Addr: \":8081\", Handler: router02(), ReadTimeout: 5 * time.Second, WriteTimeout: 10 * time.Second, } // å€ŸåŠ©errgroup.Groupæˆ–è€…è‡ªè¡Œå¼€å¯ä¸¤ä¸ªgoroutineåˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ g.Go(func() error { return server01.ListenAndServe() }) g.Go(func() error { return server02.ListenAndServe() }) if err := g.Wait(); err != nil { log.Fatal(err) } } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:8:10","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"äº”ã€HTTP ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"1. æ¦‚è¿° ç¼–å†™webçš„è¯­è¨€ï¼š Java phpï¼Œç°åœ¨éƒ½åœ¨å°è¯•ç”¨goé‡å†™ pythonï¼Œè±†ç“£ goï¼Œbeegoï¼Œginä¸¤ä¸ªä¸»æµçš„webæ¡†æ¶ httpsåè®®ï¼šæˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨è®¿é—®çš„æ—¶å€™å‘é€çš„å°±æ˜¯httpè¯·æ±‚ httpæ˜¯åº”ç”¨å±‚åè®®ï¼Œåº•å±‚è¿˜æ˜¯ä¾èµ–ä¼ è¾“å±‚ï¼›tcpï¼ˆçŸ­è¿æ¥ï¼‰ï¼Œç½‘ç»œå±‚ï¼ˆipï¼‰ æ— çŠ¶æ€çš„ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸‹æ¬¡è¯·æ±‚éœ€è¦é‡æ–°å»ºç«‹è¿æ¥ httpsï¼š httpæ˜¯æ ‡å‡†åè®® https = http + sslï¼ˆéå¯¹ç§°åŠ å¯†ï¼Œæ•°å­—è¯ä¹¦ï¼‰ ç°åœ¨æ‰€æœ‰ç½‘ç«™éƒ½å°½é‡è¦æ±‚ä½¿ç”¨httpså¼€å‘ï¼Œä¸ºäº†å®‰å…¨ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"2. httpè¯·æ±‚æŠ¥æ–‡æ ¼å¼ ä¸€ä¸ªhttpè¯·æ±‚å¯ä»¥åˆ†ä¸º4éƒ¨åˆ†ï¼š è¯·æ±‚è¡Œ æ ¼å¼ï¼šæ–¹æ³• + URL + åè®®ç‰ˆæœ¬å· å®ä¾‹ï¼šPOST + /chapter17/user.html + HTTP/1.1 è¯·æ±‚æ–¹æ³•ï¼š GETï¼šè·å–æ•°æ® POSTï¼šä¸Šä¼ æ•°æ®ï¼ˆè¡¨å•æ ¼å¼ï¼Œjsonæ ¼å¼ï¼‰ PUTï¼šä¿®æ”¹æ•°æ® DELETEï¼šç”¨äºåˆ é™¤æ•°æ® è¯·æ±‚å¤´ æ ¼å¼ï¼škeyï¼švalue å¯ä»¥æœ‰å¾ˆå¤šä¸ªé”®å€¼å¯¹ï¼ˆåŒ…å«åè®®è‡ªå¸¦ï¼Œä¹ŸåŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼‰ é‡è¦çš„å¤´ï¼š Acceptï¼šæ¥æ”¶æ•°æ®çš„æ ¼å¼ User-Agentï¼šæè¿°ç”¨æˆ·æµè§ˆå™¨çš„ä¿¡æ¯ Connectionï¼šKeep-Aliveï¼ˆé•¿è¿æ¥ï¼‰ï¼ŒCloseï¼ˆçŸ­è¿æ¥ï¼‰ Accept-Encodingï¼šgzipï¼Œxxxï¼Œæè¿°å¯æ¥å—çš„ç¼–ç  Cookieï¼šç”±æœåŠ¡å™¨è®¾ç½®çš„key = valueæ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸‹æ¬¡è¯·æ±‚å¯ä»¥æºå¸¦ä»¥éªŒè¯ Content-Typeï¼š application/-formï¼ˆè¡¨ç¤ºä¸Šä¼ çš„æ•°æ®æ˜¯è¡¨å•æ ¼å¼ï¼‰ application/jsonï¼ˆè¡¨ç¤ºbodyçš„æ•°æ®æ˜¯jsonæ ¼å¼ï¼‰ ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çš„ï¼š nameï¼šDUKE ageï¼š18 ç©ºè¡Œ å‘Šè¯‰æœåŠ¡å™¨ï¼Œè¯·æ±‚å¤´ç»“æŸäº†ï¼Œç”¨äºåˆ†å‰² è¯·æ±‚åŒ…ä½“ï¼ˆå¯é€‰çš„ï¼‰ ä¸€èˆ¬åœ¨POSTæ–¹æ³•æ—¶ï¼Œä¼šé…å¥—æä¾›BODY åœ¨GETçš„æ—¶å€™ä¹Ÿå¯ä»¥æä¾›BODYï¼Œä½†è¿™æ ·å®¹æ˜“è®©äººæ··æ·†ï¼Œå»ºè®®ä¸è¦è¿™æ ·ä½¿ç”¨ ä¸Šä¼ ä¸¤ç§æ•°æ®æ ¼å¼ï¼š è¡¨å•ï¼šå§“åï¼Œæ€§åˆ«ï¼Œå¹´é¾„ jsonæ•°æ®æ ¼å¼ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"3. httpå“åº”æ¶ˆæ¯æ ¼å¼ httpå“åº”æ¶ˆæ¯æ ¼å¼åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š çŠ¶æ€è¡Œ åè®®æ ¼å¼ï¼šåè®®ç‰ˆæœ¬å· + çŠ¶æ€ç  + çŠ¶æ€æè¿° å®ä¾‹ï¼šHTTP/1.1 + 200 + OK å®ä¾‹ï¼šHTTP/1.1 + 404 + Page not found å¸¸ç”¨çŠ¶æ€ç  1xxï¼šå®¢æˆ·ç«¯å¯ä»¥å³æ—¶å‘é€è¯·æ±‚ï¼ˆä¸€èˆ¬æ„ŸçŸ¥ä¸åˆ°ï¼‰ 2xxï¼šæ­£å¸¸è®¿é—®ï¼Œ200 3xxï¼šé‡å®šå‘ 4xxï¼š 401ï¼šæœªæˆæƒ not authorized 404ï¼šNot found 5xxï¼š 501ï¼šInternal Errorï¼ˆæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼‰ å“åº”å¤´ Content-Typeï¼šapplication/json Serverï¼šApache Dataï¼šMonï¼Œ12 Sep â€¦ ç©ºè¡Œ ç”¨äºåˆ†å‰²ï¼Œè¡¨ç¤ºä¸‹é¢æ²¡æœ‰å“åº”å¤´äº† å“åº”ä½“ é€šå¸¸æ˜¯è¿”å›jsonæ ¼å¼æ•°æ® func main() { // httpåŒ… client := http.Client{} // func (c *Client) Get(url string) (resp *Response, err error) { resp, err := client.Get(\"https://www.baidu.com\") if err != nil { fmt.Println(\"client.Get err: \", err) return } // è¯»å–Header ct := resp.Header.Get(\"Content-Type\") data := resp.Header.Get(\"Date\") ser := resp.Header.Get(\"Server\") fmt.Println(\"content-type: \", ct) fmt.Println(\"date: \", data) fmt.Println(\"server: \", ser) fmt.Println(\"----------------------\") // è¯»å–çŠ¶æ€è¡Œ url := resp.Request.URL code := resp.StatusCode status := resp.Status fmt.Println(\"url: \", url) fmt.Println(\"code: \", code) fmt.Println(\"status: \", status) fmt.Println(\"----------------------\") // è¯»å–å“åº”ä½“ body := resp.Body // func ReadAll(r io.Reader) ([]byte, error) readBodyStr, err := ioutil.ReadAll(body) if err != nil { fmt.Println(\"read body err: \", err) return } fmt.Println(\"body string: \", string(readBodyStr)) } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:3","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"4. http-server func main() { // æ³¨å†Œè·¯ç”± router // xxx/user ==\u003e func1 // xxx/name ==\u003e func2 // xxx/id ==\u003e func3 // https://127.0.0.1:8080/user funcæ˜¯å›è°ƒå‡½æ•°ï¼Œç”¨äºè·¯ç”±çš„å“åº”ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°åŸå‹æ˜¯å›ºå®šçš„ http.HandleFunc(\"/user\", func(writer http.ResponseWriter, request *http.Request) { // request: ===\u003e åŒ…å«å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ® fmt.Println(\"ç”¨æˆ·è¯·æ±‚è¯¦æƒ…: \") fmt.Println(\"request: \", request) // è¿™é‡Œæ˜¯å…·ä½“å¤„ç†ä¸šåŠ¡é€»è¾‘ // writer: ===\u003e é€šè¿‡writerå°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ _, _ = io.WriteString(writer, \"è¿™æ˜¯/userè¯·æ±‚è¿”å›çš„æ•°æ®!\") }) // https://127.0.0.1:8080/name http.HandleFunc(\"/name\", func(writer http.ResponseWriter, request *http.Request) { _, _ = io.WriteString(writer, \"è¿™æ˜¯/nameè¯·æ±‚è¿”å›çš„æ•°æ®!\") }) // https://127.0.0.1:8080/id http.HandleFunc(\"/id\", func(writer http.ResponseWriter, request *http.Request) { _, _ = io.WriteString(writer, \"è¿™æ˜¯/idè¯·æ±‚è¿”å›çš„æ•°æ®!\") }) // func ListenAndServe(addr string, handler Handler) error // å¸¸è§„å†™æ³• fmt.Println(\"Http Server Start ...\") err := http.ListenAndServe(\"127.0.0.1:8080\", nil) if err != nil { fmt.Println(\"http start failed, err: \", err) return } /*// ç®€ä¾¿å†™æ³• if err := http.ListenAndServe(\"127.0.0.1:8080\", nil); err != nil { fmt.Println(\"http start failed, err: \", err) return }*/ } ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:4","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"5. json { \"name\": \"çŸ®å¤§ç´§\", \"sex\": \"man\", \"age\": 131, \"girls\": [\"é‡‘è²\", \"å‡¤å§\", \"é©¬è\", \"æ˜¥å“¥\"], \"æˆç»©\": [2, 14, 9, 78, 96], \"å®¶ç”µ\": {\"å½©ç”µ\": \"æµ·å°”\", \"æ´—è¡£æœº\": \"ä¸‰æ˜Ÿ\"}, \"stars\": [ {\"name\": \"Faye\", \"address\": \"åŒ—äº¬\"}, {\"name\": \"Andy\", \"address\": \"é¦™æ¸¯\"}, {\"name\": \"Eddie\", \"address\": \"å°æ¹¾\"} ] } è®°ä½ï¼šjsonæœ€åä¸€ä¸ªå…ƒç´ åé¢ä¸èƒ½åŠ é€—å· jsonç¼–è§£ç  åœ¨ç½‘ç»œä¼ è¾“çš„æ—¶å€™ï¼ŒæŠŠç»“æ„ä½“ï¼Œç¼–ç æˆjsonå­—ç¬¦ä¸²ï¼Œå†è¿›è¡Œä¼ è¾“ æ¥æ”¶å­—ç¬¦ä¸²ï¼Œéœ€è¦æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆç»“æ„ä½“ï¼Œç„¶åæ“ä½œ ==\u003e å­—ç¬¦ä¸² ==\u003e ç»“æ„ä½“ ==\u003e è§£å¯† type Student struct { Id int Name string Age int gender string // æ³¨æ„æ­¤å¤„æ˜¯å°å†™ çœ‹åŒºåˆ« å°å†™å¼€å¤´çš„ï¼Œjsonç¼–ç æ—¶ä¼šå¿½ç•¥æ‰ } func main() { lily := Student{ Id: 1, Name: \"lily\", Age: 18, gender: \"å¥³\", } // ç¼–ç ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œç»“æ„ =\u003e å­—ç¬¦ä¸² // func Marshal(v interface{}) ([]byte, error) encodeInfo, err := json.Marshal(\u0026lily) if err != nil { fmt.Println(\"json.Marshal err: \", err) return } fmt.Println(\"encodeInfo: \", string(encodeInfo)) // encodeInfo: {\"Id\":1,\"Name\":\"lily\",\"Age\":18} // å¯¹ç«¯æ¥æ”¶åˆ°æ•°æ® // ååºåˆ—åŒ–ï¼ˆè§£ç ï¼‰ï¼šå­—ç¬¦ä¸² ==\u003e ç»“æ„ä½“ var lily2 Student // func Unmarshal(data []byte, v interface{}) error err = json.Unmarshal([]byte(encodeInfo), \u0026lily2) if err != nil { fmt.Println(\"json.Unmarshal err: \", err) return } fmt.Println(\"name: \", lily2.Name) fmt.Println(\"gender: \", lily2.gender) // æ‰“å°ç©ºç™½ fmt.Println(\"id: \", lily2.Id) fmt.Println(\"age: \", lily2.Age) } **æ³¨ï¼š**structä¸­å°å†™å­—æ¯å¼€å¤´çš„ï¼Œjsonç¼–ç æ—¶ä¼šè‡ªåŠ¨å¿½ç•¥æ‰ï¼ï¼ï¼ ç»“æ„ä½“æ ‡ç­¾ type Teacher struct { Name string `json:\"-\"` // åœ¨ä½¿ç”¨jsonç¼–ç æ—¶ï¼Œè¿™ä¸ªä¸å‚ä¸ç¼–ç  æ³¨æ„æ­¤å¤„æ˜¯åå¼•å·`` Subject string `json:\"Subject_name\"` // åœ¨jsonç¼–ç æ—¶ï¼Œè¿™ä¸ªå­—æ®µä¼šç¼–ç æˆSubject_name Age int `json:\"age,string\"` // åœ¨jsonç¼–ç ä¸­ï¼Œå°†åå­—è½¬æ¢æˆageå¹¶è½¬æ¢æˆstringç±»å‹ Address string `json:\"address,omitempty\"` // åœ¨jsonç¼–ç ä¸­ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µä¸ºç©ºï¼Œé‚£ä¹ˆå¿½ç•¥æ‰ï¼Œä¸å‚ä¸ç¼–ç  gender string // åœ¨jsonç¼–ç ä¸­ï¼Œå°å†™å­—æ¯çš„ä¸å‚ä¸ç¼–ç  } func main() { t1 := Teacher{ Name: \"Duke\", Subject: \"Golang\", Age: 18, Address: \"åŒ—äº¬\", gender: \"ç”·\", } fmt.Println(\"t1: \", t1) encodeInfo, _ := json.Marshal(\u0026t1) fmt.Println(\"encodeInfo: \", string(encodeInfo)) } æ€»ç»“ï¼š å¯¹äºç»“æ„ä½“è¿›è¡Œç¼–ç æ—¶ï¼Œå­—æ®µé¦–å­—æ¯å¿…é¡»æ˜¯å¤§å†™ï¼Œå¦åˆ™ä¸å‚ä¸ç¼–ç  å¦‚æœjsonæ ¼å¼è¦æ±‚keyå°å†™ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æ ‡ç­¾ï¼ˆtagï¼‰æ¥è§£å†³ tagç»†èŠ‚ï¼š Name string `json:\"-\"` // åœ¨jsonç¼–ç æ—¶ï¼Œè¿™ä¸ªä¸å‚ä¸ç¼–ç  æ³¨æ„æ­¤å¤„æ˜¯åå¼•å·`` Subject string `json:\"Subject_name\"` // åœ¨jsonç¼–ç æ—¶ï¼Œè¿™ä¸ªå­—æ®µä¼šç¼–ç æˆSubject_name Age int `json:\"age,string\"` // åœ¨jsonç¼–ç ä¸­ï¼Œå°†åå­—è½¬æ¢æˆageå¹¶è½¬æ¢æˆstringç±»å‹ Address string `json:\"address,omitempty\"` // åœ¨jsonç¼–ç ä¸­ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µä¸ºç©ºï¼Œé‚£ä¹ˆå¿½ç•¥æ‰ï¼Œä¸å‚ä¸ç¼–ç  ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:9:5","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"å…­ã€é¡¹ç›®Demo ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:10:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"6.1 èŠå¤©å®¤ 1. åŠŸèƒ½åˆ†æ å®ç°ä¸€ä¸ªç½‘ç»œèŠå¤©å®¤ï¼ˆç¾¤ï¼‰ï¼š ä¸Šçº¿ä¸‹çº¿ èŠå¤©ï¼Œå…¶ä»–äººã€è‡ªå·±éƒ½å¯ä»¥çœ‹åˆ°èŠå¤©ä¿¡æ¯ æŸ¥è¯¢å½“å‰èŠå¤©å®¤ç”¨æˆ·åå­— å¯ä»¥ä¿®æ”¹è‡ªå·±çš„åå­— è¶…æ—¶è¸¢å‡º 2. æŠ€æœ¯åˆ†æ æŠ€æœ¯ç‚¹åˆ†æï¼š socket tcpç¼–ç¨‹ mapç»“æ„ï¼š å­˜å‚¨æ‰€æœ‰ç”¨æˆ· mapéå† mapåˆ é™¤ goç¨‹ã€channel selectï¼ˆè¶…æ—¶é€€å‡ºï¼Œä¸»åŠ¨é€€å‡ºï¼‰ timerå®šæ—¶å™¨ 3. å®ç°åŸºç¡€ æ€è·¯åˆ†æ tcp socketï¼Œå»ºç«‹å¤šè¿æ¥ for { fmt.Println(\"ä¸»goç¨‹ç›‘å¬ä¸­...\") // ç›‘å¬è¿æ¥ conn, err := listener.Accept() if err != nil { fmt.Println(\"listener.Accept err: \", err) return } fmt.Println(\"å»ºç«‹è¿æ¥æˆåŠŸ!\") // ä¸šåŠ¡å¤„ç† go handle(conn) } å®šä¹‰User/mapç»“æ„ newuser := User{ name: clientAddr, id: clientAddr, msg: make(chan string), // éœ€è¦makeç©ºé—´ å¦åˆ™æ— æ³•å†™å…¥æ•°æ® } // å°†useræ·»åŠ åˆ°map allUsers[newuser.id] = newuser å®šä¹‰messageé€šé“ // å®šä¹‰ä¸€ä¸ªmessageå…¨å±€é€šé“ï¼Œç”¨äºæ¥æ”¶ä»»ä½•äººå‘é€æ¥çš„æ¶ˆæ¯ var message = make(chan string, 10) åˆ›å»ºç›‘å¬å¹¿æ’­è¿‡ç¨‹å‡½æ•° // å‘æ‰€æœ‰çš„ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯ï¼Œå¯åŠ¨ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„goç¨‹ func broadcast() { fmt.Println(\"å¹¿æ’­goç¨‹å¯åŠ¨æˆåŠŸ! \") // 1. ä»messageä¸­è¯»å–æ•°æ® info := \u003c-message for _, user := range allUsers { user.msg \u003c- info } } å¯åŠ¨ï¼Œå…¨å±€å”¯ä¸€ // å¯åŠ¨å…¨å±€å”¯ä¸€çš„goç¨‹ï¼Œè´Ÿè´£ç›‘å¬messageé€šé“ï¼Œå†™ç»™æ‰€æœ‰çš„ç”¨æˆ· go broadcast() fmt.Println(\"æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ! \") å†™å…¥ä¸Šçº¿ä¿¡æ¯ // å°†ç”¨æˆ·ä¸Šçº¿çš„æ¶ˆæ¯å†™å…¥messageï¼Œç”¨äºå¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ· loginInfo := fmt.Sprintf(\"[%s]:[%s] ===\u003e ä¸Šçº¿äº†login! \", newuser.id, newuser.name) // æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ï¼Œæœ€å¥½éƒ½ç”¨è¿™ç§ å°‘ç”¨ + message \u003c- loginInfo userç›‘å¬é€šé“ æ¯ä¸ªç”¨æˆ·è¿˜éœ€è¦ä¸€ä¸ªç”¨æ¥ç›‘å¬å„è‡ªmsgé€šé“çš„goç¨‹ï¼Œè´Ÿè´£å°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ func writeBackToClient(user *User, conn net.Conn) { //TODO fmt.Printf(\"user: %s çš„goç¨‹æ­£åœ¨ç›‘å¬è‡ªå·±çš„msgç®¡é“: \\n\", user.name) for data := range user.msg { fmt.Printf(\"user: %s å†™å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®ä¸º: %s\\n\", user.name, data) // Write(b []byte) (n int, err error) _, _ = conn.Write([]byte(data)) } } 4. å¢åŠ åŠŸèƒ½ 1. æŸ¥è¯¢ç”¨æˆ· æŸ¥è¯¢å‘½ä»¤ï¼šwho ==\u003e å°†å½“å‰æ‰€æœ‰ç™»å½•çš„ç”¨æˆ·ï¼Œå±•ç¤ºå‡ºæ¥ï¼Œidï¼Œname 2. é‡å‘½å è§„åˆ™ï¼šrename|Duke è¯»å–æ•°æ®åˆ¤æ–­é•¿åº¦7ï¼Œåˆ¤æ–­å­—ç¬¦æ˜¯rename ä½¿ç”¨ | è¿›è¡Œåˆ†å‰²ï¼Œè·å– | åé¢çš„éƒ¨åˆ†ä½œä¸ºåå­— æ›´æ–°ç”¨æˆ·åå­—newUser.name = Duke é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ›´æ–°æˆåŠŸ else if len(userInput) \u003e 8 \u0026\u0026 userInput[:7] == \"\\\\rename\" { /* 1. è¯»å–æ•°æ®åˆ¤æ–­é•¿åº¦7ï¼Œåˆ¤æ–­å­—ç¬¦æ˜¯rename 2. ä½¿ç”¨ | è¿›è¡Œåˆ†å‰²ï¼Œè·å– | åé¢çš„éƒ¨åˆ†ä½œä¸ºåå­— */ //arry := strings.Split(userInput, \"|\") //name := arry[1] /* 3. æ›´æ–°ç”¨æˆ·åå­—newUser.name = Duke 4. é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ›´æ–°æˆåŠŸ */ newUser.name = strings.Split(userInput, \"|\")[1] allUsers[newUser.id] = newUser // æ›´æ–°mapä¸­çš„user newUser.msg \u003c- \"rename success! \" 3. ä¸»åŠ¨é€€å‡º ä¸¤ç§å½¢å¼ï¼š==\u003e quitï¼Œctrl+c ç”¨æˆ·é€€å‡ºï¼šæ¸…ç†å·¥ä½œ ä»mapä¸­åˆ é™¤ å¯¹åº”çš„connè¦close æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„watch goç¨‹ï¼Œè´Ÿè´£ç›‘å¬é€€å‡ºä¿¡å· // å¯åŠ¨ä¸€ä¸ªgoç¨‹è´Ÿè´£ç›‘å¬é€€å‡ºä¿¡å·ï¼Œè§¦å‘åï¼Œè¿›è¡Œæ¸…é›¶å·¥ä½œ: delete map, close connéƒ½åœ¨è¿™é‡Œè¿›è¡Œå¤„ç† func watch(user *User, conn net.Conn, isQuit \u003c-chan bool) { fmt.Println(\"-2- å¯åŠ¨ç›‘å¬é€€å‡ºä¿¡å·çš„goç¨‹...\") defer fmt.Println(\"watch goç¨‹é€€å‡º! \") for { select { case \u003c-isQuit: logoutInfo := fmt.Sprintf(\"%s exit already! \", user.name) fmt.Println(\"åˆ é™¤å½“å‰ç”¨æˆ·: \", user.name) delete(allUsers, user.id) message \u003c- logoutInfo conn.Close() return // é˜²æ­¢å†…å­˜æ³„éœ² } } } åœ¨handleä¸­å¯åŠ¨watch goç¨‹ // å®šä¹‰ä¸€ä¸ªé€€å‡ºä¿¡å·ï¼Œç”¨äºç›‘å¬clientçš„çŠ¶æ€ var isQuit = make(chan bool) // å¯åŠ¨goç¨‹ï¼Œè´Ÿè´£ç›‘å¬é€€å‡ºä¿¡å· go watch(\u0026newUser, conn, isQuit) åœ¨readä¹‹åï¼Œé€šè¿‡è¯»å–çš„cntåˆ¤æ–­ç”¨æˆ·é€€å‡ºï¼Œå‘isQuitä¸­å†™å…¥ä¿¡å·ï¼š // è¯»å–å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ® cnt, err := conn.Read(buf) if cnt == 0 { fmt.Println(\"å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ctrl+c, å‡†å¤‡é€€å‡º! \") // mapåˆ é™¤ï¼Œconn closeæ‰ // æœåŠ¡å™¨è¿˜å¯ä»¥ä¸»åŠ¨é€€å‡º // åœ¨è¿™é‡Œä¸è¿›è¡ŒçœŸæ­£çš„é€€å‡ºåŠ¨ä½œï¼Œè€Œæ˜¯å‘å‡ºä¸€ä¸ªé€€å‡ºä¿¡å·ï¼Œç»Ÿä¸€åšé€€å‡ºå¤„ç†ï¼Œå¯ä»¥ä½¿ç”¨æ–°çš„ç®¡é“æ¥åšä¿¡å·ä¼ é€’ isQuit \u003c- true } 4. è¶…æ—¶é€€å‡º ä½¿ç”¨å®šæ—¶å™¨æ¥è¿›è¡Œè¶…æ—¶ç®¡ç† å¦‚æœ60så†…æ²¡æœ‰å‘é€ä»»ä½•æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥å°†è¿™ä¸ªè¿æ¥å…³é—­æ‰ï¼š \u003c- time.After(60 * time.second) // chan time åˆ›å»ºrestTimerç®¡é“ç”¨æ¥å½“ä½œé‡ç½®å™¨ï¼š //åˆ›å»ºä¸€ä¸ªç”¨äºé‡ç½®è®¡æ•°å™¨çš„ç®¡é“ï¼Œç”¨äºå‘ŠçŸ¥watchå‡½æ•°ï¼Œå½“å‰ç”¨æˆ·æ­£åœ¨è¾“å…¥ var restTimer = make(chan bool) // å¯åŠ¨goç¨‹ï¼Œè´Ÿè´£ç›‘å¬é€€å‡ºä¿¡å· go watch(\u0026newUser, conn, isQuit, restTimer) æ¯æ¬¡å†™å®Œæ•°æ®åè¿›è¡Œé‡ç½®ï¼š restTimer \u003c- true // é‡ç½® case \u003c-time.After(5 * time.Second): logoutInfo := fmt.Sprintf(\"%s exit timeout!\\n\", user.name) fmt.Println(\"åˆ é™¤å½“å‰ç”¨æˆ·: \", user.name) delete(allUsers, user.id) message \u003c- logoutInfo conn.Close() return // é˜²æ­¢å†…å­˜æ³„éœ² case \u003c-restTimer: fmt.Printf(\"è¿æ¥%s é‡ç½®è®¡æ•°å™¨!\\n\", user.name) 5.ä¸Šé” ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:10:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"6.2 ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ **éœ€æ±‚ï¼š**å®ç°ç”¨æˆ·çš„æ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤ï¼Œå¹¶èƒ½å¤Ÿæ‰“å°ç”¨æˆ·æ˜ç»†è¡¨ã€‚ 6.2.1 ç¨‹åºæ¡†æ¶å›¾ 6.2.2 æ˜¾ç¤ºä¸»èœå•ã€é€€å‡ºè½¯ä»¶ åŠŸèƒ½è¯´æ˜ï¼š ç”¨æˆ·æ‰“å¼€å¯ä»¥çœ‹åˆ°é¡µé¢ 6.2.3 æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨ ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:10:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"å…«ã€é«˜å¹¶å‘ä¸å¾®æœåŠ¡ ==ã€ŠGoè¯­è¨€é«˜å¹¶å‘ä¸å¾®æœåŠ¡å®æˆ˜ã€‹== ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:11:0","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"1. äº‘åŸç”Ÿ 1.1 ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿï¼Ÿ graph äº‘åŸç”Ÿ --\u003e DevOps äº‘åŸç”Ÿ --\u003e æŒç»­é›†æˆ äº‘åŸç”Ÿ --\u003e å¾®æœåŠ¡æ¶æ„ äº‘åŸç”Ÿ --\u003e å®¹å™¨åŒ– ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:11:1","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["Go"],"content":"1.2 å¾®æœåŠ¡ 1.2.1 ç³»ç»Ÿæ¶æ„çš„æ¼”è¿› graph LR å•ä½“æ¶æ„ --\u003e å‚ç›´åˆ†å±‚æ¶æ„ --\u003e SOAé¢å‘æœåŠ¡æ¶æ„ --\u003e å¾®æœåŠ¡æ¶æ„ --\u003e äº‘åŸç”Ÿæ¶æ„ å•ä½“æ¶æ„ ç¼ºç‚¹ï¼šå±€éƒ¨æ”¹åŠ¨å°±éœ€è¦é‡æ–°éƒ¨ç½²ï¼Œä¸æ˜“æ‰©å±•ï¼Œä¸æ”¯æŒå¤šè¯­è¨€æŠ€æœ¯æ ˆã€‚ å‚ç›´åˆ†å±‚æ¶æ„ 1.2.2 å¸¸è§å¾®æœåŠ¡æ¡†æ¶ Java Spring Cloud Dubbo Go Go Kit Go Micro NodeJS Seneca ","date":"2023-01-10","objectID":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/:11:2","tags":["Go","åŸºç¡€æ“ä½œ"],"title":"Goæµ…æ-åŸºç¡€æ“ä½œ","uri":"/go%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"},{"categories":["é€šç”¨","python"],"content":"çˆ¬è™« ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:0:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"ä¸€ã€æ¦‚è¿° ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:1:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"1.1 requestså…¥é—¨ å®‰è£…requests conda install requests # windows éœ€è¦åŠ ä¸Š encoding=\"utf-8\", macæ˜¯é»˜è®¤çš„ with open(\"mybaidu.html\", mode=\"w\", encoding=\"utf-8\") as f: f.write(resp.read().decode(\"utf-8\")) åœ¨åœ°å€æ ä¸­è¾“å…¥æœç´¢çš„å†…å®¹ï¼Œè¿™ç§æ–¹å¼éƒ½æ˜¯get è‹¥è¢«å‘ç°æ˜¯è‡ªåŠ¨è®¾å¤‡å‘å‡ºçš„è¯·æ±‚è€Œè¢«æ‹’ç»ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ agentï¼Œå¦‚ä¸‹å›¾ä¸­ï¼š # æ·»åŠ agent é˜²æ­¢è¢«è¯†åˆ«ä¸ºè‡ªåŠ¨åŒ–è¯·æ±‚ dic = { \"user-agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\" } resp = requests.get(url, headers=dic) # å¤„ç†äº†ä¸€ä¸ªå°åçˆ¬ å®ç°ç¿»è¯‘åŠŸèƒ½ å¯»æ‰¾ä¸‹å›¾ä¸­çš„è¯·æ±‚ï¼š å…¶è¯·æ±‚æ–¹å¼ä¸ºpostæ–¹å¼ï¼Œä»è½½è·ä¸­æŸ¥çœ‹æäº¤çš„æ•°æ®ï¼Œå¹¶æ„é€ jsonè¿›è¡Œæäº¤ï¼š url = \"https://fanyi.sogou.com/reventondc/suggV3\" s = input(\"è¯·è¾“å…¥ä½ è¦æŸ¥è¯¢çš„å•è¯:\") dat = { \"from\": \"auto\", \"to\": \"zh-CHS\", \"client\": \"web\", \"text\": s, \"uuid\": \"da793e6d-1a41-4448-8df5-ae35fc402c3a\", \"pid\": \"sogou-dict-vr\", \"addSugg\": \"on\" } resp = requests.post(url, json=dat) # å°†æœåŠ¡å™¨è¿”å›çš„å†…å®¹ç›´æ¥å¤„ç†æˆjson() ==\u003e dictæ ¼å¼ dic = resp.json() print(dic['sugg']) çˆ¬å–è±†ç“£ç”µå½±æ¦œå• æŸ¥çœ‹è½½è·ï¼Œå‘ç°æ¯æ¬¡æ–°åˆ·æ–°å†…å®¹ï¼Œåªæœ‰start+20ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ”¹å˜è¯·æ±‚ä¸­çš„startæ•°æ®æ¥çˆ¬å–æ‰€æœ‰æ¦œå•ä¿¡æ¯ã€‚ url = \"https://movie.douban.com/j/chart/top_list\" count = 0 info = [] header = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\" } for count in range(0, 81, 20): param = { \"type\": 24, 'interval_id': \"100:90\", \"action\": \"\", \"start\": count, \"limit\": 20 } resp = requests.get(url, params=param, headers=header) info.append(resp.json()) resp.close() # å…³æ‰resp print(info) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:1:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"äºŒã€æ•°æ®è§£æ æä¾›ä¸‰ç§è§£ææ–¹å¼ï¼š reè§£æ bs4è§£æï¼ˆä½¿ç”¨æ–¹ä¾¿ï¼Œä½†è§£æé€Ÿåº¦è¾ƒæ…¢ï¼‰ xpathè§£æ æŒæ¡ä¹‹åï¼Œå†è€ƒè™‘æ€§èƒ½é—®é¢˜ã€‚ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:2:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"2.1 Reè§£æ Reï¼Œæ­£åˆ™è¡¨è¾¾å¼ã€‚ è¯­æ³•ï¼šä½¿ç”¨å…ƒå­—ç¬¦è¿›è¡Œæ’åˆ—ç»„åˆç”¨æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œåœ¨çº¿æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼ï¼šhttps://tool.oschina.net/regex å…ƒå­—ç¬¦ï¼šå…·æœ‰å›ºå®šå«ä¹‰çš„ç‰¹æ®Šç¬¦å· å¸¸ç”¨å…ƒå­—ç¬¦ï¼šhttps://cloud.tencent.com/developer/article/1337734 . åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦ \\w åŒ¹é…å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ \\s åŒ¹é…ä»»æ„çš„ç©ºç™½ç¬¦ \\d åŒ¹é…æ•°å­— \\n åŒ¹é…ä¸€ä¸ªæ¢è¡Œç¬¦ \\t åŒ¹é…ä¸€ä¸ªåˆ¶è¡¨ç¬¦ ^ åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹ $ åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ \\W åŒ¹é…éå­—æ¯ã€éæ•°å­—ã€éä¸‹åˆ’çº¿ \\D åŒ¹é…éæ•°å­— \\S åŒ¹é…éç©ºç™½ç¬¦ a|b åŒ¹é…å­—ç¬¦aæˆ–å­—ç¬¦b () åŒ¹é…æ‹¬å·å†…çš„è¡¨è¾¾å¼ï¼Œä¹Ÿè¡¨ç¤ºä¸€ä¸ªç»„ [...] åŒ¹é…å­—ç¬¦ç»„ä¸­çš„å­—ç¬¦ [^...] åŒ¹é…é™¤äº†å­—ç¬¦ç»„ä¸­å­—ç¬¦çš„æ‰€æœ‰å­—ç¬¦ é‡è¯ï¼šæ§åˆ¶å‰é¢çš„å…ƒå­—ç¬¦å‡ºç°çš„æ¬¡æ•°ã€‚ * é‡å¤é›¶æ¬¡æˆ–æ›´å¤šæ¬¡ + é‡å¤ä¸€æ¬¡æˆ–æ›´å¤šæ¬¡ ? é‡å¤é›¶æ¬¡æˆ–ä¸å‡ºç° {n} é‡å¤næ¬¡ {n,} é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡ {n,m} é‡å¤nåˆ°mæ¬¡ è´ªå©ªåŒ¹é…å’Œæƒ°æ€§åŒ¹é… .* è´ªå©ªåŒ¹é… (ç©å„¿åƒé¸¡æ¸¸æˆï¼Œç©ä»€ä¹ˆæ¸¸æˆ) .*? æ‰¾æœ€çŸ­çš„ï¼Œ?ä½¿å°½å¯èƒ½å°‘çš„*ï¼Œå°½å¯èƒ½å°‘çš„åŒ¹é… (ç©å„¿åƒé¸¡æ¸¸æˆ) ä¾‹ï¼š \u003cdiv class=\"jay\"\u003eå‘¨æ°ä¼¦\u003c/div\u003e\u003cdiv class=\"jj\"\u003eæ—ä¿Šæ°\u003c/div\u003e ä½¿ç”¨ï¼š\u003c.*?\".*?\"\u003e.*?\u003e æˆ– .*?\u003c/div\u003e ç»“æœï¼š\u003cdiv class=\"jay\"\u003eå‘¨æ°ä¼¦\u003c/div\u003e \u003cdiv class=\"jj\"\u003eæ—ä¿Šæ°\u003c/div\u003e æˆ‘ä»¬çˆ¬è™«ç”¨çš„æœ€å¤šçš„å°±æ˜¯==æƒ°æ€§åŒ¹é…== ==é‡ç‚¹==ï¼š ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½å°±è¶³å¤Ÿä½¿ç”¨ï¼š finditer å’ŒfindallåŠŸèƒ½ç›¸ä¼¼ï¼ˆæŸ¥æ‰¾æ‰€æœ‰ï¼‰ï¼Œä½†æ˜¯è¿”å›è¿­ä»£å™¨ï¼Œæ•ˆç‡é«˜ findall æŸ¥æ‰¾æ‰€æœ‰ï¼Œè¿”å›list search èƒ½å¤Ÿè¿›è¡Œå…¨æ–‡åŒ¹é…ï¼Œä½†æ£€ç´¢åˆ°ç¬¬ä¸€ä¸ªå°±åœæ­¢å¹¶è¿”å› match åªèƒ½ä»å­—ç¬¦ä¸²çš„å¤´éƒ¨å¼€å§‹åŒ¹é… é¢„åŠ è½½æ­£åˆ™ï¼š obj = re.compile(r\"æ­£åˆ™\") ä»è¿­ä»£å™¨ä¸­æ‹¿åˆ°å†…å®¹éœ€è¦ï¼š è¿”å›çš„è¿­ä»£å™¨å¯¹è±¡.group() æå–æœ‰ç”¨çš„æ•°æ®ï¼š (?P\u003cgroup\u003eæ­£åˆ™) import re # æœ€é‡è¦*** finditer: åŒ¹é…å­—ç¬¦ä¸²ä¸­æ‰€æœ‰çš„å†…å®¹[è¿”å›çš„æ˜¯è¿­ä»£å™¨] it = re.finditer(r\"\\d+\", \"æˆ‘çš„ç”µè¯å·æ˜¯:10086, æˆ‘å¥³æœ‹å‹çš„ç”µè¯æ˜¯:10010\") print(it) # ä»è¿­ä»£å™¨ä¸­æ‹¿åˆ°å†…å®¹éœ€è¦ .group() for i in it: print(i.group()) # é¢„åŠ è½½æ­£åˆ™ å¯ä»¥æé«˜æ•ˆç‡ obj = re.compile(r\"\\d+\") # å¯ä»¥å¤šæ¬¡ä½¿ç”¨ ret = obj.finditer(\"æˆ‘çš„ç”µè¯å·æ˜¯:10086, æˆ‘å¥³æœ‹å‹çš„ç”µè¯æ˜¯:10010\") for i in ret: print(i.group()) # éå¸¸éå¸¸é‡è¦çš„ç‚¹ ******** s = \"\"\" \u003cdiv class='jay'\u003e\u003cspan id='1'\u003eéƒ­éº’éºŸ\u003c/span\u003e\u003c/div\u003e \u003cdiv class='jj'\u003e\u003cspan id='2'\u003eå®‹é“\u003c/span\u003e\u003c/div\u003e \u003cdiv class='jolin'\u003e\u003cspan id='3'\u003eå¤§èªæ˜\u003c/span\u003e\u003c/div\u003e \u003cdiv class='sylar'\u003e\u003cspan id='4'\u003eèŒƒæ€å“²\u003c/span\u003e\u003c/div\u003e \u003cdiv class='tory'\u003e\u003cspan id='5'\u003eèƒ¡è¯´å…«é“\u003c/span\u003e\u003c/div\u003e \"\"\" obj = re.compile(r\"\u003cdiv class='.*?'\u003e\u003cspan id='\\d+'\u003e.*?\u003c/span\u003e\u003c/div\u003e\") ret = obj.finditer(s) for i in ret: print(i.group()) # æå–æœ‰ç”¨çš„æ•°æ® (?P\u003cgroup\u003eæ­£åˆ™) obj = re.compile(r\"\u003cdiv class='(?P\u003cclass\u003e.*?)'\u003e\u003cspan id='(?P\u003cid\u003e\\d+)'\u003e(?P\u003cname\u003e.*?)\u003c/span\u003e\u003c/div\u003e\") ret = obj.finditer(s) for i in ret: print(\"class:\", i.group(\"class\"), \"id:\", i.group(\"id\"), \"name:\", i.group(\"name\")) # findall: åŒ¹é…å­—ç¬¦ä¸²ä¸­æ‰€æœ‰çš„ç¬¦åˆæ­£åˆ™çš„å†…å®¹[è¿”å›çš„æ˜¯æ•°ç»„] (ä¸ç»å¸¸ç”¨ æ•°ç»„æ•ˆç‡ä½) lst = re.findall(r\"\\d+\", \"æˆ‘çš„ç”µè¯å·æ˜¯:10086, æˆ‘å¥³æœ‹å‹çš„ç”µè¯æ˜¯:10010\") print(lst) # search: å…¨æ–‡è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°ä¸€ä¸ªç»“æœå°±è¿”å›ï¼Œä¸ä¼šå…¨éƒ½æ‰¾åˆ°ã€‚ # è¿”å›çš„ç»“æœæ˜¯matchå¯¹è±¡, æ‹¿æ•°æ®éœ€è¦ .group() s = re.search(r\"\\d+\", \"æˆ‘çš„ç”µè¯å·æ˜¯:10086, æˆ‘å¥³æœ‹å‹çš„ç”µè¯æ˜¯:10010\") print(s.group()) # match: ä»å¤´å¼€å§‹åŒ¹é…ï¼Œ s = re.match(r\"\\d+\", \"10086, æˆ‘å¥³æœ‹å‹çš„ç”µè¯æ˜¯:10010\") print(s.group()) 2.1.1 Re-è±†ç“£Top250 # æ‹¿åˆ°é¡µé¢æºä»£ç â€”â€”requests # é€šè¿‡reæ¥æå–æƒ³è¦çš„æœ‰æ•ˆä¿¡æ¯â€”â€”re import re import requests # å­˜å‚¨æ•°æ® import csv num = 0 headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\", \"x-client-data\": \"CJe2yQEIo7bJAQjEtskBCKmdygEInvnLAQjmhMwBCNKPzAEIrZzMAQ==\" # # ç”±äºè¢«é™åˆ¶ï¼Œä¸è¢«é™åˆ¶å°±ä¸åŠ  éœ€è¦æ›´æ–° } # è§£ææ•°æ® obj = re.compile(r'\u003cem class=\"\"\u003e(?P\u003cnum\u003e.*?)\u003c/em\u003e.*?' r'\u003cdiv class=\"info\"\u003e.*?\u003cspan class=\"title\"\u003e(?P\u003cname\u003e.*?)\u003c/span\u003e.*?' r'\u003cp class=\"\"\u003e.*?\u003cbr\u003e(?P\u003cyear\u003e.*?)\u0026nbsp.*?' r'property=\"v:average\"\u003e(?P\u003crate\u003e.*?)\u003c/span\u003e.*?' r'\u003cspan\u003e(?P\u003cpeople\u003e.*?)\u003c/span\u003e.*?', re.S) # re.S æ˜¯å…è®¸è·¨è¡Œè¯†åˆ« # å¦‚æœä¸ä½¿ç”¨re.Så‚æ•°ï¼Œåˆ™åªåœ¨æ¯ä¸€è¡Œå†…è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœä¸€è¡Œæ²¡æœ‰ï¼Œå°±æ¢ä¸‹ä¸€è¡Œé‡æ–°å¼€å§‹ï¼Œä¸ä¼šè·¨è¡Œã€‚ # è€Œä½¿ç”¨re.Så‚æ•°ä»¥åï¼Œæ­£åˆ™è¡¨è¾¾å¼ä¼šå°†è¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå°†â€œ\\nâ€å½“åšä¸€ä¸ªæ™®é€šçš„å­—ç¬¦åŠ å…¥åˆ°è¿™ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œåœ¨æ•´ä½“ä¸­è¿›è¡ŒåŒ¹é…ã€‚ # ç”Ÿæˆcsvæ–‡ä»¶ ä¾¿äºæ•°æ®åˆ†æ f = open(\"data.csv\", mode=\"w\", encoding=\"utf-8\") csv_write = csv.writer(f) for num in range(10): # æ‹¿åˆ°é¡µé¢æºä»£ç  url = \"https://movie.douban.com/top250?start=\" + str(num*25) resp = requests.get(url, headers=headers) paper_text = resp.text # print(resp.text) # è¿›è¡ŒåŒ¹é… rect = obj.finditer(paper_text) for i in rect: dict = i.groupdict() dict[\"year\"] = dict[\"year\"].strip() csv_write.writerow(dict.values()) f.close() print(\"over!\") # for i in rect: # print(\"num:\", i.group(\"num\")) # print(\"name:\", i.group(\"name\")) # print(\"year:\", i.group(\"year\").strip()) # print(\"rate:\", i.group(\"rate\")) # print(\"people:\", i.group(\"people\")) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:2:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"2.2 bs4è§£æ \u003cæ ‡ç­¾ å±æ€§=â€œå±æ€§å€¼â€\u003eè¢«æ ‡è®°çš„å†…å®¹\u003c/æ ‡ç­¾\u003e \u003ch1 align=\"center\"\u003ei love you\u003c/h1\u003e # h1: æ ‡ç­¾ # align: å±æ€§ # center: å±æ€§å€¼ \u003ca href=\"http://www.baidu.com\"\u003eå‘¨æ°ä¼¦\u003c/a\u003e # a: æ ‡ç­¾ # href: å±æ€§ # http: å±æ€§å€¼ æŠŠé¡µé¢æºä»£ç äº¤ç»™BeautifulSoupå¤„ç†ï¼Œç”Ÿæˆbså¯¹è±¡ page = BeautifulSoup(resp.text, \"html.parser\") # æŒ‡å®šhtmlè§£æå™¨ ä»bså¯¹è±¡ä¸­æŸ¥æ‰¾æ•°æ® # find(æ ‡ç­¾, å±æ€§=å€¼) # find_all(æ ‡ç­¾, å±æ€§=å€¼) import time import requests from bs4 import BeautifulSoup url = \"https://movie.douban.com/top250\" headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\", \"x-client-data\": \"CJe2yQEIo7bJAQjEtskBCKmdygEInvnLAQjmhMwBCNKPzAEIrZzMAQ==\" # # ç”±äºè¢«é™åˆ¶ï¼Œä¸è¢«é™åˆ¶å°±ä¸åŠ  éœ€è¦æ›´æ–° } resp = requests.get(url, headers=headers) # print(resp.text) page_text = BeautifulSoup(resp.text, \"html.parser\") pic_list = page_text.find_all(\"div\", class_=\"pic\") for i in pic_list: img_list = i.find_all(\"img\") for img in img_list: # print(img) name = img.get(\"alt\") # æ‹¿åˆ°åå­— src = img.get(\"src\") # ç›´æ¥é€šè¿‡getå°±å¯ä»¥æ‹¿åˆ°å±æ€§çš„å€¼, åˆšå¥½æ˜¯å­é¡µé¢çš„ä¸‹è½½è·¯å¾„ # ä¸‹è½½å›¾ç‰‡ img_resp = requests.get(src) img_byte = img_resp.content # è¿™é‡Œæ‹¿åˆ°çš„æ˜¯å­—èŠ‚ img_name = name + \".jpg\" with open(\"img/\" + img_name, mode=\"wb\") as f: # å¯¹æ–‡ä»¶å¤¹mark directory as exclude å¯ä»¥é¿å…pycharmä¸€ç›´å¯¹æ–‡ä»¶è¿›è¡Œç´¢å¼• f.write(img_byte) print(\"over!!\", img_name) time.sleep(1) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:2:2","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"2.3 Xpathè§£æ xpathæ˜¯åœ¨xmlæ–‡æ¡£ä¸­æœç´¢å†…å®¹çš„ä¸€é—¨è¯­è¨€ï¼Œhtmlæ˜¯xmlçš„ä¸€ä¸ªå­é›†ã€‚ å®‰è£…lxmlæ¨¡å—ï¼š conda install lxml from lxml import etree å¯ä»¥æŠŠå„çº§æ ‡ç­¾æ¨¡æ‹Ÿä¸ºå„çº§ç›®å½• ä½¿ç”¨ / è¡¨ç¤ºå±‚çº§å…³ç³»ï¼Œç¬¬ä¸€ä¸ª/è¡¨ç¤ºæ ¹èŠ‚ç‚¹ ä½¿ç”¨ // å–å‡ºæ‰€æœ‰çš„åä»£ /*/ *è¡¨ç¤ºé€šé…ç¬¦ ä»»æ„çš„èŠ‚ç‚¹ /text() å–å‡ºå…¶ä¸­çš„æ–‡æœ¬å†…å®¹ xpathä¸‹æ ‡ä»1å¼€å§‹ [1] è¯»å–htmlæ–‡ä»¶ï¼š etree.parse(\"xxx.html\") ç­›é€‰å±æ€§ï¼š .xpath(\"/html/body/ul/li[1]/a/text()\") # å¯ä»¥æ‹¿å‡ºç¬¬ä¸€ä¸ªliæ ‡ç­¾ä¸­aæ ‡ç­¾çš„æ–‡æœ¬ .xpath(\"/html/body/ul/li/a[@href='dapao']/text()\") # å¯ä»¥æ‹¿å‡ºaæ ‡ç­¾ä¸­å±æ€§href=dapaoçš„æ–‡æœ¬ .xpath(\"/html/body/ul/li/a/@href\") # æ‹¿å‡ºæ ‡ç­¾açš„æ‰€æœ‰hrefå±æ€§ è¿”å›åˆ—è¡¨ï¼š ol_li_list = tree.xpath(\"/html/body/ol/li\") # è¿”å›liæ ‡ç­¾åˆ—è¡¨ for li in ol_li_list: # ä½¿ç”¨ .è¡¨ç¤ºç›¸å¯¹è·¯å¾„ ç›¸å½“äºliå…¶å® result = li.xpath(\"./a/text()\") # å–liä¸­aæ ‡ç­¾çš„æ–‡æœ¬ï¼Œç›¸å¯¹æŸ¥æ‰¾ result = li.xpath(\"./a/@href\") # æ‹¿åˆ°å±æ€§å€¼: @å±æ€§ # æ‹¿åˆ°é¡µé¢æºä»£ç  # æå–å’Œè§£ææ•°æ® import requests from lxml import etree url = \"https://nanjing.zbj.com/search/f/?kw=saas\" resp = requests.get(url) # print(resp.text) # è§£æ html = etree.HTML(resp.text) div_list = html.xpath(\"/html/body/div[6]/div/div/div[2]/div[5]/div[1]/div\") # æ‹¿åˆ°æ¯ä¸€ä¸ªæœåŠ¡å•†çš„divæ ‡ç­¾ for div in div_list: price = div.xpath(\"./div/div/a[2]/div[2]/div[1]/span[1]/text()\")[0].strip(\"Â¥\") # price: ['Â¥898'] ä½¿ç”¨strip()å¤„ç†æ•°æ® title = \"SaaS\".join(div.xpath(\"./div/div/a[2]/div[2]/div[2]/p/text()\")) # ['è½¯ä»¶å¼€å‘/OA/è½¯ä»¶å®šåˆ¶å¼€å‘/', 'è½¯ä»¶/åŸç”Ÿæ··åˆ/ç‰©è”ç½‘'] ä¸­é—´åº”è¯¥æ˜¯æœ‰SasSçš„ ä½†æ˜¯æ²¡æœ‰æå–å‡ºæ¥ å› æ­¤ç”¨joinè¿›è¡Œæ‹¼æ¥ company = div.xpath(\"./div/div/a[1]/div[1]/p/text()\")[1].strip() # company: ['\\n\\n', '\\n\\nå½¬è¾¾ç§‘æŠ€'] ä½¿ç”¨strip()å¯ä»¥ç›´æ¥å»æ‰\\n location = div.xpath(\"./div/div/a[1]/div[1]/div/span/text()\")[0] print(\"title:\", title, \"price:\", price, \"company:\", company, \"location:\", location) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:2:3","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"ä¸‰ã€requestè¿›é˜¶ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:3:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"3.1 æ¨¡æ‹Ÿç™»å½•-cookie å‘ç°è®¿é—®è¯¥ç½‘ç«™å¯ä»¥å¾—åˆ°cookieï¼Œæ³¨æ„ï¼šcookieä¸€èˆ¬ä¸ä¼šåœ¨ é¢„è§ˆ ä¸­ï¼Œ ä¸€èˆ¬åœ¨ å“åº”æ ‡å¤´ ä¸­ å› æ­¤å¯ä»¥POSTè¯¥ç½‘ç«™å¾—åˆ°cookie # è·å¾—cookieï¼Œæ„é€ headers def get_cookie(self): cookie_url = \"http://ehall.seu.edu.cn/ygfw/sys/swpubapp/xxx\" cookie_response = self.session.post(cookie_url, data={\"USERID\": self.user_info.user_id}) # å°†cookiesè½¬åŒ–ä¸ºå­—å…¸æ ¼å¼ print(cookie_response.cookies.get_dict()) $ python main.py å¾—åˆ°Cookie { NSC_ESNS=57d88235-1b4a-127e-9678-00e0ed9d66bd_2375465377_1978659927_00000000005768517823; NSC_JOqgyvhaegq01uld2umxhgbeip03kb0=ffffffff09489f1745525d5f4f58455e445a4a423660; _WEU=tbZT ZDIpO9DfzKWosRmHWCxuajrVVDsuty8Dy6k2GDK0hXp7irsDDNISCgMQIZQTK*DeyDKn7eS0h2lzXOQEjo..; } ä½†æ­¤æ—¶çš„Cookieä¸å¤Ÿï¼Œè¿˜ç¼ºå°‘ å½“é‡æ–°ç™»å½•å¹¶æŠ“åŒ…ï¼Œå¯ä»¥å‘ç°çº¢è‰²æ¡†ä¸­çš„Cookieåœ¨é¦–æ¬¡ç™»é™†æ—¶è·å¾—ï¼š å› æ­¤åœ¨loginçš„æ—¶å€™ï¼Œå°±åº”è¯¥ä¿å­˜è¯¥Cookieã€‚ æäº¤è¡¨å•éœ€è¦ç¼–ç ï¼š self.header['Content-Type'] = 'application/x-www-form-urlencoded; charset=UTF-8' data = parse.urlencode(post_info) self.session.post(url=url, data=data, headers=self.header) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:3:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"3.2 é˜²ç›—é“¾ Referer: â€œâ€ ç”¨äºéªŒè¯ä½ çš„èµ„æºé“¾æ¥æ˜¯ä»å“ªæ¥çš„ï¼Ÿ ç›¸å½“äºæº¯æº ä»æ¢¨è§†é¢‘ç½‘ç«™ä¸‹è½½è§†é¢‘ æµç¨‹ï¼š æ‹¿åˆ°è¯·æ±‚ç½‘å€å’ŒcontID æ‹¿åˆ°videoStatusè¿”å›çš„.json â€“\u003e srcUrl ä¿®æ­£srcUrl ä¸‹è½½è§†é¢‘ # 1. æ‹¿åˆ°contID # 2. æ‹¿åˆ°videoStatusè¿”å›çš„.json --\u003e srcUrl # 3. ä¿®æ­£srcUrl # 4. ä¸‹è½½è§†é¢‘ import requests # æ‹‰å–è§†é¢‘èµ„æºç½‘ç«™ url = \"https://www.pearvideo.com/video_1752547\" url_cont = url.split(\"_\")[1] # ä»¥ _ åˆ†å‰²ä¸ºä¸¤ä¸ªå…ƒç´ ï¼Œå–ç¬¬äºŒä¸ª video_url = f\"https://www.pearvideo.com/videoStatus.jsp?contId={url_cont}\" headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\", \"Referer\": url } # æ‹¿åˆ°å“åº”åŒ… resp = requests.get(video_url, headers=headers) # ä»ç½‘ç»œå“åº”åŒ…ä¸­æ‰¾åˆ°ç½‘ç»œèµ„æºåœ°å€ï¼š # https://video.pearvideo.com/mp4/adshort/20220222/1646013336252-15830346_adpkg-ad_hd.mp4 # ä»https://www.pearvideo.com/video_1658861çš„é¡µé¢å…ƒç´ ä¸­æ‰¾åˆ°è§†é¢‘åœ°å€ä¸ºï¼š # https://video.pearvideo.com/mp4/adshort/20220222/cont-1752547-15830346_adpkg-ad_hd.mp4 dic = resp.json() srcUrl = dic['videoInfo']['videos']['srcUrl'] # æ‹¿åˆ°çš„ç½‘å€å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œé€šè¿‡ä»¥ä¸Šçš„å¯¹æ¯”è¿›è¡Œä¿®æ”¹ sysTime = dic['systemTime'] # ä¿®æ”¹srcUrl srcUrl = srcUrl.replace(sysTime, f\"cont-{url_cont}\") print(srcUrl) # è¯·æ±‚videoèµ„æº video = requests.get(srcUrl) with open(\"a.mp4\", mode=\"wb\") as f: f.write(video.content) print(\"Over!!\") é€šè¿‡å¯¹æ¯”ï¼Œå‘ç°åªæœ‰ cont-1658861 ä¸ä¸€æ ·ï¼Œå¹¶ä¸”contåé¢çš„æ•°å­—å’ŒåŸé“¾æ¥æœ€åçš„æ•°å­—ç›¸åŒï¼Œå› æ­¤å¯¹å“åº”åŒ…ä¸­çš„èµ„æºurlè¿›è¡Œä¿®æ­£ã€‚ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:3:2","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"3.3 ä»£ç† åŸç†ï¼š é€šè¿‡ç¬¬ä¸‰æ–¹çš„æœºå™¨å»å‘é€è¯·æ±‚ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:3:3","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"3.4 ç½‘æ˜“äº‘è¯„è®º é‡Œè¾¹ç”¨åˆ°åŠ å¯†ç®—æ³•ï¼Œéœ€è¦å®‰è£…ï¼š conda install pycrypto from Crypto.Cipher import AES è€ƒè™‘è¿‡ç¨‹ä¸ºï¼š æ‰¾åˆ°æœªåŠ å¯†çš„å‚æ•° æƒ³åŠæ³•å¯¹å‚æ•°è¿›è¡ŒåŠ å¯†ï¼ˆæŒ‰ç…§ç½‘æ˜“çš„åŠ å¯†æ–¹æ³•ï¼‰ï¼Œparamså’ŒencSecKey è¯·æ±‚åˆ°ç½‘æ˜“ï¼Œæ‹¿åˆ°è¯„è®ºä¿¡æ¯ æ‰¾åˆ°è¯„è®ºæ‰€åœ¨è¯·æ±‚ï¼š æ‰¾åˆ°è¯·æ±‚è¯„è®ºçš„é“¾æ¥ï¼š å› ä¸ºè¯·æ±‚æ–¹æ³•æ˜¯Postï¼Œå‘ç°è¡¨å•æ•°æ®è¢«åŠ å¯†ï¼š æŸ¥çœ‹ç¨‹åºè°ƒç”¨å †æ ˆã€‚é€‰å–æœ€ä¸Šé¢é‚£ä¸ªã€‚å› ä¸ºä»–æ˜¯æœ€åæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯å‘é€æ•°æ®çš„ï¼š å®Œäº‹è¿›å»ä¹‹åå‘ç°ç¨‹åºåœç•™åœ¨è¿™ä¸€è¡Œï¼Œåˆšå¥½æ˜¯sendï¼Œåœ¨è¿™ä¸€è¡Œè®¾ç½®ç¨‹åºæ–­ç‚¹ï¼š æŸ¥çœ‹å½“å‰è¯·æ±‚çš„urlï¼Œå‘ç°å’Œæˆ‘ä»¬æƒ³è¦çš„è¯„è®ºurlä¸åŒï¼š ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°æˆ‘ä»¬æƒ³è¦çš„urlä¸ºæ­¢ï¼Œæ­¤æ—¶dataé‡Œçš„paramè¢«åŠ å¯†ï¼š éœ€è¦å¾€å›æ‰¾æœªåŠ å¯†çš„ï¼Œé€šè¿‡ è°ƒç”¨å †æ ˆ å¾€ä¸Šæ‰¾ï¼š æ‰“å¼€ä¹‹åå‘ç°ä¾ç„¶æ˜¯åŠ å¯†çš„ï¼š é‚£ä¹ˆéœ€è¦å†å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æœªåŠ å¯†çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸‹ä¸€å±‚t0x.be0xä¸­æ•°æ®æ‰è¢«åŠ å¯†ï¼š é‚£ä¹ˆå›åˆ°ä¸Šä¸€å±‚ä¸­ï¼Œæ‰¾åˆ°é›†ä½“åœ¨ä½•å¤„è¢«åŠ å¯†ï¼š åœ¨å‡½æ•°ä¸­é€è¡Œè®¾ç½®æ–­ç‚¹ï¼Œæ…¢æ…¢æ£€æµ‹åœ¨ä½•å¤„æ•°æ®è¢«åŠ å¯†ï¼š ä½¿ç”¨å›¾ä¸­æŒ‰é’®å¯ä»¥é€è¡Œæ£€æµ‹ä»£ç ç»“æœï¼Œåœ¨windowâ€¦è¿™ä¸€è¡Œè¿˜æ˜¯æ˜æ–‡ï¼š åˆ°äº†ä¸‹ä¸€è¡Œï¼Œå‚æ•°è¢«åŠ å¯†ï¼Œå› æ­¤å¯ä»¥æ–­å®šåŠ å¯†å‡½æ•°æ˜¯windowâ€¦ï¼Œå¹¶å¯ä»¥å¾—åˆ°åŸæ–‡ï¼š å¯ä»¥çœ‹å‡ºï¼Œparams ==\u003e encTextï¼ŒencSecKey ==\u003e encSecKeyï¼š å–åŠ å¯†å‡½æ•°ï¼š æ³¨æ„åŸå‡½æ•°é‡Œé¢çš„å‚æ•°ï¼Œéœ€è¦ç»™ä»–é…é½ï¼Œå¯¹åº”ç€è°ƒç”¨å¤„çš„å®å‚ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼š é€šè¿‡åœ¨æ§åˆ¶å°è¿è¡Œï¼Œå¯ä»¥å¾—åˆ°å…¶ä»–å‚æ•°ï¼š æˆ–è€…é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹Ÿå¯ä»¥å¾—åˆ°å‚æ•°ï¼š è®¾ç½®æ–­ç‚¹æ‹¿åˆ°ä»¥ä¸‹å‚æ•°ï¼š # æ‰¾åˆ°æœªåŠ å¯†çš„å‚æ•° # æƒ³åŠæ³•æŠŠå‚æ•°è¿›è¡ŒåŠ å¯†ï¼ˆå¿…é¡»å‚è€ƒç½‘æ˜“çš„é€»è¾‘ï¼‰ï¼Œparamsï¼ŒencSecKey # è¯·æ±‚åˆ°ç½‘æ˜“ æ‹¿åˆ°è¯„è®ºä¿¡æ¯ import requests from Crypto.Cipher import AES from base64 import b64encode import json url = \"https://music.163.com/weapi/comment/resource/comments/get?csrf_token=\" # è¯·æ±‚æ–¹æ³•æ˜¯POST # æ‰¾åˆ°çœŸå®å‚æ•° e = '010001' f = '00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341' \\ 'f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82' \\ '047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7' g = '0CoJUm6Qyw8W8jud' # iæ˜¯ä¸ªéšæœºå€¼ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½å»å“åº”åŒ…ä¸­æ‹¿å–i i = '9bdHkFpLbUCNTAnl' # ä¸ºäº†ç®€åŒ–è¿ç®—ï¼ˆä¸æƒ³å¤„ç†cå‡½æ•°ï¼‰ï¼Œè®¾ç½®ä¸ºå›ºå®šçš„ iå›ºå®š åˆ™å®ƒä¹Ÿå›ºå®š def get_encSecKey(): return \"1eb5a1efb12baafd580884b5c41b0a5bbbaee1c0de49f9d0470f05aa2a9215c25563b0ad5da008dacd85f65e0406addbd\" \\ \"a43bbe77716896089f607826000aa4797f34e03e8eb822096c166ec8ae4463ec1f7dab60c045eff18dfdef9f78555301f\" \\ \"3107d521918fea66940b6589749b9db575afa03f74ec04d01f1726f22ba1d2\" def get_params(data): # æ­¤å¤„çš„dataéœ€è¦æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œä¸èƒ½æ˜¯å­—å…¸æ ¼å¼ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨jsonè½¬æ¢ first = enc_params(data, g) params = enc_params(first, i) return params def enc_params(data, key): # åŠ å¯†è¿‡ç¨‹ iv = \"0102030405060708\" aes = AES.new(key=key.encode(\"utf-8\"), IV=iv.encode(\"utf-8\"), mode=AES.MODE_CBC) # åˆ›å»ºä¸€ä¸ªAESå¯¹è±¡ bs = aes.encrypt(to_16(data)) # åŠ å¯†ï¼ŒåŠ å¯†å†…å®¹å¿…é¡»æ˜¯16çš„å€æ•° # ç”±äºåŠ å¯†ç»“æœæ˜¯ä¸èƒ½ç›´æ¥è½¬ä¸ºå­—ç¬¦ä¸²çš„ï¼Œéœ€è¦å…ˆè½¬åŒ–ä¸ºbase64æ‰è¡Œï¼Œç„¶åå†è½¬åŒ–ä¸ºå­—ç¬¦ä¸² return str(b64encode(bs), \"utf-8\") def to_16(data): pam = 16 - len(data) % 16 data += chr(pam) * pam return data # è¿›è¡ŒåŠ å¯†è¿‡ç¨‹ \"\"\" function a(a = 16) { # éšæœºäº§ç”Ÿ16ä½éšæœºç  var d, e, b = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\", c = \"\"; for (d = 0; a \u003e d; d += 1) # éšæœº16æ¬¡ e = Math.random() * b.length, # éšæœºæ•° e = Math.floor(e), # å–æ•´ c += b.charAt(e); # å»å­—ç¬¦ä¸²ä¸­çš„xxxä½ç½® b return c } function b(a, b) { var c = CryptoJS.enc.Utf8.parse(b) , d = CryptoJS.enc.Utf8.parse(\"0102030405060708\") , e = CryptoJS.enc.Utf8.parse(a) , f = CryptoJS.AES.encrypt(e, c, { # AESç®—æ³• eåŸæ–‡ï¼Œcæ˜¯å¯†é’¥ iv: d, # åç§»é‡ mode: CryptoJS.mode.CBC # æ¨¡å¼ï¼šCBC }); return f.toString() } function c(a, b, c) { var d, e; return setMaxDigits(131), d = new RSAKeyPair(b,\"\",c), e = encryptedString(d, a) } function d(d, e, f, g) { # d:data, e:'010001', f:å¾ˆé•¿, g:'0CoJUm6Qyw8W8jud' var h = {} # è®¾ç½®ä¸€ä¸ªç©ºå¯¹è±¡ , i = a(16); # iå°±æ˜¯ä¸€ä¸ªéšæœºå€¼ return h.encText = b(d, g), # g å½“ä½œå¯†é’¥ h.encText = b(h.encText, i), # è¿”å›çš„å°±æ˜¯params h.encSecKey = c(i, e, f), # è¿”å›çš„å°±æ˜¯encSecKey å…¶ä¸­eã€féƒ½æ˜¯å®šæ­»çš„ï¼Œåªæœ‰iæ˜¯å˜é‡ï¼Œè‹¥å›ºå®šiï¼Œåˆ™å¾—åˆ°çš„keyä¸€å®šæ˜¯å›ºå®šçš„ h } function e(a, b, d, e) { var f = {}; return f.encText = c(a + e, b, d), f } \"\"\" def get_comments(url, song_id, page_num): rid = \"R_SO_4_\" + song_id threadId = \"R_SO_4_\" + song_id data = { \"cursor\": \"-1\", # è¿™ä¸ªå’ŒpaperNoå…±åŒå†³å®šå“ªä¸€é¡µçš„è¯„è®º1610629253639 1621187632097 \"offset\": page_num * 20 % 200, # ä»£è¡¨æœ€æ–°è¯„è®ºçš„é¡µæ•° \"orderType\": \"1\", \"pageNo\": page_num + 1, # ä»£è¡¨çƒ­è¯„çš„é¡µæ•° \"pageSize\": \"20\", \"rid\": rid, \"threadId\": threadId, } resp = requests.post(url, data={ \"params\": get_params(json.dumps(data)), \"encSecKey\": get_encSecKey() }) source = resp.json()[\"data\"] # print(source) if source[\"hotComments\"] != None and page_num == 0: print(\"=====hotComments=====\") for hot_comment in source[\"hotComments\"]: print(hot_comment[\"user\"][\"nickname\"], \":\", hot_comment[\"content\"], \"\\ntime:\", hot_comment[\"timeStr\"], \"ç‚¹èµæ•°:\", hot_comment[\"likedCount\"]) print(\"-\"*10) elif source[\"comments\"] != None: print(\"=====latestComments=====\") for latest_comment in source[\"comments\"]: print(latest_comment[\"u","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:3:4","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"å››ã€åŠ é€Ÿ è¿›ç¨‹æ˜¯ä¸€ä¸ªèµ„æºå•ä½ï¼Œçº¿ç¨‹æ˜¯ä¸€ä¸ªæ‰§è¡Œå•ä½ eg: xxxè¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼›ä¸€ä¸ªé¡¹ç›®ç»„ï¼ˆè¿›ç¨‹ï¼‰åŒ…å«å¤šä¸ªå·¥ä½œäººå‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼› ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.1 å¤šçº¿ç¨‹ # å¤šçº¿ç¨‹ from threading import Thread class MyThread(Thread): def run(self): # å›ºå®šçš„ï¼Œ -\u003e å½“çº¿ç¨‹è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œè¢«æ‰§è¡Œçš„å°±æ˜¯run() for i in range(1000): print(\"å­çº¿ç¨‹: \", i) if __name__ == \"__main__\": t = MyThread() # t.run() # è¿™ç§æ–¹æ³•æ˜¯è°ƒç”¨æ–¹æ³•ï¼Œä¾ç„¶æ˜¯å•çº¿ç¨‹ t.start() # å¼€å¯çº¿ç¨‹ï¼Œçº¿ç¨‹æ­¤æ—¶å¯ä»¥å¼€å§‹å·¥ä½œï¼Œä½†ä¸å¿…é¡»ï¼Œå…·ä½“æ‰§è¡Œæ—¶é—´ç”±CPUå†³å®š for i in range(1000): print(\"ä¸»çº¿ç¨‹:\", i) # =========é‡å‘½å========= class MyThread(Thread): def __init__(self, name): Thread.__init__(self, name=name) def run(self): # å›ºå®šçš„ï¼Œ -\u003e å½“çº¿ç¨‹è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œè¢«æ‰§è¡Œçš„å°±æ˜¯run() for i in range(1000): print(self.getName(), i) time.sleep(1) if __name__ == \"__main__\": t1 = MyThread(\"wlh\") # t.run() # è¿™ç§æ–¹æ³•æ˜¯è°ƒç”¨æ–¹æ³•ï¼Œä¾ç„¶æ˜¯å•çº¿ç¨‹ t1.start() # å¼€å¯çº¿ç¨‹ï¼Œçº¿ç¨‹æ­¤æ—¶å¯ä»¥å¼€å§‹å·¥ä½œï¼Œä½†ä¸å¿…é¡»ï¼Œå…·ä½“æ‰§è¡Œæ—¶é—´ç”±CPUå†³å®š t2 = MyThread(\"zjl\") # t.run() # è¿™ç§æ–¹æ³•æ˜¯è°ƒç”¨æ–¹æ³•ï¼Œä¾ç„¶æ˜¯å•çº¿ç¨‹ t2.start() # å¼€å¯çº¿ç¨‹ï¼Œçº¿ç¨‹æ­¤æ—¶å¯ä»¥å¼€å§‹å·¥ä½œï¼Œä½†ä¸å¿…é¡»ï¼Œå…·ä½“æ‰§è¡Œæ—¶é—´ç”±CPUå†³å®š # # for i in range(1000): # print(\"ä¸»çº¿ç¨‹:\", i) ç”±äºä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå…±åŒè¾“å‡ºåœ¨å·¥ä½œå°ï¼Œæ‰€ä»¥ä¼šé€ æˆå›¾ä¸­çš„æƒ…å†µï¼š ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.2 å¤šè¿›ç¨‹ import time from multiprocessing import Process def func(): for i in range(1000): print(\"å­è¿›ç¨‹:\", i) time.sleep(1) if __name__ == '__main__': p = Process(target=func) p.start() for i in range(1000): print(\"ä¸»è¿›ç¨‹:\", i) time.sleep(1) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:2","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.3 çº¿ç¨‹æ± \\è¿›ç¨‹æ±  çº¿ç¨‹æ± ï¼šä¸€æ¬¡æ€§å¼€è¾Ÿä¸€äº›çº¿ç¨‹ï¼Œç”¨æˆ·ç›´æ¥ç»™çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œçº¿ç¨‹çš„ä»»åŠ¡è°ƒåº¦äº¤ç»™çº¿ç¨‹æ± å®Œæˆ åˆ›å»ºçº¿ç¨‹æ± ï¼š from concurrent.futures import ThreadPoolExecutor with ThreadPoolExecutor(num) as t: t.submit() # çº¿ç¨‹æ± å¤–çš„å«åšå®ˆæŠ¤ï¼Œéœ€è¦ç­‰å¾…çº¿ç¨‹æ± å†…çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ å¦‚ä½•æå–å•ä¸ªé¡µé¢ çš„æ•°æ® åˆ©ç”¨çº¿ç¨‹æ± ï¼Œè¿›è¡Œå¤šä¸ªé¡µé¢åŒæ—¶æŠ“å– åŒ—äº¬æ–°å‘åœ°ä¸¾ä¾‹ï¼š import requests import csv from concurrent.futures import ThreadPoolExecutor f = open(\"xfd_list.csv\", mode=\"w\", encoding=\"utf-8\", newline='') # newline æ˜¯ä¸ºäº†è¿‡æ»¤æ‰æ¢è¡Œç¬¦ csv_writer = csv.writer(f) def download_one_page(url, page_num): data = { \"current\": page_num } html_page_json = requests.post(url, data=data).json() price_list = html_page_json['list'] for item in price_list: # print(item) # txt = [0 for _ in range(7)] txt = [None] * 7 txt[0] = item['prodName'] txt[1] = item['lowPrice'] txt[2] = item['highPrice'] txt[3] = item['avgPrice'] txt[4] = item['place'] txt[5] = item['unitInfo'] txt[6] = item['pubDate'] # txt.append(item['prodName']) # txt.append(item['lowPrice']) # txt.append(item['highPrice']) # txt.append(item['avgPrice']) # txt.append(item['place']) # txt.append(item['unitInfo']) # txt.append(item['pubDate']) # print(info) csv_writer.writerow(txt) print(page_num, \"æå–å®Œæ¯•ï¼ï¼ï¼\") if __name__ == '__main__': with ThreadPoolExecutor(30) as f: # å¼€å¤šäº†æœ‰å¯èƒ½å‡ºæ ¼å¼é—®é¢˜ for num in range(1, 200): f.submit(download_one_page, \"http://www.xinfadi.com.cn/getPriceData.html\", num) print(\"å…¨éƒ¨ä¸‹è½½å®Œæ¯•!!!\") # for num in range(1, 200): # download_one_page(\"http://www.xinfadi.com.cn/getPriceData.html\", num) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:3","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.4 åç¨‹ è¦è¾¾åˆ°å¼‚æ­¥æ•ˆæœï¼Œéœ€è¦å°†åŒæ­¥æ“ä½œå†™ä¸ºåç¨‹æ“ä½œï¼š ï¼ˆåŒæ­¥æ“ä½œï¼‰ ï¼ˆå¼‚æ­¥æ“ä½œï¼‰ pythonä¸å¤ªå¸Œæœ›ä¸Šè¿°å†™æ³•ï¼Œå› ä¸ºä¸»è¿›ç¨‹é‡Œçº¿ç¨‹è¿‡å¤šï¼Œå»ºè®®ä¸‹è¿°å†™æ³•ï¼š # pythonä¸å¸Œæœ›ä¸Šé¢é‚£ç§å†™æ³•ï¼Œå› ä¸ºä¸»è¿›ç¨‹çš„çº¿ç¨‹è¿‡å¤š async def func1(): print(\"ä½ å¥½ï¼æˆ‘æ˜¯æé›ªç´ï¼\") await asyncio.sleep(3) # å°†å¼‚æ­¥æ“ä½œæŒ‚èµ· print(\"ä½ å¥½ï¼æˆ‘æ˜¯æé›ªç´ï¼\") async def func2(): print(\"ä½ å¥½ï¼æˆ‘æ˜¯ç‹å»ºå›½ï¼\") await asyncio.sleep(2) # å°†å¼‚æ­¥æ“ä½œæŒ‚èµ· print(\"ä½ å¥½ï¼æˆ‘æ˜¯ç‹å»ºå›½ï¼\") async def func3(): print(\"ä½ å¥½ï¼æˆ‘æ˜¯é»æ˜ï¼\") await asyncio.sleep(4) # å°†å¼‚æ­¥æ“ä½œæŒ‚èµ· print(\"ä½ å¥½ï¼æˆ‘æ˜¯é»æ˜ï¼\") async def main(): # ç¬¬ä¸€ç§å†™æ³• # f1 = func1() # await f1 # ä¸€èˆ¬waitæŒ‚èµ·æ“ä½œæ”¾åœ¨åç¨‹å¯¹è±¡å‰é¢ # ç¬¬äºŒç§å†™æ³•ï¼ˆæ¨èï¼‰ # ä¸€æ¬¡æ€§å¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼ˆåç¨‹ï¼‰ tasks = { asyncio.create_task(func1()), # åˆ›å»ºæˆtaskå¯¹è±¡ asyncio.create_task(func2()), asyncio.create_task(func3()) } await asyncio.wait(tasks) # æŒ‚èµ· if __name__ == '__main__': t1 = time.time() asyncio.run(main()) t2 = time.time() print(t2 - t1) æ¨¡æ‹Ÿçˆ¬è™«åº”ç”¨ï¼š # æ¨¡æ‹Ÿçˆ¬è™«åº”ç”¨ async def download(url): print(url, \"å‡†å¤‡å¼€å§‹ä¸‹è½½\") await asyncio.sleep(2) # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚ å®é™…ä¸­ åªéœ€åœ¨æ­¤å¤„å°†çˆ¬è™«ç½‘ç»œè¯·æ±‚è¯­å¥å†™ä¸ºåç¨‹å½¢å¼å³å¯ print(url, \"ä¸‹è½½å®Œæ¯•\") async def main(urls): tasks = [] for url in urls: tasks.append(download(url)) # tasks = [asyncio.create_task(download(url)) for url in urls] # è¿™æ ·ä¹Ÿå¯ä»¥ æ•ˆæœä¸€æ ·çš„ æ›´åŠ ç®€æ´ await asyncio.wait(tasks) if __name__ == '__main__': urls = { \"https://www.google.com/webhp\", \"https://www.baidu.com/\", \"https://www.bilibili.com/\" } asyncio.run(main(urls)) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:4","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.5 aiohttpæ¨¡å—åº”ç”¨ requests.get() åŒæ­¥çš„ä»£ç  â€”\u003e å¼‚æ­¥æ“ä½œaiohttp conda install aiohttp import aiohttp # aiohttp.ClientSession() \u003c==\u003e requests å‡ ä¹ä¸€æ¨¡ä¸€æ · async def download(url): name = url.rsplit('/', 1)[1] # ä»å³è¾¹åˆ‡ç‰‡ï¼Œåˆ‡ä¸€æ¬¡ï¼Œå–ç¬¬äºŒä¸ªå…ƒç´  async with aiohttp.ClientSession() as Session: # Sessionç°åœ¨ç›¸å½“äºrequests async with Session.get(url) as resp: # resp = requests.get(url) with open(name, mode='wb') as f: # å½“è¯·æ±‚è¿”å›ï¼Œå°±å¯ä»¥å¼€å§‹å†™å…¥æ–‡ä»¶ æ­¤å¤„å¯ä»¥å»¶ç”³ aiofiles å¼‚æ­¥å†™å…¥æ–‡ä»¶ f.write(await resp.content.read()) # è¯»å–å†…å®¹æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤éœ€è¦awaitæŒ‚èµ· print(name, \"ä¸‹è½½å®Œæ¯•ï¼\") async def main(urls): tasks = [asyncio.create_task(download(url)) for url in urls] await asyncio.wait(tasks) if __name__ == '__main__': urls = { \"https://img.syt5.com/2021/0907/20210907082121262.jpg\", \"https://img.syt5.com/2021/0907/20210907082121629.jpg\", \"https://img.syt5.com/2021/0907/20210907082121801.jpg\" } # asyncio.run(main(urls)) # ä¼šæŠ¥é”™ï¼ŒRuntimeError: Event loop is closed æ”¹ä¸ºå¦‚ä¸‹ï¼š loop = asyncio.get_event_loop() loop.run_until_complete(main(urls)) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:5","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.6 æŠ“å–å°è¯´ import requests import asyncio import aiohttp import aiofiles import json # æ‰€éœ€ç½‘å€ # http://dushu.baidu.com/api/pc/getCatalog?data={\"book_id\":\"4306063500\"} # å°è¯´ç« èŠ‚ # http://dushu.baidu.com/api/pc/getChapterContent?data={\"book_id\":\"4306063500\",\"cid\":\"4306063500|1569782244\",\"need_bookinfo\":1} # å°è¯´ç« èŠ‚å†…å®¹ async def get_catalog(url): resp = requests.get(url) dict = resp.json() book_id = dict['data']['novel']['book_id'] tasks = [] for item in dict['data']['novel']['items']: title = item['title'] cid = item['cid'] # æ­¤å¤„å¯ä»¥å¼€å§‹è¿›è¡Œè·å–å°è¯´å†…å®¹ # å‡†å¤‡å¼‚æ­¥ä»»åŠ¡ tasks.append(get_content(book_id, title, cid)) # å¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ await asyncio.wait(tasks) print(\"ä¸‹è½½å®Œæ¯•ï¼ï¼ï¼\") async def get_content(book_id, title, cid): data = { \"book_id\": book_id, \"cid\": f\"{book_id}|{cid}\", \"need_bookinfo\": 1 } data = json.dumps(data) url = f'http://dushu.baidu.com/api/pc/getChapterContent?data={data}' async with aiohttp.ClientSession() as session: async with session.get(url) as resp: dict = await resp.json() # å¼‚æ­¥å†™å…¥ aiofiles async with aiofiles.open('è¥¿æ¸¸è®°/' + title + '.txt', mode='w', encoding='utf-8') as f: await f.write(dict['data']['novel']['content']) if __name__ == '__main__': book_id = '4306063500' url = 'http://dushu.baidu.com/api/pc/getCatalog?data={\"book_id\":\"' + book_id + '\"}' # print(url) asyncio.run(get_catalog(url)) æ–°å»ºæ–‡æ¡£ï¼š ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:6","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"4.7 è§†é¢‘æŠ“å– é¦–å…ˆï¼Œè§†é¢‘ä¸å¯èƒ½ç›´æ¥åŠ è½½åˆ°é¡µé¢ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´ç½‘é¡µé€Ÿåº¦ææ…¢â€¦â€¦ä¸å¯èƒ½ä¸€æ¬¡æ€§åŠ è½½å®Œæ¯•ï¼ï¼ï¼ é‚£è§†é¢‘ç½‘ç«™ä¸€èˆ¬æ€ä¹ˆåšå‘¢ï¼Ÿï¼Ÿï¼Ÿ ç­”ï¼šç”¨æˆ·ä¸Šä¼  â€“\u003e è½¬ç ï¼ˆæŠŠè§†é¢‘åšå¤„ç†ï¼Œ2kï¼Œ1080ï¼Œæ ‡æ¸…ï¼‰ â€“\u003e åˆ‡ç‰‡å¤„ç†ï¼ˆæŠŠå•ä¸ªçš„æ–‡ä»¶è¿›è¡Œæ‹†åˆ†ï¼‰ éœ€è¦ä¸€ä¸ªæ–‡ä»¶è®°å½•ï¼š1. è§†é¢‘æ’­æ”¾é¡ºåºï¼Œ2. è§†é¢‘å­˜æ”¾è·¯å¾„ã€‚ M3U8 txt json ==\u003e æ–‡æœ¬ æƒ³è¦æŠ“å–ä¸€ä¸ªè§†é¢‘ï¼š æ‰¾åˆ°m3u8æ–‡ä»¶ï¼ˆå„ç§æ‰‹æ®µï¼‰ é€šè¿‡m3u8ä¸‹è½½åˆ°tsæ–‡ä»¶ å¯ä»¥é€šè¿‡å„ç§æ‰‹æ®µï¼ˆä¸ä»…æ˜¯ç¼–ç¨‹æ‰‹æ®µï¼‰ æŠŠtsæ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªmp4æ–‡ä»¶ 4.7.1 ç®€å•éš¾åº¦ æµç¨‹ï¼š é’ˆå¯¹é¡µé¢æºä»£ç ä¸­å«æœ‰m3u8çš„è§†é¢‘ï¼Œé‡‡ç”¨ä»¥ä¸‹æ–¹æ³•æŠ“å–åˆ°m3u8æ–‡ä»¶ï¼š if __name__ == '__main__': url = 'https://91kju.com/vod-play-id-1039-sid-1-pid-1.html' headers = { \"user-agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\", \"origin\": \"https://91kju.com\" } resp = requests.get(url, headers=headers) # obj = re.compile(r\"\\\"url\\\":(?P\u003curl\u003e.*?),\", re.S) # æ³¨æ„ï¼ï¼ï¼è¿™æ ·æå–å‡ºæ¥çš„ç½‘å€æ˜¯å¸¦å¼•å·çš„ï¼å¿…ç„¶æ˜¯æ— æ³•è®¿é—®çš„ï¼Œè¦æå–ä¸å¸¦å¼•å·çš„ç½‘å€ï¼ï¼ï¼ obj = re.compile(r\"\\\"url\\\":\\\"(?P\u003curl\u003e.*?)\\\",\", re.S) # æ­¤å¤„ä¸€å®šè¦æ³¨æ„ï¼ï¼ï¼ # print(resp.text) m3u8_url = obj.search(resp.text).group('url').replace('\\\\', '') # print(m3u8_url) # ä¸‹è½½m3u8æ–‡ä»¶ path = m3u8_url.rsplit('/', 1)[1] resp.close() headers = { \"user-agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36\", \"origin\": \"https://91kju.com\", \"path\": f\"/{path}\", \"authority\": \"m3api.awenhao.com\" } resp2 = requests.get(m3u8_url) with open(\"ç«æ˜Ÿæ•‘æ´.m3u8\", mode='wb') as f: f.write(resp2.content) print('m3u8ä¸‹è½½å®Œæ¯•ï¼') f.close() resp2.close() æ‹¿åˆ°m3u8æ–‡ä»¶åæ‰å¯ä»¥å¼€å§‹ä¸‹è½½è§†é¢‘ å›¾ä¸­çº¢æ¡†ç¤ºä¾‹éƒ¨åˆ†å°±æ˜¯è§†é¢‘èµ„æºçš„é“¾æ¥ï¼Œå¯ä»¥ä»å…¶ä¸­ä¸‹è½½è§†é¢‘ç‰‡æ®µ ä¸‹è½½è§†é¢‘ç‰‡æ®µ # æ‹¿åˆ°m3u8åï¼Œå°±å¯ä»¥å¼€å§‹ä¸‹è½½è§†é¢‘äº† num = 1 with open(\"ç«æ˜Ÿæ•‘æ´.m3u8\", mode='r', encoding='utf-8') as f: for line in f: line = line.strip() # å»æ‰ç©ºæ ¼ï¼Œç©ºç™½ï¼Œæ¢è¡Œç¬¦ if line.startswith('#'): # è‹¥è¡Œå¼€å¤´ä¸º # , ä¸è¦ continue # print(line) with open(f\"video/{num}.mp4\", mode='wb') as f: resp = requests.get(line) f.write(resp.content) f.close() resp.close() num += 1 print(f\"ç‰‡æ®µ{num}ä¸‹è½½å®Œæ¯•ï¼ï¼ï¼\") æœ€åéœ€è¦è½¯ä»¶å°†è§†é¢‘ç‰‡æ®µåˆæˆä¸ºå®Œæ•´çš„è§†é¢‘ 4.7.2 å¤æ‚91 æ€è·¯ï¼š æ‹¿åˆ°ä¸»é¡µé¢çš„é¡µé¢æºä»£ç ï¼Œæ‰¾åˆ°iframe ä»iframeçš„é¡µé¢æºä»£ç ä¸­æ‹¿åˆ°m3u8æ–‡ä»¶ ä¸‹è½½ç¬¬ä¸€å±‚m3u8æ–‡ä»¶ â€“\u003e ä¸‹è½½ç¬¬äºŒå±‚m3u8æ–‡ä»¶ï¼ˆè§†é¢‘å­˜æ”¾è·¯å¾„ï¼‰ ä¸‹è½½è§†é¢‘ ä¸‹è½½å¯†é’¥ï¼Œè¿›è¡Œè§£å¯†æ“ä½œ å°†ç‰‡æ®µåˆæˆè§†é¢‘ æš‚æœªå®æ–½ å¼‚æ­¥ä¸‹è½½è§†é¢‘ï¼š def get_m3u8(url): resp = requests.get(url) page_code = resp.text # print(resp.text) # å–m3u8çš„url obj = re.compile(r'\"url\":\"(?P\u003cm3u8_url\u003e.*?)\",\"', re.S) m3u8_url = obj.search(page_code).group('m3u8_url').replace('\\\\', '') # print(m3u8_url) m3u8 = requests.get(m3u8_url).content # print(m3u8) # å–title page_bs = BeautifulSoup(page_code, \"html.parser\") obj = re.compile(r'ã€Š(?P\u003ctitle\u003e.*?)ã€‹', re.S) title = obj.search(page_bs.find('title').text).group('title') # print(title.text) with open(f'{title}.m3u8', mode='wb') as f: f.write(m3u8) print(f'{title}.m3u8 ä¸‹è½½å®Œæ¯•ï¼') return f'{title}.m3u8' # # # æ‹¿åˆ°m3u8åï¼Œå°±å¯ä»¥å¼€å§‹ä¸‹è½½è§†é¢‘äº† å¼‚æ­¥ async def dowaload(url, name, session): async with session.get(url) as resp: async with aiofiles.open(f\"video/{name}\", mode='wb') as f: await f.write(await resp.content.read()) # å¼‚æ­¥æŠŠä¸‹è½½çš„è§†é¢‘ç‰‡æ®µå†™å…¥æ–‡ä»¶ print(f'{name}ä¸‹è½½å®Œæ¯•ï¼') # # async def aio_download(url): tasks = [] m3u8= get_m3u8(url) # åœ¨æ­¤å¤„åˆ›å»ºsessionæ¯”åœ¨downloadé‡Œé¢åˆ›å»ºsessionå¥½ï¼Œå› ä¸ºåªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œè‹¥æ˜¯åœ¨downloadä¸­åˆ›å»ºsessionï¼Œåˆ™æ¯ä¸ªäººç‰©éƒ½éœ€è¦é‡æ–°åˆ›å»ºsession async with aiohttp.ClientSession() as Session: # async with aiofiles.open(m3u8, mode='r', encoding='utf-8') as f: async with aiofiles.open(m3u8, mode='r', encoding='utf-8') as f: # ä¸ºäº†å¼‚æ­¥ä¹Ÿå¯ä»¥æŒ‰é¡ºåºæ’åˆ—è§†é¢‘ç‰‡æ®µï¼Œå¯ä»¥ä½¿ç”¨ç‰‡æ®µæ‰€åœ¨çš„è¡Œå·è¿›è¡Œå‘½å # for num, line in enumerate(f, 1): async for line in f: line = line.strip() if line.startswith('#'): continue else: # print(line) num = time.time() # print(num) name = f'{num}.mp4' # print(name, line) task = asyncio.create_task(dowaload(line, name, Session)) tasks.append(task) await asyncio.wait(tasks) # æ­¤å¤„ä¸èƒ½å¾€å‰æ‹‰ï¼Œåªèƒ½å†™åœ¨forå¾ªç¯å print(f'{name}ä¸‹è½½å®Œæ¯•ï¼ï¼ï¼') if __name__ == '__main__': url = 'https://91kju.com/vod-play-id-61412-sid-1-pid-1.html' # # get_m3u8(url) loop = asyncio.get_event_loop() loop.run_until_complete(aio_download(url)) print('æå®šï¼') ä½†å…¶å®è¿™ä¸ªæ–¹æ¡ˆæ— æ³•æŒ‰ç…§ç‰‡æ®µé¡ºåºä¸‹è½½ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°è¡Œå·ä»¥ä¾¿è¿›è¡Œæ’åºï¼Œå¹¶ä¸”ï¼ï¼ï¼è¡Œ38å’Œ41æ ¹æœ¬ä¸ç”¨å¼‚æ­¥å§ï¼Ÿï¼Ÿï¼Ÿæ•ˆæœæ ¹æœ¬æ²¡æœ‰å·®åˆ«ï¼ï¼ï¼å¯ä»¥ç”¨ä»¥ä¸‹å‡½æ•°è¿›è¡Œä¸‹è½½ï¼š async def aio_download(url): tasks = [] m3u8= get_m3u8(url) # åœ¨æ­¤å¤„åˆ›å»ºsessionæ¯”åœ¨downloadé‡Œé¢åˆ›å»ºsessionå¥½ï¼Œå› ä¸ºåªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œè‹¥æ˜¯åœ¨downloadä¸­åˆ›å»ºsessionï¼Œåˆ™æ¯ä¸ªäººç‰©éƒ½éœ€è¦é‡æ–°åˆ›å»ºsession async with aiohttp.ClientSession() as Session: # async with aiofiles.open(m3u8, mode='r', encoding='utf-8') as f: with open(m3u8, mode='r', encoding='utf-8') as f: # ä¸ºäº†å¼‚æ­¥ä¹Ÿå¯ä»¥æŒ‰é¡ºåºæ’åˆ—è§†é¢‘ç‰‡æ®µï¼Œå¯","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:4:7","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"äº”ã€selenium ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"5.1 æ¦‚è¿° é—®é¢˜ï¼š èƒ½ä¸èƒ½è®©æˆ‘çš„ç¨‹åºè¿æ¥åˆ°æµè§ˆå™¨ï¼Œè®©æµè§ˆå™¨é‡Œæ¥å®Œæˆå„ç§å¤æ‚çš„æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦æ¥å—æœ€åçš„ç»“æœ seleniumï¼š è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œç„¶ååƒäººä¸€æ ·å»æ“ä½œæµè§ˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥ä»seleniumä¸­ç›´æ¥æå–ç½‘é¡µä¸Šçš„å„ç§ä¿¡æ¯ ç¯å¢ƒæ­å»ºï¼š conda install selenium ä¸‹è½½æµè§ˆå™¨é©±åŠ¨ï¼šhttps://chromedriver.storage.googleapis.com/index.html â€‹ æŠŠè§£å‹ç¼©çš„æµè§ˆå™¨é©±åŠ¨ chromedriver æ”¾åœ¨pythonè§£é‡Šå™¨æ‰€åœ¨çš„æ–‡ä»¶å¤¹ è®©seleniumå¯åŠ¨è°·æ­Œæµè§ˆå™¨ï¼ï¼ï¼ æŸ¥æ‰¾æµè§ˆå™¨çš„ç‰ˆæœ¬å·ï¼š å»ç»™çš„ç½‘ç«™é‡Œæ‰¾å¯¹åº”çš„ç‰ˆæœ¬å·ï¼š æŠŠè§£å‹ç¼©çš„æµè§ˆå™¨é©±åŠ¨ chromedriver æ”¾åœ¨pythonè§£é‡Šå™¨æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œpythonè§£é‡Šå™¨çš„è·¯å¾„å¦‚ä¸‹ï¼š ç²˜è´´è¿›å»ï¼š è®©seleniumå¯åŠ¨æµè§ˆå™¨ï¼š from selenium.webdriver import Chrome # 1. åˆ›å»ºæµè§ˆå™¨å¯¹è±¡ web = Chrome() # 2. æ‰“å¼€ä¸€ä¸ªç½‘å€ web.get(\"https://www.baidu.com\") æ¡ˆä¾‹ï¼ŒæŠ“å–æ‹‰å‹¾ç½‘ä¿¡æ¯ï¼š è¦æ³¨æ„çš„æ˜¯ï¼ï¼ï¼ä¸€å®šè¦åŠ ç­‰å¾…æ—¶é—´ï¼Œå¦åˆ™æœ‰å¯èƒ½å‘ç”Ÿ æœªåŠ è½½å®Œå°±ç‚¹å‡»ï¼ˆæˆ–è€…æ‹‰å–ä¿¡æ¯ï¼‰å¯¼è‡´å¤±è´¥ï¼ˆæˆ–ä¿¡æ¯ä¸å…¨ï¼‰ï¼ï¼ï¼ web.implicitly_wait(30) # ï¼ˆæ™ºèƒ½ï¼‰éšå¼ç­‰å¾…ï¼Œ5ç§’å†…åŠ è½½å®Œå°±ç›´æ¥æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œè‹¥è¶…è¿‡5ç§’ï¼ŒæŠ¥é”™ # WebDriverWait(ä½ çš„chrome()å¯¹è±¡, maxWaitTime(s), checkInterval(s)) # åé¢çš„ .untilçš„æ„æ€æ˜¯ ç›´åˆ°æ‹¬å·å†…çš„lambdaè¡¨è¾¾å¼æˆç«‹ï¼Œä¾‹å¦‚æ­¤å¤„lambdaçš„æ„æ€å°±æ˜¯ï¼šåŠ è½½å‡ºnameä¸º'DZ_JSDTCJTW'çš„elementã€‚ # æ•´è¡Œå®Œæ•´æ„æ€å°±æ˜¯ï¼šæ¯è¿‡0.2så°±æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦åŠ è½½å‡ºåä¸º'DZ_JSDTCJTW'çš„å…ƒç´ ï¼Œè‹¥åŠ è½½å‡ºï¼Œå°±æ‰§è¡Œä¸‹ä¸€è¡Œï¼Œè‹¥è¿˜æ— ï¼Œæœ€é•¿ç­‰å¾…10sã€‚ WebDriverWait(driver, 10, 0.2).until(lambda x: x.find_element_by_name('DZ_JSDTCJTW')) driver.find_element_by_name('DZ_JSDTCJTW').send_keys(self.random_temp()) import time from selenium.webdriver import Chrome from selenium.webdriver.common.keys import Keys web = Chrome() web.get(\"https://lagou.com\") # æ‰¾åˆ°æŸä¸ªå…ƒç´ ï¼Œç‚¹å‡»å®ƒ el = web.find_element_by_xpath('//*[@id=\"changeCityBox\"]/p[1]/a') el.click() # ç‚¹å‡»äº‹ä»¶ web.implicitly_wait(30) # ï¼ˆæ™ºèƒ½ï¼‰éšå¼ç­‰å¾…ï¼Œ5ç§’å†…åŠ è½½å®Œå°±ç›´æ¥æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œè‹¥è¶…è¿‡5ç§’ï¼ŒæŠ¥é”™ # åœ¨æœç´¢æ¡†ä¸­ æœç´¢python el = web.find_element_by_xpath('//*[@id=\"search_input\"]').send_keys(\"python\", Keys.ENTER) # æ‰¾åˆ°è¾“å…¥æ¡† è¾“å…¥pythonå¹¶å›è½¦ web.implicitly_wait(30) # é˜²æ­¢æœªåŠ è½½å®Œï¼Œå¯¼è‡´è¾“å‡ºä¸å…¨ *****å¾ˆé‡è¦ï¼ï¼ï¼ # æ‰¾åˆ°ä¿¡æ¯æ‰€åœ¨ä½ç½® elements æ˜¯æ‰¾åˆ°æ‰€æœ‰çš„ job_list = web.find_elements_by_xpath('//*[@id=\"jobList\"]/div[1]/div') for item in job_list: # job_name = item.find_element_by_tag_name(\"a\").text # æŸ¥æ‰¾ itemä¸­ aæ ‡ç­¾çš„å€¼ # print(job_name) job_name = item.find_element_by_xpath('./div/div/div/a').text job_price = item.find_element_by_xpath('./div/div/div[2]/span').text # ./ ç›¸å¯¹è·¯å¾„ job_company = item.find_element_by_xpath('./div/div[2]/div/a').text print(job_name, job_price, job_company) è·å–æ ‡ç­¾å†…å…ƒç´ çš„å€¼ï¼š detail1 = web.find_element_by_xpath('//*[@id=\"zpid_19506994\"]/div[2]/a') print(detail1.get_attribute('href'), detail1.get_attribute('class')) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"5.2 çª—å£åˆ‡æ¢ å¦‚ä½•è¿›å…¥åˆ°æ–°çª—å£ä¸­è¿›è¡Œæå– æ³¨æ„ï¼šåœ¨seleniumçœ¼ä¸­ï¼Œæ–°çª—å£é»˜è®¤æ˜¯ä¸åˆ‡æ¢è¿‡æ¥çš„ web.switch_to.window(web.window_handles[-1]) # -1ä»£è¡¨æœ€åä¸€ä¸ªçª—å£ï¼ˆä»å³å¾€å·¦ï¼‰ ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–çª—å£ï¼ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:2","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"5.3 æ— å¤´æµè§ˆå™¨ from selenium.webdriver.chrome.options import Options opt = Options() opt.add_argument(\"--headless\") opt.add_argument(\"--disable-gpu\") web = Chrome(options=opt) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:3","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"5.4 éªŒè¯ç è¯†åˆ« **è¶…çº§é¹°ï¼**æˆ– ddddocr å“ªé‡Œç”¨å°±å¾€å“ªé‡Œæ¬ï¼ 1. chaojiying # ç”¨æˆ·ä¸­å¿ƒ\u003e\u003eè½¯ä»¶ID ç”Ÿæˆä¸€ä¸ªæ›¿æ¢ 96001 chaojiying = Chaojiying_Client('15237174980', '12345678', '930009') # æœ¬åœ°å›¾ç‰‡æ–‡ä»¶è·¯å¾„ æ¥æ›¿æ¢ a.jpg æœ‰æ—¶WINç³»ç»Ÿé¡»è¦// im = open('a.jpg', 'rb').read() # imå°±æ˜¯å›¾ç‰‡çš„æ‰€æœ‰å­—èŠ‚ # 1902 éªŒè¯ç ç±»å‹ å®˜æ–¹ç½‘ç«™\u003e\u003eä»·æ ¼ä½“ç³» 3.4+ç‰ˆ print åè¦åŠ () print(chaojiying.PostPic(im, 1902)) 2. ddddocr pip install ddddocr def identifyCode(imgPath) -\u003e str: ocr = ddddocr.DdddOcr() img = open(imgPath, 'rb').read() return ocr.classification(img) # ä¸Šè¿°æ˜¯è¯»å–å›¾ç‰‡è·¯å¾„çš„æ–¹å¼ï¼Œç»“åˆseleniumä¹Ÿå¯ä»¥ img = web.find_element_by_xpath('å›¾ç‰‡çš„xpath').screenshot_as_png ocr.classification(img) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:4","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"5.5 é˜²æ­¢è‡ªåŠ¨åŒ–è¢«å±è”½ è¿™æ ·æœ‰æ—¶ä¼šè¢«å±è”½æ‰ï¼ï¼ï¼ è§£å†³æ–¹æ³•ï¼å…¶å®å’Œæ— å¤´æµè§ˆå™¨å¾ˆç›¸ä¼¼ï¼ï¼ï¼ Chromeç‰ˆæœ¬å·å¤§äº88æ—¶ï¼š from selenium.webdriver.chrome.options import Options opt = Options() opt.add_argument('--disable-blink-features=AutomationControlled') web = Chrome(option=opt) ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:5:5","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"å…­ã€Jsé€†å‘ æœ¬åœ°è¿è¡ŒJSï¼Œå¾—åˆ°å’Œæµè§ˆå™¨ä¸€æ ·çš„åŠ å¯†æ•°æ®ï¼Œå‘é€ç»™æœåŠ¡å™¨ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:6:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"6.1 æ–­ç‚¹ ç½‘ç«™ä»£ç è¿è¡Œçš„æ—¶é—´è½´ï¼š åŠ è½½html-\u003eåŠ è½½js-\u003eè¿è¡Œjsåˆå§‹åŒ–-\u003eç”¨æˆ·è§¦å‘æŸä¸ªäº‹ä»¶-\u003eè°ƒç”¨äº†æŸæ®µjs-\u003eåŠ å¯†å‡½æ•°-\u003eç»™æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼ˆXHR-\u003eSENDï¼‰-\u003e æ¥å—åˆ°æœåŠ¡å™¨çš„æ•°æ®-\u003e è§£å¯†å‡½æ•°-\u003eåˆ·æ–°ç½‘é¡µæ¸²æŸ“ åˆ†ç±»ï¼š DOMæ–­ç‚¹ï¼šå½“æ¸²æŸ“çš„æ—¶å€™ï¼ˆæ ·å­å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼‰ï¼Œæ‰æœ‰ç”¨ï¼›åœ¨åŠ å¯†è¿‡ç¨‹ä¸­ï¼Œå…¶å®æ˜¯æ¯”è¾ƒé å‰çš„æ‰§è¡Œæ­¥éª¤ï¼Œè·ç¦»åŠ å¯†å‡½æ•°æ¯”è¾ƒè¿œï¼Œæ— æ³•æ ¹æ®æ ˆå»å¿«é€Ÿå®šä½ï¼Œä¸å¤ªæ¨èç”¨DOMæ–­ç‚¹ DOMäº‹ä»¶æ–­ç‚¹ï¼šå’ŒDOMç±»ä¼¼ï¼Œå¦‚æœä¸èƒ½ç”¨DOMä¸‹æ–­ï¼Œåˆ™è€ƒè™‘ç”¨DOMäº‹ä»¶ XHRæ–­ç‚¹ï¼šæ‰§è¡Œçš„æ¯”è¾ƒé åï¼Œè·ç¦»åŠ å¯†å‡½æ•°æ¯”è¾ƒè¿‘ï¼Œå¯ä»¥æ ¹æ®æ ˆå¿«é€Ÿå®šä½ï¼ŒéXHRå‘é€çš„å°±æ— æ³•æ–­ä½ ä»£ç è¡Œæ–­ç‚¹ ä»£ç çš„æ–­ç‚¹ debugger å…¨å±€äº‹ä»¶æ–­ç‚¹ï¼ˆæµè§ˆå™¨äº‹ä»¶æ–­ç‚¹ï¼‰ å¼‚å¸¸æ•è·æ–­ç‚¹ ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:6:1","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"},{"categories":["é€šç”¨","python"],"content":"ä¸ƒã€Scrapyæ¡†æ¶ æ¡†æ¶å°±æ˜¯é›†æˆäº†å¾ˆå¤šåŠŸèƒ½å¹¶ä¸”å…·æœ‰å¾ˆå¼ºé€šç”¨æ€§çš„ä¸€ä¸ªé¡¹ç›®æ¨¡æ¿ï¼Œå­¦ä¹ æ¡†æ¶å°è£…çš„å„ç§åŠŸèƒ½çš„è¯¦ç»†ç”¨æ³•ã€‚ Scrapyæ˜¯çˆ¬è™«ä¸­å°è£…å¥½çš„ä¸€ä¸ªæ˜æ˜Ÿæ¡†æ¶ï¼ŒåŠŸèƒ½ï¼šé«˜æ€§èƒ½çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå¼‚æ­¥æ•°æ®ä¸‹è½½ï¼Œé«˜æ€§èƒ½çš„æ•°æ®è§£æï¼Œåˆ†å¸ƒå¼ åŸºæœ¬ä½¿ç”¨ï¼š å®‰è£…ç¯å¢ƒï¼š conda install wheel ä¸‹è½½twistedï¼Œä¸‹è½½åœ°å€ä¸ºï¼šhttp://www.lfd.uci.edu/~gohlke/pythonlibs/#twisted å®‰è£…twistedï¼šconda install Twisted-... conda install pywin32 conda install scrapy pythonç”Ÿæˆexeæ–‡ä»¶ Pyinstaller -F setup.py æ‰“åŒ…exe Pyinstaller -F -w setup.py ä¸å¸¦æ§åˆ¶å°çš„æ‰“åŒ… Pyinstaller -F -i xx.ico setup.py æ‰“åŒ…æŒ‡å®šexeå›¾æ ‡æ‰“åŒ… git bash ä½¿ç”¨condaåˆ‡æ¢ç¯å¢ƒ å°†anacondaçš„å›¾ç¤ºçš„å‡ ä¸ªè·¯å¾„æ·»åŠ è¿›å» åˆ›å»ºç¯å¢ƒ conda create -n your_env_name python=3.7 åˆ é™¤ç¯å¢ƒ conda remove -n your_env_name --all æ¿€æ´»è‡ªå®šä¹‰çš„ç¯å¢ƒ source activate your_env_name é€€å‡ºç¯å¢ƒ source deactivate conda deactivate//æˆ–è€…è¿™æ · åˆ—å‡ºæ‰€æœ‰çš„ç¯å¢ƒ conda env list conda info --envs//æˆ–è€…è¿™æ · condaå®‰è£…åŒ…å’Œå¸è½½åŒ… conda install x //å®‰è£…xåŒ… conda uninstall x //å¸è½½xåŒ… ","date":"2022-07-18","objectID":"/%E7%88%AC%E8%99%AB/:7:0","tags":["è®¡ç®—æœºåŸºç¡€","çˆ¬è™«","python"],"title":"çˆ¬è™«","uri":"/%E7%88%AC%E8%99%AB/"}]